{"data":[{"updatedAt":"2025-12-04T19:12:44.388Z","createdAt":"2025-11-28T00:47:09.192Z","id":"hBAGnXbSIgQkW1lm","name":"n8n Auto-Healer v1.5","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":15}]}},"id":"schedule-trigger","name":"Check Every 15 Minutes","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,300]},{"parameters":{"url":"https://auto.yr.com.au/api/v1/executions?status=error&limit=50&includeData=true","sendHeaders":true,"headerParameters":{"parameters":[{"name":"X-N8N-API-KEY","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwZmRmM2Y0Ni1iNGIxLTRlYjMtYTdlZS05MGYxZDczMzE3NDUiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzYzODg3NDQyfQ.nMvcYGkjKHMkGVXXVr8Pfh61wT4WgWgX5SOtDNBW-F4"}]},"options":{}},"id":"get-recent-errors","name":"Get Recent Errors","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[240,300],"alwaysOutputData":true},{"parameters":{"jsCode":"// Filter errors to find ones that need fixing\n// v1.5: Version increment workflow - deactivate old, create new, test, activate\n// Only includes errors from last 30 minutes from active workflows\n// Excludes protected monitoring workflows\n\nconst executions = $input.item.json.data || [];\nconst thirtyMinutesAgo = new Date(Date.now() - 30 * 60 * 1000);\n\n// Protected workflows - don't alert for these (they monitor themselves)\nconst PROTECTED_WORKFLOWS = [\n  'n8n Auto-Healer',\n  'n8n Daily Error Report',\n  'n8n Silent Failure Report',\n  'n8n Email Health Check',\n];\n\nfunction isProtected(workflowName) {\n  if (!workflowName) return false;\n  return PROTECTED_WORKFLOWS.some(p => \n    workflowName.toLowerCase().includes(p.toLowerCase())\n  );\n}\n\nfunction extractErrorDetails(execution) {\n  let errorMessage = '';\n  let nodeName = '';\n  let nodeType = '';\n  let stackTrace = '';\n  let inputData = null;\n  let outputData = null;\n  \n  try {\n    if (execution.data && execution.data.resultData) {\n      const resultData = execution.data.resultData;\n      \n      // Method 1: Get from resultData.error (most reliable)\n      if (resultData.error) {\n        if (resultData.error.message) {\n          errorMessage = resultData.error.message;\n        } else if (typeof resultData.error === 'string') {\n          errorMessage = resultData.error;\n        }\n        stackTrace = resultData.error.stack || '';\n        \n        if (resultData.error.node) {\n          nodeName = resultData.error.node.name || '';\n          nodeType = resultData.error.node.type || '';\n        }\n        \n        // Extract context from error\n        if (resultData.error.context) {\n          const ctx = resultData.error.context;\n          if (ctx.itemIndex !== undefined) {\n            errorMessage += ` [Item ${ctx.itemIndex}]`;\n          }\n        }\n      }\n      \n      // Method 2: Use lastNodeExecuted\n      if (!nodeName && resultData.lastNodeExecuted) {\n        nodeName = resultData.lastNodeExecuted;\n      }\n      \n      // Method 3: Scan runData for the node that errored\n      if (resultData.runData) {\n        const nodeNames = Object.keys(resultData.runData);\n        \n        // Find node with error\n        for (const name of nodeNames) {\n          const nodeData = resultData.runData[name];\n          if (nodeData && nodeData.length > 0) {\n            for (const run of nodeData) {\n              if (run.error) {\n                if (!nodeName) nodeName = name;\n                if (!errorMessage && run.error.message) {\n                  errorMessage = run.error.message;\n                }\n                // Get input data that caused the error\n                if (run.inputData && run.inputData.main && run.inputData.main[0]) {\n                  inputData = run.inputData.main[0];\n                }\n                break;\n              }\n            }\n          }\n        }\n        \n        // Extract the failed node's output/input for context\n        if (nodeName && resultData.runData[nodeName]) {\n          const nodeRuns = resultData.runData[nodeName];\n          const lastRun = nodeRuns[nodeRuns.length - 1];\n          if (lastRun) {\n            if (lastRun.inputData && lastRun.inputData.main) {\n              inputData = lastRun.inputData.main[0];\n            }\n            if (lastRun.data && lastRun.data.main) {\n              outputData = lastRun.data.main[0];\n            }\n          }\n        }\n      }\n      \n      // Method 4: Check execution-level error\n      if (!errorMessage && execution.stoppedAt && !execution.finished) {\n        errorMessage = 'Workflow stopped unexpectedly';\n      }\n    }\n    \n    // Method 5: Check top-level execution error field\n    if (!errorMessage && execution.error) {\n      if (typeof execution.error === 'string') {\n        errorMessage = execution.error;\n      } else if (execution.error.message) {\n        errorMessage = execution.error.message;\n      }\n    }\n    \n  } catch (e) {\n    // Keep what we have if extraction fails\n    if (!errorMessage) errorMessage = `Extraction error: ${e.message}`;\n  }\n  \n  // Final fallbacks with more helpful messages\n  if (!errorMessage) errorMessage = 'Error details not captured - check n8n execution logs';\n  if (!nodeName) nodeName = 'Node name not captured';\n  if (!nodeType) nodeType = 'Type not captured';\n  \n  return { errorMessage, nodeName, nodeType, stackTrace, inputData, outputData };\n}\n\nconst errorsToFix = [];\n\nfor (const execution of executions) {\n  if (!execution || !execution.workflowId) continue;\n  \n  // Check if error is recent (within last 30 minutes)\n  const startedAt = execution.startedAt ? new Date(execution.startedAt) : null;\n  if (!startedAt || startedAt < thirtyMinutesAgo) continue;\n  \n  // Check if workflow was updated AFTER the error occurred\n  // If so, assume the error has already been fixed - skip alerting\n  const workflowUpdatedAt = execution.workflow?.updatedAt \n    ? new Date(execution.workflow.updatedAt) \n    : null;\n  \n  if (workflowUpdatedAt && workflowUpdatedAt > startedAt) {\n    // Workflow was modified after this error - likely already fixed\n    continue;\n  }\n  \n  // Get workflow name - try multiple sources\n  let workflowName = execution.workflowName || execution.workflow?.name || '';\n  \n  // Check if protected\n  if (isProtected(workflowName)) {\n    continue;\n  }\n  \n  // Extract error details\n  const { errorMessage, nodeName, nodeType, stackTrace, inputData, outputData } = extractErrorDetails(execution);\n  \n  // Add to fix queue\n  errorsToFix.push({\n    execution_id: execution.id,\n    workflow_id: execution.workflowId,\n    workflow_name: workflowName || `Workflow ${execution.workflowId}`,\n    started_at: execution.startedAt,\n    error_message: errorMessage,\n    failed_node: nodeName,\n    node_type: nodeType,\n    stack_trace: stackTrace,\n    input_data: inputData,\n    output_data: outputData\n  });\n}\n\n// Deduplicate by workflow_id (only report each workflow once per run)\nconst uniqueWorkflows = {};\nfor (const error of errorsToFix) {\n  if (!uniqueWorkflows[error.workflow_id]) {\n    uniqueWorkflows[error.workflow_id] = error;\n  }\n}\n\nconst deduplicatedErrors = Object.values(uniqueWorkflows);\n\nreturn [{\n  json: {\n    errors_to_fix: deduplicatedErrors,\n    total_errors_found: executions.length,\n    actionable_errors: deduplicatedErrors.length,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"filter-errors","name":"Filter Recent Errors","type":"n8n-nodes-base.code","typeVersion":2,"position":[480,300]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-errors","leftValue":"={{ $json.actionable_errors }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"check-has-errors","name":"Has Errors to Fix?","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[720,300]},{"parameters":{"jsCode":"// Split errors into individual items for processing\nconst data = $input.item.json;\nconst errors = data.errors_to_fix || [];\n\nreturn errors.map(error => ({ json: error }));"},"id":"split-errors","name":"Split Into Individual Errors","type":"n8n-nodes-base.code","typeVersion":2,"position":[960,200]},{"parameters":{"url":"=https://auto.yr.com.au/api/v1/workflows/{{ $json.workflow_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"X-N8N-API-KEY","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwZmRmM2Y0Ni1iNGIxLTRlYjMtYTdlZS05MGYxZDczMzE3NDUiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzYzODg3NDQyfQ.nMvcYGkjKHMkGVXXVr8Pfh61wT4WgWgX5SOtDNBW-F4"}]},"options":{}},"id":"get-workflow-json","name":"Get Workflow JSON","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1200,200],"alwaysOutputData":true},{"parameters":{"jsCode":"// Prepare the ready-to-paste prompt for Claude Code\n// v1.5: Version increment workflow - deactivate old, create new version, test, activate\nconst errorInfo = $('Split Into Individual Errors').item.json;\nconst workflowData = $input.item.json;\n\n// Get workflow name from API response (more reliable)\nconst workflowName = workflowData.name || errorInfo.workflow_name || `Workflow ${errorInfo.workflow_id}`;\nconst failedNode = errorInfo.failed_node || 'Node name not captured';\nconst errorMessage = errorInfo.error_message || 'Error details not captured - check n8n execution logs';\nconst nodeType = errorInfo.node_type || 'Type not captured';\n\n// Extract current version from workflow name (e.g., \"Workflow Name v1.2\" -> 1.2)\nlet currentVersion = '1.0';\nconst versionMatch = workflowName.match(/v?(\\d+\\.\\d+)\\s*$/i);\nif (versionMatch) {\n  currentVersion = versionMatch[1];\n}\nconst newVersion = (parseFloat(currentVersion) + 0.1).toFixed(1);\n\n// Calculate new workflow name\nlet newWorkflowName = workflowName;\nif (versionMatch) {\n  newWorkflowName = workflowName.replace(/v?\\d+\\.\\d+\\s*$/i, `v${newVersion}`);\n} else {\n  newWorkflowName = `${workflowName} v${newVersion}`;\n}\n\n// Find the failed node's configuration from the workflow\nlet failedNodeConfig = null;\nif (workflowData.nodes && failedNode !== 'Node name not captured') {\n  failedNodeConfig = workflowData.nodes.find(n => n.name === failedNode);\n}\n\n// Format timestamp\nconst errorTime = errorInfo.started_at \n  ? new Date(errorInfo.started_at).toLocaleString('en-AU', { timeZone: 'Australia/Melbourne' })\n  : 'Unknown time';\n\n// Format input data if available (truncate if too large)\nlet inputDataStr = 'Not captured';\nif (errorInfo.input_data) {\n  const inputJson = JSON.stringify(errorInfo.input_data, null, 2);\n  inputDataStr = inputJson.length > 2000 ? inputJson.substring(0, 2000) + '\\n... (truncated)' : inputJson;\n}\n\n// API key for commands\nconst API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwZmRmM2Y0Ni1iNGIxLTRlYjMtYTdlZS05MGYxZDczMzE3NDUiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzYzODg3NDQyfQ.nMvcYGkjKHMkGVXXVr8Pfh61wT4WgWgX5SOtDNBW-F4';\nconst safeWorkflowName = newWorkflowName.replace(/[^a-zA-Z0-9\\s_-]/g, '_');\n\n// Build failed node config section\nlet failedNodeSection = '';\nif (failedNodeConfig) {\n  failedNodeSection = `\\n## FAILED NODE CONFIG\\n\\`\\`\\`json\\n${JSON.stringify(failedNodeConfig, null, 2)}\\n\\`\\`\\`\\n`;\n}\n\n// Create the Claude Code prompt with versioning workflow\nconst claudePrompt = `Fix n8n workflow error: ${workflowName}\n\n## ERROR\n- **Workflow:** ${workflowName} (ID: ${errorInfo.workflow_id})\n- **Execution:** ${errorInfo.execution_id}\n- **Failed Node:** ${failedNode}\n- **Node Type:** ${nodeType}\n- **Time:** ${errorTime}\n- **Error:** ${errorMessage}\n\n## FAILED NODE INPUT DATA\n\\`\\`\\`json\n${inputDataStr}\n\\`\\`\\`\n${failedNodeSection}\n## VERSIONING INFO\n- **Current Version:** ${currentVersion}\n- **New Version:** ${newVersion}\n- **Old Workflow ID:** ${errorInfo.workflow_id}\n- **New Workflow Name:** ${newWorkflowName}\n\n## INSTRUCTIONS\n\n### Step 1: Download the workflow\n\\`\\`\\`bash\npython C:\\\\Users\\\\peter\\\\Downloads\\\\CC\\\\n8n\\\\Python\\\\CC-Made-n8n_api_download_workflows.py --id ${errorInfo.workflow_id}\n\\`\\`\\`\n\n### Step 2: Fix the issue\n- Analyze the error and fix it in the downloaded JSON\n- **Update the workflow name** to: \\`${newWorkflowName}\\`\n- **Remove the \"id\" field** from the JSON (so it creates a new workflow)\n- Save to: \\`C:\\\\Users\\\\peter\\\\Downloads\\\\CC\\\\n8n\\\\JSON\\\\active_workflows\\\\${safeWorkflowName}.json\\`\n\n### Step 3: Deactivate the OLD workflow\n\\`\\`\\`bash\ncurl -s -X POST \"https://auto.yr.com.au/api/v1/workflows/${errorInfo.workflow_id}/deactivate\" -H \"X-N8N-API-KEY: ${API_KEY}\"\n\\`\\`\\`\n\n### Step 4: Upload the NEW version (creates new workflow)\n\\`\\`\\`bash\npython C:\\\\Users\\\\peter\\\\Downloads\\\\CC\\\\n8n\\\\Python\\\\CC-Made-n8n_api_upload_workflow.py \"C:\\\\Users\\\\peter\\\\Downloads\\\\CC\\\\n8n\\\\JSON\\\\active_workflows\\\\${safeWorkflowName}.json\" --create\n\\`\\`\\`\nThis will output the NEW workflow ID - save it for the next steps.\n\n### Step 5: Activate the NEW workflow\nReplace NEW_WORKFLOW_ID with the ID from step 4:\n\\`\\`\\`bash\ncurl -s -X POST \"https://auto.yr.com.au/api/v1/workflows/NEW_WORKFLOW_ID/activate\" -H \"X-N8N-API-KEY: ${API_KEY}\"\n\\`\\`\\`\n\n### Step 6: Test - wait for new execution and check status\nReplace NEW_WORKFLOW_ID with the ID from step 4:\n\\`\\`\\`bash\ncurl -s \"https://auto.yr.com.au/api/v1/executions?workflowId=NEW_WORKFLOW_ID&limit=5\" -H \"X-N8N-API-KEY: ${API_KEY}\" | python -c \"import sys,json; d=json.load(sys.stdin); print('Recent executions:'); [print(f'  {e[\\\"id\\\"]}: {e[\\\"status\\\"]}') for e in d.get('data',[])[:5]]\"\n\\`\\`\\`\n\n### Step 7: Rollback if needed\nIf the new version fails, re-activate the old one:\n\\`\\`\\`bash\ncurl -s -X POST \"https://auto.yr.com.au/api/v1/workflows/${errorInfo.workflow_id}/activate\" -H \"X-N8N-API-KEY: ${API_KEY}\"\n\\`\\`\\`\n\n---\n## REQUIRED OUTPUT FORMAT\n\nAt the END of your response, you MUST include this status block:\n\n\\`\\`\\`\n=== FIX STATUS ===\nRoot Cause: [one line description]\nFix Applied: [one line description]\nOld Version: ${currentVersion} (ID: ${errorInfo.workflow_id}) - [DEACTIVATED | STILL ACTIVE]\nNew Version: ${newVersion} (ID: [new ID or N/A]) - [CREATED & ACTIVATED | NOT CREATED]\nTest Status: [TESTED - SUCCESS | TESTED - STILL FAILING | NOT TESTED - [reason]]\nPermission Issues: [NONE | List any curl/API commands you couldn't run]\nWebhook Docs Updated: [YES - what changed | NO | N/A]\n==================\n\\`\\`\\``;\n\n// Create shorter versions for display\nconst shortError = errorMessage.length > 300 \n  ? errorMessage.substring(0, 300) + '...' \n  : errorMessage;\n\nconst shortWorkflowName = workflowName.length > 50\n  ? workflowName.substring(0, 47) + '...'\n  : workflowName;\n\nreturn [{\n  json: {\n    workflow_id: errorInfo.workflow_id,\n    execution_id: errorInfo.execution_id,\n    workflow_name: workflowName,\n    short_workflow_name: shortWorkflowName,\n    new_workflow_name: newWorkflowName,\n    current_version: currentVersion,\n    new_version: newVersion,\n    failed_node: failedNode,\n    node_type: nodeType,\n    error_message: errorMessage,\n    short_error: shortError,\n    error_time: errorTime,\n    claude_prompt: claudePrompt,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"prepare-claude-prompt","name":"Prepare Claude Code Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[1440,200]},{"parameters":{"sendTo":"peter@yesai.au","subject":"=üîß n8n Fix Needed: {{ $json.short_workflow_name }} - {{ $json.failed_node }}","message":"=<div style=\"font-family:Arial,Helvetica,sans-serif;max-width:900px;margin:0 auto;padding:20px\">\n  <h2 style=\"color:#111827;border-bottom:3px solid #f59e0b;padding-bottom:10px\">üîß n8n Workflow Error - Fix Required</h2>\n  \n  <div style=\"background:#fff7ed;border-left:6px solid #f59e0b;padding:20px;margin:20px 0;text-align:center\">\n    <div style=\"font-size:48px;margin-bottom:10px\">‚ö†Ô∏è</div>\n    <h2 style=\"margin:0;color:#c2410c;font-size:24px\">WORKFLOW ERROR DETECTED</h2>\n    <p style=\"margin:10px 0 0 0;font-size:16px;color:#374151\">Copy the prompt below and paste into Claude Code</p>\n  </div>\n  \n  <div style=\"background:#f0f9ff;border-left:4px solid #3b82f6;padding:15px;margin-bottom:20px\">\n    <h3 style=\"margin:0 0 10px 0;color:#1e40af\">üìã Error Summary</h3>\n    <p style=\"margin:5px 0;font-size:14px\"><strong>Workflow:</strong> {{ $json.workflow_name }}</p>\n    <p style=\"margin:5px 0;font-size:14px\"><strong>Workflow ID:</strong> {{ $json.workflow_id }}</p>\n    <p style=\"margin:5px 0;font-size:14px\"><strong>Execution ID:</strong> {{ $json.execution_id }}</p>\n    <p style=\"margin:5px 0;font-size:14px\"><strong>Failed Node:</strong> {{ $json.failed_node }}</p>\n    <p style=\"margin:5px 0;font-size:14px\"><strong>Node Type:</strong> {{ $json.node_type }}</p>\n    <p style=\"margin:5px 0;font-size:14px\"><strong>Error Time:</strong> {{ $json.error_time }}</p>\n    <p style=\"margin:5px 0;font-size:14px\"><strong>Error:</strong></p>\n    <pre style=\"background:#fef2f2;padding:10px;border-radius:4px;font-size:12px;overflow-x:auto;border:1px solid #fecaca;white-space:pre-wrap;word-wrap:break-word\">{{ $json.short_error }}</pre>\n  </div>\n  \n  <div style=\"background:#e0f2fe;border-left:4px solid #0284c7;padding:15px;margin-bottom:20px\">\n    <h3 style=\"margin:0 0 10px 0;color:#0369a1\">üîÑ Version Upgrade</h3>\n    <p style=\"margin:5px 0;font-size:14px\"><strong>Current:</strong> v{{ $json.current_version }} ‚Üí <strong>New:</strong> v{{ $json.new_version }}</p>\n    <p style=\"margin:5px 0;font-size:14px\"><strong>New Name:</strong> {{ $json.new_workflow_name }}</p>\n  </div>\n  \n  <div style=\"background:#f0fdf4;border-left:4px solid #10b981;padding:15px;margin-bottom:20px\">\n    <h3 style=\"margin:0 0 10px 0;color:#047857\">üöÄ Quick Fix Steps</h3>\n    <ol style=\"margin:0;padding-left:20px;font-size:14px\">\n      <li>Open <strong>Claude Code</strong> in your terminal</li>\n      <li>Copy the prompt below</li>\n      <li>Paste into Claude Code</li>\n      <li>Claude will: download ‚Üí fix ‚Üí deactivate old ‚Üí upload new ‚Üí activate ‚Üí test</li>\n      <li>Check the <strong>=== FIX STATUS ===</strong> block at the end</li>\n    </ol>\n  </div>\n  \n  <div style=\"background:#1e293b;border-radius:8px;padding:20px;margin-bottom:20px\">\n    <h3 style=\"margin:0 0 10px 0;color:#f1f5f9;font-size:14px\">üìã COPY THIS PROMPT:</h3>\n    <pre style=\"background:#0f172a;color:#e2e8f0;padding:15px;border-radius:4px;font-size:11px;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word;max-height:400px;overflow-y:auto;cursor:text;border:2px solid #334155\" onclick=\"this.focus();document.execCommand('selectAll',false,null);\">{{ $json.claude_prompt }}</pre>\n  </div>\n  \n  <div style=\"background:#f8fafc;border:1px solid #e2e8f0;border-radius:4px;padding:15px;margin-bottom:20px\">\n    <h3 style=\"margin:0 0 10px 0;color:#475569\">üîó Quick Links</h3>\n    <p style=\"margin:5px 0;font-size:14px\">‚Ä¢ <a href=\"https://auto.yr.com.au/workflow/{{ $json.workflow_id }}\" style=\"color:#3b82f6\">Open Failed Workflow in n8n</a></p>\n    <p style=\"margin:5px 0;font-size:14px\">‚Ä¢ <a href=\"https://auto.yr.com.au/workflow/{{ $json.workflow_id }}/executions\" style=\"color:#3b82f6\">View Execution History</a></p>\n    <p style=\"margin:5px 0;font-size:14px\">‚Ä¢ <a href=\"https://auto.yr.com.au/workflow/hBAGnXbSIgQkW1lm\" style=\"color:#3b82f6\">Edit Auto-Healer Workflow</a></p>\n    <p style=\"margin:5px 0;font-size:14px\">‚Ä¢ <a href=\"file:///C:/Users/peter/Downloads/CC/n8n/Webhooks%20Docs/RETELLAI_WEBHOOKS_CURRENT.md\" style=\"color:#3b82f6\">Webhook Reference Doc</a></p>\n  </div>\n  \n  <div style=\"margin-top:30px;padding:20px;border-top:2px solid #e5e7eb;background:#f9fafb;text-align:center\">\n    <p style=\"margin:0 0 5px 0;font-size:12px;color:#6b7280\">ü§ñ Automated alert by:</p>\n    <p style=\"margin:0 0 10px 0;font-size:14px;color:#374151;font-weight:600\">n8n Auto-Healer v1.5</p>\n    <p style=\"margin:0;font-size:12px;color:#6b7280\">Checks every 15 minutes | Powered by Yes AI Consultants Australia</p>\n    <p style=\"margin:5px 0 0 0;font-size:12px\"><a href=\"https://www.YesAI.au\" style=\"color:#3b82f6;text-decoration:none\">www.YesAI.au</a></p>\n  </div>\n</div>","options":{"senderName":"n8n Auto-Healer"}},"id":"send-fix-email","name":"Send Fix Request Email","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[1680,200],"credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}},{"parameters":{},"id":"no-errors-noop","name":"No Errors - Done","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[960,400]}],"connections":{"Check Every 15 Minutes":{"main":[[{"node":"Get Recent Errors","type":"main","index":0}]]},"Get Recent Errors":{"main":[[{"node":"Filter Recent Errors","type":"main","index":0}]]},"Filter Recent Errors":{"main":[[{"node":"Has Errors to Fix?","type":"main","index":0}]]},"Has Errors to Fix?":{"main":[[{"node":"Split Into Individual Errors","type":"main","index":0}],[{"node":"No Errors - Done","type":"main","index":0}]]},"Split Into Individual Errors":{"main":[[{"node":"Get Workflow JSON","type":"main","index":0}]]},"Get Workflow JSON":{"main":[[{"node":"Prepare Claude Code Prompt","type":"main","index":0}]]},"Prepare Claude Code Prompt":{"main":[[{"node":"Send Fix Request Email","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":{"node:Check Every 15 Minutes":{"recurrenceRules":[]}},"meta":null,"pinData":null,"versionId":"77d7ec1d-23a7-48ed-9eb8-92f9148da270","triggerCount":1,"shared":[{"updatedAt":"2025-11-28T00:47:09.192Z","createdAt":"2025-11-28T00:47:09.192Z","role":"workflow:owner","workflowId":"hBAGnXbSIgQkW1lm","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-02T20:48:48.400Z","createdAt":"2025-12-02T18:59:04.433Z","id":"S2WV7x99WQ77CU4l","name":"RetellAI - Email End of Call Summary + Sheets v7.5 UNIFIED","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/email-call-summary","responseMode":"responseNode","options":{}},"id":"080540df-b49f-4f06-b2f3-f0f096eebdce","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-448,208],"webhookId":"1565fad1-c77c-46bf-b164-2f40bf462708"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $('Webhook').item.json.body?.event }}","rightValue":"call_analyzed","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"068c522b-290a-4ff3-8c2c-28479da3c264","name":"Is Call Analyzed Event?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,208]},{"parameters":{"operation":"executeQuery","query":"-- Check if we've already processed this call_id\n-- This prevents duplicate emails\n\nCREATE TABLE IF NOT EXISTS processed_call_emails (\n  call_id      text PRIMARY KEY,\n  processed_at timestamptz DEFAULT now(),\n  email_sent   boolean DEFAULT true\n);\n\n-- Check if this call_id exists\nSELECT \n  call_id,\n  processed_at,\n  email_sent\nFROM processed_call_emails\nWHERE call_id = '{{ $json.body.call.call_id }}'\nLIMIT 1;","options":{}},"id":"6e701ece-7161-4adc-89cb-f5c5f9500f7f","name":"Check If Already Processed","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[0,208],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// FIXED: Check if this call has already been processed\nconst items = $input.all();\n\nif (!items || items.length === 0) {\n  console.log('‚úÖ NEW CALL: No items from DB check, continuing...');\n  return items;\n}\n\nconst pgResult = items[0].json;\n\n// PostgreSQL returns empty array [] when no rows found\nif (Array.isArray(pgResult) && pgResult.length === 0) {\n  console.log('‚úÖ NEW CALL: Empty array from DB, not processed yet');\n  return items;\n}\n\n// If pgResult is a non-empty array, check first item\nif (Array.isArray(pgResult) && pgResult.length > 0 && pgResult[0].call_id) {\n  console.log('‚ùå DUPLICATE PREVENTED: Call already processed, skipping');\n  return [];\n}\n\n// If pgResult is an object with call_id, already processed\nif (pgResult && !Array.isArray(pgResult) && pgResult.call_id) {\n  console.log('‚ùå DUPLICATE PREVENTED: Call already processed, skipping');\n  return [];\n}\n\nconsole.log('‚úÖ NEW CALL: Not processed yet, continuing...');\nreturn items;"},"id":"9a610d56-750d-47c7-a396-42f8bc3c0ce2","name":"Skip If Already Processed","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,208]},{"parameters":{"operation":"executeQuery","query":"-- Mark this call as processed FIRST\n-- This ensures we don't send duplicate emails even if the workflow runs twice\n\nINSERT INTO processed_call_emails (call_id, processed_at, email_sent)\nVALUES (\n  '{{ $json.body.call.call_id }}',\n  NOW(),\n  true\n)\nON CONFLICT (call_id) DO NOTHING\nRETURNING *;","options":{}},"id":"a69ca148-5ad0-4c72-8925-5cee91abc505","name":"Mark As Processed","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[448,208],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"operation":"executeQuery","query":"-- Look up transfer data AND patient info by call_id\n-- v7.5: Also look up patient by webhook from_number directly\n-- ALWAYS returns one row with complete patient info when available\n\nCREATE TABLE IF NOT EXISTS retell_calls (\n  call_id      text PRIMARY KEY,\n  phone_number text,\n  no_phone     boolean DEFAULT false,\n  from_number  text,\n  created_at   timestamptz DEFAULT now(),\n  updated_at   timestamptz DEFAULT now()\n);\n\n-- Get call info from webhook\nWITH call_info AS (\n  SELECT \n    '{{ $json.body.call.call_id }}' as search_call_id,\n    '{{ $json.body.call.from_number }}' as webhook_from_number\n),\n-- Normalize the webhook from_number to E.164\nnormalized_webhook AS (\n  SELECT\n    search_call_id,\n    webhook_from_number,\n    CASE\n      WHEN webhook_from_number LIKE '+%' THEN webhook_from_number\n      WHEN webhook_from_number LIKE '0%' THEN '+61' || SUBSTRING(webhook_from_number FROM 2)\n      WHEN webhook_from_number ~ '^61' THEN '+' || webhook_from_number\n      ELSE '+61' || webhook_from_number\n    END as normalized_from_number\n  FROM call_info\n),\n-- Look for transfer (from Sara's tool)\ntransfer_lookup AS (\n  SELECT *\n  FROM retell_transfers\n  WHERE call_id = (SELECT search_call_id FROM call_info)\n  ORDER BY created_at DESC\n  LIMIT 1\n),\n-- Look for retell_calls entry (from Lookup Caller tool at start of call)\nretell_call_lookup AS (\n  SELECT *\n  FROM retell_calls\n  WHERE call_id = (SELECT search_call_id FROM call_info)\n  LIMIT 1\n),\n-- Look up patient by phone: try retell_calls.phone_number first, then webhook from_number\npatient_lookup AS (\n  SELECT\n    patient_id,\n    first_name,\n    last_name,\n    preferred_name,\n    email,\n    phone,\n    phone_mobile,\n    date_of_birth,\n    village,\n    archived\n  FROM patients\n  WHERE archived = false\n    AND (\n      -- Match by retell_calls phone_number\n      phone_normalized = (SELECT phone_number FROM retell_call_lookup)\n      OR phone_mobile_normalized = (SELECT phone_number FROM retell_call_lookup)\n      -- OR match by webhook from_number (normalized)\n      OR phone_normalized = (SELECT normalized_from_number FROM normalized_webhook)\n      OR phone_mobile_normalized = (SELECT normalized_from_number FROM normalized_webhook)\n    )\n  LIMIT 1\n)\n-- ALWAYS return one row with merged data\nSELECT\n  -- Transfer fields (from Sara's tool)\n  t.transfer_id,\n  COALESCE(t.call_id, ci.search_call_id) as call_id,\n  t.created_at as transfer_created_at,\n  t.updated_at as transfer_updated_at,\n  \n  -- Caller info: prefer transfer, fallback to patient lookup\n  COALESCE(\n    t.caller_name,\n    CASE WHEN p.first_name IS NOT NULL THEN CONCAT(p.first_name, ' ', p.last_name) ELSE NULL END\n  ) as caller_name,\n  \n  COALESCE(t.village, p.village) as village,\n  \n  COALESCE(\n    t.patient_id,\n    p.patient_id::text\n  ) as patient_id,\n  \n  -- Transfer-specific fields\n  t.phone_number as transfer_phone_number,\n  t.no_phone,\n  t.intent,\n  t.urgency,\n  t.details,\n  \n  -- retell_calls data\n  rc.phone_number AS stored_phone_number,\n  rc.no_phone AS stored_no_phone,\n  rc.from_number AS carrier_from_number,\n  \n  -- Webhook from_number for fallback\n  nw.webhook_from_number,\n  nw.normalized_from_number,\n  \n  -- Patient data for reference\n  p.first_name,\n  p.last_name,\n  p.preferred_name,\n  p.email,\n  p.phone as patient_phone,\n  p.phone_mobile as patient_mobile,\n  p.date_of_birth,\n  p.village as patient_village\n  \nFROM call_info ci\nCROSS JOIN normalized_webhook nw\nLEFT JOIN transfer_lookup t ON TRUE\nLEFT JOIN retell_call_lookup rc ON TRUE\nLEFT JOIN patient_lookup p ON TRUE\nLIMIT 1;","options":{"queryReplacement":""}},"id":"689c7d41-744d-4241-a89a-50b9981648b0","name":"Postgres Load Transfer","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[672,208],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"assignments":{"assignments":[{"id":"a1b2c3d4","name":"call_id","value":"={{ $('Webhook').first().json.body?.call?.call_id || 'N/A' }}","type":"string"},{"id":"a1b2c3d5","name":"agent_id","value":"={{ $('Webhook').first().json.body?.call?.agent_id || 'N/A' }}","type":"string"},{"id":"a1b2c3d6","name":"agent_version","value":"={{ $('Webhook').first().json.body?.call?.agent_version || 'N/A' }}","type":"string"},{"id":"a1b2c3d7","name":"direction","value":"={{ $('Webhook').first().json.body?.call?.direction || 'unknown' }}","type":"string"},{"id":"a1b2c3d8","name":"outcome","value":"={{ $('Webhook').first().json.body?.call?.call_status || 'unknown' }}","type":"string"},{"id":"a1b2c3d9","name":"start_time","value":"={{ $('Webhook').first().json.body?.call?.start_timestamp ? new Date($('Webhook').first().json.body.call.start_timestamp).toLocaleString('en-AU', { timeZone: 'Australia/Sydney' }) : 'N/A' }}","type":"string"},{"id":"a1b2c3d10","name":"end_time","value":"={{ $('Webhook').first().json.body?.call?.end_timestamp ? new Date($('Webhook').first().json.body.call.end_timestamp).toLocaleString('en-AU', { timeZone: 'Australia/Sydney' }) : 'N/A' }}","type":"string"},{"id":"a1b2c3d11","name":"duration_ms","value":"={{ $('Webhook').first().json.body?.call?.duration_ms || 0 }}","type":"number"},{"id":"a1b2c3d12","name":"human_duration","value":"={{ (() => { const ms = $('Webhook').first().json.body?.call?.duration_ms; if (!ms) return 'N/A'; const totalSeconds = Math.floor(ms / 1000); const minutes = Math.floor(totalSeconds / 60); const seconds = totalSeconds % 60; return `${minutes}m ${seconds}s`; })() }}","type":"string"},{"id":"a1b2c3d17","name":"html_transcript","value":"={{ (() => { const transcript = $('Webhook').first().json.body?.call?.transcript_object; if (!transcript || !Array.isArray(transcript)) return 'No transcript available'; return transcript.map(turn => `${turn.role === 'agent' || turn.role === 'assistant' ? 'Agent' : 'User'}: ${turn.content || ''}`).join('<br><br>'); })() }}","type":"string"},{"id":"a1b2c3d18","name":"recording_url","value":"={{ $('Webhook').first().json.body?.call?.recording_url || '' }}","type":"string"},{"id":"a1b2c3d19","name":"public_log_url","value":"={{ $('Webhook').first().json.body?.call?.public_log_url || '' }}","type":"string"},{"id":"a1b2c3d20","name":"client_name","value":"={{ (() => { const pg = $('Postgres Load Transfer').first().json; const pgData = Array.isArray(pg) ? pg[0] : pg; const name = pgData?.caller_name; return (name && name.trim()) ? name.trim() : 'Unknown Caller'; })() }}","type":"string"},{"id":"a1b2c3d21","name":"village","value":"={{ (() => { const pg = $('Postgres Load Transfer').first().json; const pgData = Array.isArray(pg) ? pg[0] : pg; return pgData?.village || pgData?.patient_village || 'N/A'; })() }}","type":"string"},{"id":"a1b2c3d22","name":"cliniko_id","value":"={{ (() => { const pg = $('Postgres Load Transfer').first().json; const pgData = Array.isArray(pg) ? pg[0] : pg; return pgData?.patient_id || 'N/A'; })() }}","type":"string"},{"id":"a1b2c3d23","name":"from_phone","value":"={{ (() => { const pg = $('Postgres Load Transfer').first().json; const pgData = Array.isArray(pg) ? pg[0] : pg; const phone = pgData?.carrier_from_number || pgData?.normalized_from_number || $('Webhook').first().json.body?.call?.from_number; if (!phone) return 'N/A'; let d = String(phone).replace(/[^0-9+]/g, ''); if (d.startsWith('+')) return d; if (d.startsWith('0')) return '+61' + d.slice(1); if (d.startsWith('61')) return '+' + d; return '+61' + d; })() }}","type":"string"},{"id":"a1b2c3d24","name":"callback_phone","value":"={{ (() => { const pg = $('Postgres Load Transfer').first().json; const pgData = Array.isArray(pg) ? pg[0] : pg; if (pgData?.no_phone === true) return 'No phone (declined)'; const phone = pgData?.stored_phone_number || pgData?.transfer_phone_number || pgData?.carrier_from_number || pgData?.normalized_from_number || $('Webhook').first().json.body?.call?.from_number; if (!phone) return 'N/A'; let d = String(phone).replace(/[^0-9+]/g, ''); if (d.startsWith('+')) return d; if (d.startsWith('0')) return '+61' + d.slice(1); if (d.startsWith('61')) return '+' + d; return '+61' + d; })() }}","type":"string"},{"id":"a1b2c3d25","name":"intent","value":"={{ (() => { const pg = $('Postgres Load Transfer').first().json; const pgData = Array.isArray(pg) ? pg[0] : pg; return pgData?.intent || 'general_inquiry'; })() }}","type":"string"},{"id":"a1b2c3d26","name":"urgency","value":"={{ (() => { const pg = $('Postgres Load Transfer').first().json; const pgData = Array.isArray(pg) ? pg[0] : pg; return pgData?.urgency || 'routine'; })() }}","type":"string"},{"id":"a1b2c3d27","name":"details","value":"={{ (() => { const pg = $('Postgres Load Transfer').first().json; const pgData = Array.isArray(pg) ? pg[0] : pg; return pgData?.details || ''; })() }}","type":"string"},{"id":"a1b2c3d28","name":"disconnection_reason","value":"={{ $('Webhook').first().json.body?.call?.disconnection_reason || '' }}","type":"string"}]},"options":{}},"id":"f833b885-51ef-45ce-913e-b64e1d34f44e","name":"Compose Data for Email","type":"n8n-nodes-base.set","typeVersion":3.3,"position":[896,112]},{"parameters":{"assignments":{"assignments":[{"id":"s1","name":"call_id","value":"={{ $('Compose Data for Email').first().json.call_id }}","type":"string"},{"id":"s2","name":"date","value":"={{ $('Webhook').first().json.body?.call?.start_timestamp ? new Date($('Webhook').first().json.body.call.start_timestamp).toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney' }) : 'N/A' }}","type":"string"},{"id":"s3","name":"time","value":"={{ $('Webhook').first().json.body?.call?.start_timestamp ? new Date($('Webhook').first().json.body.call.start_timestamp).toLocaleTimeString('en-AU', { timeZone: 'Australia/Sydney' }) : 'N/A' }}","type":"string"},{"id":"s4","name":"caller_id","value":"={{ $('Compose Data for Email').first().json.callback_phone }}","type":"string"},{"id":"s5","name":"client_name","value":"={{ $('Compose Data for Email').first().json.client_name }}","type":"string"},{"id":"s6","name":"cliniko_id","value":"={{ $('Compose Data for Email').first().json.cliniko_id }}","type":"string"},{"id":"s7","name":"village","value":"={{ $('Compose Data for Email').first().json.village }}","type":"string"},{"id":"s8","name":"duration_seconds","value":"={{ Math.floor(($('Compose Data for Email').first().json.duration_ms || 0) / 1000) }}","type":"number"},{"id":"s9","name":"intent","value":"={{ $('Compose Data for Email').first().json.intent }}","type":"string"},{"id":"s10","name":"outcome","value":"={{ $('Compose Data for Email').first().json.outcome }}","type":"string"},{"id":"s11","name":"escalated","value":"={{ $('Compose Data for Email').first().json.urgency }}","type":"string"},{"id":"s12","name":"errors","value":"","type":"string"},{"id":"s13","name":"recording_url","value":"={{ $('Compose Data for Email').first().json.recording_url || 'N/A' }}","type":"string"},{"id":"s14","name":"notes","value":"={{ $('Compose Data for Email').first().json.details || 'No details provided' }}","type":"string"}]},"options":{}},"id":"b829a873-8d2b-4531-8124-5905b4a13c90","name":"Compose Data for Sheets","type":"n8n-nodes-base.set","typeVersion":3.3,"position":[1120,304]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"inbound-check","leftValue":"={{ $json.direction }}","rightValue":"inbound","operator":{"type":"string","operation":"equals"}},{"id":"duration-check","leftValue":"={{ $json.duration_ms }}","rightValue":10000,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"d45a9865-cf2c-4f06-b99b-f872abc85e28","name":"Is Inbound Call > 10s?","type":"n8n-nodes-base.if","typeVersion":2,"position":[1120,112]},{"parameters":{"sendTo":"peter@yesai.au","subject":"=[Reignite] Call Summary: {{ $json.client_name }} ({{ $json.human_duration }})","message":"=<table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"border-collapse:collapse;width:100%;max-width:780px;border:1px solid #e5e7eb\">\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;background:#f9fafb;text-align:left;font-weight:600;font-family:Arial,Helvetica,sans-serif;font-size:13px;line-height:18px;color:#111827\" colspan=\"2\">Caller</td></tr>\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px;width:240px\"><strong>Name</strong></td><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\">{{ $json.client_name }}</td></tr>\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"><strong>From Phone (carrier)</strong></td><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\">{{ $json.from_phone }}</td></tr>\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"><strong>Callback Phone</strong></td><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\">{{ $json.callback_phone }}</td></tr>\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"><strong>Village</strong></td><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\">{{ $json.village }}</td></tr>\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"><strong>Patient ID</strong></td><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\">{{ $json.cliniko_id }}</td></tr>\n\n  {{ $json.intent !== 'general_inquiry' || $json.details ? `\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;background:#f9fafb;text-align:left;font-weight:600;font-family:Arial,Helvetica,sans-serif;font-size:13px;line-height:18px;color:#111827\" colspan=\"2\">Call Details</td></tr>\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"><strong>Intent</strong></td><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\">${$json.intent}</td></tr>\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"><strong>Urgency</strong></td><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\">${$json.urgency}</td></tr>\n  ${$json.details ? `<tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"><strong>Details</strong></td><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\">${$json.details}</td></tr>` : ''}\n  ` : '' }}\n\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;background:#f9fafb;text-align:left;font-weight:600;font-family:Arial,Helvetica,sans-serif;font-size:13px;line-height:18px;color:#111827\" colspan=\"2\">Call Timings & Status</td></tr>\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"><strong>Start Time</strong></td><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\">{{ $json.start_time }}</td></tr>\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"><strong>End Time</strong></td><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\">{{ $json.end_time }}</td></tr>\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"><strong>Duration</strong></td><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\">{{ $json.human_duration }}</td></tr>\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"><strong>Direction</strong></td><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\">{{ $json.direction }}</td></tr>\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"><strong>Status</strong></td><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\">{{ $json.outcome }}</td></tr>\n  {{ $json.disconnection_reason ? `<tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"><strong>Disconnection Reason</strong></td><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\">${$json.disconnection_reason}</td></tr>` : '' }}\n\n  {{ $json.recording_url ? `\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;background:#f9fafb;text-align:left;font-weight:600;font-family:Arial,Helvetica,sans-serif;font-size:13px;line-height:18px;color:#111827\" colspan=\"2\">Recording & Logs</td></tr>\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"><strong>Recording</strong></td><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"><a href=\"${$json.recording_url}\" style=\"color:#2563eb\">Listen to recording</a></td></tr>\n  ${$json.public_log_url ? `<tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"><strong>Public Log</strong></td><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"><a href=\"${$json.public_log_url}\" style=\"color:#2563eb\">View detailed log</a></td></tr>` : ''}\n  ` : '' }}\n\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;background:#f9fafb;text-align:left;font-weight:600;font-family:Arial,Helvetica,sans-serif;font-size:13px;line-height:18px;color:#111827\" colspan=\"2\">Transcript</td></tr>\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px;background:#fff\" colspan=\"2\">{{ $json.html_transcript }}</td></tr>\n\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;background:#f9fafb;text-align:left;font-weight:600;font-family:Arial,Helvetica,sans-serif;font-size:13px;line-height:18px;color:#111827\" colspan=\"2\">Technical</td></tr>\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"><strong>Call ID</strong></td><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\">{{ $json.call_id }}</td></tr>\n  <tr><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"><strong>Agent ID</strong></td><td style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\">{{ $json.agent_id }} (v{{ $json.agent_version }})</td></tr>\n</table>\n<div style=\"font-family:Arial,Helvetica,sans-serif;font-size:12px;color:#6b7280;margin-top:10px\">\n  Powered by Yes AI <a href=\"https://www.YesAI.au\" style=\"color:#6b7280;text-decoration:none\">www.YesAI.au</a>\n</div>","options":{}},"id":"050eecc5-3062-4f30-877c-06b19b8c36d5","name":"Send Email via Gmail","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[1344,112],"webhookId":"f9f51f13-64bd-4444-afc4-c52c03c102fa","credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}},{"parameters":{"operation":"appendOrUpdate","documentId":{"__rl":true,"value":"1RCT-JiTk7cm9uu9cVKG11K4WI0HLz_615Da37WqIz80","mode":"id"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1RCT-JiTk7cm9uu9cVKG11K4WI0HLz_615Da37WqIz80/edit#gid=0"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":[],"schema":[{"id":"call_id","displayName":"call_id","type":"string","canBeUsedToMatch":true},{"id":"date","displayName":"date","type":"string","canBeUsedToMatch":true},{"id":"time","displayName":"time","type":"string","canBeUsedToMatch":true},{"id":"caller_id","displayName":"caller_id","type":"string","canBeUsedToMatch":true},{"id":"client_name","displayName":"client_name","type":"string","canBeUsedToMatch":true},{"id":"cliniko_id","displayName":"cliniko_id","type":"string","canBeUsedToMatch":true},{"id":"village","displayName":"village","type":"string","canBeUsedToMatch":true},{"id":"duration_seconds","displayName":"duration_seconds","type":"string","canBeUsedToMatch":true},{"id":"intent","displayName":"intent","type":"string","canBeUsedToMatch":true},{"id":"outcome","displayName":"outcome","type":"string","canBeUsedToMatch":true},{"id":"escalated","displayName":"escalated","type":"string","canBeUsedToMatch":true},{"id":"errors","displayName":"errors","type":"string","canBeUsedToMatch":true},{"id":"recording_url","displayName":"recording_url","type":"string","canBeUsedToMatch":true},{"id":"notes","displayName":"notes","type":"string","canBeUsedToMatch":true}]},"options":{}},"id":"ff3f1157-8ba6-4049-8c66-c02884ed52bc","name":"Log to Google Sheets","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[1344,304],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"mode":"combine","combinationMode":"mergeByPosition","options":{}},"id":"3db133de-4ff7-4bdb-9227-8f6ffb716687","name":"Merge Branches","type":"n8n-nodes-base.merge","typeVersion":2.1,"position":[1568,208]},{"parameters":{"assignments":{"assignments":[{"id":"success-response-1","name":"success","value":true,"type":"boolean"},{"id":"success-response-2","name":"message","value":"Call processed - email and sheets logged","type":"string"},{"id":"success-response-3","name":"call_id","value":"={{ $('Compose Data for Sheets').first().json.call_id }}","type":"string"},{"id":"success-response-4","name":"timestamp","value":"={{ new Date().toISOString() }}","type":"string"}]},"options":{}},"id":"39e42df4-8cae-438f-8853-f2fb20e936a7","name":"Success Response","type":"n8n-nodes-base.set","typeVersion":3.3,"position":[1792,208]},{"parameters":{"respondWith":"json","responseBody":"={{ { \"success\": true, \"status\": \"processing\", \"message\": \"Call summary email will be sent shortly\", \"call_id\": $(\"Webhook\").first().json.body?.call?.call_id || \"unknown\" } }}","options":{}},"id":"07f3d8d7-36c9-4ea2-b550-ef4ac12ab5a4","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[0,0]}],"connections":{"Webhook":{"main":[[{"node":"Is Call Analyzed Event?","type":"main","index":0}]]},"Is Call Analyzed Event?":{"main":[[{"node":"Respond to Webhook","type":"main","index":0},{"node":"Check If Already Processed","type":"main","index":0}]]},"Check If Already Processed":{"main":[[{"node":"Skip If Already Processed","type":"main","index":0}]]},"Skip If Already Processed":{"main":[[{"node":"Mark As Processed","type":"main","index":0}]]},"Mark As Processed":{"main":[[{"node":"Postgres Load Transfer","type":"main","index":0}]]},"Postgres Load Transfer":{"main":[[{"node":"Compose Data for Email","type":"main","index":0},{"node":"Compose Data for Sheets","type":"main","index":0}]]},"Compose Data for Email":{"main":[[{"node":"Is Inbound Call > 10s?","type":"main","index":0}]]},"Is Inbound Call > 10s?":{"main":[[{"node":"Send Email via Gmail","type":"main","index":0}]]},"Send Email via Gmail":{"main":[[{"node":"Merge Branches","type":"main","index":0}]]},"Log to Google Sheets":{"main":[[{"node":"Merge Branches","type":"main","index":1}]]},"Merge Branches":{"main":[[{"node":"Success Response","type":"main","index":0}]]},"Compose Data for Sheets":{"main":[[{"node":"Log to Google Sheets","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"d9c47074-f8f3-4607-b9bd-61642db01998","triggerCount":1,"shared":[{"updatedAt":"2025-12-02T18:59:04.433Z","createdAt":"2025-12-02T18:59:04.433Z","role":"workflow:owner","workflowId":"S2WV7x99WQ77CU4l","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-02T18:59:16.063Z","createdAt":"2025-12-02T18:59:15.320Z","id":"3apIk1qWQhm75TOs","name":"RetellAI - Email Sara Transfer v2.0 UNIFIED","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/email-sara-transfer","responseMode":"responseNode","options":{}},"id":"362ee5d1-5d14-4549-b1fc-33dbda10ccbf","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-912,496],"webhookId":"1565fad1-c77c-46bf-b164-2f40bf462708"},{"parameters":{"operation":"executeQuery","query":"-- Ensure helper exists (no-op if it already does)\nCREATE TABLE IF NOT EXISTS retell_calls (\n  call_id        text PRIMARY KEY,\n  phone_number   text,\n  no_phone       boolean DEFAULT false,\n  from_number    text,\n  created_at     timestamptz DEFAULT now(),\n  updated_at     timestamptz DEFAULT now()\n);\n\nWITH t AS (\n  -- The transfer we're emailing about\n  SELECT *\n  FROM retell_transfers\n  WHERE transfer_id = '{{ $json.body?.args?.transfer_id || $json.full_body?.args?.transfer_id || $json.transfer_id }}'\n  LIMIT 1\n),\n-- Normalize the transfer callback number to AU E.164\nnorm_t AS (\n  SELECT\n    t.*,\n    t.phone_number AS t_phone_raw,\n    CASE\n      WHEN t.phone_number IS NULL OR t.phone_number = '' THEN NULL\n      WHEN t.phone_number ~ '^\\+'                    THEN t.phone_number\n      WHEN t.phone_number ~ '^0[0-9]+$'             THEN '+61' || substring(t.phone_number FROM 2)\n      ELSE '+61' || t.phone_number\n    END AS t_phone_e164,\n    -- Keep patient_id as text and also as bigint when it's numeric\n    t.patient_id::text         AS t_pid_text,\n    CASE\n      WHEN t.patient_id ~ '^[0-9]+$' THEN (t.patient_id)::bigint\n      ELSE NULL\n    END                      AS t_pid_bigint\n  FROM t\n),\n-- Safely fetch the patient using a bigint match when possible\np AS (\n  SELECT p.*\n  FROM patients p\n  WHERE p.patient_id = COALESCE( (SELECT t_pid_bigint FROM norm_t), -1 )\n  LIMIT 1\n),\n-- Normalize patient phone/mobile to AU E.164\nnorm_p AS (\n  SELECT\n    p.*,\n    CASE\n      WHEN p.phone IS NULL OR p.phone = '' THEN NULL\n      WHEN p.phone ~ '^\\+'                 THEN p.phone\n      WHEN p.phone ~ '^0[0-9]+$'           THEN '+61' || substring(p.phone FROM 2)\n      ELSE '+61' || p.phone\n    END AS p_phone_e164,\n    CASE\n      WHEN p.phone_mobile IS NULL OR p.phone_mobile = '' THEN NULL\n      WHEN p.phone_mobile ~ '^\\+'                        THEN p.phone_mobile\n      WHEN p.phone_mobile ~ '^0[0-9]+$'                  THEN '+61' || substring(p.phone_mobile FROM 2)\n      ELSE '+61' || p.phone_mobile\n    END AS p_mobile_e164\n  FROM p\n),\n-- Join retell_calls by:\n--   1) exact call_id\n--   2) the transfer's callback number (raw/E.164)\n--   3) the patient's phone or mobile (E.164)\ncandidates AS (\n  SELECT\n    nt.*,\n    rc.phone_number  AS stored_phone_number,\n    rc.no_phone      AS stored_no_phone,\n    rc.from_number   AS carrier_from_number,\n    rc.updated_at    AS rc_updated_at,\n    -- Priority: prefer rows that actually have a carrier from_number,\n    -- then those whose call_id is not a placeholder, then newest.\n    (CASE WHEN rc.from_number IS NOT NULL THEN 1 ELSE 0 END)              AS pri_has_from,\n    (CASE WHEN rc.call_id NOT IN ('unknown','current') THEN 1 ELSE 0 END) AS pri_real_callid\n  FROM norm_t nt\n  LEFT JOIN norm_p np ON TRUE\n  LEFT JOIN retell_calls rc\n    ON rc.call_id = nt.call_id\n    OR (\n      nt.t_phone_raw IS NOT NULL AND (\n           rc.phone_number = nt.t_phone_raw\n        OR rc.from_number  = nt.t_phone_raw\n        OR (nt.t_phone_e164 IS NOT NULL AND (\n               rc.phone_number = nt.t_phone_e164\n            OR rc.from_number  = nt.t_phone_e164\n        ))\n      )\n    )\n    OR (\n      (np.p_phone_e164 IS NOT NULL AND (\n           rc.phone_number = np.p_phone_e164\n        OR rc.from_number  = np.p_phone_e164\n      ))\n      OR\n      (np.p_mobile_e164 IS NOT NULL AND (\n           rc.phone_number = np.p_mobile_e164\n        OR rc.from_number  = np.p_mobile_e164\n      ))\n    )\n)\nSELECT\n  transfer_id, call_id, created_at, updated_at, caller_name,\n  phone_number, no_phone, village, intent, urgency, details, patient_id,\n  stored_phone_number, stored_no_phone, carrier_from_number\nFROM candidates\nORDER BY pri_has_from DESC, pri_real_callid DESC, rc_updated_at DESC NULLS LAST\nLIMIT 1;","options":{"queryReplacement":""}},"id":"18db800b-6d29-48ab-b55b-978123f507f1","name":"Postgres Load Transfer","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-640,496],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// UNIFIED EMAIL TEMPLATE v2.0 - Yes AI Branded\n// Transfer/Callback Request Email - Consistent with Call Summary format\n\nconst wh = $items('Webhook')?.[0]?.json || {};\nconst body = wh.body || {};\nconst call = body.call || body.args?.call || body.original_data?.call || {};\n\n// Row from Postgres Load Transfer\nconst row = Array.isArray($json) ? ($json[0] || {}) : $json;\n\n// HTML escape\nconst esc = (s) => String(s ?? '').replace(/[&<>\\\"']/g, c => (\n  {'&':'&amp;','<':'&lt;','>':'&gt;','\\\"':'&quot;',\"'\":'&#39;'}[c]\n));\n\n// AU E.164\nfunction normAU(p) {\n  if (!p) return null;\n  let d = ('' + p).replace(/[^0-9+]/g, '');\n  if (d.startsWith('+')) return d;\n  if (d.startsWith('0')) d = '61' + d.slice(1);\n  if (!d.startsWith('61')) d = '61' + d;\n  return '+' + d;\n}\n\n// Time formatting (Australia/Melbourne)\nfunction fmtAU(ts) {\n  if (!ts) return null;\n  const d = new Date(ts);\n  if (isNaN(d)) return null;\n  return d.toLocaleString('en-AU', { timeZone: 'Australia/Melbourne' });\n}\nfunction humanDuration(ms) {\n  if (ms == null || isNaN(ms)) return null;\n  const total = Math.max(0, Math.floor(Number(ms) / 1000));\n  const m = Math.floor(total / 60);\n  const s = total % 60;\n  return `${m}m ${s}s`;\n}\n\n// Role label for transcript\nfunction roleLabel(r) {\n  if (!r) return 'Unknown';\n  const t = r.toLowerCase();\n  if (['assistant','agent','ai'].includes(t)) return 'Agent';\n  if (['user','caller','human'].includes(t)) return 'User';\n  return r.charAt(0).toUpperCase() + r.slice(1);\n}\n\n// Numbers\nconst fromPhone = normAU(row.carrier_from_number || call.from_number) || '[not captured]';\nlet callbackBase = (row.no_phone === true) ? null : (row.phone_number || row.stored_phone_number || null);\nconst callbackPhone = (row.no_phone === true) ? 'No phone (declined)' : (normAU(callbackBase) || '[not provided]');\n\n// Caller/booking\nconst caller = row.caller_name || 'Unknown';\nconst village = row.village || 'N/A';\nconst intent = row.intent || 'booking';\nconst urgency = row.urgency || 'routine';\nconst details = row.details || '';\nconst patientId = row.patient_id || 'N/A';\n\n// Call meta (only include if present)\nconst startTime = fmtAU(call.start_timestamp);\nconst endTime = fmtAU(call.end_timestamp);\nconst duration = ('duration_ms' in call) ? humanDuration(call.duration_ms) : null;\nconst disconnect = call.disconnection_reason || null;\nconst recordingUrl = call.recording_url || null;\n\n// Transcript\nlet htmlTranscript = 'No transcript available';\nif (Array.isArray(call.transcript_object) && call.transcript_object.length) {\n  htmlTranscript = call.transcript_object\n    .map(t => `${esc(roleLabel(t.role))}: ${esc((t.content || '').trim())}`)\n    .join('<br><br>');\n}\n\n// Subject with urgency indicator\nconst urgencyLabel = urgency === 'urgent' ? ' (URGENT)' : '';\nconst subject = `[Reignite] ${intent.replace(/_/g, ' ')}${urgencyLabel} - ${caller}`;\n\n// Table styles\nconst td = 'style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"';\nconst th = 'style=\"padding:8px 10px;border:1px solid #e5e7eb;background:#f9fafb;text-align:left;font-weight:600;font-family:Arial,Helvetica,sans-serif;font-size:13px;line-height:18px;color:#111827\"';\nconst urgentTd = urgency === 'urgent' \n  ? 'style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px;color:#dc2626;font-weight:600\"'\n  : td;\n\n// Build conditional rows for Call Timings & Status\nlet timingsRows = `\n  <tr><td ${td}><strong>Start Time</strong></td><td ${td}>${esc(startTime || 'N/A')}</td></tr>\n`;\nif (endTime) timingsRows += `<tr><td ${td}><strong>End Time</strong></td><td ${td}>${esc(endTime)}</td></tr>`;\nif (duration) timingsRows += `<tr><td ${td}><strong>Duration</strong></td><td ${td}>${esc(duration)}</td></tr>`;\nif (disconnect) timingsRows += `<tr><td ${td}><strong>Disconnection Reason</strong></td><td ${td}>${esc(disconnect)}</td></tr>`;\n\n// Build optional Call Data & Links block only if we have a recording URL\nlet linksBlock = '';\nif (recordingUrl) {\n  linksBlock = `\n    <tr><td ${th} colspan=\"2\">Recording & Logs</td></tr>\n    <tr><td ${td}><strong>Recording</strong></td><td ${td}><a href=\"${esc(recordingUrl)}\" style=\"color:#2563eb\">Listen to recording</a></td></tr>\n  `;\n}\n\n// HTML\nconst html = `\n  <table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\"\n         style=\"border-collapse:collapse;width:100%;max-width:780px;border:1px solid #e5e7eb\">\n    <tr><td ${th} colspan=\"2\">Caller</td></tr>\n    <tr><td ${td} style=\"width:240px\"><strong>Name</strong></td><td ${td}>${esc(caller)}</td></tr>\n    <tr><td ${td}><strong>From Phone (carrier)</strong></td><td ${td}>${esc(fromPhone)}</td></tr>\n    <tr><td ${td}><strong>Callback Phone</strong></td><td ${td}>${esc(callbackPhone)}</td></tr>\n    <tr><td ${td}><strong>Village</strong></td><td ${td}>${esc(village)}</td></tr>\n\n    <tr><td ${th} colspan=\"2\">Request Details</td></tr>\n    <tr><td ${td}><strong>Intent</strong></td><td ${td}>${esc(intent.replace(/_/g, ' '))}</td></tr>\n    <tr><td ${td}><strong>Urgency</strong></td><td ${urgentTd}>${esc(urgency)}</td></tr>\n    <tr><td ${td}><strong>Patient ID</strong></td><td ${td}>${esc(patientId)}</td></tr>\n    <tr><td ${td}><strong>Details</strong></td><td ${td}>${esc(details) || '<em>No details provided</em>'}</td></tr>\n\n    <tr><td ${th} colspan=\"2\">Call Timings & Status</td></tr>\n    ${timingsRows}\n\n    ${linksBlock}\n\n    <tr><td ${th} colspan=\"2\">Transcript</td></tr>\n    <tr><td ${td} colspan=\"2\" style=\"background:#fff\">${htmlTranscript}</td></tr>\n\n    <tr><td ${th} colspan=\"2\">Technical</td></tr>\n    <tr><td ${td}><strong>Transfer ID</strong></td><td ${td}>${esc(row.transfer_id || '[unknown]')}</td></tr>\n    <tr><td ${td}><strong>Call ID</strong></td><td ${td}>${esc(row.call_id || '[unknown]')}</td></tr>\n  </table>\n  <div style=\"font-family:Arial,Helvetica,sans-serif;font-size:12px;color:#6b7280;margin-top:10px\">\n    Powered by Yes AI <a href=\"https://www.YesAI.au\" style=\"color:#6b7280;text-decoration:none\">www.YesAI.au</a>\n  </div>\n`;\n\nreturn [{ json: { subject, html } }];"},"id":"eb91b6b5-6e1c-4b0e-a1e0-119dfcf5ab52","name":"Compose Email","type":"n8n-nodes-base.code","typeVersion":2,"position":[-400,496]},{"parameters":{"jsCode":"return [{ json: { email_sent: true, success: true, message: 'Email queued/sent' } }];"},"id":"b0a25deb-8129-476a-979b-b35ec98fcc69","name":"Success JSON for Retell","type":"n8n-nodes-base.code","typeVersion":2,"position":[80,496]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"ede15efa-c737-460a-b0ed-45d8b6abb10d","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[320,496]},{"parameters":{"sendTo":"peter@yesai.au","subject":"={{$json.subject}}","message":"={{$json.html}}","options":{}},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[-128,496],"id":"4b3fdb5d-8854-4112-8cca-d0d076f34d6f","name":"Send Email via Gmail","webhookId":"28c469d5-a989-40b4-b5db-552a8cd1d8a3","credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}}],"connections":{"Webhook":{"main":[[{"node":"Postgres Load Transfer","type":"main","index":0}]]},"Postgres Load Transfer":{"main":[[{"node":"Compose Email","type":"main","index":0}]]},"Compose Email":{"main":[[{"node":"Send Email via Gmail","type":"main","index":0}]]},"Success JSON for Retell":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Send Email via Gmail":{"main":[[{"node":"Success JSON for Retell","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","saveDataSuccessExecution":"all","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"801043a7-c73f-42ac-a3c7-7f6dcd495335","triggerCount":1,"shared":[{"updatedAt":"2025-12-02T18:59:15.320Z","createdAt":"2025-12-02T18:59:15.320Z","role":"workflow:owner","workflowId":"3apIk1qWQhm75TOs","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-02T18:59:26.996Z","createdAt":"2025-12-02T18:59:26.290Z","id":"8tr0AQztNv7yWx7U","name":"RetellAI - Email Instructor v2.0 UNIFIED","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/email-instructor","responseMode":"responseNode","options":{}},"id":"951cb589-4364-4d1a-bd0c-42b3d0d29694","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-960,224],"webhookId":"email-instructor"},{"parameters":{"jsCode":"// Extract and validate request parameters\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\n// Sanitize function\nfunction sanitize(str) {\n  if (!str) return '';\n  return String(str)\n    .trim()\n    .replace(/'/g, \"''\")\n    .slice(0, 200);\n}\n\n// Extract required parameters\nconst patient_name = sanitize(args.patient_name || '');\nconst appointment_id = sanitize(args.appointment_id || '');\nconst class_type = sanitize(args.class_type || '');\nconst call_id = call.call_id || args.call_id || '';\n\n// Validate required fields\nif (!patient_name) {\n  throw new Error('patient_name is required');\n}\nif (!appointment_id) {\n  throw new Error('appointment_id is required');\n}\nif (!class_type) {\n  throw new Error('class_type is required');\n}\n\nconst startTime = Date.now();\n\nreturn [{\n  json: {\n    patient_name,\n    appointment_id,\n    class_type,\n    call_id,\n    start_time: startTime,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"92e2e87b-c57d-46ed-a1d6-6086baa19621","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-736,224]},{"parameters":{"operation":"executeQuery","query":"-- Look up instructor email from class info\nSELECT \n  cc.instructor_name,\n  ie.email as instructor_email,\n  ie.role,\n  cc.village,\n  cc.day_of_week,\n  cc.time_slot\nFROM class_cache cc\nLEFT JOIN instructor_emails ie ON cc.instructor_name = ie.instructor_name\nWHERE cc.class_name ILIKE '%' || '{{ $json.class_type }}' || '%'\n  AND cc.active = true\n  AND ie.active = true\nORDER BY cc.cached_at DESC\nLIMIT 1;","options":{"queryBatching":"independently"}},"id":"53cab43c-ee54-43b1-b51a-4aa39fcb4eb8","name":"Lookup Instructor","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-512,224],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Check if we found instructor info\nconst items = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\nif (items.length > 0 && items[0].json.instructor_email) {\n  // Found instructor\n  return [{\n    json: {\n      ...requestData,\n      instructor_name: items[0].json.instructor_name,\n      instructor_email: items[0].json.instructor_email,\n      instructor_role: items[0].json.role,\n      village: items[0].json.village,\n      day_of_week: items[0].json.day_of_week,\n      time_slot: items[0].json.time_slot,\n      instructor_found: true\n    }\n  }];\n}\n\n// No instructor found - use default/fallback\nreturn [{\n  json: {\n    ...requestData,\n    instructor_name: 'Class Instructor',\n    instructor_email: 'classes@reignitehealth.com.au',\n    instructor_role: 'Instructor',\n    instructor_found: false,\n    fallback_used: true\n  }\n}];"},"id":"e8dd170f-2836-423e-9191-bd6f921fbc53","name":"Check Instructor Found","type":"n8n-nodes-base.code","typeVersion":2,"position":[-288,224]},{"parameters":{"jsCode":"// UNIFIED EMAIL TEMPLATE v2.0 - Yes AI Branded\n// Instructor notification email - HTML table format matching other emails\n\nconst data = $items(\"Check Instructor Found\")[0].json;\n\n// HTML escape\nconst esc = (s) => String(s ?? '').replace(/[&<>\\\"']/g, c => (\n  {'&':'&amp;','<':'&lt;','>':'&gt;','\\\"':'&quot;',\"'\":'&#39;'}[c]\n));\n\nconst subject = `[Reignite] New Class Enrollment: ${data.patient_name} - ${data.class_type}`;\n\n// Table styles (matching other email formats)\nconst td = 'style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"';\nconst th = 'style=\"padding:8px 10px;border:1px solid #e5e7eb;background:#f9fafb;text-align:left;font-weight:600;font-family:Arial,Helvetica,sans-serif;font-size:13px;line-height:18px;color:#111827\"';\n\n// Build class details rows\nlet classDetailsRows = `\n  <tr><td ${td}><strong>Class Type</strong></td><td ${td}>${esc(data.class_type)}</td></tr>\n`;\nif (data.village) classDetailsRows += `<tr><td ${td}><strong>Village</strong></td><td ${td}>${esc(data.village)}</td></tr>`;\nif (data.day_of_week) classDetailsRows += `<tr><td ${td}><strong>Day</strong></td><td ${td}>${esc(data.day_of_week)}</td></tr>`;\nif (data.time_slot) classDetailsRows += `<tr><td ${td}><strong>Time</strong></td><td ${td}>${esc(data.time_slot)}</td></tr>`;\n\n// Build HTML email\nconst html = `\n  <table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\"\n         style=\"border-collapse:collapse;width:100%;max-width:780px;border:1px solid #e5e7eb\">\n    <tr><td ${th} colspan=\"2\">New Enrollment Notification</td></tr>\n    <tr><td ${td} colspan=\"2\" style=\"background:#ecfdf5;color:#065f46\">\n      A new patient has been enrolled in your class via the Reignite Health AI receptionist.\n    </td></tr>\n\n    <tr><td ${th} colspan=\"2\">Patient Details</td></tr>\n    <tr><td ${td} style=\"width:240px\"><strong>Patient Name</strong></td><td ${td}>${esc(data.patient_name)}</td></tr>\n    <tr><td ${td}><strong>Appointment ID</strong></td><td ${td}>${esc(data.appointment_id)}</td></tr>\n\n    <tr><td ${th} colspan=\"2\">Class Details</td></tr>\n    ${classDetailsRows}\n\n    <tr><td ${th} colspan=\"2\">Instructor</td></tr>\n    <tr><td ${td}><strong>Name</strong></td><td ${td}>${esc(data.instructor_name)}</td></tr>\n    <tr><td ${td}><strong>Email</strong></td><td ${td}>${esc(data.instructor_email)}</td></tr>\n    ${data.instructor_found === false ? `<tr><td ${td} colspan=\"2\" style=\"background:#fef3c7;color:#92400e\"><em>Note: Instructor not found in database, using fallback email</em></td></tr>` : ''}\n\n    <tr><td ${th} colspan=\"2\">Action Required</td></tr>\n    <tr><td ${td} colspan=\"2\">\n      Please confirm receipt and prepare for the new participant.<br><br>\n      If you have any questions, please contact the office directly.\n    </td></tr>\n  </table>\n  <div style=\"font-family:Arial,Helvetica,sans-serif;font-size:12px;color:#6b7280;margin-top:10px\">\n    Powered by Yes AI <a href=\"https://www.YesAI.au\" style=\"color:#6b7280;text-decoration:none\">www.YesAI.au</a>\n  </div>\n  <div style=\"font-family:Arial,Helvetica,sans-serif;font-size:11px;color:#9ca3af;margin-top:5px\">\n    This is an automated notification. Please do not reply to this email.\n  </div>\n`;\n\nreturn [{\n  json: {\n    ...data,\n    email_subject: subject,\n    email_html: html\n  }\n}];"},"id":"01e1dd80-adb6-4a9c-909e-8ba72c1e4dd8","name":"Build Email Content","type":"n8n-nodes-base.code","typeVersion":2,"position":[-80,224]},{"parameters":{"sendTo":"={{ $json.instructor_email }}","subject":"={{ $json.email_subject }}","message":"={{ $json.email_html }}","options":{}},"id":"32b67f7a-c7db-430c-ba90-c2319960f311","name":"Send Email via Gmail","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[160,224],"webhookId":"77d04f14-ede7-4f93-a996-c8ed8f32b568","credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}},"continueOnFail":true},{"parameters":{"jsCode":"// Check if email sent successfully\nconst emailResult = $items(\"Send Email via Gmail\")[0];\nconst emailData = $items(\"Build Email Content\")[0].json;\n\nconst emailSent = !emailResult.error;\nconst sentStatus = emailSent ? 'sent' : 'failed';\nconst errorMessage = emailResult.error ? String(emailResult.error) : null;\n\nreturn [{\n  json: {\n    ...emailData,\n    email_sent: emailSent,\n    sent_status: sentStatus,\n    error_message: errorMessage\n  }\n}];"},"id":"2cd022fb-665e-409d-84fa-6caeb3ec2b93","name":"Check Email Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[368,224]},{"parameters":{"operation":"executeQuery","query":"-- Log the email notification with send status\nINSERT INTO email_notifications (\n  recipient_email,\n  recipient_name,\n  subject,\n  body_text,\n  notification_type,\n  related_appointment_id,\n  related_patient_name,\n  sent_status,\n  call_id,\n  sent_at,\n  created_at\n)\nVALUES (\n  '{{ $json.instructor_email }}',\n  '{{ $json.instructor_name }}',\n  '{{ $json.email_subject }}',\n  '{{ $json.email_html }}',\n  'class_enrollment',\n  '{{ $json.appointment_id }}',\n  '{{ $json.patient_name }}',\n  '{{ $json.sent_status }}',\n  '{{ $json.call_id }}',\n  now(),\n  now()\n)\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"b876a099-99ff-4a86-8a01-de443836257b","name":"Log Email Notification","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[592,224],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Build success response\nconst emailData = $items(\"Log Email Notification\")[0].json;\nconst resultData = $items(\"Check Email Result\")[0].json;\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\nconst response = {\n  success: true,\n  email_sent: resultData.email_sent,\n  email_logged: true,\n  notification_id: emailData.id,\n  instructor_name: resultData.instructor_name,\n  instructor_email: resultData.instructor_email,\n  patient_name: resultData.patient_name,\n  class_type: resultData.class_type,\n  sent_status: resultData.sent_status,\n  message: resultData.email_sent \n    ? \"Instructor notified successfully via email\" \n    : \"Email logged but send failed (check logs)\",\n  call_id: requestData.call_id,\n  timestamp: new Date().toISOString()\n};\n\nif (resultData.error_message) {\n  response.error_details = resultData.error_message;\n}\n\nreturn [{ json: response }];"},"id":"c4412a11-73fd-4c1f-b434-81777c55c98d","name":"Build Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[816,224]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"536aa0b9-d0eb-49da-b1a5-4d3ae0b507f3","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1040,224]},{"parameters":{"operation":"executeQuery","query":"-- Log webhook execution\nINSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_body,\n  response_body,\n  success,\n  duration_ms,\n  cache_hit,\n  created_at\n)\nVALUES (\n  'email-instructor',\n  '{{ $items(\"Extract Request Data\")[0].json.call_id }}',\n  '{{ JSON.stringify($items(\"Extract Request Data\")[0].json) }}'::jsonb,\n  '{{ JSON.stringify($items(\"Build Response\")[0].json) }}'::jsonb,\n  true,\n  {{ Math.round((Date.now() - $items(\"Extract Request Data\")[0].json.start_time)) }},\n  false,\n  now()\n)\nRETURNING *;","options":{}},"id":"a2f74630-bb20-46d1-9b60-1d8a269e6546","name":"Log Webhook Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1248,224],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Lookup Instructor","type":"main","index":0}]]},"Lookup Instructor":{"main":[[{"node":"Check Instructor Found","type":"main","index":0}]]},"Check Instructor Found":{"main":[[{"node":"Build Email Content","type":"main","index":0}]]},"Build Email Content":{"main":[[{"node":"Send Email via Gmail","type":"main","index":0}]]},"Send Email via Gmail":{"main":[[{"node":"Check Email Result","type":"main","index":0}]]},"Check Email Result":{"main":[[{"node":"Log Email Notification","type":"main","index":0}]]},"Log Email Notification":{"main":[[{"node":"Build Response","type":"main","index":0}]]},"Build Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Webhook Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"8f7ffbd1-a77c-4be5-89dd-e00af3cdd9e8","triggerCount":1,"shared":[{"updatedAt":"2025-12-02T18:59:26.290Z","createdAt":"2025-12-02T18:59:26.290Z","role":"workflow:owner","workflowId":"8tr0AQztNv7yWx7U","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-04T06:10:16.817Z","createdAt":"2025-12-03T18:02:55.847Z","id":"gWWGCJWT6ZFjBloF","name":"RetellAI - Get Class Schedule v2.5 FIRST AVAILABLE","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-class-schedule","responseMode":"responseNode","options":{}},"id":"webhook-main","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,200],"webhookId":"get-class-schedule"},{"parameters":{"jsCode":"// Extract and validate request parameters with FUZZY VILLAGE MATCHING\n// v2.2: DATE FIX - Proper date comparison (not string comparison!)\nconst body = $json.body || $json;\nconst args = body.args || {};\nconst call = body.call || {};\n\n// ============================================\n// CLASS NAME ALIASES\n// Maps common spoken names to actual database class names\n// ============================================\nconst CLASS_ALIASES = {\n  // Hydrotherapy aliases\n  'aqua': 'Hydrotherapy',\n  'aqua class': 'Hydrotherapy',\n  'aqua therapy': 'Hydrotherapy',\n  'aquatic': 'Hydrotherapy',\n  'aquatics': 'Hydrotherapy',\n  'hydro': 'Hydrotherapy',\n  'hydrotherapy': 'Hydrotherapy',\n  'water': 'Hydrotherapy',\n  'water class': 'Hydrotherapy',\n  'pool': 'Hydrotherapy',\n  'pool class': 'Hydrotherapy',\n  'swimming': 'Hydrotherapy',\n  'equity': 'Hydrotherapy',\n  'equity class': 'Hydrotherapy',\n  \n  // Better Balance aliases\n  'balance': 'Better Balance',\n  'better balance': 'Better Balance',\n  'falls': 'Better Balance',\n  'falls prevention': 'Better Balance',\n  'fall prevention': 'Better Balance',\n  'balance class': 'Better Balance',\n  \n  // Gym Fit aliases\n  'gym': 'Gym Fit',\n  'gym fit': 'Gym Fit',\n  'gymfit': 'Gym Fit',\n  'gym class': 'Gym Fit',\n  'fitness': 'Gym Fit',\n  'strength': 'Gym Fit',\n  'strength training': 'Gym Fit',\n  \n  // Pilates aliases\n  'pilates': 'Pilates',\n  'mat pilates': 'Pilates',\n  \n  // Tai Chi aliases\n  'tai chi': 'Tai Chi',\n  'taichi': 'Tai Chi',\n  'tai-chi': 'Tai Chi'\n};\n\n// Function to resolve class name from alias\nfunction resolveClassName(input) {\n  if (!input) return 'Better Balance';\n  const normalized = input.toLowerCase().trim();\n  \n  // Direct alias match\n  if (CLASS_ALIASES[normalized]) {\n    return CLASS_ALIASES[normalized];\n  }\n  \n  // Partial match - check if input contains any alias key\n  for (const [alias, canonical] of Object.entries(CLASS_ALIASES)) {\n    if (normalized.includes(alias) || alias.includes(normalized)) {\n      return canonical;\n    }\n  }\n  \n  // No match - return original (will search as-is in database)\n  return input.trim();\n}\n\n// Known villages - MUST match actual database values in group_appointments_with_details\nconst KNOWN_VILLAGES = [\n  'The Baytree',\n  'Glenaeon',\n  'Henry Kendall',\n  'Oak Village',\n  'The Peninsula',\n  'Banksia Village',\n  'Harbourside Haven',\n  'Lakeside Gardens',\n  'Riverside Lodge',\n  'Gordon Quarter'\n];\n\n// DATABASE ALIASES: Maps user-facing name to what's actually in Cliniko/database\nconst DB_ALIASES = {};\n\n// Phonetic/fuzzy matching helpers\nfunction normalizeVillage(name) {\n  if (!name) return '';\n  return String(name)\n    .toLowerCase()\n    .trim()\n    .replace(/^the\\s+/i, '')\n    .replace(/[^a-z0-9\\s]/g, '')\n    .replace(/\\s+/g, ' ');\n}\n\nfunction phoneticCode(str) {\n  if (!str) return '';\n  const s = normalizeVillage(str);\n  return s\n    .replace(/ph/g, 'f')\n    .replace(/ck/g, 'k')\n    .replace(/gh/g, '')\n    .replace(/wr/g, 'r')\n    .replace(/kn/g, 'n')\n    .replace(/wh/g, 'w')\n    .replace(/[aeiou]/g, '')\n    .replace(/(.)\\1+/g, '$1');\n}\n\nfunction levenshtein(a, b) {\n  if (!a || !b) return 100;\n  a = normalizeVillage(a);\n  b = normalizeVillage(b);\n  if (a === b) return 0;\n  \n  const matrix = [];\n  for (let i = 0; i <= b.length; i++) matrix[i] = [i];\n  for (let j = 0; j <= a.length; j++) matrix[0][j] = j;\n  \n  for (let i = 1; i <= b.length; i++) {\n    for (let j = 1; j <= a.length; j++) {\n      if (b[i-1] === a[j-1]) {\n        matrix[i][j] = matrix[i-1][j-1];\n      } else {\n        matrix[i][j] = Math.min(\n          matrix[i-1][j-1] + 1,\n          matrix[i][j-1] + 1,\n          matrix[i-1][j] + 1\n        );\n      }\n    }\n  }\n  return matrix[b.length][a.length];\n}\n\nfunction similarityScore(input, candidate) {\n  const normInput = normalizeVillage(input);\n  const normCandidate = normalizeVillage(candidate);\n  \n  if (normInput === normCandidate) return 100;\n  if (normCandidate.includes(normInput) || normInput.includes(normCandidate)) return 90;\n  \n  const phoneticInput = phoneticCode(input);\n  const phoneticCandidate = phoneticCode(candidate);\n  if (phoneticInput === phoneticCandidate) return 85;\n  \n  const maxLen = Math.max(normInput.length, normCandidate.length);\n  const distance = levenshtein(input, candidate);\n  const similarity = Math.round((1 - distance / maxLen) * 100);\n  \n  const phoneticDistance = levenshtein(phoneticInput, phoneticCandidate);\n  if (phoneticDistance <= 2) return Math.min(100, similarity + 15);\n  \n  return similarity;\n}\n\nfunction findBestVillageMatches(input, threshold = 50) {\n  if (!input) return [];\n  \n  const scores = KNOWN_VILLAGES.map(village => ({\n    village,\n    score: similarityScore(input, village)\n  }));\n  \n  return scores\n    .filter(s => s.score >= threshold)\n    .sort((a, b) => b.score - a.score)\n    .slice(0, 3);\n}\n\n// Extract parameters\nconst rawClassType = args.class_type || body.class_type || 'Better Balance';\nconst rawVillage = args.village || body.village || 'Baytree';\nconst weeks_ahead = Math.min(args.weeks_ahead || body.weeks_ahead || 4, 8);\n\n// v2.2: Extract requested date with proper handling\nconst rawRequestedDate = args.date || body.date || null;\nlet requestedDate = null;\nlet requestedDateInfo = { provided: false };\n\nif (rawRequestedDate) {\n  // Parse the date - could be YYYY-MM-DD or other formats\n  const parsed = new Date(rawRequestedDate);\n  if (!isNaN(parsed.getTime())) {\n    requestedDate = parsed.toISOString().split('T')[0];\n    requestedDateInfo = {\n      provided: true,\n      raw_input: rawRequestedDate,\n      parsed_date: requestedDate\n    };\n  }\n}\n\n// v2.2 FIX: Use Date objects for comparison, NOT string comparison!\n// String comparison \"2025-02-01\" < \"2025-12-04\" is true (alphabetical)\n// but Feb 2025 is AFTER Dec 2024!\nconst now = new Date();\nconst todayDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());\nconst todayStr = todayDate.toISOString().split('T')[0];\n\nlet effectiveDate = requestedDate || todayStr;\n\n// If date was provided, check if it's in the past using DATE comparison\nif (requestedDate) {\n  let requestedDateObj = new Date(requestedDate + 'T00:00:00');\n  \n  // v2.3 FIX: YEAR ROLLOVER SAFETY NET\n  // If date is more than 30 days in the past, it's likely a year error from the LLM\n  // e.g., LLM sent 2025-01-15 when today is Dec 2025, but user meant Jan 2026\n  const daysDiff = (todayDate.getTime() - requestedDateObj.getTime()) / (1000 * 60 * 60 * 24);\n  \n  if (daysDiff > 30) {\n    // Date is significantly in the past - assume year error, add 1 year\n    requestedDateObj.setFullYear(requestedDateObj.getFullYear() + 1);\n    effectiveDate = requestedDateObj.toISOString().split('T')[0];\n    requestedDateInfo.year_corrected = true;\n    requestedDateInfo.original_year = requestedDate.substring(0, 4);\n    requestedDateInfo.corrected_year = effectiveDate.substring(0, 4);\n    requestedDateInfo.correction_reason = 'Date was ' + Math.round(daysDiff) + ' days in past, assumed year error';\n  } else if (requestedDateObj.getTime() < todayDate.getTime()) {\n    // Date is slightly in the past (< 30 days) - use today instead\n    effectiveDate = todayStr;\n    requestedDateInfo.adjusted_to_today = true;\n    requestedDateInfo.original_was_past = true;\n  }\n  // else: date is in future, use as-is (effectiveDate already set)\n}\n\n// Resolve class type from alias\nconst resolvedClassType = resolveClassName(rawClassType);\nconst classTypeMatchInfo = {\n  input: rawClassType,\n  resolved_to: resolvedClassType,\n  was_alias: rawClassType.toLowerCase().trim() !== resolvedClassType.toLowerCase()\n};\n\n// Find best village matches\nconst villageMatches = findBestVillageMatches(rawVillage);\nconst bestMatch = villageMatches[0];\n\nlet resolvedVillage = rawVillage;\nlet villageMatchInfo = {\n  input: rawVillage,\n  matched: false,\n  exact: false,\n  candidates: villageMatches\n};\n\nif (bestMatch && bestMatch.score >= 70) {\n  resolvedVillage = bestMatch.village;\n  villageMatchInfo.matched = true;\n  villageMatchInfo.exact = bestMatch.score === 100;\n  villageMatchInfo.resolved_to = resolvedVillage;\n  villageMatchInfo.confidence = bestMatch.score;\n}\n\n// Get database search term (may differ from canonical name due to Cliniko typos)\nconst villageForDb = DB_ALIASES[resolvedVillage] || resolvedVillage;\n\n// Cache key includes date for date-specific caching\nconst cache_key = `class_schedule_v7_${normalizeVillage(resolvedVillage).replace(/\\s+/g, '_')}_${resolvedClassType.toLowerCase().replace(/\\s+/g, '_')}_${effectiveDate}`;\n\nif (!rawClassType || rawClassType === '') {\n  throw new Error('Missing class_type');\n}\n\nif (!rawVillage || rawVillage === '') {\n  throw new Error('Missing village');\n}\n\nreturn [{\n  json: {\n    class_type: resolvedClassType,\n    class_type_input: rawClassType,\n    class_type_match: classTypeMatchInfo,\n    village: resolvedVillage,\n    village_db: villageForDb,\n    village_input: rawVillage,\n    village_match: villageMatchInfo,\n    weeks_ahead: weeks_ahead,\n    requested_date: effectiveDate,\n    requested_date_info: requestedDateInfo,\n    cache_key: cache_key,\n    call_id: call.call_id || args.call_id || 'manual-test',\n    request_timestamp: new Date().toISOString(),\n    start_time: Date.now(),\n    version: 'v2.3-year-rollover'\n  }\n}];"},"id":"extract-request","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[220,200]},{"parameters":{"operation":"executeQuery","query":"SELECT id, cache_key, data, cached_at FROM webhook_cache WHERE cache_key = '{{ $json.cache_key }}' AND cached_at > NOW() - INTERVAL '2 hours' LIMIT 1;","options":{}},"id":"check-cache","name":"Check Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[440,200],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Handle cache check result - v2.2 with Sydney timezone\nconst cacheItems = $input.all();\nconst requestData = $('Extract Request Data').first().json;\n\nconst SYDNEY_TZ = 'Australia/Sydney';\n\nfunction formatDateSpoken(dateStr) {\n  const date = new Date(dateStr);\n  const day = parseInt(date.toLocaleDateString('en-AU', { timeZone: SYDNEY_TZ, day: 'numeric' }));\n  const month = date.toLocaleDateString('en-AU', { timeZone: SYDNEY_TZ, month: 'long' });\n  const suffix = (day > 3 && day < 21) ? 'th' : ['st', 'nd', 'rd'][(day % 10) - 1] || 'th';\n  return `${day}${suffix} of ${month}`;\n}\n\nfunction getDayName(dateStr) {\n  return new Date(dateStr).toLocaleDateString('en-AU', { timeZone: SYDNEY_TZ, weekday: 'long' });\n}\n\nfunction formatTime(dateStr) {\n  return new Date(dateStr).toLocaleTimeString('en-AU', {\n    timeZone: SYDNEY_TZ,\n    hour: 'numeric',\n    minute: '2-digit',\n    hour12: true\n  });\n}\n\nfunction generateSpokenText(data) {\n  if (!data) return '';\n\n  if (data.success === false) {\n    const village = data.village || 'your village';\n    const classType = data.class_type || 'Better Balance';\n    return `I'm sorry, there are no ${classType} classes currently scheduled at ${village}. Would you like me to check a different class type, or would you prefer I organise a callback from Sara to discuss options?`;\n  }\n\n  const session = data.next_session;\n  if (!session) return '';\n\n  const dayName = session.day_name || getDayName(session.date);\n  const dateSpoken = formatDateSpoken(session.date);\n  const timeFormatted = session.time || '10:00 am';\n  const spaces = session.spaces_available || 0;\n  const spacesText = spaces === 1 ? '1 spot' : `${spaces} spots`;\n\n  let text = `The next ${data.class_type} class at ${data.village} is on ${dayName}, the ${dateSpoken} at ${timeFormatted}. There are ${spacesText} available.`;\n\n  if (data.recurring_pattern) {\n    text += ` This class runs every ${data.recurring_pattern.day} at ${data.recurring_pattern.time}.`;\n  }\n\n  text += ' Would you like me to book a spot for you?';\n  return text;\n}\n\nconst hasValidCache =\n  cacheItems.length > 0 &&\n  cacheItems[0].json &&\n  cacheItems[0].json.id &&\n  cacheItems[0].json.data;\n\nif (hasValidCache) {\n  const cached = cacheItems[0].json;\n  const cachedData = typeof cached.data === 'string' ? JSON.parse(cached.data) : cached.data;\n  const duration_ms = Date.now() - requestData.start_time;\n\n  const spoken_text = cachedData.spoken_text || generateSpokenText(cachedData);\n\n  return [{\n    json: {\n      ...cachedData,\n      spoken_text: spoken_text,\n      message: spoken_text,\n      from_cache: true,\n      cache_hit: true,\n      cached_at: cached.cached_at,\n      duration_ms: duration_ms,\n      call_id: requestData.call_id,\n      village_match: requestData.village_match,\n      class_type_match: requestData.class_type_match,\n      timestamp: new Date().toISOString(),\n      version: 'v2.2-date-fix'\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    ...requestData,\n    from_cache: false,\n    cache_hit: false\n  }\n}];"},"id":"handle-cache","name":"Handle Cache Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[660,200]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"cache-hit-condition","leftValue":"={{ $json.cache_hit }}","rightValue":true,"operator":{"type":"boolean","operation":"equals","singleValue":true}}],"combinator":"and"},"options":{}},"id":"cache-check-if","name":"Cache Hit?","type":"n8n-nodes-base.if","typeVersion":2,"position":[880,200]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-cache-hit","name":"Respond Cache Hit","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1100,100]},{"parameters":{"operation":"executeQuery","query":"-- v2.2: Query uses requested_date for future date searches\nSELECT \n    id,\n    appointment_type_name,\n    starts_at,\n    ends_at,\n    duration_minutes,\n    max_attendees,\n    attendee_count,\n    spaces_available,\n    village,\n    business_name,\n    is_cancelled,\n    last_synced,\n    class_type\nFROM group_appointments_with_details\nWHERE class_type = '{{ $json.class_type }}'\n  AND village = '{{ $json.village_db }}'\n  AND starts_at >= '{{ $json.requested_date }}'::date\n  AND starts_at < NOW() + INTERVAL '60 days'\n  AND is_cancelled = false\n  AND is_deleted = false\nORDER BY starts_at ASC\nLIMIT 10;","options":{}},"id":"query-appointments","name":"Query Group Appointments","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1100,300],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Format response with SPOKEN_TEXT - v2.2 with Sydney timezone\nconst items = $input.all();\nconst requestData = $('Cache Hit?').first().json;\nconst duration_ms = Date.now() - requestData.start_time;\n\nconst SYDNEY_TZ = 'Australia/Sydney';\n\nfunction formatDateSpoken(dateStr) {\n  const date = new Date(dateStr);\n  const day = parseInt(date.toLocaleDateString('en-AU', { timeZone: SYDNEY_TZ, day: 'numeric' }));\n  const month = date.toLocaleDateString('en-AU', { timeZone: SYDNEY_TZ, month: 'long' });\n  return `${day}${getOrdinalSuffix(day)} of ${month}`;\n}\n\nfunction getOrdinalSuffix(day) {\n  if (day > 3 && day < 21) return 'th';\n  switch (day % 10) {\n    case 1: return 'st';\n    case 2: return 'nd';\n    case 3: return 'rd';\n    default: return 'th';\n  }\n}\n\nfunction formatDate(dateStr) {\n  const date = new Date(dateStr);\n  const parts = date.toLocaleDateString('en-AU', {\n    timeZone: SYDNEY_TZ,\n    year: 'numeric',\n    month: '2-digit',\n    day: '2-digit'\n  }).split('/');\n  return `${parts[2]}-${parts[1]}-${parts[0]}`;\n}\n\nfunction formatTime(dateStr) {\n  const date = new Date(dateStr);\n  return date.toLocaleTimeString('en-AU', {\n    timeZone: SYDNEY_TZ,\n    hour: 'numeric',\n    minute: '2-digit',\n    hour12: true\n  });\n}\n\nfunction getDayName(dateStr) {\n  const date = new Date(dateStr);\n  return date.toLocaleDateString('en-AU', { timeZone: SYDNEY_TZ, weekday: 'long' });\n}\n\nfunction detectRecurringPattern(sessions) {\n  if (sessions.length < 2) return null;\n\n  const days = sessions.map(s => new Date(s.starts_at).getDay());\n  const times = sessions.map(s => formatTime(s.starts_at));\n\n  if (days.every(d => d === days[0]) && times.every(t => t === times[0])) {\n    return {\n      day: getDayName(sessions[0].starts_at),\n      time: times[0],\n      frequency: 'Weekly'\n    };\n  }\n  return null;\n}\n\nif (items.length === 0 || !items[0].json.starts_at) {\n  const villageMatch = requestData.village_match || {};\n  const classTypeMatch = requestData.class_type_match || {};\n  const requestedVillage = requestData.village || '';\n  const classType = requestData.class_type || 'Better Balance';\n\n  let spoken_text = `I'm sorry, there are no ${classType} classes currently scheduled at ${requestedVillage}. Would you like me to check a different class type, or would you prefer I organise a callback from Sara to discuss options?`;\n\n  return [{\n    json: {\n      success: false,\n      message: spoken_text,\n      spoken_text: spoken_text,\n      class_type: classType,\n      class_type_input: requestData.class_type_input,\n      class_type_match: classTypeMatch,\n      village: requestedVillage,\n      village_input: requestData.village_input,\n      village_match: villageMatch,\n      requested_date: requestData.requested_date,\n      requested_date_info: requestData.requested_date_info,\n      call_id: requestData.call_id,\n      timestamp: new Date().toISOString(),\n      duration_ms: duration_ms,\n      from_cache: false,\n      cache_hit: false,\n      cache_key: requestData.cache_key,\n      version: 'v2.4-capacity-fix'\n    }\n  }];\n}\n\nconst sessions = items.map(item => item.json);\n// v2.5 FIX: Find first AVAILABLE session (spaces_available > 0), or fallback to first\nconst nextSession = sessions.find(s => s.spaces_available > 0) || sessions[0];\nconst allBooked = !sessions.some(s => s.spaces_available > 0);\nconst recurringPattern = detectRecurringPattern(sessions);\n\nconst lastSynced = new Date(nextSession.last_synced);\nconst now = new Date();\nconst cacheAgeHours = Math.floor((now - lastSynced) / (1000 * 60 * 60));\n\nconst villageMatch = requestData.village_match || {};\nconst classTypeMatch = requestData.class_type_match || {};\n\nconst dayName = getDayName(nextSession.starts_at);\nconst dateSpoken = formatDateSpoken(nextSession.starts_at);\nconst timeFormatted = formatTime(nextSession.starts_at);\nconst spaces = nextSession.spaces_available;\n\n// v2.5 FIX: Now uses first AVAILABLE session, or offers waitlist if ALL are booked\nlet spoken_text;\n\nif (allBooked) {\n  // ALL sessions are full - offer waitlist for the chronologically first one\n  const firstSession = sessions[0];\n  const firstDayName = getDayName(firstSession.starts_at);\n  const firstDateSpoken = formatDateSpoken(firstSession.starts_at);\n  const firstTimeFormatted = formatTime(firstSession.starts_at);\n  spoken_text = `I'm sorry, but all upcoming ${requestData.class_type} classes at ${requestData.village} are currently fully booked. The next one is on ${firstDayName}, the ${firstDateSpoken} at ${firstTimeFormatted}. Would you like me to add you to the waitlist?`;\n} else if (spaces <= 2) {\n  // Low spots - create urgency (using first AVAILABLE session)\n  const spacesText = spaces === 1 ? '1 spot' : `${spaces} spots`;\n  spoken_text = `The next available ${requestData.class_type} class at ${requestData.village} is on ${dayName}, the ${dateSpoken} at ${timeFormatted}. There are only ${spacesText} left! Would you like me to book one for you?`;\n  if (recurringPattern) {\n    spoken_text = spoken_text.replace('Would you like', `This class runs every ${recurringPattern.day} at ${recurringPattern.time}. Would you like`);\n  }\n} else {\n  // Normal capacity (using first AVAILABLE session)\n  const spacesText = `${spaces} spots`;\n  spoken_text = `The next available ${requestData.class_type} class at ${requestData.village} is on ${dayName}, the ${dateSpoken} at ${timeFormatted}. There are ${spacesText} available.`;\n  if (recurringPattern) {\n    spoken_text += ` This class runs every ${recurringPattern.day} at ${recurringPattern.time}.`;\n  }\n  spoken_text += ` Would you like me to book a spot for you?`;\n}\n\nreturn [{\n  json: {\n    success: true,\n    spoken_text: spoken_text,\n    message: spoken_text,\n    next_class_id: nextSession.id,\n    class_type: requestData.class_type,\n    class_type_input: requestData.class_type_input,\n    class_type_match: classTypeMatch,\n    village: requestData.village,\n    village_input: requestData.village_input,\n    village_match: villageMatch,\n    next_session: {\n      id: nextSession.id,\n      date: formatDate(nextSession.starts_at),\n      day_name: dayName,\n      time: timeFormatted,\n      duration_minutes: nextSession.duration_minutes,\n      spaces_available: nextSession.spaces_available,\n      max_capacity: nextSession.max_attendees,\n      location: nextSession.business_name\n    },\n    upcoming_sessions: sessions.slice(0, 4).map(s => ({\n      id: s.id,\n      date: formatDate(s.starts_at),\n      day_name: getDayName(s.starts_at),\n      time: formatTime(s.starts_at),\n      spaces: s.spaces_available,\n      max: s.max_attendees\n    })),\n    recurring_pattern: recurringPattern,\n    total_sessions_found: sessions.length,\n    requested_date: requestData.requested_date,\n    requested_date_info: requestData.requested_date_info,\n    call_id: requestData.call_id,\n    timestamp: new Date().toISOString(),\n    from_cache: false,\n    cache_hit: false,\n    cache_age_hours: cacheAgeHours,\n    duration_ms: duration_ms,\n    cache_key: requestData.cache_key,\n    version: 'v2.5-first-available-fix'\n  }\n}];"},"id":"format-response","name":"Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1320,300]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_cache (cache_key, data, cached_at) VALUES ('{{ $json.cache_key }}', '{{ JSON.stringify($json).replace(/'/g, \"''\") }}'::jsonb, NOW()) ON CONFLICT (cache_key) DO UPDATE SET data = EXCLUDED.data, cached_at = EXCLUDED.cached_at RETURNING *;","options":{}},"id":"store-cache","name":"Store in Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1540,300],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"const formatResponse = $('Format Response').first();\nif (formatResponse && formatResponse.json) {\n  return [{ json: formatResponse.json }];\n}\n\nconst result = $input.item.json;\nif (result && result.data) {\n  const data = typeof result.data === 'string' ? JSON.parse(result.data) : result.data;\n  return [{ json: data }];\n}\n\nreturn $input.all();"},"id":"prepare-response","name":"Prepare Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1760,300]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-miss","name":"Respond Cache Miss","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1980,300]}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Check Cache","type":"main","index":0}]]},"Check Cache":{"main":[[{"node":"Handle Cache Result","type":"main","index":0}]]},"Handle Cache Result":{"main":[[{"node":"Cache Hit?","type":"main","index":0}]]},"Cache Hit?":{"main":[[{"node":"Respond Cache Hit","type":"main","index":0}],[{"node":"Query Group Appointments","type":"main","index":0}]]},"Query Group Appointments":{"main":[[{"node":"Format Response","type":"main","index":0}]]},"Format Response":{"main":[[{"node":"Store in Cache","type":"main","index":0}]]},"Store in Cache":{"main":[[{"node":"Prepare Response","type":"main","index":0}]]},"Prepare Response":{"main":[[{"node":"Respond Cache Miss","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"e76d3d17-2b9c-4e51-9acc-2620a38a1c9e","triggerCount":1,"shared":[{"updatedAt":"2025-12-03T18:02:55.847Z","createdAt":"2025-12-03T18:02:55.847Z","role":"workflow:owner","workflowId":"gWWGCJWT6ZFjBloF","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-04T05:06:21.207Z","createdAt":"2025-12-04T05:03:22.198Z","id":"5XywYcZdWVB5Uf1X","name":"Server Health Receiver","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"server-health-report","responseMode":"lastNode","options":{}},"id":"webhook","name":"Receive Health Report","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"server-health-report"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"combinator":"and","conditions":[{"id":"has-issues","leftValue":"={{ $json.body?.issues?.length > 0 }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}]}},"id":"check-issues","name":"Has Issues?","type":"n8n-nodes-base.if","typeVersion":2,"position":[220,0]},{"parameters":{"sendTo":"peter@yesai.au","subject":"=‚ö†Ô∏è Server Health Alert: {{ $('Receive Health Report').item.json.body.server }}","message":"=<html><body><h2>Server Health Alert</h2><p><strong>Server:</strong> {{ $('Receive Health Report').item.json.body.server }} ({{ $('Receive Health Report').item.json.body.ip }})</p><p><strong>Time:</strong> {{ $('Receive Health Report').item.json.body.timestamp }}</p><h3>Issues Found:</h3><ul>{{ $('Receive Health Report').item.json.body.issues.map(i => '<li>' + i + '</li>').join('') }}</ul><h3>Full Status:</h3><pre>{{ JSON.stringify($('Receive Health Report').item.json.body.checks, null, 2) }}</pre><hr><p><em>Automated alert from n8n</em></p></body></html>","options":{}},"id":"send-alert","name":"Send Alert Email","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[500,-100],"credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}},{"parameters":{"values":{"string":[{"name":"status","value":"received"},{"name":"message","value":"=All healthy - no issues detected on {{ $('Receive Health Report').item.json.body.server }}"}]},"options":{}},"id":"no-issues","name":"All Healthy Response","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[500,100]}],"connections":{"Receive Health Report":{"main":[[{"node":"Has Issues?","type":"main","index":0}]]},"Has Issues?":{"main":[[{"node":"Send Alert Email","type":"main","index":0}],[{"node":"All Healthy Response","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"763cb016-9274-4b2a-9e86-d652009f05da","triggerCount":1,"shared":[{"updatedAt":"2025-12-04T05:03:22.198Z","createdAt":"2025-12-04T05:03:22.198Z","role":"workflow:owner","workflowId":"5XywYcZdWVB5Uf1X","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-04T19:26:41.100Z","createdAt":"2025-12-04T19:20:03.965Z","id":"lyBFEH75jPsJ2rjg","name":"TEMP - Run Migration 002 Fix Slots","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"run-migration-002","responseMode":"lastNode","options":{}},"id":"webhook-001","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"run-migration-002"},{"parameters":{"operation":"executeQuery","query":"ALTER TABLE individual_slots_cache DROP CONSTRAINT IF EXISTS unique_practitioner_slot; DROP INDEX IF EXISTS idx_individual_slots_cache_unique_slot; DROP INDEX IF EXISTS unique_practitioner_slot; CREATE UNIQUE INDEX IF NOT EXISTS idx_slots_unique_practitioner_time_village ON individual_slots_cache(practitioner_id, starts_at, village); CREATE TABLE IF NOT EXISTS safety_holidays (date DATE PRIMARY KEY, description VARCHAR(200) NOT NULL, created_at TIMESTAMPTZ NOT NULL DEFAULT now()); CREATE TABLE IF NOT EXISTS safety_protected_slots (id SERIAL PRIMARY KEY, day_of_week VARCHAR(10) NOT NULL, start_time TIME NOT NULL, end_time TIME NOT NULL, reason VARCHAR(200) NOT NULL, practitioner_id VARCHAR(50), village VARCHAR(100), is_active BOOLEAN NOT NULL DEFAULT true, created_at TIMESTAMPTZ NOT NULL DEFAULT now()); SELECT 'SUCCESS' as status, indexname FROM pg_indexes WHERE tablename = 'individual_slots_cache' AND indexname LIKE '%unique%';","options":{}},"id":"postgres-001","name":"Run Migration","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[250,0],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"alwaysOutputData":true}],"connections":{"Webhook":{"main":[[{"node":"Run Migration","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"5d6dd37f-b72e-4604-bdff-125c63122760","triggerCount":1,"shared":[{"updatedAt":"2025-12-04T19:20:03.965Z","createdAt":"2025-12-04T19:20:03.965Z","role":"workflow:owner","workflowId":"lyBFEH75jPsJ2rjg","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-04T08:59:46.959Z","createdAt":"2025-12-03T18:35:26.383Z","id":"FWcRHilB3K6AThKI","name":"RetellAI - Book Appointment Compound v1.2 CACHED","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/book-appointment-compound","responseMode":"responseNode","options":{}},"id":"webhook-trigger-001","name":"Webhook Trigger","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,300],"webhookId":"book-appointment-compound"},{"parameters":{"jsCode":"// STANDARD EXTRACTION PATTERN - RetellAI Compatible\n// Book Appointment Compound v1.1 TIMEZONE FIX\n\nconst webhookData = $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\n// ============================================\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\n// ============================================\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n  if (phone.startsWith('+')) return phone;\n  if (phone.length === 8 && !phone.startsWith('+')) return '+612' + phone;\n  if (phone.length === 10 && phone.startsWith('0')) return '+61' + phone.substring(1);\n  if (phone.length === 11 && phone.startsWith('61')) return '+' + phone;\n  if (phone.length === 9) return '+61' + phone;\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n// ============================================\n// Extract all required parameters\n// ============================================\nconst patient_id = args.patient_id || '';\nconst practitioner_id = args.practitioner_id || '473326864069303022'; // Default practitioner\nconst appointment_type = args.appointment_type || 'Standard Consultation';\nconst starts_at = args.starts_at || args.start_time || args.datetime || '';\nconst duration_minutes = parseInt(args.duration_minutes) || 30;\nconst village = args.village || '';\nconst funding_type = (args.funding_type || '').toUpperCase();\nconst appointment_notes = args.appointment_notes || args.notes || '';\nconst unit_villa = args.unit_villa || '';\nconst is_new_client = args.is_new_client || false;\nconst client_name = args.client_name || '';\nconst recurrence_details = args.recurrence_details || null;\nconst call_id = call.call_id || args.call_id || '';\n\n// ============================================\n// Validation\n// ============================================\nconst errors = [];\n\nif (!patient_id) errors.push('patient_id is required');\nif (!starts_at) errors.push('starts_at is required');\nif (!village) errors.push('village is required');\nif (!funding_type) errors.push('funding_type is required');\n\nconst validFundingTypes = ['HCP', 'DVA', 'GP', 'PRIVATE', 'PHI'];\nif (funding_type && !validFundingTypes.includes(funding_type)) {\n  errors.push(`Invalid funding_type. Must be one of: ${validFundingTypes.join(', ')}`);\n}\n\nconst validAppointmentTypes = ['Standard Consultation', 'Standard Home Visit'];\nif (appointment_type && !validAppointmentTypes.includes(appointment_type)) {\n  errors.push(`Invalid appointment_type. Must be one of: ${validAppointmentTypes.join(', ')}`);\n}\n\n// Parse and validate datetime\nlet appointmentDate;\ntry {\n  appointmentDate = new Date(starts_at);\n  if (isNaN(appointmentDate.getTime())) {\n    errors.push('Invalid starts_at format. Use ISO 8601 format.');\n  }\n} catch (e) {\n  errors.push('Invalid starts_at format. Use ISO 8601 format.');\n}\n\n// Check appointment is in the future\nconst now = new Date();\nif (appointmentDate && appointmentDate <= now) {\n  errors.push('Appointment starts_at must be in the future');\n}\n\n// Check booking window (21 days)\nif (appointmentDate) {\n  const maxBookingDate = new Date(now);\n  maxBookingDate.setDate(now.getDate() + 21);\n  if (appointmentDate > maxBookingDate) {\n    const daysAhead = Math.ceil((appointmentDate - now) / (1000 * 60 * 60 * 24));\n    errors.push(`Appointment is ${daysAhead} days ahead. Bookings limited to 21 days.`);\n  }\n}\n\n// If validation errors, return early\nif (errors.length > 0) {\n  return [{\n    json: {\n      success: false,\n      appointment_created: false,\n      error: {\n        code: 'VALIDATION_ERROR',\n        message: errors.join('; '),\n        details: errors\n      },\n      call_id: call_id,\n      timestamp: new Date().toISOString(),\n      validation_failed: true\n    }\n  }];\n}\n\n// ============================================\n// Calculate derived fields\n// ============================================\n// Convert starts_at to UTC ISO format for Cliniko API\nconst starts_at_utc = appointmentDate.toISOString();\n\nconst endDate = new Date(appointmentDate);\nendDate.setMinutes(endDate.getMinutes() + duration_minutes);\nconst ends_at = endDate.toISOString();\n\n// Date parts for checks\nconst date_only = appointmentDate.toISOString().split('T')[0]; // YYYY-MM-DD\n\n// Day of week for recurring/protected checks\nconst daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\nconst day_of_week = daysOfWeek[appointmentDate.getDay()];\n\n// Time slot (HH:MM:SS)\nconst hours = String(appointmentDate.getHours()).padStart(2, '0');\nconst minutes = String(appointmentDate.getMinutes()).padStart(2, '0');\nconst time_slot = `${hours}:${minutes}:00`;\n\n// End time for overlap checks\nconst endHours = String(endDate.getHours()).padStart(2, '0');\nconst endMinutes = String(endDate.getMinutes()).padStart(2, '0');\nconst end_time = `${endHours}:${endMinutes}:00`;\n\n// Formatted display strings\nconst date_formatted = appointmentDate.toLocaleDateString('en-AU', { \n  timeZone: 'Australia/Sydney',\n  weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' \n});\nconst time_formatted = appointmentDate.toLocaleTimeString('en-AU', { \n  timeZone: 'Australia/Sydney',\n  hour: '2-digit', minute: '2-digit', hour12: true \n});\n\n// Cliniko notes\nconst clinikoNotes = [\n  `Village: ${village}`,\n  unit_villa ? `Unit/Villa: ${unit_villa}` : '',\n  `Funding: ${funding_type}`,\n  appointment_notes ? `Notes: ${appointment_notes}` : ''\n].filter(n => n).join('\\n');\n\n// Appointment type ID mapping\nconst APPOINTMENT_TYPE_MAP = {\n  'Standard Consultation': '472831283798480897',\n  'Standard Home Visit': '472831283798480897'\n};\nconst appointment_type_id = APPOINTMENT_TYPE_MAP[appointment_type] || '472831283798480897';\n\nreturn [{\n  json: {\n    // Core identifiers\n    patient_id,\n    practitioner_id,\n    business_id: '675491769126754955',\n    appointment_type_id,\n    appointment_type,\n    \n    // Timing (both formats - original for display, UTC for API)\n    starts_at: starts_at_utc,\n    starts_at_original: starts_at,\n    ends_at,\n    duration_minutes,\n    date_only,\n    day_of_week,\n    time_slot,\n    end_time,\n    date_formatted,\n    time_formatted,\n    \n    // Location/Funding\n    village,\n    unit_villa,\n    funding_type,\n    \n    // Notes\n    appointment_notes,\n    cliniko_notes: clinikoNotes,\n    \n    // Flags\n    is_new_client,\n    client_name,\n    recurrence_details,\n    \n    // Tracking\n    call_id,\n    start_time: Date.now(),\n    timestamp: new Date().toISOString(),\n    validation_failed: false\n  }\n}];"},"id":"code-extract-001","name":"Extract & Validate Request","type":"n8n-nodes-base.code","typeVersion":2,"position":[250,300]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"validation-failed-check","leftValue":"={{ $json.validation_failed }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"if-validation-001","name":"Validation Failed?","type":"n8n-nodes-base.if","typeVersion":2,"position":[500,300]},{"parameters":{"jsCode":"// Run All Pre-Checks - Simplified Sequential Approach\n// This replaces the parallel check pattern to avoid $items() issues in n8n v1.121+\n\nconst requestData = $json;\nlet blockers = [];\nlet warnings = [];\n\n// Pre-check results (will be populated below)\nlet is_holiday = false;\nlet holiday_name = null;\nlet has_recurring_conflict = false;\nlet recurring_conflict_details = null;\nlet is_protected_slot = false;\nlet protected_slot_reason = null;\n\n// NOTE: Database checks disabled for now - tables may not exist yet\n// Holiday and recurring conflict checks would normally query PostgreSQL\n// Protected slot checks would normally read from Google Sheets\n//\n// For now, we skip these checks and proceed directly to Cliniko slot check\n// This allows the booking to work while you set up the prerequisite tables\n\n// ============================================\n// Determine if booking can proceed\n// ============================================\nconst can_proceed = blockers.length === 0;\n\nreturn [{\n  json: {\n    ...requestData,\n    \n    // Check results (all skipped for now)\n    pre_checks: {\n      holiday: {\n        checked: false,\n        is_holiday,\n        holiday_name,\n        note: 'Holiday check skipped - table not configured'\n      },\n      recurring_conflict: {\n        checked: false,\n        has_conflict: has_recurring_conflict,\n        details: recurring_conflict_details,\n        note: 'Recurring check skipped - table not configured'\n      },\n      protected_slot: {\n        checked: false,\n        is_protected: is_protected_slot,\n        reason: protected_slot_reason,\n        note: 'Protected slot check skipped - sheet not configured'\n      }\n    },\n    \n    // Decision\n    can_proceed,\n    blockers,\n    warnings,\n    \n    // Timing\n    checks_completed_at: new Date().toISOString()\n  }\n}];"},"id":"code-prechecks-001","name":"Run All Pre-Checks","type":"n8n-nodes-base.code","typeVersion":2,"position":[750,300]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"can-proceed-check","leftValue":"={{ $json.can_proceed }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"if-can-proceed-001","name":"Can Proceed?","type":"n8n-nodes-base.if","typeVersion":2,"position":[950,300]},{"parameters":{"url":"=https://api.au2.cliniko.com/v1/individual_appointments?q[]=practitioner_id:={{ $json.practitioner_id }}&q[]=starts_at:>={{ $json.starts_at }}&q[]=starts_at:<={{ $json.ends_at }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"},{"name":"Accept","value":"application/json"}]},"options":{}},"id":"http-check-slot-001","name":"Check Cliniko Slot Availability","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1550,200],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"// Check if Cliniko slot is available\nconst clinikoResponse = $input.item.json;\n// Get request data from the Pre-Checks node using n8n's $() syntax\nconst requestData = $('Run All Pre-Checks').first().json;\n\n// Handle API error\nif (clinikoResponse.error) {\n  return [{\n    json: {\n      ...requestData,\n      cliniko_slot_available: false,\n      cliniko_error: clinikoResponse.error,\n      can_proceed: false,\n      blockers: [\n        ...requestData.blockers,\n        {\n          type: 'CLINIKO_API_ERROR',\n          message: 'Could not verify slot availability in Cliniko',\n          details: { error: clinikoResponse.error }\n        }\n      ]\n    }\n  }];\n}\n\n// Check if slot is taken\nconst appointments = clinikoResponse.individual_appointments || [];\nif (appointments.length > 0) {\n  return [{\n    json: {\n      ...requestData,\n      cliniko_slot_available: false,\n      can_proceed: false,\n      blockers: [\n        ...requestData.blockers,\n        {\n          type: 'SLOT_UNAVAILABLE',\n          message: 'This time slot is no longer available in Cliniko.',\n          details: { existing_appointments: appointments.length }\n        }\n      ]\n    }\n  }];\n}\n\n// Slot is available\nreturn [{\n  json: {\n    ...requestData,\n    cliniko_slot_available: true\n  }\n}];"},"id":"code-check-slot-001","name":"Handle Slot Check Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[1800,200]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"slot-available-check","leftValue":"={{ $json.cliniko_slot_available }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"if-slot-available-001","name":"Slot Available?","type":"n8n-nodes-base.if","typeVersion":2,"position":[2050,200]},{"parameters":{"method":"POST","url":"https://api.au2.cliniko.com/v1/individual_appointments","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"},{"name":"Accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ { patient_id: $json.patient_id, practitioner_id: $json.practitioner_id, business_id: $json.business_id, appointment_type_id: $json.appointment_type_id, starts_at: $json.starts_at, ends_at: $json.ends_at, notes: $json.cliniko_notes, send_sms: true, confirmed: true } }}","options":{}},"id":"http-create-appt-001","name":"Create Appointment in Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2300,100],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"// Process Cliniko appointment creation response\nconst clinikoResponse = $input.item.json;\nconst requestData = $('Handle Slot Check Result').first().json;\n\n// Handle API error\nif (clinikoResponse.error || !clinikoResponse.id) {\n  const errorMsg = clinikoResponse.error || 'No appointment ID returned';\n  return [{\n    json: {\n      ...requestData,\n      appointment_created: false,\n      cliniko_error: errorMsg,\n      error: {\n        code: 'CLINIKO_CREATE_ERROR',\n        message: `Failed to create appointment: ${errorMsg}`\n      }\n    }\n  }];\n}\n\n// Success - extract appointment details\nconst patient_name = clinikoResponse.patient?.first_name && clinikoResponse.patient?.last_name\n  ? `${clinikoResponse.patient.first_name} ${clinikoResponse.patient.last_name}`\n  : requestData.client_name || 'Patient';\n\nreturn [{\n  json: {\n    ...requestData,\n    appointment_created: true,\n    appointment_id: clinikoResponse.id,\n    patient_name: patient_name,\n    practitioner_name: 'Liam Potter',\n    cliniko_link: `https://reignitehealth.au2.cliniko.com/appointments/${clinikoResponse.id}`,\n    sms_sent: true,\n    cliniko_response: clinikoResponse\n  }\n}];"},"id":"code-process-cliniko-001","name":"Process Cliniko Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[2550,100]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"appointment-created-check","leftValue":"={{ $json.appointment_created }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"if-created-001","name":"Appointment Created?","type":"n8n-nodes-base.if","typeVersion":2,"position":[2800,100]},{"parameters":{"method":"POST","url":"https://api.au2.cliniko.com/v1/treatment_notes","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"},{"name":"Accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ { individual_appointment_id: $json.appointment_id, content: 'Booked via Voice AI (Compound Webhook).\\nCall ID: ' + $json.call_id + '\\nFunding: ' + $json.funding_type + '\\nAppointment Type: ' + $json.appointment_type + ($json.unit_villa ? '\\nUnit/Villa: ' + $json.unit_villa : '') + ($json.appointment_notes ? '\\nNotes: ' + $json.appointment_notes : '') } }}","options":{}},"id":"http-treatment-notes-001","name":"Add Treatment Notes","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3050,0],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"sendTo":"peter@yesai.au","subject":"=ü§ñ Voice AI Booking (Compound) - {{ $('Process Cliniko Response').first().json.patient_name }}","message":"=<html><body style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\"><div style=\"background-color: #f0f8ff; padding: 20px; border-radius: 10px;\"><h2 style=\"color: #2c3e50;\">ü§ñ Voice AI Booking (Compound Webhook)</h2><div style=\"background-color: white; padding: 15px; border-radius: 5px; margin: 10px 0;\"><table style=\"width: 100%; border-collapse: collapse;\"><tr style=\"border-bottom: 1px solid #eee;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Patient:</td><td style=\"padding: 10px;\">{{ $('Process Cliniko Response').first().json.patient_name }}</td></tr><tr style=\"border-bottom: 1px solid #eee; background: #f9f9f9;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Appointment ID:</td><td style=\"padding: 10px;\">{{ $('Process Cliniko Response').first().json.appointment_id }}</td></tr><tr style=\"border-bottom: 1px solid #eee;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Date:</td><td style=\"padding: 10px;\">{{ $('Process Cliniko Response').first().json.date_formatted }}</td></tr><tr style=\"border-bottom: 1px solid #eee; background: #f9f9f9;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Time:</td><td style=\"padding: 10px;\">{{ $('Process Cliniko Response').first().json.time_formatted }}</td></tr><tr style=\"border-bottom: 1px solid #eee;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Duration:</td><td style=\"padding: 10px;\">{{ $('Process Cliniko Response').first().json.duration_minutes }} minutes</td></tr><tr style=\"border-bottom: 1px solid #eee; background: #f9f9f9;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Type:</td><td style=\"padding: 10px;\">{{ $('Process Cliniko Response').first().json.appointment_type }}</td></tr><tr style=\"border-bottom: 1px solid #eee;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Village:</td><td style=\"padding: 10px;\">{{ $('Process Cliniko Response').first().json.village }}</td></tr><tr style=\"background: #f9f9f9;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Funding:</td><td style=\"padding: 10px;\">{{ $('Process Cliniko Response').first().json.funding_type }}</td></tr></table></div><div style=\"text-align: center; margin: 25px 0;\"><a href=\"{{ $('Process Cliniko Response').first().json.cliniko_link }}\" style=\"display: inline-block; background-color: #3498db; color: white; padding: 14px 35px; text-decoration: none; border-radius: 5px; font-weight: bold; font-size: 16px;\">View in Cliniko</a></div><div style=\"background-color: #e8f5e9; padding: 12px; border-radius: 5px; margin: 15px 0;\"><p style=\"margin: 0; font-size: 13px; color: #2e7d32;\">‚úÖ Appointment created | ‚úÖ SMS sent to patient | ‚úÖ Treatment notes added | ‚úÖ All pre-checks passed</p></div><div style=\"font-size: 12px; color: #7f8c8d; padding-top: 15px; border-top: 1px solid #ddd;\"><p style=\"margin: 5px 0;\"><strong>Call ID:</strong> {{ $('Process Cliniko Response').first().json.call_id }}</p><p style=\"margin: 5px 0;\"><strong>Created via:</strong> Compound Webhook (single call)</p><p style=\"margin: 5px 0;\"><em>Voice AI booking system | Auto-flagged for review</em></p></div></div></body></html>","options":{}},"id":"gmail-notify-001","name":"Send Email Notification","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[3300,0],"credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}},"continueOnFail":true},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1-OXnCJtYRa1h3C7HENhbxlDixLJWJYtsi-VebGiD3Tc","mode":"id"},"sheetName":{"__rl":true,"value":2141551618,"mode":"list","cachedResultName":"13_sara_approval_queue","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1-OXnCJtYRa1h3C7HENhbxlDixLJWJYtsi-VebGiD3Tc/edit#gid=2141551618"},"columns":{"mappingMode":"defineBelow","value":{"timestamp":"={{ $('Process Cliniko Response').first().json.timestamp }}","client_name":"={{ $('Process Cliniko Response').first().json.patient_name }}","cliniko_id":"={{ $('Process Cliniko Response').first().json.patient_id }}","village":"={{ $('Process Cliniko Response').first().json.village }}","is_new_client":"={{ $('Process Cliniko Response').first().json.is_new_client }}","service_type":"={{ $('Process Cliniko Response').first().json.appointment_type }}","booking_date_time":"={{ $('Process Cliniko Response').first().json.date_formatted }} {{ $('Process Cliniko Response').first().json.time_formatted }}","practitioner":"={{ $('Process Cliniko Response').first().json.practitioner_name }}","payment_method":"={{ $('Process Cliniko Response').first().json.funding_type }}","special_notes":"={{ $('Process Cliniko Response').first().json.appointment_notes }}","booking_id":"={{ $('Process Cliniko Response').first().json.appointment_id }}","call_id":"={{ $('Process Cliniko Response').first().json.call_id }}","status":"pending_review","booked_via":"voice_ai_compound"}},"options":{}},"id":"sheets-approval-001","name":"Add to Sara Approval Queue","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[3550,0],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}},"continueOnFail":true},{"parameters":{"operation":"executeQuery","query":"=DELETE FROM patient_funding_cache WHERE patient_id = '{{ $('Process Cliniko Response').first().json.patient_id }}' RETURNING *;","options":{"queryBatching":"independently"}},"id":"postgres-invalidate-001","name":"Invalidate Funding Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[3800,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"jsCode":"// Format final success response\nconst data = $('Process Cliniko Response').first().json;\n\nconst duration_ms = Date.now() - data.start_time;\n\nreturn [{\n  json: {\n    success: true,\n    appointment_created: true,\n    appointment_id: data.appointment_id,\n    \n    confirmation_details: {\n      patient_name: data.patient_name,\n      practitioner_name: data.practitioner_name,\n      datetime: data.starts_at,\n      date: data.date_formatted,\n      time: data.time_formatted,\n      duration_minutes: data.duration_minutes,\n      village: data.village,\n      funding_type: data.funding_type,\n      appointment_type: data.appointment_type\n    },\n    \n    pre_checks: data.pre_checks,\n    \n    actions_completed: {\n      holiday_checked: true,\n      recurring_conflict_checked: true,\n      protected_slot_checked: true,\n      cliniko_slot_verified: true,\n      appointment_created: true,\n      treatment_notes_added: true,\n      sms_sent: data.sms_sent,\n      email_notification_sent: true,\n      added_to_approval_queue: true,\n      funding_cache_invalidated: true\n    },\n    \n    flagged_for_review: true,\n    cliniko_link: data.cliniko_link,\n    \n    call_id: data.call_id,\n    duration_ms: duration_ms,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"code-success-response-001","name":"Format Success Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[4050,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-success-001","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[4300,0]},{"parameters":{"jsCode":"// Format blocked response (pre-checks failed)\nconst data = $json;\n\nconst duration_ms = Date.now() - data.start_time;\n\n// Get the primary blocker\nconst primaryBlocker = data.blockers[0] || { type: 'UNKNOWN', message: 'Booking blocked' };\n\nreturn [{\n  json: {\n    success: false,\n    appointment_created: false,\n    \n    error: {\n      code: primaryBlocker.type,\n      message: primaryBlocker.message,\n      all_blockers: data.blockers\n    },\n    \n    pre_checks: data.pre_checks,\n    \n    requested_details: {\n      datetime: data.starts_at,\n      date: data.date_formatted,\n      time: data.time_formatted,\n      duration_minutes: data.duration_minutes,\n      village: data.village,\n      practitioner_id: data.practitioner_id\n    },\n    \n    call_id: data.call_id,\n    duration_ms: duration_ms,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"code-blocked-response-001","name":"Format Blocked Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1300,500]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-blocked-001","name":"Respond Blocked","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1550,500]},{"parameters":{"jsCode":"// Format validation error response\nconst data = $json;\n\nreturn [{\n  json: {\n    success: false,\n    appointment_created: false,\n    error: data.error,\n    call_id: data.call_id,\n    timestamp: data.timestamp\n  }\n}];"},"id":"code-validation-error-001","name":"Format Validation Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[750,600]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-validation-001","name":"Respond Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1000,600]},{"parameters":{"jsCode":"// Format slot unavailable response\nconst data = $json;\n\nconst duration_ms = Date.now() - data.start_time;\n\nreturn [{\n  json: {\n    success: false,\n    appointment_created: false,\n    \n    error: {\n      code: 'SLOT_UNAVAILABLE',\n      message: 'This time slot is no longer available.',\n      blockers: data.blockers\n    },\n    \n    pre_checks: data.pre_checks,\n    \n    requested_details: {\n      datetime: data.starts_at,\n      date: data.date_formatted,\n      time: data.time_formatted,\n      village: data.village\n    },\n    \n    call_id: data.call_id,\n    duration_ms: duration_ms,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"code-slot-error-001","name":"Format Slot Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[2300,300]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-slot-error-001","name":"Respond Slot Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2550,300]},{"parameters":{"jsCode":"// Format Cliniko creation error response\nconst data = $json;\n\nconst duration_ms = Date.now() - data.start_time;\n\nreturn [{\n  json: {\n    success: false,\n    appointment_created: false,\n    \n    error: data.error || {\n      code: 'CLINIKO_CREATE_ERROR',\n      message: 'Failed to create appointment in Cliniko'\n    },\n    \n    pre_checks: data.pre_checks,\n    \n    requested_details: {\n      datetime: data.starts_at,\n      date: data.date_formatted,\n      time: data.time_formatted,\n      village: data.village\n    },\n    \n    call_id: data.call_id,\n    duration_ms: duration_ms,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"code-create-error-001","name":"Format Create Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[3050,200]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-create-error-001","name":"Respond Create Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[3300,200]},{"parameters":{"operation":"executeQuery","query":"-- Log compound webhook execution\nINSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_body,\n  response_body,\n  success,\n  duration_ms,\n  cache_hit,\n  created_at\n)\nVALUES (\n  'book-appointment-compound',\n  '{{ $json.call_id }}',\n  '{{ JSON.stringify($json) }}'::jsonb,\n  '{{ JSON.stringify($json) }}'::jsonb,\n  {{ $json.success }},\n  {{ $json.duration_ms || 0 }},\n  false,\n  now()\n)\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"postgres-log-001","name":"Log Webhook Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[4550,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"operation":"executeQuery","query":"-- Log appointment to database\nINSERT INTO appointment_log (\n  appointment_id,\n  patient_id,\n  practitioner_id,\n  datetime,\n  duration_minutes,\n  appointment_type,\n  funding_type,\n  village,\n  created_via,\n  call_id,\n  flagged_for_review,\n  created_at\n)\nVALUES (\n  '{{ $json.appointment_id }}',\n  '{{ $json.patient_id }}',\n  '{{ $json.practitioner_id }}',\n  '{{ $json.starts_at }}'::timestamptz,\n  {{ $json.duration_minutes }},\n  '{{ $json.appointment_type }}',\n  '{{ $json.funding_type }}',\n  '{{ $json.village }}',\n  'voice_ai_compound',\n  '{{ $json.call_id }}',\n  true,\n  now()\n)\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"postgres-appt-log-001","name":"Log Appointment to Database","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[4300,150],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"operation":"executeQuery","query":"-- Check if slot is cached as unavailable\nSELECT id, practitioner_id, starts_at, is_available, cached_at\nFROM individual_appointments_cache\nWHERE practitioner_id = '{{ $json.practitioner_id }}'\n  AND starts_at = '{{ $json.starts_at }}'::timestamptz\n  AND cached_at > NOW() - INTERVAL '30 minutes'\nLIMIT 1;","options":{}},"id":"postgres-check-cache-001","name":"Check Slot Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1000,300],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Check if we have cached slot availability\nconst cacheResult = $input.all();\nconst requestData = $('Run All Pre-Checks').first().json;\n\n// Check if we got a cache hit\nconst hasCacheHit = cacheResult.length > 0 &&\n                    cacheResult[0].json &&\n                    cacheResult[0].json.id;\n\nif (hasCacheHit) {\n  const cached = cacheResult[0].json;\n\n  // If cached as unavailable, block immediately\n  if (cached.is_available === false) {\n    return [{\n      json: {\n        ...requestData,\n        cache_hit: true,\n        cached_unavailable: true,\n        cliniko_slot_available: false,\n        can_proceed: false,\n        blockers: [\n          ...requestData.blockers,\n          {\n            type: 'SLOT_CACHED_UNAVAILABLE',\n            message: 'This time slot was recently checked and is not available.',\n            details: { cached_at: cached.cached_at }\n          }\n        ]\n      }\n    }];\n  }\n\n  // Cached as available - still need to verify with Cliniko (slot could have been booked)\n  return [{\n    json: {\n      ...requestData,\n      cache_hit: true,\n      cached_available: true,\n      need_cliniko_check: true\n    }\n  }];\n}\n\n// No cache hit - need to check Cliniko\nreturn [{\n  json: {\n    ...requestData,\n    cache_hit: false,\n    need_cliniko_check: true\n  }\n}];"},"id":"code-handle-cache-001","name":"Handle Slot Cache Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[1150,300]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"cache-unavailable-check","leftValue":"={{ $json.cached_unavailable }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"if-cache-unavailable-001","name":"Cache Hit Unavailable?","type":"n8n-nodes-base.if","typeVersion":2,"position":[1300,300]},{"parameters":{"operation":"executeQuery","query":"-- Cache the slot availability result\nINSERT INTO individual_appointments_cache (\n  practitioner_id,\n  appointment_date,\n  starts_at,\n  ends_at,\n  is_available,\n  cached_at\n)\nVALUES (\n  '{{ $json.practitioner_id }}',\n  '{{ $json.date_only }}'::date,\n  '{{ $json.starts_at }}'::timestamptz,\n  '{{ $json.ends_at }}'::timestamptz,\n  {{ $json.cliniko_slot_available }},\n  NOW()\n)\nON CONFLICT (practitioner_id, starts_at)\nDO UPDATE SET\n  is_available = EXCLUDED.is_available,\n  cached_at = NOW()\nRETURNING *;","options":{}},"id":"postgres-cache-slot-001","name":"Cache Slot Result","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[2000,200],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"operation":"executeQuery","query":"-- Mark slot as booked (unavailable) in cache\nINSERT INTO individual_appointments_cache (\n  practitioner_id,\n  appointment_date,\n  starts_at,\n  ends_at,\n  is_available,\n  patient_id,\n  booked_duration_minutes,\n  cached_at\n)\nVALUES (\n  '{{ $json.practitioner_id }}',\n  '{{ $json.date_only }}'::date,\n  '{{ $json.starts_at }}'::timestamptz,\n  '{{ $json.ends_at }}'::timestamptz,\n  false,\n  '{{ $json.patient_id }}',\n  {{ $json.duration_minutes }},\n  NOW()\n)\nON CONFLICT (practitioner_id, starts_at)\nDO UPDATE SET\n  is_available = false,\n  patient_id = EXCLUDED.patient_id,\n  booked_duration_minutes = EXCLUDED.booked_duration_minutes,\n  cached_at = NOW()\nRETURNING *;","options":{}},"id":"postgres-mark-booked-001","name":"Mark Slot Booked","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[2800,50],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true}],"connections":{"Webhook Trigger":{"main":[[{"node":"Extract & Validate Request","type":"main","index":0}]]},"Extract & Validate Request":{"main":[[{"node":"Validation Failed?","type":"main","index":0}]]},"Validation Failed?":{"main":[[{"node":"Format Validation Error","type":"main","index":0}],[{"node":"Run All Pre-Checks","type":"main","index":0}]]},"Format Validation Error":{"main":[[{"node":"Respond Validation Error","type":"main","index":0}]]},"Run All Pre-Checks":{"main":[[{"node":"Can Proceed?","type":"main","index":0}]]},"Can Proceed?":{"main":[[{"node":"Check Slot Cache","type":"main","index":0}],[{"node":"Format Blocked Response","type":"main","index":0}]]},"Format Blocked Response":{"main":[[{"node":"Respond Blocked","type":"main","index":0}]]},"Check Cliniko Slot Availability":{"main":[[{"node":"Handle Slot Check Result","type":"main","index":0}]]},"Handle Slot Check Result":{"main":[[{"node":"Cache Slot Result","type":"main","index":0}]]},"Slot Available?":{"main":[[{"node":"Create Appointment in Cliniko","type":"main","index":0}],[{"node":"Format Slot Error","type":"main","index":0}]]},"Format Slot Error":{"main":[[{"node":"Respond Slot Error","type":"main","index":0}]]},"Create Appointment in Cliniko":{"main":[[{"node":"Process Cliniko Response","type":"main","index":0}]]},"Process Cliniko Response":{"main":[[{"node":"Mark Slot Booked","type":"main","index":0}]]},"Appointment Created?":{"main":[[{"node":"Add Treatment Notes","type":"main","index":0}],[{"node":"Format Create Error","type":"main","index":0}]]},"Format Create Error":{"main":[[{"node":"Respond Create Error","type":"main","index":0}]]},"Add Treatment Notes":{"main":[[{"node":"Send Email Notification","type":"main","index":0}]]},"Send Email Notification":{"main":[[{"node":"Add to Sara Approval Queue","type":"main","index":0}]]},"Add to Sara Approval Queue":{"main":[[{"node":"Invalidate Funding Cache","type":"main","index":0}]]},"Invalidate Funding Cache":{"main":[[{"node":"Format Success Response","type":"main","index":0}]]},"Format Success Response":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Respond Success":{"main":[[{"node":"Log Appointment to Database","type":"main","index":0},{"node":"Log Webhook Execution","type":"main","index":0}]]},"Check Slot Cache":{"main":[[{"node":"Handle Slot Cache Result","type":"main","index":0}]]},"Handle Slot Cache Result":{"main":[[{"node":"Cache Hit Unavailable?","type":"main","index":0}]]},"Cache Hit Unavailable?":{"main":[[{"node":"Format Slot Error","type":"main","index":0}],[{"node":"Check Cliniko Slot Availability","type":"main","index":0}]]},"Cache Slot Result":{"main":[[{"node":"Slot Available?","type":"main","index":0}]]},"Mark Slot Booked":{"main":[[{"node":"Appointment Created?","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"44e2af9b-81b7-4cec-ab88-6800924e3119","triggerCount":1,"shared":[{"updatedAt":"2025-12-03T18:35:26.383Z","createdAt":"2025-12-03T18:35:26.383Z","role":"workflow:owner","workflowId":"FWcRHilB3K6AThKI","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-05T06:14:38.856Z","createdAt":"2025-12-04T08:49:03.489Z","id":"7XU1WbusFx2pK8td","name":"RetellAI - Get Practitioner Availability v2.1 DATE_FIX","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-availability","responseMode":"responseNode","options":{}},"id":"webhook-001","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,300],"webhookId":"get-availability"},{"parameters":{"jsCode":"// Extract Request Data - v2.1 DATE_FIX\n// Added date extraction to stop agent looping on wrong dates\n\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\n// Map village IDs to names (reverse lookup)\nconst villageIdToNameMap = {\n  'brentwood': 'Brentwood',\n  'dee_why_gardens': 'Dee Why Gardens',\n  'dee-why-gardens': 'Dee Why Gardens',\n  'glenaeon': 'Glenaeon',\n  'gordon_quarter': 'Gordon Quarter',\n  'gordon-quarter': 'Gordon Quarter',\n  'henry_kendall_gardens': 'Henry Kendall Gardens',\n  'henry-kendall-gardens': 'Henry Kendall Gardens',\n  'lutanda_manor': 'Lutanda Manor',\n  'lutanda-manor': 'Lutanda Manor',\n  'maybrook': 'Maybrook',\n  'the_baytree': 'The Baytree',\n  'the-baytree': 'The Baytree',\n  'baytree': 'The Baytree',\n  'warriewood_brook': 'Warriewood Brook',\n  'warriewood-brook': 'Warriewood Brook'\n};\n\nconst validVillages = [\n  'Brentwood', 'Dee Why Gardens', 'Glenaeon', 'Gordon Quarter',\n  'Henry Kendall Gardens', 'Lutanda Manor', 'Maybrook', 'The Baytree', 'Warriewood Brook'\n];\n\n// Extract parameters\nlet village_name = args.village_name || args.village || '';\n\n// If village_name is empty, try to resolve from village_id\nif (!village_name && args.village_id) {\n  const lookupKey = args.village_id.toLowerCase().trim();\n  village_name = villageIdToNameMap[lookupKey] || args.village_id;\n}\n\n// Service category: physio (default) or ep\nconst service_category = (args.service_category || args.specialty || 'physio').toLowerCase();\n\n// Optional practitioner_id for filtering specific practitioner\nconst practitioner_id = args.practitioner_id || null;\n\n// NEW: Extract Date with basic validation\nconst rawDate = args.date || null;\nlet date_query = '';\nif (rawDate && new Date(rawDate).toString() !== 'Invalid Date') {\n    date_query = rawDate;\n}\n\nconst call_id = call.call_id || args.call_id || '';\nconst startTime = Date.now();\n\n// Validation\nif (!village_name) {\n  return [{\n    json: {\n      success: false,\n      error: true,\n      error_code: 'MISSING_VILLAGE',\n      message: 'Village is required.',\n      spoken_text: 'I need to know which village you are looking for availability at. Could you please tell me the village name?',\n      available_villages: validVillages,\n      call_id: call_id,\n      duration_ms: Date.now() - startTime,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\nif (!validVillages.includes(village_name)) {\n  return [{\n    json: {\n      success: false,\n      error: true,\n      error_code: 'INVALID_VILLAGE',\n      message: `Invalid village: ${village_name}`,\n      spoken_text: `I couldn't find a village called ${village_name}. Our villages are: ${validVillages.join(', ')}.`,\n      available_villages: validVillages,\n      call_id: call_id,\n      duration_ms: Date.now() - startTime,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    village_name,\n    service_category,\n    practitioner_id,\n    date_query, // <-- Passes to SQL\n    call_id,\n    start_time: startTime,\n    timestamp: new Date().toISOString(),\n    error: false\n  }\n}];"},"id":"code-extract-001","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[250,300]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"error-check","leftValue":"={{ $json.error }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"if-error-001","name":"Has Error?","type":"n8n-nodes-base.if","typeVersion":2,"position":[500,300]},{"parameters":{"operation":"executeQuery","query":"-- DATABASE_FIRST: Query cached slots\n-- v2.1 Fixed to respect requested date using >= logic (First Available)\nSELECT \n  practitioner_name,\n  practitioner_id,\n  starts_at,\n  ends_at,\n  service_category\nFROM individual_slots_cache\nWHERE village = $1\n  AND service_category = $2\n  AND is_available = true\n  AND starts_at > NOW()\n  -- FIX: Use >= to find next available from this date\n  -- If date is NULL/Empty, it ignores this line and just finds next available from NOW()\n  AND ($4::text IS NULL OR $4::text = '' OR starts_at::date >= NULLIF($4, '')::date)\n  -- Handle optional practitioner_id\n  AND ($3::text IS NULL OR $3::text = '' OR practitioner_id = $3::text)\nORDER BY starts_at ASC\nLIMIT 5;","options":{"queryBatching":"independently","queryReplacement":"={{ [$json.village_name, $json.service_category, $json.practitioner_id || '', $json.date_query || ''] }}"}},"id":"postgres-query-slots-001","name":"Query Cached Slots","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[750,200],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"jsCode":"// v2.1 DATABASE_FIRST - Format slots response with natural spoken_text\nconst requestData = $items('Extract Request Data')[0].json;\nconst slots = $input.all().map(item => item.json).filter(s => s.starts_at);\nconst startTime = requestData.start_time;\nconst call_id = requestData.call_id;\nconst village = requestData.village_name;\nconst service_category = requestData.service_category;\nconst requested_date = requestData.date_query;\n\n// No slots available\nif (slots.length === 0) {\n  let noSlotMessage = `I'm sorry, I couldn't find any available ${service_category === 'ep' ? 'Exercise Physiology' : 'physiotherapy'} appointments at ${village}`;\n  if (requested_date) {\n    noSlotMessage += ` on or after ${requested_date}`;\n  } else {\n    noSlotMessage += ' in the coming days';\n  }\n  noSlotMessage += '. Would you like me to check a different village, or shall I organise a callback from Sara to help find an appointment?';\n  \n  return [{\n    json: {\n      success: true,\n      availability_checked: true,\n      slots: [],\n      spoken_text: noSlotMessage,\n      message: 'No slots available',\n      village,\n      service_category,\n      requested_date: requested_date || null,\n      call_id,\n      duration_ms: Date.now() - startTime\n    }\n  }];\n}\n\n// Format slots for response\nconst formattedSlots = slots.map(slot => {\n  const dt = new Date(slot.starts_at);\n  // Format for Sydney timezone\n  const options = { weekday: 'long', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'Australia/Sydney' };\n  const formatted = dt.toLocaleString('en-AU', options);\n  \n  return {\n    starts_at: slot.starts_at,\n    ends_at: slot.ends_at,\n    practitioner_id: slot.practitioner_id,\n    practitioner_name: slot.practitioner_name,\n    village: slot.village || village,\n    formatted_time: formatted\n  };\n});\n\n// Build natural spoken_text\nlet spoken_text;\nconst uniquePractitioners = [...new Set(formattedSlots.map(s => s.practitioner_name))];\n\nif (formattedSlots.length === 1) {\n  const slot = formattedSlots[0];\n  spoken_text = `I have an opening with ${slot.practitioner_name} on ${slot.formatted_time}. Would you like me to book that for you?`;\n} else if (uniquePractitioners.length === 1) {\n  // Same practitioner, multiple times\n  const name = uniquePractitioners[0];\n  const times = formattedSlots.slice(0, 3).map(s => {\n    const dt = new Date(s.starts_at);\n    return dt.toLocaleString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'Australia/Sydney' });\n  }).join(', ');\n  spoken_text = `I have openings with ${name} at ${times}. Which time works best for you?`;\n} else {\n  // Multiple practitioners\n  const firstFew = formattedSlots.slice(0, 3).map(s => {\n    const dt = new Date(s.starts_at);\n    const time = dt.toLocaleString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'Australia/Sydney' });\n    return `${s.practitioner_name} on ${time}`;\n  }).join('; ');\n  spoken_text = `I found ${formattedSlots.length} available slots. The next openings are: ${firstFew}. Which would you prefer?`;\n}\n\nreturn [{\n  json: {\n    success: true,\n    availability_checked: true,\n    slots: formattedSlots,\n    slots_summary: `${formattedSlots.length} slots found`,\n    spoken_text,\n    message: spoken_text,\n    village,\n    service_category,\n    requested_date: requested_date || null,\n    call_id,\n    duration_ms: Date.now() - startTime\n  }\n}];"},"id":"code-format-001","name":"Format Slots Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1000,200]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-001","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1250,200]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-error-001","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[750,450]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_log (webhook_name, call_id, request_body, response_body, success, duration_ms, created_at)\nVALUES ('get-availability-v2.1', $1, $2::jsonb, $3::jsonb, true, $4, now())\nRETURNING *;","options":{"queryBatching":"independently","queryReplacement":"={{ [$items('Extract Request Data')[0].json.call_id || '', JSON.stringify($items('Extract Request Data')[0].json), JSON.stringify($json), $json.duration_ms || 0] }}"}},"id":"postgres-log-001","name":"Log Webhook","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1500,300],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Has Error?","type":"main","index":0}]]},"Has Error?":{"main":[[{"node":"Respond Error","type":"main","index":0}],[{"node":"Query Cached Slots","type":"main","index":0}]]},"Query Cached Slots":{"main":[[{"node":"Format Slots Response","type":"main","index":0}]]},"Format Slots Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}],[{"node":"Log Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"00e2a40e-840e-41ed-a0f8-5053a7039bdc","triggerCount":1,"shared":[{"updatedAt":"2025-12-04T08:49:03.489Z","createdAt":"2025-12-04T08:49:03.489Z","role":"workflow:owner","workflowId":"7XU1WbusFx2pK8td","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-24T05:10:33.226Z","createdAt":"2025-07-22T23:55:54.309Z","id":"LjMVztuUxPtC4FLF","name":"Retell to emails and Gsheet v10","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"retellai-call","options":{}},"id":"e7dc0eb6-1937-49f8-9247-05eb84789c67","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[860,80],"webhookId":"88a0c272-2820-48ea-9338-6795d1d806af"},{"parameters":{"sendTo":"peter@ball.com.au","subject":"={{ `Yes Right Call Summary - ${$json.human_duration}` }}","message":"={{ `\n<style>\n  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; }\n  .container { border: 1px solid #e0e0e0; padding: 25px; border-radius: 8px; max-width: 700px; margin: 20px auto; background-color: #f9f9f9; }\n  h2 { color: #0056b3; border-bottom: 2px solid #e0e0e0; padding-bottom: 8px; margin-top: 25px; }\n  strong { color: #333; }\n  .transcript-box { background-color: #ffffff; padding: 15px; border: 1px solid #ddd; border-radius: 5px; margin-top: 10px; white-space: pre-wrap; }\n  .footer { margin-top: 30px; font-size: 0.9em; color: #777; text-align: center; }\n  a { color: #0056b3; text-decoration: none; }\n  a:hover { text-decoration: underline; }\n</style>\n<div class=\"container\">\n  <h2>Transcript</h2>\n  <div class=\"transcript-box\">${$json.html_transcript}</div>\n\n  <h2>Call Summary</h2>\n  <p><strong>From:</strong> ${$json.from_number}</p>\n  <p><strong>To:</strong> ${$json.to_number} ${$json.caller_name}</p>\n\n  <h2>Call Timings & Status</h2>\n  <p><strong>Start Time:</strong> ${$json.start_time}</p>\n  <p><strong>End Time:</strong> ${$json.end_time}</p>\n  <p><strong>Duration:</strong> ${$json.human_duration}</p>\n  <p><strong>Status:</strong> ${$json.status}</p>\n  <p><strong>Disconnection Reason:</strong> ${$json.disconnection_reason}</p>\n  <p><strong>Total Cost:</strong> ${$json.total_cost_cents}¬¢</p>\n\n  <h2>Call Data & Links</h2>\n  <p><strong>Recording URL:</strong> <a href=\"${$json.recording_url}\">${$json.recording_url}</a></p>\n  <p><strong>Public Log URL:</strong> <a href=\"${$json.public_log_url}\">${$json.public_log_url}</a></p>\n\n  <div class=\"footer\">\n    <p>Powered by Yes AI Consultants Australia <a href=\"https://www.YesAI.au\">www.YesAI.au</a></p>\n    <p style=\"font-size:0.8em; color:#999;\">Workflow: ${$json.workflow_name}</p>\n  </div>\n</div>\n` }}","options":{}},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[2060,240],"id":"0e7e5c7a-3c44-4b7e-be57-0449aa6d155a","name":"Gmail","webhookId":"94a90452-40d0-4f43-a94f-cf1814416816","credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}},{"parameters":{"values":{"string":[{"name":"call_id","value":"={{ $('Webhook').item.json.body?.call?.call_id || 'N/A' }}"},{"name":"agent_id","value":"={{ $('Webhook').item.json.body?.call?.agent_id || 'N/A' }}"},{"name":"agent_version","value":"={{ $('Webhook').item.json.body?.call?.agent_version || 'N/A' }}"},{"name":"status","value":"={{ $('Webhook').item.json.body?.call?.call_status || 'unknown' }}"},{"name":"start_time","value":"={{ $('Webhook').item.json.body?.call?.start_timestamp ? new Date($('Webhook').item.json.body.call.start_timestamp).toLocaleString('en-AU', { timeZone: 'Australia/Sydney' }) : 'N/A' }}"},{"name":"end_time","value":"={{ $('Webhook').item.json.body?.call?.end_timestamp ? new Date($('Webhook').item.json.body.call.end_timestamp).toLocaleString('en-AU', { timeZone: 'Australia/Sydney' }) : 'N/A' }}"},{"name":"duration_ms","value":"={{ $('Webhook').item.json.body?.call?.duration_ms || 0 }}"},{"name":"human_duration","value":"={{ (() => { const ms = $('Webhook').item.json.body?.call?.duration_ms; if (!ms) return 'N/A'; const totalSeconds = Math.floor(ms / 1000); const minutes = Math.floor(totalSeconds / 60); const seconds = totalSeconds % 60; return `${minutes}m ${seconds}s`; })() }}"},{"name":"plain_transcript","value":"={{ (() => { const transcript = $('Webhook').item.json.body?.call?.transcript_object; if (!transcript || !Array.isArray(transcript)) return 'No transcript available'; return transcript.map(turn => `${turn.role?.charAt(0)?.toUpperCase() + turn.role?.slice(1) || 'Unknown'}: ${turn.content || ''}`).join('\\n\\n'); })() }}"},{"name":"html_transcript","value":"={{ (() => { const transcript = $('Webhook').item.json.body?.call?.transcript_object; if (!transcript || !Array.isArray(transcript)) return 'No transcript available'; return transcript.map(turn => `${turn.role?.charAt(0)?.toUpperCase() + turn.role?.slice(1) || 'Unknown'}: ${turn.content || ''}`).join('<br><br>'); })() }}"},{"name":"recording_url","value":"={{ $('Webhook').item.json.body?.call?.recording_url || 'N/A' }}"},{"name":"public_log_url","value":"={{ $('Webhook').item.json.body?.call?.public_log_url || 'N/A' }}"},{"name":"disconnection_reason","value":"={{ $('Webhook').item.json.body?.call?.disconnection_reason || 'N/A' }}"},{"name":"from_number","value":"={{ $('Webhook').item.json.body?.call?.from_number || 'N/A' }}"},{"name":"to_number","value":"={{ $('Webhook').item.json.body?.call?.to_number || 'N/A' }}"},{"name":"caller_name","value":"={{ (() => { const num = $('Webhook').item.json.body?.call?.to_number; if (num === '+61399997398') return '(YR MEL)'; if (num === '+61288800208') return '(YR SYD)'; return ''; })() }}"},{"name":"direction","value":"={{ $('Webhook').item.json.body?.call?.direction || 'unknown' }}"},{"name":"batch_call_id","value":"={{ $('Webhook').item.json.body?.call?.batch_call_id || 'N/A' }}"},{"name":"total_cost","value":"={{ $('Webhook').item.json.body?.call?.call_cost?.combined_cost || 0 }}"},{"name":"total_cost_cents","value":"={{ (($('Webhook').item.json.body?.call?.call_cost?.combined_cost || 0) / 100).toFixed(4) }}"},{"name":"total_duration_seconds","value":"={{ $('Webhook').item.json.body?.call?.call_cost?.total_duration_seconds || 0 }}"},{"name":"sentiment","value":"N/A"},{"name":"call_type_custom","value":"N/A"},{"name":"opt_out_storage","value":"={{ $('Webhook').item.json.body?.call?.opt_out_sensitive_data_storage || false }}"},{"name":"opt_in_signed_url","value":"={{ $('Webhook').item.json.body?.call?.opt_in_signed_url || 'N/A' }}"},{"name":"workflow_name","value":"={{ $workflow.name }}"},{"name":"processed_timestamp","value":"={{ new Date().toLocaleString('en-AU', { timeZone: 'Australia/Sydney' }) }}"}]},"options":{}},"id":"20a9b737-260c-40c2-85a9-f39fb41b876f","name":"Extract & Format Data","type":"n8n-nodes-base.set","typeVersion":2,"position":[1420,80]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $('Webhook').item.json.body?.event }}","rightValue":"call_ended","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"00a32ce6-d257-4078-9f64-39e51198f56d","name":"Is Call Ended?","type":"n8n-nodes-base.if","typeVersion":2,"position":[1140,80]},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1wW_ib_Q4qw9NCLzZPVIlyfOInQCGJBwqg2DyQ4YoUbo","mode":"id"},"sheetName":{"__rl":true,"value":"gid=0","mode":"id"},"columns":{"mappingMode":"defineBelow","value":{"call_id":"={{ $json.call_id }}","agent_id":"={{ $json.agent_id }}","agent_version":"={{ $json.agent_version }}","status":"={{ $json.status }}","start_time":"={{ $json.start_time }}","end_time":"={{ $json.end_time }}","duration_ms":"={{ $json.duration_ms }}","human_duration":"={{ $json.human_duration }}","plain_transcript":"={{ $json.plain_transcript }}","recording_url":"={{ $json.recording_url }}","public_log_url":"={{ $json.public_log_url }}","disconnection_reason":"={{ $json.disconnection_reason }}","from_number":"={{ $json.from_number }}","to_number":"={{ $json.to_number }}","caller_name":"={{ $json.caller_name }}","direction":"={{ $json.direction }}","batch_call_id":"={{ $json.batch_call_id }}","total_cost":"={{ $json.total_cost_cents }}","total_duration_seconds":"={{ $json.total_duration_seconds }}","sentiment":"={{ $json.sentiment }}","call_type_custom":"={{ $json.call_type_custom }}","opt_out_storage":"={{ $json.opt_out_storage }}","opt_in_signed_url":"={{ $json.opt_in_signed_url }}","workflow_name":"={{ $json.workflow_name }}","processed_timestamp":"={{ $json.processed_timestamp }}"},"matchingColumns":[],"schema":[]},"options":{"cellFormat":"USER_ENTERED"}},"id":"c70ddcf6-3d16-4b2d-9b96-3680a87f2852","name":"Google Sheets - Log Call","type":"n8n-nodes-base.googleSheets","typeVersion":4,"position":[1660,80],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.direction }}","rightValue":"inbound","operator":{"type":"string","operation":"equals"}},{"leftValue":"={{ $json.duration_ms }}","rightValue":10000,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"8c8e277e-58b8-4f3c-809e-52f9cbc77f8e","name":"Is Inbound Call > 10s?","type":"n8n-nodes-base.if","typeVersion":2,"position":[1860,240]}],"connections":{"Webhook":{"main":[[{"node":"Is Call Ended?","type":"main","index":0}]]},"Extract & Format Data":{"main":[[{"node":"Google Sheets - Log Call","type":"main","index":0},{"node":"Is Inbound Call > 10s?","type":"main","index":0}]]},"Is Call Ended?":{"main":[[{"node":"Extract & Format Data","type":"main","index":0}]]},"Is Inbound Call > 10s?":{"main":[[{"node":"Gmail","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"a241f5a9-5f14-408b-a063-051d0f2ec7c1","triggerCount":1,"shared":[{"updatedAt":"2025-10-23T07:49:16.172Z","createdAt":"2025-10-23T07:49:16.172Z","role":"workflow:owner","workflowId":"LjMVztuUxPtC4FLF","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-04T19:39:08.966Z","createdAt":"2025-12-04T08:49:05.884Z","id":"L3fbjYcet4fBet6l","name":"RetellAI - Book Appointment Compound v1.3 DATABASE_FIRST","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/book-appointment-compound","responseMode":"responseNode","options":{}},"id":"webhook-trigger-001","name":"Webhook Trigger","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,300],"webhookId":"book-appointment-compound"},{"parameters":{"jsCode":"// EXTRACT & VALIDATE - v1.3 DATABASE_FIRST\n// FIX: Remove default practitioner_id - return VALIDATION_ERROR if missing\n\nconst webhookData = $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n  if (phone.startsWith('+')) return phone;\n  if (phone.length === 8 && !phone.startsWith('+')) return '+612' + phone;\n  if (phone.length === 10 && phone.startsWith('0')) return '+61' + phone.substring(1);\n  if (phone.length === 11 && phone.startsWith('61')) return '+' + phone;\n  if (phone.length === 9) return '+61' + phone;\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n// Extract parameters - NO DEFAULTS for practitioner_id\nconst patient_id = args.patient_id || '';\nconst practitioner_id = args.practitioner_id || ''; // FIX: No default!\nconst appointment_type = args.appointment_type || 'Standard Consultation';\nconst starts_at = args.starts_at || args.start_time || args.datetime || '';\nconst duration_minutes = parseInt(args.duration_minutes) || 30;\nconst village = args.village || '';\nconst funding_type = (args.funding_type || '').toUpperCase();\nconst appointment_notes = args.appointment_notes || args.notes || '';\nconst unit_villa = args.unit_villa || '';\nconst is_new_client = args.is_new_client || false;\nconst client_name = args.client_name || '';\nconst call_id = call.call_id || args.call_id || '';\n\n// Validation\nconst errors = [];\n\nif (!patient_id) errors.push('patient_id is required');\nif (!starts_at) errors.push('starts_at is required');\nif (!village) errors.push('village is required');\nif (!funding_type) errors.push('funding_type is required');\n\n// FIX: practitioner_id is REQUIRED - do not guess\nif (!practitioner_id) {\n  errors.push('practitioner_id is required. Please ask which practitioner the client wants.');\n}\n\nconst validFundingTypes = ['HCP', 'DVA', 'GP', 'PRIVATE', 'PHI'];\nif (funding_type && !validFundingTypes.includes(funding_type)) {\n  errors.push(`Invalid funding_type. Must be one of: ${validFundingTypes.join(', ')}`);\n}\n\nlet appointmentDate;\ntry {\n  appointmentDate = new Date(starts_at);\n  if (isNaN(appointmentDate.getTime())) {\n    errors.push('Invalid starts_at format. Use ISO 8601 format.');\n  }\n} catch (e) {\n  errors.push('Invalid starts_at format. Use ISO 8601 format.');\n}\n\nconst now = new Date();\nif (appointmentDate && appointmentDate <= now) {\n  errors.push('Appointment starts_at must be in the future');\n}\n\nif (appointmentDate) {\n  const maxBookingDate = new Date(now);\n  maxBookingDate.setDate(now.getDate() + 21);\n  if (appointmentDate > maxBookingDate) {\n    const daysAhead = Math.ceil((appointmentDate - now) / (1000 * 60 * 60 * 24));\n    errors.push(`Appointment is ${daysAhead} days ahead. Bookings limited to 21 days.`);\n  }\n}\n\nif (errors.length > 0) {\n  return [{\n    json: {\n      success: false,\n      appointment_created: false,\n      error: {\n        code: 'VALIDATION_ERROR',\n        message: errors.join('; '),\n        details: errors\n      },\n      call_id: call_id,\n      timestamp: new Date().toISOString(),\n      validation_failed: true\n    }\n  }];\n}\n\n// Calculate derived fields\nconst starts_at_utc = appointmentDate.toISOString();\nconst endDate = new Date(appointmentDate);\nendDate.setMinutes(endDate.getMinutes() + duration_minutes);\nconst ends_at = endDate.toISOString();\nconst date_only = appointmentDate.toISOString().split('T')[0];\n\nconst daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\nconst day_of_week = daysOfWeek[appointmentDate.getDay()];\n\nconst hours = String(appointmentDate.getHours()).padStart(2, '0');\nconst minutes = String(appointmentDate.getMinutes()).padStart(2, '0');\nconst time_slot = `${hours}:${minutes}:00`;\n\nconst endHours = String(endDate.getHours()).padStart(2, '0');\nconst endMinutes = String(endDate.getMinutes()).padStart(2, '0');\nconst end_time = `${endHours}:${endMinutes}:00`;\n\nconst date_formatted = appointmentDate.toLocaleDateString('en-AU', { \n  timeZone: 'Australia/Sydney',\n  weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' \n});\nconst time_formatted = appointmentDate.toLocaleTimeString('en-AU', { \n  timeZone: 'Australia/Sydney',\n  hour: '2-digit', minute: '2-digit', hour12: true \n});\n\nconst clinikoNotes = [\n  `Village: ${village}`,\n  unit_villa ? `Unit/Villa: ${unit_villa}` : '',\n  `Funding: ${funding_type}`,\n  appointment_notes ? `Notes: ${appointment_notes}` : ''\n].filter(n => n).join('\\n');\n\nconst APPOINTMENT_TYPE_MAP = {\n  'Standard Consultation': '472831283798480897',\n  'Standard Home Visit': '472831283798480897'\n};\nconst appointment_type_id = APPOINTMENT_TYPE_MAP[appointment_type] || '472831283798480897';\n\nreturn [{\n  json: {\n    patient_id,\n    practitioner_id,\n    business_id: '675491769126754955',\n    appointment_type_id,\n    appointment_type,\n    starts_at: starts_at_utc,\n    starts_at_original: starts_at,\n    ends_at,\n    duration_minutes,\n    date_only,\n    day_of_week,\n    time_slot,\n    end_time,\n    date_formatted,\n    time_formatted,\n    village,\n    unit_villa,\n    funding_type,\n    appointment_notes,\n    cliniko_notes: clinikoNotes,\n    is_new_client,\n    client_name,\n    call_id,\n    start_time: Date.now(),\n    timestamp: new Date().toISOString(),\n    validation_failed: false\n  }\n}];"},"id":"code-extract-001","name":"Extract & Validate Request","type":"n8n-nodes-base.code","typeVersion":2,"position":[250,300]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"validation-failed-check","leftValue":"={{ $json.validation_failed }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"if-validation-001","name":"Validation Failed?","type":"n8n-nodes-base.if","typeVersion":2,"position":[500,300]},{"parameters":{"operation":"executeQuery","query":"-- Check for holiday on booking date\nSELECT date, description FROM safety_holidays WHERE date = $1::date LIMIT 1;","options":{"queryBatching":"independently","queryReplacement":"={{ $json.date_only }}"}},"id":"postgres-holiday-001","name":"Check Holiday","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[750,200],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"operation":"executeQuery","query":"-- Check for protected slots on this day/time\nSELECT id, day_of_week, start_time, end_time, reason\nFROM safety_protected_slots\nWHERE is_active = true\n  AND day_of_week = $1\n  AND (\n    (start_time <= $2::time AND end_time > $2::time)\n    OR (start_time < $3::time AND end_time >= $3::time)\n    OR (start_time >= $2::time AND end_time <= $3::time)\n  )\n  AND (practitioner_id IS NULL OR practitioner_id = $4)\n  AND (village IS NULL OR village = $5)\nLIMIT 1;","options":{"queryBatching":"independently","queryReplacement":"={{ [$json.day_of_week, $json.time_slot, $json.end_time, $json.practitioner_id, $json.village] }}"}},"id":"postgres-protected-001","name":"Check Protected Slots","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[750,400],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Run All Pre-Checks - v1.3 DATABASE_FIRST\n// FIX: Enabled holiday and protected slot checks using new table names\n\nconst requestData = $('Extract & Validate Request').first().json;\nconst holidayResult = $('Check Holiday').all();\nconst protectedResult = $('Check Protected Slots').all();\n\nlet blockers = [];\nlet warnings = [];\n\n// Holiday check\nlet is_holiday = false;\nlet holiday_name = null;\nif (holidayResult.length > 0 && holidayResult[0].json && holidayResult[0].json.date) {\n  is_holiday = true;\n  holiday_name = holidayResult[0].json.description;\n  blockers.push({\n    type: 'HOLIDAY_BLOCKED',\n    message: `Cannot book on ${holiday_name}`,\n    details: { date: holidayResult[0].json.date, holiday: holiday_name }\n  });\n}\n\n// Protected slot check\nlet is_protected_slot = false;\nlet protected_slot_reason = null;\nif (protectedResult.length > 0 && protectedResult[0].json && protectedResult[0].json.id) {\n  is_protected_slot = true;\n  protected_slot_reason = protectedResult[0].json.reason;\n  blockers.push({\n    type: 'PROTECTED_SLOT_BLOCKED',\n    message: `This time slot is protected: ${protected_slot_reason}`,\n    details: protectedResult[0].json\n  });\n}\n\nconst can_proceed = blockers.length === 0;\n\nreturn [{\n  json: {\n    ...requestData,\n    pre_checks: {\n      holiday: {\n        checked: true,\n        is_holiday,\n        holiday_name\n      },\n      protected_slot: {\n        checked: true,\n        is_protected: is_protected_slot,\n        reason: protected_slot_reason\n      }\n    },\n    can_proceed,\n    blockers,\n    warnings,\n    checks_completed_at: new Date().toISOString()\n  }\n}];"},"id":"code-prechecks-001","name":"Run All Pre-Checks","type":"n8n-nodes-base.code","typeVersion":2,"position":[1000,300]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"can-proceed-check","leftValue":"={{ $json.can_proceed }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"if-can-proceed-001","name":"Can Proceed?","type":"n8n-nodes-base.if","typeVersion":2,"position":[1250,300]},{"parameters":{"operation":"executeQuery","query":"-- Check if slot is still available in cache\n-- Mark as unavailable to prevent double-booking\nUPDATE individual_slots_cache\nSET is_available = false, last_synced = NOW()\nWHERE practitioner_id = $1\n  AND starts_at = $2::timestamptz\n  AND is_available = true\nRETURNING *;","options":{"queryBatching":"independently","queryReplacement":"={{ [$json.practitioner_id, $json.starts_at] }}"}},"id":"postgres-reserve-slot-001","name":"Reserve Slot in Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1500,200],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Check if slot was successfully reserved\nconst reserveResult = $input.all();\nconst requestData = $('Run All Pre-Checks').first().json;\n\n// If no rows returned, slot was already taken or doesn't exist\nconst wasReserved = reserveResult.length > 0 && reserveResult[0].json && reserveResult[0].json.id;\n\nif (!wasReserved) {\n  return [{\n    json: {\n      ...requestData,\n      slot_reserved: false,\n      can_proceed: false,\n      blockers: [\n        ...requestData.blockers,\n        {\n          type: 'SLOT_UNAVAILABLE',\n          message: 'This time slot is no longer available. It may have been booked by someone else.',\n          details: { practitioner_id: requestData.practitioner_id, starts_at: requestData.starts_at }\n        }\n      ]\n    }\n  }];\n}\n\n// Slot reserved successfully\nreturn [{\n  json: {\n    ...requestData,\n    slot_reserved: true,\n    reserved_slot: reserveResult[0].json\n  }\n}];"},"id":"code-check-reserve-001","name":"Check Reservation","type":"n8n-nodes-base.code","typeVersion":2,"position":[1750,200]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"slot-reserved-check","leftValue":"={{ $json.slot_reserved }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"if-slot-reserved-001","name":"Slot Reserved?","type":"n8n-nodes-base.if","typeVersion":2,"position":[2000,200]},{"parameters":{"method":"POST","url":"https://api.au2.cliniko.com/v1/individual_appointments","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"},{"name":"Accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ { patient_id: $json.patient_id, practitioner_id: $json.practitioner_id, business_id: $json.business_id, appointment_type_id: $json.appointment_type_id, starts_at: $json.starts_at, ends_at: $json.ends_at, notes: $json.cliniko_notes, send_sms: true, confirmed: true } }}","options":{}},"id":"http-create-appt-001","name":"Create Appointment in Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2250,100],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"// Process Cliniko response\nconst clinikoResponse = $input.item.json;\nconst requestData = $('Check Reservation').first().json;\n\nif (clinikoResponse.error || !clinikoResponse.id) {\n  const errorMsg = clinikoResponse.error || 'No appointment ID returned';\n  \n  // Rollback: Mark slot as available again\n  return [{\n    json: {\n      ...requestData,\n      appointment_created: false,\n      cliniko_error: errorMsg,\n      rollback_needed: true,\n      error: {\n        code: 'CLINIKO_CREATE_ERROR',\n        message: `Failed to create appointment: ${errorMsg}`\n      }\n    }\n  }];\n}\n\nconst patient_name = clinikoResponse.patient?.first_name && clinikoResponse.patient?.last_name\n  ? `${clinikoResponse.patient.first_name} ${clinikoResponse.patient.last_name}`\n  : requestData.client_name || 'Patient';\n\nreturn [{\n  json: {\n    ...requestData,\n    appointment_created: true,\n    appointment_id: clinikoResponse.id,\n    patient_name: patient_name,\n    practitioner_name: requestData.reserved_slot?.practitioner_name || 'Practitioner',\n    cliniko_link: `https://reignitehealth.au2.cliniko.com/appointments/${clinikoResponse.id}`,\n    sms_sent: true,\n    cliniko_response: clinikoResponse,\n    rollback_needed: false\n  }\n}];"},"id":"code-process-cliniko-001","name":"Process Cliniko Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[2500,100]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"appointment-created-check","leftValue":"={{ $json.appointment_created }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"if-created-001","name":"Appointment Created?","type":"n8n-nodes-base.if","typeVersion":2,"position":[2750,100]},{"parameters":{"method":"POST","url":"https://api.au2.cliniko.com/v1/treatment_notes","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"},{"name":"Accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ { individual_appointment_id: $json.appointment_id, content: 'Booked via Voice AI.\\nCall ID: ' + $json.call_id + '\\nFunding: ' + $json.funding_type + '\\nType: ' + $json.appointment_type + ($json.unit_villa ? '\\nUnit/Villa: ' + $json.unit_villa : '') + ($json.appointment_notes ? '\\nNotes: ' + $json.appointment_notes : '') } }}","options":{}},"id":"http-treatment-notes-001","name":"Add Treatment Notes","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3000,0],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"sendTo":"peter@yesai.au","subject":"=Voice AI Booking - {{ $('Process Cliniko Response').first().json.patient_name }}","message":"=<html><body style=\"font-family: Arial, sans-serif;\"><h2>Voice AI Booking</h2><p><strong>Patient:</strong> {{ $('Process Cliniko Response').first().json.patient_name }}</p><p><strong>Date:</strong> {{ $('Process Cliniko Response').first().json.date_formatted }}</p><p><strong>Time:</strong> {{ $('Process Cliniko Response').first().json.time_formatted }}</p><p><strong>Village:</strong> {{ $('Process Cliniko Response').first().json.village }}</p><p><strong>Funding:</strong> {{ $('Process Cliniko Response').first().json.funding_type }}</p><p><a href=\"{{ $('Process Cliniko Response').first().json.cliniko_link }}\">View in Cliniko</a></p></body></html>","options":{}},"id":"gmail-notify-001","name":"Send Email Notification","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[3250,0],"credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}},"continueOnFail":true},{"parameters":{"operation":"executeQuery","query":"DELETE FROM patient_funding_cache WHERE patient_id = $1 RETURNING *;","options":{"queryBatching":"independently","queryReplacement":"={{ $('Process Cliniko Response').first().json.patient_id }}"}},"id":"postgres-invalidate-001","name":"Invalidate Funding Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[3500,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"jsCode":"// Format final success response\nconst data = $('Process Cliniko Response').first().json;\nconst duration_ms = Date.now() - data.start_time;\n\nreturn [{\n  json: {\n    success: true,\n    appointment_created: true,\n    appointment_id: data.appointment_id,\n    confirmation_details: {\n      patient_name: data.patient_name,\n      practitioner_name: data.practitioner_name,\n      datetime: data.starts_at,\n      date: data.date_formatted,\n      time: data.time_formatted,\n      duration_minutes: data.duration_minutes,\n      village: data.village,\n      funding_type: data.funding_type,\n      appointment_type: data.appointment_type\n    },\n    pre_checks: data.pre_checks,\n    cliniko_link: data.cliniko_link,\n    call_id: data.call_id,\n    duration_ms: duration_ms,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"code-success-response-001","name":"Format Success Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[3750,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-success-001","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[4000,0]},{"parameters":{"jsCode":"// Format validation error response\nconst data = $json;\n\nreturn [{\n  json: {\n    success: false,\n    appointment_created: false,\n    error: data.error,\n    call_id: data.call_id,\n    timestamp: data.timestamp\n  }\n}];"},"id":"code-validation-error-001","name":"Format Validation Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[750,600]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-validation-001","name":"Respond Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1000,600]},{"parameters":{"jsCode":"// Format blocked response (pre-checks or slot unavailable)\nconst data = $json;\nconst duration_ms = Date.now() - data.start_time;\nconst primaryBlocker = data.blockers[0] || { type: 'UNKNOWN', message: 'Booking blocked' };\n\nreturn [{\n  json: {\n    success: false,\n    appointment_created: false,\n    error: {\n      code: primaryBlocker.type,\n      message: primaryBlocker.message,\n      all_blockers: data.blockers\n    },\n    pre_checks: data.pre_checks,\n    requested_details: {\n      datetime: data.starts_at,\n      date: data.date_formatted,\n      time: data.time_formatted,\n      village: data.village,\n      practitioner_id: data.practitioner_id\n    },\n    call_id: data.call_id,\n    duration_ms: duration_ms,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"code-blocked-response-001","name":"Format Blocked Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1500,500]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-blocked-001","name":"Respond Blocked","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1750,500]},{"parameters":{"operation":"executeQuery","query":"-- Rollback: Mark slot as available again\nUPDATE individual_slots_cache\nSET is_available = true, last_synced = NOW()\nWHERE practitioner_id = $1 AND starts_at = $2::timestamptz\nRETURNING *;","options":{"queryBatching":"independently","queryReplacement":"={{ [$json.practitioner_id, $json.starts_at] }}"}},"id":"postgres-rollback-001","name":"Rollback Slot Reservation","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[3000,250],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"jsCode":"// Format create error response\nconst data = $json;\nconst duration_ms = Date.now() - data.start_time;\n\nreturn [{\n  json: {\n    success: false,\n    appointment_created: false,\n    error: data.error || {\n      code: 'CLINIKO_CREATE_ERROR',\n      message: 'Failed to create appointment in Cliniko'\n    },\n    pre_checks: data.pre_checks,\n    requested_details: {\n      datetime: data.starts_at,\n      date: data.date_formatted,\n      time: data.time_formatted,\n      village: data.village\n    },\n    call_id: data.call_id,\n    duration_ms: duration_ms,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"code-create-error-001","name":"Format Create Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[3250,250]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-create-error-001","name":"Respond Create Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[3500,250]},{"parameters":{"jsCode":"// Format slot unavailable response\nconst data = $json;\nconst duration_ms = Date.now() - data.start_time;\n\nreturn [{\n  json: {\n    success: false,\n    appointment_created: false,\n    error: {\n      code: 'SLOT_UNAVAILABLE',\n      message: 'This time slot is no longer available.',\n      blockers: data.blockers\n    },\n    pre_checks: data.pre_checks,\n    requested_details: {\n      datetime: data.starts_at,\n      date: data.date_formatted,\n      time: data.time_formatted,\n      village: data.village\n    },\n    call_id: data.call_id,\n    duration_ms: duration_ms,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"code-slot-error-001","name":"Format Slot Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[2250,350]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-slot-error-001","name":"Respond Slot Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2500,350]}],"connections":{"Webhook Trigger":{"main":[[{"node":"Extract & Validate Request","type":"main","index":0}]]},"Extract & Validate Request":{"main":[[{"node":"Validation Failed?","type":"main","index":0}]]},"Validation Failed?":{"main":[[{"node":"Format Validation Error","type":"main","index":0}],[{"node":"Check Holiday","type":"main","index":0},{"node":"Check Protected Slots","type":"main","index":0}]]},"Format Validation Error":{"main":[[{"node":"Respond Validation Error","type":"main","index":0}]]},"Check Holiday":{"main":[[{"node":"Run All Pre-Checks","type":"main","index":0}]]},"Check Protected Slots":{"main":[[{"node":"Run All Pre-Checks","type":"main","index":0}]]},"Run All Pre-Checks":{"main":[[{"node":"Can Proceed?","type":"main","index":0}]]},"Can Proceed?":{"main":[[{"node":"Reserve Slot in Cache","type":"main","index":0}],[{"node":"Format Blocked Response","type":"main","index":0}]]},"Format Blocked Response":{"main":[[{"node":"Respond Blocked","type":"main","index":0}]]},"Reserve Slot in Cache":{"main":[[{"node":"Check Reservation","type":"main","index":0}]]},"Check Reservation":{"main":[[{"node":"Slot Reserved?","type":"main","index":0}]]},"Slot Reserved?":{"main":[[{"node":"Create Appointment in Cliniko","type":"main","index":0}],[{"node":"Format Slot Error","type":"main","index":0}]]},"Format Slot Error":{"main":[[{"node":"Respond Slot Error","type":"main","index":0}]]},"Create Appointment in Cliniko":{"main":[[{"node":"Process Cliniko Response","type":"main","index":0}]]},"Process Cliniko Response":{"main":[[{"node":"Appointment Created?","type":"main","index":0}]]},"Appointment Created?":{"main":[[{"node":"Add Treatment Notes","type":"main","index":0}],[{"node":"Rollback Slot Reservation","type":"main","index":0}]]},"Rollback Slot Reservation":{"main":[[{"node":"Format Create Error","type":"main","index":0}]]},"Format Create Error":{"main":[[{"node":"Respond Create Error","type":"main","index":0}]]},"Add Treatment Notes":{"main":[[{"node":"Send Email Notification","type":"main","index":0}]]},"Send Email Notification":{"main":[[{"node":"Invalidate Funding Cache","type":"main","index":0}]]},"Invalidate Funding Cache":{"main":[[{"node":"Format Success Response","type":"main","index":0}]]},"Format Success Response":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"7df28e14-8dbe-4530-9900-16ecb52612dd","triggerCount":1,"shared":[{"updatedAt":"2025-12-04T08:49:05.884Z","createdAt":"2025-12-04T08:49:05.884Z","role":"workflow:owner","workflowId":"L3fbjYcet4fBet6l","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-04T19:28:27.440Z","createdAt":"2025-12-04T19:24:50.917Z","id":"PLKm8iWDVxkDPxCT","name":"TEMP - SQL Test Runner","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"sql-test-runner","responseMode":"lastNode","options":{}},"id":"webhook-001","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"sql-test-runner"},{"parameters":{"operation":"executeQuery","query":"={{ $json.body.query }}","options":{}},"id":"postgres-001","name":"Run SQL","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[250,0],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"alwaysOutputData":true}],"connections":{"Webhook":{"main":[[{"node":"Run SQL","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"a4c9dc5e-63dc-498c-a8f0-f72ac8df5905","triggerCount":1,"shared":[{"updatedAt":"2025-12-04T19:24:50.917Z","createdAt":"2025-12-04T19:24:50.917Z","role":"workflow:owner","workflowId":"PLKm8iWDVxkDPxCT","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-10-03T04:23:53.000Z","createdAt":"2025-10-03T03:47:14.624Z","id":"EbMK7IS9ZIgAmVGz","name":"Reignite Health V1.0","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-voice-receptionist","responseMode":"responseNode","options":{}},"id":"f9e7039d-77bb-4070-b212-c3436909fc12","name":"Webhook - Incoming Call","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-5320,455],"webhookId":"reignite-voice-receptionist"},{"parameters":{"options":{}},"id":"11b1a93c-7c74-43ce-9adc-7ccc462f2e39","name":"Extract Call Data","type":"n8n-nodes-base.set","typeVersion":3.3,"position":[-5100,455]},{"parameters":{"jsCode":"// Normalize phone number for Australian format\nconst items = $input.all();\nconst fromNumber = items[0].json.from_number || '';\n\n// Remove formatting\nlet raw = fromNumber.replace(/[\\s\\(\\)\\-\\.]/g, '');\nlet normalized = raw;\n\n// Apply rules\nif (/^\\+61[24]/.test(raw)) {\n  normalized = raw;\n} else if (/^04/.test(raw)) {\n  normalized = '+61' + raw.substring(1);\n} else if (/^02/.test(raw)) {\n  normalized = '+61' + raw.substring(1);\n} else if (/^61[24]/.test(raw)) {\n  normalized = '+' + raw;\n} else if (!/^[0\\+]/.test(raw) && raw.length >= 8) {\n  normalized = '+612' + raw;\n} else if (/^0[^24]/.test(raw)) {\n  normalized = '+61' + raw.substring(1);\n}\n\nconst primarySearch = normalized.replace(/^\\+61/, '0');\n\nreturn [{\n  json: {\n    ...items[0].json,\n    normalized_phone: normalized,\n    primary_search: primarySearch,\n    original_phone: raw\n  }\n}];"},"id":"ee16ff8a-e5cd-44d0-be9c-300ea9c87325","name":"Normalize Phone Number","type":"n8n-nodes-base.code","typeVersion":2,"position":[-4880,455]},{"parameters":{"url":"=https://api.au1.cliniko.com/v1/patients?q={{ encodeURIComponent($json.primary_search) }}","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","options":{}},"id":"d4d7ab0d-5ee8-425f-be07-d8d39e32901f","name":"Search Client by Phone - Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-4660,455]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition-found","leftValue":"={{ $json.total_entries }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"3a6c0774-0877-4ac4-b369-07b15d86af07","name":"Client Found?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-4440,455]},{"parameters":{"jsCode":"const items = $input.all();\nconst data = items[0].json;\nconst patients = data.patients || [];\nconst patient = patients[0];\n\nif (!patient) {\n  return [{\n    json: {\n      ...data,\n      is_new_client: true,\n      client_id: null,\n      client_name: 'Unknown',\n      first_name: 'Unknown',\n      last_name: '',\n      email: '',\n      village_name: 'Unknown'\n    }\n  }];\n}\n\nconst villageName = patient.custom_fields?.village || patient.suburb || 'Unknown';\n\nreturn [{\n  json: {\n    ...data,\n    is_new_client: false,\n    client_id: patient.id,\n    client_name: `${patient.first_name} ${patient.last_name}`,\n    first_name: patient.first_name,\n    last_name: patient.last_name,\n    email: patient.email || '',\n    village_name: villageName,\n    patient_data: patient\n  }\n}];"},"id":"98a1a889-70a5-4afe-b550-6b9519e6f18a","name":"Extract Client Info","type":"n8n-nodes-base.code","typeVersion":2,"position":[-4220,455]},{"parameters":{"jsCode":"const items = $input.all();\nconst data = items[0].json;\nconst transcript = (data.transcript || '').toLowerCase();\nconst functionName = data.function_name || '';\n\n// Detect intent\nlet intent = 'GENERAL_ENQUIRY';\nlet fundingType = 'Private';\n\nif (functionName) {\n  const map = {\n    'create_booking': 'NEW_BOOKING',\n    'get_available_slots': 'NEW_BOOKING',\n    'reschedule_appointment': 'RESCHEDULE',\n    'cancel_appointment': 'CANCEL',\n    'check_class_availability': 'CLASS_ENQUIRY',\n    'escalate_to_human': 'ESCALATION',\n    'get_faq_answer': 'FAQ'\n  };\n  intent = map[functionName] || 'GENERAL_ENQUIRY';\n} else if (transcript.includes('book') || transcript.includes('appointment')) {\n  intent = 'NEW_BOOKING';\n} else if (transcript.includes('reschedule') || transcript.includes('change')) {\n  intent = 'RESCHEDULE';\n} else if (transcript.includes('cancel')) {\n  intent = 'CANCEL';\n} else if (transcript.includes('class') || transcript.includes('balance') || transcript.includes('aqua')) {\n  intent = 'CLASS_ENQUIRY';\n} else if (transcript.includes('complaint') || transcript.includes('upset')) {\n  intent = 'ESCALATION';\n} else if (transcript.includes('how much') || transcript.includes('cost') || transcript.includes('fee')) {\n  intent = 'FAQ';\n}\n\n// Detect funding\nif (transcript.includes('dva') || transcript.includes('veteran')) {\n  fundingType = 'DVA';\n} else if (transcript.includes('home care') || transcript.includes('hcp')) {\n  fundingType = 'HCP';\n} else if (transcript.includes('chsp')) {\n  fundingType = 'CHSP';\n} else if (transcript.includes('gp') || transcript.includes('referral')) {\n  fundingType = 'GP_Referral';\n} else if (transcript.includes('health fund')) {\n  fundingType = 'PHI';\n}\n\nreturn [{\n  json: {\n    ...data,\n    intent: intent,\n    funding_type: fundingType,\n    booking_reason: transcript,\n    confidence: 0.85\n  }\n}];"},"id":"4e1ed565-92dc-4be4-98f1-47b687fa2ee8","name":"Detect Intent","type":"n8n-nodes-base.code","typeVersion":2,"position":[-4000,455]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.intent }}","rightValue":"NEW_BOOKING","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"booking"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.intent }}","rightValue":"ESCALATION","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"escalation"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.intent }}","rightValue":"FAQ","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"faq"}]},"options":{"fallbackOutput":"extra"}},"id":"6cbdad5f-1948-4297-87b5-5581f4f00f47","name":"Route by Intent","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-3780,434]},{"parameters":{"documentId":{"__rl":true,"value":"GOOGLE_SHEET_ID","mode":"id"},"sheetName":{"__rl":true,"value":"Villages_Config","mode":"name"},"filtersUI":{"values":[{"lookupColumn":"village_name","lookupValue":"={{ $json.village_name }}"}]},"options":{}},"id":"1a589c19-b7e0-4847-be90-37769aedb66e","name":"Lookup Village Config","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[-3560,-20]},{"parameters":{"documentId":{"__rl":true,"value":"GOOGLE_SHEET_ID","mode":"id"},"sheetName":{"__rl":true,"value":"Village_Practitioners_Map","mode":"name"},"filtersUI":{"values":[{"lookupColumn":"village_name","lookupValue":"={{ $json.village_name }}"}]},"options":{}},"id":"7c635340-d8d6-41dc-b288-9a08281c9512","name":"Lookup Village Practitioners Map","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[-3560,180]},{"parameters":{"documentId":{"__rl":true,"value":"GOOGLE_SHEET_ID","mode":"id"},"sheetName":{"__rl":true,"value":"Appointment_Rules","mode":"name"},"filtersUI":{"values":[{"lookupColumn":"funding_type","lookupValue":"={{ $json.funding_type }}"}]},"options":{}},"id":"b4c7393d-9616-4fdd-8ce8-02085261499f","name":"Lookup Appointment Rules","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[-3560,380]},{"parameters":{"url":"https://api.au1.cliniko.com/v1/practitioners","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","options":{}},"id":"ad414005-5a15-4556-8aac-be909aa1886b","name":"Get All Practitioners - Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3340,180]},{"parameters":{"jsCode":"const items = $input.all();\nconst allPractitioners = items[0].json.practitioners || [];\nconst villageMap = $('Lookup Village Practitioners Map').first().json;\nconst allowedNames = (villageMap.practitioner_names || '').split(',').map(n => n.trim());\n\nconst available = allPractitioners.filter(prac => {\n  const fullName = `${prac.first_name} ${prac.last_name}`.trim();\n  return allowedNames.includes(fullName);\n});\n\nif (available.length === 0) {\n  return [{\n    json: {\n      ...items[0].json,\n      error: 'No practitioners found for this village',\n      practitioners: []\n    }\n  }];\n}\n\nreturn available.map(prac => ({\n  json: {\n    ...items[0].json,\n    practitioner_id: prac.id,\n    practitioner_name: `${prac.first_name} ${prac.last_name}`,\n    practitioner_data: prac\n  }\n}));"},"id":"9c59ac8a-a59d-4303-b810-f5e210d075cc","name":"Filter Practitioners for Village","type":"n8n-nodes-base.code","typeVersion":2,"position":[-3120,180]},{"parameters":{"url":"=https://api.au1.cliniko.com/v1/individual_appointments?practitioner_id={{ $json.practitioner_id }}&from={{ $now.minus({weeks: 4}).toFormat('yyyy-MM-dd') }}&to={{ $now.toFormat('yyyy-MM-dd') }}&per_page=100","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","options":{}},"id":"7086d032-6d7c-43c4-a91b-bf69d3637dcf","name":"Get Recurring Appointments - Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2900,180]},{"parameters":{"jsCode":"const items = $input.all();\nconst pastAppointments = items[0].json.individual_appointments || [];\nconst slotMap = {};\n\npastAppointments.forEach(appt => {\n  if (!appt.starts_at || !appt.patient) return;\n  \n  const date = new Date(appt.starts_at);\n  const dayOfWeek = date.toLocaleDateString('en-AU', { weekday: 'long' });\n  const timeSlot = date.toTimeString().substring(0, 5);\n  const key = `${dayOfWeek}_${timeSlot}_${appt.patient.id}`;\n  \n  if (!slotMap[key]) {\n    slotMap[key] = {\n      day_of_week: dayOfWeek,\n      time_start: timeSlot,\n      patient_id: appt.patient.id,\n      count: 0,\n      practitioner_id: appt.practitioner?.id\n    };\n  }\n  slotMap[key].count++;\n});\n\nconst recurringSlots = Object.values(slotMap).filter(slot => slot.count >= 2);\n\nreturn [{\n  json: {\n    ...items[0].json,\n    recurring_slots: recurringSlots,\n    recurring_count: recurringSlots.length\n  }\n}];"},"id":"6c3a347d-b25c-4b4d-9b3e-63ed5c4abf9d","name":"Identify Recurring Slot Patterns","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2680,180]},{"parameters":{"url":"=https://api.au1.cliniko.com/v1/individual_appointments?practitioner_id={{ $json.practitioner_id }}&from={{ $now.plus({days: 1}).toFormat('yyyy-MM-dd') }}&to={{ $now.plus({weeks: 3}).toFormat('yyyy-MM-dd') }}&available=true&per_page=50","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","options":{}},"id":"c30ba39c-34fc-4bfa-86e4-03b52cec1437","name":"Get Available Slots - Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2460,180]},{"parameters":{"jsCode":"const items = $input.all();\nconst availableSlots = items[0].json.individual_appointments || [];\nconst recurringSlots = items[0].json.recurring_slots || [];\n\nconst bookableSlots = availableSlots.filter(slot => {\n  if (!slot.starts_at) return false;\n  \n  const date = new Date(slot.starts_at);\n  const dayOfWeek = date.toLocaleDateString('en-AU', { weekday: 'long' });\n  const timeOfDay = date.toTimeString().substring(0, 5);\n  \n  const isRecurring = recurringSlots.some(recurring => {\n    return (\n      String(recurring.practitioner_id) === String(slot.practitioner?.id) &&\n      recurring.day_of_week === dayOfWeek &&\n      recurring.time_start === timeOfDay\n    );\n  });\n  \n  return !isRecurring;\n});\n\nconst formattedSlots = bookableSlots.slice(0, 5).map((slot, index) => {\n  const date = new Date(slot.starts_at);\n  const dayName = date.toLocaleDateString('en-AU', { weekday: 'long' });\n  const dateStr = date.toLocaleDateString('en-AU', { day: 'numeric', month: 'long' });\n  const timeStr = date.toLocaleTimeString('en-AU', { hour: 'numeric', minute: '2-digit', hour12: true });\n  \n  return {\n    option_number: index + 1,\n    option_text: `${dayName} ${dateStr} at ${timeStr}`,\n    starts_at: slot.starts_at,\n    ends_at: slot.ends_at,\n    practitioner_id: slot.practitioner?.id,\n    practitioner_name: items[0].json.practitioner_name\n  };\n});\n\nconst message = formattedSlots.length > 0\n  ? `I have these times available: ${formattedSlots.map(s => `Option ${s.option_number}: ${s.option_text}`).join(', or ')}. Which would suit you best?`\n  : \"I don't have any available slots in the next 3 weeks. Let me take your details and have our team call you back.\";\n\nreturn [{\n  json: {\n    ...items[0].json,\n    available_slots: formattedSlots,\n    slots_count: formattedSlots.length,\n    formatted_message: message,\n    has_slots: formattedSlots.length > 0\n  }\n}];"},"id":"be780c29-ea93-4dd1-aa08-a3ec8c15714c","name":"Filter Recurring & Format Slots","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2240,180]},{"parameters":{"method":"POST","url":"https://api.retellai.com/v1/update-conversation","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={{ { \"call_id\": $json.call_id, \"agent_prompt\": $json.formatted_message } }}","options":{}},"id":"30382aa5-1946-433e-9efd-60846fbd28fe","name":"Send Available Slots to RetellAI","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2020,180]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.has_slots }}","rightValue":true,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"id":"a3260476-3b20-4235-b064-843914f4d199","name":"Has Slots?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1800,180]},{"parameters":{"method":"POST","url":"https://api.au1.cliniko.com/v1/individual_appointments","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={{ {\n  \"patient_id\": $json.client_id,\n  \"practitioner_id\": $json.available_slots[0].practitioner_id,\n  \"appointment_type_id\": $('Lookup Appointment Rules').first().json.cliniko_appointment_type_id,\n  \"business_id\": $('Lookup Village Config').first().json.cliniko_business_id,\n  \"starts_at\": $json.available_slots[0].starts_at,\n  \"ends_at\": $json.available_slots[0].ends_at,\n  \"notes\": \"REASON: \" + $json.booking_reason + \"\\n\\nFUNDING: \" + $json.funding_type + \"\\n\\nBooked via AI Voice Receptionist\\nCall ID: \" + $json.call_id\n} }}","options":{}},"id":"931b4bfa-1b47-4872-8ed4-ce7468e68d1a","name":"Create Appointment - Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1580,105]},{"parameters":{"method":"POST","url":"https://www.mobilemessage.com.au/api/v2/send","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={{ {\n  \"to\": $json.normalized_phone,\n  \"from\": \"ReigniteHP\",\n  \"message\": \"Reignite Health: \" + $json.first_name + \", your appointment with \" + $json.available_slots[0].practitioner_name + \" is booked for \" + $json.available_slots[0].option_text + \" at \" + $json.village_name + \".\\n\\nüìç \" + $('Lookup Village Config').first().json.consult_room_location + \"\\n\\n‚úÖ Reply YES to confirm or call (02) 888 05 883 to change.\\n\\nüìã Please bring: \" + $('Lookup Appointment Rules').first().json.items_to_bring\n} }}","options":{}},"id":"b9b920ff-7048-4deb-a3ac-fb1379a98ee9","name":"Send Booking Confirmation SMS","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1360,105]},{"parameters":{"sendTo":"hello@reignitehealth.com.au","subject":"=Call Summary - {{ $json.client_name }} (Booking Completed)","emailType":"text","message":"=Hi Team,\n\nCall Summary from AI Voice Receptionist:\n\nüìû CALL DETAILS:\nCall ID: {{ $json.call_id }}\nDate/Time: {{ $json.timestamp_nsw }} (NSW)\n\nüë§ CLIENT:\nName: {{ $json.client_name }}\nPhone: {{ $json.normalized_phone }}\nVillage: {{ $json.village_name }}\n\nüéØ INTENT: {{ $json.intent }}\n\n‚úÖ OUTCOME: Booking Completed\n\nüìÖ APPOINTMENT BOOKED:\nPractitioner: {{ $json.available_slots[0].practitioner_name }}\nDate/Time: {{ $json.available_slots[0].option_text }}\nLocation: {{ $('Lookup Village Config').first().json.consult_room_location }}\nFunding: {{ $json.funding_type }}\n\nüìù BOOKING REASON:\n{{ $json.booking_reason }}\n\n‚Äî\nAI Voice Receptionist\nPowered by Yes AI (yesrightau@gmail.com)","options":{}},"id":"2eaebefd-ee8f-499f-bca4-4124e2a8452b","name":"Send Call Summary Email","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[-1140,105],"webhookId":"c310e940-1149-4135-8bc0-477c0ba60375"},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"GOOGLE_SHEET_ID","mode":"id"},"sheetName":{"__rl":true,"value":"Call_Log","mode":"name"},"columns":{"mappingMode":"defineBelow","value":{"call_id":"={{ $json.call_id }}","timestamp_nsw":"={{ $json.timestamp_nsw }}","caller_phone":"={{ $json.normalized_phone }}","client_name":"={{ $json.client_name }}","village":"={{ $json.village_name }}","intent":"={{ $json.intent }}","duration_seconds":"","outcome":"Booking Completed","fcr":"Yes","booking_error":"No","escalated":"No","practitioner_booked":"={{ $json.available_slots[0].practitioner_name }}","appointment_datetime":"={{ $json.available_slots[0].option_text }}","notes":"={{ $json.booking_reason }}"}},"options":{}},"id":"3b598f3e-4c3f-4391-b981-625bd1a05c5f","name":"Log Call to Google Sheets","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[-920,105]},{"parameters":{"documentId":{"__rl":true,"value":"GOOGLE_SHEET_ID","mode":"id"},"sheetName":{"__rl":true,"value":"Public_Holidays_NSW","mode":"name"},"options":{}},"id":"5d4f005e-cabc-4002-b45f-a1f00ca1542b","name":"Load Public Holidays","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[-3560,780]},{"parameters":{"jsCode":"const items = $input.all();\nconst data = items[0].json;\nconst now = new Date();\nconst currentDate = now.toISOString().split('T')[0];\nconst currentDay = now.toLocaleDateString('en-AU', { weekday: 'long' });\nconst currentHour = now.getHours();\n\nconst holidays = $('Load Public Holidays').all().map(h => h.json.date);\nconst isPublicHoliday = holidays.includes(currentDate);\nconst isWeekday = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].includes(currentDay);\nconst isBusinessHours = isWeekday && currentHour >= 9 && currentHour < 17 && !isPublicHoliday;\n\nconst escalationAvailable = isBusinessHours;\nconst escalationPhone = escalationAvailable ? '+61437160997' : null;\n\nreturn [{\n  json: {\n    ...data,\n    current_datetime_nsw: now.toISOString(),\n    day_of_week: currentDay,\n    is_business_hours: isBusinessHours,\n    is_public_holiday: isPublicHoliday,\n    escalation_available: escalationAvailable,\n    escalation_phone: escalationPhone,\n    escalation_email: 'sara@reignitehealth.com.au'\n  }\n}];"},"id":"5e14143c-ac31-415f-b7dc-fe445df1330f","name":"Check Business Hours NSW","type":"n8n-nodes-base.code","typeVersion":2,"position":[-3340,780]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.escalation_available }}","rightValue":true,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"id":"5b808762-53fb-45ef-9125-a163762575d5","name":"Escalation Available?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-3120,780]},{"parameters":{"method":"POST","url":"https://api.retellai.com/v1/transfer-call","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={{ {\n  \"call_id\": $json.call_id,\n  \"transfer_to\": $json.escalation_phone,\n  \"transfer_type\": \"cold\",\n  \"pre_transfer_message\": \"I'm going to connect you with our Operations Manager Sara right now. Please hold for just a moment.\"\n} }}","options":{}},"id":"c23b61e9-923f-4625-93b2-61da9df48067","name":"Cold Transfer to Sara","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2900,680]},{"parameters":{"sendTo":"sara@reignitehealth.com.au","subject":"=üö® URGENT - After Hours Escalation - {{ $json.client_name }}","emailType":"text","message":"=Hi Sara,\n\nüö® URGENT: A client has escalated an issue after business hours.\n\nüìû CALL DETAILS:\nCall ID: {{ $json.call_id }}\nDate/Time: {{ $json.timestamp_nsw }} (NSW)\n\nüë§ CLIENT:\nName: {{ $json.client_name }}\nPhone: {{ $json.normalized_phone }}\nVillage: {{ $json.village_name }}\n\nüî¥ ISSUE:\n{{ $json.booking_reason }}\n\nüí¨ TRANSCRIPT:\n{{ $json.transcript }}\n\n‚úÖ ACTION REQUIRED:\nPlease call back first thing in the morning.\n\n‚Äî\nAI Voice Receptionist\nPowered by Yes AI (yesrightau@gmail.com)\nCall ID: {{ $json.call_id }}","options":{}},"id":"de75fa03-78c2-4806-9b39-68f67469325a","name":"Send Escalation Email (After Hours)","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[-2900,880],"webhookId":"1e38b83d-5049-42d7-ad75-5058a02c605e"},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"GOOGLE_SHEET_ID","mode":"id"},"sheetName":{"__rl":true,"value":"Escalation_Log","mode":"name"},"columns":{"mappingMode":"defineBelow","value":{"escalation_id":"={{ $now.toFormat('yyyyMMddHHmmss') }}-{{ $json.call_id }}","call_id":"={{ $json.call_id }}","timestamp_nsw":"={{ $json.timestamp_nsw }}","client_name":"={{ $json.client_name }}","client_phone":"={{ $json.normalized_phone }}","village":"={{ $json.village_name }}","escalation_reason":"={{ $json.booking_reason }}","escalation_type":"={{ $json.escalation_available ? 'Business Hours Transfer' : 'After Hours Email' }}","sent_to":"={{ $json.escalation_email }}","recording_url":"","transcript":"={{ $json.transcript }}","status":"Pending","resolution_notes":""}},"options":{}},"id":"b55a8666-f2ef-45c5-a250-0b8af98ae929","name":"Log Escalation to Google Sheets","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[-2680,780]},{"parameters":{"documentId":{"__rl":true,"value":"GOOGLE_SHEET_ID","mode":"id"},"sheetName":{"__rl":true,"value":"FAQs","mode":"name"},"options":{}},"id":"b41f8735-9e52-4ff3-a37b-0c0bc3ec70d3","name":"Load FAQs","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[-3560,1080]},{"parameters":{"jsCode":"const items = $input.all();\nconst data = items[0].json;\nconst transcript = (data.transcript || '').toLowerCase();\nconst faqs = $('Load FAQs').all().map(f => f.json);\n\nlet bestMatch = null;\nlet highestScore = 0;\n\nfaqs.forEach(faq => {\n  const keywords = (faq.keywords || '').toLowerCase().split(',');\n  let score = 0;\n  \n  keywords.forEach(keyword => {\n    if (transcript.includes(keyword.trim())) {\n      score++;\n    }\n  });\n  \n  if (score > highestScore) {\n    highestScore = score;\n    bestMatch = faq;\n  }\n});\n\nif (bestMatch) {\n  return [{\n    json: {\n      ...data,\n      faq_found: true,\n      faq_question: bestMatch.question,\n      faq_answer: bestMatch.answer,\n      faq_category: bestMatch.category\n    }\n  }];\n} else {\n  return [{\n    json: {\n      ...data,\n      faq_found: false,\n      faq_answer: \"I'm not sure about that. Let me connect you with our team who can help you.\"\n    }\n  }];\n}"},"id":"c8b46e9e-3cbc-4201-af01-fbc98e766c32","name":"Search FAQs","type":"n8n-nodes-base.code","typeVersion":2,"position":[-3340,1080]},{"parameters":{"method":"POST","url":"https://api.retellai.com/v1/update-conversation","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={{ { \"call_id\": $json.call_id, \"agent_prompt\": $json.faq_answer } }}","options":{}},"id":"26aaa6c1-6efd-4dd6-8c19-e967658335dc","name":"Send FAQ Answer to RetellAI","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3120,1080]},{"parameters":{"respondWith":"json","responseBody":"={{ { \"status\": \"success\", \"message\": \"Call processed\", \"call_id\": $json.call_id } }}","options":{}},"id":"a40bfe53-acb5-4f6c-98f7-3962ab16d809","name":"Webhook Response","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-260,355]},{"parameters":{"mode":"combine","options":{}},"id":"4e3dcbf0-f733-4ca3-a2ac-29018aca1135","name":"Merge - End Booking Flow","type":"n8n-nodes-base.merge","typeVersion":3,"position":[-700,180]},{"parameters":{"mode":"combine","options":{}},"id":"90caf306-0c97-48f6-9132-f9a1364c5577","name":"Merge - End Escalation Flow","type":"n8n-nodes-base.merge","typeVersion":3,"position":[-2460,780]},{"parameters":{"mode":"combine","options":{}},"id":"b80e9162-c188-436c-b40b-1c981ba4e3cd","name":"Merge - End FAQ Flow","type":"n8n-nodes-base.merge","typeVersion":3,"position":[-2900,1080]},{"parameters":{"mode":"combine","options":{}},"id":"8072217a-dfeb-485a-a07a-2c5bcd73a3a9","name":"Merge All Flows","type":"n8n-nodes-base.merge","typeVersion":3,"position":[-480,355]}],"connections":{"Webhook - Incoming Call":{"main":[[{"node":"Extract Call Data","type":"main","index":0}]]},"Extract Call Data":{"main":[[{"node":"Normalize Phone Number","type":"main","index":0}]]},"Normalize Phone Number":{"main":[[{"node":"Search Client by Phone - Cliniko","type":"main","index":0}]]},"Search Client by Phone - Cliniko":{"main":[[{"node":"Client Found?","type":"main","index":0}]]},"Client Found?":{"main":[[{"node":"Extract Client Info","type":"main","index":0}],[{"node":"Extract Client Info","type":"main","index":0}]]},"Extract Client Info":{"main":[[{"node":"Detect Intent","type":"main","index":0}]]},"Detect Intent":{"main":[[{"node":"Route by Intent","type":"main","index":0}]]},"Route by Intent":{"main":[[{"node":"Lookup Village Config","type":"main","index":0},{"node":"Lookup Village Practitioners Map","type":"main","index":0},{"node":"Lookup Appointment Rules","type":"main","index":0}],[{"node":"Load Public Holidays","type":"main","index":0}],[{"node":"Load FAQs","type":"main","index":0}],[{"node":"Merge All Flows","type":"main","index":0}]]},"Lookup Village Practitioners Map":{"main":[[{"node":"Get All Practitioners - Cliniko","type":"main","index":0}]]},"Get All Practitioners - Cliniko":{"main":[[{"node":"Filter Practitioners for Village","type":"main","index":0}]]},"Filter Practitioners for Village":{"main":[[{"node":"Get Recurring Appointments - Cliniko","type":"main","index":0}]]},"Get Recurring Appointments - Cliniko":{"main":[[{"node":"Identify Recurring Slot Patterns","type":"main","index":0}]]},"Identify Recurring Slot Patterns":{"main":[[{"node":"Get Available Slots - Cliniko","type":"main","index":0}]]},"Get Available Slots - Cliniko":{"main":[[{"node":"Filter Recurring & Format Slots","type":"main","index":0}]]},"Filter Recurring & Format Slots":{"main":[[{"node":"Send Available Slots to RetellAI","type":"main","index":0}]]},"Send Available Slots to RetellAI":{"main":[[{"node":"Has Slots?","type":"main","index":0}]]},"Has Slots?":{"main":[[{"node":"Create Appointment - Cliniko","type":"main","index":0}],[{"node":"Merge - End Booking Flow","type":"main","index":1}]]},"Create Appointment - Cliniko":{"main":[[{"node":"Send Booking Confirmation SMS","type":"main","index":0}]]},"Send Booking Confirmation SMS":{"main":[[{"node":"Send Call Summary Email","type":"main","index":0}]]},"Send Call Summary Email":{"main":[[{"node":"Log Call to Google Sheets","type":"main","index":0}]]},"Log Call to Google Sheets":{"main":[[{"node":"Merge - End Booking Flow","type":"main","index":0}]]},"Merge - End Booking Flow":{"main":[[{"node":"Merge All Flows","type":"main","index":1}]]},"Load Public Holidays":{"main":[[{"node":"Check Business Hours NSW","type":"main","index":0}]]},"Check Business Hours NSW":{"main":[[{"node":"Escalation Available?","type":"main","index":0}]]},"Escalation Available?":{"main":[[{"node":"Cold Transfer to Sara","type":"main","index":0}],[{"node":"Send Escalation Email (After Hours)","type":"main","index":0}]]},"Cold Transfer to Sara":{"main":[[{"node":"Log Escalation to Google Sheets","type":"main","index":0}]]},"Send Escalation Email (After Hours)":{"main":[[{"node":"Log Escalation to Google Sheets","type":"main","index":0}]]},"Log Escalation to Google Sheets":{"main":[[{"node":"Merge - End Escalation Flow","type":"main","index":0}]]},"Load FAQs":{"main":[[{"node":"Search FAQs","type":"main","index":0}]]},"Search FAQs":{"main":[[{"node":"Send FAQ Answer to RetellAI","type":"main","index":0}]]},"Send FAQ Answer to RetellAI":{"main":[[{"node":"Merge - End FAQ Flow","type":"main","index":0}]]},"Merge All Flows":{"main":[[{"node":"Webhook Response","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"96ada434-22e0-4b6a-821a-8277ba4f5022","triggerCount":0,"shared":[{"updatedAt":"2025-10-23T07:49:16.172Z","createdAt":"2025-10-23T07:49:16.172Z","role":"workflow:owner","workflowId":"EbMK7IS9ZIgAmVGz","projectId":"ePBcCsWsgvLDebw1"}],"tags":[{"updatedAt":"2025-10-03T03:47:29.353Z","createdAt":"2025-10-03T03:47:29.353Z","id":"dbO1yennvLLTWb9D","name":"Reignite"}]},{"updatedAt":"2025-11-07T22:30:13.974Z","createdAt":"2025-10-06T03:43:19.628Z","id":"9BO1b05irJxtGeKU","name":"RH_Main_Call_Handler","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-main","responseMode":"responseNode","options":{}},"id":"21f726cd-1a22-4d20-8492-946146295da7","name":"Webhook - RetellAI","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-1792,400],"webhookId":"reignite-main"},{"parameters":{"functionCode":"// Normalize phone number to E.164 format\nconst input = $input.item.json.caller_phone || \"\";\nlet cleaned = input.replace(/[\\s\\-\\(\\)\\.]/g, \"\");\n\nlet normalized_phone;\nlet error = null;\n\nif (cleaned.startsWith(\"+61\")) {\n  normalized_phone = cleaned;\n} else if (cleaned.startsWith(\"0\")) {\n  normalized_phone = \"+61\" + cleaned.slice(1);\n} else if (cleaned.length >= 8) {\n  // Assume (02) Sydney area code if no prefix\n  normalized_phone = \"+612\" + cleaned;\n} else {\n  normalized_phone = null;\n  error = \"Invalid phone number - too short\";\n}\n\nreturn {\n  ...($input.item.json),\n  normalized_phone: normalized_phone,\n  normalization_error: error,\n  original_phone: input\n};"},"id":"8915c66f-1ace-4736-aafd-110b0ecdb1f2","name":"Normalize Phone Number","type":"n8n-nodes-base.function","typeVersion":1,"position":[-1568,400]},{"parameters":{"documentId":{"__rl":true,"mode":"list","value":""},"sheetName":{"__rl":true,"mode":"list","value":""}},"id":"f0cae32c-0527-448b-beee-58c6f8ace672","name":"Read Business Hours","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[-1344,304]},{"parameters":{"documentId":{"__rl":true,"mode":"list","value":""},"sheetName":{"__rl":true,"mode":"list","value":""}},"id":"28924e6e-3ccc-43ee-a5dc-a19816746c7e","name":"Read Public Holidays","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[-1344,496]},{"parameters":{"functionCode":"// Check if current time is within business hours\nconst moment = require('moment-timezone');\nconst now = moment().tz('Australia/Sydney');\nconst currentDay = now.format('dddd');\nconst currentTime = now.format('HH:mm');\nconst currentDate = now.format('YYYY-MM-DD');\n\n// Get business hours from previous node\nconst businessHoursRaw = $('Read Business Hours').all();\nconst businessHours = businessHoursRaw.slice(1).map(item => ({\n  day_of_week: item.json[0],\n  is_open: item.json[1],\n  open_time: item.json[2],\n  close_time: item.json[3],\n  timezone: item.json[4],\n  notes: item.json[5]\n}));\n\n// Get public holidays from previous node\nconst holidaysRaw = $('Read Public Holidays').all();\nconst publicHolidays = holidaysRaw.slice(1).map(item => ({\n  date: item.json[0],\n  name: item.json[1],\n  active: item.json[2]\n}));\n\n// Check if today is a public holiday\nconst isPublicHoliday = publicHolidays.some(h => \n  h.date === currentDate && h.active === 'TRUE'\n);\n\n// Check if current day/time is within business hours\nconst todayHours = businessHours.find(h => h.day_of_week === currentDay);\nconst isBusinessHours = todayHours && \n                        todayHours.is_open === 'TRUE' && \n                        currentTime >= todayHours.open_time && \n                        currentTime < todayHours.close_time &&\n                        !isPublicHoliday;\n\nreturn {\n  ...$input.item.json,\n  is_business_hours: isBusinessHours,\n  current_day: currentDay,\n  current_time: currentTime,\n  current_date: currentDate,\n  is_public_holiday: isPublicHoliday,\n  check_timestamp: now.format()\n};"},"id":"1f0702e7-0d12-4a94-9032-5291910d4a81","name":"Check Business Hours","type":"n8n-nodes-base.function","typeVersion":1,"position":[-1120,400]},{"parameters":{"mode":"expression","output":"={{ $json.function }}"},"id":"8a343db3-8663-4445-a12a-d367dced84fb","name":"Route by Function","type":"n8n-nodes-base.switch","typeVersion":2,"position":[-896,368]},{"parameters":{"documentId":{"__rl":true,"mode":"list","value":""},"sheetName":{"__rl":true,"mode":"list","value":""}},"id":"483831c4-dc55-42e9-97e7-5f25a17d29c7","name":"Read Villages Config","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[-672,256]},{"parameters":{"functionCode":"// Find village and return directions\nconst villageRequested = $input.item.json.village;\nconst locationType = $input.item.json.location_type || 'consult_room';\n\n// Get villages data from previous node\nconst villagesRaw = $('Read Villages Config').all();\nconst villages = villagesRaw.slice(1).map(item => ({\n  village_name: item.json[0],\n  village_short: item.json[1],\n  address: item.json[2],\n  consult_room_location: item.json[3],\n  better_balance_location: item.json[4],\n  aqua_location: item.json[5],\n  gym_fit_location: item.json[6],\n  ep_class_location: item.json[7],\n  capacity_restricted: item.json[8],\n  notes: item.json[9],\n  active: item.json[10]\n}));\n\n// Find matching village (case-insensitive partial match)\nconst village = villages.find(v => \n  v.active === 'TRUE' && (\n    v.village_name.toLowerCase().includes(villageRequested.toLowerCase()) ||\n    v.village_short.toLowerCase().includes(villageRequested.toLowerCase())\n  )\n);\n\nif (!village) {\n  return {\n    success: false,\n    message: \"I couldn't find that village in our system. Which village are you at?\"\n  };\n}\n\n// Get the appropriate directions based on location type\nlet directions;\nswitch(locationType.toLowerCase()) {\n  case 'better_balance':\n  case 'class':\n    directions = village.better_balance_location;\n    break;\n  case 'aqua':\n  case 'hydrotherapy':\n    directions = village.aqua_location;\n    break;\n  case 'gym_fit':\n  case 'gym':\n    directions = village.gym_fit_location;\n    break;\n  case 'ep_class':\n    directions = village.ep_class_location;\n    break;\n  default:\n    directions = village.consult_room_location;\n}\n\nif (!directions || directions === 'N/A') {\n  directions = \"We don't currently offer that service at this village. Let me help you with an alternative.\";\n}\n\nreturn {\n  success: true,\n  village: village.village_name,\n  directions: directions,\n  address: village.address,\n  capacity_restricted: village.capacity_restricted === 'TRUE',\n  message: directions\n};"},"id":"0edbfcf0-39f2-4cfa-b736-34aa6801b27a","name":"Get Directions Logic","type":"n8n-nodes-base.function","typeVersion":1,"position":[-448,256]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"e0f39f03-ac4b-43ad-a619-2002bd786505","name":"Respond - Directions","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[-224,256]},{"parameters":{"documentId":{"__rl":true,"mode":"list","value":""},"sheetName":{"__rl":true,"mode":"list","value":""}},"id":"872a7d6c-1f76-4981-aa84-88d3f40990f7","name":"Read FAQs","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[-1792,32]},{"parameters":{"functionCode":"// Search FAQs for best match\nconst query = ($input.item.json.query || $input.item.json.question || '').toLowerCase();\n\n// Get FAQs from previous node\nconst faqsRaw = $('Read FAQs').all();\nconst faqs = faqsRaw.slice(1).map(item => ({\n  faq_id: item.json[0],\n  category: item.json[1],\n  question: item.json[2],\n  answer: item.json[3],\n  active: item.json[4]\n})).filter(f => f.active === 'TRUE');\n\n// Simple keyword matching\nconst matches = faqs.map(faq => {\n  const questionLower = faq.question.toLowerCase();\n  const categoryLower = faq.category.toLowerCase();\n  \n  // Calculate match score\n  let score = 0;\n  const queryWords = query.split(' ');\n  \n  queryWords.forEach(word => {\n    if (word.length > 3) { // Only match words longer than 3 chars\n      if (questionLower.includes(word)) score += 3;\n      if (categoryLower.includes(word)) score += 2;\n      if (faq.answer.toLowerCase().includes(word)) score += 1;\n    }\n  });\n  \n  return { ...faq, score };\n}).filter(f => f.score > 0).sort((a, b) => b.score - a.score);\n\nif (matches.length === 0) {\n  return {\n    success: false,\n    message: \"I don't have specific information about that. Would you like me to take a message for someone to call you back?\"\n  };\n}\n\nconst bestMatch = matches[0];\n\nreturn {\n  success: true,\n  faq_id: bestMatch.faq_id,\n  question: bestMatch.question,\n  answer: bestMatch.answer,\n  category: bestMatch.category,\n  message: bestMatch.answer\n};"},"id":"e6c5bbef-baea-44d9-86cd-a55a94a5a14d","name":"Search FAQ Logic","type":"n8n-nodes-base.function","typeVersion":1,"position":[-1568,32]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"5d30a73a-2052-4c81-8ce1-97f235f726b7","name":"Respond - FAQ","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[-1344,32]},{"parameters":{"url":"=https://api.au1.cliniko.com/v1/patients?q=phone:{{ $json.normalized_phone }}","authentication":"predefinedCredentialType","nodeCredentialType":"clinikoApi","options":{"redirect":{"redirect":{}}}},"id":"9be3ef48-c3ab-4a1f-9559-eb6f7dc3d002","name":"Lookup Client in Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-672,496]},{"parameters":{"conditions":{"options":{"caseSensitive":false},"conditions":[{"leftValue":"={{ $json.patients.length }}","rightValue":"0","operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"15dacdb2-c4db-4458-9a2e-424aeee33ab9","name":"Client Exists?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-448,496]},{"parameters":{"method":"POST","url":"https://api.au1.cliniko.com/v1/patients","authentication":"predefinedCredentialType","nodeCredentialType":"clinikoApi","sendBody":true,"bodyParameters":{"parameters":[{"name":"first_name","value":"={{ $json.caller_name.split(' ')[0] }}"},{"name":"last_name","value":"={{ $json.caller_name.split(' ').slice(1).join(' ') || $json.caller_name.split(' ')[0] }}"},{"name":"phone_numbers","value":"=[{\"number\": \"{{ $json.normalized_phone }}\", \"phone_type\": \"Mobile\"}]"},{"name":"email","value":"={{ $json.caller_email || '' }}"},{"name":"address_1","value":"={{ $json.village || '' }}"},{"name":"notes","value":"New client via AI receptionist. Call ID: {{ $json.call_id }}"}]},"options":{}},"id":"63aaedb6-91c1-4d88-a38d-140e22f074e3","name":"Create Client in Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-224,560]},{"parameters":{"functionCode":"// Extract patient_id from either lookup or create\nlet patientId;\nlet patientData;\n\nif ($input.item.json.patients && $input.item.json.patients.length > 0) {\n  // From lookup\n  patientData = $input.item.json.patients[0];\n  patientId = patientData.id;\n} else if ($input.item.json.id) {\n  // From create\n  patientId = $input.item.json.id;\n  patientData = $input.item.json;\n} else {\n  throw new Error('No patient ID found');\n}\n\nreturn {\n  ...$input.item.json,\n  patient_id: patientId,\n  patient_data: patientData\n};"},"id":"1a2a0dd8-c1e2-45e5-9f16-4e6dc8e5c7f9","name":"Extract Patient ID","type":"n8n-nodes-base.function","typeVersion":1,"position":[0,496]},{"parameters":{"documentId":{"__rl":true,"mode":"list","value":""},"sheetName":{"__rl":true,"mode":"list","value":""}},"id":"1ee76ce4-8bb0-4f6e-8323-2583bb29682f","name":"Read Appointment Rules","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[224,496]},{"parameters":{"functionCode":"// Determine appointment type and duration based on rules\nconst isNewClient = $input.item.json.is_new_client || false;\nconst fundingType = ($input.item.json.funding_type || 'Private pay').toLowerCase();\nconst serviceType = ($input.item.json.service_type || '1:1 consultation').toLowerCase();\n\n// Get appointment rules from previous node\nconst rulesRaw = $('Read Appointment Rules').all();\nconst rules = rulesRaw.slice(1).map(item => ({\n  rule_id: item.json[0],\n  condition: item.json[1],\n  appointment_type: item.json[2],\n  duration_minutes: parseInt(item.json[3]),\n  notes: item.json[4],\n  active: item.json[5]\n})).filter(r => r.active === 'TRUE');\n\n// Matching logic\nlet appointmentType = 'Standard Consultation';\nlet duration = 30;\n\nif (isNewClient && (fundingType.includes('hcp') || fundingType.includes('dva'))) {\n  appointmentType = 'Initial Consultation';\n  duration = 45;\n} else if (serviceType.includes('balance') || serviceType.includes('class')) {\n  appointmentType = 'Better Balance Class';\n  duration = 60;\n} else if (serviceType.includes('aqua') || serviceType.includes('hydro')) {\n  appointmentType = 'Aqua Aerobics Class';\n  duration = 60;\n} else if (serviceType.includes('gym')) {\n  appointmentType = 'Gym Fit Class';\n  duration = 60;\n} else if (serviceType.includes('ep') || serviceType.includes('exercise phys')) {\n  appointmentType = 'EP Class';\n  duration = 60;\n} else if (serviceType.includes('screen') || serviceType.includes('assessment')) {\n  appointmentType = 'Reignite Screen';\n  duration = 15;\n}\n\nreturn {\n  ...$input.item.json,\n  appointment_type: appointmentType,\n  duration_minutes: duration\n};"},"id":"325d47b5-811a-440e-b4d2-1b94bc42ba55","name":"Determine Appointment Type","type":"n8n-nodes-base.function","typeVersion":1,"position":[448,496]},{"parameters":{"method":"POST","url":"https://api.au1.cliniko.com/v1/appointments","authentication":"predefinedCredentialType","nodeCredentialType":"clinikoApi","sendBody":true,"bodyParameters":{"parameters":[{"name":"patient_id","value":"={{ $json.patient_id }}"},{"name":"practitioner_id","value":"={{ $json.practitioner_id || 1 }}"},{"name":"appointment_type_id","value":"={{ $json.appointment_type_id || 10 }}"},{"name":"appointment_start","value":"={{ $json.appointment_start }}"},{"name":"appointment_end","value":"={{ $json.appointment_end }}"},{"name":"notes","value":"=Reason: {{ $json.reason || 'Not specified' }}. Funding: {{ $json.funding_type || 'Private pay' }}. Via AI receptionist (Call ID: {{ $json.call_id }})."}]},"options":{}},"id":"1c5baa1d-130b-4d03-966f-f757fc1ea1e7","name":"Create Appointment in Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[672,496],"notes":"Note: You'll need to map appointment_type names to IDs from Cliniko"},{"parameters":{"operation":"append","documentId":{"__rl":true,"mode":"list","value":""},"sheetName":{"__rl":true,"mode":"list","value":""}},"id":"92f1548f-d111-4bbb-ab06-39ecfdd7e8d2","name":"Log to Call_Log","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[896,496]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": true,\n  \"message\": \"Your appointment has been booked for {{ $json.appointment_start }}\",\n  \"appointment_id\": {{ $json.id }},\n  \"patient_id\": {{ $json.patient_id }}\n}","options":{}},"id":"1f984389-8877-4a84-b77d-9fdf54ea2d22","name":"Respond - Booking Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[1120,496]},{"parameters":{"conditions":{"options":{"caseSensitive":false},"conditions":[{"leftValue":"={{ $json.is_business_hours }}","rightValue":"true","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"e86d9599-4427-4faf-b4a2-e3b188055fbf","name":"Is Business Hours?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1792,880]},{"parameters":{"method":"POST","url":"https://zadarma.com/v1/request/callback/","authentication":"predefinedCredentialType","nodeCredentialType":"zadarmaApi","sendBody":true,"bodyParameters":{"parameters":[{"name":"from","value":"={{ $env.ZADARMA_NUMBER || '0288805883' }}"},{"name":"to","value":"0437160997"},{"name":"sip","value":"={{ $json.call_id }}"}]},"options":{}},"id":"50c15f91-04fe-4929-8c13-a73af6b98767","name":"Call Sara via Zadarma","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-1568,784]},{"parameters":{"sendTo":"sara@reignitehealth.com.au","subject":"=Escalated Call - {{ $json.caller_name }} - {{ $json.reason }}","message":"=Hi Sara,\n\nYou have an escalated call from the AI receptionist:\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nCaller:       {{ $json.caller_name }}\nPhone:        {{ $json.normalized_phone }}\nVillage:      {{ $json.village || 'Not specified' }}\nTime of Call: {{ $json.current_time }} (Sydney time)\n\nReason for Escalation:\n{{ $json.reason || 'Complaint or complex issue' }}\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\nCall Recording:\n{{ $json.recording_url || 'Recording not available' }}\n\nAction Required:\n{{ $json.is_business_hours ? 'We attempted to transfer the call to you.' : 'Please call ' + $json.caller_name + ' back at ' + $json.normalized_phone + ' during business hours.' }}\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nThis is an automated message from the Reignite Health AI Receptionist.","options":{"bccList":"","ccList":""}},"id":"f2aabcd3-3550-4968-94c3-33e66ff7f7ae","name":"Email Sara - Escalation","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[-1568,976],"webhookId":"257fdd90-bb85-4f9c-ada8-d421544974aa"},{"parameters":{"operation":"append","documentId":{"__rl":true,"mode":"list","value":""},"sheetName":{"__rl":true,"mode":"list","value":""}},"id":"3ccd832c-fb5b-4c0c-ba9c-74dd0cf30af1","name":"Log to Escalation_Log","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[-1344,880]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": true,\n  \"message\": \"{{ $json.is_business_hours ? 'Transferring you to Sara now. Please hold.' : 'Sara will call you back first thing in the morning. Thank you for your patience.' }}\",\n  \"escalated\": true\n}","options":{}},"id":"79e7943a-5993-4590-a0a8-c857aa253288","name":"Respond - Escalation","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[-1120,880]},{"parameters":{"sendTo":"={{ $json.recipient_email || 'sara@reignitehealth.com.au' }}","subject":"=Message from {{ $json.caller_name }} - {{ $json.village }}","message":"=Hi,\n\nYou have a new message from the AI receptionist:\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nCaller:       {{ $json.caller_name }}\nPhone:        {{ $json.normalized_phone }}\nVillage:      {{ $json.village || 'Not specified' }}\nTime of Call: {{ $json.current_time }} (Sydney time)\n\nMessage:\n\"{{ $json.message }}\"\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\nCall Recording:\n{{ $json.recording_url || 'Recording not available' }}\n\nAction Required:\nPlease call {{ $json.caller_name }} back at {{ $json.normalized_phone }}.\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nThis is an automated message from the Reignite Health AI Receptionist.","options":{}},"id":"27124f61-1a2c-4f07-9342-119089c3ec19","name":"Email - Take Message","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[-1792,1200],"webhookId":"020b32f0-885f-4300-82e1-b2419621a7ad"},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": true,\n  \"message\": \"Thank you, I've taken your message and {{ $json.recipient_name || 'Sara' }} will call you back.\"\n}","options":{}},"id":"2f8c7a2d-b547-48ba-a5c7-adb7751214a9","name":"Respond - Message Taken","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[-1568,1200]}],"connections":{"Webhook - RetellAI":{"main":[[{"node":"Normalize Phone Number","type":"main","index":0}]]},"Normalize Phone Number":{"main":[[{"node":"Read Business Hours","type":"main","index":0},{"node":"Read Public Holidays","type":"main","index":0}]]},"Read Business Hours":{"main":[[{"node":"Check Business Hours","type":"main","index":0}]]},"Read Public Holidays":{"main":[[{"node":"Check Business Hours","type":"main","index":0}]]},"Check Business Hours":{"main":[[{"node":"Route by Function","type":"main","index":0}]]},"Route by Function":{"main":[[{"node":"Lookup Client in Cliniko","type":"main","index":0}],[],[],[{"node":"Read Villages Config","type":"main","index":0}]]},"Read Villages Config":{"main":[[{"node":"Get Directions Logic","type":"main","index":0}]]},"Get Directions Logic":{"main":[[{"node":"Respond - Directions","type":"main","index":0}]]},"Read FAQs":{"main":[[{"node":"Search FAQ Logic","type":"main","index":0}]]},"Search FAQ Logic":{"main":[[{"node":"Respond - FAQ","type":"main","index":0}]]},"Lookup Client in Cliniko":{"main":[[{"node":"Client Exists?","type":"main","index":0}]]},"Client Exists?":{"main":[[{"node":"Extract Patient ID","type":"main","index":0}],[{"node":"Create Client in Cliniko","type":"main","index":0}]]},"Create Client in Cliniko":{"main":[[{"node":"Extract Patient ID","type":"main","index":0}]]},"Extract Patient ID":{"main":[[{"node":"Read Appointment Rules","type":"main","index":0}]]},"Read Appointment Rules":{"main":[[{"node":"Determine Appointment Type","type":"main","index":0}]]},"Determine Appointment Type":{"main":[[{"node":"Create Appointment in Cliniko","type":"main","index":0}]]},"Create Appointment in Cliniko":{"main":[[{"node":"Log to Call_Log","type":"main","index":0}]]},"Log to Call_Log":{"main":[[{"node":"Respond - Booking Success","type":"main","index":0}]]},"Is Business Hours?":{"main":[[{"node":"Call Sara via Zadarma","type":"main","index":0}],[{"node":"Email Sara - Escalation","type":"main","index":0}]]},"Call Sara via Zadarma":{"main":[[{"node":"Log to Escalation_Log","type":"main","index":0}]]},"Email Sara - Escalation":{"main":[[{"node":"Log to Escalation_Log","type":"main","index":0}]]},"Log to Escalation_Log":{"main":[[{"node":"Respond - Escalation","type":"main","index":0}]]},"Email - Take Message":{"main":[[{"node":"Respond - Message Taken","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"2354a879-bb6e-4a1d-b42f-8d276cbec82d","triggerCount":0,"shared":[{"updatedAt":"2025-10-23T10:09:12.134Z","createdAt":"2025-10-23T10:09:12.134Z","role":"workflow:owner","workflowId":"9BO1b05irJxtGeKU","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-10-12T09:27:43.000Z","createdAt":"2025-10-12T09:20:25.253Z","id":"fOohUODgyn5AWfxI","name":"Cliniko Auth Test WORKING","active":false,"isArchived":false,"nodes":[{"parameters":{"url":"https://api.au2.cliniko.com/v1/users","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"per_page","value":"1"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"},{"name":"Accept","value":"application/json"}]},"options":{"response":{"response":{"responseFormat":"json"}}}},"id":"6965c193-5a5c-4c3b-ae0b-9419e970cb8f","name":"HTTP Request","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[0,0],"credentials":{"httpBasicAuth":{"id":"G1OQc53TCkWx3drm","name":"Cliniko-API"}}}],"connections":{},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"b072a76f-67fb-44c0-8765-15391096f4c6","triggerCount":0,"shared":[{"updatedAt":"2025-10-23T10:09:16.328Z","createdAt":"2025-10-23T10:09:16.328Z","role":"workflow:owner","workflowId":"fOohUODgyn5AWfxI","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-10-23T21:10:02.946Z","createdAt":"2025-10-23T19:41:19.682Z","id":"1I2wZF5sByjKoAgt","name":"Cliniko to Google Sheets - FULL SYNC WORKING","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"hours"}]}},"id":"3fbceb06-1568-490e-ab2b-ceeaff1524fc","name":"Hourly Sync Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.1,"position":[-256,-160]},{"parameters":{"url":"https://api.au2.cliniko.com/v1/patients","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"per_page","value":"100"},{"name":"page","value":"1"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"},{"name":"Accept","value":"application/json"}]},"options":{"response":{"response":{"responseFormat":"json"}}}},"id":"18520ac6-a96b-4fe6-93b9-2f81c108d403","name":"Get Page 1 for Count","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-64,-160],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"jsCode":"// Calculate how many pages exist\nconst response = $input.item.json;\nconst totalEntries = response.total_entries || 0;\nconst perPage = 100;\nconst totalPages = Math.ceil(totalEntries / perPage);\n\nconsole.log(`Total patients in Cliniko: ${totalEntries}`);\nconsole.log(`Total pages to fetch: ${totalPages}`);\n\n// Create array of ALL page numbers (including page 1)\nconst allPages = [];\nfor (let i = 1; i <= totalPages; i++) {\n  allPages.push({ page: i });\n}\n\nreturn allPages.map(p => ({ json: p }));"},"id":"11ea6e7d-175e-4a93-a72a-132a632ff3da","name":"Generate Page Numbers","type":"n8n-nodes-base.code","typeVersion":2,"position":[144,-160]},{"parameters":{"url":"https://api.au2.cliniko.com/v1/patients","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"per_page","value":"100"},{"name":"page","value":"={{ $json.page }}"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"},{"name":"Accept","value":"application/json"}]},"options":{"batching":{"batch":{"batchSize":5}},"response":{"response":{"responseFormat":"json"}}}},"id":"dbb33925-5577-46de-bc65-298f56a51e4f","name":"Fetch All Pages","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[352,-160],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"aggregate":"aggregateAllItemData","destinationFieldName":"allPageData","options":{}},"id":"3d6201cc-1638-45d8-a9a7-2d50cb6d7381","name":"Aggregate All Pages","type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[544,-160]},{"parameters":{"jsCode":"// Now extract ALL patients from ALL pages\nconst allPageData = $json.allPageData;\n\nconsole.log(`Received ${allPageData.length} pages`);\n\nconst allPatients = [];\n\nfor (const pageData of allPageData) {\n  const patients = pageData.patients || [];\n  allPatients.push(...patients);\n  console.log(`Page had ${patients.length} patients`);\n}\n\nconsole.log(`========================================`);\nconsole.log(`TOTAL PATIENTS EXTRACTED: ${allPatients.length}`);\nconsole.log(`========================================`);\n\nconst rows = allPatients.map(patient => {\n  // Extract phone numbers from patient_phone_numbers array\n  let phoneNormalized = '';\n  let phoneMobileNormalized = '';\n  let phoneOriginal = '';\n  let mobileOriginal = '';\n  \n  if (patient.patient_phone_numbers && Array.isArray(patient.patient_phone_numbers)) {\n    // Find mobile phone\n    const mobilePhone = patient.patient_phone_numbers.find(p => \n      p.phone_type && p.phone_type.toLowerCase() === 'mobile'\n    );\n    \n    if (mobilePhone) {\n      phoneMobileNormalized = mobilePhone.normalized_number ? '+' + mobilePhone.normalized_number : '';\n      mobileOriginal = mobilePhone.number || '';\n    }\n    \n    // Find any other phone (Home, Work, etc)\n    const otherPhone = patient.patient_phone_numbers.find(p => \n      p.phone_type && p.phone_type.toLowerCase() !== 'mobile'\n    );\n    \n    if (otherPhone) {\n      phoneNormalized = otherPhone.normalized_number ? '+' + otherPhone.normalized_number : '';\n      phoneOriginal = otherPhone.number || '';\n    }\n    \n    // If no other phone, use mobile for both\n    if (!phoneNormalized && phoneMobileNormalized) {\n      phoneNormalized = phoneMobileNormalized;\n      phoneOriginal = mobileOriginal;\n    }\n  }\n  \n  // Extract village from address_3\n  const village = patient.address_3 || '';\n  \n  // Build full address\n  const addressParts = [\n    patient.address_1,\n    patient.address_2\n  ].filter(part => part && part.trim());\n  const address = addressParts.join(', ');\n  \n  return {\n    cliniko_id: patient.id || '',\n    first_name: patient.first_name || '',\n    last_name: patient.last_name || '',\n    preferred_name: patient.preferred_first_name || '',\n    phone_normalized: phoneNormalized,\n    phone_mobile_normalized: phoneMobileNormalized,\n    phone_original: phoneOriginal,\n    mobile_original: mobileOriginal,\n    email: patient.email || '',\n    village: village,\n    address: address,\n    city: patient.city || '',\n    state: patient.state || '',\n    postcode: patient.post_code || '',\n    dob: patient.date_of_birth || '',\n    archived: patient.archived_at ? 'Y' : 'N',\n    last_synced: new Date().toISOString()\n  };\n});\n\nconsole.log(`========================================`);\nconsole.log(`SUCCESSFULLY PROCESSED: ${rows.length} patients`);\nconsole.log(`========================================`);\n\nreturn rows.map(row => ({ json: row }));"},"id":"a83eed8f-8911-4669-af62-a03ed9ccb3ee","name":"Extract and Process All Patients","type":"n8n-nodes-base.code","typeVersion":2,"position":[752,-160]},{"parameters":{"operation":"clear","documentId":{"__rl":true,"value":"1XZlWRJRbmLKzIHNBzk8l6weW49ZH3lbrTgFWnNVPQ-k","mode":"id"},"sheetName":{"__rl":true,"value":"Patients","mode":"name"}},"id":"b3d46e83-5f18-4b6f-b0f5-e431b4d87f7f","name":"Clear Sheet","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[-64,48],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1XZlWRJRbmLKzIHNBzk8l6weW49ZH3lbrTgFWnNVPQ-k","mode":"id"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Patients","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1XZlWRJRbmLKzIHNBzk8l6weW49ZH3lbrTgFWnNVPQ-k/edit#gid=0"},"columns":{"mappingMode":"autoMapInputData"},"options":{}},"id":"c066f7a8-5dae-4564-bde1-36e39fcf6247","name":"Write to Sheet","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[944,-160],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}}],"connections":{"Hourly Sync Trigger":{"main":[[{"node":"Get Page 1 for Count","type":"main","index":0},{"node":"Clear Sheet","type":"main","index":0}]]},"Get Page 1 for Count":{"main":[[{"node":"Generate Page Numbers","type":"main","index":0}]]},"Generate Page Numbers":{"main":[[{"node":"Fetch All Pages","type":"main","index":0}]]},"Fetch All Pages":{"main":[[{"node":"Aggregate All Pages","type":"main","index":0}]]},"Aggregate All Pages":{"main":[[{"node":"Extract and Process All Patients","type":"main","index":0}]]},"Extract and Process All Patients":{"main":[[{"node":"Write to Sheet","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"1623d104-9c74-416f-8c47-c5e02efbb2ad","triggerCount":0,"shared":[{"updatedAt":"2025-10-23T19:41:19.682Z","createdAt":"2025-10-23T19:41:19.682Z","role":"workflow:owner","workflowId":"1I2wZF5sByjKoAgt","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-03T22:07:37.255Z","createdAt":"2025-10-23T21:20:08.125Z","id":"GzO1NeHxwIeI14sZ","name":"Cliniko to Postgres & Google Sheets - FULL SYNC WORKING","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"hours"}]}},"id":"0280b587-35dd-48e9-974b-5026186f9982","name":"Hourly Sync Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.1,"position":[-208,208]},{"parameters":{"operation":"executeQuery","query":"DROP TABLE IF EXISTS patients CASCADE;\n\nCREATE TABLE patients (\n  patient_id BIGINT PRIMARY KEY,\n  first_name VARCHAR(100),\n  last_name VARCHAR(100),\n  preferred_name VARCHAR(100),\n  email VARCHAR(255),\n  phone VARCHAR(50),\n  phone_normalized VARCHAR(20),\n  phone_mobile VARCHAR(50),\n  phone_mobile_normalized VARCHAR(20),\n  date_of_birth DATE,\n  address VARCHAR(500),\n  city VARCHAR(100),\n  state VARCHAR(50),\n  postcode VARCHAR(20),\n  village VARCHAR(100),\n  archived BOOLEAN DEFAULT FALSE,\n  last_synced TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nCREATE INDEX idx_phone_normalized ON patients(phone_normalized) WHERE phone_normalized IS NOT NULL;\nCREATE INDEX idx_phone_mobile_normalized ON patients(phone_mobile_normalized) WHERE phone_mobile_normalized IS NOT NULL;\nCREATE INDEX idx_name_village ON patients(first_name, last_name, village) WHERE archived = FALSE;\nCREATE INDEX idx_name_dob ON patients(first_name, last_name, date_of_birth) WHERE archived = FALSE;\nCREATE INDEX idx_archived ON patients(archived);","options":{}},"id":"3a079f0b-df61-470b-a7a0-47e80829d5ec","name":"Drop & Create Postgres Table","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[0,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"operation":"clear","documentId":{"__rl":true,"value":"1XZlWRJRbmLKzIHNBzk8l6weW49ZH3lbrTgFWnNVPQ-k","mode":"id"},"sheetName":{"__rl":true,"value":"Patients","mode":"name"}},"id":"d537c239-7a9c-4635-8343-3dc223afbe7e","name":"Clear Google Sheet","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[672,416],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"url":"https://api.au2.cliniko.com/v1/patients","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"per_page","value":"100"},{"name":"page","value":"1"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"},{"name":"Accept","value":"application/json"}]},"options":{"response":{"response":{"responseFormat":"json"}}}},"id":"25540cc3-f22b-4253-a38f-b900b7d9c4cd","name":"Get Page 1 for Count","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[208,208],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"jsCode":"// Calculate how many pages exist\nconst response = $input.item.json;\nconst totalEntries = response.total_entries || 0;\nconst perPage = 100;\nconst totalPages = Math.ceil(totalEntries / perPage);\n\nconsole.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');\nconsole.log('‚ïë  ü•º CLINIKO PATIENT SYNC STARTED   ‚ïë');\nconsole.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');\nconsole.log(`üìä Total patients: ${totalEntries}`);\nconsole.log(`üìÑ Total pages: ${totalPages}`);\n\n// Create array of ALL page numbers (including page 1)\nconst allPages = [];\nfor (let i = 1; i <= totalPages; i++) {\n  allPages.push({ page: i });\n}\n\nreturn allPages.map(p => ({ json: p }));"},"id":"c0381a49-0c52-4723-8554-44247b16745c","name":"Generate Page Numbers","type":"n8n-nodes-base.code","typeVersion":2,"position":[400,208]},{"parameters":{"url":"https://api.au2.cliniko.com/v1/patients","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"per_page","value":"100"},{"name":"page","value":"={{ $json.page }}"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"},{"name":"Accept","value":"application/json"}]},"options":{"batching":{"batch":{"batchSize":5}},"response":{"response":{"responseFormat":"json"}}}},"id":"b6375e79-4387-479c-b284-a2e16a89b865","name":"Fetch All Pages","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[608,208],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"aggregate":"aggregateAllItemData","destinationFieldName":"allPageData","options":{}},"id":"f78b471a-9532-4865-a604-45b56ee394a2","name":"Aggregate All Pages","type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[800,208]},{"parameters":{"jsCode":"// Extract ALL patients from ALL pages and prepare for BOTH Postgres and Google Sheets\nconst allPageData = $json.allPageData;\n\nconsole.log(`üì¶ Received ${allPageData.length} pages`);\n\nconst allPatients = [];\n\nfor (const pageData of allPageData) {\n  const patients = pageData.patients || [];\n  allPatients.push(...patients);\n}\n\nconsole.log(`‚úÖ TOTAL PATIENTS EXTRACTED: ${allPatients.length}`);\n\nconst rows = allPatients.map(patient => {\n  // Extract phone numbers from patient_phone_numbers array\n  let phoneNormalized = '';\n  let phoneMobileNormalized = '';\n  let phoneOriginal = '';\n  let mobileOriginal = '';\n  \n  if (patient.patient_phone_numbers && Array.isArray(patient.patient_phone_numbers)) {\n    // Find mobile phone\n    const mobilePhone = patient.patient_phone_numbers.find(p => \n      p.phone_type && p.phone_type.toLowerCase() === 'mobile'\n    );\n    \n    if (mobilePhone) {\n      phoneMobileNormalized = mobilePhone.normalized_number ? '+' + mobilePhone.normalized_number : '';\n      mobileOriginal = mobilePhone.number || '';\n    }\n    \n    // Find any other phone (Home, Work, etc)\n    const otherPhone = patient.patient_phone_numbers.find(p => \n      p.phone_type && p.phone_type.toLowerCase() !== 'mobile'\n    );\n    \n    if (otherPhone) {\n      phoneNormalized = otherPhone.normalized_number ? '+' + otherPhone.normalized_number : '';\n      phoneOriginal = otherPhone.number || '';\n    }\n    \n    // If no other phone, use mobile for both\n    if (!phoneNormalized && phoneMobileNormalized) {\n      phoneNormalized = phoneMobileNormalized;\n      phoneOriginal = mobileOriginal;\n    }\n  }\n  \n  // Extract village from address_3\n  const village = patient.address_3 || '';\n  \n  // Build full address\n  const addressParts = [\n    patient.address_1,\n    patient.address_2\n  ].filter(part => part && part.trim());\n  const address = addressParts.join(', ');\n  \n  // Return data compatible with BOTH Postgres and Google Sheets\n  return {\n    // Postgres fields\n    patient_id: patient.id || 0,\n    first_name: patient.first_name || '',\n    last_name: patient.last_name || '',\n    preferred_name: patient.preferred_first_name || '',\n    email: patient.email || '',\n    phone: phoneOriginal,\n    phone_normalized: phoneNormalized,\n    phone_mobile: mobileOriginal,\n    phone_mobile_normalized: phoneMobileNormalized,\n    date_of_birth: patient.date_of_birth || null,\n    address: address,\n    city: patient.city || '',\n    state: patient.state || '',\n    postcode: patient.post_code || '',\n    village: village,\n    archived: patient.archived_at ? true : false,\n    last_synced: new Date().toISOString(),\n    \n    // Additional Google Sheets fields\n    cliniko_id: patient.id || '',\n    phone_original: phoneOriginal,\n    mobile_original: mobileOriginal,\n    dob: patient.date_of_birth || '',\n    archived_display: patient.archived_at ? 'Y' : 'N'\n  };\n});\n\nconsole.log(`‚úÖ Successfully processed ${rows.length} patients`);\n\nreturn rows.map(row => ({ json: row }));"},"id":"e1f8383d-d9da-4243-ba28-c08e3f69998a","name":"Extract and Process All Patients","type":"n8n-nodes-base.code","typeVersion":2,"position":[1008,208]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO patients (\n  patient_id, first_name, last_name, preferred_name, email,\n  phone, phone_normalized, phone_mobile, phone_mobile_normalized,\n  date_of_birth, address, city, state, postcode,\n  village, archived, last_synced\n) VALUES (\n  {{ $json.patient_id }},\n  {{ $json.first_name ? `'${$json.first_name.replace(/'/g, \"''\")}'` : 'NULL' }},\n  {{ $json.last_name ? `'${$json.last_name.replace(/'/g, \"''\")}'` : 'NULL' }},\n  {{ $json.preferred_name ? `'${$json.preferred_name.replace(/'/g, \"''\")}'` : 'NULL' }},\n  {{ $json.email ? `'${$json.email.replace(/'/g, \"''\")}'` : 'NULL' }},\n  {{ $json.phone ? `'${$json.phone.replace(/'/g, \"''\")}'` : 'NULL' }},\n  {{ $json.phone_normalized ? `'${$json.phone_normalized}'` : 'NULL' }},\n  {{ $json.phone_mobile ? `'${$json.phone_mobile.replace(/'/g, \"''\")}'` : 'NULL' }},\n  {{ $json.phone_mobile_normalized ? `'${$json.phone_mobile_normalized}'` : 'NULL' }},\n  {{ $json.date_of_birth ? `'${$json.date_of_birth}'` : 'NULL' }},\n  {{ $json.address ? `'${$json.address.replace(/'/g, \"''\")}'` : 'NULL' }},\n  {{ $json.city ? `'${$json.city.replace(/'/g, \"''\")}'` : 'NULL' }},\n  {{ $json.state ? `'${$json.state.replace(/'/g, \"''\")}'` : 'NULL' }},\n  {{ $json.postcode ? `'${$json.postcode.replace(/'/g, \"''\")}'` : 'NULL' }},\n  {{ $json.village ? `'${$json.village.replace(/'/g, \"''\")}'` : 'NULL' }},\n  {{ $json.archived }},\n  '{{ $json.last_synced }}'\n)\nON CONFLICT (patient_id) DO UPDATE SET\n  first_name = EXCLUDED.first_name,\n  last_name = EXCLUDED.last_name,\n  preferred_name = EXCLUDED.preferred_name,\n  email = EXCLUDED.email,\n  phone = EXCLUDED.phone,\n  phone_normalized = EXCLUDED.phone_normalized,\n  phone_mobile = EXCLUDED.phone_mobile,\n  phone_mobile_normalized = EXCLUDED.phone_mobile_normalized,\n  date_of_birth = EXCLUDED.date_of_birth,\n  address = EXCLUDED.address,\n  city = EXCLUDED.city,\n  state = EXCLUDED.state,\n  postcode = EXCLUDED.postcode,\n  village = EXCLUDED.village,\n  archived = EXCLUDED.archived,\n  last_synced = EXCLUDED.last_synced;","options":{}},"id":"1db97fd2-c193-4605-8f57-f16ae3531802","name":"Upsert to Postgres","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1200,112],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1XZlWRJRbmLKzIHNBzk8l6weW49ZH3lbrTgFWnNVPQ-k","mode":"id"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Patients","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1XZlWRJRbmLKzIHNBzk8l6weW49ZH3lbrTgFWnNVPQ-k/edit#gid=0"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":[],"schema":[{"id":"patient_id","displayName":"patient_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"first_name","displayName":"first_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"last_name","displayName":"last_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"preferred_name","displayName":"preferred_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"email","displayName":"email","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"phone","displayName":"phone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"phone_normalized","displayName":"phone_normalized","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"phone_mobile","displayName":"phone_mobile","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"phone_mobile_normalized","displayName":"phone_mobile_normalized","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"date_of_birth","displayName":"date_of_birth","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"address","displayName":"address","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"city","displayName":"city","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"state","displayName":"state","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"postcode","displayName":"postcode","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"village","displayName":"village","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"archived","displayName":"archived","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"last_synced","displayName":"last_synced","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"cliniko_id","displayName":"cliniko_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"phone_original","displayName":"phone_original","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"mobile_original","displayName":"mobile_original","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"dob","displayName":"dob","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"archived_display","displayName":"archived_display","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"0cec33b0-83dd-4beb-8f03-ee2615f3c340","name":"Write to Google Sheets","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[1392,416],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT \n  COUNT(*) as total_patients,\n  COUNT(*) FILTER (WHERE phone_normalized IS NOT NULL OR phone_mobile_normalized IS NOT NULL) as with_phone,\n  COUNT(*) FILTER (WHERE village IS NOT NULL AND village != '') as with_village,\n  COUNT(*) FILTER (WHERE date_of_birth IS NOT NULL) as with_dob,\n  COUNT(*) FILTER (WHERE archived = TRUE) as archived_count,\n  COUNT(*) FILTER (WHERE archived = FALSE) as active_count,\n  MAX(last_synced) as last_sync_time\nFROM patients;","options":{}},"id":"3a52fb9f-93fd-44ad-a575-f899e5d628cf","name":"Get Sync Statistics","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1408,208],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"const stats = $json;\n\nconsole.log('\\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');\nconsole.log('‚ïë  ü•º CLINIKO SYNC COMPLETE            ‚ïë');\nconsole.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');\nconsole.log(`üìä Total patients: ${stats.total_patients}`);\nconsole.log(`üì± With phone: ${stats.with_phone}`);\nconsole.log(`üèòÔ∏è  With village: ${stats.with_village}`);\nconsole.log(`üéÇ With DOB: ${stats.with_dob}`);\nconsole.log(`‚úÖ Active: ${stats.active_count}`);\nconsole.log(`üì¶ Archived: ${stats.archived_count}`);\nconsole.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\\n');\n\nreturn {\n  json: {\n    success: true,\n    sync_completed_at: new Date().toISOString(),\n    destinations: ['Postgres', 'Google Sheets'],\n    ...stats\n  }\n};"},"id":"8b336ef2-b779-4d66-af43-4e2cfa6cbf44","name":"Log Sync Results","type":"n8n-nodes-base.code","typeVersion":2,"position":[1600,208]}],"connections":{"Hourly Sync Trigger":{"main":[[{"node":"Drop & Create Postgres Table","type":"main","index":0},{"node":"Get Page 1 for Count","type":"main","index":0}]]},"Get Page 1 for Count":{"main":[[{"node":"Generate Page Numbers","type":"main","index":0}]]},"Generate Page Numbers":{"main":[[{"node":"Fetch All Pages","type":"main","index":0}]]},"Fetch All Pages":{"main":[[{"node":"Aggregate All Pages","type":"main","index":0}]]},"Aggregate All Pages":{"main":[[{"node":"Extract and Process All Patients","type":"main","index":0}]]},"Extract and Process All Patients":{"main":[[{"node":"Upsert to Postgres","type":"main","index":0},{"node":"Write to Google Sheets","type":"main","index":0}]]},"Upsert to Postgres":{"main":[[{"node":"Get Sync Statistics","type":"main","index":0}]]},"Get Sync Statistics":{"main":[[{"node":"Log Sync Results","type":"main","index":0}]]},"Clear Google Sheet":{"main":[[]]}},"settings":{"executionOrder":"v1","saveDataSuccessExecution":"all","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":{"node:Hourly Sync Trigger":{"recurrenceRules":[]}},"meta":null,"pinData":{},"versionId":"cb4ec41e-3147-4454-bc22-593a38165ca2","triggerCount":1,"shared":[{"updatedAt":"2025-10-23T21:20:08.125Z","createdAt":"2025-10-23T21:20:08.125Z","role":"workflow:owner","workflowId":"GzO1NeHxwIeI14sZ","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-28T23:25:45.119Z","createdAt":"2025-10-25T20:04:25.986Z","id":"0adSj1D01yanH8i9","name":"RetellAI: Reschedule Appointment - WORKING (Sydney fix)","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/reschedule-appointment","responseMode":"responseNode","options":{}},"id":"255978d8-afec-4211-906b-928efbbc4d44","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-736,128],"webhookId":"reschedule-appointment-webhook"},{"parameters":{"jsCode":"\n// Universal Phone Normalization (Australian E.164) - v9.09\n\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n\n  // 1. Strip everything except digits and '+'\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n\n  // 2. Already in E.164 format\n  if (phone.startsWith('+')) {\n    return phone;\n  }\n\n  // 3. Handle 8-digit local numbers (Assume NSW '02')\n  if (phone.length === 8 && !phone.startsWith('+')) {\n    return '+612' + phone;\n  }\n\n  // 4. Handle standard 10-digit AU numbers (04... or 02...)\n  if (phone.length === 10 && phone.startsWith('0')) {\n    return '+61' + phone.substring(1);\n  }\n\n  // 5. Handle numbers starting with 61 (missing +)\n  if (phone.length === 11 && phone.startsWith('61')) {\n    return '+' + phone;\n  }\n\n  // 6. Assume Australian if 9 digits (missing leading 0)\n  if (phone.length === 9) {\n    return '+61' + phone;\n  }\n\n  // 7. Return cleaned version (best effort)\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n\nconst body = $json.body || $json;\nlet args = body?.args?.body?.args || body?.args || body;\n\n// Fallback to direct properties if nested structure not found\nif (!args.appointment_id) {\n  args = {\n    appointment_id: body.appointment_id || args.appointment_id,\n    new_starts_at: body.new_starts_at || args.new_starts_at,\n    new_date: body.new_date || args.new_date,\n    new_time: body.new_time || args.new_time,\n    call_id: body.call_id || args.call_id || 'unknown',\n    reason: body.reason || args.reason || 'Not specified'\n  };\n}\n\n// Support both new_starts_at (ISO 8601) and legacy new_date/new_time\nlet new_date = '';\nlet new_time = '';\n\nif (args.new_starts_at) {\n  // Parse ISO 8601 timestamp to extract date and time\n  // Example: \"2025-12-15T09:15:00.000Z\" or \"2025-12-15T09:15:00+11:00\"\n  const timestamp = String(args.new_starts_at).trim();\n  const dt = new Date(timestamp);\n  \n  if (!isNaN(dt.getTime())) {\n    // Convert to Sydney time for processing\n    const sydneyTime = dt.toLocaleString('en-AU', { \n      timeZone: 'Australia/Sydney',\n      year: 'numeric',\n      month: '2-digit',\n      day: '2-digit',\n      hour: '2-digit',\n      minute: '2-digit',\n      hour12: false\n    });\n    \n    // Parse format: \"DD/MM/YYYY, HH:MM\"\n    const parts = sydneyTime.split(', ');\n    if (parts.length === 2) {\n      const dateParts = parts[0].split('/');\n      new_date = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`; // YYYY-MM-DD\n      new_time = parts[1]; // HH:MM\n    }\n  }\n} else if (args.new_date && args.new_time) {\n  // Legacy format\n  new_date = String(args.new_date).trim();\n  new_time = String(args.new_time).trim();\n}\n\nreturn {\n  json: {\n    appointment_id: String(args.appointment_id || '').trim(),\n    new_date: new_date,\n    new_time: new_time,\n    new_starts_at: String(args.new_starts_at || '').trim(),\n    call_id: String(args.call_id || 'unknown').trim(),\n    reason: String(args.reason || 'Not specified').trim()\n  }\n};"},"id":"81aec037-4169-4bca-84ce-9a2273a7da70","name":"Extract Args","type":"n8n-nodes-base.code","typeVersion":2,"position":[-528,128]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-appointment-id","leftValue":"={{ $json.appointment_id }}","rightValue":"","operator":{"type":"string","operation":"notEmpty"}},{"id":"has-new-date","leftValue":"={{ $json.new_date }}","rightValue":"","operator":{"type":"string","operation":"notEmpty"}},{"id":"has-new-time","leftValue":"={{ $json.new_time }}","rightValue":"","operator":{"type":"string","operation":"notEmpty"}}],"combinator":"and"},"options":{}},"id":"cebff1a3-1880-4be4-813b-f8bb8be18ab7","name":"Validate Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[-320,128]},{"parameters":{"respondWith":"json","responseBody":"{\n  \"success\": false,\n  \"ok\": false,\n  \"error\": \"Missing required parameters\",\n  \"required\": [\"appointment_id\", \"new_starts_at OR (new_date AND new_time)\"],\n  \"message\": \"Please provide appointment_id and either new_starts_at (ISO 8601) OR both new_date (YYYY-MM-DD) and new_time (HH:MM)\"\n}","options":{"responseCode":400}},"id":"5407b2b4-2b6f-4741-afd5-809a9710a494","name":"Error: Missing Parameters","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[-96,288]},{"parameters":{"url":"=https://api.au2.cliniko.com/v1/individual_appointments/{{ $json.appointment_id }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"},{"name":"Accept","value":"application/json"}]},"options":{}},"id":"1e249575-c0a1-40e6-ba99-298ccd707fed","name":"Get Current Appointment","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-96,128],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"jsCode":"const appt = $input.item.json;\nconst args = $node['Extract Args'].json;\n\n// Original appointment duration (ms)\nconst oldStart = new Date(appt.starts_at);\nconst oldEnd = new Date(appt.ends_at);\nconst durationMs = oldEnd.getTime() - oldStart.getTime();\n\n// Parse YYYY-MM-DD\nfunction parseYMD(d){\n  const m = String(d||'').match(/^\\s*(\\d{4})-(\\d{2})-(\\d{2})\\s*$/);\n  if(!m) throw new Error('new_date must be YYYY-MM-DD');\n  return {y:+m[1], mo:+m[2], d:+m[3]};\n}\n\n// Parse time; supports \"HH:MM\", \"HH:MM:SS\", and with am/pm\nfunction parseTime(t){\n  let s = String(t||'').trim().toLowerCase().replace(/\\./g,'');\n  const ampm = (/(am|pm)$/.test(s)) ? s.slice(-2) : null;\n  if(ampm) s = s.replace(/\\s*(am|pm)$/,'');\n  const parts = s.split(':').map(n=>parseInt(n,10));\n  let h = parts[0]||0, mi = parts[1]||0, se = parts[2]||0;\n  if(ampm){\n    if(ampm==='pm' && h<12) h += 12;\n    if(ampm==='am' && h===12) h = 0;\n  }\n  if(h<0||h>23||mi<0||mi>59||se<0||se>59) throw new Error('new_time invalid');\n  return {h, mi, se};\n}\n\n// First Sunday (day-of-month) for a given month (1-12) in UTC math (month math only)\nfunction firstSundayDOM(year, month){\n  const dt = new Date(Date.UTC(year, month-1, 1));\n  const add = (7 - dt.getUTCDay()) % 7; // 0=Sun\n  return 1 + add;\n}\n\n// Sydney DST: starts 02:00 (standard) on 1st Sunday in Oct; ends 03:00 (daylight) on 1st Sunday in Apr\nfunction isSydneyDST(y, mo, d, h, mi){\n  if(mo>=11 || mo<=3) return true;        // Nov‚ÄìMar\n  if(mo>=5 && mo<=9) return false;        // May‚ÄìSep\n  if(mo===10){                             // October\n    const fs = firstSundayDOM(y,10);\n    if(d>fs) return true;\n    if(d<fs) return false;\n    return h>=2; // start at 02:00 standard time\n  }\n  if(mo===4){                              // April\n    const fs = firstSundayDOM(y,4);\n    if(d<fs) return true;\n    if(d>fs) return false;\n    return h<3; // end at 03:00 daylight time\n  }\n  return false;\n}\n\nconst {y, mo, d} = parseYMD(args.new_date);\nconst {h, mi, se} = parseTime(args.new_time);\nconst dst = isSydneyDST(y, mo, d, h, mi);\nconst offsetHours = dst ? 11 : 10; // Australia/Sydney\n\n// Compute UTC from Sydney wall time without relying on server/local TZ\nconst startUtcMs = Date.UTC(y, mo-1, d, h, mi, se) - offsetHours*3600*1000;\nconst endUtcMs   = startUtcMs + durationMs;\n\nconst starts_at = new Date(startUtcMs).toISOString();\nconst ends_at   = new Date(endUtcMs).toISOString();\n\n// Add reschedule note with clear Sydney timestamps\nconst oldNotes = (appt.notes || '').trim();\nconst resched = `[RESCHEDULED via AI] Reason: ${args.reason}. Previous: ${oldStart.toLocaleString('en-AU',{timeZone:'Australia/Sydney'})} ‚Üí New: ${new Date(startUtcMs).toLocaleString('en-AU',{timeZone:'Australia/Sydney'})}`;\nconst notes = oldNotes ? `${oldNotes}\\n\\n${resched}` : resched;\n\nreturn {\n  json: {\n    appointment_id: String(args.appointment_id),\n    call_id: String(args.call_id||'unknown'),\n    starts_at,\n    ends_at,\n    notes,\n    new_date_local: args.new_date,\n    new_time_local: args.new_time,\n    offset_hours: offsetHours,\n    dst_active: dst\n  }\n};"},"id":"02075bf0-a52b-46b7-a751-b6b90a2ab4cf","name":"Prepare Update","type":"n8n-nodes-base.code","typeVersion":2,"position":[128,128]},{"parameters":{"method":"PATCH","url":"=https://api.au2.cliniko.com/v1/individual_appointments/{{ $json.appointment_id }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"},{"name":"Accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ { starts_at: $json.starts_at, ends_at: $json.ends_at, notes: $json.notes } }}","options":{}},"id":"ae2f66ef-577c-4a11-a827-09e85ca4a608","name":"Update Appointment","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[352,128],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1kNx5YBa-YvPKOVutfQlXUNlU9KoB1T118g583i4gLNY","mode":"id"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Call Log"},"columns":{"mappingMode":"autoMapInputData"},"options":{}},"id":"b7b89f29-3c79-468a-9bfb-e785519f6c1a","name":"Log Success","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[560,128],"alwaysOutputData":true,"notesInFlow":false,"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const updated = $input.item.json; // body from Cliniko\nconst prep = $node['Prepare Update'].json;\n\n// Format confirmation in Sydney time\nconst newStart = new Date(updated.starts_at);\nconst newDate = newStart.toLocaleDateString('en-AU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Australia/Sydney' });\nconst newTime = newStart.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'Australia/Sydney' });\n\nreturn {\n  json: {\n    success: true,\n    ok: true,\n    message: 'Appointment rescheduled successfully',\n    appointment_id: updated.id,\n    starts_at: updated.starts_at,\n    ends_at: updated.ends_at,\n    new_date: newDate,\n    new_time: newTime,\n    call_id: prep.call_id\n  }\n};"},"id":"6ed26648-1aba-4ef7-bc4b-f66739ba9db3","name":"Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[784,128]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{"responseCode":200}},"id":"91fddec6-4d08-46c2-a278-481aefff4de4","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[1008,128]},{"parameters":{"respondWith":"json","responseBody":"={{ { success: false, ok: false, error: 'Failed to update appointment', message: $json.error || 'Unknown error occurred', call_id: $node['Extract Args'].json.call_id } }}","options":{"responseCode":500}},"id":"d014ee5a-03ea-44b7-baad-514cc69bfb7a","name":"Error: Update Failed","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[560,304]}],"connections":{"Webhook":{"main":[[{"node":"Extract Args","type":"main","index":0}]]},"Extract Args":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"Get Current Appointment","type":"main","index":0}],[{"node":"Error: Missing Parameters","type":"main","index":0}]]},"Get Current Appointment":{"main":[[{"node":"Prepare Update","type":"main","index":0}]]},"Prepare Update":{"main":[[{"node":"Update Appointment","type":"main","index":0}]]},"Update Appointment":{"main":[[{"node":"Log Success","type":"main","index":0}]]},"Log Success":{"main":[[{"node":"Format Response","type":"main","index":0}]]},"Format Response":{"main":[[{"node":"Respond","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","saveDataSuccessExecution":"all","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"30f7eff4-a642-4c1b-9c6c-723e3bcf3ab5","triggerCount":1,"shared":[{"updatedAt":"2025-10-25T20:04:25.986Z","createdAt":"2025-10-25T20:04:25.986Z","role":"workflow:owner","workflowId":"0adSj1D01yanH8i9","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-26T21:45:59.777Z","createdAt":"2025-10-26T19:46:55.714Z","id":"I7A0aOe1g9f7clFE","name":"RetellAI - Cancel Appointment v2.2 FIXED","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/cancel-appointment","responseMode":"responseNode","options":{}},"id":"951d826f-c7df-4d67-8d16-065af44de63c","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"cancel-appointment"},{"parameters":{"jsCode":"// STANDARD EXTRACTION PATTERN - RetellAI Compatible\n// v2.2 - Single appointment cancellation only, bulk requests rejected\n\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\nconst appointment_id = args.appointment_id || '';\nconst appointment_ids = args.appointment_ids || [];\nconst reason = args.reason || 'Cancelled via AI Voice Receptionist';\nconst call_id = call.call_id || args.call_id || '';\nconst patient_name = args.patient_name || 'Unknown';\nconst patient_phone = args.patient_phone || args.phone || '';\n\n// Check if this is a bulk cancellation request (more than 1 appointment)\nconst isBulkRequest = appointment_ids.length > 1;\nconst totalToCancel = isBulkRequest ? appointment_ids.length : 1;\n\nreturn [{ json: { \n  appointment_id, \n  appointment_ids,\n  reason, \n  call_id,\n  patient_name,\n  patient_phone,\n  is_bulk_request: isBulkRequest,\n  total_to_cancel: totalToCancel,\n  _is_valid: !!appointment_id && !isBulkRequest\n} }];"},"id":"extract-params-001","name":"Extract Parameters","type":"n8n-nodes-base.code","typeVersion":2,"position":[220,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid-check","leftValue":"={{ $json._is_valid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"if-valid-001","name":"Check Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[440,0]},{"parameters":{"jsCode":"// Handle invalid requests - either missing ID or bulk request\nconst data = $json;\n\nif (data.is_bulk_request) {\n  return [{ json: { \n    success: false, \n    error: 'BULK_CANCELLATION_NOT_ALLOWED',\n    message: `I can only cancel one appointment at a time. You've requested to cancel ${data.total_to_cancel} appointments. Please call back or ask to speak with Sara to cancel multiple appointments at once.`,\n    hint: 'For bulk cancellations, please contact hello@reignitehealth.com.au or request a callback from Sara.',\n    appointments_requested: data.total_to_cancel,\n    call_id: data.call_id,\n    timestamp: new Date().toISOString() \n  } }];\n}\n\n// Missing appointment_id\nreturn [{ json: { \n  success: false, \n  error: 'MISSING_APPOINTMENT_ID', \n  message: 'appointment_id is required. Please use tool-list-appointments first to get the appointment_id, then call this tool with that ID.',\n  hint: 'The caller should first list their appointments, then specify which one to cancel.',\n  call_id: data.call_id,\n  timestamp: new Date().toISOString() \n} }];"},"id":"validation-error-001","name":"Handle Invalid Request","type":"n8n-nodes-base.code","typeVersion":2,"position":[660,200]},{"parameters":{"method":"DELETE","url":"=https://api.au2.cliniko.com/v1/individual_appointments/{{ $json.appointment_id }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Accept","value":"application/json"},{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"}]},"options":{}},"id":"d962bc1b-d5b7-4592-8c9a-0d7d95c183aa","name":"Cliniko API - Cancel","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[660,-200],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"// Get extracted params\nconst extractedParams = $('Extract Parameters').first().json;\nconst appointmentId = extractedParams.appointment_id || '';\nconst reason = extractedParams.reason || 'Not specified';\nconst callId = extractedParams.call_id || '';\n\nconst response = $input.first().json;\n\n// Check for API error - Cliniko DELETE returns empty on success (204)\n// If there's an error object, it failed\nif (response.error || response.message) {\n  return [{ json: { \n    success: false, \n    appointment_id: appointmentId, \n    message: 'Failed to cancel appointment in Cliniko', \n    error: response.error || response.message || 'Unknown error from Cliniko API',\n    call_id: callId,\n    timestamp: new Date().toISOString() \n  } }];\n}\n\n// Success - Cliniko DELETE returns the cancelled appointment details\nif (response.id) {\n  const startDate = new Date(response.starts_at);\n  const dateStr = startDate.toLocaleDateString('en-AU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });\n  const timeStr = startDate.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: true });\n\n  return [{ json: { \n    success: true, \n    appointment_id: response.id, \n    message: 'Appointment successfully cancelled', \n    cancelled_appointment: { \n      id: response.id, \n      was_scheduled_for: dateStr, \n      was_scheduled_time: timeStr, \n      appointment_type: response.appointment_type?.name || 'Appointment', \n      practitioner: response.practitioner?.name || 'Staff', \n      cancellation_reason: reason, \n      cancelled_at: response.cancelled_at || new Date().toISOString() \n    },\n    call_id: callId,\n    timestamp: new Date().toISOString() \n  } }];\n}\n\n// Empty response - assume success (204 No Content)\nreturn [{ json: { \n  success: true, \n  appointment_id: appointmentId, \n  message: 'Appointment cancellation processed', \n  call_id: callId,\n  timestamp: new Date().toISOString() \n} }];"},"id":"e41a8fc8-42cc-4bbf-b2ec-efb07941e4a4","name":"Transform for RetellAI","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,-200]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"460ffd23-c7c2-4f59-8671-81904d19ded9","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1100,0]}],"connections":{"Webhook":{"main":[[{"node":"Extract Parameters","type":"main","index":0}]]},"Extract Parameters":{"main":[[{"node":"Check Valid","type":"main","index":0}]]},"Check Valid":{"main":[[{"node":"Cliniko API - Cancel","type":"main","index":0}],[{"node":"Handle Invalid Request","type":"main","index":0}]]},"Handle Invalid Request":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Cliniko API - Cancel":{"main":[[{"node":"Transform for RetellAI","type":"main","index":0}]]},"Transform for RetellAI":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","saveDataSuccessExecution":"all"},"staticData":null,"meta":null,"pinData":{},"versionId":"5ff3188b-1af2-4d03-90ce-43b680d99f9f","triggerCount":1,"shared":[{"updatedAt":"2025-10-26T19:46:55.714Z","createdAt":"2025-10-26T19:46:55.714Z","role":"workflow:owner","workflowId":"I7A0aOe1g9f7clFE","projectId":"ePBcCsWsgvLDebw1"}],"tags":[{"updatedAt":"2025-10-25T20:46:30.687Z","createdAt":"2025-10-25T20:46:30.687Z","id":"f4oitz85OWylN1Dp","name":"RetellAI"},{"updatedAt":"2025-10-25T20:46:30.688Z","createdAt":"2025-10-25T20:46:30.688Z","id":"xOR2iXEsXC2hMCtx","name":"Webhooks"},{"updatedAt":"2025-10-03T03:47:29.353Z","createdAt":"2025-10-03T03:47:29.353Z","id":"dbO1yennvLLTWb9D","name":"Reignite"}]},{"updatedAt":"2025-11-06T02:42:54.124Z","createdAt":"2025-10-26T19:50:56.033Z","id":"Bovj0EHoCxL75bB2","name":"RetellAI - Search FAQ","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/search-faq","responseMode":"responseNode","options":{}},"id":"c36a9875-f783-4cde-bf7d-bc1b3f3397a5","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[576,-96],"webhookId":"search-faq"},{"parameters":{"documentId":{"__rl":true,"value":"1njShYEqUpYwlcEYmjaZRrF04qKTwGBz_yvYfMGF2Zqc","mode":"id"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1njShYEqUpYwlcEYmjaZRrF04qKTwGBz_yvYfMGF2Zqc/edit#gid=0"},"options":{}},"id":"851be1d0-6d80-40c8-9c27-316456cd2fde","name":"Google Sheets - Read FAQs","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[800,-96],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"jsCode":"// Extract search query from request\nconst searchQuery = ($input.item.json.body?.query || '').toLowerCase().trim();\n\n// Get all FAQ rows from Google Sheets\nconst faqRows = $input.all();\n\nif (!searchQuery || searchQuery.length < 3) {\n  return [\n    {\n      json: {\n        found: false,\n        query: searchQuery,\n        message: \"Search query too short. Please provide at least 3 characters.\",\n        timestamp: new Date().toISOString()\n      }\n    }\n  ];\n}\n\nif (faqRows.length === 0) {\n  return [\n    {\n      json: {\n        found: false,\n        query: searchQuery,\n        message: \"No FAQs found in database\",\n        timestamp: new Date().toISOString()\n      }\n    }\n  ];\n}\n\n// Search through FAQs\nconst matches = [];\n\nfor (const row of faqRows) {\n  const question = (row.json.Question || '').toLowerCase();\n  const answer = row.json.Answer || '';\n  const category = row.json.Category || 'General';\n  const keywords = (row.json.Keywords || '').toLowerCase();\n  \n  // Skip header row or empty rows\n  if (!question || question === 'question') continue;\n  \n  // Calculate relevance score\n  let score = 0;\n  \n  // Exact match in question (highest priority)\n  if (question.includes(searchQuery)) {\n    score += 100;\n  }\n  \n  // Match in keywords\n  if (keywords && keywords.includes(searchQuery)) {\n    score += 50;\n  }\n  \n  // Partial word matches\n  const searchWords = searchQuery.split(' ');\n  for (const word of searchWords) {\n    if (word.length > 2) {\n      if (question.includes(word)) score += 10;\n      if (keywords && keywords.includes(word)) score += 5;\n    }\n  }\n  \n  if (score > 0) {\n    matches.push({\n      question: row.json.Question,\n      answer: answer,\n      category: category,\n      keywords: row.json.Keywords || '',\n      score: score\n    });\n  }\n}\n\n// Sort by score (highest first) and take top 3\nmatches.sort((a, b) => b.score - a.score);\nconst topMatches = matches.slice(0, 3);\n\nif (topMatches.length === 0) {\n  return [\n    {\n      json: {\n        found: false,\n        query: searchQuery,\n        message: \"No matching FAQs found\",\n        suggestion: \"Try rephrasing your question or contact reception\",\n        timestamp: new Date().toISOString()\n      }\n    }\n  ];\n}\n\nreturn [\n  {\n    json: {\n      found: true,\n      query: searchQuery,\n      match_count: topMatches.length,\n      best_match: topMatches[0],\n      all_matches: topMatches,\n      message: `Found ${topMatches.length} relevant answer${topMatches.length > 1 ? 's' : ''}`,\n      timestamp: new Date().toISOString()\n    }\n  }\n];"},"id":"e7073ca4-1e6b-40bd-a5b5-641c1dd97d7a","name":"Search & Rank FAQs","type":"n8n-nodes-base.code","typeVersion":2,"position":[1024,-96]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"48c85cfb-7d55-4b4c-bda3-21f0d6cddebe","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1248,-96]}],"connections":{"Webhook":{"main":[[{"node":"Google Sheets - Read FAQs","type":"main","index":0}]]},"Google Sheets - Read FAQs":{"main":[[{"node":"Search & Rank FAQs","type":"main","index":0}]]},"Search & Rank FAQs":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","saveDataSuccessExecution":"all","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"9234f501-98b8-4edd-addb-bc5796bba1eb","triggerCount":1,"shared":[{"updatedAt":"2025-10-26T19:50:56.033Z","createdAt":"2025-10-26T19:50:56.033Z","role":"workflow:owner","workflowId":"Bovj0EHoCxL75bB2","projectId":"ePBcCsWsgvLDebw1"}],"tags":[{"updatedAt":"2025-10-03T03:47:29.353Z","createdAt":"2025-10-03T03:47:29.353Z","id":"dbO1yennvLLTWb9D","name":"Reignite"},{"updatedAt":"2025-10-25T20:46:30.687Z","createdAt":"2025-10-25T20:46:30.687Z","id":"f4oitz85OWylN1Dp","name":"RetellAI"},{"updatedAt":"2025-10-25T20:46:30.688Z","createdAt":"2025-10-25T20:46:30.688Z","id":"xOR2iXEsXC2hMCtx","name":"Webhooks"}]},{"updatedAt":"2025-11-08T01:24:04.965Z","createdAt":"2025-10-26T20:11:02.418Z","id":"PQkPBsvDMuAXT4kZ","name":"RetellAI - Get Operating Hours","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-operating-hours","responseMode":"responseNode","options":{}},"id":"242880a1-041f-42eb-b7fc-cfe23234d98e","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"get-operating-hours"},{"parameters":{"documentId":{"__rl":true,"value":"YOUR_GOOGLE_SHEET_ID","mode":"id"},"sheetName":{"__rl":true,"value":"Operating_Hours","mode":"name"},"options":{}},"id":"82f56146-5335-4148-9f8f-2bf42a1ea4dd","name":"Google Sheets - Read Hours","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[224,0],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"jsCode":"// Extract village from request (optional)\nconst requestedVillage = ($input.item.json.body?.village || '').toLowerCase().trim();\n\n// Get all hours from Google Sheets\nconst hoursRows = $input.all();\n\nif (hoursRows.length === 0) {\n  return [\n    {\n      json: {\n        success: false,\n        message: \"No operating hours data found\",\n        timestamp: new Date().toISOString()\n      }\n    }\n  ];\n}\n\n// Process rows into structured data\nconst villageHours = [];\n\nfor (const row of hoursRows) {\n  const village = row.json.Village || '';\n  const day = row.json.Day || '';\n  const opens = row.json.Opens || '';\n  const closes = row.json.Closes || '';\n  const notes = row.json.Notes || '';\n  \n  // Skip header row or empty rows\n  if (!village || village.toLowerCase() === 'village' || !day) continue;\n  \n  // If village specified, filter to that village\n  if (requestedVillage && !village.toLowerCase().includes(requestedVillage)) {\n    continue;\n  }\n  \n  villageHours.push({\n    village: village,\n    day: day,\n    opens: opens,\n    closes: closes,\n    hours: opens && closes ? `${opens} - ${closes}` : 'Closed',\n    is_open: !!(opens && closes),\n    notes: notes\n  });\n}\n\nif (villageHours.length === 0) {\n  return [\n    {\n      json: {\n        success: false,\n        message: requestedVillage \n          ? `No operating hours found for ${requestedVillage}` \n          : \"No operating hours data available\",\n        timestamp: new Date().toISOString()\n      }\n    }\n  ];\n}\n\n// Group by village\nconst byVillage = {};\nfor (const hour of villageHours) {\n  if (!byVillage[hour.village]) {\n    byVillage[hour.village] = [];\n  }\n  byVillage[hour.village].push({\n    day: hour.day,\n    opens: hour.opens,\n    closes: hour.closes,\n    hours: hour.hours,\n    is_open: hour.is_open,\n    notes: hour.notes\n  });\n}\n\n// Format response\nconst villages = Object.keys(byVillage).map(villageName => ({\n  village: villageName,\n  schedule: byVillage[villageName]\n}));\n\nreturn [\n  {\n    json: {\n      success: true,\n      village_count: villages.length,\n      villages: villages,\n      message: requestedVillage \n        ? `Operating hours for ${requestedVillage}` \n        : `Operating hours for all ${villages.length} villages`,\n      timestamp: new Date().toISOString()\n    }\n  }\n];"},"id":"109841f7-d224-4f5b-989c-195929395d5c","name":"Format Operating Hours","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"60600361-5bf5-40c1-8001-8de5f92fd317","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,0]}],"connections":{"Webhook":{"main":[[{"node":"Google Sheets - Read Hours","type":"main","index":0}]]},"Google Sheets - Read Hours":{"main":[[{"node":"Format Operating Hours","type":"main","index":0}]]},"Format Operating Hours":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"15f30ca2-b21b-4944-b87b-232bf53caf17","triggerCount":1,"shared":[{"updatedAt":"2025-10-26T20:11:02.418Z","createdAt":"2025-10-26T20:11:02.418Z","role":"workflow:owner","workflowId":"PQkPBsvDMuAXT4kZ","projectId":"ePBcCsWsgvLDebw1"}],"tags":[{"updatedAt":"2025-10-03T03:47:29.353Z","createdAt":"2025-10-03T03:47:29.353Z","id":"dbO1yennvLLTWb9D","name":"Reignite"},{"updatedAt":"2025-10-25T20:46:30.687Z","createdAt":"2025-10-25T20:46:30.687Z","id":"f4oitz85OWylN1Dp","name":"RetellAI"},{"updatedAt":"2025-10-25T20:46:30.688Z","createdAt":"2025-10-25T20:46:30.688Z","id":"xOR2iXEsXC2hMCtx","name":"Webhooks"}]},{"updatedAt":"2025-11-13T18:35:47.441Z","createdAt":"2025-10-26T20:13:09.492Z","id":"fGJZbG43h1hldptf","name":"RetellAI - Get Directions & Class Contacts WORKING","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-directions","responseMode":"responseNode","options":{}},"id":"f05fb539-64a3-41ad-ab6b-93f3e731bdb4","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[112,160],"webhookId":"get-directions"},{"parameters":{"documentId":{"__rl":true,"value":"13EaXjEQKRye-hWmtHAMnDmKJgwp34O2iGk-ldwqm9uI","mode":"id"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/13EaXjEQKRye-hWmtHAMnDmKJgwp34O2iGk-ldwqm9uI/edit#gid=0"},"options":{}},"id":"15a9cc7d-a938-40c8-bef3-7c969d85a766","name":"Google Sheets - Read Villages","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[336,160],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"jsCode":"// Code node v2 ‚Äì Run once for all items\n// Inputs: 0 = rows from Google Sheets; Webhook data accessed via $('Webhook')\n\nconst req = $('Webhook').first();\nconst body = (req?.json?.body) ?? (req?.json) ?? {};\n\nconst norm = (s) => String(s ?? '').trim().toLowerCase();\nconst requestedVillage = norm(body.village || body.village_name || body.site || '');\nconst classRaw = norm(body.class_type || body.class || body.program || '');\n\nconst aliasMap = [\n  { a: ['consult room','consult','clinic','physio','consultation'], k: 'consult_room' },\n  { a: ['better balance','balance','bb'], k: 'better_balance' },\n  { a: ['aqua','pool','hydro'], k: 'aqua' },\n  { a: ['gym fit','gymfit','gym'], k: 'gymfit' },\n  { a: ['ep','exercise phys','exercise physiology','group class','class','ep class'], k: 'ep_class' }\n];\nfunction mapClass(s){\n  if(!s) return 'consult_room';\n  for(const {a,k} of aliasMap){ if(a.some(v => s.includes(v))) return k; }\n  return 'consult_room';\n}\nconst classType = mapClass(classRaw);\n\n// All rows from Input 0 (Google Sheets)\nconst rows = $input.all().map(it => it.json);\nif(!rows.length){\n  return [{ json: { found: false, message: 'No village data found', timestamp: new Date().toISOString() } }];\n}\n\nfunction pick(row, candidates){\n  const keys = Object.keys(row || {});\n  for(const cand of candidates){\n    const k = keys.find(K => K.toLowerCase() === String(cand).toLowerCase());\n    if(k) return String(row[k] ?? '').trim();\n  }\n  return '';\n}\n\nfunction classAddress(row, cls){\n  const cols = {\n    consult_room: ['consult_room_location','Consult_Room_Location','Consultation_Room','Consult_Room','Consult location','Consult_Address','Clinic_Address','Address'],\n    better_balance: ['better_balance_location','Better_Balance_Location','Better_Balance','Balance','BB','Better_Balance_Address'],\n    aqua: ['aqua_location','Aqua_Location','Aqua','Pool','Aqua_Address'],\n    gymfit: ['gymfit_location','GymFit_Location','GymFit','Gym_Fit','Gym','Gymfit_Address'],\n    ep_class: ['ep_class_location','EP_Class_Location','EP_Class','Exercise_Phys','Exercise_Physiology','EP_Address']\n  };\n  return pick(row, cols[cls] || []);\n}\n\nconst activeYes = (r) => {\n  const a = pick(r, ['active','Active']);\n  const v = norm(a);\n  return v === '' || v === 'y' || v === 'yes' || v === 'true';\n};\nconst filteredRows = rows.filter(activeYes);\n\nif(!requestedVillage){\n  // Return all villages WITH class locations\n  const villages = filteredRows\n    .map(r => ({\n      village: pick(r, ['Village','Village_Name','village','village_name','Name']),\n      contact: pick(r, ['wellness_coordinator_email','Contact','Coordinator','Contact_Name','Manager_Name','Email','contact_email']),\n      notes: pick(r, ['notes','Notes']),\n      classes: {\n        consult_room: classAddress(r,'consult_room') || '',\n        better_balance: classAddress(r,'better_balance') || '',\n        aqua: classAddress(r,'aqua') || '',\n        gymfit: classAddress(r,'gymfit') || '',\n        ep_class: classAddress(r,'ep_class') || ''\n      }\n    }))\n    .filter(v => v.village);\n  return [{ json: { found: true, village_count: villages.length, villages, timestamp: new Date().toISOString() } }];\n}\n\nfunction normalizeName(s){ return norm(s).replace(/\\s+/g,' ').replace(/[^\\p{L}\\p{N}\\s]/gu,''); }\nconst target = normalizeName(requestedVillage);\nlet match = null;\nfor(const r of filteredRows){\n  const n = normalizeName(pick(r, ['Village','Village_Name','village','village_name','Name']));\n  if(!n) continue;\n  if(n.includes(target) || target.includes(n)){ match = r; break; }\n}\nif(!match){\n  const toks = target.split(' ').filter(Boolean);\n  for(const r of filteredRows){\n    const n = normalizeName(pick(r, ['Village','Village_Name','village','village_name','Name']));\n    if(toks.every(t => n.includes(t))){ match = r; break; }\n  }\n}\nif(!match){\n  return [{ json: { found: false, requested_village: body.village || body.village_name || '', message: `No village matching '${body.village || body.village_name || ''}'`, timestamp: new Date().toISOString() } }];\n}\n\nconst villageName = pick(match, ['Village','Village_Name','village','village_name','Name']);\nconst suburb = pick(match, ['Suburb','Town','City','suburb']);\nconst baseAddress = pick(match, ['Address','Clinic_Address','address']);\nconst addrForClass = classAddress(match, classType) || baseAddress;\n\nconst contact = pick(match, ['wellness_coordinator_email','Contact_Name','Coordinator','Contact','Manager_Name','contact_name','Email','contact_email']);\nconst directions = pick(match, ['Directions','directions']);\nconst parking = pick(match, ['Parking_Info','Parking','parking']);\nconst gmaps = pick(match, ['Google_Maps_Link','Maps','google_maps']);\n\nconst result = {\n  found: !!addrForClass,\n  village: villageName,\n  class_type: classType,\n  address_for_class: addrForClass || '',\n  suburb: suburb || '',\n  contact: contact || '',\n  ...(directions && { directions }),\n  ...(parking && { parking }),\n  ...(gmaps && { google_maps: gmaps }),\n  classes: {\n    consult_room: classAddress(match,'consult_room') || '',\n    better_balance: classAddress(match,'better_balance') || '',\n    aqua: classAddress(match,'aqua') || '',\n    gymfit: classAddress(match,'gymfit') || '',\n    ep_class: classAddress(match,'ep_class') || ''\n  },\n  timestamp: new Date().toISOString()\n};\n\nreturn [{ json: result }];"},"id":"904914ef-8581-4b1e-a462-c82d9a5dde98","name":"Find Village / Class & Contacts","type":"n8n-nodes-base.code","typeVersion":2,"position":[720,304]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"3c5d0322-2d5f-43e7-9c0e-71d4056e07a8","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1008,304]}],"connections":{"Google Sheets - Read Villages":{"main":[[{"node":"Find Village / Class & Contacts","type":"main","index":0}]]},"Find Village / Class & Contacts":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Google Sheets - Read Villages","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"b8c430a4-579a-4687-bfcf-ba1616725b09","triggerCount":1,"shared":[{"updatedAt":"2025-10-26T20:13:09.492Z","createdAt":"2025-10-26T20:13:09.492Z","role":"workflow:owner","workflowId":"fGJZbG43h1hldptf","projectId":"ePBcCsWsgvLDebw1"}],"tags":[{"updatedAt":"2025-10-25T20:46:30.688Z","createdAt":"2025-10-25T20:46:30.688Z","id":"xOR2iXEsXC2hMCtx","name":"Webhooks"},{"updatedAt":"2025-10-25T20:46:30.687Z","createdAt":"2025-10-25T20:46:30.687Z","id":"f4oitz85OWylN1Dp","name":"RetellAI"},{"updatedAt":"2025-10-03T03:47:29.353Z","createdAt":"2025-10-03T03:47:29.353Z","id":"dbO1yennvLLTWb9D","name":"Reignite"}]},{"updatedAt":"2025-12-02T22:27:00.139Z","createdAt":"2025-10-26T20:18:33.588Z","id":"qbIUIvXJkI30vRrv","name":"RetellAI - Email Sara Transfer","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/email-sara-transfer","responseMode":"responseNode","options":{}},"id":"362ee5d1-5d14-4549-b1fc-33dbda10ccbf","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-912,496],"webhookId":"1565fad1-c77c-46bf-b164-2f40bf462708"},{"parameters":{"operation":"executeQuery","query":"-- Ensure helper exists (no-op if it already does)\nCREATE TABLE IF NOT EXISTS retell_calls (\n  call_id        text PRIMARY KEY,\n  phone_number   text,\n  no_phone       boolean DEFAULT false,\n  from_number    text,\n  created_at     timestamptz DEFAULT now(),\n  updated_at     timestamptz DEFAULT now()\n);\n\nWITH t AS (\n  -- The transfer we're emailing about\n  SELECT *\n  FROM retell_transfers\n  WHERE transfer_id = '{{ $json.body?.args?.transfer_id || $json.full_body?.args?.transfer_id || $json.transfer_id }}'\n  LIMIT 1\n),\n-- Normalize the transfer callback number to AU E.164\nnorm_t AS (\n  SELECT\n    t.*,\n    t.phone_number AS t_phone_raw,\n    CASE\n      WHEN t.phone_number IS NULL OR t.phone_number = '' THEN NULL\n      WHEN t.phone_number ~ '^\\+'                    THEN t.phone_number\n      WHEN t.phone_number ~ '^0[0-9]+$'             THEN '+61' || substring(t.phone_number FROM 2)\n      ELSE '+61' || t.phone_number\n    END AS t_phone_e164,\n    -- Keep patient_id as text and also as bigint when it‚Äôs numeric\n    t.patient_id::text         AS t_pid_text,\n    CASE\n      WHEN t.patient_id ~ '^[0-9]+$' THEN (t.patient_id)::bigint\n      ELSE NULL\n    END                      AS t_pid_bigint\n  FROM t\n),\n-- Safely fetch the patient using a bigint match when possible\np AS (\n  SELECT p.*\n  FROM patients p\n  WHERE p.patient_id = COALESCE( (SELECT t_pid_bigint FROM norm_t), -1 )\n  LIMIT 1\n),\n-- Normalize patient phone/mobile to AU E.164\nnorm_p AS (\n  SELECT\n    p.*,\n    CASE\n      WHEN p.phone IS NULL OR p.phone = '' THEN NULL\n      WHEN p.phone ~ '^\\+'                 THEN p.phone\n      WHEN p.phone ~ '^0[0-9]+$'           THEN '+61' || substring(p.phone FROM 2)\n      ELSE '+61' || p.phone\n    END AS p_phone_e164,\n    CASE\n      WHEN p.phone_mobile IS NULL OR p.phone_mobile = '' THEN NULL\n      WHEN p.phone_mobile ~ '^\\+'                        THEN p.phone_mobile\n      WHEN p.phone_mobile ~ '^0[0-9]+$'                  THEN '+61' || substring(p.phone_mobile FROM 2)\n      ELSE '+61' || p.phone_mobile\n    END AS p_mobile_e164\n  FROM p\n),\n-- Join retell_calls by:\n--   1) exact call_id\n--   2) the transfer's callback number (raw/E.164)\n--   3) the patient's phone or mobile (E.164)\ncandidates AS (\n  SELECT\n    nt.*,\n    rc.phone_number  AS stored_phone_number,\n    rc.no_phone      AS stored_no_phone,\n    rc.from_number   AS carrier_from_number,\n    rc.updated_at    AS rc_updated_at,\n    -- Priority: prefer rows that actually have a carrier from_number,\n    -- then those whose call_id is not a placeholder, then newest.\n    (CASE WHEN rc.from_number IS NOT NULL THEN 1 ELSE 0 END)              AS pri_has_from,\n    (CASE WHEN rc.call_id NOT IN ('unknown','current') THEN 1 ELSE 0 END) AS pri_real_callid\n  FROM norm_t nt\n  LEFT JOIN norm_p np ON TRUE\n  LEFT JOIN retell_calls rc\n    ON rc.call_id = nt.call_id\n    OR (\n      nt.t_phone_raw IS NOT NULL AND (\n           rc.phone_number = nt.t_phone_raw\n        OR rc.from_number  = nt.t_phone_raw\n        OR (nt.t_phone_e164 IS NOT NULL AND (\n               rc.phone_number = nt.t_phone_e164\n            OR rc.from_number  = nt.t_phone_e164\n        ))\n      )\n    )\n    OR (\n      (np.p_phone_e164 IS NOT NULL AND (\n           rc.phone_number = np.p_phone_e164\n        OR rc.from_number  = np.p_phone_e164\n      ))\n      OR\n      (np.p_mobile_e164 IS NOT NULL AND (\n           rc.phone_number = np.p_mobile_e164\n        OR rc.from_number  = np.p_mobile_e164\n      ))\n    )\n)\nSELECT\n  transfer_id, call_id, created_at, updated_at, caller_name,\n  phone_number, no_phone, village, intent, urgency, details, patient_id,\n  stored_phone_number, stored_no_phone, carrier_from_number\nFROM candidates\nORDER BY pri_has_from DESC, pri_real_callid DESC, rc_updated_at DESC NULLS LAST\nLIMIT 1;","options":{"queryReplacement":""}},"id":"18db800b-6d29-48ab-b55b-978123f507f1","name":"Postgres Load Transfer","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-640,496],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"\n// Universal Date Parsing (Natural Language to YYYY-MM-DD) - v9.09\nfunction parseNaturalDate(dateStr) {\n  if (!dateStr) return null;\n  if (/^\\d{4}-\\d{2}-\\d{2}$/.test(dateStr)) return dateStr;\n  const parsed = new Date(dateStr);\n  if (!isNaN(parsed.getTime())) {\n    return parsed.toISOString().split('T')[0];\n  }\n  const today = new Date();\n  const lower = String(dateStr).toLowerCase().trim();\n  if (lower === 'today') return today.toISOString().split('T')[0];\n  if (lower === 'tomorrow') {\n    const tomorrow = new Date(today);\n    tomorrow.setDate(tomorrow.getDate() + 1);\n    return tomorrow.toISOString().split('T')[0];\n  }\n  return null;\n}\n\n// Compose Sara's email. Show Start Time always.\n// Omit End Time / Duration / Disconnection Reason when not present.\n// Omit the \"Call Data & Links\" section if no Recording URL.\n\nconst wh = $items('Webhook')?.[0]?.json || {};\nconst body = wh.body || {};\nconst call = body.call || body.args?.call || body.original_data?.call || {}; // defensive\n\n// Row from Postgres Load Transfer\nconst row = Array.isArray($json) ? ($json[0] || {}) : $json;\n\n// HTML escape\nconst esc = (s) => String(s ?? '').replace(/[&<>\"']/g, c => (\n  {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[c]\n));\n\n// AU E.164\nfunction normAU(p) {\n  if (!p) return null;\n  let d = ('' + p).replace(/[^0-9+]/g, '');\n  if (d.startsWith('+')) return d;\n  if (d.startsWith('0')) d = '61' + d.slice(1);\n  if (!d.startsWith('61')) d = '61' + d;\n  return '+' + d;\n}\n\n// Time formatting (Australia/Melbourne)\nfunction fmtAU(ts) {\n  if (!ts) return null;\n  const d = new Date(ts);\n  if (isNaN(d)) return null;\n  return d.toLocaleString('en-AU', { timeZone: 'Australia/Melbourne' });\n}\nfunction humanDuration(ms) {\n  if (ms == null || isNaN(ms)) return null;\n  const total = Math.max(0, Math.floor(Number(ms) / 1000));\n  const m = Math.floor(total / 60);\n  const s = total % 60;\n  return `${m}m ${s}s`;\n}\n\n// Numbers\nconst fromPhone = normAU(row.carrier_from_number || call.from_number) || '[not captured]';\nlet callbackBase = (row.no_phone === true) ? null : (row.phone_number || row.stored_phone_number || null);\nconst callbackPhone = (row.no_phone === true) ? 'No phone (declined)' : (normAU(callbackBase) || '[not provided]');\n\n// Caller/booking\nconst caller     = row.caller_name || 'Unknown';\nconst village    = row.village || 'Unknown';\nconst intent     = row.intent  || 'booking';\nconst urgency    = row.urgency || 'routine';\nconst details    = row.details || '';\nconst patientId  = row.patient_id || '[unknown]';\n\n// Call meta (only include if present)\nconst startTime  = fmtAU(call.start_timestamp); // show even if only this exists\nconst endTime    = fmtAU(call.end_timestamp);   // optional\nconst duration   = ('duration_ms' in call) ? humanDuration(call.duration_ms) : null;\nconst disconnect = call.disconnection_reason || null;\nconst recordingUrl = call.recording_url || null;\n\n// Transcript (leave as-is ‚Äî optional to include even if empty)\nfunction roleLabel(r) {\n  if (!r) return 'Unknown';\n  const t = r.toLowerCase();\n  if (['assistant','agent','ai'].includes(t)) return 'Agent';\n  if (['user','caller','human'].includes(t))  return 'User';\n  return r.charAt(0).toUpperCase() + r.slice(1);\n}\nlet htmlTranscript = 'No transcript available';\nif (Array.isArray(call.transcript_object) && call.transcript_object.length) {\n  htmlTranscript = call.transcript_object\n    .map(t => `${esc(roleLabel(t.role))}: ${esc((t.content || '').trim())}`)\n    .join('<br><br>');\n}\n\n// Subject\nconst subject = `[Reignite] New ${intent} (${urgency}) ‚Äî ${caller}`;\n\n// Table styles\nconst td = 'style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"';\nconst th = 'style=\"padding:8px 10px;border:1px solid #e5e7eb;background:#f9fafb;text-align:left;font-weight:600;font-family:Arial,Helvetica,sans-serif;font-size:13px;line-height:18px;color:#111827\"';\n\n// Build conditional rows for Call Timings & Status\nlet timingsRows = `\n  <tr><td ${td}><strong>Start Time</strong></td><td ${td}>${esc(startTime || 'N/A')}</td></tr>\n`;\nif (endTime)   timingsRows += `<tr><td ${td}><strong>End Time</strong></td><td ${td}>${esc(endTime)}</td></tr>`;\nif (duration)  timingsRows += `<tr><td ${td}><strong>Duration</strong></td><td ${td}>${esc(duration)}</td></tr>`;\nif (disconnect)timingsRows += `<tr><td ${td}><strong>Disconnection Reason</strong></td><td ${td}>${esc(disconnect)}</td></tr>`;\n\n// Build optional Call Data & Links block only if we have a recording URL\nlet linksBlock = '';\nif (recordingUrl) {\n  linksBlock = `\n    <tr><td ${th} colspan=\"2\">Call Data & Links</td></tr>\n    <tr><td ${td}><strong>Recording URL</strong></td><td ${td}><a href=\"${esc(recordingUrl)}\">${esc(recordingUrl)}</a></td></tr>\n  `;\n}\n\n// HTML\nconst html = `\n  <table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\"\n         style=\"border-collapse:collapse;width:100%;max-width:780px;border:1px solid #e5e7eb\">\n    <tr><td ${th} colspan=\"2\">Caller</td></tr>\n    <tr><td ${td} style=\"width:240px\"><strong>Name</strong></td><td ${td}>${esc(caller)}</td></tr>\n    <tr><td ${td}><strong>From phone (carrier)</strong></td><td ${td}>${esc(fromPhone)}</td></tr>\n    <tr><td ${td}><strong>Callback phone</strong></td><td ${td}>${esc(callbackPhone)}</td></tr>\n    <tr><td ${td}><strong>Village</strong></td><td ${td}>${esc(village)}</td></tr>\n\n    <tr><td ${th} colspan=\"2\">Booking</td></tr>\n    <tr><td ${td}><strong>Intent</strong></td><td ${td}>${esc(intent)}</td></tr>\n    <tr><td ${td}><strong>Urgency</strong></td><td ${td}>${esc(urgency)}</td></tr>\n    <tr><td ${td}><strong>Patient ID</strong></td><td ${td}>${esc(patientId)}</td></tr>\n    <tr><td ${td}><strong>Details</strong></td><td ${td}>${esc(details)}</td></tr>\n\n    <tr><td ${th} colspan=\"2\">Call Timings & Status</td></tr>\n    ${timingsRows}\n\n    ${linksBlock}\n\n    <tr><td ${th} colspan=\"2\">Transcript</td></tr>\n    <tr><td ${td} colspan=\"2\" style=\"background:#fff\">${htmlTranscript}</td></tr>\n\n    <tr><td ${th} colspan=\"2\">Technical</td></tr>\n    <tr><td ${td}><strong>Transfer ID</strong></td><td ${td}>${esc(row.transfer_id || '[unknown]')}</td></tr>\n    <tr><td ${td}><strong>Call ID</strong></td><td ${td}>${esc(row.call_id || '[unknown]')}</td></tr>\n  </table>\n  <div style=\"font-family:Arial,Helvetica,sans-serif;font-size:12px;color:#6b7280;margin-top:10px\">\n    Powered by Yes AI <a href=\"https://www.YesAI.au\" style=\"color:#6b7280;text-decoration:none\">www.YesAI.au</a>\n  </div>\n`;\n\nreturn [{ json: { subject, html } }];"},"id":"eb91b6b5-6e1c-4b0e-a1e0-119dfcf5ab52","name":"Compose Email","type":"n8n-nodes-base.code","typeVersion":2,"position":[-400,496]},{"parameters":{"fromEmail":"yesrightau@gmail.com","toEmail":"peter@yesai.au","subject":"={{$json.subject}}","text":"={{$json.body}}","options":{}},"id":"4fe9187c-026f-4b2b-9ac8-c335c0519d4f","name":"Send Email","type":"n8n-nodes-base.emailSend","typeVersion":2,"position":[-224,368],"webhookId":"b7ab8d93-5933-4079-8e7d-5598b84c685b","credentials":{"smtp":{"id":"qR64tEayuNvv3PWa","name":"SMTP account"}}},{"parameters":{"jsCode":"return [{ json: { email_sent: true, success: true, message: 'Email queued/sent' } }];"},"id":"b0a25deb-8129-476a-979b-b35ec98fcc69","name":"Success JSON for Retell","type":"n8n-nodes-base.code","typeVersion":2,"position":[80,496]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"ede15efa-c737-460a-b0ed-45d8b6abb10d","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[320,496]},{"parameters":{"sendTo":"peter@yesai.au","subject":"={{$json.subject}}","message":"={{$json.html}}","options":{}},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[-128,512],"id":"4b3fdb5d-8854-4112-8cca-d0d076f34d6f","name":"Send a message","webhookId":"28c469d5-a989-40b4-b5db-552a8cd1d8a3","credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}}],"connections":{"Webhook":{"main":[[{"node":"Postgres Load Transfer","type":"main","index":0}]]},"Postgres Load Transfer":{"main":[[{"node":"Compose Email","type":"main","index":0}]]},"Compose Email":{"main":[[{"node":"Send a message","type":"main","index":0}]]},"Success JSON for Retell":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Send a message":{"main":[[{"node":"Success JSON for Retell","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","saveDataSuccessExecution":"all","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"aa2f9004-122d-4820-9771-195e24af4057","triggerCount":1,"shared":[{"updatedAt":"2025-10-26T20:18:33.588Z","createdAt":"2025-10-26T20:18:33.588Z","role":"workflow:owner","workflowId":"qbIUIvXJkI30vRrv","projectId":"ePBcCsWsgvLDebw1"}],"tags":[{"updatedAt":"2025-10-25T20:46:30.688Z","createdAt":"2025-10-25T20:46:30.688Z","id":"xOR2iXEsXC2hMCtx","name":"Webhooks"},{"updatedAt":"2025-10-25T20:46:30.687Z","createdAt":"2025-10-25T20:46:30.687Z","id":"f4oitz85OWylN1Dp","name":"RetellAI"},{"updatedAt":"2025-10-03T03:47:29.353Z","createdAt":"2025-10-03T03:47:29.353Z","id":"dbO1yennvLLTWb9D","name":"Reignite"}]},{"updatedAt":"2025-11-25T00:03:34.018Z","createdAt":"2025-10-28T06:48:26.594Z","id":"albW0rjrJvEdvEXH","name":"RetellAI - Check Phone Availability","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/check-phone-availability","responseMode":"responseNode","options":{}},"id":"babd71e8-84c6-4ef6-a330-09cfdd83ca1d","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"523388ec-d9a8-4fc4-a5b3-ed7a481bed27"},{"parameters":{"jsCode":"// STANDARD EXTRACTION PATTERN - RetellAI Compatible\nfunction normAU(p) {\n  if (!p) return null;\n  let d = ('' + p).replace(/[^0-9+]/g, '');\n  if (d.startsWith('+')) return d;\n  if (d.startsWith('0')) d = '61' + d.slice(1);\n  if (!d.startsWith('61')) d = '61' + d;\n  return '+' + d;\n}\n\nconst webhookData = $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\nconst original = webhookData.original_data || {};\nconst headers = $input.item.json.headers || {};\n\nconst rawFrom = call.from_number || original.call?.from_number || headers['x-retell-phone'] || args.from_number || args.phone_number || null;\n\nconst discovered_phone = normAU(args.phone_number || rawFrom);\nconst discovered_phone_raw = rawFrom;\nconst call_id = call.call_id || args.call_id || '';\n\nreturn [{ json: { discovered_phone, discovered_phone_raw, carrier_from_number: rawFrom, call_id } }];"},"id":"b165e876-aa0d-4be5-ba54-dfa82e9fe427","name":"Extract/Normalize Phone","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"operation":"executeQuery","query":"-- Ensure table + new column exist\nCREATE TABLE IF NOT EXISTS retell_calls (\n  call_id      text PRIMARY KEY,\n  phone_number text,\n  no_phone     boolean DEFAULT false,\n  from_number  text,                   -- carrier caller-id (raw) if known\n  created_at   timestamptz DEFAULT now(),\n  updated_at   timestamptz DEFAULT now()\n);\n\n-- Upsert phone + carrier from_number\nINSERT INTO retell_calls (call_id, phone_number, from_number)\nVALUES (\n  '{{ $json.body?.args?.call_id || $json.full_body?.args?.call_id || $json.call_id || $json.body?.call_id || $json.full_body?.call_id || \"\" }}',\n  NULLIF('{{ $json.discovered_phone || \"\" }}',''),\n  NULLIF('{{ $json.carrier_from_number || $json.discovered_phone_raw || $json.full_body?.original_data?.call?.from_number || $json.headers?.[\"x-retell-phone\"] || $json.body?.phone_number || $json.full_body?.phone_number || \"\" }}','')\n)\nON CONFLICT (call_id) DO UPDATE SET\n  phone_number = COALESCE(NULLIF(EXCLUDED.phone_number,''), retell_calls.phone_number),\n  from_number  = COALESCE(retell_calls.from_number, NULLIF(EXCLUDED.from_number,'')),\n  updated_at   = now();\n\n-- Return best-known values\nSELECT\n  CASE\n    WHEN rc.no_phone IS TRUE THEN NULL\n    ELSE COALESCE(\n      rc.phone_number,\n      NULLIF('{{ $json.discovered_phone || \"\" }}','')\n    )\n  END AS phone_number,\n  COALESCE(rc.no_phone, false) AS no_phone,\n  rc.from_number AS carrier_from_number\nFROM retell_calls rc\nWHERE rc.call_id = '{{ $json.body?.args?.call_id || $json.full_body?.args?.call_id || $json.call_id || $json.body?.call_id || $json.full_body?.call_id || \"\" }}';","options":{"queryReplacement":""}},"id":"69792933-92a7-4001-ad2b-1fd309e17a7f","name":"Postgres Upsert+Read","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[464,0],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"const row = $json[0] || {}; // from SELECT\nconst phone = row.phone_number || null;\nconst noPhone = row.no_phone === true;\nreturn [{ json: { has_phone: !!phone, phone_number: phone || undefined, no_phone: noPhone } }];"},"id":"5e9bd8e4-189e-4955-8deb-0096f5ba4b5c","name":"Shape Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[704,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"b372a500-cd0f-4968-95bb-915065aea0d6","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[928,0]}],"connections":{"Webhook":{"main":[[{"node":"Extract/Normalize Phone","type":"main","index":0}]]},"Extract/Normalize Phone":{"main":[[{"node":"Postgres Upsert+Read","type":"main","index":0}]]},"Postgres Upsert+Read":{"main":[[{"node":"Shape Response","type":"main","index":0}]]},"Shape Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","saveDataSuccessExecution":"all"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"200d4a35-cb12-448e-b556-89c709a98adc","triggerCount":1,"shared":[{"updatedAt":"2025-10-28T06:48:26.594Z","createdAt":"2025-10-28T06:48:26.594Z","role":"workflow:owner","workflowId":"albW0rjrJvEdvEXH","projectId":"ePBcCsWsgvLDebw1"}],"tags":[{"updatedAt":"2025-10-03T03:47:29.353Z","createdAt":"2025-10-03T03:47:29.353Z","id":"dbO1yennvLLTWb9D","name":"Reignite"}]},{"updatedAt":"2025-11-24T05:10:55.854Z","createdAt":"2025-10-28T06:49:16.824Z","id":"MHCGmxBFIJkod10Q","name":"RetellAI - Store Phone Number","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/store-phone-number","responseMode":"responseNode","options":{}},"id":"7cd7eaf3-de41-4b5b-91a4-c1aa2778993c","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-128,80],"webhookId":"ae092fd7-94a4-4cef-a396-9506b3af147a"},{"parameters":{"jsCode":"\n// Universal Date Parsing (Natural Language to YYYY-MM-DD) - v9.09\nfunction parseNaturalDate(dateStr) {\n  if (!dateStr) return null;\n  if (/^\\d{4}-\\d{2}-\\d{2}$/.test(dateStr)) return dateStr;\n  const parsed = new Date(dateStr);\n  if (!isNaN(parsed.getTime())) {\n    return parsed.toISOString().split('T')[0];\n  }\n  const today = new Date();\n  const lower = String(dateStr).toLowerCase().trim();\n  if (lower === 'today') return today.toISOString().split('T')[0];\n  if (lower === 'tomorrow') {\n    const tomorrow = new Date(today);\n    tomorrow.setDate(tomorrow.getDate() + 1);\n    return tomorrow.toISOString().split('T')[0];\n  }\n  return null;\n}\n\n// Normalize and validate input\nfunction normAU(p){ if(!p) return null; let d=(''+p).replace(/[^0-9+]/g,''); if(d.startsWith('+')) return d; if(d.startsWith('0')) d='61'+d.slice(1); if(!d.startsWith('61')) d='61'+d; return '+'+d; }\nconst args = $json.body?.args || $json.body || {};\nconst callId = args.call_id || $json.full_body?.args?.call_id || $json.full_body?.call_id || $json.call_id;\nlet phone = args.phone_number || null;\nconst noPhone = !!args.no_phone;\nphone = noPhone ? null : normAU(phone);\nif(!callId){ throw new Error('call_id is required'); }\nreturn [{ json: { call_id: callId, phone_number: phone, no_phone: noPhone } }];"},"id":"2b9c2d0d-10bc-474c-8e5a-10b80b7a3ae2","name":"Validate/Normalize","type":"n8n-nodes-base.code","typeVersion":2,"position":[112,80]},{"parameters":{"operation":"executeQuery","query":"CREATE TABLE IF NOT EXISTS retell_calls (\n  call_id      text PRIMARY KEY,\n  phone_number text,\n  no_phone     boolean DEFAULT false,\n  created_at   timestamptz DEFAULT now(),\n  updated_at   timestamptz DEFAULT now()\n);\n\nINSERT INTO retell_calls(call_id, phone_number, no_phone)\nVALUES('{{ $json.call_id }}', {{ $json.phone_number ? `'${$json.phone_number}'` : 'NULL' }}, {{ $json.no_phone ? 'true' : 'false' }})\nON CONFLICT (call_id) DO UPDATE SET\n  phone_number = CASE WHEN EXCLUDED.no_phone IS TRUE THEN NULL ELSE EXCLUDED.phone_number END,\n  no_phone = EXCLUDED.no_phone,\n  updated_at = now();\n\nSELECT phone_number, no_phone FROM retell_calls WHERE call_id='{{ $json.call_id }}';","options":{"queryReplacement":""}},"id":"3eb5280c-3586-4f87-a620-fdc514d75529","name":"Postgres Upsert","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[352,80],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"const row = $json[0] || {}; return [{ json: { stored: true, phone_number: row.phone_number || undefined, no_phone: row.no_phone || false } }];"},"id":"469c4cc2-0e56-49b9-9c8d-23f11badce13","name":"Shape Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[592,80]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"dd174f1d-d2ea-4295-99b2-99fd4b696993","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[832,80]}],"connections":{"Webhook":{"main":[[{"node":"Validate/Normalize","type":"main","index":0}]]},"Validate/Normalize":{"main":[[{"node":"Postgres Upsert","type":"main","index":0}]]},"Postgres Upsert":{"main":[[{"node":"Shape Response","type":"main","index":0}]]},"Shape Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","saveDataSuccessExecution":"all"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"e3f45d71-6bc9-4d88-bf46-6fb5afdef1f5","triggerCount":1,"shared":[{"updatedAt":"2025-10-28T06:49:16.824Z","createdAt":"2025-10-28T06:49:16.824Z","role":"workflow:owner","workflowId":"MHCGmxBFIJkod10Q","projectId":"ePBcCsWsgvLDebw1"}],"tags":[{"updatedAt":"2025-10-03T03:47:29.353Z","createdAt":"2025-10-03T03:47:29.353Z","id":"dbO1yennvLLTWb9D","name":"Reignite"}]},{"updatedAt":"2025-10-28T20:58:01.185Z","createdAt":"2025-10-28T20:58:01.185Z","id":"rQgRjHsZuajPM2Ga","name":"RetellAI - Email Sara Transfer copy","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"c07042c4-eb8c-4f4c-9d4f-84dc93ff0510","responseMode":"responseNode","options":{}},"id":"001c3969-d22f-4821-97db-4377f713d0c2","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[1088,176],"webhookId":"c07042c4-eb8c-4f4c-9d4f-84dc93ff0510"},{"parameters":{"operation":"executeQuery","query":"-- Ensure helper exists (no-op if it already does)\nCREATE TABLE IF NOT EXISTS retell_calls (\n  call_id        text PRIMARY KEY,\n  phone_number   text,\n  no_phone       boolean DEFAULT false,\n  from_number    text,\n  created_at     timestamptz DEFAULT now(),\n  updated_at     timestamptz DEFAULT now()\n);\n\nWITH t AS (\n  -- The transfer we're emailing about\n  SELECT *\n  FROM retell_transfers\n  WHERE transfer_id = '{{ $json.body?.args?.transfer_id || $json.full_body?.args?.transfer_id || $json.transfer_id }}'\n  LIMIT 1\n),\n-- Normalize the transfer callback number to AU E.164\nnorm_t AS (\n  SELECT\n    t.*,\n    t.phone_number AS t_phone_raw,\n    CASE\n      WHEN t.phone_number IS NULL OR t.phone_number = '' THEN NULL\n      WHEN t.phone_number ~ '^\\+'                    THEN t.phone_number\n      WHEN t.phone_number ~ '^0[0-9]+$'             THEN '+61' || substring(t.phone_number FROM 2)\n      ELSE '+61' || t.phone_number\n    END AS t_phone_e164,\n    -- Keep patient_id as text and also as bigint when it‚Äôs numeric\n    t.patient_id::text         AS t_pid_text,\n    CASE\n      WHEN t.patient_id ~ '^[0-9]+$' THEN (t.patient_id)::bigint\n      ELSE NULL\n    END                      AS t_pid_bigint\n  FROM t\n),\n-- Safely fetch the patient using a bigint match when possible\np AS (\n  SELECT p.*\n  FROM patients p\n  WHERE p.patient_id = COALESCE( (SELECT t_pid_bigint FROM norm_t), -1 )\n  LIMIT 1\n),\n-- Normalize patient phone/mobile to AU E.164\nnorm_p AS (\n  SELECT\n    p.*,\n    CASE\n      WHEN p.phone IS NULL OR p.phone = '' THEN NULL\n      WHEN p.phone ~ '^\\+'                 THEN p.phone\n      WHEN p.phone ~ '^0[0-9]+$'           THEN '+61' || substring(p.phone FROM 2)\n      ELSE '+61' || p.phone\n    END AS p_phone_e164,\n    CASE\n      WHEN p.phone_mobile IS NULL OR p.phone_mobile = '' THEN NULL\n      WHEN p.phone_mobile ~ '^\\+'                        THEN p.phone_mobile\n      WHEN p.phone_mobile ~ '^0[0-9]+$'                  THEN '+61' || substring(p.phone_mobile FROM 2)\n      ELSE '+61' || p.phone_mobile\n    END AS p_mobile_e164\n  FROM p\n),\n-- Join retell_calls by:\n--   1) exact call_id\n--   2) the transfer's callback number (raw/E.164)\n--   3) the patient's phone or mobile (E.164)\ncandidates AS (\n  SELECT\n    nt.*,\n    rc.phone_number  AS stored_phone_number,\n    rc.no_phone      AS stored_no_phone,\n    rc.from_number   AS carrier_from_number,\n    rc.updated_at    AS rc_updated_at,\n    -- Priority: prefer rows that actually have a carrier from_number,\n    -- then those whose call_id is not a placeholder, then newest.\n    (CASE WHEN rc.from_number IS NOT NULL THEN 1 ELSE 0 END)              AS pri_has_from,\n    (CASE WHEN rc.call_id NOT IN ('unknown','current') THEN 1 ELSE 0 END) AS pri_real_callid\n  FROM norm_t nt\n  LEFT JOIN norm_p np ON TRUE\n  LEFT JOIN retell_calls rc\n    ON rc.call_id = nt.call_id\n    OR (\n      nt.t_phone_raw IS NOT NULL AND (\n           rc.phone_number = nt.t_phone_raw\n        OR rc.from_number  = nt.t_phone_raw\n        OR (nt.t_phone_e164 IS NOT NULL AND (\n               rc.phone_number = nt.t_phone_e164\n            OR rc.from_number  = nt.t_phone_e164\n        ))\n      )\n    )\n    OR (\n      (np.p_phone_e164 IS NOT NULL AND (\n           rc.phone_number = np.p_phone_e164\n        OR rc.from_number  = np.p_phone_e164\n      ))\n      OR\n      (np.p_mobile_e164 IS NOT NULL AND (\n           rc.phone_number = np.p_mobile_e164\n        OR rc.from_number  = np.p_mobile_e164\n      ))\n    )\n)\nSELECT\n  transfer_id, call_id, created_at, updated_at, caller_name,\n  phone_number, no_phone, village, intent, urgency, details, patient_id,\n  stored_phone_number, stored_no_phone, carrier_from_number\nFROM candidates\nORDER BY pri_has_from DESC, pri_real_callid DESC, rc_updated_at DESC NULLS LAST\nLIMIT 1;","options":{"queryReplacement":""}},"id":"84779521-b4a9-4e72-912a-ca7db0c01beb","name":"Postgres Load Transfer","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1360,176],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Compose a neat HTML email with a strict carrier \"From phone\" and a callback phone.\n// This node should receive one item from \"Postgres Load Transfer\".\n\n// Handle item vs array-of-one\nconst row = Array.isArray($json) ? ($json[0] || {}) : $json;\n\n// HTML escape\nconst esc = (s) => String(s ?? '').replace(/[&<>\"']/g, c => (\n  {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[c]\n));\n\n// AU E.164 normalizer\nfunction normAU(p) {\n  if (!p) return null;\n  let d = ('' + p).replace(/[^0-9+]/g, '');\n  if (d.startsWith('+')) return d;\n  if (d.startsWith('0')) d = '61' + d.slice(1);\n  if (!d.startsWith('61')) d = '61' + d;\n  return '+' + d;\n}\n\n// Strict carrier \"From phone\" (do NOT fall back to callback)\nconst fromPhone = normAU(row.carrier_from_number) || '[not captured]';\n\n// Callback phone (use spoken/captured; DO NOT use carrier here)\nlet callbackBase = null;\nif (row.no_phone === true) {\n  callbackBase = null;\n} else {\n  callbackBase = row.phone_number || row.stored_phone_number || null;\n}\nconst callbackPhone = row.no_phone === true\n  ? 'No phone (declined)'\n  : (normAU(callbackBase) || '[not provided]');\n\n// Other fields\nconst caller     = row.caller_name || 'Unknown';\nconst village    = row.village || 'Unknown';\nconst intent     = row.intent  || 'booking';\nconst urgency    = row.urgency || 'routine';\nconst details    = row.details || '';\n\nconst transferId = row.transfer_id || '[unknown]';\nconst callId     = row.call_id     || '[unknown]';\nconst createdAt  = row.created_at  || '';\nconst updatedAt  = row.updated_at  || '';\n\n// Subject\nconst subject = `[Reignite] New ${intent} (${urgency}) ‚Äî ${caller}`;\n\n// Table styles\nconst td = 'style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"';\nconst th = 'style=\"padding:8px 10px;border:1px solid #e5e7eb;background:#f9fafb;text-align:left;font-weight:600;font-family:Arial,Helvetica,sans-serif;font-size:13px;line-height:18px;color:#111827\"';\n\n// Build HTML\nconst html = `\n  <table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\"\n         style=\"border-collapse:collapse;width:100%;max-width:680px;border:1px solid #e5e7eb\">\n    <tr><td ${th} colspan=\"2\">Caller</td></tr>\n    <tr><td ${td} style=\"width:220px\"><strong>Name</strong></td><td ${td}>${esc(caller)}</td></tr>\n    <tr><td ${td}><strong>From phone (carrier)</strong></td><td ${td}>${esc(fromPhone)}</td></tr>\n    <tr><td ${td}><strong>Callback phone</strong></td><td ${td}>${esc(callbackPhone)}</td></tr>\n    <tr><td ${td}><strong>Village</strong></td><td ${td}>${esc(village)}</td></tr>\n\n    <tr><td ${th} colspan=\"2\">Booking</td></tr>\n    <tr><td ${td}><strong>Intent</strong></td><td ${td}>${esc(intent)}</td></tr>\n    <tr><td ${td}><strong>Urgency</strong></td><td ${td}>${esc(urgency)}</td></tr>\n    <tr><td ${td}><strong>Patient ID</strong></td><td ${td}>${esc(row.patient_id || '[unknown]')}</td></tr>\n    <tr><td ${td}><strong>Details</strong></td><td ${td}>${esc(details)}</td></tr>\n\n    <tr><td ${th} colspan=\"2\">Technical</td></tr>\n    <tr><td ${td}><strong>Transfer ID</strong></td><td ${td}>${esc(transferId)}</td></tr>\n    <tr><td ${td}><strong>Call ID</strong></td><td ${td}>${esc(callId)}</td></tr>\n    <tr><td ${td}><strong>Created</strong></td><td ${td}>${esc(createdAt)}</td></tr>\n    <tr><td ${td}><strong>Updated</strong></td><td ${td}>${esc(updatedAt)}</td></tr>\n  </table>\n  <div style=\"font-family:Arial,Helvetica,sans-serif;font-size:12px;color:#6b7280;margin-top:10px\">\n    Powered by Yes AI <a href=\"https://www.YesAI.au\" style=\"color:#6b7280;text-decoration:none\">www.YesAI.au</a>\n  </div>\n`;\n\n// Output for the email node\nreturn [{ json: { subject, html } }];"},"id":"0fcaba67-05d9-42d8-87cc-e18e4632661f","name":"Compose Email","type":"n8n-nodes-base.code","typeVersion":2,"position":[1600,176]},{"parameters":{"fromEmail":"yesrightau@gmail.com","toEmail":"peter@yesai.au","subject":"={{$json.subject}}","text":"={{$json.body}}","options":{},"path":"2718b5dc-1efa-4bd3-ac48-d17363f3891f"},"id":"21c98ab3-01d6-42f5-b124-ebc9fb5621e5","name":"Send Email","type":"n8n-nodes-base.emailSend","typeVersion":2,"position":[1776,48],"webhookId":"2718b5dc-1efa-4bd3-ac48-d17363f3891f","credentials":{"smtp":{"id":"qR64tEayuNvv3PWa","name":"SMTP account"}}},{"parameters":{"jsCode":"return [{ json: { email_sent: true, success: true, message: 'Email queued/sent' } }];"},"id":"738f1261-8aca-45d3-9567-274c6fc6eb7d","name":"Success JSON for Retell","type":"n8n-nodes-base.code","typeVersion":2,"position":[2080,176]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"49d3787d-7835-47dc-9b15-800e5c4f09fe","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2320,176]},{"parameters":{"sendTo":"peter@yesai.au","subject":"={{$json.subject}}","message":"={{$json.html}}","options":{},"path":"4d111f72-7486-4a11-9062-72204bff2330"},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[1872,192],"id":"1c245e0f-9e83-4736-81c9-997cbc6943d4","name":"Send a message","webhookId":"4d111f72-7486-4a11-9062-72204bff2330","credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}}],"connections":{"Webhook":{"main":[[{"node":"Postgres Load Transfer","type":"main","index":0}]]},"Postgres Load Transfer":{"main":[[{"node":"Compose Email","type":"main","index":0}]]},"Compose Email":{"main":[[{"node":"Send a message","type":"main","index":0}]]},"Send Email":{"main":[[]]},"Success JSON for Retell":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Send a message":{"main":[[{"node":"Success JSON for Retell","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","saveDataSuccessExecution":"all","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"54345702-64b8-45e7-8ef5-ec823d8cdfff","triggerCount":1,"shared":[{"updatedAt":"2025-10-28T20:58:01.185Z","createdAt":"2025-10-28T20:58:01.185Z","role":"workflow:owner","workflowId":"rQgRjHsZuajPM2Ga","projectId":"ePBcCsWsgvLDebw1"}],"tags":[{"updatedAt":"2025-10-25T20:46:30.687Z","createdAt":"2025-10-25T20:46:30.687Z","id":"f4oitz85OWylN1Dp","name":"RetellAI"},{"updatedAt":"2025-10-25T20:46:30.688Z","createdAt":"2025-10-25T20:46:30.688Z","id":"xOR2iXEsXC2hMCtx","name":"Webhooks"},{"updatedAt":"2025-10-03T03:47:29.353Z","createdAt":"2025-10-03T03:47:29.353Z","id":"dbO1yennvLLTWb9D","name":"Reignite"}]},{"updatedAt":"2025-11-24T05:10:32.333Z","createdAt":"2025-10-30T22:45:39.659Z","id":"JTNTdVDUzfkLM3mz","name":"Reignite: Retell List Upcoming Appointments WORKING","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/list-appointments","responseMode":"responseNode","options":{}},"id":"521c658b-1e0f-413a-afe9-06caaf18a00a","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-528,208],"webhookId":"ddc78d3a-5efb-4335-80ff-5a2e5afe51f9"},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.body.name }}","value2":"list_upcoming_appointments"}]},"options":{}},"id":"899841f4-5f9e-4639-aba8-91c7b46e6b1c","name":"IF","type":"n8n-nodes-base.if","typeVersion":2,"position":[-304,208]},{"parameters":{"jsCode":"\n// Universal Phone Normalization (Australian E.164) - v9.09\n\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n\n  // 1. Strip everything except digits and '+'\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n\n  // 2. Already in E.164 format\n  if (phone.startsWith('+')) {\n    return phone;\n  }\n\n  // 3. Handle 8-digit local numbers (Assume NSW '02')\n  if (phone.length === 8 && !phone.startsWith('+')) {\n    return '+612' + phone;\n  }\n\n  // 4. Handle standard 10-digit AU numbers (04... or 02...)\n  if (phone.length === 10 && phone.startsWith('0')) {\n    return '+61' + phone.substring(1);\n  }\n\n  // 5. Handle numbers starting with 61 (missing +)\n  if (phone.length === 11 && phone.startsWith('61')) {\n    return '+' + phone;\n  }\n\n  // 6. Assume Australian if 9 digits (missing leading 0)\n  if (phone.length === 9) {\n    return '+61' + phone;\n  }\n\n  // 7. Return cleaned version (best effort)\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n\nconst body = $json.body || $json;\nconst patientId = body?.args?.body?.args?.patient_id || body?.args?.patient_id || body?.patient_id;\n\nif (!patientId) {\n  throw new Error('Missing patient_id in request');\n}\n\nconst now = new Date().toISOString();\nconst filters = [\n  `patient_id:=${patientId}`,\n  `starts_at:>=${now}`,  // Changed from > to >= to include appointments starting now\n  `cancelled_at:!?`,\n  `deleted_at:!?`,\n  `archived_at:!?`\n];\n\nconst url = `https://api.au2.cliniko.com/v1/individual_appointments?${filters.map(f => 'q[]=' + encodeURIComponent(f)).join('&')}&sort=starts_at:asc&per_page=20`;\n\nreturn { \n  json: { \n    url, \n    patient_id: patientId, \n    timestamp: now \n  } \n};"},"id":"ef88366f-00c5-416e-b540-106f8bb37aaf","name":"Build URL","type":"n8n-nodes-base.code","typeVersion":2,"position":[-96,96]},{"parameters":{"url":"={{ $json.url }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Accept","value":"application/json"},{"name":"User-Agent","value":"Reignite (n8n)"}]},"options":{}},"id":"48a76c02-0915-4aeb-b08a-c40bd200d546","name":"Cliniko API","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[128,96],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"jsCode":"const response = $json;\nconst buildData = $node['Build URL'].json;\n\nfunction extractId(linkObj) {\n  const match = linkObj?.links?.self?.match(/\\/(\\d+)$/);\n  return match ? match[1] : null;\n}\n\nfunction extractName(linkObj) {\n  return linkObj?.links?.self?.split('/').pop()?.replace(/_/g, ' ') || null;\n}\n\nconst appointments = (response.individual_appointments || []).map(a => {\n  const practitionerId = extractId(a.practitioner);\n  const practitionerName = a.practitioner_name || 'Staff Member';\n  \n  return {\n    id: a.id,\n    starts_at: a.starts_at,\n    ends_at: a.ends_at,\n    patient_name: a.patient_name,\n    patient_id: extractId(a.patient),\n    practitioner_id: practitionerId,\n    practitioner_name: practitionerName,\n    appointment_type_id: extractId(a.appointment_type) || 'unknown',\n    business_id: extractId(a.business),\n    business_name: a.business_name || '',\n    notes: a.notes || ''\n  };\n});\n\nconst summary = appointments.slice(0, 5).map((a, i) => {\n  const start = new Date(a.starts_at);\n  return {\n    rank: i + 1,\n    id: a.id,\n    patient_name: a.patient_name,\n    practitioner: a.practitioner_name,\n    location: a.business_name,\n    date: start.toLocaleDateString('en-AU', { \n      weekday: 'long', \n      year: 'numeric', \n      month: 'long', \n      day: 'numeric' \n    }),\n    time: start.toLocaleTimeString('en-AU', { \n      hour: '2-digit', \n      minute: '2-digit',\n      hour12: true \n    })\n  };\n});\n\nreturn {\n  json: {\n    ok: true,\n    message: appointments.length ? `Found ${appointments.length} appointment(s)` : 'No appointments found',\n    count: appointments.length,\n    patient_id: buildData.patient_id,\n    appointments_summary: summary,\n    appointments: appointments\n  }\n};"},"id":"842f122e-57bf-4fea-9329-b5b5d75a5d62","name":"Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[352,96]},{"parameters":{"jsCode":"const error = $json.error || 'Invalid request';\nreturn { \n  json: { \n    ok: false, \n    error: error,\n    message: 'Unable to process request. Expected action: list_upcoming_appointments' \n  } \n};"},"id":"649254fa-45eb-4dc9-9d6c-01d2f8e79839","name":"Error Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[-96,304]},{"parameters":{"options":{}},"id":"72ab0849-418f-4e02-bc1b-af35c1a5a5b1","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[576,208]}],"connections":{"Webhook":{"main":[[{"node":"IF","type":"main","index":0}]]},"IF":{"main":[[{"node":"Build URL","type":"main","index":0}],[{"node":"Error Response","type":"main","index":0}]]},"Build URL":{"main":[[{"node":"Cliniko API","type":"main","index":0}]]},"Cliniko API":{"main":[[{"node":"Format Response","type":"main","index":0}]]},"Format Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Error Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"fcd833f9-10be-404e-b56f-b02e414078bf","triggerCount":1,"shared":[{"updatedAt":"2025-10-30T22:45:39.659Z","createdAt":"2025-10-30T22:45:39.659Z","role":"workflow:owner","workflowId":"JTNTdVDUzfkLM3mz","projectId":"ePBcCsWsgvLDebw1"}],"tags":[{"updatedAt":"2025-10-03T03:47:29.353Z","createdAt":"2025-10-03T03:47:29.353Z","id":"dbO1yennvLLTWb9D","name":"Reignite"}]},{"updatedAt":"2025-10-31T05:51:44.431Z","createdAt":"2025-10-31T03:22:05.804Z","id":"p39d05GlPx6at2aG","name":"RetellAI - Email End of Call Summary Gemini","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/email-call-summary","responseMode":"responseNode","options":{}},"id":"e44f17d1-ba5d-46d0-9043-1c6abe10675a","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-1360,160],"webhookId":"792a324c-aec8-4de8-b20b-ea74983a8007"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"typeValidation":"strict","leftValue":""},"conditions":[{"leftValue":"={{ $('Webhook').item.json.body?.event }}","rightValue":"call_ended","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"67c81332-cb9b-46a6-83ed-7a45c06170bc","name":"Is Call Ended?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1136,160]},{"parameters":{"operation":"executeQuery","query":"CREATE TABLE IF NOT EXISTS retell_email_sends (\n  call_id text PRIMARY KEY,\n  email_sent_at timestamptz DEFAULT now()\n);\nWITH ci AS (\n  SELECT '{{ $json.body.call.call_id }}'::text AS call_id,\n         NULLIF('{{ $json.body.call.end_timestamp }}','')::text AS end_ts_text\n),\ngate AS (\n  SELECT (end_ts_text IS NOT NULL AND end_ts_text <> '') AS ended FROM ci\n),\nins AS (\n  INSERT INTO retell_email_sends(call_id)\n  SELECT call_id FROM ci, gate WHERE gate.ended\n  ON CONFLICT DO NOTHING\n  RETURNING 1 AS inserted\n)\nSELECT (SELECT ended FROM gate) AS ended,\n       COALESCE((SELECT inserted FROM ins), 0) AS should_send,\n       (SELECT call_id FROM ci) AS call_id;","options":{"queryReplacement":""}},"id":"24de8ce2-4ba7-43bb-ac44-64e40a937c30","name":"Postgres: Claim Send Once","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-928,160],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"conditions":{"number":[{"value1":"={{$json.should_send}}","operation":"equal","value2":1}]}},"id":"b842c2fe-2223-45ae-a630-9bc08776b023","name":"IF: Should Send?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-704,160]},{"parameters":{"operation":"executeQuery","query":"WITH call_info AS (\n  SELECT '{{ $json.body.call.call_id }}' as search_call_id\n),\ntransfer_lookup AS (\n  SELECT * FROM retell_transfers\n  WHERE call_id = (SELECT search_call_id FROM call_info)\n  ORDER BY created_at DESC LIMIT 1\n)\nSELECT * FROM transfer_lookup;","options":{"queryReplacement":""}},"id":"0de3c954-371d-4ba6-b830-ee6fab99803d","name":"Postgres Load Transfer","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-480,160],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"const wh = $items('Webhook')?.[0]?.json || {};\nconst body = wh.body || {};\nconst call = body.call || {};\nconst transfer = ($items('Postgres Load Transfer')?.[0]?.json ?? [])[0] || {};\n\nfunction esc(s){return String(s ?? '').replace(/[&<>\\\"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\\\"':'&quot;','\\'':'&#39;'}[c]));}\nfunction normAU(p){ if(!p)return null; let d=(''+p).replace(/[^0-9+]/g,''); if(d.startsWith('+'))return d; if(d.startsWith('0')) d='61'+d.slice(1); if(!d.startsWith('61')) d='61'+d; return '+'+d; }\nfunction fmtAU(ts){ if(!ts)return null; const d=new Date(ts); if(isNaN(d))return null; return d.toLocaleString('en-AU',{timeZone:'Australia/Melbourne'}); }\nfunction humanDuration(ms){ if(ms==null||isNaN(ms))return 'N/A'; const total=Math.max(0,Math.floor(Number(ms)/1000)); const m=Math.floor(total/60); const s=total%60; return `${m}m ${s}s`; }\nfunction roleLabel(r){ if(!r) return 'Unknown'; const t=r.toLowerCase(); if(['assistant','agent','ai'].includes(t)) return 'Agent'; if(['user','caller','human'].includes(t)) return 'User'; return r.charAt(0).toUpperCase()+r.slice(1); }\n\nconst duration_ms = call.duration_ms ?? 0;\nconst duration_h = humanDuration(duration_ms);\nconst direction = call.direction || 'unknown';\nconst start_local = fmtAU(call.start_timestamp);\nconst end_local = fmtAU(call.end_timestamp);\nconst subject = `Call Summary ‚Äî ${duration_h}`;\n\nlet htmlTranscript = 'No transcript available';\nlet plainTranscript = 'No transcript available';\nif (Array.isArray(call.transcript_object) && call.transcript_object.length) {\n  htmlTranscript = call.transcript_object.map(t => `${esc(roleLabel(t.role))}: ${esc((t.content || '').trim())}`).join('<br><br>');\n  plainTranscript = call.transcript_object.map(t => `${roleLabel(t.role)}: ${(t.content || '').trim()}`).join('\\n\\n');\n}\n\nconst payload = {\n  subject,\n  html: `\n  <style>\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; line-height:1.6; color:#333; }\n    .container { border:1px solid #e0e0e0; padding:25px; border-radius:8px; max-width:700px; background:#f9f9f9; }\n    h2 { color:#0056b3; border-bottom:2px solid #e0e0e0; padding-bottom:8px; margin-top:25px; }\n    .transcript-box { background:#fff; padding:15px; border:1px solid #ddd; border-radius:5px; margin-top:10px; white-space:pre-wrap; }\n    a { color:#0056b3; text-decoration:none; }\n    a:hover { text-decoration:underline; }\n    \n    /* --- NEW TABLE STYLES --- */\n    .summary-table { \n      width: 100%; \n      border-collapse: collapse; \n      margin-top: 15px; \n      background: #fff; \n      border: 1px solid #ddd;\n    }\n    .summary-table th, .summary-table td { \n      border-bottom: 1px solid #e7e7e7; \n      padding: 10px 12px; \n      text-align: left; \n      font-size: 0.95em; \n    }\n    .summary-table th { \n      background-color: #f7f7f7; \n      color: #333; \n      width: 30%; \n      font-weight: 600; \n    }\n    .summary-table td { \n      color: #555; \n    }\n    /* --- END NEW STYLES --- */\n  </style>\n  <div class=\"container\">\n    <h2>Call Summary</h2>\n    \n    <table class=\"summary-table\">\n      <tr><th>From</th><td>${esc(normAU(call.from_number) || 'N/A')}</td></tr>\n      <tr><th>To</th><td>${esc(normAU(call.to_number) || 'N/A')} ${esc(transfer.caller_name || '')}</td></tr>\n      <tr><th>Start Time</th><td>${esc(start_local || 'N/A')}</td></tr>\n      <tr><th>End Time</th><td>${esc(end_local || 'N/A')}</td></tr>\n      <tr><th>Duration</th><td>${esc(duration_h)}</td></tr>\n      <tr><th>Status</th><td>${esc(call.call_status || 'unknown')}</td></tr>\n      <tr><th>Disconnect Reason</th><td>${esc(call.disconnection_reason || 'N/A')}</td></tr>\n      <tr><th>Total Duration (s)</th><td>${esc(String(call.call_cost?.total_duration_seconds || 0))}</td></tr>\n      <tr><th>Total Cost (AUD)</th><td>${esc(String((call.call_cost?.combined_cost || 0) / 100))}</td></tr>\n      <tr><th>Recording URL</th><td><a href=\"${esc(call.recording_url || '')}\">${esc(call.recording_url || 'N/A')}</a></td></tr>\n      <tr><th>Public Log URL</th><td><a href=\"${esc(call.public_log_url || '')}\">${esc(call.public_log_url || 'N/A')}</a></td></tr>\n    </table>\n    <h2>Transcript</h2>\n    <div class=\"transcript-box\">${htmlTranscript}</div>\n\n    <div class=\"footer\" style=\"margin-top:30px; font-size:0.9em; color:#777; text-align:center;\">\n      <p>Powered by Yes AI Consultants Australia <a href=\"https://www.YesAI.au\">www.YesAI.au</a></p>\n    </div>\n  </div>\n  `,\n  // expose fields for downstream IF and sheet\n  direction,\n  duration_ms,\n  sheet: {\n    call_id: call.call_id || 'Unknown',\n    agent_id: call.agent_id || 'N/A',\n    agent_version: call.agent_version || 'N/A',\n    status: call.call_status || 'unknown',\n    start_time: start_local || 'N/A',\n    end_time: end_local || 'N/A',\n    duration_ms,\n    human_duration: duration_h,\n    plain_transcript: plainTranscript,\n    recording_url: call.recording_url || 'N/A',\n    public_log_url: call.public_log_url || 'N/A',\n    disconnection_reason: call.disconnection_reason || 'N/A',\n    from_number: normAU(call.from_number) || 'N/A',\n    to_number: normAU(call.to_number) || 'N/A',\n    caller_name: transfer.caller_name || '',\n    direction,\n    batch_call_id: call.batch_call_id || 'N/A',\n    total_cost_aud: (call.call_cost?.combined_cost || 0) / 100,\n    total_duration_seconds: call.call_cost?.total_duration_seconds || 0,\n    sentiment: 'N/A',\n    call_type_custom: 'N/A',\n    opt_out_storage: call.opt_out_sensitive_data_storage || false,\n    opt_in_signed_url: call.opt_in_signed_url || 'N/A',\n    workflow_name: $workflow.name,\n    processed_timestamp: (new Date()).toLocaleString('en-AU', { timeZone: 'Australia/Melbourne' })\n  }\n};\n\nreturn [{ json: payload }];"},"id":"2d5c1d26-b46c-4462-b2e5-1d67d737b230","name":"Compose Email & Sheet Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-240,160]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"typeValidation":"strict","leftValue":""},"conditions":[{"leftValue":"={{ $json.direction }}","rightValue":"inbound","operator":{"type":"string","operation":"equals"}},{"leftValue":"={{ $json.duration_ms }}","rightValue":10000,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"93af438c-c565-424b-8502-82857a431fdd","name":"Is Inbound Call > 10s?","type":"n8n-nodes-base.if","typeVersion":2,"position":[0,336]},{"parameters":{"sendTo":"peter@yesai.au","subject":"={{$json.subject}}","message":"={{$json.html}}","options":{}},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[240,288],"id":"16542b07-4bd5-4791-a203-d6c39a1397c3","name":"Send End of Call Summary","webhookId":"6d1b5781-deb4-4107-bfa1-52fdc668cbc6","credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}},{"parameters":{"jsCode":"return [{ json: { email_sent: true, success: true, message: 'End of Call Summary email sent' } }];"},"id":"1c09e70f-5575-43f7-860e-0d3938f1f600","name":"Success JSON for Retell","type":"n8n-nodes-base.code","typeVersion":2,"position":[464,208]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"00f9331a-5d6a-4165-93c8-0129d538234b","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[688,208]},{"parameters":{"jsCode":"return [{ json: ($json.sheet || {}) }];"},"id":"4fa31739-3f96-462f-94ab-9f36012226d3","name":"Build Sheet Row","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,48]},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1kNx5YBa-YvPKOVutfQlXUNlU9KoB1T118g583i4gLNY","mode":""},"sheetName":{"__rl":true,"value":1594861138,"mode":"list","cachedResultName":"Call Emails","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1kNx5YBa-YvPKOVutfQlXUNlU9KoB1T118g583i4gLNY/edit#gid=1594861138"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":[],"schema":[{"id":"subject","displayName":"subject","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"html","displayName":"html","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"processedTimestamp","displayName":"processedTimestamp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"callerName","displayName":"callerName","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"fromPhone","displayName":"fromPhone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"toNumber","displayName":"toNumber","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"callbackPhone","displayName":"callbackPhone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"village","displayName":"village","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"intent","displayName":"intent","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"urgency","displayName":"urgency","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"patientId","displayName":"patientId","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"details","displayName":"details","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"startTime","displayName":"startTime","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"endTime","displayName":"endTime","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"duration","displayName":"duration","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"durationSeconds","displayName":"durationSeconds","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"callStatus","displayName":"callStatus","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"disconnect","displayName":"disconnect","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"direction","displayName":"direction","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"recordingUrl","displayName":"recordingUrl","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"plainTranscript","displayName":"plainTranscript","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"agentId","displayName":"agentId","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"agentVersion","displayName":"agentVersion","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"callId","displayName":"callId","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"transferId","displayName":"transferId","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{"cellFormat":"USER_ENTERED"}},"id":"6d540857-6447-4db9-a3cb-a1445e96dc6c","name":"Google Sheets - Log Call","type":"n8n-nodes-base.googleSheets","typeVersion":4,"position":[240,48],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"jsCode":"const ended = !!$json.ended; const shouldSend = Number($json.should_send)===1;\nlet message;\nif (!ended) message = 'Ignored: not call_ended';\nelse message = 'Skipped: email already sent for this call_id';\nreturn [{ json: { success: true, email_sent: false, message } }];"},"id":"540d07df-1ebf-4947-8b0c-a9586b23b57f","name":"Skip JSON","type":"n8n-nodes-base.code","typeVersion":2,"position":[-928,336]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"fa3ee617-7371-4cdc-b6c6-57ace9b1eddb","name":"Respond (Skip)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-704,336]}],"connections":{"Webhook":{"main":[[{"node":"Is Call Ended?","type":"main","index":0}]]},"Is Call Ended?":{"main":[[{"node":"Postgres: Claim Send Once","type":"main","index":0}]]},"Postgres: Claim Send Once":{"main":[[{"node":"IF: Should Send?","type":"main","index":0}]]},"IF: Should Send?":{"main":[[{"node":"Postgres Load Transfer","type":"main","index":0}],[{"node":"Skip JSON","type":"main","index":0}]]},"Postgres Load Transfer":{"main":[[{"node":"Compose Email & Sheet Data","type":"main","index":0}]]},"Compose Email & Sheet Data":{"main":[[{"node":"Build Sheet Row","type":"main","index":0},{"node":"Is Inbound Call > 10s?","type":"main","index":0}]]},"Is Inbound Call > 10s?":{"main":[[{"node":"Send End of Call Summary","type":"main","index":0}]]},"Send End of Call Summary":{"main":[[{"node":"Success JSON for Retell","type":"main","index":0}]]},"Success JSON for Retell":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Build Sheet Row":{"main":[[{"node":"Google Sheets - Log Call","type":"main","index":0}]]},"Skip JSON":{"main":[[{"node":"Respond (Skip)","type":"main","index":0}]]},"Google Sheets - Log Call":{"main":[[]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"ddcf3fe6-8023-48db-86e8-7c674dd9f59d","triggerCount":1,"shared":[{"updatedAt":"2025-10-31T03:22:05.804Z","createdAt":"2025-10-31T03:22:05.804Z","role":"workflow:owner","workflowId":"p39d05GlPx6at2aG","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-10-31T03:39:26.259Z","createdAt":"2025-10-31T03:38:02.500Z","id":"0jW4MiCpMovOFqBG","name":"Retell - List Appointments","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/list-appointments","responseMode":"lastNode","responseData":"allEntries","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"03b91466-889d-4c20-9659-e59ca3213f4c","name":"Webhook: List Appointments","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-144,320],"webhookId":"13732d15-a4c1-49a8-86a4-6eb1d7ac930e"},{"parameters":{"conditions":{"boolean":[],"number":[],"string":[{"value1":"={{ $json.body.name }}","operation":"equals","value2":"list_upcoming_appointments"}]}},"id":"c9860082-ac6a-4a9c-b5d7-03548db262a6","name":"IF: is list_upcoming_appointments","type":"n8n-nodes-base.if","typeVersion":1,"position":[128,320]},{"parameters":{"language":"javascript"},"id":"c4c51f59-5c3c-4863-9b11-82346d7c61ee","name":"Fetch Appointments from Cliniko","type":"n8n-nodes-base.code","typeVersion":2,"position":[416,192]},{"parameters":{"language":"javascript"},"id":"d933d01d-221b-446a-8033-04bf171eb05c","name":"Format Appointments for AI","type":"n8n-nodes-base.code","typeVersion":2,"position":[704,192]},{"parameters":{"language":"javascript"},"id":"ee3be539-11be-4401-b0af-b8e7d07def8f","name":"Return: Not a List Request","type":"n8n-nodes-base.code","typeVersion":2,"position":[416,432]},{"parameters":{"options":{}},"id":"80045253-9a73-4de8-ba70-ed501241bd2b","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[960,192]}],"connections":{"Webhook: List Appointments":{"main":[[{"node":"IF: is list_upcoming_appointments","type":"main","index":0}]]},"IF: is list_upcoming_appointments":{"main":[[{"node":"Fetch Appointments from Cliniko","type":"main","index":0}],[{"node":"Return: Not a List Request","type":"main","index":0}]]},"Fetch Appointments from Cliniko":{"main":[[{"node":"Format Appointments for AI","type":"main","index":0}]]},"Format Appointments for AI":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Return: Not a List Request":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"5a451db0-a9c0-437a-9ed6-7e05976dabd8","triggerCount":1,"shared":[{"updatedAt":"2025-10-31T03:38:02.500Z","createdAt":"2025-10-31T03:38:02.500Z","role":"workflow:owner","workflowId":"0jW4MiCpMovOFqBG","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-24T05:10:47.048Z","createdAt":"2025-10-31T22:35:55.024Z","id":"Dg2T2OVGhwwRBLfp","name":"RetellAI - Get Class Contact (Google Sheets)","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-class-contact","responseMode":"responseNode","options":{}},"id":"265942c4-b47c-4145-b1b3-c4cb0ab09792","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-736,48],"webhookId":"get-class-contact"},{"parameters":{"documentId":{"__rl":true,"value":"13EaXjEQKRye-hWmtHAMnDmKJgwp34O2iGk-ldwqm9uI","mode":"id"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/13EaXjEQKRye-hWmtHAMnDmKJgwp34O2iGk-ldwqm9uI/edit#gid=0"},"options":{}},"id":"0b418374-30fc-42de-ac3f-4d9911d25e28","name":"Google Sheets - Read Villages","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[-512,-32],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"mode":"passThrough","options":{}},"id":"f0157360-9d90-4942-83f0-6dc050841076","name":"Merge (Sheets + Webhook)","type":"n8n-nodes-base.merge","typeVersion":2.1,"position":[-288,48]},{"parameters":{"jsCode":"\n// Universal Phone Normalization (Australian E.164) - v9.09\n\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n\n  // 1. Strip everything except digits and '+'\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n\n  // 2. Already in E.164 format\n  if (phone.startsWith('+')) {\n    return phone;\n  }\n\n  // 3. Handle 8-digit local numbers (Assume NSW '02')\n  if (phone.length === 8 && !phone.startsWith('+')) {\n    return '+612' + phone;\n  }\n\n  // 4. Handle standard 10-digit AU numbers (04... or 02...)\n  if (phone.length === 10 && phone.startsWith('0')) {\n    return '+61' + phone.substring(1);\n  }\n\n  // 5. Handle numbers starting with 61 (missing +)\n  if (phone.length === 11 && phone.startsWith('61')) {\n    return '+' + phone;\n  }\n\n  // 6. Assume Australian if 9 digits (missing leading 0)\n  if (phone.length === 9) {\n    return '+61' + phone;\n  }\n\n  // 7. Return cleaned version (best effort)\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n\n// Input 1: Google Sheets rows; Input 2: Webhook body\\nconst webhook = $input.first(1)?.json || {};\\nconst body = webhook.body || {};\\n\\nfunction norm(s){ return String(s || '').trim().toLowerCase(); }\\nconst requestedVillage = norm(body.village || body.village_name || '');\\nconst classRaw = norm(body.class_type || body.class || '');\\n\\n// Alias map (clients often say 'Exercise Physiology' instead of EP)\\nconst aliasMap = [\\n  { a: ['consult room','consult','clinic','physio'], k: 'consult_room', display: 'Consult Room' },\\n  { a: ['better balance','balance','bb'], k: 'better_balance', display: 'Better Balance' },\\n  { a: ['aqua','pool','hydro','hydrotherapy'], k: 'aqua', display: 'Aqua' },\\n  { a: ['gym fit','gymfit','gym'], k: 'gymfit', display: 'Gym Fit' },\\n  { a: ['exercise physiology','exercise phys','ep','ep class'], k: 'ep_class', display: 'Exercise Physiology' }\\n];\\nfunction mapClass(s){\\n  if(!s) return { key: 'consult_room', display: 'Consult Room' };\\n  for(const {a,k,display} of aliasMap){ if(a.some(v=> s.includes(v))) return { key: k, display }; }\\n  return { key: 'consult_room', display: 'Consult Room' };\\n}\\nconst cls = mapClass(classRaw);\\n\\n// Get all rows from Input 1 (Sheets)\\nconst rows = $input.all(0).map(it => it.json);\\nif(!rows.length){\\n  return [{ json: { found:false, error:'No village data found', timestamp:new Date().toISOString() } }];\\n}\\n\\n// Case-insensitive column getter\\nfunction pick(row, candidates){\\n  const keys = Object.keys(row);\\n  for(const cand of candidates){\\n    const k = keys.find(K => K.toLowerCase() === String(cand).toLowerCase());\\n    if(k) return String(row[k] ?? '').trim();\\n  }\\n  return '';\\n}\\n\\nfunction classAddress(row, key){\\n  const cols = {\\n    consult_room: ['Consult_Room','Consultation_Room','Consult Address','Consult_Address','Consult location','Clinic_Address','Address','consult_room'],\\n    better_balance: ['Better_Balance','Balance','BB','Better_Balance_Address','better_balance'],\\n    aqua: ['Aqua','Aqua_Address','Aqua Location','Pool','aqua'],\\n    gymfit: ['GymFit','Gym_Fit','Gym','Gymfit','Gymfit_Address','gymfit'],\\n    ep_class: ['EP_Class','Exercise_Phys','Exercise_Physiology','EP_Address','EP Class','exercise physiology','ep_class']\\n  };\\n  return pick(row, cols[key] || []);\\n}\\n\\n// If no village provided, return a directory (handy for menus)\\nif(!requestedVillage){\\n  const villages = rows.map(r => ({\\n    village: pick(r, ['Village','Village_Name','village','Name']),\\n    suburb: pick(r, ['Suburb','Town','City','suburb']),\\n    contact_name: pick(r, ['Contact_Name','Coordinator','Contact','Manager_Name','contact_name']),\\n    contact_phone: pick(r, ['Contact_Phone','Phone','contact_phone']),\\n    contact_email: pick(r, ['Email','contact_email'])\\n  })).filter(v => v.village);\\n  return [{ json: { found:true, village_count:villages.length, villages, message:`Directory of ${villages.length} villages`, timestamp:new Date().toISOString() } }];\\n}\\n\\n// Find best match (substring match either way)\\nlet match = null;\\nfor(const r of rows){\\n  const name = pick(r, ['Village','Village_Name','village','Name']);\\n  const n = norm(name);\\n  if(!n) continue;\\n  if(n.includes(requestedVillage) || requestedVillage.includes(n)){ match = r; break; }\\n}\\n\\nif(!match){\\n  return [{ json: { found:false, requested_village: body.village || '', message:`No village matching '${body.village || ''}'`, timestamp:new Date().toISOString() } }];\\n}\\n\\nconst villageName = pick(match, ['Village','Village_Name','village','Name']);\\nconst suburb = pick(match, ['Suburb','Town','City','suburb']);\\nconst baseAddress = pick(match, ['Address','Clinic_Address','address']);\\nconst addr = classAddress(match, cls.key) || baseAddress || '';\\n\\nconst contact = {\\n  name: pick(match, ['Contact_Name','Coordinator','Contact','Manager_Name','contact_name']),\\n  phone: pick(match, ['Contact_Phone','Phone','contact_phone']),\\n  email: pick(match, ['Email','contact_email'])\\n};\\n\\nreturn [{ json: {\\n  found: !!addr,\\n  village: villageName,\\n  suburb,\\n  class_type: cls.key,\\n  friendly_class_type: cls.display,\\n  address: addr,\\n  contact_name: contact.name || '',\\n  contact_phone: contact.phone || '',\\n  contact_email: contact.email || '',\\n  classes: {\\n    consult_room: classAddress(match,'consult_room') || '',\\n    better_balance: classAddress(match,'better_balance') || '',\\n    aqua: classAddress(match,'aqua') || '',\\n    gymfit: classAddress(match,'gymfit') || '',\\n    ep_class: classAddress(match,'ep_class') || ''\\n  },\\n  timestamp: new Date().toISOString()\\n} }];"},"id":"f6fbe409-9265-4cf2-8301-053d913fcd2c","name":"Lookup Class Contact (Sheets)","type":"n8n-nodes-base.code","typeVersion":2,"position":[-80,48]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"ff4525b9-57b7-4469-94d3-cf18f2c2faa5","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[160,48]}],"connections":{"Google Sheets - Read Villages":{"main":[[{"node":"Merge (Sheets + Webhook)","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Merge (Sheets + Webhook)","type":"main","index":1}]]},"Merge (Sheets + Webhook)":{"main":[[{"node":"Lookup Class Contact (Sheets)","type":"main","index":0}]]},"Lookup Class Contact (Sheets)":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"c07697ff-e6d0-4edf-8d5b-c2a1c438a5ae","triggerCount":1,"shared":[{"updatedAt":"2025-10-31T22:35:55.024Z","createdAt":"2025-10-31T22:35:55.024Z","role":"workflow:owner","workflowId":"Dg2T2OVGhwwRBLfp","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-03T00:50:42.182Z","createdAt":"2025-11-02T22:34:35.992Z","id":"8kCWwyCKR5FQuSt9","name":"Reignite - Add to Sara Approval Queue v2.0 UNIFIED","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/add-to-sara-approval","options":{}},"id":"0250c2c6-de77-47d6-8a7c-ab8f663c0ba4","name":"Webhook Trigger","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[752,128],"webhookId":"reignite-sara-approval"},{"parameters":{"jsCode":"// UNIFIED EMAIL TEMPLATE v2.0 - Sara Approval Queue\n// Uses same table format as Sara Transfer for consistency\n\nconst data = $input.item.json;\n\n// HTML escape\nconst esc = (s) => String(s ?? '').replace(/[&<>\"']/g, c => (\n  {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[c]\n));\n\n// Subject - unified format\nconst subject = `[Reignite] Booking Approval: ${data.client_name || 'Unknown'}`;\n\n// Table styles - same as Sara Transfer\nconst td = 'style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"';\nconst th = 'style=\"padding:8px 10px;border:1px solid #e5e7eb;background:#f9fafb;text-align:left;font-weight:600;font-family:Arial,Helvetica,sans-serif;font-size:13px;line-height:18px;color:#111827\"';\n\n// Build links section\nconst clinikoLink = data.booking_id ? `https://reignitehealth.cliniko.com/appointments/${data.booking_id}` : null;\nconst sheetLink = 'https://docs.google.com/spreadsheets/d/1-OXnCJtYRa1h3C7HENhbxlDixLJWJYtsi-VebGiD3Tc/edit';\n\nlet linksBlock = `\n  <tr><td ${th} colspan=\"2\">Actions</td></tr>\n`;\nif (clinikoLink) {\n  linksBlock += `<tr><td ${td}><strong>View in Cliniko</strong></td><td ${td}><a href=\"${esc(clinikoLink)}\">${esc(clinikoLink)}</a></td></tr>`;\n}\nlinksBlock += `<tr><td ${td}><strong>Review in Sheet</strong></td><td ${td}><a href=\"${esc(sheetLink)}\">Open Sara Approval Queue</a></td></tr>`;\n\n// Build HTML using unified table format\nconst html = `\n  <table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\"\n         style=\"border-collapse:collapse;width:100%;max-width:780px;border:1px solid #e5e7eb\">\n    <tr><td ${th} colspan=\"2\">Client Details</td></tr>\n    <tr><td ${td} style=\"width:240px\"><strong>Name</strong></td><td ${td}>${esc(data.client_name || 'Unknown')}</td></tr>\n    <tr><td ${td}><strong>Cliniko ID</strong></td><td ${td}>${esc(data.cliniko_id || 'N/A')}</td></tr>\n    <tr><td ${td}><strong>Village</strong></td><td ${td}>${esc(data.village || 'N/A')}</td></tr>\n    <tr><td ${td}><strong>New Client</strong></td><td ${td}>${esc(data.is_new_client || 'Unknown')}</td></tr>\n\n    <tr><td ${th} colspan=\"2\">Booking Details</td></tr>\n    <tr><td ${td}><strong>Service</strong></td><td ${td}>${esc(data.service_type || 'N/A')}</td></tr>\n    <tr><td ${td}><strong>Date/Time</strong></td><td ${td}>${esc(data.booking_date_time || 'N/A')}</td></tr>\n    <tr><td ${td}><strong>Practitioner</strong></td><td ${td}>${esc(data.practitioner || 'N/A')}</td></tr>\n    <tr><td ${td}><strong>Payment Method</strong></td><td ${td}>${esc(data.payment_method || 'N/A')}</td></tr>\n\n    <tr><td ${th} colspan=\"2\">Special Notes</td></tr>\n    <tr><td ${td} colspan=\"2\" style=\"background:#fff\">${esc(data.special_notes || 'None')}</td></tr>\n\n    ${linksBlock}\n\n    <tr><td ${th} colspan=\"2\">Technical</td></tr>\n    <tr><td ${td}><strong>Booking ID</strong></td><td ${td}>${esc(data.booking_id || 'N/A')}</td></tr>\n    <tr><td ${td}><strong>Flagged At</strong></td><td ${td}>${new Date().toISOString()}</td></tr>\n  </table>\n  <div style=\"font-family:Arial,Helvetica,sans-serif;font-size:12px;color:#6b7280;margin-top:10px\">\n    Powered by Yes AI <a href=\"https://www.YesAI.au\" style=\"color:#6b7280;text-decoration:none\">www.YesAI.au</a>\n  </div>\n`;\n\nreturn [{\n  json: {\n    ...data,\n    email_subject: subject,\n    email_html: html\n  }\n}];"},"id":"compose-unified-email","name":"Compose Email (UNIFIED)","type":"n8n-nodes-base.code","typeVersion":2,"position":[960,128]},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1-OXnCJtYRa1h3C7HENhbxlDixLJWJYtsi-VebGiD3Tc","mode":"id"},"sheetName":{"__rl":true,"value":2141551618,"mode":"list","cachedResultName":"13_sara_approval_queue","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1-OXnCJtYRa1h3C7HENhbxlDixLJWJYtsi-VebGiD3Tc/edit#gid=2141551618"},"options":{}},"id":"e20bed3f-ad39-410a-844f-7c686c7d6b18","name":"Append to Sara Approval Queue","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[1168,128],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"sendTo":"peter@yesai.au","subject":"={{ $('Compose Email (UNIFIED)').item.json.email_subject }}","message":"={{ $('Compose Email (UNIFIED)').item.json.email_html }}","options":{}},"id":"cbfd6bc8-4cd6-451d-8975-7ef5b2e137f5","name":"Send Email to Sara","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[1376,128],"webhookId":"3a773d97-8f4c-4688-9a9a-07dd856d1e83","credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}},{"parameters":{"assignments":{"assignments":[{"id":"1","name":"success","value":true,"type":"boolean"},{"id":"2","name":"message","value":"Added to approval queue and email sent","type":"string"},{"id":"3","name":"timestamp","value":"={{ new Date().toISOString() }}","type":"string"}]},"options":{}},"id":"1c4f9135-d6e7-4656-b4ec-1429c831860c","name":"Format Success Response","type":"n8n-nodes-base.set","typeVersion":3,"position":[1584,128]}],"connections":{"Webhook Trigger":{"main":[[{"node":"Compose Email (UNIFIED)","type":"main","index":0}]]},"Compose Email (UNIFIED)":{"main":[[{"node":"Append to Sara Approval Queue","type":"main","index":0}]]},"Append to Sara Approval Queue":{"main":[[{"node":"Send Email to Sara","type":"main","index":0}]]},"Send Email to Sara":{"main":[[{"node":"Format Success Response","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"65a12079-e673-42c1-8ca6-822c599246d1","triggerCount":1,"shared":[{"updatedAt":"2025-11-02T22:34:35.992Z","createdAt":"2025-11-02T22:34:35.992Z","role":"workflow:owner","workflowId":"8kCWwyCKR5FQuSt9","projectId":"ePBcCsWsgvLDebw1"}],"tags":[{"updatedAt":"2025-11-02T22:31:37.089Z","createdAt":"2025-11-02T22:31:37.089Z","id":"SOCEgV0wWUgzAwbd","name":"Reignite Health"}]},{"updatedAt":"2025-11-18T01:37:29.089Z","createdAt":"2025-11-03T01:40:39.292Z","id":"ngyFYeyhHBgEQwlx","name":"Reignite - Add to Follow-Up List","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/add-to-followup","options":{}},"id":"03e874a4-4cff-4142-90f6-c3ae955705e7","name":"Webhook Trigger","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[784,192],"webhookId":"reignite-add-followup"},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"14dWZbvNykFox06a4UhHj1UBc5PI-iwZAog5Ia6iQUrw","mode":"id"},"sheetName":{"__rl":true,"value":372162973,"mode":"list","cachedResultName":"12_follow_up_list","cachedResultUrl":"https://docs.google.com/spreadsheets/d/14dWZbvNykFox06a4UhHj1UBc5PI-iwZAog5Ia6iQUrw/edit#gid=372162973"},"options":{}},"id":"71d8b263-6800-498d-9a4e-99bd6427dde6","name":"Append to Follow-Up List","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[992,192],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"options":{}},"id":"37c5df22-1472-468d-b8fa-75c90da2f38b","name":"Format Success Response","type":"n8n-nodes-base.set","typeVersion":3,"position":[1184,192]},{"parameters":{"errorMessage":"={{ $json.message }}"},"id":"2424d398-daa7-4a11-b65d-7a33bff20e49","name":"Error Handler","type":"n8n-nodes-base.stopAndError","typeVersion":1,"position":[1184,400],"onError":"continueErrorOutput"}],"connections":{"Webhook Trigger":{"main":[[{"node":"Append to Follow-Up List","type":"main","index":0}]]},"Append to Follow-Up List":{"main":[[{"node":"Format Success Response","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"3790f67f-170e-47d1-a161-f2575610d852","triggerCount":1,"shared":[{"updatedAt":"2025-11-03T01:40:39.292Z","createdAt":"2025-11-03T01:40:39.292Z","role":"workflow:owner","workflowId":"ngyFYeyhHBgEQwlx","projectId":"ePBcCsWsgvLDebw1"}],"tags":[{"updatedAt":"2025-11-02T22:31:37.089Z","createdAt":"2025-11-02T22:31:37.089Z","id":"SOCEgV0wWUgzAwbd","name":"Reignite Health"}]},{"updatedAt":"2025-11-04T09:48:07.729Z","createdAt":"2025-11-03T22:08:25.840Z","id":"Dmkv2uvBrxt04FRC","name":"Cliniko Incremental Sync v2","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"hours"}]}},"id":"b1183434-b63b-476b-9f39-f71217817506","name":"Hourly Sync Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.1,"position":[-2192,224]},{"parameters":{"operation":"executeQuery","query":"-- Create patients table if it doesn't exist\nCREATE TABLE IF NOT EXISTS patients (\n  patient_id BIGINT PRIMARY KEY,\n  first_name VARCHAR(100),\n  last_name VARCHAR(100),\n  preferred_name VARCHAR(100),\n  email VARCHAR(255),\n  phone VARCHAR(50),\n  phone_normalized VARCHAR(20),\n  phone_mobile VARCHAR(50),\n  phone_mobile_normalized VARCHAR(20),\n  date_of_birth DATE,\n  address VARCHAR(500),\n  city VARCHAR(100),\n  state VARCHAR(50),\n  postcode VARCHAR(20),\n  village VARCHAR(100),\n  archived BOOLEAN DEFAULT FALSE,\n  last_synced TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- Add cliniko_updated_at column if it doesn't exist (for existing tables)\nDO $$ \nBEGIN\n    IF NOT EXISTS (\n        SELECT 1 FROM information_schema.columns \n        WHERE table_name = 'patients' AND column_name = 'cliniko_updated_at'\n    ) THEN\n        ALTER TABLE patients ADD COLUMN cliniko_updated_at TIMESTAMP;\n    END IF;\nEND $$;\n\nCREATE INDEX IF NOT EXISTS idx_phone_normalized ON patients(phone_normalized) WHERE phone_normalized IS NOT NULL;\nCREATE INDEX IF NOT EXISTS idx_phone_mobile_normalized ON patients(phone_mobile_normalized) WHERE phone_mobile_normalized IS NOT NULL;\nCREATE INDEX IF NOT EXISTS idx_name_village ON patients(first_name, last_name, village) WHERE archived = FALSE;\nCREATE INDEX IF NOT EXISTS idx_name_dob ON patients(first_name, last_name, date_of_birth) WHERE archived = FALSE;\nCREATE INDEX IF NOT EXISTS idx_archived ON patients(archived);\nCREATE INDEX IF NOT EXISTS idx_cliniko_updated_at ON patients(cliniko_updated_at);\n\n-- Create sync_metadata table to track last sync time\nCREATE TABLE IF NOT EXISTS sync_metadata (\n  sync_key VARCHAR(50) PRIMARY KEY,\n  last_sync_time TIMESTAMP,\n  last_sync_completed TIMESTAMP,\n  records_synced INTEGER DEFAULT 0\n);\n\n-- Initialize sync metadata if not exists\nINSERT INTO sync_metadata (sync_key, last_sync_time, last_sync_completed, records_synced)\nVALUES ('cliniko_patients', '2020-01-01 00:00:00', CURRENT_TIMESTAMP, 0)\nON CONFLICT (sync_key) DO NOTHING;","options":{}},"id":"b8abac07-6b02-462c-88c2-afacafbd2b80","name":"Initialize Postgres Tables","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-2000,224],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"operation":"executeQuery","query":"SELECT last_sync_time FROM sync_metadata WHERE sync_key = 'cliniko_patients';","options":{}},"id":"ac8e22cb-91e9-43ad-b082-41ed1f0a1474","name":"Get Last Sync Time","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-1792,224],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Get last sync time and format it for Cliniko API\nconst lastSyncTime = $json.last_sync_time;\nconst lastSyncDate = new Date(lastSyncTime);\n\n// Format as ISO 8601 (Cliniko expects this format)\nconst formattedDate = lastSyncDate.toISOString();\n\nconsole.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');\nconsole.log('‚ïë  ü•º CLINIKO INCREMENTAL SYNC STARTED       ‚ïë');\nconsole.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');\nconsole.log(`üìÖ Last sync: ${formattedDate}`);\nconsole.log(`üîÑ Fetching records updated since last sync...`);\n\nreturn {\n  json: {\n    last_sync_time: formattedDate,\n    sync_started: new Date().toISOString()\n  }\n};"},"id":"34ec7c2b-1fe2-4c91-b975-489e11acb106","name":"Format Last Sync Time","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1600,224]},{"parameters":{"url":"https://api.au2.cliniko.com/v1/patients","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"per_page","value":"100"},{"name":"page","value":"1"},{"name":"updated_since","value":"={{ $json.last_sync_time }}"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"},{"name":"Accept","value":"application/json"}]},"options":{"response":{"response":{"responseFormat":"json"}}}},"id":"e02175b3-5083-453b-a9ca-12c0676e9f19","name":"Get Page 1 for Count","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-1392,224],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"jsCode":"// Calculate how many pages exist\nconst response = $input.item.json;\nconst totalEntries = response.total_entries || 0;\nconst perPage = 100;\nconst totalPages = Math.ceil(totalEntries / perPage);\n\nconsole.log(`üìä Updated/New patients: ${totalEntries}`);\nconsole.log(`üìÑ Pages to fetch: ${totalPages}`);\n\n// If no updates, return empty array to skip fetching\nif (totalEntries === 0) {\n  console.log('‚úÖ No updates found - skipping sync');\n  return [];\n}\n\n// Create array of ALL page numbers (including page 1)\nconst allPages = [];\nfor (let i = 1; i <= totalPages; i++) {\n  allPages.push({ \n    page: i,\n    last_sync_time: $input.first().json.last_sync_time,\n    sync_started: $input.first().json.sync_started\n  });\n}\n\nreturn allPages.map(p => ({ json: p }));"},"id":"235db8af-912c-4279-b46f-7c6261094b3f","name":"Generate Page Numbers","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1200,224]},{"parameters":{"url":"https://api.au2.cliniko.com/v1/patients","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"per_page","value":"100"},{"name":"page","value":"={{ $json.page }}"},{"name":"updated_since","value":"={{ $json.last_sync_time }}"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"},{"name":"Accept","value":"application/json"}]},"options":{"batching":{"batch":{"batchSize":5}},"response":{"response":{"responseFormat":"json"}}}},"id":"ee2df76e-49b2-4356-9b51-41460e60a23c","name":"Fetch All Pages","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-992,224],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"aggregate":"aggregateAllItemData","destinationFieldName":"allPageData","options":{}},"id":"fc97e75f-27c9-4ce5-bf72-aa46411d1233","name":"Aggregate All Pages","type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-800,224]},{"parameters":{"jsCode":"// Extract ALL patients from ALL pages and prepare for Postgres\nconst allPageData = $json.allPageData;\n\nconsole.log(`üì¶ Received ${allPageData.length} pages`);\n\nconst allPatients = [];\n\nfor (const pageData of allPageData) {\n  const patients = pageData.patients || [];\n  allPatients.push(...patients);\n}\n\nconsole.log(`‚úÖ TOTAL PATIENTS TO UPDATE: ${allPatients.length}`);\n\n// If no patients, return early\nif (allPatients.length === 0) {\n  return [];\n}\n\nconst rows = allPatients.map(patient => {\n  // Extract phone numbers from patient_phone_numbers array\n  let phoneNormalized = '';\n  let phoneMobileNormalized = '';\n  let phoneOriginal = '';\n  let mobileOriginal = '';\n  \n  if (patient.patient_phone_numbers && Array.isArray(patient.patient_phone_numbers)) {\n    // Find mobile phone\n    const mobilePhone = patient.patient_phone_numbers.find(p => \n      p.phone_type && p.phone_type.toLowerCase() === 'mobile'\n    );\n    \n    if (mobilePhone) {\n      phoneMobileNormalized = mobilePhone.normalized_number ? '+' + mobilePhone.normalized_number : '';\n      mobileOriginal = mobilePhone.number || '';\n    }\n    \n    // Find any other phone (Home, Work, etc)\n    const otherPhone = patient.patient_phone_numbers.find(p => \n      p.phone_type && p.phone_type.toLowerCase() !== 'mobile'\n    );\n    \n    if (otherPhone) {\n      phoneNormalized = otherPhone.normalized_number ? '+' + otherPhone.normalized_number : '';\n      phoneOriginal = otherPhone.number || '';\n    }\n    \n    // If no other phone, use mobile for both\n    if (!phoneNormalized && phoneMobileNormalized) {\n      phoneNormalized = phoneMobileNormalized;\n      phoneOriginal = mobileOriginal;\n    }\n  }\n  \n  // Extract village from address_3\n  const village = patient.address_3 || '';\n  \n  // Build full address\n  const addressParts = [\n    patient.address_1,\n    patient.address_2\n  ].filter(part => part && part.trim());\n  const address = addressParts.join(', ');\n  \n  // Return data for Postgres\n  return {\n    patient_id: patient.id || 0,\n    first_name: patient.first_name || '',\n    last_name: patient.last_name || '',\n    preferred_name: patient.preferred_first_name || '',\n    email: patient.email || '',\n    phone: phoneOriginal,\n    phone_normalized: phoneNormalized,\n    phone_mobile: mobileOriginal,\n    phone_mobile_normalized: phoneMobileNormalized,\n    date_of_birth: patient.date_of_birth || null,\n    address: address,\n    city: patient.city || '',\n    state: patient.state || '',\n    postcode: patient.post_code || '',\n    village: village,\n    archived: patient.archived_at ? true : false,\n    last_synced: new Date().toISOString(),\n    cliniko_updated_at: patient.updated_at || new Date().toISOString()\n  };\n});\n\nconsole.log(`‚úÖ Successfully processed ${rows.length} patients for upsert`);\n\nreturn rows.map(row => ({ json: row }));"},"id":"a8caca61-80b3-4553-be72-55d59e2c1804","name":"Extract and Process Updated Patients","type":"n8n-nodes-base.code","typeVersion":2,"position":[-592,224]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO patients (\n  patient_id, first_name, last_name, preferred_name, email,\n  phone, phone_normalized, phone_mobile, phone_mobile_normalized,\n  date_of_birth, address, city, state, postcode, village,\n  archived, last_synced, cliniko_updated_at\n) VALUES (\n  {{ $json.patient_id }},\n  {{ $json.first_name ? \"'\" + $json.first_name.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n  {{ $json.last_name ? \"'\" + $json.last_name.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n  {{ $json.preferred_name ? \"'\" + $json.preferred_name.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n  {{ $json.email ? \"'\" + $json.email.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n  {{ $json.phone ? \"'\" + $json.phone.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n  {{ $json.phone_normalized ? \"'\" + $json.phone_normalized.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n  {{ $json.phone_mobile ? \"'\" + $json.phone_mobile.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n  {{ $json.phone_mobile_normalized ? \"'\" + $json.phone_mobile_normalized.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n  {{ $json.date_of_birth ? \"'\" + $json.date_of_birth + \"'\" : 'NULL' }},\n  {{ $json.address ? \"'\" + $json.address.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n  {{ $json.city ? \"'\" + $json.city.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n  {{ $json.state ? \"'\" + $json.state.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n  {{ $json.postcode ? \"'\" + $json.postcode.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n  {{ $json.village ? \"'\" + $json.village.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n  {{ $json.archived }},\n  '{{ $json.last_synced }}',\n  {{ $json.cliniko_updated_at ? \"'\" + $json.cliniko_updated_at + \"'\" : 'NULL' }}\n)\nON CONFLICT (patient_id) DO UPDATE SET\n  first_name = EXCLUDED.first_name,\n  last_name = EXCLUDED.last_name,\n  preferred_name = EXCLUDED.preferred_name,\n  email = EXCLUDED.email,\n  phone = EXCLUDED.phone,\n  phone_normalized = EXCLUDED.phone_normalized,\n  phone_mobile = EXCLUDED.phone_mobile,\n  phone_mobile_normalized = EXCLUDED.phone_mobile_normalized,\n  date_of_birth = EXCLUDED.date_of_birth,\n  address = EXCLUDED.address,\n  city = EXCLUDED.city,\n  state = EXCLUDED.state,\n  postcode = EXCLUDED.postcode,\n  village = EXCLUDED.village,\n  archived = EXCLUDED.archived,\n  last_synced = EXCLUDED.last_synced,\n  cliniko_updated_at = EXCLUDED.cliniko_updated_at;","options":{}},"id":"fc84d672-25a6-4522-baac-249a9d22713e","name":"Upsert to Postgres","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-400,224],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"aggregate":"aggregateAllItemData","destinationFieldName":"upsertResults","options":{}},"id":"e7b9bd46-33e4-4f87-9ec9-eb94b18ad074","name":"Aggregate Upsert Results","type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-192,224]},{"parameters":{"operation":"executeQuery","query":"-- Update sync metadata with current time\nUPDATE sync_metadata \nSET \n  last_sync_time = CURRENT_TIMESTAMP,\n  last_sync_completed = CURRENT_TIMESTAMP,\n  records_synced = records_synced + {{ $json.upsertResults.length }}\nWHERE sync_key = 'cliniko_patients'\nRETURNING *;","options":{}},"id":"f9ab5ba3-0544-4029-bc76-e5f1d94e26b6","name":"Update Sync Metadata","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[16,224],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"operation":"executeQuery","query":"SELECT \n  COUNT(*) as total_patients,\n  COUNT(*) FILTER (WHERE phone_normalized IS NOT NULL OR phone_mobile_normalized IS NOT NULL) as with_phone,\n  COUNT(*) FILTER (WHERE village IS NOT NULL AND village != '') as with_village,\n  COUNT(*) FILTER (WHERE date_of_birth IS NOT NULL) as with_dob,\n  COUNT(*) FILTER (WHERE archived = TRUE) as archived_count,\n  COUNT(*) FILTER (WHERE archived = FALSE) as active_count,\n  MAX(last_synced) as last_sync_time,\n  (SELECT records_synced FROM sync_metadata WHERE sync_key = 'cliniko_patients') as total_synced\nFROM patients;","options":{}},"id":"015ba8d1-deb8-42cf-b2ac-cacb042a5b5e","name":"Get Sync Statistics","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[816,224],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"const stats = $json;\nconst recordsUpdated = $('Aggregate Upsert Results').first().json.upsertResults?.length || 0;\n\nconsole.log('\\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');\nconsole.log('‚ïë  ü•º CLINIKO INCREMENTAL SYNC DONE     ‚ïë');\nconsole.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');\nconsole.log(`üîÑ Records updated: ${recordsUpdated}`);\nconsole.log(`üìä Total patients: ${stats.total_patients}`);\nconsole.log(`üì± With phone: ${stats.with_phone}`);\nconsole.log(`üèòÔ∏è  With village: ${stats.with_village}`);\nconsole.log(`üéÇ With DOB: ${stats.with_dob}`);\nconsole.log(`‚úÖ Active: ${stats.active_count}`);\nconsole.log(`üì¶ Archived: ${stats.archived_count}`);\nconsole.log(`üìà Total sync operations: ${stats.total_synced}`);\nconsole.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\\n');\n\nreturn {\n  json: {\n    success: true,\n    sync_type: 'incremental',\n    records_updated: recordsUpdated,\n    sync_completed_at: new Date().toISOString(),\n    destinations: ['Postgres', 'Google Sheets'],\n    ...stats\n  }\n};"},"id":"fa8666ec-6185-4777-b26e-38504f8b7791","name":"Log Sync Results","type":"n8n-nodes-base.code","typeVersion":2,"position":[1008,224]}],"connections":{"Hourly Sync Trigger":{"main":[[{"node":"Initialize Postgres Tables","type":"main","index":0}]]},"Initialize Postgres Tables":{"main":[[{"node":"Get Last Sync Time","type":"main","index":0}]]},"Get Last Sync Time":{"main":[[{"node":"Format Last Sync Time","type":"main","index":0}]]},"Format Last Sync Time":{"main":[[{"node":"Get Page 1 for Count","type":"main","index":0}]]},"Get Page 1 for Count":{"main":[[{"node":"Generate Page Numbers","type":"main","index":0}]]},"Generate Page Numbers":{"main":[[{"node":"Fetch All Pages","type":"main","index":0}]]},"Fetch All Pages":{"main":[[{"node":"Aggregate All Pages","type":"main","index":0}]]},"Aggregate All Pages":{"main":[[{"node":"Extract and Process Updated Patients","type":"main","index":0}]]},"Extract and Process Updated Patients":{"main":[[{"node":"Upsert to Postgres","type":"main","index":0}]]},"Upsert to Postgres":{"main":[[{"node":"Aggregate Upsert Results","type":"main","index":0}]]},"Aggregate Upsert Results":{"main":[[{"node":"Update Sync Metadata","type":"main","index":0}]]},"Update Sync Metadata":{"main":[[{"node":"Get Sync Statistics","type":"main","index":0}]]},"Get Sync Statistics":{"main":[[{"node":"Log Sync Results","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Hourly Sync Trigger":{"recurrenceRules":[]}},"meta":null,"pinData":{},"versionId":"2269b468-8ac3-45b7-82fc-105d7354a203","triggerCount":1,"shared":[{"updatedAt":"2025-11-03T22:08:25.840Z","createdAt":"2025-11-03T22:08:25.840Z","role":"workflow:owner","workflowId":"Dmkv2uvBrxt04FRC","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-03T18:05:04.539Z","createdAt":"2025-12-02T06:03:16.472Z","id":"5irNzq6GP9FNVfvZ","name":"RetellAI - Get Class Schedule v1.9 OPTIMIZED","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-class-schedule","responseMode":"responseNode","options":{}},"id":"webhook-main","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,200],"webhookId":"get-class-schedule"},{"parameters":{"jsCode":"// Extract and validate request parameters with FUZZY VILLAGE MATCHING\n// v1.9: OPTIMIZED - resolved values used for EXACT match queries\nconst body = $json.body || $json;\nconst args = body.args || {};\nconst call = body.call || {};\n\n// ============================================\n// CLASS NAME ALIASES - v1.7\n// Maps common spoken names to actual database class names\n// ============================================\nconst CLASS_ALIASES = {\n  // Hydrotherapy aliases\n  'aqua': 'Hydrotherapy',\n  'aqua class': 'Hydrotherapy',\n  'aqua therapy': 'Hydrotherapy',\n  'aquatic': 'Hydrotherapy',\n  'aquatics': 'Hydrotherapy',\n  'hydro': 'Hydrotherapy',\n  'hydrotherapy': 'Hydrotherapy',\n  'water': 'Hydrotherapy',\n  'water class': 'Hydrotherapy',\n  'pool': 'Hydrotherapy',\n  'pool class': 'Hydrotherapy',\n  'swimming': 'Hydrotherapy',\n  \n  // Better Balance aliases\n  'balance': 'Better Balance',\n  'better balance': 'Better Balance',\n  'falls': 'Better Balance',\n  'falls prevention': 'Better Balance',\n  'fall prevention': 'Better Balance',\n  'balance class': 'Better Balance',\n  \n  // Gym Fit aliases\n  'gym': 'Gym Fit',\n  'gym fit': 'Gym Fit',\n  'gymfit': 'Gym Fit',\n  'gym class': 'Gym Fit',\n  'fitness': 'Gym Fit',\n  'strength': 'Gym Fit',\n  'strength training': 'Gym Fit',\n  \n  // Pilates aliases\n  'pilates': 'Pilates',\n  'mat pilates': 'Pilates',\n  \n  // Tai Chi aliases\n  'tai chi': 'Tai Chi',\n  'taichi': 'Tai Chi',\n  'tai-chi': 'Tai Chi'\n};\n\n// Function to resolve class name from alias\nfunction resolveClassName(input) {\n  if (!input) return 'Better Balance';\n  const normalized = input.toLowerCase().trim();\n  \n  // Direct alias match\n  if (CLASS_ALIASES[normalized]) {\n    return CLASS_ALIASES[normalized];\n  }\n  \n  // Partial match - check if input contains any alias key\n  for (const [alias, canonical] of Object.entries(CLASS_ALIASES)) {\n    if (normalized.includes(alias) || alias.includes(normalized)) {\n      return canonical;\n    }\n  }\n  \n  // No match - return original (will search as-is in database)\n  return input.trim();\n}\n\n// Known villages - MUST match actual database values in group_appointments_with_details\nconst KNOWN_VILLAGES = [\n  'The Baytree',\n  'Glenaeon',\n  'Henry Kendall',\n  'Oak Village',\n  'The Peninsula',\n  'Banksia Village',\n  'Harbourside Haven',\n  'Lakeside Gardens',\n  'Riverside Lodge',\n  'Gordon Quarter'\n];\n\n// DATABASE ALIASES: Maps user-facing name to what's actually in Cliniko/database\nconst DB_ALIASES = {};\n\n// Phonetic/fuzzy matching helpers\nfunction normalizeVillage(name) {\n  if (!name) return '';\n  return String(name)\n    .toLowerCase()\n    .trim()\n    .replace(/^the\\s+/i, '')\n    .replace(/[^a-z0-9\\s]/g, '')\n    .replace(/\\s+/g, ' ');\n}\n\nfunction phoneticCode(str) {\n  if (!str) return '';\n  const s = normalizeVillage(str);\n  return s\n    .replace(/ph/g, 'f')\n    .replace(/ck/g, 'k')\n    .replace(/gh/g, '')\n    .replace(/wr/g, 'r')\n    .replace(/kn/g, 'n')\n    .replace(/wh/g, 'w')\n    .replace(/[aeiou]/g, '')\n    .replace(/(.)\\1+/g, '$1');\n}\n\nfunction levenshtein(a, b) {\n  if (!a || !b) return 100;\n  a = normalizeVillage(a);\n  b = normalizeVillage(b);\n  if (a === b) return 0;\n  \n  const matrix = [];\n  for (let i = 0; i <= b.length; i++) matrix[i] = [i];\n  for (let j = 0; j <= a.length; j++) matrix[0][j] = j;\n  \n  for (let i = 1; i <= b.length; i++) {\n    for (let j = 1; j <= a.length; j++) {\n      if (b[i-1] === a[j-1]) {\n        matrix[i][j] = matrix[i-1][j-1];\n      } else {\n        matrix[i][j] = Math.min(\n          matrix[i-1][j-1] + 1,\n          matrix[i][j-1] + 1,\n          matrix[i-1][j] + 1\n        );\n      }\n    }\n  }\n  return matrix[b.length][a.length];\n}\n\nfunction similarityScore(input, candidate) {\n  const normInput = normalizeVillage(input);\n  const normCandidate = normalizeVillage(candidate);\n  \n  if (normInput === normCandidate) return 100;\n  if (normCandidate.includes(normInput) || normInput.includes(normCandidate)) return 90;\n  \n  const phoneticInput = phoneticCode(input);\n  const phoneticCandidate = phoneticCode(candidate);\n  if (phoneticInput === phoneticCandidate) return 85;\n  \n  const maxLen = Math.max(normInput.length, normCandidate.length);\n  const distance = levenshtein(input, candidate);\n  const similarity = Math.round((1 - distance / maxLen) * 100);\n  \n  const phoneticDistance = levenshtein(phoneticInput, phoneticCandidate);\n  if (phoneticDistance <= 2) return Math.min(100, similarity + 15);\n  \n  return similarity;\n}\n\nfunction findBestVillageMatches(input, threshold = 50) {\n  if (!input) return [];\n  \n  const scores = KNOWN_VILLAGES.map(village => ({\n    village,\n    score: similarityScore(input, village)\n  }));\n  \n  return scores\n    .filter(s => s.score >= threshold)\n    .sort((a, b) => b.score - a.score)\n    .slice(0, 3);\n}\n\n// Extract parameters\nconst rawClassType = args.class_type || body.class_type || 'Better Balance';\nconst rawVillage = args.village || body.village || 'Baytree';\nconst weeks_ahead = Math.min(args.weeks_ahead || body.weeks_ahead || 4, 8); // v1.9: Cap at 8 weeks max\n\n// v1.8: Extract requested date - if user asks for a specific date, use it!\nconst rawRequestedDate = args.date || body.date || null;\nlet requestedDate = null;\nlet requestedDateInfo = { provided: false };\n\nif (rawRequestedDate) {\n  // Parse the date - could be YYYY-MM-DD or other formats\n  const parsed = new Date(rawRequestedDate);\n  if (!isNaN(parsed.getTime())) {\n    requestedDate = parsed.toISOString().split('T')[0];\n    requestedDateInfo = {\n      provided: true,\n      raw_input: rawRequestedDate,\n      parsed_date: requestedDate\n    };\n  }\n}\n\n// If no date provided or invalid, default to today\nconst today = new Date().toISOString().split('T')[0];\nconst effectiveDate = requestedDate || today;\n\n// Resolve class type from alias (v1.7)\nconst resolvedClassType = resolveClassName(rawClassType);\nconst classTypeMatchInfo = {\n  input: rawClassType,\n  resolved_to: resolvedClassType,\n  was_alias: rawClassType.toLowerCase().trim() !== resolvedClassType.toLowerCase()\n};\n\n// Find best village matches\nconst villageMatches = findBestVillageMatches(rawVillage);\nconst bestMatch = villageMatches[0];\n\nlet resolvedVillage = rawVillage;\nlet villageMatchInfo = {\n  input: rawVillage,\n  matched: false,\n  exact: false,\n  candidates: villageMatches\n};\n\nif (bestMatch && bestMatch.score >= 70) {\n  resolvedVillage = bestMatch.village;\n  villageMatchInfo.matched = true;\n  villageMatchInfo.exact = bestMatch.score === 100;\n  villageMatchInfo.resolved_to = resolvedVillage;\n  villageMatchInfo.confidence = bestMatch.score;\n}\n\n// Get database search term (may differ from canonical name due to Cliniko typos)\nconst villageForDb = DB_ALIASES[resolvedVillage] || resolvedVillage;\n\n// v1.9: Cache key includes date for date-specific caching\nconst cache_key = `class_schedule_v6_${normalizeVillage(resolvedVillage).replace(/\\s+/g, '_')}_${resolvedClassType.toLowerCase().replace(/\\s+/g, '_')}_${effectiveDate}`;\n\nif (!rawClassType || rawClassType === '') {\n  throw new Error('Missing class_type');\n}\n\nif (!rawVillage || rawVillage === '') {\n  throw new Error('Missing village');\n}\n\nreturn [{\n  json: {\n    class_type: resolvedClassType,\n    class_type_input: rawClassType,\n    class_type_match: classTypeMatchInfo,\n    village: resolvedVillage,\n    village_db: villageForDb,\n    village_input: rawVillage,\n    village_match: villageMatchInfo,\n    weeks_ahead: weeks_ahead,\n    requested_date: effectiveDate,\n    requested_date_info: requestedDateInfo,\n    cache_key: cache_key,\n    call_id: call.call_id || args.call_id || 'manual-test',\n    request_timestamp: new Date().toISOString(),\n    start_time: Date.now(),\n    version: 'v1.9-optimized'\n  }\n}];"},"id":"extract-request","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[220,200]},{"parameters":{"operation":"executeQuery","query":"SELECT id, cache_key, data, cached_at FROM webhook_cache WHERE cache_key = '{{ $json.cache_key }}' AND cached_at > NOW() - INTERVAL '2 hours' LIMIT 1;","options":{}},"id":"check-cache","name":"Check Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[440,200],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Handle cache check result - v1.9 OPTIMIZED\n// CRITICAL: Generate spoken_text even from cached data\nconst cacheItems = $input.all();\nconst requestData = $('Extract Request Data').first().json;\n\n// Helper functions for spoken_text generation\nfunction formatDateSpoken(dateStr) {\n  const date = new Date(dateStr);\n  const day = date.getDate();\n  const month = date.toLocaleDateString('en-AU', { month: 'long' });\n  const suffix = (day > 3 && day < 21) ? 'th' : ['st', 'nd', 'rd'][(day % 10) - 1] || 'th';\n  return `${day}${suffix} of ${month}`;\n}\n\nfunction getDayName(dateStr) {\n  return new Date(dateStr).toLocaleDateString('en-AU', { weekday: 'long' });\n}\n\nfunction formatTime(dateStr) {\n  return new Date(dateStr).toLocaleTimeString('en-AU', { hour: 'numeric', minute: '2-digit', hour12: true });\n}\n\nfunction generateSpokenText(data) {\n  if (!data) return '';\n  \n  // For failure case\n  if (data.success === false) {\n    const village = data.village || 'your village';\n    const classType = data.class_type || 'Better Balance';\n    return `I'm sorry, there are no ${classType} classes currently scheduled at ${village}. Would you like me to check a different class type, or would you prefer I organise a callback from Sara to discuss options?`;\n  }\n  \n  // For success case\n  const session = data.next_session;\n  if (!session) return '';\n  \n  const dayName = session.day_name || getDayName(session.date);\n  const dateSpoken = formatDateSpoken(session.date);\n  const timeFormatted = session.time || '10:00 am';\n  const spaces = session.spaces_available || 0;\n  const spacesText = spaces === 1 ? '1 spot' : `${spaces} spots`;\n  \n  let text = `The next ${data.class_type} class at ${data.village} is on ${dayName}, the ${dateSpoken} at ${timeFormatted}. There are ${spacesText} available.`;\n  \n  if (data.recurring_pattern) {\n    text += ` This class runs every ${data.recurring_pattern.day} at ${data.recurring_pattern.time}.`;\n  }\n  \n  text += ' Would you like me to book a spot for you?';\n  return text;\n}\n\n// Check if we have valid cache data\nconst hasValidCache = \n  cacheItems.length > 0 && \n  cacheItems[0].json && \n  cacheItems[0].json.id && \n  cacheItems[0].json.data;\n\nif (hasValidCache) {\n  const cached = cacheItems[0].json;\n  const cachedData = typeof cached.data === 'string' ? JSON.parse(cached.data) : cached.data;\n  const duration_ms = Date.now() - requestData.start_time;\n  \n  // Generate spoken_text if not present in cached data\n  const spoken_text = cachedData.spoken_text || generateSpokenText(cachedData);\n  \n  return [{\n    json: {\n      ...cachedData,\n      spoken_text: spoken_text,\n      message: spoken_text,\n      from_cache: true,\n      cache_hit: true,\n      cached_at: cached.cached_at,\n      duration_ms: duration_ms,\n      call_id: requestData.call_id,\n      village_match: requestData.village_match,\n      class_type_match: requestData.class_type_match,\n      timestamp: new Date().toISOString(),\n      version: 'v1.9-optimized'\n    }\n  }];\n}\n\n// Cache MISS - pass request data for database query\nreturn [{\n  json: {\n    ...requestData,\n    from_cache: false,\n    cache_hit: false\n  }\n}];"},"id":"handle-cache","name":"Handle Cache Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[660,200]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"cache-hit-condition","leftValue":"={{ $json.cache_hit }}","rightValue":true,"operator":{"type":"boolean","operation":"equals","singleValue":true}}],"combinator":"and"},"options":{}},"id":"cache-check-if","name":"Cache Hit?","type":"n8n-nodes-base.if","typeVersion":2,"position":[880,200]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-cache-hit","name":"Respond Cache Hit","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1100,100]},{"parameters":{"operation":"executeQuery","query":"-- v1.9 OPTIMIZED: Exact match queries, 60-day hard cap\n-- Uses view for enriched village/class_type data\nSELECT \n    id,\n    appointment_type_name,\n    starts_at,\n    ends_at,\n    duration_minutes,\n    max_attendees,\n    attendee_count,\n    spaces_available,\n    village,\n    business_name,\n    is_cancelled,\n    last_synced,\n    class_type\nFROM group_appointments_with_details\nWHERE class_type = '{{ $json.class_type }}'\n  AND village = '{{ $json.village_db }}'\n  AND starts_at >= '{{ $json.requested_date }}'::date\n  AND starts_at < NOW() + INTERVAL '60 days'\n  AND is_cancelled = false\n  AND is_deleted = false\nORDER BY starts_at ASC\nLIMIT 10;","options":{}},"id":"query-appointments","name":"Query Group Appointments","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1100,300],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Format response with SPOKEN_TEXT - v1.9 OPTIMIZED\n// CRITICAL: Returns spoken_text for agent to read verbatim\nconst items = $input.all();\nconst requestData = $('Cache Hit?').first().json;\nconst duration_ms = Date.now() - requestData.start_time;\n\n// Helper functions\nfunction formatDateSpoken(dateStr) {\n  const date = new Date(dateStr);\n  const day = date.getDate();\n  const month = date.toLocaleDateString('en-AU', { month: 'long' });\n  return `${day}${getOrdinalSuffix(day)} of ${month}`;\n}\n\nfunction getOrdinalSuffix(day) {\n  if (day > 3 && day < 21) return 'th';\n  switch (day % 10) {\n    case 1: return 'st';\n    case 2: return 'nd';\n    case 3: return 'rd';\n    default: return 'th';\n  }\n}\n\nfunction formatDate(dateStr) {\n  const date = new Date(dateStr);\n  return date.toISOString().split('T')[0];\n}\n\nfunction formatTime(dateStr) {\n  const date = new Date(dateStr);\n  return date.toLocaleTimeString('en-AU', { \n    hour: 'numeric', \n    minute: '2-digit',\n    hour12: true \n  });\n}\n\nfunction getDayName(dateStr) {\n  const date = new Date(dateStr);\n  return date.toLocaleDateString('en-AU', { weekday: 'long' });\n}\n\nfunction detectRecurringPattern(sessions) {\n  if (sessions.length < 2) return null;\n  \n  const days = sessions.map(s => new Date(s.starts_at).getDay());\n  const times = sessions.map(s => formatTime(s.starts_at));\n  \n  if (days.every(d => d === days[0]) && times.every(t => t === times[0])) {\n    return {\n      day: getDayName(sessions[0].starts_at),\n      time: times[0],\n      frequency: 'Weekly'\n    };\n  }\n  return null;\n}\n\n// NO RESULTS - Generate spoken_text\nif (items.length === 0 || !items[0].json.starts_at) {\n  const villageMatch = requestData.village_match || {};\n  const classTypeMatch = requestData.class_type_match || {};\n  const requestedVillage = requestData.village || '';\n  const classType = requestData.class_type || 'Better Balance';\n  \n  let spoken_text = `I'm sorry, there are no ${classType} classes currently scheduled at ${requestedVillage}. Would you like me to check a different class type, or would you prefer I organise a callback from Sara to discuss options?`;\n  \n  return [{\n    json: {\n      success: false,\n      message: spoken_text,\n      spoken_text: spoken_text,\n      class_type: classType,\n      class_type_input: requestData.class_type_input,\n      class_type_match: classTypeMatch,\n      village: requestedVillage,\n      village_input: requestData.village_input,\n      village_match: villageMatch,\n      requested_date: requestData.requested_date,\n      requested_date_info: requestData.requested_date_info,\n      call_id: requestData.call_id,\n      timestamp: new Date().toISOString(),\n      duration_ms: duration_ms,\n      from_cache: false,\n      cache_hit: false,\n      cache_key: requestData.cache_key,\n      version: 'v1.9-optimized'\n    }\n  }];\n}\n\n// SUCCESS - Format class details with spoken_text\nconst sessions = items.map(item => item.json);\nconst nextSession = sessions[0];\nconst recurringPattern = detectRecurringPattern(sessions);\n\nconst lastSynced = new Date(nextSession.last_synced);\nconst now = new Date();\nconst cacheAgeHours = Math.floor((now - lastSynced) / (1000 * 60 * 60));\n\nconst villageMatch = requestData.village_match || {};\nconst classTypeMatch = requestData.class_type_match || {};\n\n// Build spoken_text for success\nconst dayName = getDayName(nextSession.starts_at);\nconst dateSpoken = formatDateSpoken(nextSession.starts_at);\nconst timeFormatted = formatTime(nextSession.starts_at);\nconst spacesText = nextSession.spaces_available === 1 ? '1 spot' : `${nextSession.spaces_available} spots`;\n\nlet spoken_text = `The next ${requestData.class_type} class at ${requestData.village} is on ${dayName}, the ${dateSpoken} at ${timeFormatted}. There are ${spacesText} available.`;\n\n// Add recurring pattern if detected\nif (recurringPattern) {\n  spoken_text += ` This class runs every ${recurringPattern.day} at ${recurringPattern.time}.`;\n}\n\nspoken_text += ` Would you like me to book a spot for you?`;\n\nreturn [{\n  json: {\n    success: true,\n    spoken_text: spoken_text,\n    message: spoken_text,\n    next_class_id: nextSession.id,\n    class_type: requestData.class_type,\n    class_type_input: requestData.class_type_input,\n    class_type_match: classTypeMatch,\n    village: requestData.village,\n    village_input: requestData.village_input,\n    village_match: villageMatch,\n    next_session: {\n      id: nextSession.id,\n      date: formatDate(nextSession.starts_at),\n      day_name: dayName,\n      time: timeFormatted,\n      duration_minutes: nextSession.duration_minutes,\n      spaces_available: nextSession.spaces_available,\n      max_capacity: nextSession.max_attendees,\n      location: nextSession.business_name\n    },\n    upcoming_sessions: sessions.slice(0, 4).map(s => ({\n      id: s.id,\n      date: formatDate(s.starts_at),\n      day_name: getDayName(s.starts_at),\n      time: formatTime(s.starts_at),\n      spaces: s.spaces_available,\n      max: s.max_attendees\n    })),\n    recurring_pattern: recurringPattern,\n    total_sessions_found: sessions.length,\n    requested_date: requestData.requested_date,\n    requested_date_info: requestData.requested_date_info,\n    call_id: requestData.call_id,\n    timestamp: new Date().toISOString(),\n    from_cache: false,\n    cache_hit: false,\n    cache_age_hours: cacheAgeHours,\n    duration_ms: duration_ms,\n    cache_key: requestData.cache_key,\n    version: 'v1.9-optimized'\n  }\n}];"},"id":"format-response","name":"Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1320,300]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_cache (cache_key, data, cached_at) VALUES ('{{ $json.cache_key }}', '{{ JSON.stringify($json).replace(/'/g, \"''\") }}'::jsonb, NOW()) ON CONFLICT (cache_key) DO UPDATE SET data = EXCLUDED.data, cached_at = EXCLUDED.cached_at RETURNING *;","options":{}},"id":"store-cache","name":"Store in Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1540,300],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Extract the response data from Format Response (before cache storage)\nconst formatResponse = $('Format Response').first();\nif (formatResponse && formatResponse.json) {\n  return [{ json: formatResponse.json }];\n}\n\n// Fallback: try to get data from cache storage result\nconst result = $input.item.json;\nif (result && result.data) {\n  const data = typeof result.data === 'string' ? JSON.parse(result.data) : result.data;\n  return [{ json: data }];\n}\n\nreturn $input.all();"},"id":"prepare-response","name":"Prepare Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1760,300]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-miss","name":"Respond Cache Miss","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1980,300]}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Check Cache","type":"main","index":0}]]},"Check Cache":{"main":[[{"node":"Handle Cache Result","type":"main","index":0}]]},"Handle Cache Result":{"main":[[{"node":"Cache Hit?","type":"main","index":0}]]},"Cache Hit?":{"main":[[{"node":"Respond Cache Hit","type":"main","index":0}],[{"node":"Query Group Appointments","type":"main","index":0}]]},"Query Group Appointments":{"main":[[{"node":"Format Response","type":"main","index":0}]]},"Format Response":{"main":[[{"node":"Store in Cache","type":"main","index":0}]]},"Store in Cache":{"main":[[{"node":"Prepare Response","type":"main","index":0}]]},"Prepare Response":{"main":[[{"node":"Respond Cache Miss","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"b5fd2504-3591-4c09-81ac-d77d0660d86b","triggerCount":1,"shared":[{"updatedAt":"2025-12-02T06:03:16.472Z","createdAt":"2025-12-02T06:03:16.472Z","role":"workflow:owner","workflowId":"5irNzq6GP9FNVfvZ","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-03T01:51:07.569Z","createdAt":"2025-12-03T01:51:06.871Z","id":"E48p1dxkZm2WdQ2y","name":"Cliniko Weekly Deleted Patient Purge v1.0","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"triggerAtHour":2,"triggerAtMinute":35,"weekday":6}]}},"id":"weekly-trigger","name":"Weekly Saturday 2:35am","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.1,"position":[0,300]},{"parameters":{"operation":"executeQuery","query":"-- Get all non-deleted patient IDs from Postgres\nSELECT \n  patient_id,\n  first_name,\n  last_name,\n  village\nFROM patients \nWHERE deleted = false OR deleted IS NULL\nORDER BY patient_id;","options":{}},"id":"get-all-patients","name":"Get All Patient IDs","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[220,300],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Split patients into batches of 10 for API checking\nconst patients = $input.all().map(item => item.json);\nconst batchSize = 10;\nconst batches = [];\n\nconsole.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');\nconsole.log('‚ïë  üßπ WEEKLY DELETED PATIENT PURGE v1.0             ‚ïë');\nconsole.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');\nconsole.log(`üìä Total patients to check: ${patients.length}`);\n\nfor (let i = 0; i < patients.length; i += batchSize) {\n  const batch = patients.slice(i, i + batchSize);\n  batches.push({\n    batch_number: Math.floor(i / batchSize) + 1,\n    total_batches: Math.ceil(patients.length / batchSize),\n    patients: batch\n  });\n}\n\nconsole.log(`üì¶ Created ${batches.length} batches of ${batchSize} patients each`);\n\nreturn batches.map(b => ({ json: b }));"},"id":"create-batches","name":"Create Batches of 10","type":"n8n-nodes-base.code","typeVersion":2,"position":[440,300]},{"parameters":{"jsCode":"// Check each patient in the batch against Cliniko API\nconst batch = $json;\nconst deletedPatients = [];\nconst existingPatients = [];\nconst errors = [];\n\nfor (const patient of batch.patients) {\n  try {\n    const response = await this.helpers.httpRequest({\n      method: 'GET',\n      url: `https://api.au2.cliniko.com/v1/patients/${patient.patient_id}`,\n      auth: {\n        username: $credentials.httpBasicAuth.user,\n        password: $credentials.httpBasicAuth.password\n      },\n      headers: {\n        'User-Agent': 'Reignite Health AI (peter@yesai.au)',\n        'Accept': 'application/json'\n      },\n      returnFullResponse: true,\n      ignoreHttpStatusErrors: true\n    });\n    \n    if (response.statusCode === 404 || response.statusCode === 410) {\n      // Patient deleted in Cliniko\n      deletedPatients.push(patient);\n      console.log(`üóëÔ∏è DELETED: ${patient.first_name} ${patient.last_name} (${patient.patient_id})`);\n    } else if (response.statusCode === 200) {\n      existingPatients.push(patient);\n    } else {\n      errors.push({ patient, status: response.statusCode });\n      console.log(`‚ö†Ô∏è Unexpected status ${response.statusCode} for ${patient.patient_id}`);\n    }\n  } catch (error) {\n    errors.push({ patient, error: error.message });\n    console.log(`‚ùå Error checking ${patient.patient_id}: ${error.message}`);\n  }\n  \n  // Small delay to avoid rate limiting (100ms between requests)\n  await new Promise(resolve => setTimeout(resolve, 100));\n}\n\nconsole.log(`Batch ${batch.batch_number}/${batch.total_batches}: ${deletedPatients.length} deleted, ${existingPatients.length} exist, ${errors.length} errors`);\n\nreturn [{\n  json: {\n    batch_number: batch.batch_number,\n    total_batches: batch.total_batches,\n    deleted_patients: deletedPatients,\n    deleted_count: deletedPatients.length,\n    existing_count: existingPatients.length,\n    error_count: errors.length\n  }\n}];","options":{}},"id":"check-cliniko-batch","name":"Check Cliniko API (Batch)","type":"n8n-nodes-base.code","typeVersion":2,"position":[660,300],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"aggregate":"aggregateAllItemData","destinationFieldName":"all_batches","options":{}},"id":"aggregate-batches","name":"Aggregate All Batches","type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[880,300]},{"parameters":{"jsCode":"// Collect all deleted patients from all batches\nconst allBatches = $json.all_batches || [];\nconst allDeleted = [];\nlet totalExisting = 0;\nlet totalErrors = 0;\n\nfor (const batch of allBatches) {\n  if (batch.deleted_patients && batch.deleted_patients.length > 0) {\n    allDeleted.push(...batch.deleted_patients);\n  }\n  totalExisting += batch.existing_count || 0;\n  totalErrors += batch.error_count || 0;\n}\n\nconsole.log(`\\nüìä BATCH PROCESSING COMPLETE`);\nconsole.log(`   Total deleted found: ${allDeleted.length}`);\nconsole.log(`   Total existing: ${totalExisting}`);\nconsole.log(`   Total errors: ${totalErrors}`);\n\nif (allDeleted.length === 0) {\n  console.log('‚úÖ No deleted patients found - nothing to purge');\n  return [{ \n    json: { \n      deleted_count: 0, \n      deleted_patients: [],\n      message: 'No deleted patients found'\n    } \n  }];\n}\n\n// Build comma-separated list of IDs for SQL\nconst ids = allDeleted.map(p => p.patient_id);\nconst idsString = ids.join(',');\n\nreturn [{\n  json: {\n    deleted_patients: allDeleted,\n    deleted_count: allDeleted.length,\n    ids_string: idsString,\n    total_existing: totalExisting,\n    total_errors: totalErrors\n  }\n}];"},"id":"collect-deleted","name":"Collect All Deleted","type":"n8n-nodes-base.code","typeVersion":2,"position":[1100,300]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-deleted","leftValue":"={{ $json.deleted_count }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"if-any-deleted","name":"Any Deleted?","type":"n8n-nodes-base.if","typeVersion":2,"position":[1320,300]},{"parameters":{"operation":"executeQuery","query":"-- Mark patients as deleted in Postgres\nWITH updated AS (\n  UPDATE patients \n  SET \n    deleted = true,\n    deleted_at = CURRENT_TIMESTAMP,\n    last_synced = CURRENT_TIMESTAMP\n  WHERE patient_id IN ({{ $json.ids_string }})\n    AND (deleted = false OR deleted IS NULL)\n  RETURNING patient_id, first_name, last_name, village\n)\nSELECT \n  COUNT(*) as purged_count,\n  json_agg(json_build_object(\n    'patient_id', patient_id,\n    'name', first_name || ' ' || last_name,\n    'village', village\n  )) as purged_patients\nFROM updated;","options":{}},"id":"mark-deleted-postgres","name":"Mark Deleted in Postgres","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1540,200],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"operation":"executeQuery","query":"-- Clear cache entries for purged patients\nDELETE FROM webhook_cache \nWHERE cache_key LIKE 'caller_phone_%'\nRETURNING cache_key;","options":{}},"id":"clear-cache","name":"Clear Phone Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1760,200],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Log final results\nconst collectData = $('Collect All Deleted').first().json;\nconst purgeResult = $('Mark Deleted in Postgres').first().json;\nconst cacheCleared = $('Clear Phone Cache').all().length;\n\nconsole.log('\\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');\nconsole.log('‚ïë  üßπ WEEKLY PURGE COMPLETE                         ‚ïë');\nconsole.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');\nconsole.log(`üóëÔ∏è Patients purged: ${purgeResult.purged_count || 0}`);\nconsole.log(`üßπ Cache entries cleared: ${cacheCleared}`);\n\nif (purgeResult.purged_patients && purgeResult.purged_patients.length > 0) {\n  console.log('\\nPurged patients:');\n  for (const p of purgeResult.purged_patients) {\n    console.log(`   - ${p.name} (${p.village || 'no village'}) [ID: ${p.patient_id}]`);\n  }\n}\n\nreturn [{\n  json: {\n    success: true,\n    purged_count: purgeResult.purged_count || 0,\n    purged_patients: purgeResult.purged_patients || [],\n    cache_cleared: cacheCleared,\n    checked_count: collectData.total_existing + collectData.deleted_count,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"log-results","name":"Log Results","type":"n8n-nodes-base.code","typeVersion":2,"position":[1980,200]},{"parameters":{"jsCode":"// No deleted patients found\nconsole.log('\\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');\nconsole.log('‚ïë  üßπ WEEKLY PURGE COMPLETE - NO ACTION NEEDED      ‚ïë');\nconsole.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');\nconsole.log('‚úÖ All patients in Postgres still exist in Cliniko');\n\nreturn [{\n  json: {\n    success: true,\n    purged_count: 0,\n    message: 'No deleted patients found',\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"skip-purge","name":"Skip Purge","type":"n8n-nodes-base.code","typeVersion":2,"position":[1540,400]}],"connections":{"Weekly Saturday 2:35am":{"main":[[{"node":"Get All Patient IDs","type":"main","index":0}]]},"Get All Patient IDs":{"main":[[{"node":"Create Batches of 10","type":"main","index":0}]]},"Create Batches of 10":{"main":[[{"node":"Check Cliniko API (Batch)","type":"main","index":0}]]},"Check Cliniko API (Batch)":{"main":[[{"node":"Aggregate All Batches","type":"main","index":0}]]},"Aggregate All Batches":{"main":[[{"node":"Collect All Deleted","type":"main","index":0}]]},"Collect All Deleted":{"main":[[{"node":"Any Deleted?","type":"main","index":0}]]},"Any Deleted?":{"main":[[{"node":"Mark Deleted in Postgres","type":"main","index":0}],[{"node":"Skip Purge","type":"main","index":0}]]},"Mark Deleted in Postgres":{"main":[[{"node":"Clear Phone Cache","type":"main","index":0}]]},"Clear Phone Cache":{"main":[[{"node":"Log Results","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":{"node:Weekly Saturday 2:35am":{"recurrenceRules":[]}},"meta":null,"pinData":null,"versionId":"bae73524-91ff-4d57-843f-952d6bde5921","triggerCount":1,"shared":[{"updatedAt":"2025-12-03T01:51:06.871Z","createdAt":"2025-12-03T01:51:06.871Z","role":"workflow:owner","workflowId":"E48p1dxkZm2WdQ2y","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-03T22:47:56.308Z","createdAt":"2025-12-03T19:12:28.526Z","id":"F37DUMqjeMpQWIFA","name":"RetellAI - Enroll Class Single v1.1 FIXED","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/enroll-class-single","responseMode":"responseNode","options":{}},"id":"webhook-enroll-single","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"enroll-class-single"},{"parameters":{"jsCode":"// Extract and validate request - Enroll Class Single v1.0\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\nconst class_id = args.class_id || '';\nconst patient_id = args.patient_id || '';\nconst is_trial = args.is_trial === true || args.is_trial === 'true';\nconst village = args.village || '';\nconst class_type = args.class_type || '';  // From get_class_schedule response\nconst call_id = call.call_id || args.call_id || '';\n\n// Validation\nif (!class_id) {\n  return [{\n    json: {\n      success: false,\n      error: {\n        code: 'MISSING_CLASS_ID',\n        message: 'class_id is required'\n      },\n      call_id,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\nif (!patient_id) {\n  return [{\n    json: {\n      success: false,\n      error: {\n        code: 'MISSING_PATIENT_ID',\n        message: 'patient_id is required'\n      },\n      call_id,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    class_id,\n    patient_id,\n    is_trial,\n    village,\n    class_type,\n    call_id,\n    start_time: Date.now(),\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"extract-request","name":"Extract Request","type":"n8n-nodes-base.code","typeVersion":2,"position":[220,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-error","leftValue":"={{ $json.error }}","rightValue":"","operator":{"type":"object","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"if-validation-error","name":"Validation Error?","type":"n8n-nodes-base.if","typeVersion":2,"position":[440,0]},{"parameters":{"operation":"executeQuery","query":"-- Lookup class details from group_appointments\nSELECT \n  id,\n  cliniko_appointment_id,\n  class_type,\n  village,\n  starts_at,\n  ends_at,\n  duration_minutes,\n  max_attendees,\n  attendee_count,\n  spaces_available,\n  practitioner_id,\n  practitioner_name,\n  business_id,\n  appointment_type_id,\n  is_cancelled\nFROM group_appointments\nWHERE id = {{ $json.class_id }}\nLIMIT 1;","options":{}},"id":"lookup-class","name":"Lookup Class","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[660,100],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Check class lookup result\nconst classData = $input.all();\nconst requestData = $('Extract Request').first().json;\n\nif (!classData || classData.length === 0 || !classData[0].json.id) {\n  return [{\n    json: {\n      success: false,\n      error: {\n        code: 'CLASS_NOT_FOUND',\n        message: `Class with ID ${requestData.class_id} not found`\n      },\n      class_id: requestData.class_id,\n      patient_id: requestData.patient_id,\n      call_id: requestData.call_id,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\nconst cls = classData[0].json;\n\n// Check if class is cancelled\nif (cls.is_cancelled) {\n  return [{\n    json: {\n      success: false,\n      error: {\n        code: 'CLASS_CANCELLED',\n        message: 'This class has been cancelled'\n      },\n      class_id: requestData.class_id,\n      patient_id: requestData.patient_id,\n      call_id: requestData.call_id,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// Check if class is in the past\nconst classTime = new Date(cls.starts_at);\nif (classTime < new Date()) {\n  return [{\n    json: {\n      success: false,\n      error: {\n        code: 'CLASS_IN_PAST',\n        message: 'This class has already occurred'\n      },\n      class_id: requestData.class_id,\n      patient_id: requestData.patient_id,\n      call_id: requestData.call_id,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// Check capacity\nconst spacesAvailable = cls.spaces_available || (cls.max_attendees - (cls.attendee_count || 0));\nif (spacesAvailable <= 0) {\n  return [{\n    json: {\n      success: false,\n      error: {\n        code: 'CLASS_FULL',\n        message: 'This class is fully booked'\n      },\n      class_id: requestData.class_id,\n      patient_id: requestData.patient_id,\n      max_attendees: cls.max_attendees,\n      current_attendees: cls.attendee_count,\n      call_id: requestData.call_id,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// Format time for response (Sydney timezone)\nconst SYDNEY_TZ = 'Australia/Sydney';\nconst startDate = new Date(cls.starts_at);\n\nconst dateFormatted = startDate.toLocaleDateString('en-AU', {\n  timeZone: SYDNEY_TZ,\n  weekday: 'long',\n  day: 'numeric',\n  month: 'long',\n  year: 'numeric'\n});\n\nconst timeFormatted = startDate.toLocaleTimeString('en-AU', {\n  timeZone: SYDNEY_TZ,\n  hour: 'numeric',\n  minute: '2-digit',\n  hour12: true\n});\n\n// All checks passed - prepare for Cliniko API call\nreturn [{\n  json: {\n    ...requestData,\n    class_found: true,\n    cliniko_appointment_id: cls.cliniko_appointment_id,\n    class_type: cls.class_type,\n    class_village: cls.village,\n    starts_at: cls.starts_at,\n    ends_at: cls.ends_at,\n    duration_minutes: cls.duration_minutes,\n    max_attendees: cls.max_attendees,\n    current_attendees: cls.attendee_count || 0,\n    spaces_available: spacesAvailable,\n    practitioner_id: cls.practitioner_id,\n    practitioner_name: cls.practitioner_name,\n    business_id: cls.business_id,\n    appointment_type_id: cls.appointment_type_id,\n    date_formatted: dateFormatted,\n    time_formatted: timeFormatted\n  }\n}];"},"id":"validate-class","name":"Validate Class","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,100]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"class-valid","leftValue":"={{ $json.class_found }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"if-class-valid","name":"Class Valid?","type":"n8n-nodes-base.if","typeVersion":2,"position":[1100,100]},{"parameters":{"method":"POST","url":"https://api.au2.cliniko.com/v1/attendees","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"},{"name":"Accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ { booking_id: $json.cliniko_appointment_id, patient_id: $json.patient_id } }}","options":{}},"id":"cliniko-add-attendee","name":"Add Attendee to Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1320,0],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"// Process Cliniko API response\nconst clinikoResult = $input.item.json;\nconst requestData = $('Validate Class').first().json;\nconst duration_ms = Date.now() - requestData.start_time;\n\n// Check for Cliniko errors\nif (clinikoResult.error || clinikoResult.message) {\n  const errorStr = JSON.stringify(clinikoResult).toLowerCase();\n  \n  // Handle duplicate attendee (various formats)\n  if (errorStr.includes('already') || errorStr.includes('twice') || errorStr.includes('duplicate')) {\n    return [{\n      json: {\n        success: false,\n        error: {\n          code: 'ALREADY_ENROLLED',\n          message: 'You are already enrolled in this class'\n        },\n        class_id: requestData.class_id,\n        patient_id: requestData.patient_id,\n        class_type: requestData.class_type,\n        date_formatted: requestData.date_formatted,\n        time_formatted: requestData.time_formatted,\n        call_id: requestData.call_id,\n        duration_ms,\n        timestamp: new Date().toISOString()\n      }\n    }];\n  }\n  \n  return [{\n    json: {\n      success: false,\n      error: {\n        code: 'CLINIKO_ERROR',\n        message: clinikoResult.message || 'Failed to add attendee',\n        details: clinikoResult\n      },\n      class_id: requestData.class_id,\n      patient_id: requestData.patient_id,\n      call_id: requestData.call_id,\n      duration_ms,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// Success!\nconst attendee_id = clinikoResult.id;\nconst originalRequest = $('Extract Request').first().json;\n\n// Prefer class_type from request (agent knows it), fallback to DB\nconst classType = originalRequest.class_type || requestData.class_type || 'class';\nconst village = originalRequest.village || requestData.class_village || '';\n\nreturn [{\n  json: {\n    success: true,\n    enrollment_id: attendee_id,\n    class_id: requestData.class_id,\n    patient_id: requestData.patient_id,\n    cliniko_appointment_id: requestData.cliniko_appointment_id,\n    class_type: classType,\n    village: village,\n    date_formatted: requestData.date_formatted,\n    time_formatted: requestData.time_formatted,\n    starts_at: requestData.starts_at,\n    is_trial: requestData.is_trial,\n    practitioner_name: requestData.practitioner_name,\n    message: requestData.is_trial \n      ? `Great news! You're booked for a FREE trial ${classType} class on ${requestData.date_formatted} at ${requestData.time_formatted}.`\n      : `You're booked for ${classType} on ${requestData.date_formatted} at ${requestData.time_formatted}.`,\n    call_id: requestData.call_id,\n    duration_ms,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"process-result","name":"Process Cliniko Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[1540,0]},{"parameters":{"operation":"executeQuery","query":"-- Update attendee count in group_appointments\nUPDATE group_appointments\nSET \n  attendee_count = COALESCE(attendee_count, 0) + 1,\n  spaces_available = GREATEST(0, COALESCE(spaces_available, max_attendees) - 1),\n  updated_at = NOW()\nWHERE id = {{ $('Extract Request').first().json.class_id }}\nRETURNING id, attendee_count, spaces_available;","options":{}},"id":"update-counts","name":"Update Attendee Count","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1760,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($('Process Cliniko Result').first().json) }}","options":{}},"id":"respond-success","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2200,0]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"respond-validation-error","name":"Respond Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[660,-100]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"respond-class-error","name":"Respond Class Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1320,200]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_body,\n  response_body,\n  success,\n  duration_ms,\n  error_code,\n  created_at\n) VALUES (\n  'enroll-class-single',\n  '{{ $('Extract Request').first().json.call_id }}',\n  '{{ JSON.stringify($('Extract Request').first().json).replace(/'/g, \"''\") }}',\n  '{{ JSON.stringify($('Process Cliniko Result').first().json).replace(/'/g, \"''\") }}',\n  {{ $('Process Cliniko Result').first().json.success }},\n  {{ $('Process Cliniko Result').first().json.duration_ms || 0 }},\n  {{ $('Process Cliniko Result').first().json.error ? \"'\" + $('Process Cliniko Result').first().json.error.code + \"'\" : \"NULL\" }},\n  NOW()\n) RETURNING *;","options":{}},"id":"log-webhook","name":"Log to Database","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[2420,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true}],"connections":{"Webhook":{"main":[[{"node":"Extract Request","type":"main","index":0}]]},"Extract Request":{"main":[[{"node":"Validation Error?","type":"main","index":0}]]},"Validation Error?":{"main":[[{"node":"Respond Validation Error","type":"main","index":0}],[{"node":"Lookup Class","type":"main","index":0}]]},"Lookup Class":{"main":[[{"node":"Validate Class","type":"main","index":0}]]},"Validate Class":{"main":[[{"node":"Class Valid?","type":"main","index":0}]]},"Class Valid?":{"main":[[{"node":"Add Attendee to Cliniko","type":"main","index":0}],[{"node":"Respond Class Error","type":"main","index":0}]]},"Add Attendee to Cliniko":{"main":[[{"node":"Process Cliniko Result","type":"main","index":0}]]},"Process Cliniko Result":{"main":[[{"node":"Update Attendee Count","type":"main","index":0}]]},"Update Attendee Count":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Respond Success":{"main":[[{"node":"Log to Database","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"79e375cf-925c-402d-a8dc-367a0b657a4f","triggerCount":1,"shared":[{"updatedAt":"2025-12-03T19:12:28.526Z","createdAt":"2025-12-03T19:12:28.526Z","role":"workflow:owner","workflowId":"F37DUMqjeMpQWIFA","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-07T04:34:20.678Z","createdAt":"2025-11-06T23:12:42.691Z","id":"PU3lrxEjnwY84uuh","name":"RetellAI - Enroll in Class v6.0 FINAL WORKING","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/enroll-class","responseMode":"responseNode","options":{}},"id":"5fb59315-f626-40db-8f73-2ead6c829016","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-544,240],"webhookId":"enroll-class"},{"parameters":{"jsCode":"// Extract and validate request\nconst webhookData = $input.item.json.body || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\nconst patient_id = args.patient_id || '';\nconst class_name = args.class_name || '';\nconst village = args.village || '';\nconst day_of_week = args.day_of_week || '';\nconst time = args.time || '';\nconst funding_type = (args.funding_type || '').toUpperCase();\nconst has_ep_assessment = args.has_ep_assessment || false;\nconst start_date = args.start_date || null;\nconst call_id = call.call_id || args.call_id || '';\n\nif (!patient_id) throw new Error('patient_id is required');\nif (!class_name) throw new Error('class_name is required');\nif (!day_of_week) throw new Error('day_of_week is required');\nif (!time) throw new Error('time is required');\n\nreturn [{\n  json: {\n    patient_id,\n    class_name,\n    village,\n    day_of_week,\n    time,\n    funding_type,\n    has_ep_assessment,\n    start_date,\n    call_id,\n    start_time: Date.now(),\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"1d039820-8129-4a39-9c65-0b334b756a7b","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-320,240]},{"parameters":{"jsCode":"// === SYDNEY TIMEZONE LOGIC (from working reschedule workflow) ===\n\n// Parse time; supports \"HH:MM\", \"HH:MM:SS\", and with am/pm\nfunction parseTime(t){\n  let s = String(t||'').trim().toLowerCase().replace(/\\./g,'');\n  const ampm = (/(am|pm)$/.test(s)) ? s.slice(-2) : null;\n  if(ampm) s = s.replace(/\\s*(am|pm)$/,'');\n  const parts = s.split(':').map(n=>parseInt(n,10));\n  let h = parts[0]||0, mi = parts[1]||0, se = parts[2]||0;\n  if(ampm){\n    if(ampm==='pm' && h<12) h += 12;\n    if(ampm==='am' && h===12) h = 0;\n  }\n  if(h<0||h>23||mi<0||mi>59||se<0||se>59) throw new Error('time invalid');\n  return {h, mi, se};\n}\n\n// First Sunday (day-of-month) for a given month (1-12) in UTC math\nfunction firstSundayDOM(year, month){\n  const dt = new Date(Date.UTC(year, month-1, 1));\n  const add = (7 - dt.getUTCDay()) % 7; // 0=Sun\n  return 1 + add;\n}\n\n// Sydney DST: starts 02:00 (standard) on 1st Sunday in Oct; ends 03:00 (daylight) on 1st Sunday in Apr\nfunction isSydneyDST(y, mo, d, h, mi){\n  if(mo>=11 || mo<=3) return true;        // Nov‚ÄìMar\n  if(mo>=5 && mo<=9) return false;        // May‚ÄìSep\n  if(mo===10){                             // October\n    const fs = firstSundayDOM(y,10);\n    if(d>fs) return true;\n    if(d<fs) return false;\n    return h>=2;\n  }\n  if(mo===4){                              // April\n    const fs = firstSundayDOM(y,4);\n    if(d<fs) return true;\n    if(d>fs) return false;\n    return h<3;\n  }\n  return false;\n}\n\n// === MAIN LOGIC ===\n\nconst data = $input.item.json;\n\nconst daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\nconst targetDayIndex = daysOfWeek.indexOf(data.day_of_week);\n\nif (targetDayIndex === -1) throw new Error(`Invalid day: ${data.day_of_week}`);\n\n// Parse time\nconst {h: hours, mi: minutes, se: seconds} = parseTime(data.time);\n\n// Find first class date - at least 2 weeks from now\nlet searchDate = new Date();\nsearchDate.setDate(searchDate.getDate() + 14); // Start 2 weeks from now\n\n// Find next occurrence of target day (in local date, but we'll use the date parts only)\nwhile (searchDate.getDay() !== targetDayIndex) {\n  searchDate.setDate(searchDate.getDate() + 1);\n}\n\n// Get the date parts (YYYY-MM-DD) for first class\nconst firstYear = searchDate.getFullYear();\nconst firstMonth = searchDate.getMonth() + 1;\nconst firstDay = searchDate.getDate();\n\n// Generate series ID\nconst series_id = `CLASS_${data.class_name.replace(/\\s+/g,'_')}_${Date.now()}`;\nconst appointments = [];\n\n// Create 12 weekly appointments\nfor (let week = 0; week < 12; week++) {\n  // Calculate date for this week\n  const weekDate = new Date(searchDate);\n  weekDate.setDate(searchDate.getDate() + (week * 7));\n  \n  const y = weekDate.getFullYear();\n  const mo = weekDate.getMonth() + 1;\n  const d = weekDate.getDate();\n  \n  // Calculate if DST is active for this specific date\n  const dst = isSydneyDST(y, mo, d, hours, minutes);\n  const offsetHours = dst ? 11 : 10;\n  \n  // Compute UTC from Sydney wall time\n  const startUtcMs = Date.UTC(y, mo-1, d, hours, minutes, seconds) - offsetHours*3600*1000;\n  const endUtcMs = startUtcMs + 60*60*1000; // 1 hour duration\n  \n  const starts_at = new Date(startUtcMs).toISOString();\n  const ends_at = new Date(endUtcMs).toISOString();\n  \n  const notes = [\n    `Class: ${data.class_name}`,\n    `Village: ${data.village}`,\n    `Funding: ${data.funding_type}`,\n    `Series: ${series_id}`,\n    `Week ${week + 1} of 12`,\n    'Enrolled via Voice AI',\n    `Call: ${data.call_id}`,\n    `Offset: UTC${dst ? '+11' : '+10'} (DST: ${dst})`\n  ].join('\\n');\n  \n  appointments.push({\n    json: {\n      ...data,\n      week_number: week + 1,\n      starts_at,\n      ends_at,\n      appointment_date: `${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`,\n      notes,\n      series_id,\n      offset_hours: offsetHours,\n      dst_active: dst\n    }\n  });\n}\n\nreturn appointments;"},"id":"fca475bb-877d-4925-9b68-aebc779a7cb8","name":"Calculate 12 Dates","type":"n8n-nodes-base.code","typeVersion":2,"position":[-96,240]},{"parameters":{"method":"POST","url":"https://api.au2.cliniko.com/v1/appointments","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"},{"name":"Accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ { patient_id: $json.patient_id, practitioner_id: '473326864069303022', business_id: '675491769126754955', appointment_type_id: '472831283798480897', starts_at: $json.starts_at, ends_at: $json.ends_at, notes: $json.notes, send_sms: false } }}","options":{"batching":{"batch":{"batchSize":1}}}},"id":"b2a70e69-1eff-47b6-8707-0ae8370ac897","name":"Create Appointment in Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[128,240],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"aggregate":"aggregateAllItemData","destinationFieldName":"appointments","options":{}},"id":"5b0238f1-9455-46b2-b73d-9121f24c46d8","name":"Aggregate Results","type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[336,240]},{"parameters":{"jsCode":"// Process results\nconst items = $input.all();\nconst appointments = items[0].json.appointments || [];\n\nconst successful = appointments.filter(apt => apt.id && !apt.error);\nconst failed = appointments.filter(apt => apt.error || !apt.id);\n\nif (successful.length === 0) {\n  return [{\n    json: {\n      success: false,\n      error: {\n        code: 'CLINIKO_API_ERROR',\n        message: 'Failed to create any appointments',\n        details: failed.map(f => f.error || 'Unknown error')\n      }\n    }\n  }];\n}\n\nconst requestData = $items(\"Extract Request Data\")[0].json;\nconst firstApt = successful[0];\n\nreturn [{\n  json: {\n    patient_id: requestData.patient_id,\n    class_name: requestData.class_name,\n    village: requestData.village,\n    day_of_week: requestData.day_of_week,\n    time: requestData.time,\n    funding_type: requestData.funding_type,\n    call_id: requestData.call_id,\n    instructor_name: 'Liam Potter',\n    first_date: successful[0]?.starts_at?.split('T')[0],\n    last_date: successful[successful.length - 1]?.starts_at?.split('T')[0],\n    sessions_created: successful.length,\n    first_appointment_id: successful[0]?.id,\n    series_id: firstApt.series_id || appointments[0]?.series_id,\n    appointments_failed: failed.length,\n    start_time: requestData.start_time\n  }\n}];"},"id":"b980a6d1-a68b-424a-835c-4f917d77d81e","name":"Process Results","type":"n8n-nodes-base.code","typeVersion":2,"position":[560,240]},{"parameters":{"jsCode":"const data = $input.item.json;\n\nif (data.error) {\n  return [{ json: data }];\n}\n\nconst response = {\n  success: true,\n  enrollment_successful: true,\n  class_name: data.class_name,\n  village: data.village,\n  instructor: data.instructor_name,\n  start_date: data.first_date,\n  end_date: data.last_date,\n  day_of_week: data.day_of_week,\n  time: data.time,\n  sessions_created: data.sessions_created,\n  first_appointment_id: data.first_appointment_id,\n  series_id: data.series_id,\n  funding_type: data.funding_type,\n  message: `Successfully enrolled in ${data.class_name}! Created ${data.sessions_created} appointments starting ${data.first_date}.`,\n  call_id: data.call_id,\n  timestamp: new Date().toISOString()\n};\n\nif (data.appointments_failed > 0) {\n  response.warning = `${data.appointments_failed} of 12 appointments failed to create`;\n  response.partial_success = true;\n}\n\nreturn [{ json: response }];"},"id":"32350158-cf06-4e9f-8169-c306321390af","name":"Build Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[784,240]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"6ec0d92a-b032-4c07-9c29-236062838e67","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1008,240]}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Calculate 12 Dates","type":"main","index":0}]]},"Calculate 12 Dates":{"main":[[{"node":"Create Appointment in Cliniko","type":"main","index":0}]]},"Create Appointment in Cliniko":{"main":[[{"node":"Aggregate Results","type":"main","index":0}]]},"Aggregate Results":{"main":[[{"node":"Process Results","type":"main","index":0}]]},"Process Results":{"main":[[{"node":"Build Response","type":"main","index":0}]]},"Build Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"4516dc31-85a5-4cd3-91ae-52855286fe9f","triggerCount":1,"shared":[{"updatedAt":"2025-11-06T23:12:42.691Z","createdAt":"2025-11-06T23:12:42.691Z","role":"workflow:owner","workflowId":"PU3lrxEjnwY84uuh","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-05T06:26:00.310Z","createdAt":"2025-12-04T10:22:01.303Z","id":"2nY72DBqZsDhnKGc","name":"Cliniko Slots Sync Worker v2.1 60_DAYS DAILY_AVAILABILITY","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":15}]}},"id":"schedule-trigger-001","name":"Every 15 Minutes","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,300]},{"parameters":{"url":"https://api.au2.cliniko.com/v1/daily_availabilities?per_page=100","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Sync Worker (support@yr.com.au)"},{"name":"Accept","value":"application/json"}]},"options":{}},"id":"http-daily-avail-001","name":"Fetch Daily Availabilities","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[250,300],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"operation":"executeQuery","query":"SELECT cliniko_id, name, title, specialty, villages FROM practitioner_rosters WHERE is_active = true;","options":{"queryBatching":"independently"}},"id":"postgres-get-practitioners-001","name":"Get Active Practitioners","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[250,500],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"mode":"combine","combineBy":"combineAll","options":{}},"id":"merge-001","name":"Merge Data","type":"n8n-nodes-base.merge","typeVersion":3,"position":[500,400]},{"parameters":{"jsCode":"// Generate time slots from daily_availabilities\n// Cliniko day_of_week: 1=Sunday, 2=Monday... 7=Saturday\n// JavaScript getDay(): 0=Sunday, 1=Monday... 6=Saturday\n\nconst items = $input.all();\nconst dailyAvailabilities = items[0]?.json?.daily_availabilities || [];\nconst practitioners = items.slice(1).map(i => i.json);\n\nif (!dailyAvailabilities.length) {\n  return [{\n    json: {\n      error: true,\n      message: 'No daily availabilities from Cliniko',\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// Build practitioner lookup map\nconst practitionerMap = {};\nfor (const p of practitioners) {\n  practitionerMap[p.cliniko_id] = p;\n}\n\n// Build schedule lookup: {practitioner_id: {day_of_week: [{starts_at, ends_at}]}}\nconst scheduleMap = {};\nfor (const da of dailyAvailabilities) {\n  const pracUrl = da.practitioner?.links?.self || '';\n  const pracId = pracUrl.split('/').pop();\n  if (!pracId || !practitionerMap[pracId]) continue;\n  \n  if (!scheduleMap[pracId]) scheduleMap[pracId] = {};\n  const day = da.day_of_week; // 1-7\n  if (!scheduleMap[pracId][day]) scheduleMap[pracId][day] = [];\n  \n  const avails = da.availabilities || [];\n  for (const a of avails) {\n    scheduleMap[pracId][day].push({\n      starts_at: a.starts_at, // \"09:00\"\n      ends_at: a.ends_at       // \"17:00\"\n    });\n  }\n}\n\n// Generate slots for next 60 days\nconst allSlots = [];\nconst now = new Date();\nconst slotDuration = 30; // minutes\n\nfor (let dayOffset = 0; dayOffset < 60; dayOffset++) {\n  const date = new Date(now);\n  date.setDate(date.getDate() + dayOffset);\n  date.setHours(0, 0, 0, 0);\n  \n  // Convert JS day (0-6) to Cliniko day (1-7)\n  const jsDay = date.getDay();\n  const clinikoDay = jsDay === 0 ? 1 : jsDay + 1;\n  \n  for (const [pracId, schedule] of Object.entries(scheduleMap)) {\n    const daySchedule = schedule[clinikoDay] || [];\n    const practitioner = practitionerMap[pracId];\n    \n    // Parse villages\n    let villages = practitioner.villages;\n    if (typeof villages === 'string') {\n      try { villages = JSON.parse(villages); } catch (e) { villages = []; }\n    }\n    if (!Array.isArray(villages)) villages = [];\n    \n    const serviceCategory = practitioner.specialty?.toLowerCase() === 'ep' ? 'ep' : 'physio';\n    \n    for (const timeBlock of daySchedule) {\n      // Parse start/end times\n      const [startH, startM] = timeBlock.starts_at.split(':').map(Number);\n      const [endH, endM] = timeBlock.ends_at.split(':').map(Number);\n      \n      const blockStart = new Date(date);\n      blockStart.setHours(startH, startM, 0, 0);\n      \n      const blockEnd = new Date(date);\n      blockEnd.setHours(endH, endM, 0, 0);\n      \n      // Skip if block end is in the past\n      if (blockEnd <= now) continue;\n      \n      // Generate 30-minute slots\n      let slotStart = new Date(blockStart);\n      if (slotStart < now) {\n        // Round up to next 30-min boundary\n        slotStart = new Date(now);\n        slotStart.setMinutes(Math.ceil(slotStart.getMinutes() / 30) * 30, 0, 0);\n      }\n      \n      while (slotStart < blockEnd) {\n        const slotEnd = new Date(slotStart);\n        slotEnd.setMinutes(slotEnd.getMinutes() + slotDuration);\n        \n        if (slotEnd > blockEnd) break;\n        \n        // Create slot for each village\n        for (const village of villages) {\n          allSlots.push({\n            practitioner_id: pracId,\n            practitioner_name: practitioner.name,\n            village: village,\n            service_category: serviceCategory,\n            starts_at: slotStart.toISOString(),\n            ends_at: slotEnd.toISOString(),\n            is_available: true\n          });\n        }\n        \n        slotStart = new Date(slotEnd);\n      }\n    }\n  }\n}\n\nreturn [{\n  json: {\n    all_slots: allSlots,\n    total_slots: allSlots.length,\n    practitioners_count: Object.keys(scheduleMap).length,\n    timestamp: new Date().toISOString(),\n    error: false\n  }\n}];"},"id":"code-generate-slots-001","name":"Generate Time Slots","type":"n8n-nodes-base.code","typeVersion":2,"position":[750,400]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"error-check","leftValue":"={{ $json.error }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"if-error-001","name":"Has Error?","type":"n8n-nodes-base.if","typeVersion":2,"position":[1000,400]},{"parameters":{"operation":"executeQuery","query":"-- Clear old slots and fix ALL unique constraints for multi-village support\nTRUNCATE individual_slots_cache;\n\n-- Drop ALL old constraints/indexes that might exist\nDROP INDEX IF EXISTS idx_individual_slots_cache_unique_slot;\nDROP INDEX IF EXISTS unique_practitioner_slot;\n\n-- Also try to drop named constraints (may error, but we catch it)\nDO $$ BEGIN\n  ALTER TABLE individual_slots_cache DROP CONSTRAINT IF EXISTS unique_practitioner_slot;\n  ALTER TABLE individual_slots_cache DROP CONSTRAINT IF EXISTS individual_slots_cache_practitioner_id_starts_at_key;\n  ALTER TABLE individual_slots_cache DROP CONSTRAINT IF EXISTS individual_slots_cache_pkey;\nEXCEPTION WHEN OTHERS THEN\n  NULL;\nEND $$;\n\n-- Create the correct unique index with village included\nCREATE UNIQUE INDEX IF NOT EXISTS idx_slots_unique_practitioner_time_village \nON individual_slots_cache(practitioner_id, starts_at, village);\n\nSELECT 1 as cleanup_done;","options":{"queryBatching":"independently"}},"id":"postgres-cleanup-001","name":"Cleanup Old Slots","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1250,300],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"jsCode":"// Prepare batch insert statements with DEDUPLICATION\nconst data = $('Generate Time Slots').first().json;\nlet slots = data.all_slots || [];\n\nif (slots.length === 0) {\n  return [{\n    json: {\n      insert_query: null,\n      slot_count: 0,\n      message: 'No slots to insert'\n    }\n  }];\n}\n\n// DEDUPLICATE: Remove duplicate (practitioner_id, starts_at, village) combinations\nconst seen = new Set();\nconst uniqueSlots = [];\nfor (const slot of slots) {\n  const key = `${slot.practitioner_id}|${slot.starts_at}|${slot.village}`;\n  if (!seen.has(key)) {\n    seen.add(key);\n    uniqueSlots.push(slot);\n  }\n}\n\nconst duplicatesRemoved = slots.length - uniqueSlots.length;\nslots = uniqueSlots;\n\n// Build UPSERT query with all slots (batch in chunks of 500)\nconst chunkSize = 500;\nconst queries = [];\n\nfor (let i = 0; i < slots.length; i += chunkSize) {\n  const chunk = slots.slice(i, i + chunkSize);\n  \n  const values = chunk.map(slot => {\n    const practId = (slot.practitioner_id || '').toString().replace(/'/g, \"''\");\n    const practName = (slot.practitioner_name || '').replace(/'/g, \"''\");\n    const village = (slot.village || '').replace(/'/g, \"''\");\n    const category = slot.service_category || 'physio';\n    const startsAt = slot.starts_at;\n    const endsAt = slot.ends_at;\n    \n    return `('${practId}', '${practName}', '${village}', '${category}', '${startsAt}'::timestamptz, '${endsAt}'::timestamptz, true, NOW())`;\n  }).join(', ');\n\n  queries.push(`INSERT INTO individual_slots_cache (practitioner_id, practitioner_name, village, service_category, starts_at, ends_at, is_available, last_synced) VALUES ${values} ON CONFLICT (practitioner_id, starts_at, village) DO UPDATE SET practitioner_name = EXCLUDED.practitioner_name, village = EXCLUDED.village, service_category = EXCLUDED.service_category, ends_at = EXCLUDED.ends_at, is_available = EXCLUDED.is_available, last_synced = NOW();`);\n}\n\nreturn [{\n  json: {\n    insert_query: queries.join(' '),\n    slot_count: slots.length,\n    batch_count: queries.length,\n    duplicates_removed: duplicatesRemoved\n  }\n}];"},"id":"code-build-insert-001","name":"Build Insert Query","type":"n8n-nodes-base.code","typeVersion":2,"position":[1500,300]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-slots-check","leftValue":"={{ $json.slot_count }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"if-has-slots-001","name":"Has Slots?","type":"n8n-nodes-base.if","typeVersion":2,"position":[1750,300]},{"parameters":{"operation":"executeQuery","query":"={{ $json.insert_query }}","options":{"queryBatching":"independently"}},"id":"postgres-insert-001","name":"Insert/Update Slots","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[2000,200],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"operation":"executeQuery","query":"UPDATE sync_metadata SET last_sync_at = NOW(), last_sync_status = 'success', last_sync_count = $1, last_error = NULL, updated_at = NOW() WHERE sync_key = 'individual_slots' RETURNING *;","options":{"queryBatching":"independently","queryReplacement":"={{ $('Generate Time Slots').first().json.total_slots }}"}},"id":"postgres-update-metadata-001","name":"Update Sync Metadata","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[2250,200],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"jsCode":"// Final sync summary\nconst slotData = $('Generate Time Slots').first().json;\n\nreturn [{\n  json: {\n    success: true,\n    sync_summary: {\n      total_slots_synced: slotData.total_slots,\n      practitioners_count: slotData.practitioners_count,\n      sync_completed_at: new Date().toISOString()\n    }\n  }\n}];"},"id":"code-summary-001","name":"Sync Summary","type":"n8n-nodes-base.code","typeVersion":2,"position":[2500,200]},{"parameters":{"jsCode":"// No slots to sync\nreturn [{\n  json: {\n    success: true,\n    sync_summary: {\n      total_slots_synced: 0,\n      message: 'No available slots generated from schedule',\n      sync_completed_at: new Date().toISOString()\n    }\n  }\n}];"},"id":"code-no-slots-001","name":"No Slots Summary","type":"n8n-nodes-base.code","typeVersion":2,"position":[2000,450]},{"parameters":{"jsCode":"// Error handler\nreturn [{\n  json: {\n    success: false,\n    error: $json.message || 'Unknown error during sync',\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"code-error-001","name":"Error Handler","type":"n8n-nodes-base.code","typeVersion":2,"position":[1250,550]}],"connections":{"Every 15 Minutes":{"main":[[{"node":"Fetch Daily Availabilities","type":"main","index":0},{"node":"Get Active Practitioners","type":"main","index":0}]]},"Fetch Daily Availabilities":{"main":[[{"node":"Merge Data","type":"main","index":0}]]},"Get Active Practitioners":{"main":[[{"node":"Merge Data","type":"main","index":1}]]},"Merge Data":{"main":[[{"node":"Generate Time Slots","type":"main","index":0}]]},"Generate Time Slots":{"main":[[{"node":"Has Error?","type":"main","index":0}]]},"Has Error?":{"main":[[{"node":"Error Handler","type":"main","index":0}],[{"node":"Cleanup Old Slots","type":"main","index":0}]]},"Cleanup Old Slots":{"main":[[{"node":"Build Insert Query","type":"main","index":0}]]},"Build Insert Query":{"main":[[{"node":"Has Slots?","type":"main","index":0}]]},"Has Slots?":{"main":[[{"node":"Insert/Update Slots","type":"main","index":0}],[{"node":"No Slots Summary","type":"main","index":0}]]},"Insert/Update Slots":{"main":[[{"node":"Update Sync Metadata","type":"main","index":0}]]},"Update Sync Metadata":{"main":[[{"node":"Sync Summary","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":{"node:Every 15 Minutes":{"recurrenceRules":[]}},"meta":null,"pinData":null,"versionId":"e6a06159-8b64-4ca9-a7e2-e47643da7114","triggerCount":1,"shared":[{"updatedAt":"2025-12-04T10:22:01.303Z","createdAt":"2025-12-04T10:22:01.303Z","role":"workflow:owner","workflowId":"2nY72DBqZsDhnKGc","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-05T01:03:52.230Z","createdAt":"2025-12-04T19:39:34.001Z","id":"jG6ClzLklzLAbLqY","name":"RetellAI - Book Appointment Compound v1.5 PRACTITIONER_NAME","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/book-appointment-compound","responseMode":"responseNode","options":{}},"id":"webhook-trigger-001","name":"Webhook Trigger","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,300],"webhookId":"book-appointment-compound"},{"parameters":{"jsCode":"// STANDARD EXTRACTION PATTERN - RetellAI Compatible\n// Book Appointment Compound v1.5 PRACTITIONER_NAME\n// v1.4 CHANGE: No default practitioner_id - must be provided or error\n// v1.5 CHANGE: Accept practitioner_name from agent and pass through to response\n\nconst webhookData = $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\n// ============================================\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\n// ============================================\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n  if (phone.startsWith('+')) return phone;\n  if (phone.length === 8 && !phone.startsWith('+')) return '+612' + phone;\n  if (phone.length === 10 && phone.startsWith('0')) return '+61' + phone.substring(1);\n  if (phone.length === 11 && phone.startsWith('61')) return '+' + phone;\n  if (phone.length === 9) return '+61' + phone;\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n// ============================================\n// Extract all required parameters\n// v1.4 CHANGE: practitioner_id has NO DEFAULT - must be provided\n// ============================================\nconst patient_id = args.patient_id || '';\nconst practitioner_id = args.practitioner_id || '';  // NO DEFAULT\nconst appointment_type = args.appointment_type || 'Standard Consultation';\nconst starts_at = args.starts_at || args.start_time || args.datetime || '';\nconst duration_minutes = parseInt(args.duration_minutes) || 30;\nconst village = args.village || '';\nconst funding_type = (args.funding_type || '').toUpperCase();\nconst appointment_notes = args.appointment_notes || args.notes || '';\nconst unit_villa = args.unit_villa || '';\nconst is_new_client = args.is_new_client || false;\nconst client_name = args.client_name || '';\nconst practitioner_name = args.practitioner_name || '';  // v1.5: Accept practitioner_name from agent\nconst recurrence_details = args.recurrence_details || null;\nconst call_id = call.call_id || args.call_id || '';\n\n// ============================================\n// Validation - v1.4: practitioner_id now required\n// ============================================\nconst errors = [];\n\nif (!patient_id) errors.push('patient_id is required');\nif (!practitioner_id) errors.push('practitioner_id is required - please select a practitioner first');\nif (!starts_at) errors.push('starts_at is required');\nif (!village) errors.push('village is required');\nif (!funding_type) errors.push('funding_type is required');\n\nconst validFundingTypes = ['HCP', 'DVA', 'GP', 'PRIVATE', 'PHI'];\nif (funding_type && !validFundingTypes.includes(funding_type)) {\n  errors.push(`Invalid funding_type. Must be one of: ${validFundingTypes.join(', ')}`);\n}\n\nconst validAppointmentTypes = ['Standard Consultation', 'Standard Home Visit', 'Initial Assessment', 'EP Assessment', 'EP Initial Assessment', 'Initial Consultation'];\nif (appointment_type && !validAppointmentTypes.includes(appointment_type)) {\n  errors.push(`Invalid appointment_type. Must be one of: ${validAppointmentTypes.join(', ')}`);\n}\n\n// Parse and validate datetime\nlet appointmentDate;\ntry {\n  appointmentDate = new Date(starts_at);\n  if (isNaN(appointmentDate.getTime())) {\n    errors.push('Invalid starts_at format. Use ISO 8601 format.');\n  }\n} catch (e) {\n  errors.push('Invalid starts_at format. Use ISO 8601 format.');\n}\n\n// Check appointment is in the future\nconst now = new Date();\nif (appointmentDate && appointmentDate <= now) {\n  errors.push('Appointment starts_at must be in the future');\n}\n\n// Check booking window (21 days)\nif (appointmentDate) {\n  const maxBookingDate = new Date(now);\n  maxBookingDate.setDate(now.getDate() + 21);\n  if (appointmentDate > maxBookingDate) {\n    const daysAhead = Math.ceil((appointmentDate - now) / (1000 * 60 * 60 * 24));\n    errors.push(`Appointment is ${daysAhead} days ahead. Bookings limited to 21 days.`);\n  }\n}\n\n// If validation errors, return early\nif (errors.length > 0) {\n  return [{\n    json: {\n      success: false,\n      appointment_created: false,\n      error: {\n        code: 'VALIDATION_ERROR',\n        message: errors.join('; '),\n        details: errors\n      },\n      call_id: call_id,\n      timestamp: new Date().toISOString(),\n      validation_failed: true\n    }\n  }];\n}\n\n// ============================================\n// Calculate derived fields\n// ============================================\nconst starts_at_utc = appointmentDate.toISOString();\n\nconst endDate = new Date(appointmentDate);\nendDate.setMinutes(endDate.getMinutes() + duration_minutes);\nconst ends_at = endDate.toISOString();\n\nconst date_only = appointmentDate.toISOString().split('T')[0];\n\nconst daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\nconst day_of_week = daysOfWeek[appointmentDate.getDay()];\n\nconst hours = String(appointmentDate.getHours()).padStart(2, '0');\nconst minutes = String(appointmentDate.getMinutes()).padStart(2, '0');\nconst time_slot = `${hours}:${minutes}:00`;\n\nconst endHours = String(endDate.getHours()).padStart(2, '0');\nconst endMinutes = String(endDate.getMinutes()).padStart(2, '0');\nconst end_time = `${endHours}:${endMinutes}:00`;\n\nconst date_formatted = appointmentDate.toLocaleDateString('en-AU', { \n  timeZone: 'Australia/Sydney',\n  weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' \n});\nconst time_formatted = appointmentDate.toLocaleTimeString('en-AU', { \n  timeZone: 'Australia/Sydney',\n  hour: '2-digit', minute: '2-digit', hour12: true \n});\n\nconst clinikoNotes = [\n  `Village: ${village}`,\n  unit_villa ? `Unit/Villa: ${unit_villa}` : '',\n  `Funding: ${funding_type}`,\n  appointment_notes ? `Notes: ${appointment_notes}` : ''\n].filter(n => n).join('\\n');\n\n// FIX #2: Valid ID Mapping (Prevent 422 Crashes)\n// TODO: Replace duplicate IDs with unique Cliniko IDs for reporting accuracy\nconst APPOINTMENT_TYPE_MAP = {\n  'Standard Consultation': '472831283798480897',\n  'Standard Home Visit': '472831283798480897',  // TODO: Get distinct ID\n  'Initial Assessment': '472831283798480897',   // TODO: Get distinct ID\n  'EP Assessment': '472831283798480897',        // TODO: Get distinct ID\n  'Initial Consultation': '472831283798480897'  // FIXED: Valid ID instead of placeholder\n};\nconst appointment_type_id = APPOINTMENT_TYPE_MAP[appointment_type] || '472831283798480897';\n\nreturn [{\n  json: {\n    patient_id,\n    practitioner_id,\n    business_id: '675491769126754955',\n    appointment_type_id,\n    appointment_type,\n    \n    starts_at: starts_at_utc,\n    starts_at_original: starts_at,\n    ends_at,\n    duration_minutes,\n    date_only,\n    day_of_week,\n    time_slot,\n    end_time,\n    date_formatted,\n    time_formatted,\n    \n    village,\n    unit_villa,\n    funding_type,\n    \n    appointment_notes,\n    cliniko_notes: clinikoNotes,\n    \n    is_new_client,\n    client_name,\n    practitioner_name,\n    recurrence_details,\n    \n    call_id,\n    start_time: Date.now(),\n    timestamp: new Date().toISOString(),\n    validation_failed: false\n  }\n}];"},"id":"code-extract-001","name":"Extract & Validate Request","type":"n8n-nodes-base.code","typeVersion":2,"position":[250,300]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"validation-failed-check","leftValue":"={{ $json.validation_failed }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"if-validation-001","name":"Validation Failed?","type":"n8n-nodes-base.if","typeVersion":2,"position":[500,300]},{"parameters":{"operation":"executeQuery","query":"-- v1.4 SAFETY CHECKS: Holiday, Protected Slot\n-- Using tables: safety_holidays, safety_protected_slots\n\nSELECT \n  'holiday' as check_type,\n  EXISTS(SELECT 1 FROM safety_holidays WHERE date = $1::date) as is_blocked,\n  (SELECT description FROM safety_holidays WHERE date = $1::date) as reason\nUNION ALL\nSELECT \n  'protected_slot' as check_type,\n  EXISTS(\n    SELECT 1 FROM safety_protected_slots \n    WHERE is_active = true\n      AND day_of_week = $2\n      AND (\n        ($3::time, $4::time) OVERLAPS (start_time, end_time)\n        OR ($3::time >= start_time AND $3::time < end_time)\n      )\n      AND (practitioner_id IS NULL OR practitioner_id = $5)\n      AND (village IS NULL OR village = $6)\n  ) as is_blocked,\n  (SELECT reason FROM safety_protected_slots \n   WHERE is_active = true\n     AND day_of_week = $2\n     AND ($3::time >= start_time AND $3::time < end_time)\n   LIMIT 1) as reason;","options":{"queryBatching":"independently","queryReplacement":"={{ [$json.date_only, $json.day_of_week, $json.time_slot, $json.end_time, $json.practitioner_id, $json.village] }}"}},"id":"postgres-safety-checks-001","name":"Run Safety Checks","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[750,200],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"jsCode":"// v1.4 Process Safety Check Results\nconst requestData = $items('Extract & Validate Request')[0].json;\nconst checkResults = $input.all().map(i => i.json);\n\nlet blockers = [];\nlet pre_checks = {\n  holiday_clear: true,\n  protected_clear: true,\n  slot_available: true  // Assume available until Cliniko says otherwise\n};\n\n// Process check results\nfor (const result of checkResults) {\n  if (result.check_type === 'holiday' && result.is_blocked) {\n    pre_checks.holiday_clear = false;\n    blockers.push({\n      type: 'HOLIDAY',\n      message: `Cannot book on ${requestData.date_formatted} - ${result.reason || 'Public holiday'}`,\n      details: { date: requestData.date_only, holiday_name: result.reason }\n    });\n  }\n  \n  if (result.check_type === 'protected_slot' && result.is_blocked) {\n    pre_checks.protected_clear = false;\n    blockers.push({\n      type: 'PROTECTED_SLOT',\n      message: `This time slot is protected: ${result.reason || 'Reserved time'}`,\n      details: { time: requestData.time_slot, reason: result.reason }\n    });\n  }\n}\n\nconst can_proceed = blockers.length === 0;\n\nreturn [{\n  json: {\n    ...requestData,\n    pre_checks,\n    can_proceed,\n    blockers,\n    checks_completed_at: new Date().toISOString()\n  }\n}];"},"id":"code-process-checks-001","name":"Process Safety Check Results","type":"n8n-nodes-base.code","typeVersion":2,"position":[1000,200]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"can-proceed-check","leftValue":"={{ $json.can_proceed }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"if-can-proceed-001","name":"Can Proceed?","type":"n8n-nodes-base.if","typeVersion":2,"position":[1250,200]},{"parameters":{"method":"POST","url":"https://api.au2.cliniko.com/v1/individual_appointments","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"},{"name":"Accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ { patient_id: $json.patient_id, practitioner_id: $json.practitioner_id, business_id: $json.business_id, appointment_type_id: $json.appointment_type_id, starts_at: $json.starts_at, ends_at: $json.ends_at, notes: $json.cliniko_notes, send_sms: true, confirmed: true } }}","options":{}},"id":"http-create-appt-001","name":"Create Appointment","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1500,100],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"// Process Cliniko response - v1.5 PRACTITIONER_NAME\n// Handle race conditions since we removed the pre-check\n// v1.5: Added practitioner_name passthrough from agent\nconst clinikoResponse = $input.item.json;\n// Access request data from the Validation node since we skipped the Check Slot node\nconst requestData = $('Process Safety Check Results').first().json;\n\n// FIX: Catch Race Conditions (Slot taken) specific errors\n// 422 = Unprocessable Entity (often overlap), 409 = Conflict\nif (clinikoResponse.error && (clinikoResponse.statusCode === 422 || clinikoResponse.statusCode === 409)) {\n   return [{\n     json: {\n       ...requestData,\n       success: false,\n       appointment_created: false,\n       error_code: 'SLOT_UNAVAILABLE',\n       error_message: 'This time slot was just taken. Please select a different time.',\n       pre_checks: {\n         ...requestData.pre_checks,\n         slot_available: false\n       }\n     }\n   }];\n}\n\nif (clinikoResponse.error || !clinikoResponse.id) {\n  return [{\n    json: {\n      ...requestData,\n      success: false,\n      appointment_created: false,\n      error_code: 'CLINIKO_CREATE_ERROR',\n      error_message: clinikoResponse.error || 'No appointment ID returned',\n      error: { code: 'CLINIKO_CREATE_ERROR', message: clinikoResponse.error || 'No appointment ID returned' }\n    }\n  }];\n}\n\nconst patient_name = clinikoResponse.patient?.first_name && clinikoResponse.patient?.last_name\n  ? `${clinikoResponse.patient.first_name} ${clinikoResponse.patient.last_name}`\n  : requestData.client_name || 'Patient';\n\n// v1.5: Use practitioner_name from agent (passed through requestData), fall back to Cliniko response\nconst practitioner_name = requestData.practitioner_name\n  || (clinikoResponse.practitioner?.first_name && clinikoResponse.practitioner?.last_name\n      ? `${clinikoResponse.practitioner.first_name} ${clinikoResponse.practitioner.last_name}`\n      : 'Practitioner');\n\nreturn [{\n  json: {\n    ...requestData,\n    success: true,\n    appointment_created: true,\n    appointment_id: clinikoResponse.id,\n    patient_name,\n    practitioner_name,\n    cliniko_link: `https://reignitehealth.au2.cliniko.com/appointments/${clinikoResponse.id}`,\n    sms_sent: true\n  }\n}];"},"id":"code-process-cliniko-001","name":"Process Cliniko Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1750,100]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"created-check","leftValue":"={{ $json.appointment_created }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"if-created-001","name":"Created?","type":"n8n-nodes-base.if","typeVersion":2,"position":[2000,100]},{"parameters":{"jsCode":"// Format success response\nconst data = $json;\nconst duration_ms = Date.now() - data.start_time;\n\nreturn [{\n  json: {\n    success: true,\n    appointment_created: true,\n    appointment_id: data.appointment_id,\n    confirmation_details: {\n      patient_name: data.patient_name,\n      practitioner_name: data.practitioner_name,\n      datetime: data.starts_at,\n      date: data.date_formatted,\n      time: data.time_formatted,\n      duration_minutes: data.duration_minutes,\n      village: data.village,\n      funding_type: data.funding_type\n    },\n    pre_checks: data.pre_checks,\n    cliniko_link: data.cliniko_link,\n    call_id: data.call_id,\n    duration_ms,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"code-success-001","name":"Format Success","type":"n8n-nodes-base.code","typeVersion":2,"position":[2250,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-success-001","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2500,0]},{"parameters":{"jsCode":"// Format validation error\nreturn [{ json: { success: false, appointment_created: false, error: $json.error, call_id: $json.call_id, timestamp: $json.timestamp } }];"},"id":"code-val-error-001","name":"Format Validation Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[750,500]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-val-error-001","name":"Respond Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1000,500]},{"parameters":{"jsCode":"// Format blocked response\nconst data = $json;\nconst primaryBlocker = data.blockers[0] || { type: 'UNKNOWN', message: 'Booking blocked' };\n\nreturn [{\n  json: {\n    success: false,\n    appointment_created: false,\n    error_code: primaryBlocker.type,\n    error_message: primaryBlocker.message,\n    error: { code: primaryBlocker.type, message: primaryBlocker.message, all_blockers: data.blockers },\n    pre_checks: data.pre_checks,\n    call_id: data.call_id,\n    duration_ms: Date.now() - data.start_time,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"code-blocked-001","name":"Format Blocked","type":"n8n-nodes-base.code","typeVersion":2,"position":[1500,350]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-blocked-001","name":"Respond Blocked","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1750,350]},{"parameters":{"jsCode":"// Format create error (includes race condition handling)\nconst data = $json;\nreturn [{\n  json: {\n    success: false,\n    appointment_created: false,\n    error_code: data.error_code || 'CLINIKO_CREATE_ERROR',\n    error_message: data.error_message || 'Failed to create appointment',\n    pre_checks: data.pre_checks,\n    call_id: data.call_id,\n    duration_ms: Date.now() - data.start_time,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"code-create-error-001","name":"Format Create Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[2250,200]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-create-error-001","name":"Respond Create Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2500,200]}],"connections":{"Webhook Trigger":{"main":[[{"node":"Extract & Validate Request","type":"main","index":0}]]},"Extract & Validate Request":{"main":[[{"node":"Validation Failed?","type":"main","index":0}]]},"Validation Failed?":{"main":[[{"node":"Format Validation Error","type":"main","index":0}],[{"node":"Run Safety Checks","type":"main","index":0}]]},"Format Validation Error":{"main":[[{"node":"Respond Validation Error","type":"main","index":0}]]},"Run Safety Checks":{"main":[[{"node":"Process Safety Check Results","type":"main","index":0}]]},"Process Safety Check Results":{"main":[[{"node":"Can Proceed?","type":"main","index":0}]]},"Can Proceed?":{"main":[[{"node":"Create Appointment","type":"main","index":0}],[{"node":"Format Blocked","type":"main","index":0}]]},"Format Blocked":{"main":[[{"node":"Respond Blocked","type":"main","index":0}]]},"Create Appointment":{"main":[[{"node":"Process Cliniko Response","type":"main","index":0}]]},"Process Cliniko Response":{"main":[[{"node":"Created?","type":"main","index":0}]]},"Created?":{"main":[[{"node":"Format Success","type":"main","index":0}],[{"node":"Format Create Error","type":"main","index":0}]]},"Format Success":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Format Create Error":{"main":[[{"node":"Respond Create Error","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"677d4818-937d-4513-b097-112464ed6082","triggerCount":1,"shared":[{"updatedAt":"2025-12-04T19:39:34.001Z","createdAt":"2025-12-04T19:39:34.001Z","role":"workflow:owner","workflowId":"jG6ClzLklzLAbLqY","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-09T09:14:54.903Z","createdAt":"2025-11-07T04:26:00.801Z","id":"0ccBfNio4Q0jRF3n","name":"RetellAI - Update Client Notes v1.2","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/update-notes","responseMode":"responseNode","options":{}},"id":"0a9c3c9b-d098-4d07-99c4-a48e3b35cdb2","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"update-notes"},{"parameters":{"jsCode":"const webhookData = $input.item.json.body || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\nconst patient_id = args.patient_id || '';\nconst notes = args.notes || '';\nconst call_id = call.call_id || args.call_id || '';\nif (!patient_id) throw new Error('patient_id is required');\nif (!notes) throw new Error('notes is required');\nreturn [{ json: { patient_id, notes, call_id, timestamp: new Date().toISOString(), start_time: Date.now() } }];"},"id":"3fdcf574-2f30-4c89-8c91-3771ed03dcdc","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"jsCode":"const requestData = $input.item.json;\nconst dateStr = new Date().toLocaleString('en-AU', { timeZone: 'Australia/Sydney', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });\nconst formattedNote = `[Voice AI Note - ${dateStr}]\\n${requestData.notes}\\n\\nCall ID: ${requestData.call_id}`;\nreturn [{ json: { patient_id: requestData.patient_id, original_notes: requestData.notes, formatted_note: formattedNote, call_id: requestData.call_id, timestamp: requestData.timestamp, start_time: requestData.start_time } }];"},"id":"c8aed7da-0e8f-42e3-aa19-f6db0d4c2deb","name":"Format Note for Cliniko","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"url":"=https://api.au2.cliniko.com/v1/patients/{{ $json.patient_id }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"},{"name":"Accept","value":"application/json"}]},"options":{"response":{"response":{"responseFormat":"json"}}}},"id":"3871e6b3-5abf-410b-87c4-40bee41890af","name":"Get Patient Details","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[672,0],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"jsCode":"const patientData = $input.item.json;\nconst noteData = $items('Format Note for Cliniko')[0].json;\nconst existingNotes = patientData.notes || '';\nconst updatedNotes = existingNotes ? `${existingNotes}\\n\\n---\\n\\n${noteData.formatted_note}` : noteData.formatted_note;\nreturn [{ json: { patient_id: noteData.patient_id, updated_notes: updatedNotes, formatted_note: noteData.formatted_note, call_id: noteData.call_id, timestamp: noteData.timestamp, start_time: noteData.start_time } }];"},"id":"945a3330-c79c-470b-80e9-4aea610aba4a","name":"Append to Existing Notes","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,0]},{"parameters":{"method":"PATCH","url":"=https://api.au2.cliniko.com/v1/patients/{{ $json.patient_id }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"},{"name":"Accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={ \"notes\": {{ JSON.stringify($json.updated_notes) }} }","options":{"response":{"response":{"responseFormat":"json"}}}},"id":"94e89bb4-f6d6-46f5-b322-9e99737b9f8a","name":"Update Patient Notes","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1104,0],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"jsCode":"const requestData = $items('Append to Existing Notes')[0].json;\nconst duration_ms = Math.round(Date.now() - requestData.start_time);\nreturn [{ json: { success: true, notes_updated: true, patient_id: requestData.patient_id, note_added: requestData.formatted_note, call_id: requestData.call_id, timestamp: new Date().toISOString(), logging_data: { patient_id: requestData.patient_id, note_text: requestData.formatted_note, call_id: requestData.call_id, success: true, duration_ms: duration_ms } } }];"},"id":"46087460-6f6b-4e6d-be8b-f543a020270d","name":"Build Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1328,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify({ success: $json.success, notes_updated: $json.notes_updated, patient_id: $json.patient_id, note_added: $json.note_added, call_id: $json.call_id, timestamp: $json.timestamp }) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"a06855d7-ea00-4c60-b5b4-f950962640a6","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1552,0]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO patient_notes_log (patient_id, note_text, added_via, call_id, cliniko_note_id, success, created_at) VALUES ('{{ $json.logging_data.patient_id }}', '{{ $json.logging_data.note_text.replace(/'/g, \"''\") }}', 'voice_ai', '{{ $json.logging_data.call_id }}', 'patient_notes_field', {{ $json.logging_data.success }}, now()) RETURNING *;","options":{"queryBatching":"independently"}},"id":"7df3b4b1-5e9e-4da1-b256-a3b9482156c5","name":"Log to Database","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1760,0],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_log (webhook_name, call_id, request_body, response_body, success, duration_ms, cache_hit, created_at) VALUES ('update-notes', '{{ $items(\"Build Response\")[0].json.logging_data.call_id }}', '{{ JSON.stringify($items(\"Extract Request Data\")[0].json) }}'::jsonb, '{{ JSON.stringify($items(\"Build Response\")[0].json) }}'::jsonb, true, {{ $items(\"Build Response\")[0].json.logging_data.duration_ms }}, false, now()) RETURNING *;","options":{"queryBatching":"independently"}},"id":"f29a4069-227a-4ec1-ac5c-ea76235eb720","name":"Log Webhook Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1984,0],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Format Note for Cliniko","type":"main","index":0}]]},"Format Note for Cliniko":{"main":[[{"node":"Get Patient Details","type":"main","index":0}]]},"Get Patient Details":{"main":[[{"node":"Append to Existing Notes","type":"main","index":0}]]},"Append to Existing Notes":{"main":[[{"node":"Update Patient Notes","type":"main","index":0}]]},"Update Patient Notes":{"main":[[{"node":"Build Response","type":"main","index":0}]]},"Build Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log to Database","type":"main","index":0}]]},"Log to Database":{"main":[[{"node":"Log Webhook Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"66049060-a81f-4965-8957-4fc2762ec794","triggerCount":1,"shared":[{"updatedAt":"2025-11-07T04:26:00.801Z","createdAt":"2025-11-07T04:26:00.801Z","role":"workflow:owner","workflowId":"0ccBfNio4Q0jRF3n","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-03T21:20:20.127Z","createdAt":"2025-11-07T04:34:31.181Z","id":"3iCwSDEo0210tVYK","name":"RetellAI - Enroll in Class v7.0 COMPLETE","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/enroll-class","responseMode":"responseNode","options":{}},"id":"27fb6499-e442-45f5-afd4-e727b0b2bcce","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"enroll-class"},{"parameters":{"jsCode":"\n// Universal Phone Normalization (Australian E.164) - v9.09\n\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n\n  // 1. Strip everything except digits and '+'\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n\n  // 2. Already in E.164 format\n  if (phone.startsWith('+')) {\n    return phone;\n  }\n\n  // 3. Handle 8-digit local numbers (Assume NSW '02')\n  if (phone.length === 8 && !phone.startsWith('+')) {\n    return '+612' + phone;\n  }\n\n  // 4. Handle standard 10-digit AU numbers (04... or 02...)\n  if (phone.length === 10 && phone.startsWith('0')) {\n    return '+61' + phone.substring(1);\n  }\n\n  // 5. Handle numbers starting with 61 (missing +)\n  if (phone.length === 11 && phone.startsWith('61')) {\n    return '+' + phone;\n  }\n\n  // 6. Assume Australian if 9 digits (missing leading 0)\n  if (phone.length === 9) {\n    return '+61' + phone;\n  }\n\n  // 7. Return cleaned version (best effort)\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n\n// Extract and validate request\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\nconst patient_id = args.patient_id || '';\nconst class_name = args.class_name || '';\nconst village = args.village || '';\nconst day_of_week = args.day_of_week || '';\nconst time = args.time || '';\nconst funding_type = (args.funding_type || '').toUpperCase();\nconst has_ep_assessment = args.has_ep_assessment || false;\nconst start_date = args.start_date || null;\nconst call_id = call.call_id || args.call_id || '';\n\nif (!patient_id) throw new Error('patient_id is required');\nif (!class_name) throw new Error('class_name is required');\nif (!day_of_week) throw new Error('day_of_week is required');\nif (!time) throw new Error('time is required');\n\nreturn [{\n  json: {\n    patient_id,\n    class_name,\n    village,\n    day_of_week,\n    time,\n    funding_type,\n    has_ep_assessment,\n    start_date,\n    call_id,\n    start_time: Date.now(),\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"73a18ce4-61e3-4e03-9a15-79efd914a308","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"jsCode":"// === SYDNEY TIMEZONE LOGIC (PROVEN WORKING) ===\n\n// Parse time; supports \"HH:MM\", \"HH:MM:SS\", and with am/pm\nfunction parseTime(t){\n  let s = String(t||'').trim().toLowerCase().replace(/\\./g,'');\n  const ampm = (/(am|pm)$/.test(s)) ? s.slice(-2) : null;\n  if(ampm) s = s.replace(/\\s*(am|pm)$/,'');\n  const parts = s.split(':').map(n=>parseInt(n,10));\n  let h = parts[0]||0, mi = parts[1]||0, se = parts[2]||0;\n  if(ampm){\n    if(ampm==='pm' && h<12) h += 12;\n    if(ampm==='am' && h===12) h = 0;\n  }\n  if(h<0||h>23||mi<0||mi>59||se<0||se>59) throw new Error('time invalid');\n  return {h, mi, se};\n}\n\n// First Sunday (day-of-month) for a given month (1-12) in UTC math\nfunction firstSundayDOM(year, month){\n  const dt = new Date(Date.UTC(year, month-1, 1));\n  const add = (7 - dt.getUTCDay()) % 7; // 0=Sun\n  return 1 + add;\n}\n\n// Sydney DST: starts 02:00 (standard) on 1st Sunday in Oct; ends 03:00 (daylight) on 1st Sunday in Apr\nfunction isSydneyDST(y, mo, d, h, mi){\n  if(mo>=11 || mo<=3) return true;        // Nov‚ÄìMar\n  if(mo>=5 && mo<=9) return false;        // May‚ÄìSep\n  if(mo===10){                             // October\n    const fs = firstSundayDOM(y,10);\n    if(d>fs) return true;\n    if(d<fs) return false;\n    return h>=2;\n  }\n  if(mo===4){                              // April\n    const fs = firstSundayDOM(y,4);\n    if(d<fs) return true;\n    if(d>fs) return false;\n    return h<3;\n  }\n  return false;\n}\n\n// === MAIN LOGIC ===\n\nconst data = $input.item.json;\n\nconst daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\nconst targetDayIndex = daysOfWeek.indexOf(data.day_of_week);\n\nif (targetDayIndex === -1) throw new Error(`Invalid day: ${data.day_of_week}`);\n\n// Parse time\nconst {h: hours, mi: minutes, se: seconds} = parseTime(data.time);\n\n// Find first class date - at least 2 weeks from now\nlet searchDate = new Date();\nsearchDate.setDate(searchDate.getDate() + 14); // Start 2 weeks from now\n\n// Find next occurrence of target day (in local date, but we'll use the date parts only)\nwhile (searchDate.getDay() !== targetDayIndex) {\n  searchDate.setDate(searchDate.getDate() + 1);\n}\n\n// Get the date parts (YYYY-MM-DD) for first class\nconst firstYear = searchDate.getFullYear();\nconst firstMonth = searchDate.getMonth() + 1;\nconst firstDay = searchDate.getDate();\n\n// Generate series ID\nconst series_id = `CLASS_${data.class_name.replace(/\\s+/g,'_')}_${Date.now()}`;\nconst appointments = [];\n\n// Create 12 weekly appointments\nfor (let week = 0; week < 12; week++) {\n  // Calculate date for this week\n  const weekDate = new Date(searchDate);\n  weekDate.setDate(searchDate.getDate() + (week * 7));\n  \n  const y = weekDate.getFullYear();\n  const mo = weekDate.getMonth() + 1;\n  const d = weekDate.getDate();\n  \n  // Calculate if DST is active for this specific date\n  const dst = isSydneyDST(y, mo, d, hours, minutes);\n  const offsetHours = dst ? 11 : 10;\n  \n  // Compute UTC from Sydney wall time\n  const startUtcMs = Date.UTC(y, mo-1, d, hours, minutes, seconds) - offsetHours*3600*1000;\n  const endUtcMs = startUtcMs + 60*60*1000; // 1 hour duration\n  \n  const starts_at = new Date(startUtcMs).toISOString();\n  const ends_at = new Date(endUtcMs).toISOString();\n  \n  const notes = [\n    `Class: ${data.class_name}`,\n    `Village: ${data.village}`,\n    `Funding: ${data.funding_type}`,\n    `Series: ${series_id}`,\n    `Week ${week + 1} of 12`,\n    'Enrolled via Voice AI',\n    `Call: ${data.call_id}`,\n    `Offset: UTC${dst ? '+11' : '+10'} (DST: ${dst})`\n  ].join('\\n');\n  \n  appointments.push({\n    json: {\n      ...data,\n      week_number: week + 1,\n      starts_at,\n      ends_at,\n      appointment_date: `${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`,\n      notes,\n      series_id,\n      offset_hours: offsetHours,\n      dst_active: dst\n    }\n  });\n}\n\nreturn appointments;"},"id":"43145cd0-35e7-42c4-a892-add3e5e5a22f","name":"Calculate 12 Dates","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"method":"POST","url":"https://api.au2.cliniko.com/v1/appointments","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"},{"name":"Accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ { patient_id: $json.patient_id, practitioner_id: '473326864069303022', business_id: '675491769126754955', appointment_type_id: '472831283798480897', starts_at: $json.starts_at, ends_at: $json.ends_at, notes: $json.notes, send_sms: false } }}","options":{"batching":{"batch":{"batchSize":1}}}},"id":"d141278a-8f46-46e0-b2a5-fe6293c7bdf5","name":"Create Appointment in Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[672,0],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"aggregate":"aggregateAllItemData","destinationFieldName":"appointments","options":{}},"id":"6d9e3d2d-8752-4467-b55b-91c4e02d3047","name":"Aggregate Results","type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[880,0]},{"parameters":{"jsCode":"// Process results\nconst items = $input.all();\nconst appointments = items[0].json.appointments || [];\n\nconst successful = appointments.filter(apt => apt.id && !apt.error);\nconst failed = appointments.filter(apt => apt.error || !apt.id);\n\nif (successful.length === 0) {\n  return [{\n    json: {\n      success: false,\n      error: {\n        code: 'CLINIKO_API_ERROR',\n        message: 'Failed to create any appointments',\n        details: failed.map(f => f.error || 'Unknown error')\n      }\n    }\n  }];\n}\n\nconst requestData = $items(\"Extract Request Data\")[0].json;\nconst firstApt = successful[0];\n\nreturn [{\n  json: {\n    patient_id: requestData.patient_id,\n    class_name: requestData.class_name,\n    village: requestData.village,\n    day_of_week: requestData.day_of_week,\n    time: requestData.time,\n    funding_type: requestData.funding_type,\n    call_id: requestData.call_id,\n    instructor_name: 'Liam Potter',\n    first_date: successful[0]?.starts_at?.split('T')[0],\n    last_date: successful[successful.length - 1]?.starts_at?.split('T')[0],\n    sessions_created: successful.length,\n    first_appointment_id: successful[0]?.id,\n    series_id: firstApt.series_id || appointments[0]?.series_id,\n    appointments_failed: failed.length,\n    start_time: requestData.start_time\n  }\n}];"},"id":"63f69247-1eb1-4ef5-93e2-ef45f6d80698","name":"Process Results","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,0]},{"parameters":{"jsCode":"const data = $input.item.json;\n\nif (data.error) {\n  return [{ json: data }];\n}\n\nconst response = {\n  success: true,\n  enrollment_successful: true,\n  class_name: data.class_name,\n  village: data.village,\n  instructor: data.instructor_name,\n  start_date: data.first_date,\n  end_date: data.last_date,\n  day_of_week: data.day_of_week,\n  time: data.time,\n  sessions_created: data.sessions_created,\n  first_appointment_id: data.first_appointment_id,\n  series_id: data.series_id,\n  funding_type: data.funding_type,\n  message: `Successfully enrolled in ${data.class_name}! Created ${data.sessions_created} appointments starting ${data.first_date}.`,\n  call_id: data.call_id,\n  timestamp: new Date().toISOString()\n};\n\nif (data.appointments_failed > 0) {\n  response.warning = `${data.appointments_failed} of 12 appointments failed to create`;\n  response.partial_success = true;\n}\n\nreturn [{ json: response }];"},"id":"35bbe785-0183-466a-b202-b6ae03cb78bc","name":"Build Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1328,0]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"f4cbcbf8-e3e8-4994-a978-b8006e185146","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1552,0]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_body,\n  response_body,\n  success,\n  duration_ms,\n  error_code,\n  created_at\n) VALUES (\n  'enroll-class',\n  '{{ $items(\"Extract Request Data\")[0].json.call_id }}',\n  '{{ JSON.stringify($items(\"Extract Request Data\")[0].json) }}',\n  '{{ JSON.stringify($items(\"Build Response\")[0].json) }}',\n  {{ $items(\"Build Response\")[0].json.success }},\n  {{ Date.now() - $items(\"Extract Request Data\")[0].json.start_time }},\n  {{ $items(\"Build Response\")[0].json.error ? \"'\" + $items(\"Build Response\")[0].json.error.code + \"'\" : \"NULL\" }},\n  now()\n) RETURNING *;","options":{"queryBatching":"independently"}},"id":"f7af8150-4626-4178-88f5-7f584d73c820","name":"Log to Database","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1776,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"operation":"executeQuery","query":"=DELETE FROM class_enrollment_cache \nWHERE class_name = '{{ $items(\"Extract Request Data\")[0].json.class_name }}' \n  AND village = '{{ $items(\"Extract Request Data\")[0].json.village }}' \n  AND day_of_week = '{{ $items(\"Extract Request Data\")[0].json.day_of_week }}'\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"eecb06c1-485b-4500-92bf-47e4d445870e","name":"Invalidate Class Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1776,160],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Calculate 12 Dates","type":"main","index":0}]]},"Calculate 12 Dates":{"main":[[{"node":"Create Appointment in Cliniko","type":"main","index":0}]]},"Create Appointment in Cliniko":{"main":[[{"node":"Aggregate Results","type":"main","index":0}]]},"Aggregate Results":{"main":[[{"node":"Process Results","type":"main","index":0}]]},"Process Results":{"main":[[{"node":"Build Response","type":"main","index":0}]]},"Build Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log to Database","type":"main","index":0},{"node":"Invalidate Class Cache","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"451b53eb-7f88-43e2-b761-28bd2fc81880","triggerCount":1,"shared":[{"updatedAt":"2025-11-07T04:34:31.181Z","createdAt":"2025-11-07T04:34:31.181Z","role":"workflow:owner","workflowId":"3iCwSDEo0210tVYK","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-08T07:40:01.365Z","createdAt":"2025-11-07T05:22:31.009Z","id":"ie7mcpAWfmi8DqET","name":"RetellAI - Create New Client v1.2","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/create-new-client","responseMode":"responseNode","options":{}},"id":"a145d385-6a55-4b10-b3e9-841cbe8d9ed6","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"create-new-client"},{"parameters":{"jsCode":"const webhookData = $input.item.json.body || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\nconst first_name = (args.first_name || '').trim();\nconst last_name = (args.last_name || '').trim();\nconst phone = (args.phone || '').trim();\nconst email = (args.email || '').trim();\nconst village = (args.village || '').trim();\nconst date_of_birth = args.date_of_birth || '';\nconst call_id = call.call_id || args.call_id || '';\n\nif (!first_name) throw new Error('first_name is required');\nif (!last_name) throw new Error('last_name is required');\nif (!phone) throw new Error('phone is required');\nif (!village) throw new Error('village is required');\n\nreturn [{ json: { first_name, last_name, phone, email, village, date_of_birth, call_id, timestamp: new Date().toISOString(), start_time: Date.now() } }];"},"id":"24f2aa73-84c4-49c1-9bf9-71fc96db8921","name":"Extract & Validate","type":"n8n-nodes-base.code","typeVersion":2,"position":[240,0]},{"parameters":{"operation":"append","documentId":{"__rl":true,"mode":"id","value":"14dWZbvNykFox06a4UhHj1UBc5PI-iwZAog5Ia6iQUrw"},"sheetName":{"__rl":true,"value":372162973,"mode":"list","cachedResultName":"12_follow_up_list","cachedResultUrl":"https://docs.google.com/spreadsheets/d/14dWZbvNykFox06a4UhHj1UBc5PI-iwZAog5Ia6iQUrw/edit#gid=372162973"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":[],"schema":[{"id":"date_added","displayName":"date_added","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"type","displayName":"type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"client_name","displayName":"client_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"cliniko_id","displayName":"cliniko_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"phone","displayName":"phone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"village","displayName":"village","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"cancellation_date","displayName":"cancellation_date","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"reason","displayName":"reason","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"last_contact_date","displayName":"last_contact_date","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"status","displayName":"status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"outcome","displayName":"outcome","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"notes","displayName":"notes","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"f40f40b5-a87f-4b1f-be75-12a19ac9fc32","name":"Add to Sara's Follow-Up Sheet","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[480,0],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"jsCode":"const leadData = $items('Extract & Validate')[0].json;\n\nreturn [{ json: { success: true, lead_created: true, message: \"Thank you! Sara will review your information and call you back within 1 business day to complete your setup.\", first_name: leadData.first_name, last_name: leadData.last_name, phone: leadData.phone, village: leadData.village, call_id: leadData.call_id, timestamp: new Date().toISOString(), logging_data: { first_name: leadData.first_name, last_name: leadData.last_name, phone: leadData.phone, email: leadData.email, village: leadData.village, date_of_birth: leadData.date_of_birth, call_id: leadData.call_id, was_duplicate: false, duplicate_check_done: false, duration_ms: Math.round(Date.now() - leadData.start_time) } } }];"},"id":"fb85a274-5560-4b8c-aae3-b2167e6ec128","name":"Build Success Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[720,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify({ success: $json.success, lead_created: $json.lead_created, message: $json.message, call_id: $json.call_id, timestamp: $json.timestamp }) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"f8c41cb8-4043-4b75-b78d-9d63d7598125","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[944,0]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO new_leads_log (first_name, last_name, phone, email, village, date_of_birth, added_via, call_id, imported_to_cliniko, duplicate_check_done, was_duplicate, created_at) VALUES ('{{ $json.logging_data.first_name }}', '{{ $json.logging_data.last_name }}', '{{ $json.logging_data.phone }}', '{{ $json.logging_data.email }}', '{{ $json.logging_data.village }}', {{ $json.logging_data.date_of_birth ? \"'\" + $json.logging_data.date_of_birth + \"'\" : 'NULL' }}, 'voice_ai', '{{ $json.logging_data.call_id }}', false, {{ $json.logging_data.duplicate_check_done }}, {{ $json.logging_data.was_duplicate }}, now()) RETURNING *;","options":{"queryBatching":"independently"}},"id":"c04e105d-ae6d-4720-8923-406f477f419e","name":"Log to Database","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1168,0],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_log (webhook_name, call_id, request_body, response_body, success, duration_ms, cache_hit, created_at) VALUES ('create-new-client', '{{ $items(\"Respond to Webhook\")[0].json.call_id }}', '{{ JSON.stringify($items(\"Extract & Validate\")[0].json) }}'::jsonb, '{{ JSON.stringify($items(\"Respond to Webhook\")[0].json) }}'::jsonb, true, {{ $items(\"Respond to Webhook\")[0].json.logging_data.duration_ms }}, false, now()) RETURNING *;","options":{"queryBatching":"independently"}},"id":"7e90cbfd-ba89-419f-9ff4-d765d4f18567","name":"Log Webhook Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1392,0],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract & Validate","type":"main","index":0}]]},"Extract & Validate":{"main":[[{"node":"Add to Sara's Follow-Up Sheet","type":"main","index":0}]]},"Add to Sara's Follow-Up Sheet":{"main":[[{"node":"Build Success Response","type":"main","index":0}]]},"Build Success Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log to Database","type":"main","index":0}]]},"Log to Database":{"main":[[{"node":"Log Webhook Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"91a745b1-1f86-4b0c-8879-7b09a779e72b","triggerCount":1,"shared":[{"updatedAt":"2025-11-07T05:22:31.009Z","createdAt":"2025-11-07T05:22:31.009Z","role":"workflow:owner","workflowId":"ie7mcpAWfmi8DqET","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-07T18:39:26.228Z","createdAt":"2025-11-07T18:24:41.284Z","id":"f1ZCLp6LnVTecP3A","name":"log-faq-query v1.8 PRODUCTION","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/log-faq-query","responseMode":"responseNode","options":{}},"id":"5b68b408-5672-422f-9ceb-4375101942bf","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-624,128],"webhookId":"log-faq-query"},{"parameters":{"jsCode":"// Extract and validate request parameters (DO NOT THROW - return validation status)\nconst webhookData = $input.item.json.body || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\nconst question = (args.question || '').trim();\nconst answer_found = args.answer_found === true || args.answer_found === 'true';\nconst call_id = call.call_id || args.call_id || '';\n\n// Validation check\nif (!question) {\n  return [{\n    json: {\n      valid: false,\n      error_message: 'question is required',\n      call_id: call_id,\n      timestamp: new Date().toISOString(),\n      start_time: Date.now()\n    }\n  }];\n}\n\n// Valid data\nreturn [{\n  json: {\n    valid: true,\n    question,\n    answer_found,\n    call_id,\n    timestamp: new Date().toISOString(),\n    start_time: Date.now()\n  }\n}];"},"id":"1fd27c2c-5e08-4275-8d09-dd4e9d63c16d","name":"Extract & Validate","type":"n8n-nodes-base.code","typeVersion":2,"position":[-400,128]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.valid }}","value2":true}]},"options":{}},"id":"1b1e566c-c29a-4a2d-8bf9-ffbf5e7a50bb","name":"Check Validation","type":"n8n-nodes-base.if","typeVersion":2,"position":[-208,128]},{"parameters":{"jsCode":"const data = $input.item.json;\nconst now = new Date();\n\n// Format dates as strings (not date objects) to prevent Google Sheets auto-conversion\nconst dateStr = now.toLocaleString('en-AU', { \n  timeZone: 'Australia/Sydney', \n  year: 'numeric', \n  month: 'short', \n  day: 'numeric', \n  hour: '2-digit', \n  minute: '2-digit' \n});\n\n// Date added - use DD/MM/YYYY format as plain string\nconst day = now.toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney', day: '2-digit' });\nconst month = now.toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney', month: '2-digit' });\nconst year = now.toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney', year: 'numeric' });\nconst dateAddedStr = day + '/' + month + '/' + year;\n\nconst answerStatus = data.answer_found ? 'Answered' : 'Unanswered - Needs Review';\nconst formattedNotes = 'FAQ Query: ' + data.question + ' | Answer Found: ' + (data.answer_found ? 'YES' : 'NO') + ' | Call: ' + dateStr + ' | ID: ' + data.call_id;\n\nreturn [{\n  json: {\n    // Fields for Google Sheets (visible to Sara)\n    date_added: dateAddedStr,\n    type: 'FAQ',\n    client_name: 'FAQ Query',\n    cliniko_id: '',\n    phone: '',\n    village: '',\n    cancellation_date: '',\n    reason: data.question,\n    last_contact_date: '',\n    status: answerStatus,\n    outcome: '',\n    notes: formattedNotes,\n    first_name: '',\n    last_name: '',\n    email: '',\n    date_of_birth: '',\n    \n    // Internal fields for tracking (not for Google Sheets visible columns)\n    call_id: data.call_id,\n    service_interest: '',\n    funding_type: '',\n    timing_preference: '',\n    special_needs: '',\n    additional_context: '',\n    urgency: '',\n    formatted_notes: formattedNotes,\n    reason_summary: data.question,\n    human_readable_date: dateStr,\n    \n    // Internal tracking fields (for response/logging only, not Google Sheets)\n    timestamp: data.timestamp,\n    start_time: data.start_time\n  }\n}];"},"id":"e32c26e3-43b2-4d65-951d-2512990fb1e8","name":"Format for Google Sheets","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,0]},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"14dWZbvNykFox06a4UhHj1UBc5PI-iwZAog5Ia6iQUrw","mode":"id"},"sheetName":{"__rl":true,"value":372162973,"mode":"list","cachedResultName":"12_follow_up_list","cachedResultUrl":"https://docs.google.com/spreadsheets/d/14dWZbvNykFox06a4UhHj1UBc5PI-iwZAog5Ia6iQUrw/edit#gid=372162973"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"f430004a-eb17-4c07-8bdb-00543046bb42","name":"Add to Follow-Up Sheet","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[224,0],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}},"continueOnFail":true},{"parameters":{"jsCode":"const items = $input.all();\nconst sheetData = $items('Format for Google Sheets')[0].json;\nconst duration = Math.round(Date.now() - sheetData.start_time);\n\n// Check if Google Sheets write was successful\nconst sheetsSuccess = items.length > 0 && !items[0].json.error;\n\nreturn [{\n  json: {\n    success: true,\n    logged: sheetsSuccess,\n    sheets_error: sheetsSuccess ? null : 'Failed to write to Google Sheets',\n    question: sheetData.reason,\n    call_id: sheetData.call_id,\n    timestamp: sheetData.timestamp,\n    duration_ms: duration\n  }\n}];"},"id":"7d881cbc-44a3-4bfa-b8aa-9d5159c6b2cf","name":"Build Success Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify({ success: $json.success, logged: $json.logged, sheets_error: $json.sheets_error, timestamp: $json.timestamp }) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"cadc1a22-a12f-4104-8708-c55865570d31","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[672,0]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_log (webhook_name, call_id, request_body, response_body, success, duration_ms, cache_hit, created_at) VALUES ('log-faq-query', '{{ $items(\"Build Success Response\")[0].json.call_id }}', '{{ JSON.stringify($items(\"Extract & Validate\")[0].json) }}'::jsonb, '{{ JSON.stringify($items(\"Build Success Response\")[0].json) }}'::jsonb, true, {{ $items(\"Build Success Response\")[0].json.duration_ms }}, false, now()) RETURNING *;","options":{"queryBatching":"independently"}},"id":"3986b004-1d72-4471-b4cd-8941664c17c9","name":"Log Success","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[880,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"const data = $input.item.json;\nconst duration = Math.round(Date.now() - data.start_time);\n\nreturn [{\n  json: {\n    success: false,\n    error: {\n      code: 'VALIDATION_ERROR',\n      message: data.error_message || 'Invalid request parameters'\n    },\n    call_id: data.call_id || '',\n    timestamp: data.timestamp,\n    duration_ms: duration\n  }\n}];"},"id":"2ba921b2-8af8-4c8b-a908-3a8b7df55e09","name":"Build Error Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,240]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseCode":"400","responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"11f37837-13b9-45d5-9512-cd5725cb9969","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[224,240]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_log (webhook_name, call_id, request_body, response_body, success, duration_ms, cache_hit, error_code, created_at) VALUES ('log-faq-query', '{{ $items(\"Build Error Response\")[0].json.call_id }}', '{}'::jsonb, '{{ JSON.stringify($items(\"Build Error Response\")[0].json) }}'::jsonb, false, {{ $items(\"Build Error Response\")[0].json.duration_ms }}, false, '{{ $items(\"Build Error Response\")[0].json.error.code }}', now()) RETURNING *;","options":{"queryBatching":"independently"}},"id":"d6df27cc-5b59-40fc-87a1-590c7bf5372f","name":"Log Error","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[448,240],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract & Validate","type":"main","index":0}]]},"Extract & Validate":{"main":[[{"node":"Check Validation","type":"main","index":0}]]},"Check Validation":{"main":[[{"node":"Format for Google Sheets","type":"main","index":0}],[{"node":"Build Error Response","type":"main","index":0}]]},"Format for Google Sheets":{"main":[[{"node":"Add to Follow-Up Sheet","type":"main","index":0}]]},"Add to Follow-Up Sheet":{"main":[[{"node":"Build Success Response","type":"main","index":0}]]},"Build Success Response":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Respond Success":{"main":[[{"node":"Log Success","type":"main","index":0}]]},"Build Error Response":{"main":[[{"node":"Respond Error","type":"main","index":0}]]},"Respond Error":{"main":[[{"node":"Log Error","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"01187224-8516-4a16-b38d-121b983901ec","triggerCount":1,"shared":[{"updatedAt":"2025-11-07T18:24:41.284Z","createdAt":"2025-11-07T18:24:41.284Z","role":"workflow:owner","workflowId":"f1ZCLp6LnVTecP3A","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-25T08:34:05.940Z","createdAt":"2025-11-07T18:39:52.606Z","id":"8A0i0YU8pyIBknFy","name":"log-faq-query v1.9 PRODUCTION FINAL","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/log-faq-query","responseMode":"responseNode","options":{}},"id":"42d84251-4e4d-4185-8ebd-0d9352701924","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-624,128],"webhookId":"log-faq-query"},{"parameters":{"jsCode":"// Extract and validate request parameters (DO NOT THROW - return validation status)\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\nconst question = (args.question || '').trim();\nconst answer_found = args.answer_found === true || args.answer_found === 'true';\nconst call_id = call.call_id || args.call_id || '';\n\n// Validation check\nif (!question) {\n  return [{\n    json: {\n      valid: false,\n      error_message: 'question is required',\n      call_id: call_id,\n      timestamp: new Date().toISOString(),\n      start_time: Date.now()\n    }\n  }];\n}\n\n// Valid data\nreturn [{\n  json: {\n    valid: true,\n    question,\n    answer_found,\n    call_id,\n    timestamp: new Date().toISOString(),\n    start_time: Date.now()\n  }\n}];"},"id":"1c209e39-a1bc-4b9d-a82d-0909c3af52b9","name":"Extract & Validate","type":"n8n-nodes-base.code","typeVersion":2,"position":[-400,128]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.valid }}","value2":true}]},"options":{}},"id":"f7f8722d-a46a-4f01-87ac-a0c265a08097","name":"Check Validation","type":"n8n-nodes-base.if","typeVersion":2,"position":[-208,128]},{"parameters":{"jsCode":"const data = $input.item.json;\nconst now = new Date();\n\n// Format dates as strings (not date objects) to prevent Google Sheets auto-conversion\nconst dateStr = now.toLocaleString('en-AU', { \n  timeZone: 'Australia/Sydney', \n  year: 'numeric', \n  month: 'short', \n  day: 'numeric', \n  hour: '2-digit', \n  minute: '2-digit' \n});\n\n// Date added - use DD/MM/YYYY format as plain string\nconst day = now.toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney', day: '2-digit' });\nconst month = now.toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney', month: '2-digit' });\nconst year = now.toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney', year: 'numeric' });\nconst dateAddedStr = day + '/' + month + '/' + year;\n\nconst answerStatus = data.answer_found ? 'Answered' : 'Unanswered - Needs Review';\nconst formattedNotes = 'FAQ Query: ' + data.question + ' | Answer Found: ' + (data.answer_found ? 'YES' : 'NO') + ' | Call: ' + dateStr + ' | ID: ' + data.call_id;\n\nreturn [{\n  json: {\n    // Fields for Google Sheets (visible to Sara)\n    date_added: dateAddedStr,\n    type: 'FAQ',\n    client_name: '',  // Empty - no client name for FAQ queries\n    cliniko_id: '',\n    phone: '',\n    village: '',\n    cancellation_date: '',\n    reason: data.question,\n    last_contact_date: '',\n    status: answerStatus,\n    outcome: '',\n    notes: formattedNotes,\n    first_name: '',\n    last_name: '',\n    email: '',\n    date_of_birth: '',\n    \n    // Internal fields for tracking (not for Google Sheets visible columns)\n    call_id: data.call_id,\n    service_interest: '',\n    funding_type: '',\n    timing_preference: '',\n    special_needs: '',\n    additional_context: '',\n    urgency: '',\n    formatted_notes: formattedNotes,\n    reason_summary: data.question,\n    human_readable_date: dateStr,\n    \n    // Internal tracking fields (for response/logging only, not Google Sheets)\n    timestamp: data.timestamp,\n    start_time: data.start_time\n  }\n}];"},"id":"b353623c-aac0-47f8-b673-8fa8b8995c4b","name":"Format for Google Sheets","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,0]},{"parameters":{"operation":"append","documentId":{"__rl":true,"mode":"id","value":"14dWZbvNykFox06a4UhHj1UBc5PI-iwZAog5Ia6iQUrw"},"sheetName":{"__rl":true,"value":372162973,"mode":"list","cachedResultName":"12_follow_up_list","cachedResultUrl":"https://docs.google.com/spreadsheets/d/14dWZbvNykFox06a4UhHj1UBc5PI-iwZAog5Ia6iQUrw/edit#gid=372162973"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"d2ceea99-19f5-4eea-ad3a-453774296250","name":"Add to Follow-Up Sheet","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[224,0],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}},"continueOnFail":true},{"parameters":{"jsCode":"const items = $input.all();\nconst sheetData = $items('Format for Google Sheets')[0].json;\nconst duration = Math.round(Date.now() - sheetData.start_time);\n\n// Check if Google Sheets write was successful\nconst sheetsSuccess = items.length > 0 && !items[0].json.error;\n\nreturn [{\n  json: {\n    success: true,\n    logged: sheetsSuccess,\n    sheets_error: sheetsSuccess ? null : 'Failed to write to Google Sheets',\n    question: sheetData.reason,\n    call_id: sheetData.call_id,\n    timestamp: sheetData.timestamp,\n    duration_ms: duration\n  }\n}];"},"id":"78034996-d293-4575-902a-bd500091b442","name":"Build Success Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify({ success: $json.success, logged: $json.logged, sheets_error: $json.sheets_error, timestamp: $json.timestamp }) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"b99e74c1-579a-4ef1-ad21-3b0673dca9e2","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[672,0]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_log (webhook_name, call_id, request_body, response_body, success, duration_ms, cache_hit, created_at) VALUES ('log-faq-query', '{{ $items(\"Build Success Response\")[0].json.call_id }}', '{{ JSON.stringify($items(\"Extract & Validate\")[0].json) }}'::jsonb, '{{ JSON.stringify($items(\"Build Success Response\")[0].json) }}'::jsonb, true, {{ $items(\"Build Success Response\")[0].json.duration_ms }}, false, now()) RETURNING *;","options":{"queryBatching":"independently"}},"id":"004a3b97-81c6-45fc-bdce-c63c34b4cf07","name":"Log Success","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[880,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"const data = $input.item.json;\nconst duration = Math.round(Date.now() - data.start_time);\n\nreturn [{\n  json: {\n    success: false,\n    error: {\n      code: 'VALIDATION_ERROR',\n      message: data.error_message || 'Invalid request parameters'\n    },\n    call_id: data.call_id || '',\n    timestamp: data.timestamp,\n    duration_ms: duration\n  }\n}];"},"id":"82fc751f-c18f-4cd3-a72e-f374cc8b2bce","name":"Build Error Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,240]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseCode":"400","responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"11001ed4-1cf5-452d-9243-c64ea277139f","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[224,240]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_log (webhook_name, call_id, request_body, response_body, success, duration_ms, cache_hit, error_code, created_at) VALUES ('log-faq-query', '{{ $items(\"Build Error Response\")[0].json.call_id }}', '{}'::jsonb, '{{ JSON.stringify($items(\"Build Error Response\")[0].json) }}'::jsonb, false, {{ $items(\"Build Error Response\")[0].json.duration_ms }}, false, '{{ $items(\"Build Error Response\")[0].json.error.code }}', now()) RETURNING *;","options":{"queryBatching":"independently"}},"id":"9dedbb47-3b19-4db8-8894-b999e07628e7","name":"Log Error","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[448,240],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract & Validate","type":"main","index":0}]]},"Extract & Validate":{"main":[[{"node":"Check Validation","type":"main","index":0}]]},"Check Validation":{"main":[[{"node":"Format for Google Sheets","type":"main","index":0}],[{"node":"Build Error Response","type":"main","index":0}]]},"Format for Google Sheets":{"main":[[{"node":"Add to Follow-Up Sheet","type":"main","index":0}]]},"Add to Follow-Up Sheet":{"main":[[{"node":"Build Success Response","type":"main","index":0}]]},"Build Success Response":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Respond Success":{"main":[[{"node":"Log Success","type":"main","index":0}]]},"Build Error Response":{"main":[[{"node":"Respond Error","type":"main","index":0}]]},"Respond Error":{"main":[[{"node":"Log Error","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"9cd7b77b-fdbb-4c74-842f-ed88a62bd3b4","triggerCount":1,"shared":[{"updatedAt":"2025-11-07T18:39:52.606Z","createdAt":"2025-11-07T18:39:52.606Z","role":"workflow:owner","workflowId":"8A0i0YU8pyIBknFy","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-08T07:44:00.325Z","createdAt":"2025-11-07T21:08:06.419Z","id":"DCB31c1glDzJ1mUc","name":"RetellAI - Get Available Practitioners v1.2.2 PROPER CACHING","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-available-practitioners","responseMode":"responseNode","options":{}},"id":"bfcc9021-8d83-4c83-845e-0e1ae23c1b9d","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-880,128],"webhookId":"get-practitioners"},{"parameters":{"jsCode":"// Extract and validate request parameters\nconst webhookData = $input.item.json.body || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\nconst village = args.village || '';\nconst specialty = args.specialty ? args.specialty.toLowerCase() : '';\nconst call_id = call.call_id || args.call_id || '';\n\nif (!village) {\n  throw new Error('village is required');\n}\n\nconst validSpecialties = ['physio', 'ep', ''];\nif (specialty && !validSpecialties.slice(0, -1).includes(specialty)) {\n  throw new Error('Invalid specialty. Must be \"physio\" or \"ep\"');\n}\n\nconst startTime = Date.now();\n\nconsole.log('‚úÖ Request validated:', { village, specialty, call_id });\n\nreturn [{\n  json: {\n    village,\n    specialty: specialty || null,\n    call_id,\n    start_time: startTime,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"9b1d4eb9-78b3-4fa0-a9e8-5578f2630edb","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,128]},{"parameters":{"operation":"executeQuery","query":"SELECT \n  practitioner_id,\n  first_name,\n  last_name,\n  title,\n  villages,\n  active,\n  EXTRACT(EPOCH FROM (now() - cached_at))/3600 as hours_old\nFROM practitioners_cache\nWHERE active = true\n  AND cached_at > now() - interval '24 hours'\nORDER BY last_name, first_name;","options":{"queryBatching":"independently"}},"id":"c7a844a0-5b5b-4323-b284-e3f22d2eaa03","name":"Check Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-448,128],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"cache-check","leftValue":"={{ $json.practitioner_id }}","rightValue":"","operator":{"type":"string","operation":"notEmpty"}}],"combinator":"and"},"options":{}},"id":"dda9458a-aee4-4bf2-9071-56e7b5bbf2d0","name":"Cache Hit?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,128]},{"parameters":{"jsCode":"// CACHE HIT PATH - Mark all items as from cache\nconst items = $input.all();\n\nconsole.log(`‚úÖ CACHE HIT - Using ${items.length} cached practitioners`);\n\n// Mark all items as cache hit\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    from_cache: true,\n    cache_hit: true\n  }\n}));"},"id":"e0e8adad-816a-462c-9296-6541e37bcf79","name":"Mark Cache Hit","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,0]},{"parameters":{"jsCode":"// CACHE MISS PATH - Fetch from mock data source\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\nconsole.log('‚ùå CACHE MISS - Fetching fresh data');\n\n// Mock data - Replace with Google Sheets when ready\nconst allPractitioners = [\n  {\n    practitioner_id: '473326864069303022',\n    first_name: 'Liam',\n    last_name: 'Potter',\n    title: 'Physiotherapist',\n    villages: ['The Baytree', 'The Gardens'],\n    active: true\n  },\n  {\n    practitioner_id: '473326864069303023',\n    first_name: 'Sarah',\n    last_name: 'Johnson',\n    title: 'Exercise Physiologist',\n    villages: ['The Baytree'],\n    active: true\n  },\n  {\n    practitioner_id: '473326864069303024',\n    first_name: 'Emma',\n    last_name: 'Williams',\n    title: 'Physiotherapist',\n    villages: ['The Gardens', 'Palm Lake Resort'],\n    active: true\n  },\n  {\n    practitioner_id: '473326864069303025',\n    first_name: 'Michael',\n    last_name: 'Chen',\n    title: 'Exercise Physiologist',\n    villages: ['The Gardens', 'Palm Lake Resort'],\n    active: true\n  },\n  {\n    practitioner_id: '473326864069303026',\n    first_name: 'Sophie',\n    last_name: 'Anderson',\n    title: 'Physiotherapist',\n    villages: ['Palm Lake Resort'],\n    active: true\n  }\n];\n\nconsole.log(`üìã Fetched ${allPractitioners.length} practitioners`);\n\nreturn allPractitioners.map(p => ({\n  json: {\n    ...p,\n    from_cache: false,\n    cache_hit: false\n  }\n}));"},"id":"e1c1a734-28f0-4dd7-a687-3b22e11ee516","name":"Fetch Fresh Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,240]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO practitioners_cache (\n  practitioner_id,\n  first_name,\n  last_name,\n  title,\n  villages,\n  active,\n  cached_at\n)\nVALUES (\n  '{{ $json.practitioner_id }}',\n  '{{ $json.first_name }}',\n  '{{ $json.last_name }}',\n  '{{ $json.title }}',\n  ARRAY[{{ $json.villages.map(v => \"'\" + v + \"'\").join(',') }}],\n  {{ $json.active }},\n  now()\n)\nON CONFLICT (practitioner_id) \nDO UPDATE SET\n  first_name = EXCLUDED.first_name,\n  last_name = EXCLUDED.last_name,\n  title = EXCLUDED.title,\n  villages = EXCLUDED.villages,\n  active = EXCLUDED.active,\n  cached_at = now()\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"a6d194ef-4a5c-4e2d-a9d9-b26daf9180db","name":"Write to Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[224,240],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Build final response with filtering\nconst requestData = $items(\"Extract Request Data\")[0].json;\nconst allPractitionerItems = $input.all();\n\n// Determine if this was a cache hit\nconst cacheHit = allPractitionerItems.length > 0 && allPractitionerItems[0].json.cache_hit === true;\n\nconsole.log(`üì¶ Building response (cache_hit: ${cacheHit}, items: ${allPractitionerItems.length})`);\n\n// Get all practitioners\nconst allPractitioners = allPractitionerItems\n  .filter(item => item.json.practitioner_id)\n  .map(item => item.json);\n\n// Filter by village\nconst practitionersForVillage = allPractitioners.filter(p => \n  p.villages && p.villages.includes(requestData.village) && p.active\n);\n\nconsole.log(`üèòÔ∏è ${practitionersForVillage.length} practitioners for ${requestData.village}`);\n\n// Detect specialty\nconst withSpecialty = practitionersForVillage.map(p => {\n  const titleLower = (p.title || '').toLowerCase();\n  let specialty = 'unknown';\n  if (titleLower.includes('physiotherapist')) specialty = 'physio';\n  else if (titleLower.includes('exercise physiologist')) specialty = 'ep';\n  return { ...p, specialty };\n});\n\n// Apply specialty filter\nlet filtered = withSpecialty;\nif (requestData.specialty) {\n  filtered = withSpecialty.filter(p => p.specialty === requestData.specialty);\n  console.log(`üéØ After specialty filter: ${filtered.length}`);\n}\n\n// Sort by last name\nfiltered.sort((a, b) => (a.last_name || '').localeCompare(b.last_name || ''));\n\n// Format\nconst formatted = filtered.map(p => ({\n  practitioner_id: p.practitioner_id,\n  name: `${p.first_name} ${p.last_name}`,\n  title: p.title,\n  specialty: p.specialty,\n  villages_served: p.villages,\n  available: p.active\n}));\n\nconst response = {\n  success: true,\n  practitioners_available: formatted.length > 0,\n  count: formatted.length,\n  practitioners: formatted,\n  village: requestData.village,\n  specialty_filter: requestData.specialty || null,\n  call_id: requestData.call_id,\n  cache_hit: cacheHit,\n  timestamp: new Date().toISOString()\n};\n\nif (formatted.length === 0) {\n  response.message = `No ${requestData.specialty ? requestData.specialty + ' ' : ''}practitioners found for ${requestData.village}`;\n} else if (formatted.length === 1) {\n  response.message = `1 practitioner found for ${requestData.village}`;\n} else {\n  response.message = `${formatted.length} practitioners found for ${requestData.village}`;\n}\n\nconsole.log('‚úÖ Response ready:', response.message, `cache_hit: ${cacheHit}`);\n\nreturn [{ json: response }];"},"id":"ba514ca3-6462-45e4-bd3b-fc0477d76917","name":"Build Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,128]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"e4a6b48b-51fd-4926-8729-fd6f23edfc40","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,128]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_body,\n  response_body,\n  success,\n  duration_ms,\n  cache_hit,\n  created_at\n)\nVALUES (\n  'get-available-practitioners',\n  '{{ $items(\"Extract Request Data\")[0].json.call_id }}',\n  '{{ JSON.stringify($items(\"Extract Request Data\")[0].json) }}'::jsonb,\n  '{{ JSON.stringify($items(\"Build Response\")[0].json) }}'::jsonb,\n  true,\n  {{ Math.round((Date.now() - $items(\"Extract Request Data\")[0].json.start_time)) }},\n  {{ $items(\"Build Response\")[0].json.cache_hit || false }},\n  now()\n);","options":{}},"id":"44d16ec3-779f-4103-879d-a193e6965f01","name":"Log Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[880,128],"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Check Cache","type":"main","index":0}]]},"Check Cache":{"main":[[{"node":"Cache Hit?","type":"main","index":0}]]},"Cache Hit?":{"main":[[{"node":"Mark Cache Hit","type":"main","index":0}],[{"node":"Fetch Fresh Data","type":"main","index":0}]]},"Mark Cache Hit":{"main":[[{"node":"Build Response","type":"main","index":0}]]},"Fetch Fresh Data":{"main":[[{"node":"Write to Cache","type":"main","index":0}]]},"Write to Cache":{"main":[[{"node":"Build Response","type":"main","index":0}]]},"Build Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"f87442a9-8358-4a70-9111-5f2bfad98a79","triggerCount":1,"shared":[{"updatedAt":"2025-11-07T21:08:06.419Z","createdAt":"2025-11-07T21:08:06.419Z","role":"workflow:owner","workflowId":"DCB31c1glDzJ1mUc","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-08T07:05:35.464Z","createdAt":"2025-11-07T22:21:58.853Z","id":"9Mg99W1pZ7ro8FMq","name":"RetellAI - Log Call Start","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/log-call-start","responseMode":"responseNode","options":{}},"id":"ae4e3d92-eb9b-48f8-ba3a-d0197467e5c0","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"log-call-start"},{"parameters":{"jsCode":"// Extract and validate request parameters\nconst webhookData = $input.item.json.body || {};\nconst call = webhookData.call || webhookData;\nconst args = webhookData.args || {};\n\n// Extract parameters\nconst call_id = call.call_id || webhookData.call_id || args.call_id;\nconst from_number = call.from_number || webhookData.from_number || args.from_number;\nconst to_number = call.to_number || webhookData.to_number || args.to_number || '+61291234567';\nconst agent_name = webhookData.agent_name || args.agent_name || 'Unknown';\nconst call_started_at = webhookData.timestamp || args.timestamp || new Date().toISOString();\n\n// Validate required fields\nif (!call_id) {\n  throw new Error('call_id is required');\n}\n\nif (!from_number) {\n  throw new Error('from_number is required');\n}\n\nconst startTime = Date.now();\n\nreturn [{\n  json: {\n    call_id,\n    from_number,\n    to_number,\n    agent_name,\n    call_started_at,\n    start_time: startTime,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"5feab403-063c-478d-9611-a10c0a035d8e","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"operation":"executeQuery","query":"-- Insert call start record\nINSERT INTO call_log (\n  call_id,\n  from_number,\n  to_number,\n  agent_name,\n  call_started_at\n)\nVALUES (\n  '{{ $json.call_id }}',\n  '{{ $json.from_number }}',\n  '{{ $json.to_number }}',\n  '{{ $json.agent_name }}',\n  '{{ $json.call_started_at }}'\n)\nON CONFLICT (call_id) DO NOTHING\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"fa917b32-6304-4358-aaf9-6d96b0a37dc4","name":"Insert Call Log","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[448,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Build response\nconst items = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// Check if insert was successful\nif (items.length > 0 && items[0].json.id) {\n  // Record inserted successfully\n  return [{\n    json: {\n      success: true,\n      data: {\n        log_id: items[0].json.id,\n        call_id: items[0].json.call_id,\n        logged_at: items[0].json.call_started_at\n      },\n      timestamp: new Date().toISOString()\n    }\n  }];\n} else {\n  // Duplicate call_id (ON CONFLICT DO NOTHING triggered)\n  // Still return success since record exists\n  return [{\n    json: {\n      success: true,\n      data: {\n        log_id: null,\n        call_id: requestData.call_id,\n        logged_at: requestData.call_started_at,\n        note: 'Call already logged (duplicate call_id)'\n      },\n      timestamp: new Date().toISOString()\n    }\n  }];\n}"},"id":"b1fd9e55-5f4d-4e6c-ae54-723dc3720860","name":"Build Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"e4e9146a-d7fe-4213-84da-54cbc5a59200","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[880,0]}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Insert Call Log","type":"main","index":0}]]},"Insert Call Log":{"main":[[{"node":"Build Response","type":"main","index":0}]]},"Build Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"918949e6-b3e5-424e-a615-5cd5c4da30d5","triggerCount":1,"shared":[{"updatedAt":"2025-11-07T22:21:58.853Z","createdAt":"2025-11-07T22:21:58.853Z","role":"workflow:owner","workflowId":"9Mg99W1pZ7ro8FMq","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-25T08:36:11.799Z","createdAt":"2025-11-07T22:22:29.286Z","id":"PkIagKmTOll5XWIP","name":"RetellAI - Log Call End","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/log-call-end","responseMode":"responseNode","options":{}},"id":"81508492-6e1c-4cb5-b2a3-b420f2c44e51","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"log-call-end"},{"parameters":{"jsCode":"\n// Universal Phone Normalization (Australian E.164) - v9.09\n\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n\n  // 1. Strip everything except digits and '+'\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n\n  // 2. Already in E.164 format\n  if (phone.startsWith('+')) {\n    return phone;\n  }\n\n  // 3. Handle 8-digit local numbers (Assume NSW '02')\n  if (phone.length === 8 && !phone.startsWith('+')) {\n    return '+612' + phone;\n  }\n\n  // 4. Handle standard 10-digit AU numbers (04... or 02...)\n  if (phone.length === 10 && phone.startsWith('0')) {\n    return '+61' + phone.substring(1);\n  }\n\n  // 5. Handle numbers starting with 61 (missing +)\n  if (phone.length === 11 && phone.startsWith('61')) {\n    return '+' + phone;\n  }\n\n  // 6. Assume Australian if 9 digits (missing leading 0)\n  if (phone.length === 9) {\n    return '+61' + phone;\n  }\n\n  // 7. Return cleaned version (best effort)\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n\n// Extract and validate request parameters\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || $input.item.json || {};\nconst call = webhookData.call || webhookData;\nconst args = webhookData.args || {};\n\n// Extract parameters\nconst call_id = call.call_id || webhookData.call_id || args.call_id;\nconst patient_id = webhookData.patient_id || args.patient_id || null;\nconst intent = webhookData.intent || args.intent || null;\nconst outcome = webhookData.outcome || args.outcome || null;\nconst transfer_count = parseInt(webhookData.transfer_count || args.transfer_count || 0);\nconst call_ended_at = webhookData.timestamp || args.timestamp || new Date().toISOString();\n\n// Validate required fields\nif (!call_id) {\n  throw new Error('call_id is required');\n}\n\nconst startTime = Date.now();\n\nreturn [{\n  json: {\n    call_id,\n    patient_id,\n    intent,\n    outcome,\n    transfer_count,\n    call_ended_at,\n    start_time: startTime,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"0c4bd23a-8a8c-4efa-9adb-456bf824ce6c","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"operation":"executeQuery","query":"-- Update call log with end details\nUPDATE call_log\nSET \n  call_ended_at = '{{ $json.call_ended_at }}'::timestamptz,\n  duration_seconds = EXTRACT(EPOCH FROM ('{{ $json.call_ended_at }}'::timestamptz - call_started_at)),\n  patient_id = {{ $json.patient_id ? \"'\" + $json.patient_id + \"'\" : 'patient_id' }},\n  intent = {{ $json.intent ? \"'\" + $json.intent + \"'\" : 'intent' }},\n  outcome = {{ $json.outcome ? \"'\" + $json.outcome + \"'\" : 'outcome' }},\n  transfer_count = {{ $json.transfer_count || 0 }},\n  updated_at = now()\nWHERE call_id = '{{ $json.call_id }}'\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"d3dfe819-a1e2-45fa-868c-a58a792bf388","name":"Update Call Log","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[448,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Check if record was updated and build response\nconst items = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// Check if we have an updated record\nif (items.length === 0 || !items[0].json.id) {\n  // No record found - call_id doesn't exist\n  return [{\n    json: {\n      success: false,\n      error: {\n        code: 'NOT_FOUND',\n        message: 'No call_log record found for call_id. Call start was not logged.'\n      },\n      call_id: requestData.call_id,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// Record updated successfully\nconst record = items[0].json;\nreturn [{\n  json: {\n    success: true,\n    data: {\n      call_id: record.call_id,\n      duration_seconds: Math.round(record.duration_seconds),\n      outcome: record.outcome,\n      logged_at: record.call_ended_at\n    },\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"f5db720e-9890-4320-b28e-8f23686b3e3c","name":"Handle Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"e83a4cae-ea4a-4e65-aaf1-655ba4132c61","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[880,0]}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Update Call Log","type":"main","index":0}]]},"Update Call Log":{"main":[[{"node":"Handle Result","type":"main","index":0}]]},"Handle Result":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"1be6b321-8a25-4263-8ab6-e8d5a54127c9","triggerCount":1,"shared":[{"updatedAt":"2025-11-07T22:22:29.286Z","createdAt":"2025-11-07T22:22:29.286Z","role":"workflow:owner","workflowId":"PkIagKmTOll5XWIP","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-24T05:10:53.728Z","createdAt":"2025-11-08T01:13:37.708Z","id":"PczmEq6TYTlZ3Eev","name":"RetellAI - Lookup Caller by DOB v2.1 FIXED","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/lookup-caller-dob","responseMode":"responseNode","options":{}},"id":"c9f14f1b-5d4d-4f4e-bc68-d74592dc7ea5","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"lookup-caller-dob"},{"parameters":{"operation":"executeQuery","query":"SELECT \n  patient_id,\n  first_name,\n  last_name,\n  preferred_name,\n  email,\n  phone,\n  phone_mobile,\n  date_of_birth,\n  village,\n  archived,\n  last_synced\nFROM patients\nWHERE \n  date_of_birth = '{{ $json.body.args.date_of_birth }}'\n  AND LOWER(first_name) LIKE LOWER('%{{ $json.body.args.first_name }}%')\n  AND LOWER(last_name) LIKE LOWER('%{{ $json.body.args.last_name }}%')\n  AND archived = false\nLIMIT 1","options":{"queryReplacement":""}},"id":"56c33b0e-5e18-4abb-8afd-cc6491f67aa5","name":"Postgres - Search by DOB","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[640,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"\n// Universal Phone Normalization (Australian E.164) - v9.09\n\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n\n  // 1. Strip everything except digits and '+'\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n\n  // 2. Already in E.164 format\n  if (phone.startsWith('+')) {\n    return phone;\n  }\n\n  // 3. Handle 8-digit local numbers (Assume NSW '02')\n  if (phone.length === 8 && !phone.startsWith('+')) {\n    return '+612' + phone;\n  }\n\n  // 4. Handle standard 10-digit AU numbers (04... or 02...)\n  if (phone.length === 10 && phone.startsWith('0')) {\n    return '+61' + phone.substring(1);\n  }\n\n  // 5. Handle numbers starting with 61 (missing +)\n  if (phone.length === 11 && phone.startsWith('61')) {\n    return '+' + phone;\n  }\n\n  // 6. Assume Australian if 9 digits (missing leading 0)\n  if (phone.length === 9) {\n    return '+61' + phone;\n  }\n\n  // 7. Return cleaned version (best effort)\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n\n// Extract DOB from request\nconst dob = $input.item.json.body?.date_of_birth || '';\n\n// Get all results from Postgres\nconst results = $input.all();\n\nif (results.length === 0 || !results[0].json.patient_id) {\n  // No patients found\n  return [\n    {\n      json: {\n        found: false,\n        search_criteria: {\n          date_of_birth: dob\n        },\n        message: \"No patients found with this date of birth\",\n        suggestion: \"Verify the date format (YYYY-MM-DD) or try searching by name\",\n        timestamp: new Date().toISOString()\n      }\n    }\n  ];\n}\n\n// Format all matching patients\nconst patients = results.map(result => {\n  const patient = result.json;\n  return {\n    id: patient.patient_id,\n    first_name: patient.first_name,\n    last_name: patient.last_name,\n    full_name: `${patient.first_name} ${patient.last_name}`,\n    email: patient.email || null,\n    phone: patient.phone || patient.phone_mobile,\n    mobile: patient.phone_mobile || null,\n    dob: patient.date_of_birth,\n    village: patient.village || 'Unknown',\n    is_archived: patient.archived === true,\n    is_active: patient.archived === false,\n    cliniko_url: `https://your-clinic.au.cliniko.com/patients/${patient.patient_id}`,\n    created_at: patient.created_at,\n    updated_at: patient.updated_at\n  };\n});\n\nreturn [\n  {\n    json: {\n      found: true,\n      match_count: patients.length,\n      search_criteria: {\n        date_of_birth: dob\n      },\n      patients: patients,\n      message: patients.length === 1 ? \"Exact match found\" : `${patients.length} patients share this date of birth`,\n      timestamp: new Date().toISOString()\n    }\n  }\n];"},"id":"3b57fad9-00ce-4c43-a731-5858fcb7abf6","name":"Transform for RetellAI","type":"n8n-nodes-base.code","typeVersion":2,"position":[864,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"efdb6313-5eae-4cb9-8d56-2e261d1c68ce","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1088,0]}],"connections":{"Webhook":{"main":[[{"node":"Postgres - Search by DOB","type":"main","index":0}]]},"Postgres - Search by DOB":{"main":[[{"node":"Transform for RetellAI","type":"main","index":0}]]},"Transform for RetellAI":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"05c4e4fe-cd1e-4541-aa9c-7dc377cd7c57","triggerCount":1,"shared":[{"updatedAt":"2025-11-08T01:13:37.708Z","createdAt":"2025-11-08T01:13:37.708Z","role":"workflow:owner","workflowId":"PczmEq6TYTlZ3Eev","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-02T09:29:02.345Z","createdAt":"2025-11-08T01:24:13.259Z","id":"Lc2wFxn0UjPPMqaO","name":"RetellAI - Get Operating Hours v1.1 FIXED (NEEDS SHEET SETUP)","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-operating-hours","responseMode":"responseNode","options":{}},"id":"adbfdafb-e19e-45bd-bcdf-f772ae2ef0be","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"get-operating-hours"},{"parameters":{"documentId":{"__rl":true,"value":"13EaXjEQKRye-hWmtHAMnDmKJgwp34O2iGk-ldwqm9uI","mode":"id"},"sheetName":{"__rl":true,"value":"Operating_Hours","mode":"name"},"options":{}},"id":"ff9b4e11-c231-48d2-93a7-d8d887c10822","name":"Google Sheets - Read Hours","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[224,0],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"jsCode":"// STANDARD EXTRACTION PATTERN - RetellAI Compatible\nconst webhookData = $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst requestedVillage = (args.village || '').toLowerCase().trim();\n\nconst hoursRows = $input.all();\n\nif (hoursRows.length === 0) {\n  return [{ json: { success: false, message: \"No operating hours data found\", timestamp: new Date().toISOString() } }];\n}\n\nconst villageHours = [];\nfor (const row of hoursRows) {\n  const village = row.json.Village || '';\n  const day = row.json.Day || '';\n  const opens = row.json.Opens || '';\n  const closes = row.json.Closes || '';\n  const notes = row.json.Notes || '';\n\n  if (!village || village.toLowerCase() === 'village' || !day) continue;\n  if (requestedVillage && !village.toLowerCase().includes(requestedVillage)) continue;\n\n  villageHours.push({\n    village, day, opens, closes,\n    hours: opens && closes ? `${opens} - ${closes}` : 'Closed',\n    is_open: !!(opens && closes),\n    notes\n  });\n}\n\nif (villageHours.length === 0) {\n  return [{ json: { success: false, message: requestedVillage ? `No operating hours found for ${requestedVillage}` : \"No operating hours data available\", timestamp: new Date().toISOString() } }];\n}\n\nconst byVillage = {};\nfor (const hour of villageHours) {\n  if (!byVillage[hour.village]) byVillage[hour.village] = [];\n  byVillage[hour.village].push({ day: hour.day, opens: hour.opens, closes: hour.closes, hours: hour.hours, is_open: hour.is_open, notes: hour.notes });\n}\n\nconst villages = Object.keys(byVillage).map(villageName => ({ village: villageName, schedule: byVillage[villageName] }));\n\nreturn [{ json: { success: true, village_count: villages.length, villages, message: requestedVillage ? `Operating hours for ${requestedVillage}` : `Operating hours for all ${villages.length} villages`, timestamp: new Date().toISOString() } }];"},"id":"764d57f9-518a-4d72-b81d-f14cd5127b48","name":"Format Operating Hours","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"e113b99a-0ab1-4436-b1fe-0cdc1cbc3625","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,0]}],"connections":{"Webhook":{"main":[[{"node":"Google Sheets - Read Hours","type":"main","index":0}]]},"Google Sheets - Read Hours":{"main":[[{"node":"Format Operating Hours","type":"main","index":0}]]},"Format Operating Hours":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"0cba4a86-daf5-4c79-a358-c493b7d01a39","triggerCount":1,"shared":[{"updatedAt":"2025-11-08T01:24:13.259Z","createdAt":"2025-11-08T01:24:13.259Z","role":"workflow:owner","workflowId":"Lc2wFxn0UjPPMqaO","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-08T19:22:59.012Z","createdAt":"2025-11-08T01:39:45.507Z","id":"41qudxSceZQSLkSA","name":"RetellAI - Get Availability v2.8 FIXED","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-availability","responseMode":"responseNode","options":{}},"id":"8cd926ba-9114-431a-9068-2d085514650f","name":"Webhook Trigger","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"get-availability-webhook"},{"parameters":{"jsCode":"// Extract and validate request parameters\nconst webhookData = $input.item.json.body || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\n// Extract parameters\nconst practitioner_id = args.practitioner_id || '473326864069303022';\nconst date = args.date || '';\nconst call_id = call.call_id || args.call_id || 'unknown';\n\n// Validate required fields\nif (!date) {\n  throw new Error('date is required (format: YYYY-MM-DD)');\n}\n\n// Parse date and create date range (full day in UTC)\nconst dateObj = new Date(date + 'T00:00:00Z');\nif (isNaN(dateObj.getTime())) {\n  throw new Error('Invalid date format. Use YYYY-MM-DD');\n}\n\n// Create start and end timestamps for the day\nconst date_start = date + 'T00:00:00Z';\nconst date_end = date + 'T23:59:59Z';\n\n// Calculate booking window (21 days from now)\nconst now = new Date();\nconst maxBookingDate = new Date(now);\nmaxBookingDate.setDate(maxBookingDate.getDate() + 21);\n\n// Check if requested date is within booking window\nif (dateObj < now) {\n  throw new Error('Cannot book appointments in the past');\n}\n\nif (dateObj > maxBookingDate) {\n  throw new Error('Cannot book more than 21 days in advance');\n}\n\nconsole.log('‚úÖ Request validated:', {\n  practitioner_id,\n  date,\n  date_start,\n  date_end,\n  call_id\n});\n\nreturn [{\n  json: {\n    practitioner_id,\n    date,\n    date_start,\n    date_end,\n    call_id,\n    timestamp: new Date().toISOString(),\n    start_time: Date.now()\n  }\n}];"},"id":"f97b541d-1e8c-4651-a7af-7d52e51d0df8","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"jsCode":"// Build Cliniko API URL with individual_appointments endpoint\nconst data = $input.item.json;\n\nconst practitioner_id = data.practitioner_id;\nconst date_start = data.date_start;\nconst date_end = data.date_end;\n\n// Use /individual_appointments endpoint (not legacy /appointments)\n// Cliniko API requires q[] (with brackets) for filtering\n// Multiple filters = multiple q[] parameters\nconst url = `https://api.au2.cliniko.com/v1/individual_appointments?q[]=practitioner_id:=${practitioner_id}&q[]=starts_at:>=${date_start}&q[]=starts_at:<=${date_end}&per_page=100`;\n\nconsole.log('üîó Built Cliniko URL (individual_appointments):', url);\n\nreturn [{\n  json: {\n    ...data,\n    cliniko_url: url,\n    practitioner_id_filter: practitioner_id,\n    date_filter_start: date_start,\n    date_filter_end: date_end\n  }\n}];"},"id":"bfe32005-ecd3-4d67-8b57-34aabb55cb39","name":"Build Cliniko URL","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"url":"={{ $json.cliniko_url }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"},{"name":"Accept","value":"application/json"}]},"options":{"response":{"response":{"neverError":true,"responseFormat":"json"}},"timeout":10000}},"id":"ca339be5-e5b1-42f8-9584-734ab271c889","name":"Query Cliniko Appointments","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[672,0],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"jsCode":"// Handle Cliniko API response and extract booked slots\nconst items = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\nif (items.length === 0) {\n  console.error('‚ùå No response from Cliniko API');\n  throw new Error('Cliniko API returned no data');\n}\n\nconst response = items[0].json;\n\n// Check for API errors\nif (response.error || response.errors) {\n  console.error('‚ùå Cliniko API Error:', response);\n  throw new Error(response.error || response.errors || 'Cliniko API error');\n}\n\n// Extract individual appointments (modern endpoint)\nconst appointments = response.individual_appointments || [];\nconst total_entries = response.total_entries || 0;\n\nconsole.log(`üìÖ Cliniko returned ${appointments.length} individual appointments (total: ${total_entries})`);\n\n// Extract booked time slots\nconst booked_slots = appointments.map(apt => {\n  return {\n    start: apt.starts_at,\n    end: apt.ends_at,\n    appointment_id: apt.id,\n    patient_name: apt.patient_name || 'Unknown',\n    practitioner_url: apt.practitioner?.links?.self || null,\n    notes: apt.notes || ''\n  };\n});\n\nconsole.log('üö´ Booked slots:', booked_slots.length);\nif (booked_slots.length > 0) {\n  console.log('üìã Sample booked times:', booked_slots.slice(0, 3).map(s => s.start).join(', '));\n}\n\nreturn [{\n  json: {\n    ...requestData,\n    booked_slots,\n    total_booked: appointments.length,\n    cliniko_total: total_entries\n  }\n}];"},"id":"4343ddfc-b2e9-4862-b562-42fc9195781b","name":"Extract Booked Slots","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,0]},{"parameters":{"operation":"executeQuery","query":"-- Get recurring client protected slots for this practitioner and day\nSELECT \n  day_of_week,\n  time_slot,\n  patient_name,\n  frequency\nFROM recurring_clients\nWHERE practitioner_id = '{{ $json.practitioner_id }}'\n  AND day_of_week = EXTRACT(DOW FROM TIMESTAMP '{{ $json.date }}T00:00:00Z')\n  AND active = true;","options":{"queryBatching":"independently"}},"id":"1a837e53-67f3-49ca-8c28-776e2e692a04","name":"Get Recurring Protected Slots","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1104,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Generate available time slots for the day\n// Exclude booked slots and recurring protected slots\n\nconst items = $input.all();\nconst requestData = $items(\"Extract Booked Slots\")[0].json;\nconst recurringData = items; // May be empty if no protected slots\n\nconst date = requestData.date;\nconst booked_slots = requestData.booked_slots || [];\n\n// Extract recurring protected slots (if any)\nconst protected_slots = [];\nif (recurringData.length > 0 && recurringData[0].json.day_of_week !== undefined) {\n  // We have protected slots\n  recurringData.forEach(item => {\n    if (item.json.time_slot) {\n      protected_slots.push({\n        time: item.json.time_slot,\n        reason: `Protected for ${item.json.patient_name || 'recurring client'}`,\n        frequency: item.json.frequency\n      });\n    }\n  });\n}\n\nconsole.log(`üîí Found ${protected_slots.length} protected recurring slots`);\n\n// Define business hours (9 AM to 5 PM, hourly slots)\nconst business_hours = [\n  '09:00:00',\n  '10:00:00', \n  '11:00:00',\n  '12:00:00',\n  '13:00:00',\n  '14:00:00',\n  '15:00:00',\n  '16:00:00'\n];\n\n// Generate all potential slots\nconst available_slots = [];\n\nfor (const time of business_hours) {\n  const slot_start = `${date}T${time}Z`;\n  const slot_datetime = new Date(slot_start);\n  \n  // Calculate end time (1 hour appointment)\n  const slot_end_datetime = new Date(slot_datetime);\n  slot_end_datetime.setHours(slot_end_datetime.getHours() + 1);\n  const slot_end = slot_end_datetime.toISOString();\n  \n  // Check if slot is already booked\n  const is_booked = booked_slots.some(booked => {\n    const booked_start = new Date(booked.start);\n    const booked_end = new Date(booked.end);\n    // Check for any overlap\n    return (\n      (slot_datetime >= booked_start && slot_datetime < booked_end) ||\n      (slot_end_datetime > booked_start && slot_end_datetime <= booked_end) ||\n      (slot_datetime <= booked_start && slot_end_datetime >= booked_end)\n    );\n  });\n  \n  // Check if slot is protected for recurring client\n  const is_protected = protected_slots.some(protected => {\n    return protected.time === time;\n  });\n  \n  // Only add if not booked and not protected\n  if (!is_booked && !is_protected) {\n    available_slots.push({\n      datetime: slot_start,\n      time: time.substring(0, 5), // \"09:00\"\n      display_time: formatTime(time),\n      duration_minutes: 60\n    });\n  }\n}\n\n// Format time for display (24h to 12h)\nfunction formatTime(time24) {\n  const [hours, minutes] = time24.split(':');\n  const hour = parseInt(hours);\n  const ampm = hour >= 12 ? 'PM' : 'AM';\n  const hour12 = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;\n  return `${hour12}:${minutes} ${ampm}`;\n}\n\nconsole.log(`‚úÖ Generated ${available_slots.length} available slots`);\nconsole.log(`üö´ Filtered out ${booked_slots.length} booked slots`);\nconsole.log(`üîí Filtered out ${protected_slots.length} protected slots`);\n\nreturn [{\n  json: {\n    ...requestData,\n    available_slots,\n    total_available: available_slots.length,\n    total_booked: booked_slots.length,\n    total_protected: protected_slots.length\n  }\n}];"},"id":"45df23be-e25a-4d7e-9d74-4776e1927974","name":"Generate Available Slots","type":"n8n-nodes-base.code","typeVersion":2,"position":[1328,0]},{"parameters":{"jsCode":"// Build final response for RetellAI\nconst data = $input.item.json;\n\nconst response = {\n  success: true,\n  date: data.date,\n  practitioner_id: data.practitioner_id,\n  available_slots: data.available_slots,\n  summary: {\n    total_available: data.total_available,\n    total_booked: data.total_booked,\n    total_protected: data.total_protected\n  },\n  call_id: data.call_id,\n  timestamp: new Date().toISOString()\n};\n\n// Add user-friendly message\nif (data.total_available === 0) {\n  response.message = 'No available slots for this date. All slots are booked or protected.';\n} else if (data.total_available === 1) {\n  response.message = '1 available slot found.';\n} else {\n  response.message = `${data.total_available} available slots found.`;\n}\n\nconsole.log('‚úÖ Response ready:', response.message);\n\nreturn [{\n  json: response\n}];"},"id":"a2e6dc84-31cc-45ad-b7cc-9edd2efcc49e","name":"Build Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1552,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json, null, 2) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"8b5898a8-ed1d-436a-841f-db4a2c994254","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[1760,0]},{"parameters":{"operation":"executeQuery","query":"-- Log webhook execution\nINSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_body,\n  response_body,\n  success,\n  duration_ms,\n  cache_hit,\n  created_at\n) VALUES (\n  'get-availability',\n  '{{ $items(\"Extract Request Data\")[0].json.call_id }}',\n  '{{ JSON.stringify($items(\"Extract Request Data\")[0].json) }}'::jsonb,\n  '{{ JSON.stringify($json) }}'::jsonb,\n  {{ $json.success }},\n  {{ Date.now() - $items(\"Extract Request Data\")[0].json.start_time }},\n  false,\n  NOW()\n) RETURNING *;","options":{"queryBatching":"independently"}},"id":"64297913-29f8-49dd-867a-bee3b9e88e13","name":"Log Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1984,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Handle errors and format error response\nconst error = $input.item.json.error || {};\nconst errorMessage = error.message || 'Unknown error occurred';\n\nconsole.error('‚ùå Error in webhook:', errorMessage);\n\nconst errorResponse = {\n  success: false,\n  error: {\n    code: 'VALIDATION_ERROR',\n    message: errorMessage\n  },\n  call_id: $items(\"Webhook Trigger\")[0]?.json?.body?.call?.call_id || 'unknown',\n  timestamp: new Date().toISOString()\n};\n\nreturn [{\n  json: errorResponse\n}];"},"id":"7526db67-8bd8-4d5c-8482-7dac2349e2aa","name":"Handle Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,224]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json, null, 2) }}","options":{"responseCode":400,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"aeb3c340-2ae5-4233-b0f0-7376d76d2e95","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[448,224]}],"connections":{"Webhook Trigger":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Build Cliniko URL","type":"main","index":0},{"node":"Handle Error","type":"main","index":0}]]},"Build Cliniko URL":{"main":[[{"node":"Query Cliniko Appointments","type":"main","index":0}]]},"Query Cliniko Appointments":{"main":[[{"node":"Extract Booked Slots","type":"main","index":0}]]},"Extract Booked Slots":{"main":[[{"node":"Get Recurring Protected Slots","type":"main","index":0}]]},"Get Recurring Protected Slots":{"main":[[{"node":"Generate Available Slots","type":"main","index":0}]]},"Generate Available Slots":{"main":[[{"node":"Build Response","type":"main","index":0}]]},"Build Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Execution","type":"main","index":0}]]},"Handle Error":{"main":[[{"node":"Respond Error","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"48e90ba3-070a-4fe4-82e8-2fff4058c4d3","triggerCount":1,"shared":[{"updatedAt":"2025-11-08T01:39:45.507Z","createdAt":"2025-11-08T01:39:45.507Z","role":"workflow:owner","workflowId":"41qudxSceZQSLkSA","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-16T19:05:50.912Z","createdAt":"2025-11-08T06:27:09.601Z","id":"P0xnQhtFiWZaFMd1","name":"RetellAI - Email End of Call Summary + Sheets v2 FIXED","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/email-call-summary","responseMode":"responseNode","options":{}},"id":"2c756f4e-a497-49a0-a27f-2c9bf22ae100","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-240,0],"webhookId":"1565fad1-c77c-46bf-b164-2f40bf462708"},{"parameters":{"jsCode":"// Check if call has ended (has end_timestamp)\nconst body = $input.item.json.body || {};\nconst call = body.call || {};\n\n// Only process calls that have ended\nif (!call.end_timestamp) {\n  // Stop execution - call hasn't ended yet\n  return [];\n}\n\n// Pass through the data for ended calls\nreturn [$input.item];"},"id":"884fbe26-076d-4f2a-9a95-dfe8551216a8","name":"Only Process Ended Calls","type":"n8n-nodes-base.code","typeVersion":2,"position":[-48,0]},{"parameters":{"operation":"executeQuery","query":"-- Look up transfer data AND patient info by call_id\n-- ALWAYS returns one row with complete patient info when available\n\nCREATE TABLE IF NOT EXISTS retell_calls (\n  call_id      text PRIMARY KEY,\n  phone_number text,\n  no_phone     boolean DEFAULT false,\n  from_number  text,\n  created_at   timestamptz DEFAULT now(),\n  updated_at   timestamptz DEFAULT now()\n);\n\n-- Get the call_id from webhook\nWITH call_info AS (\n  SELECT '{{ $json.body.call.call_id }}' as search_call_id\n),\n-- Look for transfer (from Sara's tool)\ntransfer_lookup AS (\n  SELECT *\n  FROM retell_transfers\n  WHERE call_id = (SELECT search_call_id FROM call_info)\n  ORDER BY created_at DESC\n  LIMIT 1\n),\n-- Look for retell_calls entry (from Lookup Caller tool at start of call)\nretell_call_lookup AS (\n  SELECT *\n  FROM retell_calls\n  WHERE call_id = (SELECT search_call_id FROM call_info)\n  LIMIT 1\n),\n-- Look up patient by phone number\npatient_lookup AS (\n  SELECT\n    patient_id,\n    first_name,\n    last_name,\n    preferred_name,\n    email,\n    phone,\n    phone_mobile,\n    date_of_birth,\n    village,\n    archived\n  FROM patients\n  WHERE archived = false\n    AND (\n      phone_normalized = (SELECT phone_number FROM retell_call_lookup)\n      OR phone_mobile_normalized = (SELECT phone_number FROM retell_call_lookup)\n    )\n  LIMIT 1\n)\n-- ALWAYS return one row with merged data\nSELECT\n  -- Transfer fields (from Sara's tool)\n  t.transfer_id,\n  COALESCE(t.call_id, ci.search_call_id) as call_id,\n  t.created_at as transfer_created_at,\n  t.updated_at as transfer_updated_at,\n  \n  -- Caller info: prefer transfer, fallback to patient lookup\n  COALESCE(\n    t.caller_name,\n    CONCAT(p.first_name, ' ', p.last_name)\n  ) as caller_name,\n  \n  COALESCE(t.village, p.village) as village,\n  \n  COALESCE(\n    t.patient_id,\n    p.patient_id::text\n  ) as patient_id,\n  \n  -- Transfer-specific fields\n  t.phone_number as transfer_phone_number,\n  t.no_phone,\n  t.intent,\n  t.urgency,\n  t.details,\n  \n  -- retell_calls data\n  rc.phone_number AS stored_phone_number,\n  rc.no_phone AS stored_no_phone,\n  rc.from_number AS carrier_from_number,\n  \n  -- Patient data for reference\n  p.first_name,\n  p.last_name,\n  p.preferred_name,\n  p.email,\n  p.phone as patient_phone,\n  p.phone_mobile as patient_mobile,\n  p.date_of_birth,\n  p.village as patient_village\n  \nFROM call_info ci\nLEFT JOIN transfer_lookup t ON TRUE\nLEFT JOIN retell_call_lookup rc ON TRUE\nLEFT JOIN patient_lookup p ON TRUE\nLIMIT 1;","options":{"queryReplacement":""}},"id":"8b64d66f-b251-4108-8997-4afe930b43a9","name":"Postgres Load Transfer","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[208,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"const wh = $items('Webhook')?.[0]?.json || {};\nconst body = wh.body || {};\nconst call = body.call || {};\nconst pgItems = $items('Postgres Load Transfer') || [];\nconst row = pgItems.length > 0 && pgItems[0]?.json ? (Array.isArray(pgItems[0].json) ? pgItems[0].json[0] : pgItems[0].json) : {};\n\nconst esc = (s) => String(s ?? '').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[c]));\n\nfunction normAU(p) {\n  if (!p) return null;\n  let d = ('' + p).replace(/[^0-9+]/g, '');\n  if (d.startsWith('+')) return d;\n  if (d.startsWith('0')) d = '61' + d.slice(1);\n  if (!d.startsWith('61')) d = '61' + d;\n  return '+' + d;\n}\n\nfunction fmtAU(ts) {\n  if (!ts) return null;\n  const d = new Date(ts);\n  if (isNaN(d)) return null;\n  return d.toLocaleString('en-AU', { timeZone: 'Australia/Melbourne' });\n}\n\nfunction humanDuration(ms) {\n  if (ms == null || isNaN(ms)) return null;\n  const total = Math.max(0, Math.floor(Number(ms) / 1000));\n  const m = Math.floor(total / 60);\n  const s = total % 60;\n  return `${m}m ${s}s`;\n}\n\nconst metadata = call.metadata || {};\nconst analysis = call.call_analysis || {};\nconst callerName = row.caller_name || metadata.caller_name || analysis.user_name || 'Not provided';\nconst village = row.village || metadata.village || 'Not specified';\nconst intent = row.intent || metadata.intent || 'General inquiry';\nconst urgency = row.urgency || metadata.urgency || 'routine';\nconst details = row.details || metadata.details || analysis.call_summary || '';\nconst patientId = row.patient_id || metadata.patient_id || 'Not available';\nconst callId = call.call_id || 'Unknown';\nconst agentId = call.agent_id || 'N/A';\nconst agentVersion = call.agent_version || 'N/A';\nconst callStatus = call.call_status || 'unknown';\nconst direction = call.direction || 'unknown';\nconst fromPhone = normAU(row.carrier_from_number || call.from_number) || 'Not captured';\nconst toNumber = normAU(call.to_number) || 'N/A';\nlet callbackBase = (row.no_phone === true) ? null : (row.phone_number || call.from_number);\nconst callbackPhone = (row.no_phone === true) ? 'Declined to provide' : (normAU(callbackBase) || 'Not provided');\nconst startTime = fmtAU(call.start_timestamp);\nconst endTime = fmtAU(call.end_timestamp);\nconst duration = ('duration_ms' in call) ? humanDuration(call.duration_ms) : null;\nconst durationSeconds = call.call_cost?.total_duration_seconds || (call.duration_ms ? Math.floor(call.duration_ms / 1000) : 0);\nconst disconnect = call.disconnection_reason || null;\nconst processedTimestamp = new Date().toLocaleString('en-AU', { timeZone: 'Australia/Melbourne' });\nconst recordingUrl = call.recording_url || null;\n\nfunction roleLabel(r) {\n  if (!r) return 'Unknown';\n  const t = r.toLowerCase();\n  if (['assistant','agent','ai'].includes(t)) return 'Agent';\n  if (['user','caller','human'].includes(t)) return 'User';\n  return r.charAt(0).toUpperCase() + r.slice(1);\n}\n\nlet htmlTranscript = 'No transcript available';\nlet plainTranscript = 'No transcript available';\nif (Array.isArray(call.transcript_object) && call.transcript_object.length) {\n  htmlTranscript = call.transcript_object.map(t => `${esc(roleLabel(t.role))}: ${esc((t.content || '').trim())}`).join('<br><br>');\n  plainTranscript = call.transcript_object.map(t => `${roleLabel(t.role)}: ${(t.content || '').trim()}`).join('\\n\\n');\n}\n\nconst subject = `[Reignite] End of Call Summary ‚Äî ${callerName} (${duration || 'N/A'})`;\nconst td = 'style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"';\nconst th = 'style=\"padding:8px 10px;border:1px solid #e5e7eb;background:#f9fafb;text-align:left;font-weight:600;font-family:Arial,Helvetica,sans-serif;font-size:13px;line-height:18px;color:#111827\"';\n\nlet timingsRows = `<tr><td ${td}><strong>Start Time</strong></td><td ${td}>${esc(startTime || 'N/A')}</td></tr>`;\nif (endTime) timingsRows += `<tr><td ${td}><strong>End Time</strong></td><td ${td}>${esc(endTime)}</td></tr>`;\nif (duration) timingsRows += `<tr><td ${td}><strong>Duration</strong></td><td ${td}>${esc(duration)}</td></tr>`;\nif (durationSeconds > 0) timingsRows += `<tr><td ${td}><strong>Total Duration (seconds)</strong></td><td ${td}>${esc(durationSeconds)}</td></tr>`;\ntimingsRows += `<tr><td ${td}><strong>Call Status</strong></td><td ${td}>${esc(callStatus)}</td></tr>`;\nif (disconnect) timingsRows += `<tr><td ${td}><strong>Disconnection Reason</strong></td><td ${td}>${esc(disconnect)}</td></tr>`;\ntimingsRows += `<tr><td ${td}><strong>Direction</strong></td><td ${td}>${esc(direction)}</td></tr>`;\n\nlet linksBlock = '';\nif (recordingUrl) {\n  linksBlock = `<tr><td ${th} colspan=\"2\">Call Data & Links</td></tr>\n    <tr><td ${td}><strong>Recording URL</strong></td><td ${td}><a href=\"${esc(recordingUrl)}\" style=\"color:#0056b3;text-decoration:none\">${esc(recordingUrl)}</a></td></tr>`;\n}\n\nconst html = `\n  <table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\"\n         style=\"border-collapse:collapse;width:100%;max-width:780px;border:1px solid #e5e7eb\">\n    <tr><td ${th} colspan=\"2\">Caller Information</td></tr>\n    <tr><td ${td} style=\"width:240px\"><strong>Name</strong></td><td ${td}>${esc(callerName)}</td></tr>\n    <tr><td ${td}><strong>From Number (Carrier)</strong></td><td ${td}>${esc(fromPhone)}</td></tr>\n    <tr><td ${td}><strong>To Number</strong></td><td ${td}>${esc(toNumber)}</td></tr>\n    <tr><td ${td}><strong>Callback Phone</strong></td><td ${td}>${esc(callbackPhone)}</td></tr>\n    <tr><td ${td}><strong>Village</strong></td><td ${td}>${esc(village)}</td></tr>\n    <tr><td ${th} colspan=\"2\">Booking Details</td></tr>\n    <tr><td ${td}><strong>Intent</strong></td><td ${td}>${esc(intent)}</td></tr>\n    <tr><td ${td}><strong>Urgency</strong></td><td ${td}>${esc(urgency)}</td></tr>\n    <tr><td ${td}><strong>Patient ID</strong></td><td ${td}>${esc(patientId)}</td></tr>\n    <tr><td ${td}><strong>Details</strong></td><td ${td}>${esc(details)}</td></tr>\n    <tr><td ${th} colspan=\"2\">Call Timings & Status</td></tr>\n    ${timingsRows}\n    ${linksBlock}\n    <tr><td ${th} colspan=\"2\">Transcript</td></tr>\n    <tr><td ${td} colspan=\"2\" style=\"background:#fff\">${htmlTranscript}</td></tr>\n    <tr><td ${th} colspan=\"2\">Agent & System Info</td></tr>\n    <tr><td ${td} style=\"width:240px\"><strong>Agent ID</strong></td><td ${td}>${esc(agentId)}</td></tr>\n    <tr><td ${td}><strong>Agent Version</strong></td><td ${td}>${esc(agentVersion)}</td></tr>\n    <tr><td ${th} colspan=\"2\">Technical Details</td></tr>\n    <tr><td ${td}><strong>Call ID</strong></td><td ${td}>${esc(callId)}</td></tr>\n    <tr><td ${td}><strong>Transfer ID</strong></td><td ${td}>${esc(row.transfer_id || 'N/A')}</td></tr>\n    <tr><td ${td}><strong>Processed Timestamp</strong></td><td ${td}>${esc(processedTimestamp)}</td></tr>\n  </table>\n  <div style=\"font-family:Arial,Helvetica,sans-serif;font-size:12px;color:#6b7280;margin-top:10px\">\n    Powered by Yes AI Consultants Australia <a href=\"https://www.YesAI.au\" style=\"color:#6b7280;text-decoration:none\">www.YesAI.au</a>\n  </div>\n`;\n\nreturn [{ json: { subject, html, processedTimestamp, callerName, fromPhone, toNumber, callbackPhone, village, intent, urgency, patientId, details, startTime: startTime || '', endTime: endTime || '', duration: duration || '', durationSeconds: durationSeconds || 0, callStatus, disconnect: disconnect || '', direction, recordingUrl: recordingUrl || '', plainTranscript, agentId, agentVersion, callId, transferId: row.transfer_id || 'N/A' } }];"},"id":"e60eb7c8-940e-4ca0-919c-1b99667da7c3","name":"Compose Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1kNx5YBa-YvPKOVutfQlXUNlU9KoB1T118g583i4gLNY","mode":"id"},"sheetName":{"__rl":true,"value":237087233,"mode":"list","cachedResultName":"Call Emails","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1kNx5YBa-YvPKOVutfQlXUNlU9KoB1T118g583i4gLNY/edit#gid=237087233"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":[],"schema":[{"id":"processedTimestamp","displayName":"processedTimestamp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"callerName","displayName":"callerName","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"fromPhone","displayName":"fromPhone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"toNumber","displayName":"toNumber","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"callbackPhone","displayName":"callbackPhone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"village","displayName":"village","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"intent","displayName":"intent","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"urgency","displayName":"urgency","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"patientId","displayName":"patientId","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"details","displayName":"details","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"startTime","displayName":"startTime","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"endTime","displayName":"endTime","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"duration","displayName":"duration","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"durationSeconds","displayName":"durationSeconds","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"callStatus","displayName":"callStatus","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"disconnect","displayName":"disconnect","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"direction","displayName":"direction","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"recordingUrl","displayName":"recordingUrl","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"plainTranscript","displayName":"plainTranscript","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"agentId","displayName":"agentId","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"agentVersion","displayName":"agentVersion","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"callId","displayName":"callId","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"transferId","displayName":"transferId","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"subject","displayName":"subject","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"html","displayName":"html","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"56e4f190-b22a-4ec1-82ed-5437e81765df","name":"Append to Google Sheets","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[688,0],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"sendTo":"peter@yesai.au","subject":"={{$json.subject}}","message":"={{$json.html}}","options":{}},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[928,0],"id":"cb50af0c-af3a-474b-a729-8322ad9a63e2","name":"Send Email","webhookId":"66c45fdf-6f3c-4baa-80ac-342fd2520f59","credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}},{"parameters":{"jsCode":"return [{ json: { email_sent: true, sheet_updated: true, success: true, message: 'Call logged successfully' } }];"},"id":"be0a6047-78a7-444e-b976-e4880292f589","name":"Success Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1168,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"82751bf6-952d-492c-a25f-32354e14c2f1","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1408,0]}],"connections":{"Webhook":{"main":[[{"node":"Only Process Ended Calls","type":"main","index":0}]]},"Only Process Ended Calls":{"main":[[{"node":"Postgres Load Transfer","type":"main","index":0}]]},"Postgres Load Transfer":{"main":[[{"node":"Compose Data","type":"main","index":0}]]},"Compose Data":{"main":[[{"node":"Append to Google Sheets","type":"main","index":0}]]},"Append to Google Sheets":{"main":[[{"node":"Send Email","type":"main","index":0}]]},"Send Email":{"main":[[{"node":"Success Response","type":"main","index":0}]]},"Success Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"5bf5ebaf-c108-4bd5-b47a-203085f3985c","triggerCount":1,"shared":[{"updatedAt":"2025-11-08T06:27:09.601Z","createdAt":"2025-11-08T06:27:09.601Z","role":"workflow:owner","workflowId":"P0xnQhtFiWZaFMd1","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-25T08:36:23.450Z","createdAt":"2025-11-08T07:05:44.034Z","id":"oQMp4RS1crCnjj0F","name":"RetellAI - Log Call Start v2 FIXED","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/log-call-start","responseMode":"responseNode","options":{}},"id":"1e6ed0dc-4376-44fe-8fa9-5c4be85d4a06","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"log-call-start"},{"parameters":{"jsCode":"\n// Universal Phone Normalization (Australian E.164) - v9.09\n\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n\n  // 1. Strip everything except digits and '+'\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n\n  // 2. Already in E.164 format\n  if (phone.startsWith('+')) {\n    return phone;\n  }\n\n  // 3. Handle 8-digit local numbers (Assume NSW '02')\n  if (phone.length === 8 && !phone.startsWith('+')) {\n    return '+612' + phone;\n  }\n\n  // 4. Handle standard 10-digit AU numbers (04... or 02...)\n  if (phone.length === 10 && phone.startsWith('0')) {\n    return '+61' + phone.substring(1);\n  }\n\n  // 5. Handle numbers starting with 61 (missing +)\n  if (phone.length === 11 && phone.startsWith('61')) {\n    return '+' + phone;\n  }\n\n  // 6. Assume Australian if 9 digits (missing leading 0)\n  if (phone.length === 9) {\n    return '+61' + phone;\n  }\n\n  // 7. Return cleaned version (best effort)\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n\n// Extract and validate request parameters\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || $input.item.json || {};\nconst call = webhookData.call || webhookData;\nconst args = webhookData.args || {};\n\n// Extract parameters\nconst call_id = call.call_id || webhookData.call_id || args.call_id;\nconst from_number = call.from_number || webhookData.from_number || args.from_number;\nconst to_number = call.to_number || webhookData.to_number || args.to_number || '+61291234567';\nconst agent_name = webhookData.agent_name || args.agent_name || 'Unknown';\nconst call_started_at = webhookData.timestamp || args.timestamp || new Date().toISOString();\n\n// Validate required fields\nif (!call_id) {\n  throw new Error('call_id is required');\n}\n\nif (!from_number) {\n  throw new Error('from_number is required');\n}\n\nconst startTime = Date.now();\n\nreturn [{\n  json: {\n    call_id,\n    from_number,\n    to_number,\n    agent_name,\n    call_started_at,\n    start_time: startTime,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"0babf7bb-cb1f-419e-89ee-ef7a58b2ec47","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"operation":"executeQuery","query":"-- Insert call start record\nINSERT INTO call_log (\n  call_id,\n  from_number,\n  to_number,\n  agent_name,\n  call_started_at\n)\nVALUES (\n  '{{ $json.call_id }}',\n  '{{ $json.from_number }}',\n  '{{ $json.to_number }}',\n  '{{ $json.agent_name }}',\n  '{{ $json.call_started_at }}'\n)\nON CONFLICT (call_id) DO NOTHING\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"70205160-69ef-4dcf-a61d-04eb99a15c2f","name":"Insert Call Log","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[448,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Build response\nconst items = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// Check if insert was successful\nif (items.length > 0 && items[0].json.id) {\n  // Record inserted successfully\n  return [{\n    json: {\n      success: true,\n      data: {\n        log_id: items[0].json.id,\n        call_id: items[0].json.call_id,\n        logged_at: items[0].json.call_started_at\n      },\n      timestamp: new Date().toISOString()\n    }\n  }];\n} else {\n  // Duplicate call_id (ON CONFLICT DO NOTHING triggered)\n  // Still return success since record exists\n  return [{\n    json: {\n      success: true,\n      data: {\n        log_id: null,\n        call_id: requestData.call_id,\n        logged_at: requestData.call_started_at,\n        note: 'Call already logged (duplicate call_id)'\n      },\n      timestamp: new Date().toISOString()\n    }\n  }];\n}"},"id":"326cbddc-b7e0-4cc2-ac10-a9fbfa405409","name":"Build Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"19164aa2-f178-48c5-aa25-f1eccffae254","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[880,0]},{"parameters":{"operation":"executeQuery","query":"-- Log webhook execution\nINSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_body,\n  response_body,\n  success,\n  duration_ms,\n  cache_hit,\n  created_at\n) VALUES (\n  'log-call-start',\n  '{{ $items(\"Extract Request Data\")[0].json.call_id }}',\n  '{{ JSON.stringify($items(\"Extract Request Data\")[0].json) }}'::jsonb,\n  '{{ JSON.stringify($items(\"Build Response\")[0].json) }}'::jsonb,\n  {{ $items(\"Build Response\")[0].json.success }},\n  {{ Date.now() - $items(\"Extract Request Data\")[0].json.start_time }},\n  false,\n  NOW()\n) RETURNING *;","options":{"queryBatching":"independently"}},"id":"3fa4fec1-3ada-414e-b207-984fe005ff0c","name":"Log Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1104,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Insert Call Log","type":"main","index":0}]]},"Insert Call Log":{"main":[[{"node":"Build Response","type":"main","index":0}]]},"Build Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"af7f77af-cd2c-44b9-9337-e6bc3395d6d2","triggerCount":1,"shared":[{"updatedAt":"2025-11-08T07:05:44.034Z","createdAt":"2025-11-08T07:05:44.034Z","role":"workflow:owner","workflowId":"oQMp4RS1crCnjj0F","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-30T06:40:19.891Z","createdAt":"2025-11-08T07:07:15.285Z","id":"OCHp1xPu7Eo50MxY","name":"RetellAI - Check EP Assessment","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/check-ep-assessment","responseMode":"responseNode","options":{}},"id":"c30376f2-819a-47e9-88c1-4649424cc3d8","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"check-ep-assessment"},{"parameters":{"jsCode":"\n// Universal Phone Normalization (Australian E.164) - v9.09\n\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n\n  // 1. Strip everything except digits and '+'\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n\n  // 2. Already in E.164 format\n  if (phone.startsWith('+')) {\n    return phone;\n  }\n\n  // 3. Handle 8-digit local numbers (Assume NSW '02')\n  if (phone.length === 8 && !phone.startsWith('+')) {\n    return '+612' + phone;\n  }\n\n  // 4. Handle standard 10-digit AU numbers (04... or 02...)\n  if (phone.length === 10 && phone.startsWith('0')) {\n    return '+61' + phone.substring(1);\n  }\n\n  // 5. Handle numbers starting with 61 (missing +)\n  if (phone.length === 11 && phone.startsWith('61')) {\n    return '+' + phone;\n  }\n\n  // 6. Assume Australian if 9 digits (missing leading 0)\n  if (phone.length === 9) {\n    return '+61' + phone;\n  }\n\n  // 7. Return cleaned version (best effort)\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n\n// Extract and validate request parameters\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\n// Extract required parameters\nconst patient_id = args.patient_id || '';\nconst call_id = call.call_id || args.call_id || '';\n\n// Validate required fields\nif (!patient_id) {\n  throw new Error('patient_id is required');\n}\n\nconst startTime = Date.now();\n\nreturn [{\n  json: {\n    patient_id,\n    call_id,\n    start_time: startTime,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"0de7fd62-d0aa-474e-a883-40db581ad945","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"operation":"executeQuery","query":"-- Check universal webhook_cache for EP assessment (24 hour TTL)\nSELECT \n  id,\n  cache_key,\n  data,\n  cached_at,\n  EXTRACT(EPOCH FROM (now() - cached_at))/60 as minutes_old\nFROM webhook_cache\nWHERE cache_key = 'ep_assessment_{{ $json.patient_id }}'\n  AND cached_at > now() - interval '24 hours'\nLIMIT 1;","options":{"queryBatching":"independently"}},"id":"27316bca-b76f-4015-bf06-621bd6fbedac","name":"Check Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[448,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Handle cache result - NO JSON.parse on JSONB!\nconst cacheItems = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// Validate cache hit with proper checks\nconst hasValidCache = \n  cacheItems.length > 0 &&\n  cacheItems[0].json &&\n  cacheItems[0].json.id &&\n  cacheItems[0].json.data;\n\nif (hasValidCache) {\n  // Cache HIT - JSONB is already parsed, no JSON.parse needed!\n  const cached = cacheItems[0].json;\n  const assessmentData = cached.data;  // Already an object!\n  \n  return [{\n    json: {\n      patient_id: requestData.patient_id,\n      call_id: requestData.call_id,\n      has_ep_assessment: assessmentData.has_ep_assessment || false,\n      assessment_date: assessmentData.assessment_date || null,\n      practitioner_name: assessmentData.practitioner_name || null,\n      practitioner_id: assessmentData.practitioner_id || null,\n      is_current: assessmentData.is_current || false,\n      cliniko_appointment_id: assessmentData.cliniko_appointment_id || null,\n      from_cache: true,\n      cache_age_minutes: Math.round(cached.minutes_old || 0)\n    }\n  }];\n}\n\n// Cache MISS\nreturn [{\n  json: {\n    patient_id: requestData.patient_id,\n    call_id: requestData.call_id,\n    from_cache: false\n  }\n}];"},"id":"6d195824-e5a0-462e-9b63-cefa49b9f79a","name":"Handle Cache Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"cache-hit-check","leftValue":"={{ $json.from_cache }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"id":"a1b2c3d4-e5f6-7890-abcd-ef1234567890","name":"Cache Hit?","type":"n8n-nodes-base.if","typeVersion":2,"position":[896,0]},{"parameters":{"url":"=https://api.au2.cliniko.com/v1/individual_appointments?q[]=patient_id:={{ $items(\"Extract Request Data\")[0].json.patient_id }}&per_page=50","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"},{"name":"Accept","value":"application/json"}]},"options":{"timeout":10000}},"id":"f9adcf1a-e055-4b10-9c43-0b9c6aef04ee","name":"Query Cliniko EP Assessments","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1120,120],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"jsCode":"// Process Cliniko response and find most recent EP assessment\nconst items = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// Parse Cliniko API response\nlet has_ep_assessment = false;\nlet assessment_date = null;\nlet practitioner_name = null;\nlet practitioner_id = null;\nlet cliniko_appointment_id = null;\nlet is_current = false;\n\nif (items.length > 0 && items[0].json.individual_appointments) {\n  const appointments = items[0].json.individual_appointments;\n  \n  // Filter for EP Assessment appointments only\n  // Look for various possible names: \"EP Assessment\", \"Exercise Physiology Assessment\", etc.\n  const epAssessments = appointments.filter(apt => {\n    const typeName = apt.appointment_type?.name || '';\n    return typeName.toLowerCase().includes('ep') && \n           (typeName.toLowerCase().includes('assessment') || typeName.toLowerCase().includes('initial'));\n  });\n  \n  // Sort by starts_at date descending (most recent first)\n  epAssessments.sort((a, b) => {\n    const dateA = new Date(a.starts_at || 0).getTime();\n    const dateB = new Date(b.starts_at || 0).getTime();\n    return dateB - dateA; // Descending order\n  });\n  \n  if (epAssessments.length > 0) {\n    // Get the most recent EP assessment (now sorted by date)\n    const mostRecent = epAssessments[0];\n    \n    has_ep_assessment = true;\n    assessment_date = mostRecent.starts_at?.split('T')[0] || null; // Extract date\n    practitioner_name = mostRecent.practitioner?.name || null;\n    practitioner_id = mostRecent.practitioner?.id?.toString() || null;\n    cliniko_appointment_id = mostRecent.id?.toString() || null;\n    \n    // Check if assessment is current (within last 12 months)\n    if (assessment_date) {\n      const assessmentTime = new Date(assessment_date).getTime();\n      const twelveMonthsAgo = Date.now() - (365 * 24 * 60 * 60 * 1000);\n      is_current = assessmentTime >= twelveMonthsAgo;\n    }\n  }\n}\n\nreturn [{\n  json: {\n    patient_id: requestData.patient_id,\n    call_id: requestData.call_id,\n    has_ep_assessment,\n    assessment_date,\n    practitioner_name,\n    practitioner_id,\n    is_current,\n    cliniko_appointment_id,\n    from_cache: false\n  }\n}];"},"id":"b1b20ea7-a03f-4b09-88be-f246ffc087f5","name":"Process Cliniko Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1344,120]},{"parameters":{"operation":"executeQuery","query":"-- Cache EP assessment in universal webhook_cache table (24 hour TTL)\nINSERT INTO webhook_cache (\n  cache_key,\n  data,\n  cached_at\n)\nVALUES (\n  'ep_assessment_{{ $json.patient_id }}',\n  '{{ JSON.stringify({\n    has_ep_assessment: $json.has_ep_assessment,\n    assessment_date: $json.assessment_date,\n    practitioner_name: $json.practitioner_name,\n    practitioner_id: $json.practitioner_id,\n    is_current: $json.is_current,\n    cliniko_appointment_id: $json.cliniko_appointment_id\n  }).replace(/'/g, \"''\") }}'::jsonb,\n  now()\n)\nON CONFLICT (cache_key) \nDO UPDATE SET\n  data = EXCLUDED.data,\n  cached_at = now()\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"c682fef3-36d1-4d7b-a484-bb0eaec1d70b","name":"Update Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1568,120],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Merge cached data back with request data for final response\nconst cacheResult = $input.item.json;\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\nreturn [{\n  json: {\n    patient_id: requestData.patient_id,\n    call_id: requestData.call_id,\n    has_ep_assessment: cacheResult.data?.has_ep_assessment || false,\n    assessment_date: cacheResult.data?.assessment_date || null,\n    practitioner_name: cacheResult.data?.practitioner_name || null,\n    practitioner_id: cacheResult.data?.practitioner_id || null,\n    is_current: cacheResult.data?.is_current || false,\n    cliniko_appointment_id: cacheResult.data?.cliniko_appointment_id || null,\n    from_cache: false,\n    cache_age_minutes: 0\n  }\n}];"},"id":"e1f2g3h4-i5j6-7890-abcd-ef9876543210","name":"Prepare Cliniko Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[1792,120]},{"parameters":{"jsCode":"// Build final response\nconst assessmentData = $input.item.json;\n\nconst response = {\n  success: true,\n  has_ep_assessment: assessmentData.has_ep_assessment || false,\n  assessment_date: assessmentData.assessment_date || null,\n  practitioner: assessmentData.practitioner_name || null,\n  is_current: assessmentData.is_current || false,\n  message: null,\n  call_id: assessmentData.call_id,\n  from_cache: assessmentData.from_cache || false,\n  cache_age_minutes: assessmentData.cache_age_minutes || 0,\n  timestamp: new Date().toISOString()\n};\n\n// Add helpful message based on status\nif (!response.has_ep_assessment) {\n  response.message = 'No EP assessment found. An EP assessment is required before enrolling in exercise classes.';\n} else if (!response.is_current) {\n  response.message = `EP assessment completed on ${response.assessment_date}, but it's more than 12 months old. A new assessment may be required.`;\n} else {\n  response.message = `EP assessment completed on ${response.assessment_date} by ${response.practitioner}. Client is cleared for exercise classes.`;\n}\n\nreturn [{ json: response }];"},"id":"df0e0076-c0a2-435c-b73d-c871e4b9ba2d","name":"Build Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[2016,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"4880d69b-8971-403c-bfd6-56b5e4e02d5f","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2240,0]},{"parameters":{"operation":"executeQuery","query":"-- Log webhook execution (happens after response sent)\nINSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_body,\n  response_body,\n  success,\n  duration_ms,\n  cache_hit,\n  created_at\n)\nVALUES (\n  'check-ep-assessment',\n  '{{ $items(\"Extract Request Data\")[0].json.call_id }}',\n  '{{ JSON.stringify($items(\"Extract Request Data\")[0].json).replace(/'/g, \"''\") }}'::jsonb,\n  '{{ JSON.stringify($items(\"Build Response\")[0].json).replace(/'/g, \"''\") }}'::jsonb,\n  true,\n  {{ Math.round((Date.now() - $items(\"Extract Request Data\")[0].json.start_time)) }},\n  {{ $items(\"Build Response\")[0].json.from_cache || false }},\n  now()\n)\nRETURNING id, webhook_name, duration_ms, cache_hit;","options":{"queryBatching":"independently"}},"id":"cb9edfa6-aa6a-43a5-8dc5-9d3a90b0b047","name":"Log Webhook Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[2464,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Check Cache","type":"main","index":0}]]},"Check Cache":{"main":[[{"node":"Handle Cache Result","type":"main","index":0}]]},"Handle Cache Result":{"main":[[{"node":"Cache Hit?","type":"main","index":0}]]},"Cache Hit?":{"main":[[{"node":"Build Response","type":"main","index":0}],[{"node":"Query Cliniko EP Assessments","type":"main","index":0}]]},"Query Cliniko EP Assessments":{"main":[[{"node":"Process Cliniko Response","type":"main","index":0}]]},"Process Cliniko Response":{"main":[[{"node":"Update Cache","type":"main","index":0}]]},"Update Cache":{"main":[[{"node":"Prepare Cliniko Data","type":"main","index":0}]]},"Prepare Cliniko Data":{"main":[[{"node":"Build Response","type":"main","index":0}]]},"Build Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Webhook Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"5f19728a-b61f-4fbd-81f0-9518502a2d40","triggerCount":1,"shared":[{"updatedAt":"2025-11-08T07:07:15.285Z","createdAt":"2025-11-08T07:07:15.285Z","role":"workflow:owner","workflowId":"OCHp1xPu7Eo50MxY","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-16T07:25:57.912Z","createdAt":"2025-11-08T07:14:02.855Z","id":"rCAgVJwAyDXliKDe","name":"RetellAI - Lookup Caller by Name & Village v2.1 WORKING","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/lookup-caller-name-village","responseMode":"responseNode","options":{}},"id":"cc20afa3-8798-423b-ab49-02d0ae8a8e10","name":"Webhook1","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[1168,192],"webhookId":"lookup-caller-name-village"},{"parameters":{"operation":"executeQuery","query":"WITH q AS (\n  SELECT\n    '{{ $json.body.body.first_name }}' AS search_first,\n    '{{ $json.body.body.last_name }}' AS search_last,\n    '{{ $json.body.body.village }}' AS search_village,\n    util.immutable_unaccent(util.lc('{{ $json.body.body.first_name }}')) AS q_first,\n    util.immutable_unaccent(util.lc('{{ $json.body.body.last_name }}')) AS q_last,\n    util.nospace(util.immutable_unaccent(util.lc('{{ $json.body.body.village }}'))) AS q_village\n),\ncand AS (\n  SELECT\n    p.patient_id, p.first_name, p.last_name, p.preferred_name,\n    p.email, p.phone, p.phone_mobile, p.date_of_birth, p.village,\n    p.archived, p.last_synced,\n    util.immutable_unaccent(util.lc(p.first_name)) AS f_first,\n    util.immutable_unaccent(util.lc(p.last_name)) AS f_last,\n    util.nospace(util.immutable_unaccent(util.lc(coalesce(p.village,'')))) AS f_village\n  FROM patients p\n  WHERE p.archived = false\n),\nscored AS (\n  SELECT\n    c.*,\n    similarity(c.f_first, (SELECT q_first FROM q)) AS s_first,\n    similarity(c.f_last, (SELECT q_last FROM q)) AS s_last,\n    similarity(c.f_village, (SELECT q_village FROM q)) AS s_village,\n    CASE\n      WHEN GREATEST(length(c.f_first), length((SELECT q_first FROM q))) = 0 THEN 0\n      ELSE 1 - (LEAST(levenshtein(c.f_first, (SELECT q_first FROM q)),\n                      GREATEST(length(c.f_first), length((SELECT q_first FROM q))))::float\n                / GREATEST(length(c.f_first), length((SELECT q_first FROM q))))\n    END AS l_first,\n    CASE\n      WHEN GREATEST(length(c.f_last), length((SELECT q_last FROM q))) = 0 THEN 0\n      ELSE 1 - (LEAST(levenshtein(c.f_last, (SELECT q_last FROM q)),\n                      GREATEST(length(c.f_last), length((SELECT q_last FROM q))))::float\n                / GREATEST(length(c.f_last), length((SELECT q_last FROM q))))\n    END AS l_last,\n    CASE\n      WHEN GREATEST(length(c.f_village), length((SELECT q_village FROM q))) = 0 THEN 0\n      ELSE 1 - (LEAST(levenshtein(c.f_village, (SELECT q_village FROM q)),\n                      GREATEST(length(c.f_village), length((SELECT q_village FROM q))))::float\n                / GREATEST(length(c.f_village), length((SELECT q_village FROM q))))\n    END AS l_village,\n    difference(c.f_first, (SELECT q_first FROM q)) AS d_first,\n    difference(c.f_last, (SELECT q_last FROM q)) AS d_last,\n    difference(c.f_village, (SELECT q_village FROM q)) AS d_village\n  FROM cand c\n),\nresults AS (\n  SELECT\n    (SELECT search_first FROM q) AS search_first_name,\n    (SELECT search_last FROM q) AS search_last_name,\n    (SELECT search_village FROM q) AS search_village,\n    patient_id, first_name, last_name, village, email, phone, phone_mobile,\n    date_of_birth, archived,\n    s_first, l_first, d_first,\n    s_last, l_last, d_last,\n    s_village, l_village, d_village,\n    last_synced\n  FROM scored\n  WHERE\n    (\n      (s_last >= 0.50 OR l_last >= 0.65 OR d_last >= 3)\n      AND (\n        (SELECT q_village FROM q) = ''\n        OR s_village >= 0.25 OR l_village >= 0.50 OR d_village >= 3\n      )\n    )\n    AND (\n      (SELECT q_first FROM q) = ''\n      OR s_first >= 0.15 OR l_first >= 0.30 OR d_first >= 2\n    )\n  ORDER BY\n    (GREATEST(s_last, l_last)*0.55\n     + GREATEST(s_first, l_first)*0.25\n     + GREATEST(s_village, l_village)*0.15\n     + (CASE WHEN d_last >= 3 THEN 0.03 ELSE 0 END)\n     + (CASE WHEN d_first >= 3 THEN 0.01 ELSE 0 END)\n     + (CASE WHEN d_village >= 3 THEN 0.01 ELSE 0 END)\n    ) DESC,\n    last_synced DESC\n  LIMIT 5\n)\nSELECT * FROM results\nUNION ALL\nSELECT\n  (SELECT search_first FROM q) AS search_first_name,\n  (SELECT search_last FROM q) AS search_last_name,\n  (SELECT search_village FROM q) AS search_village,\n  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,\n  NULL, NULL, NULL, NULL, NULL, NULL,\n  NULL, NULL, NULL, NULL\nWHERE NOT EXISTS (SELECT 1 FROM results)\nLIMIT 6;","options":{}},"id":"d1bbed1f-0442-4e44-ab02-1a2905c2cdf9","name":"Postgres - Search Patients1","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1488,192],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Simple transform - reads search criteria from Postgres output\nconst allItems = $input.all();\n\n// Get search criteria from first row\nlet searchCriteria = {\n  first_name: allItems[0]?.json?.search_first_name || '',\n  last_name: allItems[0]?.json?.search_last_name || '',\n  village: allItems[0]?.json?.search_village || ''\n};\n\n// Filter for actual patient results\nconst patients = allItems.filter(item => item.json.patient_id);\n\nif (patients.length === 0) {\n  return [{\n    json: {\n      found: false,\n      search_criteria: searchCriteria,\n      message: \"No matching patients found\",\n      suggestion: \"Try searching by phone number or date of birth\",\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// Format matches\nconst formattedPatients = patients.map(item => {\n  const p = item.json;\n  return {\n    id: p.patient_id,\n    first_name: p.first_name,\n    last_name: p.last_name,\n    full_name: `${p.first_name} ${p.last_name}`,\n    email: p.email || null,\n    phone: p.phone || p.phone_mobile,\n    mobile: p.phone_mobile || null,\n    dob: p.date_of_birth,\n    village: p.village || 'Unknown',\n    is_archived: p.archived === true,\n    is_active: p.archived === false,\n    cliniko_url: `https://reignitehealth.au2.cliniko.com/patients/${p.patient_id}`,\n    last_synced: p.last_synced,\n    match_scores: {\n      first_name: { similarity: p.s_first, levenshtein: p.l_first, soundex: p.d_first },\n      last_name: { similarity: p.s_last, levenshtein: p.l_last, soundex: p.d_last },\n      village: { similarity: p.s_village, levenshtein: p.l_village, soundex: p.d_village }\n    }\n  };\n});\n\nreturn [{\n  json: {\n    found: true,\n    match_count: formattedPatients.length,\n    search_criteria: searchCriteria,\n    patients: formattedPatients,\n    message: formattedPatients.length === 1 ? \"Exact match found\" : `${formattedPatients.length} potential matches found`,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"850b8be3-c125-4b40-85ec-562c10a7c589","name":"Transform for RetellAI1","type":"n8n-nodes-base.code","typeVersion":2,"position":[1808,192]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"49e888b4-5d76-426a-8ca4-02e56896736f","name":"Respond to Webhook1","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2128,192]}],"connections":{"Webhook1":{"main":[[{"node":"Postgres - Search Patients1","type":"main","index":0}]]},"Postgres - Search Patients1":{"main":[[{"node":"Transform for RetellAI1","type":"main","index":0}]]},"Transform for RetellAI1":{"main":[[{"node":"Respond to Webhook1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"188e5f12-b6c9-40ad-ac28-85284582401b","triggerCount":1,"shared":[{"updatedAt":"2025-11-08T07:14:02.855Z","createdAt":"2025-11-08T07:14:02.855Z","role":"workflow:owner","workflowId":"rCAgVJwAyDXliKDe","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-24T05:10:45.621Z","createdAt":"2025-11-08T07:27:14.176Z","id":"g6f6b5HjYUQ7YfA8","name":"RetellAI - Get Booking Rules","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-booking-rules","responseMode":"responseNode","options":{}},"id":"8553b6aa-014d-4e20-b99e-028d60e5b903","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"get-booking-rules"},{"parameters":{"jsCode":"\n// Universal Phone Normalization (Australian E.164) - v9.09\n\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n\n  // 1. Strip everything except digits and '+'\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n\n  // 2. Already in E.164 format\n  if (phone.startsWith('+')) {\n    return phone;\n  }\n\n  // 3. Handle 8-digit local numbers (Assume NSW '02')\n  if (phone.length === 8 && !phone.startsWith('+')) {\n    return '+612' + phone;\n  }\n\n  // 4. Handle standard 10-digit AU numbers (04... or 02...)\n  if (phone.length === 10 && phone.startsWith('0')) {\n    return '+61' + phone.substring(1);\n  }\n\n  // 5. Handle numbers starting with 61 (missing +)\n  if (phone.length === 11 && phone.startsWith('61')) {\n    return '+' + phone;\n  }\n\n  // 6. Assume Australian if 9 digits (missing leading 0)\n  if (phone.length === 9) {\n    return '+61' + phone;\n  }\n\n  // 7. Return cleaned version (best effort)\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n\n// Extract and validate request parameters\nconst webhookData = $input.item.json.body || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\n// Extract required parameters\nconst is_new_client = args.is_new_client;\nconst funding_type = (args.funding_type || '').toUpperCase();\nconst call_id = call.call_id || args.call_id || '';\n\n// Validate required fields\nif (typeof is_new_client !== 'boolean') {\n  throw new Error('is_new_client is required and must be a boolean');\n}\nif (!funding_type) {\n  throw new Error('funding_type is required');\n}\n\n// Validate funding_type is one of the allowed values\nconst validTypes = ['HCP', 'DVA', 'GP', 'PRIVATE', 'PHI'];\nif (!validTypes.includes(funding_type)) {\n  throw new Error(`Invalid funding_type. Must be one of: ${validTypes.join(', ')}`);\n}\n\n// Create rule_key for cache lookup\nconst clientType = is_new_client ? 'new' : 'existing';\nconst rule_key = `${clientType}_${funding_type}`;\n\nconst startTime = Date.now();\n\nreturn [{\n  json: {\n    is_new_client,\n    funding_type,\n    rule_key,\n    call_id,\n    start_time: startTime,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"1e56e291-41c8-492c-b2b5-d66fcd67f5de","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"operation":"executeQuery","query":"-- Check if business rules cache exists and is fresh (24 hour TTL)\nSELECT \n  rule_key,\n  is_new_client,\n  funding_type,\n  appointment_type,\n  duration_minutes,\n  requires_referral,\n  max_booking_window_days,\n  can_book_recurring,\n  notes,\n  EXTRACT(EPOCH FROM (now() - cached_at))/3600 as hours_old\nFROM business_rules_cache\nWHERE rule_key = '{{ $json.rule_key }}'\n  AND cached_at > now() - interval '24 hours'\nLIMIT 1;","options":{"queryBatching":"independently"}},"id":"63609b03-67aa-4209-869c-c67db6a5e759","name":"Check Business Rules Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[448,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Check if we have cached business rules\nconst items = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// If we have cached data, return it\nif (items.length > 0 && items[0].json.rule_key) {\n  items[0].json.from_cache = true;\n  return items; // Cache hit - pass through\n}\n\n// Cache miss - get default rules\nconst is_new_client = requestData.is_new_client;\nconst funding_type = requestData.funding_type;\nconst rule_key = requestData.rule_key;\n\n// Default rules matrix\nconst newClientRules = {\n  'HCP': {\n    appointment_type: 'Initial Consultation',\n    duration_minutes: 60,\n    requires_referral: false,\n    max_booking_window_days: 21,\n    can_book_recurring: false,\n    notes: 'New Home Care Package client - Initial assessment required'\n  },\n  'DVA': {\n    appointment_type: 'Initial Consultation',\n    duration_minutes: 60,\n    requires_referral: true,\n    max_booking_window_days: 21,\n    can_book_recurring: false,\n    notes: 'New DVA client - Referral required for initial appointment'\n  },\n  'GP': {\n    appointment_type: 'Initial Consultation',\n    duration_minutes: 60,\n    requires_referral: true,\n    max_booking_window_days: 21,\n    can_book_recurring: false,\n    notes: 'New GP CDM client - Referral required'\n  },\n  'PRIVATE': {\n    appointment_type: 'Initial Consultation',\n    duration_minutes: 60,\n    requires_referral: false,\n    max_booking_window_days: 21,\n    can_book_recurring: false,\n    notes: 'New private client - Standard initial consultation'\n  },\n  'PHI': {\n    appointment_type: 'Initial Consultation',\n    duration_minutes: 60,\n    requires_referral: false,\n    max_booking_window_days: 21,\n    can_book_recurring: false,\n    notes: 'New PHI client - Check fund requirements'\n  }\n};\n\nconst existingClientRules = {\n  'HCP': {\n    appointment_type: 'Review Appointment',\n    duration_minutes: 45,\n    requires_referral: false,\n    max_booking_window_days: 21,\n    can_book_recurring: true,\n    notes: 'Existing HCP client - Can book recurring appointments'\n  },\n  'DVA': {\n    appointment_type: 'Review Appointment',\n    duration_minutes: 45,\n    requires_referral: false,\n    max_booking_window_days: 21,\n    can_book_recurring: true,\n    notes: 'Existing DVA client - Referral on file, can book recurring'\n  },\n  'GP': {\n    appointment_type: 'Review Appointment',\n    duration_minutes: 45,\n    requires_referral: false,\n    max_booking_window_days: 21,\n    can_book_recurring: true,\n    notes: 'Existing GP CDM client - Referral on file, can book recurring'\n  },\n  'PRIVATE': {\n    appointment_type: 'Review Appointment',\n    duration_minutes: 45,\n    requires_referral: false,\n    max_booking_window_days: 21,\n    can_book_recurring: true,\n    notes: 'Existing private client - Can book recurring appointments'\n  },\n  'PHI': {\n    appointment_type: 'Review Appointment',\n    duration_minutes: 45,\n    requires_referral: false,\n    max_booking_window_days: 21,\n    can_book_recurring: true,\n    notes: 'Existing PHI client - Can book recurring appointments'\n  }\n};\n\nconst rulesSource = is_new_client ? newClientRules : existingClientRules;\nconst defaultRule = rulesSource[funding_type] || rulesSource['PRIVATE'];\n\nreturn [{\n  json: {\n    rule_key,\n    is_new_client,\n    funding_type,\n    ...defaultRule,\n    from_cache: false\n  }\n}];"},"id":"8cb5da64-3e93-42a5-ae4b-c3796fc3d997","name":"Get Business Rules","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"operation":"executeQuery","query":"-- Cache the business rules for 24 hours (only if it was a cache miss)\nINSERT INTO business_rules_cache (\n  rule_key,\n  is_new_client,\n  funding_type,\n  appointment_type,\n  duration_minutes,\n  requires_referral,\n  max_booking_window_days,\n  can_book_recurring,\n  notes,\n  cached_at\n)\nVALUES (\n  '{{ $json.rule_key }}',\n  {{ $json.is_new_client }},\n  '{{ $json.funding_type }}',\n  '{{ $json.appointment_type }}',\n  {{ $json.duration_minutes }},\n  {{ $json.requires_referral }},\n  {{ $json.max_booking_window_days }},\n  {{ $json.can_book_recurring }},\n  '{{ $json.notes }}',\n  now()\n)\nON CONFLICT (rule_key) \nDO UPDATE SET\n  appointment_type = EXCLUDED.appointment_type,\n  duration_minutes = EXCLUDED.duration_minutes,\n  requires_referral = EXCLUDED.requires_referral,\n  max_booking_window_days = EXCLUDED.max_booking_window_days,\n  can_book_recurring = EXCLUDED.can_book_recurring,\n  notes = EXCLUDED.notes,\n  cached_at = now()\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"71c58264-5def-49bb-a566-e40b31b56b1c","name":"Cache Business Rules","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[880,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Build final response with booking rules\nconst rulesNode = $items(\"Cache Business Rules\")[0].json;\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// Extract values\nconst call_id = requestData.call_id;\nconst from_cache = rulesNode.from_cache || false;\n\nconst response = {\n  success: true,\n  rules: {\n    appointment_type: rulesNode.appointment_type,\n    duration_minutes: rulesNode.duration_minutes,\n    requires_referral: rulesNode.requires_referral,\n    max_booking_window_days: rulesNode.max_booking_window_days,\n    can_book_recurring: rulesNode.can_book_recurring\n  },\n  notes: rulesNode.notes,\n  call_id,\n  from_cache,\n  timestamp: new Date().toISOString()\n};\n\nreturn [{ json: response }];"},"id":"0d9e072a-7db1-4778-b2f0-e78bd54e3e83","name":"Build Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"87f8c84c-49fa-441a-aa45-1a82c0b3f239","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,0]},{"parameters":{"operation":"executeQuery","query":"-- Log webhook execution (happens after response sent)\nINSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_body,\n  response_body,\n  success,\n  duration_ms,\n  cache_hit,\n  created_at\n)\nVALUES (\n  'get-booking-rules',\n  '{{ $items(\"Extract Request Data\")[0].json.call_id }}',\n  '{{ JSON.stringify($items(\"Extract Request Data\")[0].json) }}'::jsonb,\n  '{{ JSON.stringify($items(\"Build Response\")[0].json) }}'::jsonb,\n  true,\n  {{ Math.round((Date.now() - $items(\"Extract Request Data\")[0].json.start_time)) }},\n  {{ $items(\"Get Business Rules\")[0]?.json?.from_cache || false }},\n  now()\n)\nRETURNING id, webhook_name, duration_ms, cache_hit;","options":{"queryBatching":"independently"}},"id":"c54d9bb9-d773-4984-a062-cd5936865b46","name":"Log Webhook Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1552,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Check Business Rules Cache","type":"main","index":0}]]},"Check Business Rules Cache":{"main":[[{"node":"Get Business Rules","type":"main","index":0}]]},"Get Business Rules":{"main":[[{"node":"Cache Business Rules","type":"main","index":0}]]},"Cache Business Rules":{"main":[[{"node":"Build Response","type":"main","index":0}]]},"Build Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Webhook Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"80791c71-c763-496a-8e6c-678cdecd026b","triggerCount":1,"shared":[{"updatedAt":"2025-11-08T07:27:14.176Z","createdAt":"2025-11-08T07:27:14.176Z","role":"workflow:owner","workflowId":"g6f6b5HjYUQ7YfA8","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-25T08:36:44.065Z","createdAt":"2025-11-08T07:36:55.858Z","id":"ILVuCeQstKNm7QbJ","name":"RetellAI - Update Client Notes v1.3","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/update-notes","responseMode":"responseNode","options":{}},"id":"d527f629-98e6-422a-95f5-8b0ed6795a92","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"update-notes"},{"parameters":{"jsCode":"\n// Universal Phone Normalization (Australian E.164) - v9.09\n\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n\n  // 1. Strip everything except digits and '+'\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n\n  // 2. Already in E.164 format\n  if (phone.startsWith('+')) {\n    return phone;\n  }\n\n  // 3. Handle 8-digit local numbers (Assume NSW '02')\n  if (phone.length === 8 && !phone.startsWith('+')) {\n    return '+612' + phone;\n  }\n\n  // 4. Handle standard 10-digit AU numbers (04... or 02...)\n  if (phone.length === 10 && phone.startsWith('0')) {\n    return '+61' + phone.substring(1);\n  }\n\n  // 5. Handle numbers starting with 61 (missing +)\n  if (phone.length === 11 && phone.startsWith('61')) {\n    return '+' + phone;\n  }\n\n  // 6. Assume Australian if 9 digits (missing leading 0)\n  if (phone.length === 9) {\n    return '+61' + phone;\n  }\n\n  // 7. Return cleaned version (best effort)\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\nconst patient_id = args.patient_id || '';\nconst notes = args.notes || '';\nconst call_id = call.call_id || args.call_id || '';\nif (!patient_id) throw new Error('patient_id is required');\nif (!notes) throw new Error('notes is required');\nreturn [{ json: { patient_id, notes, call_id, timestamp: new Date().toISOString(), start_time: Date.now() } }];"},"id":"4ecfbebc-e45f-416d-baba-26d5d897ab5e","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"jsCode":"const requestData = $input.item.json;\nconst dateStr = new Date().toLocaleString('en-AU', { timeZone: 'Australia/Sydney', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });\nconst formattedNote = `[Voice AI Note - ${dateStr}]\\n${requestData.notes}\\n\\nCall ID: ${requestData.call_id}`;\nreturn [{ json: { patient_id: requestData.patient_id, original_notes: requestData.notes, formatted_note: formattedNote, call_id: requestData.call_id, timestamp: requestData.timestamp, start_time: requestData.start_time } }];"},"id":"e06aa470-7185-445a-bb0d-0e1633813bff","name":"Format Note for Cliniko","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"url":"=https://api.au2.cliniko.com/v1/patients/{{ $json.patient_id }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"},{"name":"Accept","value":"application/json"}]},"options":{"response":{"response":{"responseFormat":"json"}}}},"id":"6870a652-5f41-4961-b026-e26b9a35d635","name":"Get Patient Details","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[672,0],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"jsCode":"const patientData = $input.item.json;\nconst noteData = $items('Format Note for Cliniko')[0].json;\nconst existingNotes = patientData.notes || '';\nconst updatedNotes = existingNotes ? `${existingNotes}\\n\\n---\\n\\n${noteData.formatted_note}` : noteData.formatted_note;\nreturn [{ json: { patient_id: noteData.patient_id, updated_notes: updatedNotes, formatted_note: noteData.formatted_note, call_id: noteData.call_id, timestamp: noteData.timestamp, start_time: noteData.start_time } }];"},"id":"20394f46-af3e-494b-bbe9-25269230ce1c","name":"Append to Existing Notes","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,0]},{"parameters":{"method":"PATCH","url":"=https://api.au2.cliniko.com/v1/patients/{{ $json.patient_id }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"},{"name":"Accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={ \"notes\": {{ JSON.stringify($json.updated_notes) }} }","options":{"response":{"response":{"responseFormat":"json"}}}},"id":"ee9308f1-abca-46a1-96ee-a3fe26da50aa","name":"Update Patient Notes","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1104,0],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"jsCode":"const requestData = $items('Append to Existing Notes')[0].json;\nconst duration_ms = Math.round(Date.now() - requestData.start_time);\nreturn [{ json: { success: true, notes_updated: true, patient_id: requestData.patient_id, note_added: requestData.formatted_note, call_id: requestData.call_id, timestamp: new Date().toISOString(), logging_data: { patient_id: requestData.patient_id, note_text: requestData.formatted_note, call_id: requestData.call_id, success: true, duration_ms: duration_ms } } }];"},"id":"1929a632-b70f-433d-b689-c9d1c5bc8663","name":"Build Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1328,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify({ success: $json.success, notes_updated: $json.notes_updated, patient_id: $json.patient_id, note_added: $json.note_added, call_id: $json.call_id, timestamp: $json.timestamp }) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"315f9e84-3ebc-49ed-b0b1-bc5d84c01572","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1552,0]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO patient_notes_log (patient_id, note_text, added_via, call_id, cliniko_note_id, success, created_at) VALUES ('{{ $json.logging_data.patient_id }}', '{{ $json.logging_data.note_text.replace(/'/g, \"''\") }}', 'voice_ai', '{{ $json.logging_data.call_id }}', 'patient_notes_field', {{ $json.logging_data.success }}, now()) RETURNING *;","options":{"queryBatching":"independently"}},"id":"c636aa63-5dca-45aa-8ed2-d1aa36aa3e6f","name":"Log to Database","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1760,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_log (webhook_name, call_id, request_body, response_body, success, duration_ms, cache_hit, created_at) VALUES ('update-notes', '{{ $items(\"Build Response\")[0].json.logging_data.call_id }}', '{{ JSON.stringify($items(\"Extract Request Data\")[0].json) }}'::jsonb, '{{ JSON.stringify($items(\"Build Response\")[0].json) }}'::jsonb, true, {{ $items(\"Build Response\")[0].json.logging_data.duration_ms }}, false, now()) RETURNING *;","options":{"queryBatching":"independently"}},"id":"820e3fd4-7fe6-4899-b97e-ac02d910d62f","name":"Log Webhook Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1984,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Format Note for Cliniko","type":"main","index":0}]]},"Format Note for Cliniko":{"main":[[{"node":"Get Patient Details","type":"main","index":0}]]},"Get Patient Details":{"main":[[{"node":"Append to Existing Notes","type":"main","index":0}]]},"Append to Existing Notes":{"main":[[{"node":"Update Patient Notes","type":"main","index":0}]]},"Update Patient Notes":{"main":[[{"node":"Build Response","type":"main","index":0}]]},"Build Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log to Database","type":"main","index":0}]]},"Log to Database":{"main":[[{"node":"Log Webhook Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"65069c9b-f020-488c-b6b8-0d4b4b7078e0","triggerCount":1,"shared":[{"updatedAt":"2025-11-08T07:36:55.858Z","createdAt":"2025-11-08T07:36:55.858Z","role":"workflow:owner","workflowId":"ILVuCeQstKNm7QbJ","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-16T07:25:52.833Z","createdAt":"2025-11-08T08:29:29.463Z","id":"rzb4TuUYvRUYI0lb","name":"RetellAI - Lookup Caller by Phone v1.1","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/lookup-caller-phone","responseMode":"responseNode","options":{}},"id":"eca4499c-7779-414c-b1b4-7f77acdcaf60","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-400,64],"webhookId":"lookup-caller-phone"},{"parameters":{"jsCode":"// Input validation: handles missing/malformed data gracefully\n// Extract caller numbers and surface both normalized and carrier \"from\" values\n\nconst webhookData = $input.item.json.body || {};\nconst args   = webhookData.args || {};\nconst call   = webhookData.call || {};\nconst hdrs   = ($input.item.json.headers) || {};\n\n// pick the first non-empty string\nfunction pick(...v){ return v.find(x => typeof x === 'string' && x.trim() !== ''); }\n\n// AU E.164 best-effort\nfunction normAU(p){\n  if(!p) return null;\n  let d = (''+p).replace(/[^0-9+]/g,'');\n  if(d.startsWith('+')) return d;\n  if(d.startsWith('0')) d = '61' + d.slice(1);\n  if(!d.startsWith('61')) d = '61' + d;\n  return '+' + d;\n}\n\n// raw from_number direct from carrier (prefer this)\nconst carrierRaw = pick(call.from_number, webhookData.from_number, hdrs['x-retell-phone']);\n\n// user/agent supplied phone (may be a placeholder)\nlet spoken = args.phone_number;\n\n// if placeholders/unknown, fall back to carrier\nif(!spoken || /unknown|<caller_phone_number>|<call_id>/i.test(spoken)){\n  spoken = carrierRaw;\n}\n\n// normalize both\nconst phone_e164   = normAU(spoken) || null;\nconst carrier_e164 = normAU(carrierRaw) || null;\n\nreturn [{\n  json: {\n    // keep your original outputs\n    phone_number: phone_e164 || (spoken || '').replace(/[\\s\\-\\(\\)]/g,''),  // backward-compatible\n    call_id: call.call_id || args.call_id || '',\n\n    // NEW: make carrier explicit\n    carrier_from_number: carrierRaw || null,\n    carrier_from_number_e164: carrier_e164,\n\n    // preserve the full payload you were returning\n    original_data: webhookData\n  }\n}];"},"id":"5fb10acf-fcaf-4973-8076-f4ae4550521b","name":"Extract Phone Number","type":"n8n-nodes-base.code","typeVersion":2,"position":[-144,64]},{"parameters":{"operation":"executeQuery","query":"SELECT \n  patient_id,\n  first_name,\n  last_name,\n  preferred_name,\n  email,\n  phone,\n  phone_mobile,\n  date_of_birth,\n  village,\n  archived,\n  last_synced,\n  '{{ $json.phone_number }}'::text AS phone_searched\nFROM patients\nWHERE \n  (phone_normalized = '{{ $json.phone_number }}' \n   OR phone_mobile_normalized = '{{ $json.phone_number }}')\n  AND archived = false\nLIMIT 1","options":{}},"id":"da28468b-025b-4cc6-a4d9-fde8c415e07a","name":"Postgres - Lookup Patient","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[304,64],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Build a clean response for RetellAI without relying on paired items.\n// Input to this node comes from \"Postgres - Lookup Patient\".\n\nconst items = $input.all();\nconst row = items[0]?.json || {};\n\n// Prefer the searched phone the DB node echoed; fall back gracefully.\nconst phoneNumber =\n  $json.phone_searched ??\n  ($items('Postgres - Lookup Patient')[0]?.json?.phone_searched) ??\n  ($items('Extract Phone Number')[0]?.json?.phone_number) ??\n  null;\n\n// Get the carrier \"from\" number we upserted earlier.\n// If missing, fall back to what Extract Phone saw.\nconst carrierFrom =\n  ($items('Execute a SQL query')[0]?.json?.from_number) ??\n  ($items('Extract Phone Number')[0]?.json?.carrier_from_number) ??\n  null;\n\n// No match case\nif (!row.patient_id) {\n  return [{\n    json: {\n      found: false,\n      phone_searched: phoneNumber,\n      carrier_from_number: carrierFrom || null,\n      message: 'No patient found with this phone number',\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// Build patient object\nconst patient = {\n  id: row.patient_id,\n  first_name: row.first_name,\n  last_name: row.last_name,\n  full_name: [row.first_name, row.last_name].filter(Boolean).join(' '),\n  preferred_name: row.preferred_name || row.first_name || null,\n  email: row.email || null,\n  phone: row.phone || null,\n  mobile: row.phone_mobile || null,\n  dob: row.date_of_birth || null,\n  village: row.village || null,\n  is_archived: row.archived === true,\n  is_active: row.archived === false,\n  cliniko_url: row.patient_id ? `https://reignitehealth.au2.cliniko.com/patients/${row.patient_id}` : null,\n  last_synced: row.last_synced || null\n};\n\nreturn [{\n  json: {\n    found: true,\n    phone_searched: phoneNumber,\n    carrier_from_number: carrierFrom || null,\n    patient,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"b5ae31c6-0baa-4cca-bdcb-eeffd16fcc3c","name":"Transform for RetellAI","type":"n8n-nodes-base.code","typeVersion":2,"position":[528,64]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"42032bd1-4ad9-46bd-a999-46fa74661845","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[736,64]},{"parameters":{"operation":"executeQuery","query":"CREATE TABLE IF NOT EXISTS retell_calls (\n  call_id      text PRIMARY KEY,\n  phone_number text,\n  no_phone     boolean DEFAULT false,\n  from_number  text,\n  created_at   timestamptz DEFAULT now(),\n  updated_at   timestamptz DEFAULT now()\n);\n\nINSERT INTO retell_calls (call_id, phone_number, from_number)\nVALUES (\n  '{{ $json.call_id || \"\" }}',\n  NULLIF('{{ $json.phone_number || \"\" }}',''),\n  NULLIF('{{ $json.carrier_from_number || $json.carrier_from_number_e164 || \"\" }}','')\n)\nON CONFLICT (call_id) DO UPDATE SET\n  phone_number = COALESCE(NULLIF(EXCLUDED.phone_number,''), retell_calls.phone_number),\n  from_number  = COALESCE(retell_calls.from_number, NULLIF(EXCLUDED.from_number,'')),\n  updated_at   = now() RETURNING *;\n\n-- return what we now know (handy during testing)\nSELECT call_id, phone_number, from_number FROM retell_calls\nWHERE call_id = '{{ $json.call_id || \"\" }}' LIMIT 1;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[80,64],"id":"596788e2-36a9-42da-b406-34159ad21e19","name":"Execute a SQL query","alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Phone Number","type":"main","index":0}]]},"Extract Phone Number":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]},"Postgres - Lookup Patient":{"main":[[{"node":"Transform for RetellAI","type":"main","index":0}]]},"Transform for RetellAI":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Execute a SQL query":{"main":[[{"node":"Postgres - Lookup Patient","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"895aeb2b-90a7-4080-a8de-cef2d4d39d02","triggerCount":1,"shared":[{"updatedAt":"2025-11-08T08:29:29.463Z","createdAt":"2025-11-08T08:29:29.463Z","role":"workflow:owner","workflowId":"rzb4TuUYvRUYI0lb","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-11T03:32:09.695Z","createdAt":"2025-11-08T09:30:10.861Z","id":"8eyP8QHpEwut7k7F","name":"RetellAI - Create Appointment v2.3 FIXED","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/create-appointment","responseMode":"responseNode","options":{}},"id":"0ff7d07c-39b0-4b5f-a97e-abedaac82da0","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"create-appointment"},{"parameters":{"jsCode":"// Extract and validate request parameters\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\n// Extract required parameters\nconst patient_id = args.patient_id || '';\nconst practitioner_id = args.practitioner_id || '473326864069303022'; // Default: Liam Potter\nconst appointment_type = args.appointment_type || 'Initial Consultation';\nconst datetime = args.datetime || '';\nconst duration_minutes = parseInt(args.duration_minutes) || 60;\nconst village = args.village || '';\nconst funding_type = (args.funding_type || '').toUpperCase();\nconst reason = args.reason || '';\nconst requires_referral = args.requires_referral === true || args.requires_referral === 'true';\nconst notes = args.notes || '';\nconst call_id = call.call_id || args.call_id || '';\n\n// Validate required fields\nif (!patient_id) {\n  throw new Error('patient_id is required');\n}\nif (!datetime) {\n  throw new Error('datetime is required');\n}\nif (!village) {\n  throw new Error('village is required');\n}\nif (!funding_type) {\n  throw new Error('funding_type is required');\n}\n\n// Validate funding type\nconst validFundingTypes = ['HCP', 'DVA', 'GP', 'PRIVATE', 'PHI'];\nif (!validFundingTypes.includes(funding_type)) {\n  throw new Error(`Invalid funding_type. Must be one of: ${validFundingTypes.join(', ')}`);\n}\n\n// Parse and validate datetime\nconst appointmentDate = new Date(datetime);\nif (isNaN(appointmentDate.getTime())) {\n  throw new Error('Invalid datetime format. Use ISO 8601 format.');\n}\n\n// Check datetime is in the future\nconst now = new Date();\nif (appointmentDate <= now) {\n  throw new Error('Appointment datetime must be in the future');\n}\n\n// Check datetime is within 21-day booking window\nconst maxBookingDate = new Date(now);\nmaxBookingDate.setDate(now.getDate() + 21);\nif (appointmentDate > maxBookingDate) {\n  const daysAhead = Math.ceil((appointmentDate - now) / (1000 * 60 * 60 * 24));\n  throw new Error(`Appointment is ${daysAhead} days ahead. Bookings are limited to 21 days in advance. Error code: BOOKING_WINDOW_EXCEEDED`);\n}\n\n// Calculate end time\nconst endDate = new Date(appointmentDate);\nendDate.setMinutes(endDate.getMinutes() + duration_minutes);\nconst ends_at = endDate.toISOString();\n\n// Format datetime for display\nconst dateStr = appointmentDate.toLocaleDateString('en-AU', { \n  weekday: 'long', \n  year: 'numeric', \n  month: 'long', \n  day: 'numeric' \n});\nconst timeStr = appointmentDate.toLocaleTimeString('en-AU', { \n  hour: '2-digit', \n  minute: '2-digit', \n  hour12: true \n});\n\n// Build appointment notes\nconst appointmentNotes = [\n  `Booking via Voice AI`,\n  `Call ID: ${call_id}`,\n  `Funding: ${funding_type}`,\n  requires_referral ? 'Referral required' : 'No referral required',\n  reason ? `Reason: ${reason}` : '',\n  notes ? `Notes: ${notes}` : ''\n].filter(n => n).join('\\n');\n\n// Return validated data\nreturn [{\n  json: {\n    patient_id,\n    practitioner_id,\n    business_id: '675491769126754955',\n    appointment_type_id: '472831283798480897', // Liam's standard appointment type\n    appointment_type,\n    starts_at: datetime,\n    ends_at,\n    duration_minutes,\n    village,\n    funding_type,\n    reason,\n    requires_referral,\n    notes: appointmentNotes,\n    call_id,\n    // Formatted for display\n    date_formatted: dateStr,\n    time_formatted: timeStr,\n    date_only: appointmentDate.toISOString().split('T')[0],\n    time_only: timeStr,\n    // Metadata\n    timestamp: new Date().toISOString(),\n    start_time: Date.now()\n  }\n}];"},"id":"7b30cba3-b9d2-4e7f-befd-efb250d4fc24","name":"Extract & Validate Request","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"method":"POST","url":"https://api.au2.cliniko.com/v1/appointments","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"},{"name":"Accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ { patient_id: $json.patient_id, practitioner_id: $json.practitioner_id, business_id: $json.business_id, appointment_type_id: $json.appointment_type_id, starts_at: $json.starts_at, ends_at: $json.ends_at, notes: $json.notes, send_sms: true } }}","options":{}},"id":"be6c87b4-d845-493a-b79d-814d6894d43a","name":"Create Appointment in Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[448,0],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"// Process Cliniko API response\nconst items = $input.all();\nconst requestData = $items(\"Extract & Validate Request\")[0].json;\n\n// Check if Cliniko API call succeeded\nif (items.length === 0 || items[0].json.error) {\n  const errorMsg = items[0]?.json?.error || 'Failed to create appointment in Cliniko';\n  return [{\n    json: {\n      success: false,\n      appointment_created: false,\n      error: {\n        code: 'CLINIKO_API_ERROR',\n        message: errorMsg\n      },\n      call_id: requestData.call_id,\n      timestamp: new Date().toISOString(),\n      is_error: true,\n      // Keep request data for logging\n      request_data: requestData\n    }\n  }];\n}\n\nconst cliniko_response = items[0].json;\n\n// Check if appointment was actually created\nif (!cliniko_response.id) {\n  return [{\n    json: {\n      success: false,\n      appointment_created: false,\n      error: {\n        code: 'CLINIKO_API_ERROR',\n        message: 'Appointment creation failed - no ID returned'\n      },\n      call_id: requestData.call_id,\n      timestamp: new Date().toISOString(),\n      is_error: true,\n      request_data: requestData\n    }\n  }];\n}\n\n// Success - appointment created\n// Extract patient name from Cliniko response\nconst patient_name = cliniko_response.patient?.first_name && cliniko_response.patient?.last_name \n  ? `${cliniko_response.patient.first_name} ${cliniko_response.patient.last_name}`\n  : 'Patient';\n\nreturn [{\n  json: {\n    // Original request data\n    ...requestData,\n    // Cliniko response data\n    appointment_id: cliniko_response.id,\n    patient_name: patient_name,\n    practitioner_name: 'Liam Potter',\n    cliniko_link: `https://reignitehealth.au2.cliniko.com/appointments/${cliniko_response.id}`,\n    sms_sent: true,\n    is_error: false,\n    // Full Cliniko response for debugging\n    cliniko_response: cliniko_response\n  }\n}];"},"id":"36c4bd7a-3b5a-4519-9de3-e13740f114dd","name":"Process Cliniko Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"operation":"executeQuery","query":"=DELETE FROM patient_funding_cache WHERE patient_id = '{{ $json.patient_id }}' RETURNING *;","options":{"queryBatching":"independently"}},"id":"4637e466-0d7e-4e46-a385-f61669da900b","name":"Invalidate Patient Funding Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[896,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"jsCode":"// Format final response\n// CRITICAL: Reference the \"Process Cliniko Response\" node directly\n// because the previous node (Invalidate Cache) outputs different data\nconst data = $items(\"Process Cliniko Response\")[0].json;\n\n// Check if this is an error response\nif (data.is_error) {\n  return [{ \n    json: {\n      success: false,\n      appointment_created: false,\n      error: data.error,\n      call_id: data.call_id,\n      timestamp: data.timestamp\n    }\n  }];\n}\n\n// Build success response with ALL details\nconst response = {\n  success: true,\n  appointment_created: true,\n  appointment_id: data.appointment_id,\n  confirmation_details: {\n    patient_name: data.patient_name,\n    practitioner_name: data.practitioner_name,\n    datetime: data.starts_at,\n    date: data.date_formatted,\n    time: data.time_formatted,\n    duration_minutes: data.duration_minutes,\n    village: data.village,\n    funding_type: data.funding_type,\n    appointment_type: data.appointment_type\n  },\n  sms_sent: data.sms_sent,\n  flagged_for_review: true,\n  cliniko_link: data.cliniko_link,\n  call_id: data.call_id,\n  timestamp: new Date().toISOString()\n};\n\nreturn [{ json: response }];"},"id":"97a1b902-20c1-4ed6-bfc9-cd796a1211c3","name":"Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1120,0]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"f65810c3-42b8-4ddd-a39b-36abad6a5a3b","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1344,0]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO appointment_log (appointment_id, patient_id, practitioner_id, datetime, duration_minutes, appointment_type, funding_type, village, created_via, call_id, flagged_for_review, created_at) VALUES ('{{ $items(\"Process Cliniko Response\")[0].json.appointment_id }}', '{{ $items(\"Extract & Validate Request\")[0].json.patient_id }}', '{{ $items(\"Extract & Validate Request\")[0].json.practitioner_id }}', '{{ $items(\"Extract & Validate Request\")[0].json.starts_at }}'::timestamptz, {{ $items(\"Extract & Validate Request\")[0].json.duration_minutes }}, '{{ $items(\"Extract & Validate Request\")[0].json.appointment_type }}', '{{ $items(\"Extract & Validate Request\")[0].json.funding_type }}', '{{ $items(\"Extract & Validate Request\")[0].json.village }}', 'voice_ai', '{{ $items(\"Extract & Validate Request\")[0].json.call_id }}', true, now()) RETURNING *;","options":{"queryBatching":"independently"}},"id":"a0e00351-5426-4840-9cce-abb704d5b58e","name":"Log Appointment to Database","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1568,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO webhook_log (webhook_name, call_id, request_body, response_body, success, duration_ms, cache_hit, created_at) VALUES ('create-appointment', '{{ $items(\"Extract & Validate Request\")[0].json.call_id }}', '{{ JSON.stringify($items(\"Extract & Validate Request\")[0].json) }}'::jsonb, '{{ JSON.stringify($items(\"Format Response\")[0].json) }}'::jsonb, {{ $items(\"Format Response\")[0].json.success }}, {{ Date.now() - $items(\"Extract & Validate Request\")[0].json.start_time }}, false, now()) RETURNING *;","options":{"queryBatching":"independently"}},"id":"c1f26865-13d5-4824-a723-d23271951baa","name":"Log Webhook Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1792,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true}],"connections":{"Webhook":{"main":[[{"node":"Extract & Validate Request","type":"main","index":0}]]},"Extract & Validate Request":{"main":[[{"node":"Create Appointment in Cliniko","type":"main","index":0}]]},"Create Appointment in Cliniko":{"main":[[{"node":"Process Cliniko Response","type":"main","index":0}]]},"Process Cliniko Response":{"main":[[{"node":"Invalidate Patient Funding Cache","type":"main","index":0}]]},"Invalidate Patient Funding Cache":{"main":[[{"node":"Format Response","type":"main","index":0}]]},"Format Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Appointment to Database","type":"main","index":0}]]},"Log Appointment to Database":{"main":[[{"node":"Log Webhook Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"01fb06e8-787d-42e3-8b96-8db2186047df","triggerCount":1,"shared":[{"updatedAt":"2025-11-08T09:30:10.861Z","createdAt":"2025-11-08T09:30:10.861Z","role":"workflow:owner","workflowId":"8eyP8QHpEwut7k7F","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-04T02:24:27.210Z","createdAt":"2025-12-04T01:52:16.217Z","id":"lTSZxat0xt2EfObW","name":"Send System Email","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"send-system-email","responseMode":"responseNode","options":{}},"id":"e05b6d8f-390d-475d-af03-7d1bae1d9293","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[260,300]},{"parameters":{"sendTo":"={{ $json.body.to || 'peter@yesai.au' }}","subject":"={{ $json.body.subject || 'System Notification' }}","emailType":"html","message":"={{ $json.body.html }}","options":{}},"id":"d24468d8-1c24-479f-a094-320c4f93f312","name":"Gmail","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[480,300],"credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}},{"parameters":{"respondWith":"json","responseBody":"={{ { \"success\": true, \"message\": \"Email sent to \" + ($json.body?.to || 'peter@yesai.au') } }}","options":{}},"id":"8f752767-cf34-4491-a73a-f0c2eaf78dc8","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[700,300]}],"connections":{"Webhook":{"main":[[{"node":"Gmail","type":"main","index":0}]]},"Gmail":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"b6f8c4ec-b157-4b12-b0d4-1e541a13095f","triggerCount":1,"shared":[{"updatedAt":"2025-12-04T01:52:16.217Z","createdAt":"2025-12-04T01:52:16.217Z","role":"workflow:owner","workflowId":"lTSZxat0xt2EfObW","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-04T10:28:22.957Z","createdAt":"2025-12-04T10:28:14.519Z","id":"EXSLqjHqHR0lFR0U","name":"TEMP - Drop Constraint Fix","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"temp-drop-constraint","responseMode":"responseNode","options":{}},"id":"webhook-001","name":"Webhook Trigger","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,300],"webhookId":"temp-drop-constraint"},{"parameters":{"operation":"executeQuery","query":"ALTER TABLE individual_slots_cache DROP CONSTRAINT IF EXISTS unique_practitioner_slot; CREATE UNIQUE INDEX IF NOT EXISTS idx_slots_unique_practitioner_time_village ON individual_slots_cache(practitioner_id, starts_at, village); SELECT 'constraint dropped, new index created' as result;","options":{}},"id":"postgres-001","name":"Drop Constraint","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[250,300],"credentials":{"postgres":{"id":"R69Kqj5pJPT4CyDE","name":"RetellAI Postgres DB"}}},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"respond-001","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[500,300]}],"connections":{"Webhook Trigger":{"main":[[{"node":"Drop Constraint","type":"main","index":0}]]},"Drop Constraint":{"main":[[{"node":"Respond","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"3dc66422-4a8b-4dee-9749-d48d64670828","triggerCount":1,"shared":[{"updatedAt":"2025-12-04T10:28:14.519Z","createdAt":"2025-12-04T10:28:14.519Z","role":"workflow:owner","workflowId":"EXSLqjHqHR0lFR0U","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-08T19:23:01.604Z","createdAt":"2025-11-08T10:42:55.834Z","id":"S1wesIpfrjczyHrF","name":"RetellAI - Get Practitioner Availability v1.1","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-availability","responseMode":"responseNode","options":{}},"id":"1ef458a7-7e14-4112-a07d-dea688be7217","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"get-availability"},{"parameters":{"jsCode":"// Extract and validate request parameters\nconst webhookData = $input.item.json.body || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\n// Extract parameters\nconst village_name = args.village_name || '';\nconst date = args.date || '';\nconst check_availability = args.check_availability === true || args.check_availability === 'true';\nconst call_id = call.call_id || args.call_id || '';\n\n// Validate required fields\nif (!village_name) {\n  throw new Error('village_name is required');\n}\n\n// Date is optional - if not provided, use today\nconst targetDate = date || new Date().toISOString().split('T')[0];\n\n// Map village names to business IDs\nconst villageBusinessMap = {\n  'Brentwood': '1710601771996420729',\n  'Dee Why Gardens': '1374156546560236184',\n  'Glenaeon': '1239460067472840799',\n  'Gordon Quarter': '961914130913040793',\n  'Henry Kendall Gardens': '1660498557771192794',\n  'Lutanda Manor': '1696156412926761532',\n  'Maybrook': '1786735647856270138',\n  'The Baytree': '829296846122784947',\n  'Warriewood Brook': '675491769126754955'\n};\n\nconst business_id = villageBusinessMap[village_name];\nif (!business_id) {\n  throw new Error(`Invalid village_name: ${village_name}`);\n}\n\nconst startTime = Date.now();\n\nreturn [{\n  json: {\n    village_name,\n    business_id,\n    date: targetDate,\n    check_availability,\n    call_id,\n    appointment_type_id: '1435018693833661111',\n    start_time: startTime,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"bb04bd5a-06bf-4fd0-8ded-9798e5f9a9d9","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[256,0]},{"parameters":{"operation":"executeQuery","query":"-- Check practitioner cache (24 hour TTL)\nSELECT \n  id,\n  practitioner_data,\n  EXTRACT(EPOCH FROM (now() - cached_at))/3600 as hours_old\nFROM practitioner_cache\nWHERE cache_key = 'all_practitioners'\n  AND cached_at > now() - interval '24 hours'\nLIMIT 1;","options":{"queryBatching":"independently"}},"id":"7b5af45b-156e-4a43-8295-5c3b1d4aa913","name":"Check Practitioner Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[512,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Check if we have cached practitioner data\nconst items = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// If we have cached data, return it\nif (items.length > 0 && items[0].json.id) {\n  const cached = items[0].json;\n  let practitionerData = [];\n  \n  try {\n    practitionerData = JSON.parse(cached.practitioner_data);\n    if (!Array.isArray(practitionerData)) {\n      throw new Error('Cached data is not an array');\n    }\n  } catch (e) {\n    console.error('Cache corrupted:', e);\n    // Fall through to cache miss\n  }\n  \n  if (practitionerData.length > 0) {\n    return [{\n      json: {\n        practitioners: practitionerData,\n        from_cache: true,\n        needs_cliniko_fetch: false\n      }\n    }];\n  }\n}\n\n// Cache miss - need to fetch from Cliniko\nreturn [{\n  json: {\n    practitioners: [],\n    from_cache: false,\n    needs_cliniko_fetch: true\n  }\n}];"},"id":"19c89292-d7ac-4e18-bba7-7390d191362a","name":"Handle Cache","type":"n8n-nodes-base.code","typeVersion":2,"position":[752,0]},{"parameters":{"url":"https://api.au2.cliniko.com/v1/practitioners","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Accept","value":"application/json"},{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"}]},"options":{}},"id":"b9c4a784-6192-4aec-8269-d27e1fdfee47","name":"Fetch Practitioners from Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1008,0],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"// Process Cliniko response\nconst response = $input.item.json;\nconst cacheData = $items(\"Handle Cache\")[0].json;\n\n// If cache hit, just pass through\nif (cacheData.from_cache) {\n  return [{ json: { practitioners: cacheData.practitioners, from_cache: true } }];\n}\n\n// Check for API errors\nif (response.error || response.statusCode >= 400) {\n  throw new Error(`Cliniko API error: ${response.error || 'Unknown error'}`);\n}\n\n// Extract practitioners from response\nconst practitioners = response.practitioners || [];\n\n// Map to our format with village assignments from roster\nconst practitionerMap = {\n  'Liam Potter': { villages: ['Gordon Quarter', 'The Baytree', 'Dee Why Gardens', 'Glenaeon', 'Warriewood Brook'], title: 'Physio', specialty: 'Physio' },\n  'Paul Salem': { villages: ['Gordon Quarter', 'The Baytree', 'Dee Why Gardens', 'Glenaeon'], title: 'Physio', specialty: 'Physio' },\n  'Casey Resch': { villages: ['Glenaeon', 'Dee Why Gardens', 'Maybrook'], title: 'Physio', specialty: 'Physio', notes: 'Specialises in neuro & chronic pain' },\n  'Sue Williams': { villages: ['Gordon Quarter'], title: 'Physio', specialty: 'Physio', notes: 'Does NOT take massage requests' },\n  'Lesley Miller': { villages: ['Warriewood Brook', 'Dee Why Gardens'], title: 'Physio', specialty: 'Physio', notes: 'Female practitioner' },\n  'Cecilia Bae': { villages: ['Lutanda Manor'], title: 'Physio', specialty: 'Physio' },\n  'Loren Lozano': { villages: ['Henry Kendall Gardens', 'Brentwood'], title: 'Physio', specialty: 'Physio', notes: 'Pronounced like Ralph Lauren' },\n  'Joanna Peel': { villages: ['Warriewood Brook'], title: 'Physio', specialty: 'Physio' },\n  'Samantha Salerno': { villages: ['Gordon Quarter'], title: 'EP', specialty: 'EP' },\n  'Lucas Lung': { villages: ['Warriewood Brook'], title: 'EP', specialty: 'EP', notes: 'Level 2 S&C Certified' },\n  'Alec Pijcke': { villages: ['Brentwood'], title: 'EP', specialty: 'EP' }\n};\n\nconst mappedPractitioners = practitioners\n  .filter(p => p.active && p.show_in_online_bookings)\n  .map(p => {\n    // Use label (full name) for matching, fallback to display_name or constructed name\n    const fullName = p.label || p.display_name || `${p.first_name} ${p.last_name}`;\n    const roster = practitionerMap[fullName] || { villages: [], title: 'Unknown', specialty: 'Unknown' };\n    \n    return {\n      cliniko_id: p.id,\n      name: fullName,\n      first_name: p.first_name,\n      last_name: p.last_name,\n      title: roster.title,\n      specialty: roster.specialty,\n      villages: roster.villages,\n      notes: roster.notes || '',\n      active: p.active,\n      show_in_online_bookings: p.show_in_online_bookings\n    };\n  });\n\nreturn [{\n  json: {\n    practitioners: mappedPractitioners,\n    from_cache: false,\n    fetched_from_cliniko: true\n  }\n}];"},"id":"692f7924-7661-47a6-b058-023ff4430a7f","name":"Process Cliniko Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1264,0]},{"parameters":{"operation":"executeQuery","query":"-- Cache practitioner data for 24 hours\nINSERT INTO practitioner_cache (\n  cache_key,\n  practitioner_data,\n  cached_at\n)\nVALUES (\n  'all_practitioners',\n  '{{ JSON.stringify($json.practitioners) }}'::jsonb,\n  now()\n)\nON CONFLICT (cache_key) \nDO UPDATE SET\n  practitioner_data = EXCLUDED.practitioner_data,\n  cached_at = now()\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"b5ce4540-a4f8-4b88-a621-c05bc3e371ce","name":"Cache Practitioners","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1504,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Filter practitioners by village and check availability if requested\nconst practitionerData = $items(\"Process Cliniko Response\")[0].json;\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\nconst village_name = requestData.village_name;\nconst check_availability = requestData.check_availability;\nconst all_practitioners = practitionerData.practitioners || [];\n\n// Filter by village\nconst village_practitioners = all_practitioners.filter(p => \n  p.villages.includes(village_name)\n);\n\nif (village_practitioners.length === 0) {\n  return [{\n    json: {\n      success: true,\n      available_practitioners: [],\n      message: `No practitioners found for ${village_name}`,\n      call_id: requestData.call_id,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// If not checking availability, return all village practitioners\nif (!check_availability) {\n  const result = village_practitioners.map(p => ({\n    name: p.name,\n    title: p.title,\n    specialty: p.specialty,\n    notes: p.notes || undefined\n  }));\n  \n  return [{\n    json: {\n      success: true,\n      available_practitioners: result,\n      village: village_name,\n      date: requestData.date,\n      availability_checked: false,\n      call_id: requestData.call_id,\n      duration_ms: Date.now() - requestData.start_time,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// Need to check availability - prepare data for Cliniko API calls\nreturn [{\n  json: {\n    village_practitioners,\n    business_id: requestData.business_id,\n    appointment_type_id: requestData.appointment_type_id,\n    date: requestData.date,\n    check_availability: true,\n    call_id: requestData.call_id,\n    start_time: requestData.start_time\n  }\n}];"},"id":"6aebadcb-049c-4d04-afab-f4396ac13635","name":"Filter and Prepare","type":"n8n-nodes-base.code","typeVersion":2,"position":[1760,0]},{"parameters":{"jsCode":"// Check availability for each practitioner using Cliniko API\n// Note: This is a simplified version - in production, you'd make actual API calls\nconst prepData = $input.item.json;\nconst village_practitioners = prepData.village_practitioners || [];\n\n// TODO: Replace with actual Cliniko availability API calls\n// For now, return all practitioners as potentially available\nconst available_practitioners = village_practitioners.map(p => ({\n  name: p.name,\n  title: p.title,\n  specialty: p.specialty,\n  notes: p.notes || undefined,\n  next_available: prepData.date + 'T09:00:00Z' // Mock data\n}));\n\nreturn [{\n  json: {\n    success: true,\n    available_practitioners,\n    village: prepData.village,\n    date: prepData.date,\n    availability_checked: true,\n    call_id: prepData.call_id,\n    duration_ms: Date.now() - prepData.start_time,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"76c1ac76-6fe5-4dfd-8218-4099684b25de","name":"Check Availability","type":"n8n-nodes-base.code","typeVersion":2,"position":[2000,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"de63eaf3-0284-4828-b482-0d44723a23dd","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2256,0]},{"parameters":{"operation":"executeQuery","query":"-- Log webhook execution\nINSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_body,\n  response_body,\n  success,\n  duration_ms,\n  cache_hit,\n  created_at\n)\nVALUES (\n  'get-availability',\n  '{{ $items(\"Extract Request Data\")[0].json.call_id }}',\n  '{{ JSON.stringify($items(\"Extract Request Data\")[0].json) }}'::jsonb,\n  '{{ JSON.stringify($items(\"Check Availability\")[0].json) }}'::jsonb,\n  true,\n  {{ $items(\"Check Availability\")[0].json.duration_ms || 0 }},\n  {{ $items(\"Handle Cache\")[0]?.json?.from_cache || false }},\n  now()\n)\nRETURNING *;","options":{}},"id":"785ab614-24c3-4573-9fbd-0e47eb44a34d","name":"Log Webhook Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[2512,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Check Practitioner Cache","type":"main","index":0}]]},"Check Practitioner Cache":{"main":[[{"node":"Handle Cache","type":"main","index":0}]]},"Handle Cache":{"main":[[{"node":"Fetch Practitioners from Cliniko","type":"main","index":0}]]},"Fetch Practitioners from Cliniko":{"main":[[{"node":"Process Cliniko Response","type":"main","index":0}]]},"Process Cliniko Response":{"main":[[{"node":"Cache Practitioners","type":"main","index":0}]]},"Cache Practitioners":{"main":[[{"node":"Filter and Prepare","type":"main","index":0}]]},"Filter and Prepare":{"main":[[{"node":"Check Availability","type":"main","index":0}]]},"Check Availability":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Webhook Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"924a76d4-8cf3-48d1-88e7-c82d36977d9e","triggerCount":1,"shared":[{"updatedAt":"2025-11-08T10:42:55.834Z","createdAt":"2025-11-08T10:42:55.834Z","role":"workflow:owner","workflowId":"S1wesIpfrjczyHrF","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-25T08:34:44.113Z","createdAt":"2025-11-08T21:57:34.873Z","id":"Nl5vN6BRFU1GBWCC","name":"RetellAI - Check Recurring Conflict v1.0","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/check-recurring-conflict","responseMode":"responseNode","options":{}},"id":"cbba68f4-2c04-4200-9efa-cc87428e0ec1","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"check-recurring-conflict"},{"parameters":{"jsCode":"\n// Universal Phone Normalization (Australian E.164) - v9.09\n\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n\n  // 1. Strip everything except digits and '+'\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n\n  // 2. Already in E.164 format\n  if (phone.startsWith('+')) {\n    return phone;\n  }\n\n  // 3. Handle 8-digit local numbers (Assume NSW '02')\n  if (phone.length === 8 && !phone.startsWith('+')) {\n    return '+612' + phone;\n  }\n\n  // 4. Handle standard 10-digit AU numbers (04... or 02...)\n  if (phone.length === 10 && phone.startsWith('0')) {\n    return '+61' + phone.substring(1);\n  }\n\n  // 5. Handle numbers starting with 61 (missing +)\n  if (phone.length === 11 && phone.startsWith('61')) {\n    return '+' + phone;\n  }\n\n  // 6. Assume Australian if 9 digits (missing leading 0)\n  if (phone.length === 9) {\n    return '+61' + phone;\n  }\n\n  // 7. Return cleaned version (best effort)\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n\n// Extract and validate request parameters\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\n// Extract required parameters\nconst practitioner_id = args.practitioner_id || '';\nconst datetime = args.datetime || '';\nconst duration_minutes = args.duration_minutes || 60;\nconst call_id = call.call_id || args.call_id || '';\n\n// Validate required fields\nif (!practitioner_id) {\n  throw new Error('practitioner_id is required');\n}\nif (!datetime) {\n  throw new Error('datetime is required');\n}\n\n// Parse datetime\nlet requestedDate;\ntry {\n  requestedDate = new Date(datetime);\n  if (isNaN(requestedDate.getTime())) {\n    throw new Error('Invalid datetime');\n  }\n} catch (e) {\n  throw new Error('Invalid datetime format. Expected ISO 8601.');\n}\n\n// Get day of week (0=Sunday, 1=Monday, etc.)\nconst daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\nconst day_of_week = daysOfWeek[requestedDate.getDay()];\n\n// Get time in HH:MM:SS format\nconst hours = String(requestedDate.getHours()).padStart(2, '0');\nconst minutes = String(requestedDate.getMinutes()).padStart(2, '0');\nconst requested_time = `${hours}:${minutes}:00`;\n\n// Calculate end time\nconst endDate = new Date(requestedDate.getTime() + duration_minutes * 60000);\nconst endHours = String(endDate.getHours()).padStart(2, '0');\nconst endMinutes = String(endDate.getMinutes()).padStart(2, '0');\nconst requested_end_time = `${endHours}:${endMinutes}:00`;\n\n// Format time for display (12-hour format with AM/PM)\nconst formatTime = (date) => {\n  let h = date.getHours();\n  const m = String(date.getMinutes()).padStart(2, '0');\n  const ampm = h >= 12 ? 'PM' : 'AM';\n  h = h % 12;\n  h = h ? h : 12; // 0 should be 12\n  return `${h}:${m} ${ampm}`;\n};\n\nconst requested_time_display = formatTime(requestedDate);\n\nreturn [{\n  json: {\n    practitioner_id,\n    datetime,\n    duration_minutes,\n    day_of_week,\n    requested_time,\n    requested_end_time,\n    requested_time_display,\n    call_id,\n    start_time: Date.now(),\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"65297e46-ea51-484e-9892-297fdd86742a","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"operation":"executeQuery","query":"-- Check for conflicts with recurring clients\n-- This query finds any recurring appointment that overlaps with the requested time\nSELECT \n  id,\n  patient_id,\n  patient_name,\n  practitioner_id,\n  day_of_week,\n  time_slot,\n  duration_minutes,\n  frequency,\n  village,\n  notes\nFROM recurring_clients\nWHERE practitioner_id = '{{ $json.practitioner_id }}'\n  AND day_of_week = '{{ $json.day_of_week }}'\n  AND active = true\n  AND (\n    -- Check if requested slot overlaps with recurring slot\n    -- Case 1: Recurring slot starts before or at requested time and ends after requested start\n    (time_slot <= '{{ $json.requested_time }}'::time \n     AND (time_slot + (duration_minutes || ' minutes')::interval) > '{{ $json.requested_time }}'::time)\n    OR\n    -- Case 2: Recurring slot starts before requested end time and ends at or after requested end\n    (time_slot < '{{ $json.requested_end_time }}'::time \n     AND (time_slot + (duration_minutes || ' minutes')::interval) >= '{{ $json.requested_end_time }}'::time)\n    OR\n    -- Case 3: Recurring slot is entirely within requested slot\n    (time_slot >= '{{ $json.requested_time }}'::time \n     AND time_slot < '{{ $json.requested_end_time }}'::time)\n  )\nLIMIT 1;","options":{}},"id":"e6050832-8f9c-4e8f-984b-fa00c21f23dc","name":"Check Recurring Conflicts","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[464,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Handle conflict check results\nconst items = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// If conflicts found (items.length > 0 and has id field)\nif (items.length > 0 && items[0].json.id) {\n  const conflict = items[0].json;\n  \n  // Format time_slot for display (12-hour format with AM/PM)\n  const timeSlotStr = conflict.time_slot; // Format: \"HH:MM:SS\"\n  const [hours, mins] = timeSlotStr.split(':');\n  const h = parseInt(hours);\n  const m = mins;\n  const ampm = h >= 12 ? 'PM' : 'AM';\n  const displayHour = h % 12 || 12;\n  const timeSlotDisplay = `${displayHour}:${m} ${ampm}`;\n  \n  // Calculate duration_ms\n  const duration_ms = Date.now() - requestData.start_time;\n  \n  return [{\n    json: {\n      success: true,\n      conflict_exists: true,\n      can_book: false,\n      conflict_details: {\n        recurring_client_id: String(conflict.id),\n        recurring_client_name: conflict.patient_name,\n        usual_day: conflict.day_of_week,\n        usual_time: timeSlotDisplay,\n        duration_minutes: conflict.duration_minutes,\n        frequency: conflict.frequency,\n        village: conflict.village || '',\n        reason: 'This time slot is protected for a recurring client'\n      },\n      requested_time: {\n        datetime: requestData.datetime,\n        day_of_week: requestData.day_of_week,\n        time: requestData.requested_time_display,\n        duration_minutes: requestData.duration_minutes\n      },\n      call_id: requestData.call_id,\n      duration_ms: duration_ms,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// No conflict found\nconst duration_ms = Date.now() - requestData.start_time;\n\nreturn [{\n  json: {\n    success: true,\n    conflict_exists: false,\n    can_book: true,\n    message: 'No recurring client conflict found',\n    requested_time: {\n      datetime: requestData.datetime,\n      day_of_week: requestData.day_of_week,\n      time: requestData.requested_time_display,\n      duration_minutes: requestData.duration_minutes\n    },\n    call_id: requestData.call_id,\n    duration_ms: duration_ms,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"f11779e4-07d8-4016-a5bb-f36e0aa60043","name":"Handle Conflict Check","type":"n8n-nodes-base.code","typeVersion":2,"position":[704,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"d2929d49-4ded-4ffc-a776-2c109675355a","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[944,0]},{"parameters":{"operation":"executeQuery","query":"-- Log webhook execution (happens after response sent)\nINSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_body,\n  response_body,\n  success,\n  duration_ms,\n  created_at\n)\nVALUES (\n  'check-recurring-conflict',\n  '{{ $items(\"Extract Request Data\")[0].json.call_id }}',\n  '{{ JSON.stringify($items(\"Extract Request Data\")[0].json) }}'::jsonb,\n  '{{ JSON.stringify($items(\"Handle Conflict Check\")[0].json) }}'::jsonb,\n  {{ $items(\"Handle Conflict Check\")[0].json.success }},\n  {{ $items(\"Handle Conflict Check\")[0].json.duration_ms }},\n  now()\n)\nRETURNING *;","options":{}},"id":"8fe32ad1-d2b5-44e0-ae39-972b6eb472f6","name":"Log Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1168,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Check Recurring Conflicts","type":"main","index":0}]]},"Check Recurring Conflicts":{"main":[[{"node":"Handle Conflict Check","type":"main","index":0}]]},"Handle Conflict Check":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"ba97fa15-bee2-451e-927e-dd83c5684481","triggerCount":1,"shared":[{"updatedAt":"2025-11-08T21:57:34.873Z","createdAt":"2025-11-08T21:57:34.873Z","role":"workflow:owner","workflowId":"Nl5vN6BRFU1GBWCC","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-24T05:10:51.663Z","createdAt":"2025-11-08T22:47:26.117Z","id":"GN1l398EzlOmvmBI","name":"RetellAI - Get Reschedule Availability v1.0","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-reschedule-availability","responseMode":"responseNode","options":{}},"id":"16b4f68b-f1b9-452b-a454-d9a41abb796c","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1616,384],"webhookId":"a1b2c3d4-e5f6-7890-abcd-ef1234567890"},{"parameters":{"jsCode":"\n// Universal Phone Normalization (Australian E.164) - v9.09\n\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n\n  // 1. Strip everything except digits and '+'\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n\n  // 2. Already in E.164 format\n  if (phone.startsWith('+')) {\n    return phone;\n  }\n\n  // 3. Handle 8-digit local numbers (Assume NSW '02')\n  if (phone.length === 8 && !phone.startsWith('+')) {\n    return '+612' + phone;\n  }\n\n  // 4. Handle standard 10-digit AU numbers (04... or 02...)\n  if (phone.length === 10 && phone.startsWith('0')) {\n    return '+61' + phone.substring(1);\n  }\n\n  // 5. Handle numbers starting with 61 (missing +)\n  if (phone.length === 11 && phone.startsWith('61')) {\n    return '+' + phone;\n  }\n\n  // 6. Assume Australian if 9 digits (missing leading 0)\n  if (phone.length === 9) {\n    return '+61' + phone;\n  }\n\n  // 7. Return cleaned version (best effort)\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n\nconst webhookData = $input.item.json.body || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\nconst appointment_id = args.appointment_id || '';\nconst preferred_date = args.preferred_date || '';\nconst date_range_days = args.date_range_days || 14;\nconst call_id = call.call_id || args.call_id || '';\n\nif (!appointment_id) {\n  throw new Error('appointment_id is required');\n}\n\nconst targetDate = preferred_date || new Date().toISOString().split('T')[0];\n\nreturn [{\n  json: {\n    appointment_id,\n    preferred_date: targetDate,\n    date_range_days,\n    call_id,\n    start_time: Date.now(),\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"34fdede3-7c5c-4c1a-a7f0-33e7b4c87b6a","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1392,384]},{"parameters":{"url":"=https://api.au2.cliniko.com/v1/individual_appointments/{{ $json.appointment_id }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Accept","value":"application/json"},{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"}]},"options":{"response":{"response":{"responseFormat":"json"}}}},"id":"7dfe91a5-8627-44ac-9bb2-e39bc50d3ed5","name":"Get Current Appointment","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1168,384],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"const response = $input.item.json;\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\nif (response.error || response.statusCode >= 400) {\n  throw new Error('Failed to fetch appointment');\n}\n\nconst appointment = response;\nlet practitioner_id = null;\n\nif (appointment.practitioner?.links?.self) {\n  const match = appointment.practitioner.links.self.match(/practitioners\\/(\\d+)/);\n  if (match && match[1]) {\n    practitioner_id = match[1];\n  }\n}\n\nif (!practitioner_id) {\n  throw new Error('Could not extract practitioner ID');\n}\n\nconst starts_at = new Date(appointment.starts_at);\nconst ends_at = new Date(appointment.ends_at);\nconst duration_minutes = Math.round((ends_at - starts_at) / 60000);\n\nconst original_date = starts_at.toISOString().split('T')[0];\nconst original_time = starts_at.toLocaleTimeString('en-AU', { \n  hour: '2-digit', \n  minute: '2-digit', \n  hour12: true \n});\n\nreturn [{\n  json: {\n    ...requestData,\n    practitioner_id,\n    duration_minutes,\n    original_datetime: appointment.starts_at,\n    original_date,\n    original_time,\n    appointment_type_id: appointment.appointment_type?.id || ''\n  }\n}];"},"id":"5238f1d5-1b48-49d0-bb5c-954364e34771","name":"Process Current Appointment","type":"n8n-nodes-base.code","typeVersion":2,"position":[-960,384]},{"parameters":{"operation":"executeQuery","query":"SELECT id, practitioner_data, \n  EXTRACT(EPOCH FROM (now() - cached_at))/3600 as hours_old\nFROM practitioner_cache\nWHERE cache_key = 'all_practitioners'\n  AND cached_at > now() - interval '24 hours'\nLIMIT 1;","options":{"queryBatching":"single"}},"id":"0f86a5d4-52ec-474d-842e-fba8e35c10b6","name":"Check Practitioner Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-736,384],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"const items = $input.all();\nconst requestData = $items(\"Process Current Appointment\")[0].json;\n\nif (items.length > 0 && items[0].json.id) {\n  const cached = items[0].json;\n  let practitionerData = [];\n  \n  try {\n    practitionerData = JSON.parse(cached.practitioner_data);\n    if (Array.isArray(practitionerData) && practitionerData.length > 0) {\n      return [{\n        json: {\n          ...requestData,\n          practitioners: practitionerData,\n          from_cache: true,\n          needs_cliniko_fetch: false\n        }\n      }];\n    }\n  } catch (e) {\n    // Fall through to fetch\n  }\n}\n\nreturn [{\n  json: {\n    ...requestData,\n    practitioners: [],\n    from_cache: false,\n    needs_cliniko_fetch: true\n  }\n}];"},"id":"6c542c03-797d-4bc9-a0d3-bfcb2a106579","name":"Handle Cache","type":"n8n-nodes-base.code","typeVersion":2,"position":[-512,384]},{"parameters":{"url":"https://api.au2.cliniko.com/v1/practitioners","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Accept","value":"application/json"},{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"}]},"options":{"response":{"response":{"responseFormat":"json"}}}},"id":"fa5877ef-10e1-45b6-b7ec-05c5a6ddfbaf","name":"Fetch Practitioners from Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-288,384],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"const response = $input.item.json;\nconst cacheData = $items(\"Handle Cache\")[0].json;\n\nif (cacheData.from_cache && cacheData.practitioners.length > 0) {\n  return [{ json: { ...cacheData, from_cache: true }}];\n}\n\nif (response.error || response.statusCode >= 400) {\n  throw new Error('Cliniko API error fetching practitioners');\n}\n\nconst practitioners = response.practitioners || [];\nconst mappedPractitioners = practitioners\n  .filter(p => p.active)\n  .map(p => ({\n    cliniko_id: p.id,\n    name: p.label || p.display_name || p.first_name + ' ' + p.last_name,\n    active: p.active\n  }));\n\nreturn [{\n  json: {\n    ...cacheData,\n    practitioners: mappedPractitioners,\n    from_cache: false\n  }\n}];"},"id":"51113a8a-d79f-4918-9c28-de0f1ee24e20","name":"Process Cliniko Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[-80,384]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO practitioner_cache (cache_key, practitioner_data, cached_at)\nVALUES (\n  'all_practitioners',\n  '{{ JSON.stringify($json.practitioners) }}'::jsonb,\n  now()\n)\nON CONFLICT (cache_key) \nDO UPDATE SET\n  practitioner_data = EXCLUDED.practitioner_data,\n  cached_at = now()\nRETURNING *;","options":{"queryBatching":"single"}},"id":"691f263e-f342-4962-994e-c205a8ffdd42","name":"Cache Practitioners","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[160,384],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Get practitioners from Cache Practitioners node (PostgreSQL output)\nconst cacheResult = $items(\"Cache Practitioners\")[0].json;\nconst practitioners = cacheResult.practitioner_data || [];\n\n// Get context data from Process Cliniko Response node (has practitioner_id, duration, etc.)\nconst contextData = $items(\"Process Cliniko Response\")[0].json;\n\n// Look up practitioner name\nlet practitioner_name = 'Unknown Practitioner';\nconst practitioner = practitioners.find(p => \n  String(p.cliniko_id) === String(contextData.practitioner_id)\n);\nif (practitioner) {\n  practitioner_name = practitioner.name;\n}\n\n// Date handling\nlet startDate;\nif (contextData.preferred_date && typeof contextData.preferred_date === 'string') {\n  startDate = new Date(contextData.preferred_date + 'T00:00:00.000Z');\n  if (isNaN(startDate.getTime())) {\n    startDate = new Date();\n  }\n} else {\n  startDate = new Date();\n}\n\nconst dateRangeDays = parseInt(contextData.date_range_days) || 14;\nconst endDate = new Date(startDate.getTime());\nendDate.setUTCDate(endDate.getUTCDate() + dateRangeDays);\n\nlet startDateStr;\nlet endDateStr;\ntry {\n  startDateStr = startDate.toISOString().split('T')[0];\n  endDateStr = endDate.toISOString().split('T')[0];\n} catch (e) {\n  const now = new Date();\n  startDateStr = now.toISOString().split('T')[0];\n  const futureDate = new Date(now.getTime());\n  futureDate.setUTCDate(futureDate.getUTCDate() + 14);\n  endDateStr = futureDate.toISOString().split('T')[0];\n}\n\nreturn [{\n  json: {\n    ...contextData,\n    practitioners: practitioners,\n    practitioner_name: practitioner_name,\n    start_date: startDateStr,\n    end_date: endDateStr\n  }\n}];"},"id":"df3a1a48-a134-4261-9141-04aca751a2f0","name":"Prepare Availability Query","type":"n8n-nodes-base.code","typeVersion":2,"position":[368,384]},{"parameters":{"url":"https://api.au2.cliniko.com/v1/individual_appointments","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"practitioner_id","value":"={{ $json.practitioner_id }}"},{"name":"per_page","value":"100"},{"name":"sort","value":"starts_at"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Accept","value":"application/json"},{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"}]},"options":{"response":{"response":{"responseFormat":"json"}}}},"id":"dd458103-dced-4582-823d-f1cdd5f7213b","name":"Check Cliniko Availability","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[592,384],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"const availabilityResponse = $input.item.json;\nconst prepData = $items(\"Prepare Availability Query\")[0].json;\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\nif (availabilityResponse.error || availabilityResponse.statusCode >= 400) {\n  return [{\n    json: {\n      success: true,\n      slots_available: false,\n      total_slots: 0,\n      slots: [],\n      message: 'Unable to check availability',\n      original_appointment: {\n        appointment_id: requestData.appointment_id,\n        current_date: prepData.original_date || 'unknown',\n        current_time: prepData.original_time || 'unknown',\n        practitioner: prepData.practitioner_name || 'Unknown Practitioner',\n        duration_minutes: prepData.duration_minutes || 60\n      },\n      call_id: requestData.call_id,\n      duration_ms: Date.now() - requestData.start_time,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\nconst allAppointments = availabilityResponse.individual_appointments || [];\nconst startDate = new Date(prepData.start_date);\nconst endDate = new Date(prepData.end_date);\n\nconst existingAppointments = allAppointments.filter(appt => {\n  const apptDate = new Date(appt.starts_at);\n  return apptDate >= startDate && apptDate <= endDate;\n});\n\nconst workingHours = { start: 9, end: 17, workingDays: [1,2,3,4,5] };\nconst availableSlots = [];\n\nconst currentDate = new Date(startDate);\nwhile (currentDate <= endDate) {\n  if (!workingHours.workingDays.includes(currentDate.getDay())) {\n    currentDate.setDate(currentDate.getDate() + 1);\n    continue;\n  }\n  \n  const dateStr = currentDate.toISOString().split('T')[0];\n  const dayAppointments = existingAppointments\n    .filter(appt => new Date(appt.starts_at).toISOString().split('T')[0] === dateStr)\n    .map(appt => ({ start: new Date(appt.starts_at), end: new Date(appt.ends_at) }))\n    .sort((a, b) => a.start - b.start);\n  \n  for (let hour = workingHours.start; hour < workingHours.end; hour++) {\n    for (let minute = 0; minute < 60; minute += 15) {\n      const slotStart = new Date(dateStr + 'T00:00:00.000Z');\n      slotStart.setUTCHours(hour, minute, 0, 0);\n      const slotEnd = new Date(slotStart.getTime() + prepData.duration_minutes * 60000);\n      \n      if (slotEnd.getUTCHours() + (slotEnd.getUTCMinutes() / 60) > workingHours.end) continue;\n      \n      let hasConflict = false;\n      for (const appt of dayAppointments) {\n        if (slotStart < appt.end && slotEnd > appt.start) {\n          hasConflict = true;\n          break;\n        }\n      }\n      \n      if (prepData.original_datetime && !hasConflict) {\n        const origStart = new Date(prepData.original_datetime);\n        const origEnd = new Date(origStart.getTime() + prepData.duration_minutes * 60000);\n        if (slotStart < origEnd && slotEnd > origStart) hasConflict = true;\n      }\n      \n      if (!hasConflict) {\n        const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];\n        const displayTime = new Date(slotStart.getTime() + 11 * 60 * 60 * 1000);\n        const timeStr = displayTime.toLocaleTimeString('en-AU', { \n          hour: '2-digit', minute: '2-digit', hour12: true \n        });\n        \n        availableSlots.push({\n          datetime: slotStart.toISOString(),\n          date: dateStr,\n          time: timeStr,\n          day_of_week: dayNames[slotStart.getUTCDay()],\n          practitioner_id: prepData.practitioner_id || 'unknown',\n          practitioner_name: prepData.practitioner_name || 'Unknown Practitioner',\n          duration_minutes: prepData.duration_minutes || 60,\n          is_protected: false\n        });\n      }\n    }\n  }\n  \n  currentDate.setDate(currentDate.getDate() + 1);\n}\n\nconst topSlots = availableSlots.slice(0, 10);\n\nreturn [{\n  json: {\n    success: true,\n    slots_available: topSlots.length > 0,\n    total_slots: topSlots.length,\n    slots: topSlots,\n    message: topSlots.length > 0 \n      ? 'Found ' + topSlots.length + ' available slots'\n      : 'No availability found',\n    original_appointment: {\n      appointment_id: requestData.appointment_id,\n      current_date: prepData.original_date || 'unknown',\n      current_time: prepData.original_time || 'unknown',\n      practitioner: prepData.practitioner_name || 'Unknown Practitioner',\n      duration_minutes: prepData.duration_minutes || 60\n    },\n    call_id: requestData.call_id,\n    duration_ms: Date.now() - requestData.start_time,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"79244909-e7b2-4593-a332-e94dceacd849","name":"Build Final Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[816,384]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"1892eeaa-603c-407d-bfed-1c288f2c350b","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1040,384]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO webhook_log (\n  webhook_name, call_id, request_body, response_body,\n  success, duration_ms, cache_hit, created_at\n)\nVALUES (\n  'get-reschedule-availability',\n  '{{ $items(\"Extract Request Data\")[0].json.call_id }}',\n  '{{ JSON.stringify($items(\"Extract Request Data\")[0].json) }}'::jsonb,\n  '{{ JSON.stringify($items(\"Build Final Response\")[0].json) }}'::jsonb,\n  true,\n  {{ $items(\"Build Final Response\")[0].json.duration_ms || 0 }},\n  {{ $items(\"Handle Cache\")[0]?.json?.from_cache || false }},\n  now()\n)\nRETURNING *;","options":{"queryBatching":"single"}},"id":"57d5db70-fb4a-4d79-9eee-2e60e81752d8","name":"Log Webhook Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1248,384],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Get Current Appointment","type":"main","index":0}]]},"Get Current Appointment":{"main":[[{"node":"Process Current Appointment","type":"main","index":0}]]},"Process Current Appointment":{"main":[[{"node":"Check Practitioner Cache","type":"main","index":0}]]},"Check Practitioner Cache":{"main":[[{"node":"Handle Cache","type":"main","index":0}]]},"Handle Cache":{"main":[[{"node":"Fetch Practitioners from Cliniko","type":"main","index":0}]]},"Fetch Practitioners from Cliniko":{"main":[[{"node":"Process Cliniko Response","type":"main","index":0}]]},"Process Cliniko Response":{"main":[[{"node":"Cache Practitioners","type":"main","index":0}]]},"Cache Practitioners":{"main":[[{"node":"Prepare Availability Query","type":"main","index":0}]]},"Prepare Availability Query":{"main":[[{"node":"Check Cliniko Availability","type":"main","index":0}]]},"Check Cliniko Availability":{"main":[[{"node":"Build Final Response","type":"main","index":0}]]},"Build Final Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Webhook Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"b20e1ac2-42a4-4c2f-aeb5-d630c552491b","triggerCount":1,"shared":[{"updatedAt":"2025-11-08T22:47:26.117Z","createdAt":"2025-11-08T22:47:26.117Z","role":"workflow:owner","workflowId":"GN1l398EzlOmvmBI","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-25T08:34:30.391Z","createdAt":"2025-11-09T06:31:08.429Z","id":"Cd4Je3tY7OAlV9Yi","name":"RetellAI - Check Holiday","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/check-holiday","responseMode":"responseNode","options":{}},"id":"15f8c56a-f65c-4ca4-af18-b293b6ab0fee","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"check-holiday"},{"parameters":{"jsCode":"\n// Universal Phone Normalization (Australian E.164) - v9.09\n\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n\n  // 1. Strip everything except digits and '+'\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n\n  // 2. Already in E.164 format\n  if (phone.startsWith('+')) {\n    return phone;\n  }\n\n  // 3. Handle 8-digit local numbers (Assume NSW '02')\n  if (phone.length === 8 && !phone.startsWith('+')) {\n    return '+612' + phone;\n  }\n\n  // 4. Handle standard 10-digit AU numbers (04... or 02...)\n  if (phone.length === 10 && phone.startsWith('0')) {\n    return '+61' + phone.substring(1);\n  }\n\n  // 5. Handle numbers starting with 61 (missing +)\n  if (phone.length === 11 && phone.startsWith('61')) {\n    return '+' + phone;\n  }\n\n  // 6. Assume Australian if 9 digits (missing leading 0)\n  if (phone.length === 9) {\n    return '+61' + phone;\n  }\n\n  // 7. Return cleaned version (best effort)\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n\n// Extract and validate request parameters\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\n// Extract required parameters\nconst date = args.date || '';\nconst call_id = call.call_id || args.call_id || '';\n\n// Validate required fields\nif (!date) {\n  throw new Error('date is required');\n}\n\n// Validate date format (YYYY-MM-DD)\nconst dateRegex = /^\\d{4}-\\d{2}-\\d{2}$/;\nif (!dateRegex.test(date)) {\n  throw new Error('date must be in YYYY-MM-DD format');\n}\n\n// Validate date is valid\nconst dateObj = new Date(date + 'T00:00:00Z');\nif (isNaN(dateObj.getTime())) {\n  throw new Error('Invalid date provided');\n}\n\nconst startTime = Date.now();\n\nreturn [{\n  json: {\n    date,\n    call_id,\n    start_time: startTime,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"be8d8f02-21db-4caf-8a0e-949d4d2ada3b","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"operation":"executeQuery","query":"-- Check if date is a public holiday in cache (7 day TTL)\nSELECT \n  date,\n  holiday_name,\n  applies_to,\n  notes,\n  EXTRACT(EPOCH FROM (now() - cached_at))/3600 as hours_old\nFROM public_holidays_cache\nWHERE date = '{{ $json.date }}'\n  AND cached_at > now() - interval '7 days'\nLIMIT 1;","options":{"queryBatching":"independently"}},"id":"10e7d7f8-9138-42ad-bbdd-feb477870906","name":"Check Holiday Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[448,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Process holiday lookup result\nconst items = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// If we found a holiday in cache, return it\nif (items.length > 0 && items[0].json.date) {\n  const holiday = items[0].json;\n  return [{\n    json: {\n      success: true,\n      is_holiday: true,\n      holiday_name: holiday.holiday_name,\n      applies_to: holiday.applies_to || 'NSW',\n      notes: holiday.notes || '',\n      message: `${requestData.date} is ${holiday.holiday_name}`,\n      date: requestData.date,\n      call_id: requestData.call_id,\n      from_cache: true,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// Not a holiday\nreturn [{\n  json: {\n    success: true,\n    is_holiday: false,\n    holiday_name: null,\n    message: `${requestData.date} is not a public holiday`,\n    date: requestData.date,\n    call_id: requestData.call_id,\n    from_cache: true,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"17a90f87-fdb7-4f50-aaf6-a1d97919a11b","name":"Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"8135e370-5217-4149-af6d-9f0b224f3a0c","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[880,0]},{"parameters":{"operation":"executeQuery","query":"-- Log webhook execution (happens after response sent)\nINSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_body,\n  response_body,\n  success,\n  duration_ms,\n  cache_hit,\n  created_at\n)\nVALUES (\n  'check-holiday',\n  '{{ $items(\"Extract Request Data\")[0].json.call_id }}',\n  '{{ JSON.stringify($items(\"Extract Request Data\")[0].json) }}'::jsonb,\n  '{{ JSON.stringify($items(\"Format Response\")[0].json) }}'::jsonb,\n  true,\n  {{ Math.round((Date.now() - $items(\"Extract Request Data\")[0].json.start_time)) }},\n  {{ $items(\"Format Response\")[0]?.json?.from_cache || false }},\n  now()\n) RETURNING *;","options":{}},"id":"837ef5ac-0b48-4db2-8a7c-db97b6a32379","name":"Log Webhook Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1104,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Check Holiday Cache","type":"main","index":0}]]},"Check Holiday Cache":{"main":[[{"node":"Format Response","type":"main","index":0}]]},"Format Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Webhook Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"3f305d55-6363-4fbe-a598-3038fcfb742f","triggerCount":1,"shared":[{"updatedAt":"2025-11-09T06:31:08.429Z","createdAt":"2025-11-09T06:31:08.429Z","role":"workflow:owner","workflowId":"Cd4Je3tY7OAlV9Yi","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-09T17:47:23.150Z","createdAt":"2025-11-09T08:07:34.978Z","id":"c6biTvEVZCsi9yml","name":"RetellAI - Get Class Capacity Rules v1.3 FIXED","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-class-capacity-rules","responseMode":"responseNode","options":{}},"id":"7942bfc5-91e6-45f2-9209-2348c0549e0b","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-736,256],"webhookId":"get-class-capacity-rules"},{"parameters":{"jsCode":"// Extract and validate request parameters\nconst webhookData = $input.item.json.body || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\n// Sanitize input to prevent SQL injection\nfunction sanitize(str) {\n  if (!str) return '';\n  return String(str)\n    .trim()\n    .replace(/'/g, \"''\")  // Escape single quotes\n    .replace(/;/g, '')    // Remove semicolons\n    .replace(/--/g, '')   // Remove SQL comments\n    .slice(0, 200);       // Limit length\n}\n\n// Extract required parameters\nconst class_type = sanitize(args.class_type || args.class_name || '');\nconst village = sanitize(args.village || '');\nconst call_id = sanitize(call.call_id || args.call_id || '');\n\n// Validate required fields\nif (!class_type) {\n  throw new Error('class_type is required');\n}\nif (!village) {\n  throw new Error('village is required');\n}\n\nconst startTime = Date.now();\nconst cacheKey = `${class_type}|${village}`.toLowerCase();\n\nreturn [{\n  json: {\n    class_type,\n    village,\n    call_id,\n    cache_key: cacheKey,\n    start_time: startTime,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"6e3ea31a-a7dc-4db5-9674-97d76841e456","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-512,256]},{"parameters":{"operation":"executeQuery","query":"-- Check class capacity rules cache (24 hour TTL)\nSELECT \n  class_type,\n  village,\n  capacity_rule,\n  max_capacity,\n  free_trial,\n  handling_instruction,\n  notes,\n  EXTRACT(EPOCH FROM (now() - cached_at))/3600 as hours_old\nFROM class_capacity_rules_cache\nWHERE cache_key = '{{ $json.cache_key }}'\n  AND cached_at > now() - interval '24 hours'\nLIMIT 1;","options":{"queryBatching":"independently"}},"id":"f9afb2f6-d789-4dbf-8ee2-4eda4d3417b7","name":"Check Capacity Rules Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-288,256],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Handle cache hit vs miss\nconst items = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// Check if we have cached data\nif (items.length > 0 && items[0].json.class_type) {\n  // CACHE HIT - Return complete response immediately\n  console.log(`‚úÖ CACHE HIT for ${requestData.cache_key}`);\n  const cached = items[0].json;\n  \n  const response = {\n    success: true,\n    capacity_rule: cached.capacity_rule,\n    max_capacity: cached.max_capacity,\n    free_trial: cached.free_trial || false,\n    handling_instruction: cached.handling_instruction || '',\n    class_type: requestData.class_type,\n    village: requestData.village,\n    call_id: requestData.call_id,\n    timestamp: new Date().toISOString(),\n    from_cache: true,\n    cache_age_hours: Math.round(cached.hours_old * 10) / 10\n  };\n  \n  // Add notes if present\n  if (cached.notes) {\n    response.notes = cached.notes;\n  }\n  \n  return [{ json: response }];\n}\n\n// CACHE MISS - Continue to Google Sheets\nconsole.log(`‚ùå CACHE MISS for ${requestData.cache_key}`);\nreturn [{\n  json: {\n    ...requestData,\n    from_cache: false,\n    needs_google_sheets: true\n  }\n}];"},"id":"b56d160b-0ddf-4775-a898-f64fb2fb73e1","name":"Handle Cache Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,256]},{"parameters":{"operation":"appendOrUpdate","documentId":{"__rl":true,"value":"1OopAYnlAnsCCSQvVc5mh-cN55KnThulZkciA8eIGMnA","mode":"id"},"sheetName":{"__rl":true,"value":"Sheet1","mode":"name"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":[],"schema":[{"id":"class_type","displayName":"class_type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"capacity_rule","displayName":"capacity_rule","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"free_trial","displayName":"free_trial","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"threshold","displayName":"threshold","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"handling","displayName":"handling","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"notes","displayName":"notes","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{"useAppend":false}},"id":"19673306-47d4-437f-bda3-f087622c49ac","name":"Read from Google Sheets","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[144,256],"notesInFlow":true,"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}},"notes":"SETUP REQUIRED: Replace credential ID with your Google OAuth2 credential"},{"parameters":{"jsCode":"// Process Google Sheets response\nconst items = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// If already has success flag (from cache), pass through\nif (items.length > 0 && items[0].json.success === true) {\n  return items;\n}\n\n// Parse Google Sheets response\nlet matchedRule = null;\n\n// Google Sheets returns data in various formats depending on operation\nif (items.length > 0 && items[0].json) {\n  const sheetData = items[0].json;\n  \n  // Check if this row matches our search criteria\n  const class_type_match = (sheetData.class_type || '').toLowerCase();\n  const village_match = (sheetData.village || '').toLowerCase();\n  const search_class = requestData.class_type.toLowerCase();\n  const search_village = requestData.village.toLowerCase();\n  \n  // Exact match or fuzzy match\n  if (class_type_match.includes(search_class) || search_class.includes(class_type_match)) {\n    if (village_match.includes(search_village) || search_village.includes(village_match)) {\n      matchedRule = {\n        capacity_rule: sheetData.capacity_rule || 'ops_approval_required',\n        max_capacity: parseInt(sheetData.max_capacity) || 10,\n        free_trial: sheetData.free_trial === 'TRUE' || sheetData.free_trial === true,\n        handling_instruction: sheetData.handling_instruction || '',\n        notes: sheetData.notes || ''\n      };\n    }\n  }\n}\n\n// If no match found in Google Sheets, use safe default\nif (!matchedRule) {\n  console.log(`‚ö†Ô∏è No match found in Google Sheets for: ${requestData.class_type} at ${requestData.village}`);\n  matchedRule = {\n    capacity_rule: 'ops_approval_required',\n    max_capacity: 10,\n    free_trial: false,\n    handling_instruction: 'Class not found in configuration. Please escalate to operations for capacity check.',\n    notes: 'Unknown class type - requires manual verification'\n  };\n}\n\nreturn [{\n  json: {\n    ...requestData,\n    ...matchedRule,\n    from_google_sheets: true,\n    needs_cache_write: true\n  }\n}];"},"id":"c9eb053d-0bd3-4bdc-ac93-721b85f4cf47","name":"Process Sheets Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[368,256]},{"parameters":{"operation":"executeQuery","query":"-- Cache class capacity rules for 24 hours\n-- FIX v1.3: Construct cache_key from class_type and village (don't rely on undefined cache_key)\nINSERT INTO class_capacity_rules_cache (\n  cache_key,\n  class_type,\n  village,\n  capacity_rule,\n  max_capacity,\n  free_trial,\n  handling_instruction,\n  notes,\n  cached_at\n)\nVALUES (\n  LOWER('{{ $json.class_type }}' || '|' || '{{ $json.village }}'),\n  '{{ $json.class_type }}',\n  '{{ $json.village }}',\n  '{{ $json.capacity_rule }}',\n  {{ $json.max_capacity }},\n  {{ $json.free_trial }},\n  '{{ $json.handling_instruction }}',\n  '{{ $json.notes }}',\n  now()\n)\nON CONFLICT (cache_key) \nDO UPDATE SET\n  capacity_rule = EXCLUDED.capacity_rule,\n  max_capacity = EXCLUDED.max_capacity,\n  free_trial = EXCLUDED.free_trial,\n  handling_instruction = EXCLUDED.handling_instruction,\n  notes = EXCLUDED.notes,\n  cached_at = now()\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"18e4fef6-59d3-46eb-850f-26d99f58c01c","name":"Write to Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[592,256],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Format final response\nconst items = $input.all();\nconst item = items[0].json;\n\n// If already has success flag (from cache hit), pass through\nif (item.success === true) {\n  return items;\n}\n\n// Otherwise, format the response from Google Sheets + cache write\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\nconst response = {\n  success: true,\n  capacity_rule: item.capacity_rule,\n  max_capacity: item.max_capacity,\n  free_trial: item.free_trial || false,\n  handling_instruction: item.handling_instruction || '',\n  class_type: requestData.class_type,\n  village: requestData.village,\n  call_id: requestData.call_id,\n  timestamp: new Date().toISOString(),\n  from_cache: false\n};\n\n// Add notes if present\nif (item.notes) {\n  response.notes = item.notes;\n}\n\nconsole.log(`‚úÖ Response ready: ${response.capacity_rule} (max: ${response.max_capacity})`);\nreturn [{ json: response }];"},"id":"60dde09c-e393-4712-be8d-c9ed6b3656b2","name":"Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[816,256]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"c9daba99-ac15-4152-b846-13c61f680370","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1024,256]},{"parameters":{"operation":"executeQuery","query":"-- Log webhook execution (happens after response sent)\nINSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_body,\n  response_body,\n  success,\n  duration_ms,\n  cache_hit,\n  created_at\n)\nVALUES (\n  'get-class-capacity-rules',\n  '{{ $items(\"Extract Request Data\")[0].json.call_id }}',\n  '{{ JSON.stringify($items(\"Extract Request Data\")[0].json) }}'::jsonb,\n  '{{ JSON.stringify($items(\"Format Response\")[0].json) }}'::jsonb,\n  true,\n  {{ Math.round((Date.now() - $items(\"Extract Request Data\")[0].json.start_time)) }},\n  {{ $items(\"Handle Cache Result\")[0]?.json?.from_cache || false }},\n  now()\n) RETURNING *;","options":{}},"id":"da500602-58e5-4b45-b0c9-46ba3f940dd8","name":"Log Webhook Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1248,256],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Check Capacity Rules Cache","type":"main","index":0}]]},"Check Capacity Rules Cache":{"main":[[{"node":"Handle Cache Result","type":"main","index":0}]]},"Handle Cache Result":{"main":[[{"node":"Read from Google Sheets","type":"main","index":0}]]},"Read from Google Sheets":{"main":[[{"node":"Process Sheets Response","type":"main","index":0}]]},"Process Sheets Response":{"main":[[{"node":"Write to Cache","type":"main","index":0}]]},"Write to Cache":{"main":[[{"node":"Format Response","type":"main","index":0}]]},"Format Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Webhook Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"8729647d-164a-4e84-9368-d8598951d0e1","triggerCount":1,"shared":[{"updatedAt":"2025-11-09T08:07:34.978Z","createdAt":"2025-11-09T08:07:34.978Z","role":"workflow:owner","workflowId":"c6biTvEVZCsi9yml","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-25T08:35:40.121Z","createdAt":"2025-11-09T17:47:37.331Z","id":"Qruo4TvFkfvBhdkH","name":"RetellAI - Get Class Capacity Rules v1.8 IF NODE","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-class-capacity-rules","responseMode":"responseNode","options":{}},"id":"db82769a-c573-41c9-b6b8-92c5c3cb9e38","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-1616,272],"webhookId":"get-class-capacity-rules"},{"parameters":{"jsCode":"\n// Universal Phone Normalization (Australian E.164) - v9.09\n\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n\n  // 1. Strip everything except digits and '+'\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n\n  // 2. Already in E.164 format\n  if (phone.startsWith('+')) {\n    return phone;\n  }\n\n  // 3. Handle 8-digit local numbers (Assume NSW '02')\n  if (phone.length === 8 && !phone.startsWith('+')) {\n    return '+612' + phone;\n  }\n\n  // 4. Handle standard 10-digit AU numbers (04... or 02...)\n  if (phone.length === 10 && phone.startsWith('0')) {\n    return '+61' + phone.substring(1);\n  }\n\n  // 5. Handle numbers starting with 61 (missing +)\n  if (phone.length === 11 && phone.startsWith('61')) {\n    return '+' + phone;\n  }\n\n  // 6. Assume Australian if 9 digits (missing leading 0)\n  if (phone.length === 9) {\n    return '+61' + phone;\n  }\n\n  // 7. Return cleaned version (best effort)\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\nfunction sanitize(str) {\n  if (!str) return '';\n  return String(str).trim().replace(/'/g, \"''\").replace(/;/g, '').replace(/--/g, '').slice(0, 200);\n}\n\nconst class_type = sanitize(args.class_type || args.class_name || '');\nconst village = sanitize(args.village || '');\nconst call_id = sanitize(call.call_id || args.call_id || '');\n\nif (!class_type) throw new Error('class_type is required');\nif (!village) throw new Error('village is required');\n\nconst cacheKey = `${class_type}|${village}`.toLowerCase();\n\nreturn [{\n  json: {\n    class_type,\n    village,\n    call_id,\n    cache_key: cacheKey,\n    start_time: Date.now(),\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"d135f6d3-9f3c-41fb-a695-776693e3632c","name":"Extract Request","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1392,272]},{"parameters":{"operation":"executeQuery","query":"SELECT class_type, village, capacity_rule, max_capacity, free_trial, handling_instruction, notes, EXTRACT(EPOCH FROM (now() - cached_at))/3600 as hours_old FROM class_capacity_rules_cache WHERE cache_key = '{{ $json.cache_key }}' AND cached_at > now() - interval '24 hours' LIMIT 1;","options":{}},"id":"1ab56aef-6c4b-4690-b0dd-1faf0e02081d","name":"Check Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-1168,272],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.class_type }}","operation":"isNotEmpty"}]}},"id":"e0c8b9e3-f203-4d60-b2a2-28aa62866a4c","name":"Cache Hit?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-960,272]},{"parameters":{"jsCode":"// Format CACHE HIT response\nconst cacheItems = $input.all();\nconst requestData = $items(\"Extract Request\")[0].json;\nconst cached = cacheItems[0].json;\n\nconsole.log(`‚úÖ CACHE HIT for ${requestData.cache_key}`);\n\nconst response = {\n  success: true,\n  capacity_rule: cached.capacity_rule,\n  max_capacity: cached.max_capacity,\n  free_trial: cached.free_trial || false,\n  handling_instruction: cached.handling_instruction || '',\n  class_type: requestData.class_type,\n  village: requestData.village,\n  call_id: requestData.call_id,\n  timestamp: new Date().toISOString(),\n  from_cache: true,\n  cache_age_hours: Math.round(cached.hours_old * 10) / 10,\n  notes: cached.notes || ''\n};\n\nreturn [{ json: response }];"},"id":"6e1e30dd-599d-479d-b379-0326572027f6","name":"Format Cache Hit","type":"n8n-nodes-base.code","typeVersion":2,"position":[-736,144]},{"parameters":{"documentId":{"__rl":true,"value":"1OopAYnlAnsCCSQvVc5mh-cN55KnThulZkciA8eIGMnA","mode":"id"},"sheetName":{"__rl":true,"value":"Sheet1","mode":"name"},"options":{}},"id":"aab2df52-a309-4e33-930e-21d8e0f7ec9d","name":"Read Sheets","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[-736,384],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"jsCode":"// Process Google Sheets (READ-ONLY)\nconst items = $input.all();\nconst requestData = $items(\"Extract Request\")[0].json;\n\nconsole.log(`‚ùå CACHE MISS for ${requestData.cache_key}`);\n\nlet matchedRule = null;\n\nif (items.length > 0) {\n  for (const item of items) {\n    const sheetData = item.json;\n    const class_type_match = (sheetData.class_type || '').toLowerCase();\n    const village_match = (sheetData.village || '').toLowerCase();\n    const search_class = requestData.class_type.toLowerCase();\n    const search_village = requestData.village.toLowerCase();\n    \n    if (class_type_match.includes(search_class) || search_class.includes(class_type_match)) {\n      if (village_match.includes(search_village) || search_village.includes(village_match)) {\n        matchedRule = {\n          capacity_rule: sheetData.capacity_rule || 'ops_approval_required',\n          max_capacity: parseInt(sheetData.max_capacity) || 10,\n          free_trial: sheetData.free_trial === 'TRUE' || sheetData.free_trial === true || sheetData.free_trial === 'true',\n          handling_instruction: sheetData.handling_instruction || '',\n          notes: sheetData.notes || ''\n        };\n        break;\n      }\n    }\n  }\n}\n\nif (!matchedRule) {\n  console.log(`‚ö†Ô∏è No match for: ${requestData.class_type} at ${requestData.village}`);\n  matchedRule = {\n    capacity_rule: 'ops_approval_required',\n    max_capacity: 10,\n    free_trial: false,\n    handling_instruction: 'Class not found. Escalate.',\n    notes: 'Unknown class'\n  };\n}\n\nreturn [{ json: { ...requestData, ...matchedRule } }];"},"id":"6b13d5cc-a1be-41e8-bd8a-5236c2e2d656","name":"Process Sheets","type":"n8n-nodes-base.code","typeVersion":2,"position":[-512,384]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO class_capacity_rules_cache (cache_key, class_type, village, capacity_rule, max_capacity, free_trial, handling_instruction, notes, cached_at) VALUES (LOWER('{{ $json.class_type }}' || '|' || '{{ $json.village }}'), '{{ $json.class_type }}', '{{ $json.village }}', '{{ $json.capacity_rule }}', {{ $json.max_capacity }}, {{ $json.free_trial }}, '{{ $json.handling_instruction }}', '{{ $json.notes }}', now()) ON CONFLICT (cache_key) DO UPDATE SET capacity_rule = EXCLUDED.capacity_rule, max_capacity = EXCLUDED.max_capacity, free_trial = EXCLUDED.free_trial, handling_instruction = EXCLUDED.handling_instruction, notes = EXCLUDED.notes, cached_at = now() RETURNING *;","options":{}},"id":"5fc5aff9-c261-4aed-81f3-c163aab1731a","name":"Write Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-288,384],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Format CACHE MISS response\nconst item = $input.item.json;\nconst requestData = $items(\"Extract Request\")[0].json;\n\nconst response = {\n  success: true,\n  capacity_rule: item.capacity_rule,\n  max_capacity: item.max_capacity,\n  free_trial: item.free_trial || false,\n  handling_instruction: item.handling_instruction || '',\n  class_type: requestData.class_type,\n  village: requestData.village,\n  call_id: requestData.call_id,\n  timestamp: new Date().toISOString(),\n  from_cache: false\n};\n\nif (item.notes) response.notes = item.notes;\n\nreturn [{ json: response }];"},"id":"892b8c4b-ce07-469d-a224-385669c18dc2","name":"Format Cache Miss","type":"n8n-nodes-base.code","typeVersion":2,"position":[-80,384]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"908070c4-a130-4461-a6a0-75ddb3502171","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[160,272]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_log (webhook_name, call_id, request_body, response_body, success, duration_ms, cache_hit, created_at) VALUES ('get-class-capacity-rules', '{{ $items(\"Extract Request\")[0].json.call_id }}', '{{ JSON.stringify($items(\"Extract Request\")[0].json) }}'::jsonb, '{{ JSON.stringify($json) }}'::jsonb, true, {{ Math.round((Date.now() - $items(\"Extract Request\")[0].json.start_time)) }}, {{ $json.from_cache || false }}, now()) RETURNING *;","options":{}},"id":"698b300d-0853-46ce-a3b1-4df72608f656","name":"Log","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[368,272],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request","type":"main","index":0}]]},"Extract Request":{"main":[[{"node":"Check Cache","type":"main","index":0}]]},"Check Cache":{"main":[[{"node":"Cache Hit?","type":"main","index":0}]]},"Cache Hit?":{"main":[[{"node":"Format Cache Hit","type":"main","index":0}],[{"node":"Read Sheets","type":"main","index":0}]]},"Format Cache Hit":{"main":[[{"node":"Respond","type":"main","index":0}]]},"Read Sheets":{"main":[[{"node":"Process Sheets","type":"main","index":0}]]},"Process Sheets":{"main":[[{"node":"Write Cache","type":"main","index":0}]]},"Write Cache":{"main":[[{"node":"Format Cache Miss","type":"main","index":0}]]},"Format Cache Miss":{"main":[[{"node":"Respond","type":"main","index":0}]]},"Respond":{"main":[[{"node":"Log","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"c5e61926-75e2-428b-a2bf-6ed4b8a6da44","triggerCount":1,"shared":[{"updatedAt":"2025-11-09T17:47:37.331Z","createdAt":"2025-11-09T17:47:37.331Z","role":"workflow:owner","workflowId":"Qruo4TvFkfvBhdkH","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-02T21:00:33.046Z","createdAt":"2025-11-09T20:54:01.700Z","id":"9AiRdBWE8EVoXM1C","name":"RetellAI - Get Class Schedule v1.1 SPOKEN_TEXT","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-class-schedule","responseMode":"responseNode","options":{}},"id":"34244632-f447-40d0-95d3-04c8a3ac518b","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-240,128],"webhookId":"get-class-schedule"},{"parameters":{"jsCode":"// STANDARD EXTRACTION PATTERN - RetellAI Compatible\nconst webhookData = $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\nconst class_type = args.class_type || '';\nconst village = args.village || '';\nconst weeks_ahead = args.weeks_ahead || 4;\nconst call_id = call.call_id || args.call_id || 'unknown';\n\nif (!class_type || !village) {\n  return [{\n    json: {\n      success: false,\n      error: 'Missing required parameters: class_type and village',\n      spoken_text: 'I need to know the class type and village to check the schedule. Which class are you interested in?',\n      class_type: class_type || 'not provided',\n      village: village || 'not provided',\n      call_id,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    class_type: class_type.trim(),\n    village: village.trim(),\n    weeks_ahead,\n    call_id,\n    request_timestamp: new Date().toISOString(),\n    start_time: Date.now()\n  }\n}];"},"id":"b6a5cefa-7883-4207-8d39-6cb9c74e277e","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[208,0]},{"parameters":{"operation":"executeQuery","query":"SELECT \n    appointment_type_name,\n    starts_at,\n    ends_at,\n    duration_minutes,\n    max_attendees,\n    attendee_count,\n    spaces_available,\n    village,\n    business_name,\n    is_cancelled,\n    last_synced,\n    class_type\nFROM group_appointments_with_details\nWHERE class_type ILIKE '%{{ $json.class_type }}%'\n  AND (village ILIKE '%{{ $json.village }}%' OR village = 'Unknown')\n  AND starts_at >= NOW()\n  AND starts_at <= NOW() + INTERVAL '{{ $json.weeks_ahead }} weeks'\n  AND is_cancelled = false\n  AND is_deleted = false\nORDER BY starts_at ASC\nLIMIT 10;","options":{}},"id":"fc3d6d2b-6ad6-4e5d-8a27-96d03e883ef5","name":"Query Group Appointments","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[400,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"operation":"executeQuery","query":"-- Find alternative villages that DO have this class type\nSELECT DISTINCT village \nFROM group_appointments_with_details\nWHERE class_type ILIKE '%{{ $('Extract Request Data').first().json.class_type }}%'\n  AND starts_at >= NOW()\n  AND starts_at <= NOW() + INTERVAL '4 weeks'\n  AND is_cancelled = false\n  AND is_deleted = false\n  AND village != '{{ $('Extract Request Data').first().json.village }}'\nORDER BY village ASC\nLIMIT 5;","options":{}},"id":"alt-villages-query","name":"Query Alternative Villages","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[400,200],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Format response with SPOKEN_TEXT - v1.1\n// FIX: Always return spoken_text for the agent to read verbatim\n\nconst items = $input.all();\nconst requestData = $('Extract Request Data').first().json;\nconst altVillagesData = $('Query Alternative Villages').all();\n\n// Calculate duration regardless of success/failure\nconst duration_ms = Date.now() - requestData.start_time;\n\n// Extract alternative villages\nconst alternative_villages = altVillagesData\n  .filter(item => item.json && item.json.village)\n  .map(item => item.json.village);\n\n// Helper functions\nfunction formatDate(dateStr) {\n  const date = new Date(dateStr);\n  const day = date.getDate();\n  const month = date.toLocaleDateString('en-AU', { month: 'long' });\n  return `${day}${getOrdinalSuffix(day)} of ${month}`;\n}\n\nfunction getOrdinalSuffix(day) {\n  if (day > 3 && day < 21) return 'th';\n  switch (day % 10) {\n    case 1: return 'st';\n    case 2: return 'nd';\n    case 3: return 'rd';\n    default: return 'th';\n  }\n}\n\nfunction formatTime(dateStr) {\n  const date = new Date(dateStr);\n  return date.toLocaleTimeString('en-AU', { \n    hour: 'numeric', \n    minute: '2-digit',\n    hour12: true \n  });\n}\n\nfunction getDayName(dateStr) {\n  const date = new Date(dateStr);\n  return date.toLocaleDateString('en-AU', { weekday: 'long' });\n}\n\n// NO RESULTS - Generate spoken_text with alternatives\nif (items.length === 0 || !items[0].json.starts_at) {\n  let spoken_text = `I'm sorry, there are no ${requestData.class_type} classes currently scheduled at ${requestData.village}.`;\n  \n  if (alternative_villages.length > 0) {\n    spoken_text += ` However, ${requestData.class_type} classes are available at ${alternative_villages.join(', ')}. Would you like me to check one of those villages instead?`;\n  } else {\n    spoken_text += ` Would you like me to check a different class type, or would you prefer I organise a callback from Sara to discuss options?`;\n  }\n  \n  return [{\n    json: {\n      success: false,\n      message: spoken_text,\n      spoken_text: spoken_text,\n      class_type: requestData.class_type,\n      village: requestData.village,\n      alternative_villages: alternative_villages,\n      call_id: requestData.call_id,\n      timestamp: new Date().toISOString(),\n      duration_ms: duration_ms,\n      from_cache: false\n    }\n  }];\n}\n\n// SUCCESS - Format class details with spoken_text\nconst sessions = items.map(item => item.json);\nconst nextSession = sessions[0];\n\nconst dayName = getDayName(nextSession.starts_at);\nconst dateFormatted = formatDate(nextSession.starts_at);\nconst timeFormatted = formatTime(nextSession.starts_at);\nconst spacesText = nextSession.spaces_available === 1 ? '1 spot' : `${nextSession.spaces_available} spots`;\n\nlet spoken_text = `The next ${requestData.class_type} class at ${requestData.village} is on ${dayName}, the ${dateFormatted} at ${timeFormatted}. There are ${spacesText} available.`;\n\n// Add recurring pattern info if detected\nif (sessions.length >= 2) {\n  const days = sessions.map(s => new Date(s.starts_at).getDay());\n  const times = sessions.map(s => formatTime(s.starts_at));\n  if (days.every(d => d === days[0]) && times.every(t => t === times[0])) {\n    spoken_text += ` This class runs every ${dayName} at ${timeFormatted}.`;\n  }\n}\n\nspoken_text += ` Would you like me to book a spot for you?`;\n\n// Calculate cache age\nconst lastSynced = new Date(nextSession.last_synced);\nconst now = new Date();\nconst cacheAgeHours = Math.floor((now - lastSynced) / (1000 * 60 * 60));\n\nreturn [{\n  json: {\n    success: true,\n    spoken_text: spoken_text,\n    message: spoken_text,\n    class_type: requestData.class_type,\n    village: requestData.village,\n    next_session: {\n      date: nextSession.starts_at.split('T')[0],\n      day_name: dayName,\n      time: timeFormatted,\n      duration_minutes: nextSession.duration_minutes,\n      spaces_available: nextSession.spaces_available,\n      max_capacity: nextSession.max_attendees,\n      location: nextSession.business_name\n    },\n    upcoming_sessions: sessions.slice(0, 4).map(s => ({\n      date: s.starts_at.split('T')[0],\n      day_name: getDayName(s.starts_at),\n      time: formatTime(s.starts_at),\n      spaces: s.spaces_available,\n      max: s.max_attendees\n    })),\n    total_sessions_found: sessions.length,\n    call_id: requestData.call_id,\n    timestamp: new Date().toISOString(),\n    from_cache: true,\n    cache_age_hours: cacheAgeHours,\n    duration_ms: duration_ms\n  }\n}];"},"id":"fc275bd2-cffe-4690-948b-e5da55ba6f00","name":"Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[608,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"f0b582d5-eafc-481f-8dd3-0ccb75ca56f1","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[800,0]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_log (\n    webhook_name,\n    call_id,\n    request_body,\n    response_body,\n    duration_ms,\n    cache_hit,\n    success,\n    created_at\n) VALUES (\n    'get-class-schedule',\n    '{{ $json.call_id }}',\n    '{{ JSON.stringify($items(\"Extract Request Data\")[0].json) }}'::jsonb,\n    '{{ JSON.stringify($json) }}'::jsonb,\n    {{ $json.duration_ms }},\n    {{ $json.from_cache }},\n    {{ $json.success }},\n    NOW()\n) RETURNING id;","options":{}},"id":"3580d599-8098-415b-9702-8ba3d0a369a1","name":"Log Webhook Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1008,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-224,-80],"id":"d9e5cee4-a3b0-46c7-bb0a-68430967b154","name":"When clicking 'Execute workflow'"}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Query Group Appointments","type":"main","index":0},{"node":"Query Alternative Villages","type":"main","index":0}]]},"Query Group Appointments":{"main":[[{"node":"Format Response","type":"main","index":0}]]},"Query Alternative Villages":{"main":[[{"node":"Format Response","type":"main","index":0}]]},"Format Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Webhook Execution","type":"main","index":0}]]},"When clicking 'Execute workflow'":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"8536ae38-ecac-4544-9fd2-068aee6fd07b","triggerCount":1,"shared":[{"updatedAt":"2025-11-09T20:54:01.700Z","createdAt":"2025-11-09T20:54:01.700Z","role":"workflow:owner","workflowId":"9AiRdBWE8EVoXM1C","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-24T05:10:41.049Z","createdAt":"2025-11-10T21:26:30.667Z","id":"5cR929ZqO1IMTROA","name":"RetellAI - Create Appointment v2.5 PETER EMAIL FIXED","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/create-appointment","responseMode":"responseNode","options":{}},"id":"9f480fff-ccf4-4c4f-983c-436d3331bf82","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-3552,288],"webhookId":"create-appointment"},{"parameters":{"jsCode":"\n// Universal Phone Normalization (Australian E.164) - v9.09\n\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n\n  // 1. Strip everything except digits and '+'\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n\n  // 2. Already in E.164 format\n  if (phone.startsWith('+')) {\n    return phone;\n  }\n\n  // 3. Handle 8-digit local numbers (Assume NSW '02')\n  if (phone.length === 8 && !phone.startsWith('+')) {\n    return '+612' + phone;\n  }\n\n  // 4. Handle standard 10-digit AU numbers (04... or 02...)\n  if (phone.length === 10 && phone.startsWith('0')) {\n    return '+61' + phone.substring(1);\n  }\n\n  // 5. Handle numbers starting with 61 (missing +)\n  if (phone.length === 11 && phone.startsWith('61')) {\n    return '+' + phone;\n  }\n\n  // 6. Assume Australian if 9 digits (missing leading 0)\n  if (phone.length === 9) {\n    return '+61' + phone;\n  }\n\n  // 7. Return cleaned version (best effort)\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n\n// Extract and validate request parameters\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\nconst patient_id = args.patient_id || '';\nconst practitioner_id = args.practitioner_id || '473326864069303022';\nconst appointment_type = args.appointment_type || 'Standard Consultation';\nconst start_time = args.start_time || args.datetime || '';\nconst duration_minutes = parseInt(args.duration_minutes) || 30;\nconst village = args.village || '';\nconst funding_type = (args.funding_type || '').toUpperCase();\nconst appointment_notes = args.appointment_notes || '';\nconst unit_villa = args.unit_villa || '';\nconst call_id = call.call_id || args.call_id || '';\n\nif (!patient_id) throw new Error('patient_id is required');\nif (!start_time) throw new Error('start_time is required');\nif (!village) throw new Error('village is required');\nif (!funding_type) throw new Error('funding_type is required');\nif (!appointment_type) throw new Error('appointment_type is required');\n\nconst validFundingTypes = ['HCP', 'DVA', 'GP', 'PRIVATE', 'PHI'];\nif (!validFundingTypes.includes(funding_type)) {\n  throw new Error(`Invalid funding_type. Must be one of: ${validFundingTypes.join(', ')}`);\n}\n\nconst validAppointmentTypes = ['Standard Consultation', 'Standard Home Visit'];\nif (!validAppointmentTypes.includes(appointment_type)) {\n  throw new Error(`Invalid appointment_type. Must be one of: ${validAppointmentTypes.join(', ')}`);\n}\n\nconst appointmentDate = new Date(start_time);\nif (isNaN(appointmentDate.getTime())) {\n  throw new Error('Invalid start_time format. Use ISO 8601 format');\n}\n\nconst now = new Date();\nif (appointmentDate <= now) {\n  throw new Error('Appointment start_time must be in the future');\n}\n\nconst maxBookingDate = new Date(now);\nmaxBookingDate.setDate(now.getDate() + 21);\nif (appointmentDate > maxBookingDate) {\n  const daysAhead = Math.ceil((appointmentDate - now) / (1000 * 60 * 60 * 24));\n  throw new Error(`Appointment is ${daysAhead} days ahead. Bookings limited to 21 days. Error: BOOKING_WINDOW_EXCEEDED`);\n}\n\nconst endDate = new Date(appointmentDate);\nendDate.setMinutes(endDate.getMinutes() + duration_minutes);\nconst ends_at = endDate.toISOString();\n\nconst dateStr = appointmentDate.toLocaleDateString('en-AU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });\nconst timeStr = appointmentDate.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: true });\n\nconst clinikoNotes = [`Village: ${village}`, unit_villa ? `Unit/Villa: ${unit_villa}` : '', `Funding: ${funding_type}`, appointment_notes ? `Notes: ${appointment_notes}` : ''].filter(n => n).join('\\n');\n\nreturn [{ json: { patient_id, practitioner_id, business_id: '675491769126754955', appointment_type, starts_at: start_time, ends_at, duration_minutes, village, funding_type, unit_villa, appointment_notes, cliniko_notes: clinikoNotes, call_id, date_formatted: dateStr, time_formatted: timeStr, date_only: appointmentDate.toISOString().split('T')[0], timestamp: new Date().toISOString(), start_time: Date.now() }}];"},"id":"3eb0f2cb-65dc-4515-826e-c73317b7ed28","name":"Extract & Validate Request","type":"n8n-nodes-base.code","typeVersion":2,"position":[-3312,288]},{"parameters":{"jsCode":"const data = $input.item.json;\nconst APPOINTMENT_TYPE_MAP = {'Standard Consultation': process.env.CLINIKO_APPT_ID_CONSULT || '472831283798480897', 'Standard Home Visit': process.env.CLINIKO_APPT_ID_HOMEVISIT || '472831283798480897'};\nconst appointment_type_id = APPOINTMENT_TYPE_MAP[data.appointment_type];\nif (!appointment_type_id) throw new Error(`Unknown appointment type: ${data.appointment_type}`);\nreturn [{ json: { ...data, appointment_type_id: appointment_type_id }}];"},"id":"f6ec80c5-e6fe-4d83-ab9a-e3ff55482f82","name":"Map Appointment Type","type":"n8n-nodes-base.code","typeVersion":2,"position":[-3072,288]},{"parameters":{"url":"=https://api.au2.cliniko.com/v1/individual_appointments?q[]=practitioner_id:={{ $json.practitioner_id }}&q[]=starts_at:>={{ $json.starts_at }}&q[]=starts_at:<={{ $json.ends_at }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"},{"name":"Accept","value":"application/json"}]},"options":{}},"id":"9a7acbf7-a97b-4274-b60f-d147b160c0f5","name":"Check Slot Availability","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2832,288],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"const items = $input.all();\nconst requestData = $items(\"Map Appointment Type\")[0].json;\nif (items.length === 0 || items[0].json.error) { return [{ json: { ...requestData, availability_check_failed: true }}]; }\nconst clinikoResponse = items[0].json;\nconst appointments = clinikoResponse.individual_appointments || [];\nif (appointments.length > 0) { return [{ json: { success: false, appointment_created: false, error: { code: 'SLOT_UNAVAILABLE', message: 'This time slot is no longer available.' }, call_id: requestData.call_id, timestamp: new Date().toISOString(), is_error: true, stop_workflow: true }}]; }\nreturn [{ json: { ...requestData, slot_available: true }}];"},"id":"06ac3c4d-3263-44fc-86b8-d38a0c9d0565","name":"Handle Slot Conflict","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2592,288]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"slot_conflict_check","leftValue":"={{ $json.stop_workflow }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"e3ec94d5-9279-4991-9b44-55f762e45dda","name":"Check If Should Stop","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2352,288]},{"parameters":{"method":"POST","url":"https://api.au2.cliniko.com/v1/individual_appointments","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"},{"name":"Accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ { patient_id: $json.patient_id, practitioner_id: $json.practitioner_id, business_id: $json.business_id, appointment_type_id: $json.appointment_type_id, starts_at: $json.starts_at, ends_at: $json.ends_at, notes: $json.cliniko_notes, send_sms: true, confirmed: true } }}","options":{}},"id":"cdff622d-06a3-4992-bf34-3fe8a1c3c6e9","name":"Create Appointment in Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2112,192],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"const items = $input.all();\nconst requestData = $items(\"Handle Slot Conflict\")[0].json;\nif (items.length === 0 || items[0].json.error) { const errorMsg = items[0]?.json?.error || 'Failed to create appointment'; return [{ json: { success: false, appointment_created: false, error: { code: 'CLINIKO_API_ERROR', message: errorMsg }, call_id: requestData.call_id, timestamp: new Date().toISOString(), is_error: true, request_data: requestData }}]; }\nconst cliniko_response = items[0].json;\nif (!cliniko_response.id) { return [{ json: { success: false, appointment_created: false, error: { code: 'CLINIKO_API_ERROR', message: 'No ID returned' }, call_id: requestData.call_id, timestamp: new Date().toISOString(), is_error: true, request_data: requestData }}]; }\nconst patient_name = cliniko_response.patient?.first_name && cliniko_response.patient?.last_name ? `${cliniko_response.patient.first_name} ${cliniko_response.patient.last_name}` : 'Patient';\nreturn [{ json: { ...requestData, appointment_id: cliniko_response.id, patient_name: patient_name, practitioner_name: 'Liam Potter', cliniko_link: `https://reignitehealth.au2.cliniko.com/appointments/${cliniko_response.id}`, sms_sent: true, is_error: false, cliniko_response: cliniko_response }}];"},"id":"f03e05a0-bd96-40c0-9585-7e12866d5f9f","name":"Process Cliniko Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1872,192]},{"parameters":{"method":"POST","url":"https://api.au2.cliniko.com/v1/treatment_notes","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"},{"name":"Accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ { individual_appointment_id: $json.appointment_id, content: 'Booked via Voice AI.\\nCall ID: ' + $json.call_id + '\\nFunding: ' + $json.funding_type + '\\nAppointment Type: ' + $json.appointment_type + ($json.unit_villa ? '\\nUnit/Villa: ' + $json.unit_villa : '') + ($json.appointment_notes ? '\\nNotes: ' + $json.appointment_notes : '') } }}","options":{}},"id":"e276ec54-8a4e-4e63-b7f9-f3555217a3d8","name":"Add Treatment Notes","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1632,192],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"sendTo":"peter@yesai.au","subject":"=ü§ñ Voice AI Booking - {{ $items(\"Process Cliniko Response\")[0].json.patient_name }}","message":"=<html><body style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\"><div style=\"background-color: #f0f8ff; padding: 20px; border-radius: 10px;\"><h2 style=\"color: #2c3e50;\">ü§ñ Voice AI Booking</h2><div style=\"background-color: white; padding: 15px; border-radius: 5px; margin: 10px 0;\"><table style=\"width: 100%; border-collapse: collapse;\"><tr style=\"border-bottom: 1px solid #eee;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Patient:</td><td style=\"padding: 10px;\">{{ $items(\"Process Cliniko Response\")[0].json.patient_name }}</td></tr><tr style=\"border-bottom: 1px solid #eee; background: #f9f9f9;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Appointment ID:</td><td style=\"padding: 10px;\">{{ $items(\"Process Cliniko Response\")[0].json.appointment_id }}</td></tr><tr style=\"border-bottom: 1px solid #eee;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Date:</td><td style=\"padding: 10px;\">{{ $items(\"Process Cliniko Response\")[0].json.date_formatted }}</td></tr><tr style=\"border-bottom: 1px solid #eee; background: #f9f9f9;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Time:</td><td style=\"padding: 10px;\">{{ $items(\"Process Cliniko Response\")[0].json.time_formatted }}</td></tr><tr style=\"border-bottom: 1px solid #eee;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Duration:</td><td style=\"padding: 10px;\">{{ $items(\"Process Cliniko Response\")[0].json.duration_minutes }} minutes</td></tr><tr style=\"border-bottom: 1px solid #eee; background: #f9f9f9;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Type:</td><td style=\"padding: 10px;\">{{ $items(\"Process Cliniko Response\")[0].json.appointment_type }}</td></tr><tr style=\"border-bottom: 1px solid #eee;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Village:</td><td style=\"padding: 10px;\">{{ $items(\"Process Cliniko Response\")[0].json.village }}</td></tr><tr style=\"background: #f9f9f9;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Funding:</td><td style=\"padding: 10px;\">{{ $items(\"Process Cliniko Response\")[0].json.funding_type }}</td></tr></table></div><div style=\"text-align: center; margin: 25px 0;\"><a href=\"{{ $items(\"Process Cliniko Response\")[0].json.cliniko_link }}\" style=\"display: inline-block; background-color: #3498db; color: white; padding: 14px 35px; text-decoration: none; border-radius: 5px; font-weight: bold; font-size: 16px;\">View in Cliniko</a></div><div style=\"background-color: #e8f5e9; padding: 12px; border-radius: 5px; margin: 15px 0;\"><p style=\"margin: 0; font-size: 13px; color: #2e7d32;\">‚úÖ Appointment created | ‚úÖ SMS sent to patient | ‚úÖ Treatment notes added</p></div><div style=\"font-size: 12px; color: #7f8c8d; padding-top: 15px; border-top: 1px solid #ddd;\"><p style=\"margin: 5px 0;\"><strong>Call ID:</strong> {{ $items(\"Process Cliniko Response\")[0].json.call_id }}</p><p style=\"margin: 5px 0;\"><strong>Created:</strong> {{ $items(\"Process Cliniko Response\")[0].json.timestamp }}</p><p style=\"margin: 5px 0;\"><em>Voice AI booking system | Auto-flagged for review</em></p></div></div></body></html>","options":{}},"id":"0848ac56-3ac3-4d21-aa1b-e756a75cadbf","name":"Send Email to Peter","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[-1392,192],"webhookId":"b833cd85-ddc4-4e00-86b8-07dde247c541","credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}},"continueOnFail":true},{"parameters":{"operation":"executeQuery","query":"=DELETE FROM patient_funding_cache WHERE patient_id = '{{ $json.patient_id }}' RETURNING *;","options":{"queryBatching":"independently"}},"id":"934a5e95-88c0-41b9-8582-9b513be78aa8","name":"Invalidate Patient Funding Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-1152,192],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"jsCode":"const data = $items(\"Process Cliniko Response\")[0].json;\nif (data.is_error) { return [{ json: { success: false, appointment_created: false, error: data.error, call_id: data.call_id, timestamp: data.timestamp }}]; }\nconst response = { success: true, appointment_created: true, appointment_id: data.appointment_id, confirmation_details: { patient_name: data.patient_name, practitioner_name: data.practitioner_name, datetime: data.starts_at, date: data.date_formatted, time: data.time_formatted, duration_minutes: data.duration_minutes, village: data.village, funding_type: data.funding_type, appointment_type: data.appointment_type }, sms_sent: data.sms_sent, flagged_for_review: true, cliniko_link: data.cliniko_link, call_id: data.call_id, timestamp: new Date().toISOString() };\nreturn [{ json: response }];"},"id":"75a55a77-d2f2-4def-9350-aaaf5dee2e65","name":"Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[-912,288]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"cb45d04b-ba6e-4b26-a364-ab853baa0923","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-672,288]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO appointment_log (appointment_id, patient_id, practitioner_id, datetime, duration_minutes, appointment_type, funding_type, village, created_via, call_id, flagged_for_review, created_at) VALUES ('{{ $items(\"Process Cliniko Response\")[0].json.appointment_id }}', '{{ $items(\"Extract & Validate Request\")[0].json.patient_id }}', '{{ $items(\"Extract & Validate Request\")[0].json.practitioner_id }}', '{{ $items(\"Extract & Validate Request\")[0].json.starts_at }}'::timestamptz, {{ $items(\"Extract & Validate Request\")[0].json.duration_minutes }}, '{{ $items(\"Extract & Validate Request\")[0].json.appointment_type }}', '{{ $items(\"Extract & Validate Request\")[0].json.funding_type }}', '{{ $items(\"Extract & Validate Request\")[0].json.village }}', 'voice_ai', '{{ $items(\"Extract & Validate Request\")[0].json.call_id }}', true, now()) RETURNING *;","options":{"queryBatching":"independently"}},"id":"8a3cf926-66c3-4437-a6f7-d4081447c2bb","name":"Log Appointment to Database","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-432,288],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO webhook_log (webhook_name, call_id, request_body, response_body, success, duration_ms, cache_hit, created_at) VALUES ('create-appointment', '{{ $items(\"Extract & Validate Request\")[0].json.call_id }}', '{{ JSON.stringify($items(\"Extract & Validate Request\")[0].json) }}'::jsonb, '{{ JSON.stringify($items(\"Format Response\")[0].json) }}'::jsonb, {{ $items(\"Format Response\")[0].json.success }}, {{ Date.now() - $items(\"Extract & Validate Request\")[0].json.start_time }}, false, now()) RETURNING *;","options":{"queryBatching":"independently"}},"id":"1fd3aa7a-8223-4fcd-bf0b-4a4dc20c1075","name":"Log Webhook Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-192,288],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"jsCode":"const data = $input.item.json;\nreturn [{ json: { success: false, appointment_created: false, error: data.error, call_id: data.call_id, timestamp: data.timestamp }}];"},"id":"7789a229-2a6b-49bc-a273-619db2276669","name":"Format Error Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2112,384]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"96d6b4db-dd9f-4328-9fa4-832807e5ff61","name":"Respond Error to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1872,384]}],"connections":{"Webhook":{"main":[[{"node":"Extract & Validate Request","type":"main","index":0}]]},"Extract & Validate Request":{"main":[[{"node":"Map Appointment Type","type":"main","index":0}]]},"Map Appointment Type":{"main":[[{"node":"Check Slot Availability","type":"main","index":0}]]},"Check Slot Availability":{"main":[[{"node":"Handle Slot Conflict","type":"main","index":0}]]},"Handle Slot Conflict":{"main":[[{"node":"Check If Should Stop","type":"main","index":0}]]},"Check If Should Stop":{"main":[[{"node":"Format Error Response","type":"main","index":0}],[{"node":"Create Appointment in Cliniko","type":"main","index":0}]]},"Create Appointment in Cliniko":{"main":[[{"node":"Process Cliniko Response","type":"main","index":0}]]},"Process Cliniko Response":{"main":[[{"node":"Add Treatment Notes","type":"main","index":0}]]},"Add Treatment Notes":{"main":[[{"node":"Send Email to Peter","type":"main","index":0}]]},"Send Email to Peter":{"main":[[{"node":"Invalidate Patient Funding Cache","type":"main","index":0}]]},"Invalidate Patient Funding Cache":{"main":[[{"node":"Format Response","type":"main","index":0}]]},"Format Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Appointment to Database","type":"main","index":0}]]},"Log Appointment to Database":{"main":[[{"node":"Log Webhook Execution","type":"main","index":0}]]},"Format Error Response":{"main":[[{"node":"Respond Error to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"3434aa40-b872-40fe-9f07-ebc8ec006d50","triggerCount":1,"shared":[{"updatedAt":"2025-11-10T21:26:30.667Z","createdAt":"2025-11-10T21:26:30.667Z","role":"workflow:owner","workflowId":"5cR929ZqO1IMTROA","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-22T01:13:05.978Z","createdAt":"2025-11-12T01:26:40.637Z","id":"P4A06yDPMbECEN6T","name":"RetellAI - Check Funding Eligibility v2.3 FIXED","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/check-funding","responseMode":"responseNode","options":{}},"id":"aece893c-9895-4406-8aa8-eeb9535e599f","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"check-funding"},{"parameters":{"jsCode":"// Extract and validate request parameters\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\n// Extract required parameters with trim() to remove whitespace\nconst patient_id = (args.patient_id || '').toString().trim();\nconst funding_type = (args.funding_type || '').toString().trim().toUpperCase();\nconst call_id = call.call_id || args.call_id || '';\n\n// Validate required fields\nif (!patient_id) {\n  throw new Error('patient_id is required');\n}\nif (!funding_type) {\n  throw new Error('funding_type is required');\n}\n\n// Validate funding_type is one of the allowed values\nconst validTypes = ['HCP', 'DVA', 'GP', 'PRIVATE', 'PHI'];\nif (!validTypes.includes(funding_type)) {\n  throw new Error(`Invalid funding_type: \"${funding_type}\". Must be one of: ${validTypes.join(', ')}`);\n}\n\nconst currentYear = new Date().getFullYear();\nconst startTime = Date.now();\n\nreturn [{\n  json: {\n    patient_id,\n    funding_type,\n    call_id,\n    current_year: currentYear,\n    start_time: startTime,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"e181be99-089b-473e-9539-5235a04dbd97","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"operation":"executeQuery","query":"-- Check if funding rules cache exists and is fresh (24 hour TTL)\nSELECT \n  funding_type,\n  requires_referral,\n  max_appointments_per_year,\n  bulk_billing_available,\n  gap_fee,\n  notes,\n  EXTRACT(EPOCH FROM (now() - cached_at))/3600 as hours_old\nFROM funding_rules_cache\nWHERE funding_type = '{{ $json.funding_type }}'\n  AND cached_at > now() - interval '24 hours'\nLIMIT 1;","options":{"queryBatching":"independently"}},"id":"e5a684ad-0f08-4a55-84ac-f1b3caaa26c8","name":"Check Funding Rules Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[448,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Check if we have cached funding rules\nconst items = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// If we have cached data, return it\nif (items.length > 0 && items[0].json.funding_type) {\n  items[0].json.from_cache = true;\n  return items; // Cache hit - pass through\n}\n\n// Cache miss - get default rules\nconst funding_type = requestData.funding_type;\n\nconst rules = {\n  'HCP': {\n    funding_type: 'HCP',\n    requires_referral: false,\n    max_appointments_per_year: 5,\n    bulk_billing_available: true,\n    gap_fee: 0.00,\n    notes: 'Home Care Package - Max 5 appointments per calendar year'\n  },\n  'DVA': {\n    funding_type: 'DVA',\n    requires_referral: true,\n    max_appointments_per_year: null,\n    bulk_billing_available: true,\n    gap_fee: 0.00,\n    notes: 'Department of Veterans Affairs - Unlimited appointments with referral'\n  },\n  'GP': {\n    funding_type: 'GP',\n    requires_referral: true,\n    max_appointments_per_year: 5,\n    bulk_billing_available: true,\n    gap_fee: 0.00,\n    notes: 'GP Chronic Disease Management Plan - Max 5 appointments per calendar year with referral'\n  },\n  'PRIVATE': {\n    funding_type: 'PRIVATE',\n    requires_referral: false,\n    max_appointments_per_year: null,\n    bulk_billing_available: false,\n    gap_fee: 120.00,\n    notes: 'Private pay - Unlimited appointments'\n  },\n  'PHI': {\n    funding_type: 'PHI',\n    requires_referral: false,\n    max_appointments_per_year: null,\n    bulk_billing_available: false,\n    gap_fee: 50.00,\n    notes: 'Private Health Insurance - Check with your fund for limits'\n  }\n};\n\nconst defaultRule = rules[funding_type] || rules['PRIVATE'];\ndefaultRule.from_cache = false;\n\nreturn [{ json: defaultRule }];"},"id":"afd5764d-1e73-448e-979c-a0506767a470","name":"Get Funding Rules","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"operation":"executeQuery","query":"-- Cache the funding rules for 24 hours (only if it was a cache miss)\nINSERT INTO funding_rules_cache (\n  funding_type,\n  requires_referral,\n  max_appointments_per_year,\n  bulk_billing_available,\n  gap_fee,\n  notes,\n  cached_at\n)\nVALUES (\n  '{{ $json.funding_type }}',\n  {{ $json.requires_referral }},\n  {{ $json.max_appointments_per_year || 'NULL' }},\n  {{ $json.bulk_billing_available }},\n  {{ $json.gap_fee || 0 }},\n  '{{ $json.notes }}',\n  now()\n)\nON CONFLICT (funding_type) \nDO UPDATE SET\n  requires_referral = EXCLUDED.requires_referral,\n  max_appointments_per_year = EXCLUDED.max_appointments_per_year,\n  bulk_billing_available = EXCLUDED.bulk_billing_available,\n  gap_fee = EXCLUDED.gap_fee,\n  notes = EXCLUDED.notes,\n  cached_at = now()\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"556ad160-d590-4fa9-8cc0-0215474b69b9","name":"Cache Funding Rules","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[880,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"operation":"executeQuery","query":"-- Check patient funding history cache (1 hour TTL)\nSELECT \n  patient_id,\n  funding_type,\n  year,\n  appointment_count,\n  last_appointment_date,\n  EXTRACT(EPOCH FROM (now() - cached_at))/60 as minutes_old\nFROM patient_funding_cache\nWHERE patient_id = '{{ $items(\"Extract Request Data\")[0].json.patient_id }}'\n  AND funding_type = '{{ $items(\"Extract Request Data\")[0].json.funding_type }}'\n  AND year = {{ $items(\"Extract Request Data\")[0].json.current_year }}\n  AND cached_at > now() - interval '1 hour'\nLIMIT 1;","options":{"queryBatching":"independently"}},"id":"7d85636b-633c-4957-bd32-d980c11529f4","name":"Check Patient Funding Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1104,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"url":"=https://api.au2.cliniko.com/v1/appointments?patient_id={{ $items(\"Extract Request Data\")[0].json.patient_id }}&from_date={{ $items(\"Extract Request Data\")[0].json.current_year }}-01-01&per_page=100","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"Reignite Health AI (peter@yesai.au)"},{"name":"Accept","value":"application/json"}]},"options":{"response":{"response":{"neverError":true,"responseFormat":"json"}}}},"id":"b6589141-b4e1-484e-be3f-607e7267cc37","name":"Query Cliniko API for Appointments","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1328,0],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"// Process Cliniko API response and count appointments by funding type\nconst cacheCheck = $items(\"Check Patient Funding Cache\");\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// Check if we have cached patient data (cache hit)\nif (cacheCheck.length > 0 && cacheCheck[0].json.patient_id) {\n  const cached = cacheCheck[0].json;\n  cached.from_cache = true;\n  cached.from_cliniko = false;\n  return [{ json: cached }];\n}\n\n// Cache miss - process Cliniko API response\nconst clinikoResponse = $input.item.json;\n\n// Check for Cliniko API error\nif (!clinikoResponse || clinikoResponse.error) {\n  return [{\n    json: {\n      patient_id: requestData.patient_id,\n      funding_type: requestData.funding_type,\n      year: requestData.current_year,\n      appointment_count: 0,\n      last_appointment_date: null,\n      from_cliniko: true,\n      from_cache: false,\n      cliniko_error: true,\n      error_message: clinikoResponse.error || 'Failed to fetch appointments from Cliniko'\n    }\n  }];\n}\n\n// Extract appointments array from Cliniko response\nconst appointments = clinikoResponse.appointments || [];\nconst funding_type = requestData.funding_type;\nconst current_year = requestData.current_year;\n\n// Filter appointments for current year and matching funding type\n// Note: Funding type is stored in appointment notes\nconst filteredAppointments = appointments.filter(apt => {\n  // Check if appointment is in current year\n  const aptDate = new Date(apt.appointment_start);\n  const aptYear = aptDate.getFullYear();\n  if (aptYear !== current_year) return false;\n  \n  // Check if funding type is in notes (case insensitive)\n  // Funding type is typically stored as \"Funding: HCP\" or \"HCP funded\" in notes\n  const notes = (apt.notes || '').toUpperCase();\n  const hasFundingType = notes.includes(funding_type) || \n                         notes.includes(`FUNDING: ${funding_type}`) ||\n                         notes.includes(`${funding_type} FUNDED`);\n  \n  return hasFundingType;\n});\n\nconst appointment_count = filteredAppointments.length;\n\n// Get most recent appointment date\nlet last_appointment_date = null;\nif (filteredAppointments.length > 0) {\n  const dates = filteredAppointments.map(apt => new Date(apt.appointment_start));\n  const mostRecent = new Date(Math.max(...dates));\n  last_appointment_date = mostRecent.toISOString().split('T')[0];\n}\n\nreturn [{\n  json: {\n    patient_id: requestData.patient_id,\n    funding_type: requestData.funding_type,\n    year: current_year,\n    appointment_count,\n    last_appointment_date,\n    from_cliniko: true,\n    from_cache: false,\n    total_appointments_fetched: appointments.length,\n    filtered_count: appointment_count\n  }\n}];"},"id":"0082eb6f-fbc7-4c8f-be1d-7479b1a43060","name":"Process Cliniko Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1552,0]},{"parameters":{"operation":"executeQuery","query":"-- Cache patient funding history (1 hour TTL, only for cache miss)\nINSERT INTO patient_funding_cache (\n  patient_id,\n  funding_type,\n  year,\n  appointment_count,\n  last_appointment_date,\n  cached_at\n)\nVALUES (\n  '{{ $json.patient_id }}',\n  '{{ $json.funding_type }}',\n  {{ $json.year }},\n  {{ $json.appointment_count }},\n  {{ $json.last_appointment_date ? `'${$json.last_appointment_date}'` : 'NULL' }},\n  now()\n)\nON CONFLICT (patient_id, funding_type, year)\nDO UPDATE SET\n  appointment_count = EXCLUDED.appointment_count,\n  last_appointment_date = EXCLUDED.last_appointment_date,\n  cached_at = now()\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"3688dd27-02fb-4ad1-b3a2-6b2cd64e9ba8","name":"Cache Patient History","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1776,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Calculate final eligibility result\nconst requestData = $items(\"Extract Request Data\")[0].json;\nconst fundingRules = $items(\"Get Funding Rules\")[0].json;\nconst patientHistory = $items(\"Process Cliniko Response\")[0].json;\n\nconst appointment_count = patientHistory.appointment_count || 0;\nconst max_appointments = fundingRules.max_appointments_per_year;\nconst requires_referral = fundingRules.requires_referral;\n\n// Calculate eligibility\nlet is_eligible = true;\nlet reason = '';\nlet remaining_appointments = null;\n\n// Check appointment limit\nif (max_appointments !== null) {\n  remaining_appointments = max_appointments - appointment_count;\n  if (remaining_appointments <= 0) {\n    is_eligible = false;\n    reason = `Maximum ${max_appointments} appointments per year reached. ${appointment_count} appointments already booked this year.`;\n  } else {\n    reason = `${remaining_appointments} appointment${remaining_appointments !== 1 ? 's' : ''} remaining this year (${appointment_count}/${max_appointments} used).`;\n  }\n} else {\n  // Unlimited appointments\n  reason = `Unlimited appointments available. ${appointment_count} appointment${appointment_count !== 1 ? 's' : ''} booked this year.`;\n}\n\n// Add referral requirement to reason\nif (requires_referral && is_eligible) {\n  reason += ' Referral required.';\n}\n\nreturn [{\n  json: {\n    success: true,\n    call_id: requestData.call_id,\n    timestamp: new Date().toISOString(),\n    patient_id: requestData.patient_id,\n    funding_type: requestData.funding_type,\n    is_eligible,\n    reason,\n    details: {\n      appointments_this_year: appointment_count,\n      max_appointments_per_year: max_appointments,\n      remaining_appointments,\n      requires_referral,\n      bulk_billing_available: fundingRules.bulk_billing_available,\n      gap_fee: fundingRules.gap_fee,\n      last_appointment_date: patientHistory.last_appointment_date,\n      from_cache: patientHistory.from_cache || false\n    },\n    processing_time_ms: Date.now() - requestData.start_time\n  }\n}];"},"id":"ac6f120e-441c-4245-a644-8fd826b833e2","name":"Calculate Eligibility","type":"n8n-nodes-base.code","typeVersion":2,"position":[2000,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"8a3978cf-e993-4886-af69-8866e1cd80e8","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2208,0]},{"parameters":{"operation":"executeQuery","query":"-- Log webhook execution (happens after response sent)\nINSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_body,\n  response_body,\n  success,\n  duration_ms,\n  cache_hit,\n  created_at\n)\nVALUES (\n  'check-funding-v2',\n  '{{ $items(\"Extract Request Data\")[0].json.call_id }}',\n  '{{ JSON.stringify($items(\"Extract Request Data\")[0].json) }}'::jsonb,\n  '{{ JSON.stringify($items(\"Calculate Eligibility\")[0].json) }}'::jsonb,\n  true,\n  {{ Math.round((Date.now() - $items(\"Extract Request Data\")[0].json.start_time)) }},\n  {{ $items(\"Process Cliniko Response\")[0]?.json?.from_cache || false }},\n  now()\n)\nRETURNING *;","options":{}},"id":"86c922db-c26c-4251-be15-cfc53f243a7b","name":"Log Webhook Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[2432,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Check Funding Rules Cache","type":"main","index":0}]]},"Check Funding Rules Cache":{"main":[[{"node":"Get Funding Rules","type":"main","index":0}]]},"Get Funding Rules":{"main":[[{"node":"Cache Funding Rules","type":"main","index":0}]]},"Cache Funding Rules":{"main":[[{"node":"Check Patient Funding Cache","type":"main","index":0}]]},"Check Patient Funding Cache":{"main":[[{"node":"Query Cliniko API for Appointments","type":"main","index":0}]]},"Query Cliniko API for Appointments":{"main":[[{"node":"Process Cliniko Response","type":"main","index":0}]]},"Process Cliniko Response":{"main":[[{"node":"Cache Patient History","type":"main","index":0}]]},"Cache Patient History":{"main":[[{"node":"Calculate Eligibility","type":"main","index":0}]]},"Calculate Eligibility":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Webhook Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"f747dbb1-f908-46b4-89d7-5c443ebc8c8d","triggerCount":1,"shared":[{"updatedAt":"2025-11-12T01:26:40.637Z","createdAt":"2025-11-12T01:26:40.637Z","role":"workflow:owner","workflowId":"P4A06yDPMbECEN6T","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-12T20:56:23.027Z","createdAt":"2025-11-12T20:56:22.735Z","id":"er7j5qrLIDcQWpeJ","name":"Cliniko Appointment Types Sync - Daily v1.0","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"cronExpression","expression":"0 2 * * *"}]}},"id":"ea5bd164-9ed6-4fd4-a1f9-b30cf33f2cce","name":"Daily at 2am","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.1,"position":[0,0]},{"parameters":{"jsCode":"// Log sync start\nconst startTime = new Date();\nreturn [{\n  json: {\n    sync_type: 'appointment_types',\n    started_at: startTime.toISOString(),\n    start_timestamp: Date.now()\n  }\n}];"},"id":"0ef2b4dd-b1f2-4a1d-ad7f-c047cb74a59f","name":"Log Sync Start","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"url":"https://api.au2.cliniko.com/v1/appointment_types","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"per_page","value":"100"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Daily Sync (support@yr.com.au)"},{"name":"Accept","value":"application/json"}]},"options":{"response":{"response":{"responseFormat":"json"}},"pagination":{"pagination":{"paginationMode":"responseContainsNextURL","nextURL":"={{ $response.body.links.next }}","paginationCompleteWhen":"other","completeExpression":"={{ !$response.body.links || !$response.body.links.next }}"}}}},"id":"a2c0fdc1-0158-414c-a17a-a7661cf146fa","name":"Fetch from Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[448,0],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"jsCode":"// Process appointment types\nconst items = $input.all();\nconst processed = [];\n\nfor (const item of items) {\n  const types = item.json.appointment_types || [item.json];\n  \n  for (const type of types) {\n    if (!type.id) continue;\n    \n    // Extract duration from max_duration (in seconds, convert to minutes)\n    const durationMinutes = type.max_duration ? Math.round(type.max_duration / 60) : null;\n    \n    processed.push({\n      json: {\n        cliniko_id: String(type.id),\n        name: String(type.name || 'Unknown'),\n        duration_minutes: durationMinutes,\n        active: !type.deleted_at,\n        last_synced: new Date().toISOString()\n      }\n    });\n  }\n}\n\nconsole.log(`Processed ${processed.length} appointment types`);\n\nif (processed.length === 0) {\n  return [{\n    json: {\n      no_types: true,\n      message: 'No appointment types found'\n    }\n  }];\n}\n\nreturn processed;"},"id":"7f13c441-f6e3-491f-a288-25e89bdb7376","name":"Process Appointment Types","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"jsCode":"// Check if there are types to process\nconst items = $input.all();\n\nif (items.length === 1 && items[0].json.no_types) {\n  // No types - skip upsert\n  return [{\n    json: {\n      skipped: true,\n      records_processed: 0\n    }\n  }];\n}\n\n// Has types - pass through\nreturn items;"},"id":"3b2c8a11-50c2-4234-9ba1-4a07825c7018","name":"Check Has Types","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,0]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO appointment_types (\n    cliniko_id,\n    name,\n    duration_minutes,\n    active,\n    last_synced\n) VALUES (\n    '{{ $json.cliniko_id }}',\n    '{{ $json.name.replace(/'/g, \"''\") }}',\n    {{ $json.duration_minutes || 'NULL' }},\n    {{ $json.active }},\n    '{{ $json.last_synced }}'\n)\nON CONFLICT (cliniko_id) DO UPDATE SET\n    name = EXCLUDED.name,\n    duration_minutes = EXCLUDED.duration_minutes,\n    active = EXCLUDED.active,\n    last_synced = EXCLUDED.last_synced\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"5a296e96-3e68-4392-95a4-1c61c03ea14d","name":"Upsert to Database","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1104,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Calculate stats\nconst items = $input.all();\nconst endTime = Date.now();\nconst startTime = $('Log Sync Start').first().json.start_timestamp;\n\nif (items.length === 1 && items[0].json.skipped) {\n  return [{\n    json: {\n      status: 'success',\n      records_processed: 0,\n      duration_ms: endTime - startTime,\n      completed_at: new Date().toISOString(),\n      notes: 'No appointment types found'\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    status: 'success',\n    records_processed: items.length,\n    duration_ms: endTime - startTime,\n    completed_at: new Date().toISOString()\n  }\n}];"},"id":"5f796283-0f07-486f-b0fa-58815c13dcb6","name":"Calculate Stats","type":"n8n-nodes-base.code","typeVersion":2,"position":[1328,0]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO sync_log (\n    sync_type,\n    completed_at,\n    status,\n    records_processed,\n    duration_ms,\n    notes\n) VALUES (\n    'appointment_types',\n    '{{ $json.completed_at }}',\n    '{{ $json.status }}',\n    {{ $json.records_processed }},\n    {{ $json.duration_ms }},\n    {{ $json.notes ? \"'\" + $json.notes + \"'\" : 'NULL' }}\n) RETURNING *;","options":{}},"id":"bca650f3-acd2-410f-bd3a-5e53b07a5edc","name":"Log Sync Completion","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1552,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Daily at 2am":{"main":[[{"node":"Log Sync Start","type":"main","index":0}]]},"Log Sync Start":{"main":[[{"node":"Fetch from Cliniko","type":"main","index":0}]]},"Fetch from Cliniko":{"main":[[{"node":"Process Appointment Types","type":"main","index":0}]]},"Process Appointment Types":{"main":[[{"node":"Check Has Types","type":"main","index":0}]]},"Check Has Types":{"main":[[{"node":"Upsert to Database","type":"main","index":0}]]},"Upsert to Database":{"main":[[{"node":"Calculate Stats","type":"main","index":0}]]},"Calculate Stats":{"main":[[{"node":"Log Sync Completion","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Daily at 2am":{"recurrenceRules":[]}},"meta":null,"pinData":{},"versionId":"e4110105-a039-46ab-9992-7a247a1bdb4b","triggerCount":1,"shared":[{"updatedAt":"2025-11-12T20:56:22.735Z","createdAt":"2025-11-12T20:56:22.735Z","role":"workflow:owner","workflowId":"er7j5qrLIDcQWpeJ","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-13T01:41:49.717Z","createdAt":"2025-11-13T01:09:13.155Z","id":"iSg6SCgdd1soXZbv","name":"Cliniko Practitioners Sync - Daily v1.1","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"cronExpression","expression":"0 2 * * *"}]}},"id":"a8583157-a7fa-40f8-b9de-e72eb02751ea","name":"Daily at 2am","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.1,"position":[0,0]},{"parameters":{"jsCode":"// Log sync start\nconst startTime = new Date();\nreturn [{\n  json: {\n    sync_type: 'practitioners',\n    started_at: startTime.toISOString(),\n    start_timestamp: Date.now()\n  }\n}];"},"id":"84754f9d-2092-4ac9-83e8-0836cb5b7f08","name":"Log Sync Start","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"url":"https://api.au2.cliniko.com/v1/practitioners","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"per_page","value":"100"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Daily Sync (support@yr.com.au)"},{"name":"Accept","value":"application/json"}]},"options":{"response":{"response":{"responseFormat":"json"}},"pagination":{"pagination":{"paginationMode":"responseContainsNextURL","nextURL":"={{ $response.body.links.next }}","paginationCompleteWhen":"other","completeExpression":"={{ !$response.body.links || !$response.body.links.next }}"}}}},"id":"d312f50b-f097-479e-b881-b02c02981a75","name":"Fetch from Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[448,0],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"jsCode":"// Process practitioners with business lookup\nconst items = $input.all();\nconst processed = [];\n\n// Village name extraction from business name\nfunction extractVillage(businessName) {\n  if (!businessName) return 'Unknown';\n  \n  // Common patterns in Reignite Health business names\n  const patterns = [\n    /The Baytree/i,\n    /Oak Village/i,\n    /Seaside Village/i,\n    /Henry Kendall/i,\n    /Glenaeon/i,\n    /Retirement Village/i\n  ];\n  \n  for (const pattern of patterns) {\n    const match = businessName.match(pattern);\n    if (match) return match[0];\n  }\n  \n  // Return full business name if no pattern matches\n  return businessName;\n}\n\nfor (const item of items) {\n  const practitioners = item.json.practitioners || [item.json];\n  \n  for (const prac of practitioners) {\n    if (!prac.id) continue;\n    \n    // Extract village from business\n    const businessName = prac.business?.name || null;\n    const village = businessName ? extractVillage(businessName) : 'Unknown';\n    \n    processed.push({\n      json: {\n        cliniko_id: String(prac.id),\n        first_name: String(prac.first_name || ''),\n        last_name: String(prac.last_name || ''),\n        title: prac.title || null,\n        village: village,\n        active: !prac.deleted_at && prac.show_in_online_bookings,\n        last_synced: new Date().toISOString()\n      }\n    });\n  }\n}\n\nconsole.log(`Processed ${processed.length} practitioners`);\n\nif (processed.length === 0) {\n  return [{\n    json: {\n      no_practitioners: true,\n      message: 'No practitioners found'\n    }\n  }];\n}\n\nreturn processed;"},"id":"c72d1bd1-2837-48cf-a3da-73fb7aae1d3a","name":"Process Practitioners","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"jsCode":"// Check if there are practitioners to process\nconst items = $input.all();\n\nif (items.length === 1 && items[0].json.no_practitioners) {\n  // No practitioners - skip upsert\n  return [{\n    json: {\n      skipped: true,\n      records_processed: 0\n    }\n  }];\n}\n\n// Has practitioners - pass through\nreturn items;"},"id":"1160ee15-b82d-405e-a925-874eeb4b7c0b","name":"Check Has Practitioners","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,0]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO practitioners (\n    cliniko_id,\n    first_name,\n    last_name,\n    title,\n    village,\n    active,\n    last_synced\n) VALUES (\n    '{{ $json.cliniko_id }}',\n    '{{ $json.first_name.replace(/'/g, \"''\") }}',\n    '{{ $json.last_name.replace(/'/g, \"''\") }}',\n    {{ $json.title ? \"'\" + $json.title.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n    '{{ $json.village.replace(/'/g, \"''\") }}',\n    {{ $json.active }},\n    '{{ $json.last_synced }}'\n)\nON CONFLICT (cliniko_id) DO UPDATE SET\n    first_name = EXCLUDED.first_name,\n    last_name = EXCLUDED.last_name,\n    title = EXCLUDED.title,\n    village = EXCLUDED.village,\n    active = EXCLUDED.active,\n    last_synced = EXCLUDED.last_synced\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"3326200e-b66e-4816-b780-c67b3fa0ff47","name":"Upsert to Database","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1104,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"operation":"executeQuery","query":"-- Find practitioners that don't have village mappings yet\nSELECT \n    p.cliniko_id,\n    p.village\nFROM practitioners p\nLEFT JOIN practitioner_villages pv ON p.cliniko_id = pv.practitioner_id\nWHERE pv.practitioner_id IS NULL\n  AND p.active = true\n  AND p.village != 'Unknown';","options":{}},"id":"ec736435-7b6b-4c12-9481-ae7b320149e9","name":"Find Missing Village Mappings","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1328,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Check if there are new practitioners needing mappings\nconst items = $input.all();\n\nif (items.length === 0 || !items[0].json.cliniko_id) {\n  // No new practitioners - stop execution here\n  console.log('No new practitioners need village mappings');\n  \n  // Return to Calculate Stats node with special flag\n  // This will skip the Auto-Create node entirely\n  throw new Error('SKIP_TO_STATS'); // This will cause workflow to handle gracefully\n}\n\nconsole.log(`Found ${items.length} practitioners needing village mappings`);\n\n// Pass through for insertion\nreturn items;"},"id":"a5d6ce39-9b41-4c8a-be52-50d0e8e15a09","name":"Check New Mappings Needed","type":"n8n-nodes-base.code","typeVersion":2,"position":[1552,0]},{"parameters":{"operation":"executeQuery","query":"-- Auto-create village mapping for new practitioner\nINSERT INTO practitioner_villages (\n    practitioner_id,\n    village\n) VALUES (\n    '{{ $json.cliniko_id }}',\n    '{{ $json.village.replace(/'/g, \"''\") }}'\n)\nON CONFLICT (practitioner_id, village) DO NOTHING\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"ac62e936-7d5b-4fd5-ae4a-eb5a2043ad0f","name":"Auto-Create Village Mappings","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1760,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Calculate stats including auto-mappings\nconst upsertItems = $('Upsert to Database').all();\nconst mappingItems = $input.all();\nconst endTime = Date.now();\nconst startTime = $('Log Sync Start').first().json.start_timestamp;\n\n// Count practitioners processed\nlet practitionersProcessed = 0;\nif (upsertItems.length > 0 && !upsertItems[0].json.skipped) {\n  practitionersProcessed = upsertItems.length;\n}\n\n// Count auto-mappings created\nlet mappingsCreated = 0;\nif (mappingItems.length > 0 && !mappingItems[0].json.no_new_mappings) {\n  mappingsCreated = mappingItems.filter(i => i.json.practitioner_id).length;\n}\n\nconst notes = [];\nif (practitionersProcessed === 0) {\n  notes.push('No practitioners found');\n}\nif (mappingsCreated > 0) {\n  notes.push(`Auto-created ${mappingsCreated} village mappings`);\n}\n\nreturn [{\n  json: {\n    status: 'success',\n    records_processed: practitionersProcessed,\n    auto_mappings_created: mappingsCreated,\n    duration_ms: endTime - startTime,\n    completed_at: new Date().toISOString(),\n    notes: notes.length > 0 ? notes.join('; ') : null\n  }\n}];"},"id":"3f472ed6-04b7-45e3-9de0-ee8fa6833bd0","name":"Calculate Stats","type":"n8n-nodes-base.code","typeVersion":2,"position":[1984,0]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO sync_log (\n    sync_type,\n    completed_at,\n    status,\n    records_processed,\n    duration_ms,\n    notes\n) VALUES (\n    'practitioners',\n    '{{ $json.completed_at }}',\n    '{{ $json.status }}',\n    {{ $json.records_processed }},\n    {{ $json.duration_ms }},\n    {{ $json.notes ? \"'\" + $json.notes + \"'\" : 'NULL' }}\n) RETURNING *;","options":{}},"id":"0ab0c5f8-5cf9-44df-8624-ab8d975a48e6","name":"Log Sync Completion","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[2208,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Daily at 2am":{"main":[[{"node":"Log Sync Start","type":"main","index":0}]]},"Log Sync Start":{"main":[[{"node":"Fetch from Cliniko","type":"main","index":0}]]},"Fetch from Cliniko":{"main":[[{"node":"Process Practitioners","type":"main","index":0}]]},"Process Practitioners":{"main":[[{"node":"Check Has Practitioners","type":"main","index":0}]]},"Check Has Practitioners":{"main":[[{"node":"Upsert to Database","type":"main","index":0}]]},"Upsert to Database":{"main":[[{"node":"Find Missing Village Mappings","type":"main","index":0}]]},"Find Missing Village Mappings":{"main":[[{"node":"Check New Mappings Needed","type":"main","index":0}]]},"Check New Mappings Needed":{"main":[[{"node":"Auto-Create Village Mappings","type":"main","index":0}]]},"Auto-Create Village Mappings":{"main":[[{"node":"Calculate Stats","type":"main","index":0}]]},"Calculate Stats":{"main":[[{"node":"Log Sync Completion","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Daily at 2am":{"recurrenceRules":[]}},"meta":null,"pinData":{},"versionId":"8cbf3075-d2e4-4022-a384-ca607a46c60d","triggerCount":1,"shared":[{"updatedAt":"2025-11-13T01:09:13.155Z","createdAt":"2025-11-13T01:09:13.155Z","role":"workflow:owner","workflowId":"iSg6SCgdd1soXZbv","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-13T05:40:13.063Z","createdAt":"2025-11-13T02:21:26.203Z","id":"4BNjjIutyf9CQfUF","name":"Cliniko Group Appointments Sync - Hourly v1.2 COMPLETE FIXED","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"hours"}]}},"id":"a9e1fce3-b830-4e3b-a3d2-a0222e8f70d4","name":"Schedule Trigger - Every Hour","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.1,"position":[0,0]},{"parameters":{"jsCode":"// Log sync start\nconsole.log('================================');\nconsole.log('üïê STARTING CLINIKO GROUP APPOINTMENTS SYNC');\nconsole.log('================================');\n\nreturn [{ json: { sync_started: new Date().toISOString() } }];"},"id":"d01d09b3-a732-46dc-8fd2-93be74127668","name":"Log Sync Start","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"operation":"executeQuery","query":"-- Get last sync time for group appointments\nSELECT \n  last_sync_time,\n  last_sync_completed,\n  records_synced\nFROM sync_metadata \nWHERE sync_key = 'cliniko_group_appointments'\nLIMIT 1;","options":{}},"id":"51bade46-433a-4bc6-93ce-c789ad0433d5","name":"Get Last Sync Time","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[448,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Determine last sync time\nconst items = $input.all();\n\nlet lastSyncTime;\nif (items.length > 0 && items[0].json.last_sync_time) {\n  lastSyncTime = items[0].json.last_sync_time;\n  console.log(`üìÖ Last sync: ${lastSyncTime}`);\n} else {\n  // Default to 7 days ago for first sync\n  const sevenDaysAgo = new Date();\n  sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);\n  lastSyncTime = sevenDaysAgo.toISOString();\n  console.log(`üÜï First sync - starting from 7 days ago: ${lastSyncTime}`);\n}\n\nreturn [{ json: { last_sync_time: lastSyncTime } }];"},"id":"26f1e4b6-a1ec-4b76-8a13-ec4d60cd1552","name":"Prepare Sync Parameters","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"url":"=https://api.au2.cliniko.com/v1/group_appointments?updated_since={{ encodeURIComponent($json.last_sync_time) }}&per_page=100&page=1","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"},{"name":"Accept","value":"application/json"}]},"options":{}},"id":"edbd6e08-dec1-49ae-a4b9-7644dc3d259d","name":"Fetch First Page from Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[880,0],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"jsCode":"// Generate page numbers for pagination\nconst response = $input.item.json;\nconst totalEntries = response.total_entries || 0;\nconst perPage = 100;\nconst totalPages = Math.ceil(totalEntries / perPage);\n\nconsole.log(`üìä Total group appointments to sync: ${totalEntries}`);\nconsole.log(`üìÑ Total pages: ${totalPages}`);\n\nif (totalPages === 0) {\n  console.log('‚úÖ No group appointments to sync');\n  return [{ json: { no_appointments: true, total_pages: 0 } }];\n}\n\nconst lastSyncTime = $('Prepare Sync Parameters').item.json.last_sync_time;\n\nconst pages = [];\nfor (let i = 1; i <= totalPages; i++) {\n  pages.push({ \n    page: i, \n    last_sync_time: lastSyncTime \n  });\n}\n\nreturn pages.map(p => ({ json: p }));"},"id":"283f18e6-3dfa-451b-b88c-c3b16d2eea0c","name":"Generate Page Numbers","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,0]},{"parameters":{"url":"=https://api.au2.cliniko.com/v1/group_appointments?updated_since={{ encodeURIComponent($json.last_sync_time) }}&per_page=100&page={{ $json.page }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"},{"name":"Accept","value":"application/json"}]},"options":{}},"id":"24d1dac4-e455-437a-97c6-10cb6507e20d","name":"Fetch All Pages","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1328,0],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"aggregate":"aggregateAllItemData","destinationFieldName":"allPages","options":{}},"id":"4d0106ca-3981-4dc5-b8b7-ff1bf71db3db","name":"Aggregate All Pages","type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[1552,0]},{"parameters":{"jsCode":"// Extract and process group appointments - FIXED for Cliniko's actual structure\nconst items = $input.all();\nconst allPages = items[0].json.allPages || [];\n\nconsole.log('================================');\nconsole.log('üì¶ PROCESSING GROUP APPOINTMENTS');\nconsole.log('================================');\n\nif (allPages.length === 0) {\n  console.log('‚ö†Ô∏è  No pages to process');\n  return [{ json: { no_data: true } }];\n}\n\n// Extract appointments from all pages\nconst allAppointments = [];\nfor (const page of allPages) {\n  const appointments = page.group_appointments || [];\n  allAppointments.push(...appointments);\n}\n\nconsole.log(`üìä Total appointments extracted: ${allAppointments.length}`);\n\nif (allAppointments.length === 0) {\n  console.log('‚úÖ No appointments to process');\n  return [{ json: { no_appointments: true } }];\n}\n\n// Extract ID from Cliniko URL structure\nfunction extractIdFromUrl(url) {\n  if (!url) return null;\n  const match = url.match(/\\/([0-9]+)(?:\\?|$)/);\n  return match ? match[1] : null;\n}\n\n// Process each appointment\nconst processed = [];\nlet skippedCount = 0;\n\nfor (const apt of allAppointments) {\n  try {\n    // CORRECT: Cliniko returns nested objects, not flat links\n    const appointmentTypeId = extractIdFromUrl(apt.appointment_type?.links?.self);\n    const businessId = extractIdFromUrl(apt.business?.links?.self);\n    const practitionerId = extractIdFromUrl(apt.practitioner?.links?.self);\n    \n    // Extract attendee IDs\n    const attendeeIds = apt.patient_ids || [];\n    \n    // Calculate spaces\n    const maxAttendees = apt.max_attendees || 10;\n    const attendeeCount = attendeeIds.length;\n    const spacesAvailable = Math.max(0, maxAttendees - attendeeCount);\n    \n    processed.push({\n      json: {\n        cliniko_appointment_id: String(apt.id),\n        appointment_type_id: appointmentTypeId,\n        business_id: businessId,\n        practitioner_id: practitionerId,\n        starts_at: apt.starts_at,\n        ends_at: apt.ends_at,\n        duration_minutes: apt.duration || 60,\n        max_attendees: maxAttendees,\n        attendee_ids: attendeeIds,\n        attendee_count: attendeeCount,\n        spaces_available: spacesAvailable,\n        is_cancelled: apt.cancelled || false,\n        is_deleted: apt.deleted_at ? true : false,\n        created_at: apt.created_at,\n        updated_at: apt.updated_at\n      }\n    });\n  } catch (e) {\n    skippedCount++;\n    console.log(`‚ö†Ô∏è  Skipped appointment ${apt.id}: ${e.message}`);\n  }\n}\n\nconsole.log(`‚úÖ Processed ${processed.length} appointments`);\nif (skippedCount > 0) {\n  console.log(`‚ö†Ô∏è  Skipped ${skippedCount} appointments due to errors`);\n}\n\nreturn processed;"},"id":"06d75bdd-c1d4-47cb-8a0e-a18eb0ee12f0","name":"Extract and Process Group Appointments","type":"n8n-nodes-base.code","typeVersion":2,"position":[1760,0]},{"parameters":{"operation":"executeQuery","query":"-- Upsert group appointment (using IDs only)\nINSERT INTO group_appointments (\n    cliniko_appointment_id,\n    appointment_type_id,\n    business_id,\n    practitioner_id,\n    starts_at,\n    ends_at,\n    duration_minutes,\n    max_attendees,\n    attendee_ids,\n    attendee_count,\n    spaces_available,\n    is_cancelled,\n    is_deleted,\n    created_at,\n    updated_at,\n    last_synced\n) VALUES (\n    '{{ $json.cliniko_appointment_id }}',\n    {{ $json.appointment_type_id ? \"'\" + $json.appointment_type_id + \"'\" : 'NULL' }},\n    {{ $json.business_id ? \"'\" + $json.business_id + \"'\" : 'NULL' }},\n    {{ $json.practitioner_id ? \"'\" + $json.practitioner_id + \"'\" : 'NULL' }},\n    '{{ $json.starts_at }}',\n    '{{ $json.ends_at }}',\n    {{ $json.duration_minutes }},\n    {{ $json.max_attendees }},\n    ARRAY[{{ $json.attendee_ids.map(id => \"'\" + id + \"'\").join(',') || '' }}]::TEXT[],\n    {{ $json.attendee_count }},\n    {{ $json.spaces_available }},\n    {{ $json.is_cancelled }},\n    {{ $json.is_deleted }},\n    '{{ $json.created_at }}',\n    '{{ $json.updated_at }}',\n    CURRENT_TIMESTAMP\n)\nON CONFLICT (cliniko_appointment_id) DO UPDATE SET\n    appointment_type_id = EXCLUDED.appointment_type_id,\n    business_id = EXCLUDED.business_id,\n    practitioner_id = EXCLUDED.practitioner_id,\n    starts_at = EXCLUDED.starts_at,\n    ends_at = EXCLUDED.ends_at,\n    duration_minutes = EXCLUDED.duration_minutes,\n    max_attendees = EXCLUDED.max_attendees,\n    attendee_ids = EXCLUDED.attendee_ids,\n    attendee_count = EXCLUDED.attendee_count,\n    spaces_available = EXCLUDED.spaces_available,\n    is_cancelled = EXCLUDED.is_cancelled,\n    is_deleted = EXCLUDED.is_deleted,\n    updated_at = EXCLUDED.updated_at,\n    last_synced = CURRENT_TIMESTAMP\nRETURNING *;","options":{}},"id":"6cf4a040-65b0-4ecf-a8ea-9b1501a507d8","name":"Upsert Group Appointments to Postgres","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1984,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"aggregate":"aggregateAllItemData","destinationFieldName":"upsertResults","options":{}},"id":"e2d30200-9a3f-46f2-ac14-83ec38e83d70","name":"Aggregate Upsert Results","type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[2208,0]},{"parameters":{"jsCode":"// Extract unique practitioner-business (village) combinations\n// FIXED v1.2: Now properly validates and filters out practitioners without valid IDs\nconst items = $input.all();\nconst upsertResults = items[0].json.upsertResults || [];\n\nconsole.log('================================');\nconsole.log('üèòÔ∏è  BUILDING PRACTITIONER-VILLAGE MAPPINGS');\nconsole.log('================================');\n\nif (upsertResults.length === 0) {\n  console.log('‚ö†Ô∏è  No appointments to process for village mappings');\n  return [{ json: { no_mappings: true } }];\n}\n\n// Use Map to track unique combinations\nconst uniqueMappings = new Map();\nlet skippedCount = 0;\n\nfor (const apt of upsertResults) {\n  const practitionerId = apt.practitioner_id;\n  const businessId = apt.business_id;\n  \n  // CRITICAL FIX: Skip if practitioner_id is null, undefined, empty, or 'undefined' string\n  if (!practitionerId || \n      practitionerId === '' || \n      practitionerId === 'null' || \n      practitionerId === 'undefined' ||\n      !businessId || \n      businessId === '' || \n      businessId === 'null' ||\n      businessId === 'undefined') {\n    skippedCount++;\n    if (skippedCount <= 5) { // Log first 5 skipped items\n      console.log(`‚ö†Ô∏è  Skipped appointment: practitioner_id=${practitionerId}, business_id=${businessId}`);\n    }\n    continue;\n  }\n  \n  // Create unique key for this combination\n  const key = `${practitionerId}|${businessId}`;\n  \n  if (!uniqueMappings.has(key)) {\n    uniqueMappings.set(key, {\n      practitioner_id: practitionerId,\n      business_id: businessId\n    });\n  }\n}\n\nif (skippedCount > 0) {\n  console.log(`‚ö†Ô∏è  Skipped ${skippedCount} appointments without valid practitioner or business IDs`);\n}\n\nconst mappings = Array.from(uniqueMappings.values());\n\nconsole.log(`üìç Found ${mappings.length} unique practitioner-business combinations`);\n\nif (mappings.length === 0) {\n  console.log('‚ö†Ô∏è  No valid mappings to create');\n  return [{ json: { no_valid_mappings: true } }];\n}\n\n// Log summary\nconst practitionerCount = new Set(mappings.map(m => m.practitioner_id)).size;\nconst businessCount = new Set(mappings.map(m => m.business_id)).size;\n\nconsole.log(`üë• Practitioners: ${practitionerCount}`);\nconsole.log(`üèòÔ∏è  Businesses: ${businessCount}`);\n\nreturn mappings.map(m => ({ json: m }));"},"id":"5a1f8625-b7ea-41a8-9f21-7e2ae8d4b087","name":"Extract Unique Practitioner-Business Mappings","type":"n8n-nodes-base.code","typeVersion":2,"position":[2432,0]},{"parameters":{"operation":"executeQuery","query":"-- Get existing practitioner-village mappings\nSELECT \n  practitioner_id,\n  village\nFROM practitioner_villages\nWHERE practitioner_id IS NOT NULL\n  AND village IS NOT NULL;","options":{}},"id":"5fc21cfa-1f91-43e0-97ee-30813bb9c9eb","name":"Get Existing Village Mappings","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[2640,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// FIXED v1.2: Enhanced validation to prevent undefined cliniko_id errors\n// Check if there are new practitioner-business mappings that need village names\n\nconst newMappings = $('Extract Unique Practitioner-Business Mappings').all();\nconst existingMappings = $input.all();\n\nconsole.log('================================');\nconsole.log('üîç CHECKING FOR NEW VILLAGE MAPPINGS');\nconsole.log('================================');\n\n// Build set of existing mappings for fast lookup (by practitioner_id only)\nconst existingPractitioners = new Set();\nfor (const existing of existingMappings) {\n  if (existing.json.practitioner_id) {\n    existingPractitioners.add(existing.json.practitioner_id);\n  }\n}\n\nconsole.log(`üìä Existing practitioners in database: ${existingPractitioners.size}`);\nconsole.log(`üìä New mappings from sync: ${newMappings.length}`);\n\n// Filter for practitioners that need village lookup from Cliniko\n// CRITICAL: Only include practitioners with valid IDs\nconst needsLookup = [];\nlet invalidCount = 0;\n\nfor (const item of newMappings) {\n  const data = item.json;\n  \n  // STRICT VALIDATION: Must have valid practitioner_id\n  if (!data || \n      !data.practitioner_id || \n      data.practitioner_id === '' || \n      data.practitioner_id === 'null' || \n      data.practitioner_id === 'undefined') {\n    invalidCount++;\n    if (invalidCount <= 3) { // Log first 3 invalid items\n      console.log(`‚ö†Ô∏è  SKIPPED invalid data: ${JSON.stringify(data)}`);\n    }\n    continue;\n  }\n  \n  // Check if this practitioner already has village mappings\n  const isNew = !existingPractitioners.has(data.practitioner_id);\n  \n  if (isNew) {\n    console.log(`‚ú® NEW practitioner needs village lookup: ${data.practitioner_id}`);\n    needsLookup.push(item);\n  }\n}\n\nif (invalidCount > 0) {\n  console.log(`‚ö†Ô∏è  Skipped ${invalidCount} items with invalid practitioner IDs`);\n}\n\nif (needsLookup.length === 0) {\n  console.log('‚úÖ No new practitioners need village lookups');\n  \n  // Return skip signal - this prevents the next node from trying to process invalid data\n  return [{\n    json: {\n      skip_lookup: true,\n      practitioners_checked: newMappings.length,\n      new_practitioners: 0,\n      invalid_items: invalidCount\n    }\n  }];\n}\n\nconsole.log(`üÜï Found ${needsLookup.length} NEW practitioners needing village lookups`);\n\n// Return only valid practitioners that need lookups\nreturn needsLookup;"},"id":"5c00535d-c674-44d2-9bd5-5698ffb3dad7","name":"Check Which Practitioners Need Village Lookup","type":"n8n-nodes-base.code","typeVersion":2,"position":[2864,0]},{"parameters":{"url":"=https://api.au2.cliniko.com/v1/practitioners/{{ $json.practitioner_id }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"},{"name":"Accept","value":"application/json"}]},"options":{}},"id":"3768386c-8fdb-456e-a7ba-bc0eac143320","name":"Fetch Practitioner Details from Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[3088,0],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"url":"=https://api.au2.cliniko.com/v1/businesses/{{ $('Extract Unique Practitioner-Business Mappings').item.json.business_id }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"},{"name":"Accept","value":"application/json"}]},"options":{}},"id":"7df8ad90-cdea-4db9-a557-eb68c248af57","name":"Fetch Business Details from Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[3312,0],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"// FIXED v1.2: Now properly handles failed lookups\n// Combine practitioner and business data for village mappings\n\nconst items = $input.all();\n\nconsole.log('================================');\nconsole.log('üîó COMBINING PRACTITIONER AND BUSINESS DATA');\nconsole.log('================================');\n\nconst combined = [];\nlet successCount = 0;\nlet failCount = 0;\n\nfor (const item of items) {\n  // Get the practitioner data (from Fetch Practitioner Details)\n  const practitionerData = $('Fetch Practitioner Details from Cliniko').item.json;\n  \n  // Get the business data (from Fetch Business Details)\n  const businessData = item.json;\n  \n  // Validate we have both pieces of data\n  if (!practitionerData || !practitionerData.id || \n      !businessData || !businessData.id || !businessData.name) {\n    failCount++;\n    console.log(`‚ùå Failed lookup for practitioner - missing data`);\n    continue;\n  }\n  \n  const practitionerId = String(practitionerData.id);\n  const practitionerName = practitionerData.first_name && practitionerData.last_name\n    ? `${practitionerData.first_name} ${practitionerData.last_name}`\n    : 'Unknown';\n  const village = businessData.name;\n  \n  // Final validation before adding to combined list\n  if (practitionerId && practitionerId !== 'undefined' && village) {\n    combined.push({\n      json: {\n        practitioner_id: practitionerId,\n        practitioner_name: practitionerName,\n        village: village\n      }\n    });\n    successCount++;\n    console.log(`‚úÖ ${practitionerName} ‚Üí ${village}`);\n  } else {\n    failCount++;\n    console.log(`‚ùå Invalid data: practitioner_id=${practitionerId}, village=${village}`);\n  }\n}\n\nconsole.log(`\\nüìä Results: ${successCount} successful, ${failCount} failed`);\n\nif (combined.length === 0) {\n  console.log('‚ö†Ô∏è  No valid practitioner-village combinations found');\n  return [{ json: { no_valid_combinations: true } }];\n}\n\nreturn combined;"},"id":"0e885d3e-614e-4ad2-bc5c-cb694b390ad7","name":"Combine Practitioner and Business Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[3520,0]},{"parameters":{"operation":"executeQuery","query":"-- Insert new practitioner-village mapping\n-- v1.2 FIX: Now only called with validated data from previous nodes\nINSERT INTO practitioner_villages (\n    practitioner_id,\n    village\n) VALUES (\n    '{{ $json.practitioner_id }}',\n    '{{ $json.village.replace(/'/g, \"''\") }}'\n)\nON CONFLICT (practitioner_id, village) DO NOTHING\nRETURNING *;","options":{}},"id":"99c081b8-b2c4-41dc-be29-049e4a4456be","name":"Auto-Create Village Mappings","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[3744,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"aggregate":"aggregateAllItemData","destinationFieldName":"newMappings","options":{}},"id":"ff117f9f-4718-4c1a-b2cd-1ded50b94893","name":"Aggregate New Mappings","type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[3968,0]},{"parameters":{"jsCode":"// Simple statistics calculation - handles all cases\nconst items = $input.all();\n\n// Try to get upsert results\nlet totalAppointments = 0;\ntry {\n  const upsertResults = $('Aggregate Upsert Results').item.json.upsertResults || [];\n  totalAppointments = upsertResults.length;\n} catch (e) {\n  console.log('Could not get upsert results, using input count');\n  totalAppointments = items.length;\n}\n\n// Try to get mappings created (optional)\nlet mappingsCreated = 0;\ntry {\n  const newMappings = items[0]?.json?.newMappings || [];\n  mappingsCreated = newMappings.filter(m => m.practitioner_id && m.village).length;\n} catch (e) {\n  console.log('No new mappings (this is normal for group classes without practitioners)');\n}\n\nconsole.log('================================');\nconsole.log('‚úÖ SYNC COMPLETE');\nconsole.log('================================');\nconsole.log(`üìä Total appointments synced: ${totalAppointments}`);\nconsole.log(`üìç New village mappings created: ${mappingsCreated}`);\n\nreturn [{ \n  json: { \n    sync_complete: true,\n    total_appointments: totalAppointments,\n    mappings_created: mappingsCreated,\n    status: 'success',\n    completed_at: new Date().toISOString()\n  } \n}];"},"id":"9c3eb95a-c273-43c6-a977-485f67022bd8","name":"Calculate Final Statistics","type":"n8n-nodes-base.code","typeVersion":2,"position":[4192,0]},{"parameters":{"operation":"executeQuery","query":"-- Update sync metadata with completion time\nUPDATE sync_metadata \nSET \n  last_sync_time = CURRENT_TIMESTAMP,\n  last_sync_completed = CURRENT_TIMESTAMP,\n  records_synced = records_synced + {{ $json.total_appointments || 0 }}\nWHERE sync_key = 'cliniko_group_appointments'\nRETURNING *;","options":{}},"id":"5f43da4c-42a8-4242-97ec-2159aed81313","name":"Update Sync Metadata","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[4400,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Schedule Trigger - Every Hour":{"main":[[{"node":"Log Sync Start","type":"main","index":0}]]},"Log Sync Start":{"main":[[{"node":"Get Last Sync Time","type":"main","index":0}]]},"Get Last Sync Time":{"main":[[{"node":"Prepare Sync Parameters","type":"main","index":0}]]},"Prepare Sync Parameters":{"main":[[{"node":"Fetch First Page from Cliniko","type":"main","index":0}]]},"Fetch First Page from Cliniko":{"main":[[{"node":"Generate Page Numbers","type":"main","index":0}]]},"Generate Page Numbers":{"main":[[{"node":"Fetch All Pages","type":"main","index":0}]]},"Fetch All Pages":{"main":[[{"node":"Aggregate All Pages","type":"main","index":0}]]},"Aggregate All Pages":{"main":[[{"node":"Extract and Process Group Appointments","type":"main","index":0}]]},"Extract and Process Group Appointments":{"main":[[{"node":"Upsert Group Appointments to Postgres","type":"main","index":0}]]},"Upsert Group Appointments to Postgres":{"main":[[{"node":"Aggregate Upsert Results","type":"main","index":0}]]},"Aggregate Upsert Results":{"main":[[{"node":"Extract Unique Practitioner-Business Mappings","type":"main","index":0}]]},"Extract Unique Practitioner-Business Mappings":{"main":[[{"node":"Get Existing Village Mappings","type":"main","index":0}]]},"Get Existing Village Mappings":{"main":[[{"node":"Check Which Practitioners Need Village Lookup","type":"main","index":0}]]},"Check Which Practitioners Need Village Lookup":{"main":[[{"node":"Fetch Practitioner Details from Cliniko","type":"main","index":0}]]},"Fetch Practitioner Details from Cliniko":{"main":[[{"node":"Fetch Business Details from Cliniko","type":"main","index":0}]]},"Fetch Business Details from Cliniko":{"main":[[{"node":"Combine Practitioner and Business Data","type":"main","index":0}]]},"Combine Practitioner and Business Data":{"main":[[{"node":"Auto-Create Village Mappings","type":"main","index":0}]]},"Auto-Create Village Mappings":{"main":[[{"node":"Aggregate New Mappings","type":"main","index":0}]]},"Aggregate New Mappings":{"main":[[{"node":"Calculate Final Statistics","type":"main","index":0}]]},"Calculate Final Statistics":{"main":[[{"node":"Update Sync Metadata","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Schedule Trigger - Every Hour":{"recurrenceRules":[]}},"meta":null,"pinData":{},"versionId":"0a658ed2-3665-48f5-83bd-f15ddbf2925d","triggerCount":1,"shared":[{"updatedAt":"2025-11-13T02:21:26.203Z","createdAt":"2025-11-13T02:21:26.203Z","role":"workflow:owner","workflowId":"4BNjjIutyf9CQfUF","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-13T09:55:20.056Z","createdAt":"2025-11-13T07:19:36.025Z","id":"eK9YGjAyJ5AD3bv1","name":"Weekly Group Class Performance Report","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"weeks","triggerAtHour":2}]}},"id":"c9398874-4e4b-4edc-8efc-853be309fe56","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1,"position":[80,32]},{"parameters":{"operation":"executeQuery","query":"-- CORRECTED WEEKLY GROUP CLASS PERFORMANCE REPORT\n-- Uses existing table structure: cliniko_id and name (not appointment_type_id and type_name)\n\nWITH village_performance AS (\n  SELECT \n    COALESCE(b.village_name, ga.business_id, 'Unknown') as village_name,\n    ga.business_id,\n    COUNT(*) as total_classes,\n    SUM(ga.max_attendees) as total_capacity,\n    SUM(ga.attendee_count) as total_enrolled,\n    ROUND(100.0 * SUM(ga.attendee_count) / NULLIF(SUM(ga.max_attendees), 0), 1) as utilization_pct,\n    SUM(ga.max_attendees) - SUM(ga.attendee_count) as empty_seats,\n    COUNT(*) FILTER (WHERE ga.attendee_count > ga.max_attendees) as waitlist_classes\n  FROM group_appointments ga\n  LEFT JOIN businesses b ON ga.business_id = b.business_id\n  WHERE ga.starts_at > NOW() \n    AND ga.starts_at < NOW() + INTERVAL '30 days'\n    AND ga.is_cancelled = false\n  GROUP BY ga.business_id, b.village_name\n),\nunderutilized AS (\n  SELECT \n    COALESCE(at.name, ga.appointment_type_id, 'Unknown Class') as class_name,\n    COALESCE(b.village_name, ga.business_id, 'Unknown Village') as village_name,\n    ga.appointment_type_id,\n    ga.business_id,\n    COUNT(*) as occurrences,\n    AVG(ga.max_attendees)::INTEGER as avg_capacity,\n    AVG(ga.attendee_count)::INTEGER as avg_enrolled,\n    ROUND(100.0 * AVG(ga.attendee_count) / NULLIF(AVG(ga.max_attendees), 0), 1) as utilization,\n    (AVG(ga.max_attendees) - AVG(ga.attendee_count))::INTEGER * COUNT(*) as wasted_capacity\n  FROM group_appointments ga\n  LEFT JOIN appointment_types at ON ga.appointment_type_id = at.cliniko_id\n  LEFT JOIN businesses b ON ga.business_id = b.business_id\n  WHERE ga.starts_at > NOW() \n    AND ga.starts_at < NOW() + INTERVAL '60 days'\n    AND ga.is_cancelled = false\n  GROUP BY ga.appointment_type_id, at.name, ga.business_id, b.village_name\n  HAVING AVG(ga.attendee_count) / NULLIF(AVG(ga.max_attendees), 0) < 0.5\n  ORDER BY wasted_capacity DESC\n  LIMIT 5\n),\nwaitlist_opps AS (\n  SELECT \n    COALESCE(at.name, ga.appointment_type_id, 'Unknown Class') as class_name,\n    COALESCE(b.village_name, ga.business_id, 'Unknown Village') as village_name,\n    ga.appointment_type_id,\n    ga.business_id,\n    COUNT(*) as times_over,\n    AVG(ga.attendee_count - ga.max_attendees)::INTEGER as avg_waitlist\n  FROM group_appointments ga\n  LEFT JOIN appointment_types at ON ga.appointment_type_id = at.cliniko_id\n  LEFT JOIN businesses b ON ga.business_id = b.business_id\n  WHERE ga.starts_at > NOW() \n    AND ga.starts_at < NOW() + INTERVAL '60 days'\n    AND ga.is_cancelled = false\n    AND ga.attendee_count > ga.max_attendees\n  GROUP BY ga.appointment_type_id, at.name, ga.business_id, b.village_name\n  ORDER BY avg_waitlist DESC\n  LIMIT 5\n),\nsummary AS (\n  SELECT \n    COUNT(*) as total_classes,\n    COUNT(DISTINCT appointment_type_id) as class_types,\n    COUNT(DISTINCT business_id) as villages,\n    SUM(max_attendees) as capacity,\n    SUM(attendee_count) as enrolled,\n    ROUND(100.0 * SUM(attendee_count) / NULLIF(SUM(max_attendees), 0), 1) as utilization,\n    SUM(max_attendees) - SUM(attendee_count) as empty_seats,\n    COUNT(*) FILTER (WHERE attendee_count > max_attendees) as waitlist_classes\n  FROM group_appointments\n  WHERE starts_at > NOW() \n    AND starts_at < NOW() + INTERVAL '30 days'\n    AND is_cancelled = false\n)\nSELECT \n  json_build_object(\n    'report_date', TO_CHAR(CURRENT_DATE, 'YYYY-MM-DD'),\n    'summary', (SELECT row_to_json(summary.*) FROM summary),\n    'village_performance', (SELECT json_agg(row_to_json(vp.*)) FROM village_performance vp),\n    'underutilized', (SELECT json_agg(row_to_json(u.*)) FROM underutilized u),\n    'waitlist_opportunities', (SELECT json_agg(row_to_json(w.*)) FROM waitlist_opps w)\n  ) as report_data;","options":{}},"id":"6e2ef523-7f09-421e-b1e1-6ddf18a6296a","name":"Generate Report Data","type":"n8n-nodes-base.postgres","typeVersion":2,"position":[288,32],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// ENHANCED FORMAT HTML EMAIL CODE\n// WITH READABLE VILLAGE AND CLASS NAMES\n\nconst data = $input.item.json.report_data;\nconst summary = data.summary;\nconst villages = data.village_performance || [];\nconst underutilized = data.underutilized || [];\nconst waitlist = data.waitlist_opportunities || [];\n\n// Helper function to format performance indicator\nfunction performanceIcon(utilization) {\n  if (utilization >= 80) return 'üî• Excellent';\n  if (utilization >= 60) return '‚úÖ Good';\n  if (utilization >= 40) return '‚ö†Ô∏è Fair';\n  return '‚ùå Poor';\n}\n\n// Build HTML\nconst html = `\n<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }\n    h1 { color: #2c5aa0; border-bottom: 3px solid #2c5aa0; padding-bottom: 10px; }\n    h2 { color: #2c5aa0; margin-top: 30px; border-left: 4px solid #2c5aa0; padding-left: 10px; }\n    .summary-box { background: #f0f7ff; border: 2px solid #2c5aa0; border-radius: 8px; padding: 20px; margin: 20px 0; }\n    .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }\n    .metric { text-align: center; }\n    .metric-value { font-size: 32px; font-weight: bold; color: #2c5aa0; }\n    .metric-label { font-size: 14px; color: #666; text-transform: uppercase; }\n    table { width: 100%; border-collapse: collapse; margin: 20px 0; }\n    th { background: #2c5aa0; color: white; padding: 12px; text-align: left; font-weight: bold; }\n    td { padding: 10px; border-bottom: 1px solid #ddd; }\n    tr:hover { background: #f5f5f5; }\n    .insight-box { background: #fff9e6; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; }\n    .footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #ddd; font-size: 12px; color: #666; }\n  </style>\n</head>\n<body>\n  <h1>üìä Group Class Performance Report</h1>\n  <p><strong>Report Period:</strong> Next 30 Days | <strong>Generated:</strong> ${new Date().toLocaleDateString('en-AU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>\n  \n  <div class=\"summary-box\">\n    <h2 style=\"margin-top: 0;\">üìà Executive Summary</h2>\n    <div class=\"summary-grid\">\n      <div class=\"metric\">\n        <div class=\"metric-value\">${summary.total_classes}</div>\n        <div class=\"metric-label\">Total Classes</div>\n      </div>\n      <div class=\"metric\">\n        <div class=\"metric-value\">${summary.enrolled}</div>\n        <div class=\"metric-label\">Total Enrolled</div>\n      </div>\n      <div class=\"metric\">\n        <div class=\"metric-value\">${summary.utilization}%</div>\n        <div class=\"metric-label\">Utilization</div>\n      </div>\n      <div class=\"metric\">\n        <div class=\"metric-value\">${summary.capacity}</div>\n        <div class=\"metric-label\">Total Capacity</div>\n      </div>\n      <div class=\"metric\">\n        <div class=\"metric-value\">${summary.empty_seats}</div>\n        <div class=\"metric-label\">Empty Seats</div>\n      </div>\n      <div class=\"metric\">\n        <div class=\"metric-value\">${summary.waitlist_classes}</div>\n        <div class=\"metric-label\">Waitlist Classes</div>\n      </div>\n    </div>\n  </div>\n\n  <h2>üèòÔ∏è Village Performance Scorecard</h2>\n  <table>\n    <thead>\n      <tr>\n        <th>Village</th>\n        <th>Classes</th>\n        <th>Capacity</th>\n        <th>Enrolled</th>\n        <th>Utilization</th>\n        <th>Empty Seats</th>\n        <th>Performance</th>\n      </tr>\n    </thead>\n    <tbody>\n      ${villages.map(v => `\n        <tr>\n          <td><strong>${v.village_name}</strong></td>\n          <td>${v.total_classes}</td>\n          <td>${v.total_capacity}</td>\n          <td>${v.total_enrolled}</td>\n          <td><strong>${v.utilization_pct}%</strong></td>\n          <td>${v.empty_seats}</td>\n          <td>${performanceIcon(v.utilization_pct)}</td>\n        </tr>\n      `).join('')}\n    </tbody>\n  </table>\n\n  ${underutilized.length > 0 ? `\n    <h2>üí∞ Revenue Opportunity: Underutilized Classes</h2>\n    <p>Classes running below 50% capacity - consider consolidation or increased marketing:</p>\n    <table>\n      <thead>\n        <tr>\n          <th>Class Type</th>\n          <th>Village</th>\n          <th>Occurrences</th>\n          <th>Avg Capacity</th>\n          <th>Avg Enrolled</th>\n          <th>Utilization</th>\n          <th>Wasted Capacity</th>\n        </tr>\n      </thead>\n      <tbody>\n        ${underutilized.map(u => `\n          <tr>\n            <td><strong>${u.class_name}</strong></td>\n            <td>${u.village_name}</td>\n            <td>${u.occurrences}</td>\n            <td>${u.avg_capacity}</td>\n            <td>${u.avg_enrolled}</td>\n            <td>${u.utilization}%</td>\n            <td><strong>${u.wasted_capacity} seats</strong></td>\n          </tr>\n        `).join('')}\n      </tbody>\n    </table>\n  ` : '<p>‚úÖ No significantly underutilized classes found.</p>'}\n\n  ${waitlist.length > 0 ? `\n    <h2>üöÄ Growth Opportunity: Waitlist Demand</h2>\n    <p>Classes consistently over-enrolled - consider adding more sessions:</p>\n    <table>\n      <thead>\n        <tr>\n          <th>Class Type</th>\n          <th>Village</th>\n          <th>Times Over Capacity</th>\n          <th>Avg Waitlist Size</th>\n        </tr>\n      </thead>\n      <tbody>\n        ${waitlist.map(w => `\n          <tr>\n            <td><strong>${w.class_name}</strong></td>\n            <td>${w.village_name}</td>\n            <td>${w.times_over}</td>\n            <td><strong>${w.avg_waitlist} people</strong></td>\n          </tr>\n        `).join('')}\n      </tbody>\n    </table>\n  ` : '<p>‚ÑπÔ∏è No waitlist pressure detected.</p>'}\n\n  <div class=\"insight-box\">\n    <h3 style=\"margin-top: 0;\">üí° Key Insights</h3>\n    <ul>\n      <li><strong>Overall Utilization:</strong> ${summary.utilization}% - ${performanceIcon(summary.utilization)}</li>\n      <li><strong>Empty Seats:</strong> ${summary.empty_seats} seats available (${Math.round(summary.empty_seats / 30)} per day average)</li>\n      ${summary.waitlist_classes > 0 ? `<li><strong>High Demand:</strong> ${summary.waitlist_classes} classes have waitlists - expansion opportunity!</li>` : ''}\n      ${underutilized.length > 0 ? `<li><strong>Revenue Leak:</strong> ${underutilized.length} class types consistently under 50% - review needed</li>` : ''}\n    </ul>\n  </div>\n\n  <div class=\"footer\">\n    <p><strong>Reignite Health - Group Class Analytics</strong></p>\n    <p>This report analyzes the next 30 days of scheduled group classes. Data synced hourly from Cliniko.</p>\n    <p>Questions? Contact your system administrator.</p>\n  </div>\n</body>\n</html>\n`;\n\nreturn [{\n  json: {\n    html: html,\n    subject: `üìä Weekly Class Performance Report - ${new Date().toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' })}`,\n    summary: summary,\n    report_date: data.report_date\n  }\n}];"},"id":"de114130-0484-4a22-ab5e-b7942e0b4498","name":"Format HTML Email","type":"n8n-nodes-base.code","typeVersion":2,"position":[480,32]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO workflow_execution_log (\n  workflow_name,\n  execution_date,\n  status,\n  records_processed,\n  notes\n) VALUES (\n  'Weekly Group Class Performance Report',\n  CURRENT_TIMESTAMP,\n  'success',\n  {{ $('Generate Report Data').item.json.report_data.summary.total_classes }},\n  'Email sent via Gmail. Report period: {{ $('Format HTML Email').item.json.report_date }}'\n) RETURNING *;","options":{}},"id":"fae2d6f9-1128-4769-a87b-f5ff2e7cb6e9","name":"Log Execution","type":"n8n-nodes-base.postgres","typeVersion":2,"position":[880,32],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"sendTo":"peter@yesai.au","subject":"={{ $json.subject }}","message":"={{ $json.html }}","options":{}},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[720,256],"id":"9649a93e-e7c7-414c-83a0-1ae03d482459","name":"Send Gmail","webhookId":"1ccd79fa-376c-48a4-951e-1503cef20673","credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}},"continueOnFail":true}],"connections":{"Schedule Trigger":{"main":[[{"node":"Generate Report Data","type":"main","index":0}]]},"Generate Report Data":{"main":[[{"node":"Format HTML Email","type":"main","index":0}]]},"Format HTML Email":{"main":[[{"node":"Send Gmail","type":"main","index":0}]]},"Send Gmail":{"main":[[{"node":"Log Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"27fc017d-195c-4ca5-a8ba-65341210c071","triggerCount":1,"shared":[{"updatedAt":"2025-11-13T07:19:36.025Z","createdAt":"2025-11-13T07:19:36.025Z","role":"workflow:owner","workflowId":"eK9YGjAyJ5AD3bv1","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-30T07:31:40.560Z","createdAt":"2025-11-13T19:00:05.510Z","id":"ifBGaq7tVYIQiz1o","name":"RetellAI - Get Directions & Class Contacts v1.4 CACHE","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-directions","responseMode":"responseNode","options":{}},"id":"81c941e1-d03d-426b-bccb-b2ebb77b8e3c","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"get-directions"},{"parameters":{"jsCode":"// Extract request data\nconst req = $('Webhook').first();\nconst webhookData = req?.json?.body || req?.json || {};\nconst args = webhookData.args || webhookData;\n\nconst norm = (s) => String(s ?? '').trim().toLowerCase();\nconst requestedVillage = norm(args.village || args.village_name || args.site || '');\nconst classRaw = norm(args.class_type || args.class || args.program || '');\nconst callId = String(args.call_id || webhookData.call_id || '');\n\n// Map class aliases\nconst aliasMap = [\n  { a: ['consult room','consult','clinic','physio','consultation'], k: 'consult_room' },\n  { a: ['better balance','balance','bb'], k: 'better_balance' },\n  { a: ['aqua','pool','hydro'], k: 'aqua' },\n  { a: ['gym fit','gymfit','gym'], k: 'gymfit' },\n  { a: ['ep','exercise phys','exercise physiology','group class','class','ep class'], k: 'ep_class' }\n];\n\nfunction mapClass(s){ \n  if(!s) return 'consult_room'; \n  for(const {a,k} of aliasMap){ \n    if(a.some(v => s.includes(v))) return k; \n  } \n  return 'consult_room'; \n}\n\nconst classType = mapClass(classRaw);\n\nreturn [{\n  json: {\n    village: requestedVillage,\n    class_type: classType,\n    call_id: callId,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"extract-request-001","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"documentId":{"__rl":true,"value":"13EaXjEQKRye-hWmtHAMnDmKJgwp34O2iGk-ldwqm9uI","mode":"id"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/13EaXjEQKRye-hWmtHAMnDmKJgwp34O2iGk-ldwqm9uI/edit#gid=0"},"options":{}},"id":"5fce0314-b850-4de7-ac48-eb6ea2048b81","name":"Google Sheets - Read Villages","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[448,0],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"jsCode":"// STANDARD EXTRACTION PATTERN - RetellAI Compatible\nconst requestData = $items(\"Extract Request Data\")[0].json;\nconst requestedVillage = requestData.village;\nconst classType = requestData.class_type;\nconst callId = requestData.call_id;\n\nconst rows = $input.all().map(it => it.json);\nif(!rows.length) return [{ json: { found: false, message: 'No village data found', call_id: callId, timestamp: new Date().toISOString() } }];\n\nfunction pick(row, candidates){ const keys = Object.keys(row || {}); for(const cand of candidates){ const k = keys.find(K => K.toLowerCase() === String(cand).toLowerCase()); if(k && String(row[k] ?? '').trim()) return String(row[k]).trim(); } return ''; }\n\nfunction classAddress(row, cls){\n  const cols = { consult_room: ['consult_room_location'], better_balance: ['better_balance_location'], aqua: ['aqua_location'], gymfit: ['gymfit_location'], ep_class: ['ep_class_location'] };\n  return pick(row, cols[cls] || []);\n}\n\nconst norm = (s) => String(s ?? '').trim().toLowerCase();\nconst activeYes = (r) => { const v = norm(pick(r, ['active'])); return v === '' || v === 'y' || v === 'yes' || v === 'true' || v === '1'; };\nconst filteredRows = rows.filter(activeYes);\n\nif(!requestedVillage){\n  const villages = filteredRows.map(r => { const villageName = pick(r, ['village_name']); if(!villageName) return null; return { village: villageName, contact: pick(r, ['wellness_coordinator_email']), classes: { consult_room: classAddress(r,'consult_room'), better_balance: classAddress(r,'better_balance'), aqua: classAddress(r,'aqua'), gymfit: classAddress(r,'gymfit'), ep_class: classAddress(r,'ep_class') } }; }).filter(v => v !== null);\n  return [{ json: { found: true, village_count: villages.length, villages, call_id: callId, timestamp: new Date().toISOString() } }];\n}\n\nfunction normalizeName(s){ return norm(s).replace(/\\s+/g,' ').replace(/[^\\p{L}\\p{N}\\s]/gu,''); }\nconst target = normalizeName(requestedVillage);\nlet match = null;\n\nfor(const r of filteredRows){ const n = normalizeName(pick(r, ['village_name'])); if(!n) continue; if(n.includes(target) || target.includes(n)){ match = r; break; } }\nif(!match){ const toks = target.split(' ').filter(Boolean); for(const r of filteredRows){ const n = normalizeName(pick(r, ['village_name'])); if(toks.every(t => n.includes(t))){ match = r; break; } } }\n\nif(!match) return [{ json: { found: false, requested_village: requestedVillage, message: `No village matching '${requestedVillage}'`, available_villages: filteredRows.map(r => pick(r, ['village_name'])).filter(Boolean), call_id: callId, timestamp: new Date().toISOString() } }];\n\nconst villageName = pick(match, ['village_name']);\nconst addressForClass = classAddress(match, classType);\n\nreturn [{ json: { found: !!addressForClass, village: villageName, class_type: classType, address_for_class: addressForClass, contact: pick(match, ['wellness_coordinator_email']), classes: { consult_room: classAddress(match,'consult_room'), better_balance: classAddress(match,'better_balance'), aqua: classAddress(match,'aqua'), gymfit: classAddress(match,'gymfit'), ep_class: classAddress(match,'ep_class') }, call_id: callId, timestamp: new Date().toISOString() } }];"},"id":"28befd36-9cbe-4d12-8295-59bbdbfb9faf","name":"Find Village / Class & Contacts","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"44ff5fbd-3d28-4754-abcb-8a92d785bdf6","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[896,0]}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Google Sheets - Read Villages","type":"main","index":0}]]},"Google Sheets - Read Villages":{"main":[[{"node":"Find Village / Class & Contacts","type":"main","index":0}]]},"Find Village / Class & Contacts":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"c0e4fa78-988d-4b89-ac66-4d2e24cfa05d","triggerCount":1,"shared":[{"updatedAt":"2025-11-13T19:00:05.510Z","createdAt":"2025-11-13T19:00:05.510Z","role":"workflow:owner","workflowId":"ifBGaq7tVYIQiz1o","projectId":"ePBcCsWsgvLDebw1"}],"tags":[{"updatedAt":"2025-10-25T20:46:30.687Z","createdAt":"2025-10-25T20:46:30.687Z","id":"f4oitz85OWylN1Dp","name":"RetellAI"},{"updatedAt":"2025-10-25T20:46:30.688Z","createdAt":"2025-10-25T20:46:30.688Z","id":"xOR2iXEsXC2hMCtx","name":"Webhooks"},{"updatedAt":"2025-10-03T03:47:29.353Z","createdAt":"2025-10-03T03:47:29.353Z","id":"dbO1yennvLLTWb9D","name":"Reignite"}]},{"updatedAt":"2025-11-14T01:38:36.285Z","createdAt":"2025-11-14T01:34:21.691Z","id":"4TTt07kNjHMUA7uV","name":"RetellAI - Get MAC Script v1.4 PRODUCTION","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-mac-script","responseMode":"responseNode","options":{}},"id":"ac00ebbf-9c57-433d-9db1-5012526b26f9","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"d5ada33c-bdb4-44b9-8380-381f0f14f695"},{"parameters":{"jsCode":"// Extract request data and validate\nconst webhookData = $input.item.json.body || {};\nconst args = webhookData.args || {};\nconst call = webhookData.call || {};\n\n// Get parameters\nconst call_id = call.call_id || args.call_id || 'unknown';\n\n// Return extracted data\nreturn [{\n  json: {\n    call_id,\n    start_time: Date.now(),\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"88d435c4-ba33-4025-af68-13957d696443","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM mac_script_cache WHERE cached_at > now() - interval '24 hours' ORDER BY cached_at DESC LIMIT 1;","options":{}},"id":"11e8ffd6-7288-4efc-84d1-dcb27a58ebed","name":"Check Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[448,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Handle cache hit/miss\nconst items = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// Cache hit - return cached script\nif (items.length > 0 && items[0].json.script_content) {\n  return [{\n    json: {\n      ...requestData,\n      script: items[0].json.script_content,\n      from_cache: true,\n      cached_at: items[0].json.cached_at\n    }\n  }];\n}\n\n// Cache miss - need to fetch from Google Sheets\nreturn [{\n  json: {\n    ...requestData,\n    from_cache: false\n  }\n}];"},"id":"bc2085a7-a145-4752-8d3b-b709e2f6ce0b","name":"Handle Cache","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.from_cache }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"43fcb67b-e7a1-4461-87e1-f76f347819d0","name":"Cache Hit?","type":"n8n-nodes-base.if","typeVersion":2,"position":[880,0]},{"parameters":{"url":"https://sheets.googleapis.com/v4/spreadsheets/1XZMvjpWBvzjmwFhn2wJcYVILoExtZZ0Ee7eBQNnxBKg/values/mac_script!A2:D100","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","options":{}},"id":"af0498b0-ea7a-4b1b-8314-afa123b06a50","name":"Fetch from Google Sheets","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1104,112],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"jsCode":"// Parse Google Sheets response and structure MAC script\nconst items = $input.all();\nconst requestData = $items(\"Handle Cache\")[0].json;\nconst sheetsData = items[0].json.values || [];\n\n// Build structured script from rows\nconst steps = [];\nconst sections = {};\n\nfor (const row of sheetsData) {\n  if (!row[0]) continue; // Skip empty rows\n  \n  const step = {\n    step_number: row[0],\n    script_text: row[1] || '',\n    action: row[2] || '',\n    notes: row[3] || ''\n  };\n  \n  steps.push(step);\n  \n  // Group by action type for easy access\n  const actionType = row[2] || 'general';\n  if (!sections[actionType]) {\n    sections[actionType] = [];\n  }\n  sections[actionType].push(step);\n}\n\n// Structure the complete script\nconst scriptContent = {\n  greeting: sections.greeting?.[0]?.script_text || \"Let me help you understand My Aged Care funding options.\",\n  eligibility_questions: sections.eligibility_questions?.map(s => s.script_text) || [\n    \"Are you currently receiving any government support like a Home Care Package?\",\n    \"Have you contacted My Aged Care before?\",\n    \"Do you have your MAC reference number?\"\n  ],\n  explanation: sections.explanation?.[0]?.script_text || \"My Aged Care (MAC) coordinates government-funded support for older Australians. This includes Home Care Packages that can cover exercise physiology services.\",\n  next_steps: sections.next_steps?.map(s => s.script_text) || [\n    \"Contact My Aged Care on 1800 200 422 for an assessment\",\n    \"Request exercise physiology services in your care plan\",\n    \"Once approved, we can book your first appointment\"\n  ],\n  escalation_criteria: sections.escalation?.[0]?.script_text || \"Escalate to Sara if: unclear funding status, complex care package questions, or MAC approval disputes.\",\n  all_steps: steps\n};\n\n// CRITICAL: Stringify for PostgreSQL JSONB column\nconst scriptContentJSON = JSON.stringify(scriptContent);\n\nreturn [{\n  json: {\n    ...requestData,\n    script_content: scriptContent,\n    script_content_json: scriptContentJSON,\n    from_cache: false,\n    sheet_rows_parsed: steps.length\n  }\n}];"},"id":"48e0efbf-da38-4b35-83ba-a1d3482632ce","name":"Parse Script Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[1328,112]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO mac_script_cache (script_content, cached_at)\nVALUES (\n  $${{ $json.script_content_json }}$$::jsonb,\n  CURRENT_TIMESTAMP\n)\nRETURNING *;","options":{}},"id":"d76057f5-1c75-4084-bf1e-dab9fcc03367","name":"Write to Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1552,112],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Calculate final response\nconst items = $input.all();\nconst requestData = items[0].json;\n\nconst response = {\n  success: true,\n  script: requestData.script_content || requestData.script,\n  from_cache: requestData.from_cache === true,\n  call_id: requestData.call_id,\n  timestamp: new Date().toISOString(),\n  response_time_ms: Date.now() - requestData.start_time\n};\n\nreturn [{ json: response }];"},"id":"ce1af5eb-fc1a-4a42-8450-696cfe59b980","name":"Calculate Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1760,0]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"b721f1f8-d4d0-4710-ac14-941a61e2ceea","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[1984,0]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_params,\n  response_data,\n  duration_ms,\n  cache_hit,\n  success,\n  created_at\n)\nVALUES (\n  'get-mac-script',\n  '{{ $json.call_id }}',\n  '{}',\n  '{{ $json }}',\n  {{ $json.response_time_ms }},\n  {{ $json.from_cache }},\n  {{ $json.success }},\n  CURRENT_TIMESTAMP\n)\nRETURNING *;","options":{}},"id":"c49e31bd-a5af-4805-8ba4-89cb37194e2c","name":"Log Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[2208,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Check Cache","type":"main","index":0}]]},"Check Cache":{"main":[[{"node":"Handle Cache","type":"main","index":0}]]},"Handle Cache":{"main":[[{"node":"Cache Hit?","type":"main","index":0}]]},"Cache Hit?":{"main":[[{"node":"Calculate Response","type":"main","index":0}],[{"node":"Fetch from Google Sheets","type":"main","index":0}]]},"Fetch from Google Sheets":{"main":[[{"node":"Parse Script Data","type":"main","index":0}]]},"Parse Script Data":{"main":[[{"node":"Write to Cache","type":"main","index":0}]]},"Write to Cache":{"main":[[{"node":"Calculate Response","type":"main","index":0}]]},"Calculate Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"85912e69-95da-4b95-a3e6-6c5ee9677a2b","triggerCount":1,"shared":[{"updatedAt":"2025-11-14T01:34:21.691Z","createdAt":"2025-11-14T01:34:21.691Z","role":"workflow:owner","workflowId":"4TTt07kNjHMUA7uV","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-25T08:35:53.440Z","createdAt":"2025-11-14T01:39:27.732Z","id":"SBtrayClBOrmeI0I","name":"RetellAI - Get MAC Script v1.4 PRODUCTION","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-mac-script","responseMode":"responseNode","options":{}},"id":"564a4f35-f07a-425c-9ee2-c9160aeb3516","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-1328,304],"webhookId":"49299969-8a50-47f8-85fb-54c02909897c"},{"parameters":{"jsCode":"\n// Universal Phone Normalization (Australian E.164) - v9.09\n\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n\n  // 1. Strip everything except digits and '+'\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n\n  // 2. Already in E.164 format\n  if (phone.startsWith('+')) {\n    return phone;\n  }\n\n  // 3. Handle 8-digit local numbers (Assume NSW '02')\n  if (phone.length === 8 && !phone.startsWith('+')) {\n    return '+612' + phone;\n  }\n\n  // 4. Handle standard 10-digit AU numbers (04... or 02...)\n  if (phone.length === 10 && phone.startsWith('0')) {\n    return '+61' + phone.substring(1);\n  }\n\n  // 5. Handle numbers starting with 61 (missing +)\n  if (phone.length === 11 && phone.startsWith('61')) {\n    return '+' + phone;\n  }\n\n  // 6. Assume Australian if 9 digits (missing leading 0)\n  if (phone.length === 9) {\n    return '+61' + phone;\n  }\n\n  // 7. Return cleaned version (best effort)\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n\n// Extract request data and validate\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || {};\nconst call = webhookData.call || {};\n\n// Get parameters\nconst call_id = call.call_id || args.call_id || 'unknown';\n\n// Return extracted data\nreturn [{\n  json: {\n    call_id,\n    start_time: Date.now(),\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"de42785f-9878-46a9-b61e-daa406f002ad","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1104,304]},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM mac_script_cache WHERE cached_at > now() - interval '24 hours' ORDER BY cached_at DESC LIMIT 1;","options":{}},"id":"7bc7c92a-fc5b-4d33-9959-44d02f41f9ca","name":"Check Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-880,304],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Handle cache hit/miss\nconst items = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// Cache hit - return cached script\nif (items.length > 0 && items[0].json.script_content) {\n  return [{\n    json: {\n      ...requestData,\n      script: items[0].json.script_content,\n      from_cache: true,\n      cached_at: items[0].json.cached_at\n    }\n  }];\n}\n\n// Cache miss - need to fetch from Google Sheets\nreturn [{\n  json: {\n    ...requestData,\n    from_cache: false\n  }\n}];"},"id":"b1c4e03a-11a3-46d6-b57e-cf8a50389b9c","name":"Handle Cache","type":"n8n-nodes-base.code","typeVersion":2,"position":[-672,304]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.from_cache }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"7afad715-20fa-46b5-a084-41fc1245d335","name":"Cache Hit?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-448,304]},{"parameters":{"url":"https://sheets.googleapis.com/v4/spreadsheets/1XZMvjpWBvzjmwFhn2wJcYVILoExtZZ0Ee7eBQNnxBKg/values/mac_script!A2:D100","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","options":{}},"id":"2dc082cd-3dca-4ae9-a80d-d3c4fe923781","name":"Fetch from Google Sheets","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-224,416],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"jsCode":"// Parse Google Sheets response and structure MAC script\nconst items = $input.all();\nconst requestData = $items(\"Handle Cache\")[0].json;\nconst sheetsData = items[0].json.values || [];\n\n// Build structured script from rows\nconst steps = [];\nconst sections = {};\n\nfor (const row of sheetsData) {\n  if (!row[0]) continue; // Skip empty rows\n  \n  const step = {\n    step_number: row[0],\n    script_text: row[1] || '',\n    action: row[2] || '',\n    notes: row[3] || ''\n  };\n  \n  steps.push(step);\n  \n  // Group by action type for easy access\n  const actionType = row[2] || 'general';\n  if (!sections[actionType]) {\n    sections[actionType] = [];\n  }\n  sections[actionType].push(step);\n}\n\n// Structure the complete script\nconst scriptContent = {\n  greeting: sections.greeting?.[0]?.script_text || \"Let me help you understand My Aged Care funding options.\",\n  eligibility_questions: sections.eligibility_questions?.map(s => s.script_text) || [\n    \"Are you currently receiving any government support like a Home Care Package?\",\n    \"Have you contacted My Aged Care before?\",\n    \"Do you have your MAC reference number?\"\n  ],\n  explanation: sections.explanation?.[0]?.script_text || \"My Aged Care (MAC) coordinates government-funded support for older Australians. This includes Home Care Packages that can cover exercise physiology services.\",\n  next_steps: sections.next_steps?.map(s => s.script_text) || [\n    \"Contact My Aged Care on 1800 200 422 for an assessment\",\n    \"Request exercise physiology services in your care plan\",\n    \"Once approved, we can book your first appointment\"\n  ],\n  escalation_criteria: sections.escalation?.[0]?.script_text || \"Escalate to Sara if: unclear funding status, complex care package questions, or MAC approval disputes.\",\n  all_steps: steps\n};\n\n// CRITICAL: Stringify for PostgreSQL JSONB column\nconst scriptContentJSON = JSON.stringify(scriptContent);\n\nreturn [{\n  json: {\n    ...requestData,\n    script_content: scriptContent,\n    script_content_json: scriptContentJSON,\n    from_cache: false,\n    sheet_rows_parsed: steps.length\n  }\n}];"},"id":"22411970-0cd4-4d1c-8608-3dce914180b7","name":"Parse Script Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,416]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO mac_script_cache (script_content, cached_at)\nVALUES (\n  $${{ $json.script_content_json }}$$::jsonb,\n  CURRENT_TIMESTAMP\n)\nRETURNING *;","options":{}},"id":"c6dd7fbb-1bc8-42c9-9d1e-455770b29047","name":"Write to Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[224,416],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Calculate final response\nconst items = $input.all();\nconst requestData = items[0].json;\n\n// Calculate response time safely\nconst responseTimeMs = requestData.start_time ? \n  Date.now() - requestData.start_time : 0;\n\nconst response = {\n  success: true,\n  script: requestData.script_content || requestData.script,\n  from_cache: requestData.from_cache === true,\n  call_id: requestData.call_id || 'unknown',\n  timestamp: new Date().toISOString(),\n  response_time_ms: responseTimeMs\n};\n\nreturn [{ json: response }];"},"id":"5f51e326-c36d-4396-b503-1fcece717086","name":"Calculate Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,304]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"2e7d9894-6f8a-425a-860f-70896b3f2278","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[656,304]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_params,\n  response_data,\n  duration_ms,\n  cache_hit,\n  success,\n  created_at\n)\nVALUES (\n  'get-mac-script',\n  '{{ $json.call_id }}',\n  '{}',\n  $${{ JSON.stringify($json) }}$$,\n  {{ $json.response_time_ms || 0 }},\n  {{ $json.from_cache || false }},\n  {{ $json.success || true }},\n  CURRENT_TIMESTAMP\n)\nRETURNING *;","options":{}},"id":"60ca2abf-73ef-4174-87a1-a7b3d7d8755b","name":"Log Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[880,304],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Check Cache","type":"main","index":0}]]},"Check Cache":{"main":[[{"node":"Handle Cache","type":"main","index":0}]]},"Handle Cache":{"main":[[{"node":"Cache Hit?","type":"main","index":0}]]},"Cache Hit?":{"main":[[{"node":"Calculate Response","type":"main","index":0}],[{"node":"Fetch from Google Sheets","type":"main","index":0}]]},"Fetch from Google Sheets":{"main":[[{"node":"Parse Script Data","type":"main","index":0}]]},"Parse Script Data":{"main":[[{"node":"Write to Cache","type":"main","index":0}]]},"Write to Cache":{"main":[[{"node":"Calculate Response","type":"main","index":0}]]},"Calculate Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"0500f454-69c8-4259-8970-56658766fdac","triggerCount":1,"shared":[{"updatedAt":"2025-11-14T01:39:27.732Z","createdAt":"2025-11-14T01:39:27.732Z","role":"workflow:owner","workflowId":"SBtrayClBOrmeI0I","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-24T05:10:42.829Z","createdAt":"2025-11-15T05:52:51.601Z","id":"5Zsa8R1Sc34qfJtK","name":"RetellAI - Email End of Call Summary + Sheets v4 GMAIL OAUTH","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/email-call-summary","responseMode":"responseNode","options":{}},"id":"c1c28f42-9b8a-4b17-be90-6d943ac14ef6","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"1565fad1-c77c-46bf-b164-2f40bf462708"},{"parameters":{"jsCode":"// Check if call has ended (has end_timestamp)\nconst body = $input.item.json.body || {};\nconst call = body.call || {};\n\n// Only process calls that have ended\nif (!call.end_timestamp) {\n  // Stop execution - call hasn't ended yet\n  return [];\n}\n\n// Pass through the data for ended calls\nreturn [$input.item];"},"id":"06c729b0-161e-4711-8bfd-7271142e56cb","name":"Only Process Ended Calls","type":"n8n-nodes-base.code","typeVersion":2,"position":[192,0]},{"parameters":{"operation":"executeQuery","query":"-- Check if we've already processed this call_id\n-- This prevents duplicate emails\n\nCREATE TABLE IF NOT EXISTS processed_call_emails (\n  call_id      text PRIMARY KEY,\n  processed_at timestamptz DEFAULT now(),\n  email_sent   boolean DEFAULT true\n);\n\n-- Check if this call_id exists\nSELECT \n  call_id,\n  processed_at,\n  email_sent\nFROM processed_call_emails\nWHERE call_id = '{{ $json.body.call.call_id }}'\nLIMIT 1;","options":{}},"id":"7c28718a-3485-4420-829d-d3eefb2a4f44","name":"Check If Already Processed","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[368,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Check if this call has already been processed\nconst items = $input.all();\nconst pgResult = items[0].json;\n\n// If pgResult is an array and has items, call already processed\nif (Array.isArray(pgResult) && pgResult.length > 0) {\n  // Already processed - stop execution\n  console.log('Call already processed, skipping email');\n  return [];\n}\n\n// If pgResult is an object with call_id, already processed\nif (pgResult && pgResult.call_id) {\n  console.log('Call already processed, skipping email');\n  return [];\n}\n\n// Not processed yet - continue\nreturn items;"},"id":"673b5e55-15f3-40e5-84a9-ee9540cd7a22","name":"Skip If Already Processed","type":"n8n-nodes-base.code","typeVersion":2,"position":[528,0]},{"parameters":{"operation":"executeQuery","query":"-- Mark this call as processed FIRST\n-- This ensures we don't send duplicate emails even if the workflow runs twice\n\nINSERT INTO processed_call_emails (call_id, processed_at, email_sent)\nVALUES (\n  '{{ $json.body.call.call_id }}',\n  NOW(),\n  true\n)\nON CONFLICT (call_id) DO NOTHING\nRETURNING *;","options":{}},"id":"00d99c55-bdb3-42f4-8e78-8b6fd7e8ba47","name":"Mark As Processed","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[688,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"operation":"executeQuery","query":"-- Look up transfer data AND patient info by call_id\n-- ALWAYS returns one row with complete patient info when available\n\nCREATE TABLE IF NOT EXISTS retell_calls (\n  call_id      text PRIMARY KEY,\n  phone_number text,\n  no_phone     boolean DEFAULT false,\n  from_number  text,\n  created_at   timestamptz DEFAULT now(),\n  updated_at   timestamptz DEFAULT now()\n);\n\n-- Get the call_id from webhook\nWITH call_info AS (\n  SELECT '{{ $json.body.call.call_id }}' as search_call_id\n),\n-- Look for transfer (from Sara's tool)\ntransfer_lookup AS (\n  SELECT *\n  FROM retell_transfers\n  WHERE call_id = (SELECT search_call_id FROM call_info)\n  ORDER BY created_at DESC\n  LIMIT 1\n),\n-- Look for retell_calls entry (from Lookup Caller tool at start of call)\nretell_call_lookup AS (\n  SELECT *\n  FROM retell_calls\n  WHERE call_id = (SELECT search_call_id FROM call_info)\n  LIMIT 1\n),\n-- Look up patient by phone number\npatient_lookup AS (\n  SELECT\n    patient_id,\n    first_name,\n    last_name,\n    preferred_name,\n    email,\n    phone,\n    phone_mobile,\n    date_of_birth,\n    village,\n    archived\n  FROM patients\n  WHERE archived = false\n    AND (\n      phone_normalized = (SELECT phone_number FROM retell_call_lookup)\n      OR phone_mobile_normalized = (SELECT phone_number FROM retell_call_lookup)\n    )\n  LIMIT 1\n)\n-- ALWAYS return one row with merged data\nSELECT\n  -- Transfer fields (from Sara's tool)\n  t.transfer_id,\n  COALESCE(t.call_id, ci.search_call_id) as call_id,\n  t.created_at as transfer_created_at,\n  t.updated_at as transfer_updated_at,\n  \n  -- Caller info: prefer transfer, fallback to patient lookup\n  COALESCE(\n    t.caller_name,\n    CONCAT(p.first_name, ' ', p.last_name)\n  ) as caller_name,\n  \n  COALESCE(t.village, p.village) as village,\n  \n  COALESCE(\n    t.patient_id,\n    p.patient_id::text\n  ) as patient_id,\n  \n  -- Transfer-specific fields\n  t.phone_number as transfer_phone_number,\n  t.no_phone,\n  t.intent,\n  t.urgency,\n  t.details,\n  \n  -- retell_calls data\n  rc.phone_number AS stored_phone_number,\n  rc.no_phone AS stored_no_phone,\n  rc.from_number AS carrier_from_number,\n  \n  -- Patient data for reference\n  p.first_name,\n  p.last_name,\n  p.preferred_name,\n  p.email,\n  p.phone as patient_phone,\n  p.phone_mobile as patient_mobile,\n  p.date_of_birth,\n  p.village as patient_village\n  \nFROM call_info ci\nLEFT JOIN transfer_lookup t ON TRUE\nLEFT JOIN retell_call_lookup rc ON TRUE\nLEFT JOIN patient_lookup p ON TRUE\nLIMIT 1;","options":{"queryReplacement":""}},"id":"8a8a826b-5a64-46b9-965a-d20252cf430c","name":"Postgres Load Transfer","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[912,-176],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"const wh = $items('Webhook')?.[0]?.json || {};\nconst body = wh.body || {};\nconst call = body.call || {};\nconst pgItems = $items('Postgres Load Transfer') || [];\nconst row = pgItems.length > 0 && pgItems[0]?.json ? (Array.isArray(pgItems[0].json) ? pgItems[0].json[0] : pgItems[0].json) : {};\n\nconst esc = (s) => String(s ?? '').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[c]));\n\nfunction normAU(p) {\n  if (!p) return null;\n  let d = ('' + p).replace(/[^0-9+]/g, '');\n  if (d.startsWith('+')) return d;\n  if (d.startsWith('0')) d = '61' + d.slice(1);\n  if (!d.startsWith('61')) d = '61' + d;\n  return '+' + d;\n}\n\nfunction fmtAU(ts) {\n  if (!ts) return null;\n  const d = new Date(ts);\n  if (isNaN(d)) return null;\n  return d.toLocaleString('en-AU', { timeZone: 'Australia/Melbourne' });\n}\n\nfunction humanDuration(ms) {\n  if (ms == null || isNaN(ms)) return null;\n  const total = Math.max(0, Math.floor(Number(ms) / 1000));\n  const m = Math.floor(total / 60);\n  const s = total % 60;\n  return `${m}m ${s}s`;\n}\n\nconst metadata = call.metadata || {};\nconst analysis = call.call_analysis || {};\nconst callerName = row.caller_name || metadata.caller_name || analysis.user_name || 'Not provided';\nconst village = row.village || metadata.village || 'Not specified';\nconst intent = row.intent || metadata.intent || 'General inquiry';\nconst urgency = row.urgency || metadata.urgency || 'routine';\nconst details = row.details || metadata.details || analysis.call_summary || '';\nconst patientId = row.patient_id || metadata.patient_id || 'Not available';\nconst callId = call.call_id || 'Unknown';\nconst agentId = call.agent_id || 'N/A';\nconst agentVersion = call.agent_version || 'N/A';\nconst callStatus = call.call_status || 'unknown';\nconst direction = call.direction || 'unknown';\nconst fromPhone = normAU(row.carrier_from_number || call.from_number) || 'Not captured';\nconst toNumber = normAU(call.to_number) || 'N/A';\nlet callbackBase = (row.no_phone === true) ? null : (row.phone_number || call.from_number);\nconst callbackPhone = (row.no_phone === true) ? 'Declined to provide' : (normAU(callbackBase) || 'Not provided');\nconst startTime = fmtAU(call.start_timestamp);\nconst endTime = fmtAU(call.end_timestamp);\nconst duration = ('duration_ms' in call) ? humanDuration(call.duration_ms) : null;\nconst durationSeconds = call.call_cost?.total_duration_seconds || (call.duration_ms ? Math.floor(call.duration_ms / 1000) : 0);\nconst disconnect = call.disconnection_reason || null;\nconst processedTimestamp = new Date().toLocaleString('en-AU', { timeZone: 'Australia/Melbourne' });\nconst recordingUrl = call.recording_url || null;\n\nfunction roleLabel(r) {\n  if (!r) return 'Unknown';\n  const t = r.toLowerCase();\n  if (['assistant','agent','ai'].includes(t)) return 'Agent';\n  if (['user','caller','human'].includes(t)) return 'User';\n  return r.charAt(0).toUpperCase() + r.slice(1);\n}\n\nlet htmlTranscript = 'No transcript available';\nlet plainTranscript = 'No transcript available';\nif (Array.isArray(call.transcript_object) && call.transcript_object.length) {\n  htmlTranscript = call.transcript_object.map(t => `${esc(roleLabel(t.role))}: ${esc((t.content || '').trim())}`).join('<br><br>');\n  plainTranscript = call.transcript_object.map(t => `${roleLabel(t.role)}: ${(t.content || '').trim()}`).join('\\n\\n');\n}\n\nconst subject = `[Reignite] End of Call Summary ‚Äî ${callerName} (${duration || 'N/A'})`;\nconst td = 'style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"';\nconst th = 'style=\"padding:8px 10px;border:1px solid #e5e7eb;background:#f9fafb;text-align:left;font-weight:600;font-family:Arial,Helvetica,sans-serif;font-size:13px;line-height:18px;color:#111827\"';\n\nlet timingsRows = `<tr><td ${td}><strong>Start Time</strong></td><td ${td}>${esc(startTime || 'N/A')}</td></tr>`;\nif (endTime) timingsRows += `<tr><td ${td}><strong>End Time</strong></td><td ${td}>${esc(endTime)}</td></tr>`;\nif (duration) timingsRows += `<tr><td ${td}><strong>Duration</strong></td><td ${td}>${esc(duration)}</td></tr>`;\nif (durationSeconds > 0) timingsRows += `<tr><td ${td}><strong>Total Duration (seconds)</strong></td><td ${td}>${esc(durationSeconds)}</td></tr>`;\ntimingsRows += `<tr><td ${td}><strong>Call Status</strong></td><td ${td}>${esc(callStatus)}</td></tr>`;\nif (disconnect) timingsRows += `<tr><td ${td}><strong>Disconnection Reason</strong></td><td ${td}>${esc(disconnect)}</td></tr>`;\ntimingsRows += `<tr><td ${td}><strong>Direction</strong></td><td ${td}>${esc(direction)}</td></tr>`;\n\nlet linksBlock = '';\nif (recordingUrl) {\n  linksBlock = `<tr><td ${th} colspan=\"2\">Call Data & Links</td></tr>\n    <tr><td ${td}><strong>Recording URL</strong></td><td ${td}><a href=\"${esc(recordingUrl)}\" style=\"color:#0056b3;text-decoration:none\">${esc(recordingUrl)}</a></td></tr>`;\n}\n\nconst html = `\n  <table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\"\n         style=\"border-collapse:collapse;width:100%;max-width:780px;border:1px solid #e5e7eb\">\n    <tr><td ${th} colspan=\"2\">Caller Information</td></tr>\n    <tr><td ${td} style=\"width:240px\"><strong>Name</strong></td><td ${td}>${esc(callerName)}</td></tr>\n    <tr><td ${td}><strong>From Number (Carrier)</strong></td><td ${td}>${esc(fromPhone)}</td></tr>\n    <tr><td ${td}><strong>To Number</strong></td><td ${td}>${esc(toNumber)}</td></tr>\n    <tr><td ${td}><strong>Callback Phone</strong></td><td ${td}>${esc(callbackPhone)}</td></tr>\n    <tr><td ${td}><strong>Village</strong></td><td ${td}>${esc(village)}</td></tr>\n    <tr><td ${th} colspan=\"2\">Booking Details</td></tr>\n    <tr><td ${td}><strong>Intent</strong></td><td ${td}>${esc(intent)}</td></tr>\n    <tr><td ${td}><strong>Urgency</strong></td><td ${td}>${esc(urgency)}</td></tr>\n    <tr><td ${td}><strong>Patient ID</strong></td><td ${td}>${esc(patientId)}</td></tr>\n    <tr><td ${td}><strong>Details</strong></td><td ${td}>${esc(details)}</td></tr>\n    <tr><td ${th} colspan=\"2\">Call Timings & Status</td></tr>\n    ${timingsRows}\n    ${linksBlock}\n    <tr><td ${th} colspan=\"2\">Transcript</td></tr>\n    <tr><td ${td} colspan=\"2\" style=\"background:#fff\">${htmlTranscript}</td></tr>\n    <tr><td ${th} colspan=\"2\">Agent & System Info</td></tr>\n    <tr><td ${td} style=\"width:240px\"><strong>Agent ID</strong></td><td ${td}>${esc(agentId)}</td></tr>\n    <tr><td ${td}><strong>Agent Version</strong></td><td ${td}>${esc(agentVersion)}</td></tr>\n    <tr><td ${th} colspan=\"2\">Technical Details</td></tr>\n    <tr><td ${td}><strong>Call ID</strong></td><td ${td}>${esc(callId)}</td></tr>\n    <tr><td ${td}><strong>Transfer ID</strong></td><td ${td}>${esc(row.transfer_id || 'N/A')}</td></tr>\n    <tr><td ${td}><strong>Processed Timestamp</strong></td><td ${td}>${esc(processedTimestamp)}</td></tr>\n  </table>\n  <div style=\"font-family:Arial,Helvetica,sans-serif;font-size:12px;color:#6b7280;margin-top:10px\">\n    Powered by Yes AI Consultants Australia <a href=\"https://www.YesAI.au\" style=\"color:#6b7280;text-decoration:none\">www.YesAI.au</a>\n  </div>\n`;\n\nreturn [{ json: { subject, html, processedTimestamp, callerName, fromPhone, toNumber, callbackPhone, village, intent, urgency, patientId, details, startTime: startTime || '', endTime: endTime || '', duration: duration || '', durationSeconds: durationSeconds || 0, callStatus, disconnect: disconnect || '', direction, recordingUrl: recordingUrl || '', plainTranscript, agentId, agentVersion, callId, transferId: row.transfer_id || 'N/A' } }];"},"id":"6485a585-6329-4f68-aeb5-b5ac8ad188f4","name":"Compose Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[1088,0]},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1kNx5YBa-YvPKOVutfQlXUNlU9KoB1T118g583i4gLNY","mode":"id"},"sheetName":{"__rl":true,"value":237087233,"mode":"list","cachedResultName":"Call Emails","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1kNx5YBa-YvPKOVutfQlXUNlU9KoB1T118g583i4gLNY/edit#gid=237087233"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":[],"schema":[{"id":"processedTimestamp","displayName":"processedTimestamp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"callerName","displayName":"callerName","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"fromPhone","displayName":"fromPhone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"toNumber","displayName":"toNumber","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"callbackPhone","displayName":"callbackPhone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"village","displayName":"village","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"intent","displayName":"intent","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"urgency","displayName":"urgency","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"patientId","displayName":"patientId","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"details","displayName":"details","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"startTime","displayName":"startTime","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"endTime","displayName":"endTime","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"duration","displayName":"duration","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"durationSeconds","displayName":"durationSeconds","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"callStatus","displayName":"callStatus","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"disconnect","displayName":"disconnect","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"direction","displayName":"direction","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"recordingUrl","displayName":"recordingUrl","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"plainTranscript","displayName":"plainTranscript","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"agentId","displayName":"agentId","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"agentVersion","displayName":"agentVersion","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"callId","displayName":"callId","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"transferId","displayName":"transferId","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}]},"options":{}},"id":"bb0184d0-7ede-4578-90c8-161f348b38f3","name":"Append to Google Sheets","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[1328,0],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"sendTo":"peter@yesai.au","subject":"={{ $json.subject }}","message":"={{ $json.html }}","options":{}},"id":"8bcd7444-6ee1-4c42-a72b-b41e0765121f","name":"Send Email via Gmail","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[1568,0],"webhookId":"03f07ea5-ec64-46a4-aed9-0f7fc9d34f70","credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}},{"parameters":{"jsCode":"return [\n  {\n    json: {\n      success: true,\n      message: 'Email sent and logged successfully',\n      call_id: $items('Webhook')[0].json.body.call.call_id,\n      timestamp: new Date().toISOString()\n    }\n  }\n];"},"id":"256171da-7a47-4716-a01a-a6aff91a70d6","name":"Success Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1808,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"c9128cc0-a90c-43c5-a50c-74add1753dca","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2048,0]}],"connections":{"Webhook":{"main":[[{"node":"Only Process Ended Calls","type":"main","index":0}]]},"Only Process Ended Calls":{"main":[[{"node":"Check If Already Processed","type":"main","index":0}]]},"Check If Already Processed":{"main":[[{"node":"Skip If Already Processed","type":"main","index":0}]]},"Skip If Already Processed":{"main":[[{"node":"Mark As Processed","type":"main","index":0}]]},"Mark As Processed":{"main":[[{"node":"Postgres Load Transfer","type":"main","index":0}]]},"Postgres Load Transfer":{"main":[[{"node":"Compose Data","type":"main","index":0}]]},"Compose Data":{"main":[[{"node":"Append to Google Sheets","type":"main","index":0}]]},"Append to Google Sheets":{"main":[[{"node":"Send Email via Gmail","type":"main","index":0}]]},"Send Email via Gmail":{"main":[[{"node":"Success Response","type":"main","index":0}]]},"Success Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"339142d0-7042-49cc-8795-a2bf6b70f192","triggerCount":1,"shared":[{"updatedAt":"2025-11-15T05:52:51.601Z","createdAt":"2025-11-15T05:52:51.601Z","role":"workflow:owner","workflowId":"5Zsa8R1Sc34qfJtK","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-23T11:03:48.649Z","createdAt":"2025-11-15T20:28:44.919Z","id":"nT1RYHhe0mqagt83","name":"SMS to Mobile Message v1.4","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/send-sms","responseMode":"responseNode","options":{}},"id":"1055d058-7ea1-426e-82e9-d8c5b0769911","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"sms-webhook-001"},{"parameters":{"jsCode":"// Extract SMS parameters from webhook request\n// Fixed v1.4 - Enhanced parameter extraction with multiple fallback paths\nconst webhookData = $input.item.json.body || $input.item.json || {};\n\n// Try multiple possible data structures\nconst args = webhookData.args || webhookData.parameters || webhookData;\nconst call = webhookData.call || {};\n\n// Enhanced parameter extraction with multiple fallback paths\n// RetellAI can send data in different formats depending on how the tool is configured\nlet to = args.to_phone || args.to || args.phone || args.phone_number || \n         webhookData.to_phone || webhookData.to || webhookData.phone;\n\nlet message = args.message || args.sms_message || args.text || args.body ||\n              webhookData.message || webhookData.sms_message || webhookData.text;\n\nconst sender = args.sender || args.from || webhookData.sender || '61412111000';\nconst call_id = call.call_id || args.call_id || webhookData.call_id || 'unknown';\n\n// Debug logging - log what we received if parameters are missing\nif (!to || !message) {\n  console.log('DEBUG - Received webhook data:', JSON.stringify(webhookData, null, 2));\n  console.log('DEBUG - Extracted args:', JSON.stringify(args, null, 2));\n}\n\n// Validate required parameters\nif (!to) {\n  throw new Error(`Missing required parameter: to_phone, to, phone, or phone_number. Received data: ${JSON.stringify(Object.keys(webhookData))}`);\n}\n\nif (!message) {\n  throw new Error(`Missing required parameter: message, sms_message, text, or body. Received data: ${JSON.stringify(Object.keys(webhookData))}`);\n}\n\n// Clean phone number - remove any non-digits and validate\nto = to.toString().replace(/\\D/g, '');\n\n// Validate phone number format\nif (!to.match(/^\\d{10,15}$/)) {\n  throw new Error(`Invalid phone number format: ${to}. Use format: 61412345678 (10-15 digits, numbers only)`);\n}\n\n// Validate message length (SMS limit is 160 chars standard, 918 for concatenated)\nif (message.length > 918) {\n  throw new Error(`Message too long: ${message.length} characters. Maximum 918 characters.`);\n}\n\nreturn [{\n  json: {\n    to,\n    message,\n    sender,\n    call_id,\n    start_time: Date.now(),\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"9fddcda2-29d2-4103-9647-f6e45d5759c9","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[208,0]},{"parameters":{"url":"=https://api.mobilemessage.com.au/simple/send-sms?api_username=03KnC9&api_password=TthH29CLiQ7S8Jd22jMq4UWr16YgtuJBPgjMNX23faP&sender={{ $json.sender }}&to={{ $json.to }}&message={{ encodeURIComponent($json.message) }}","options":{}},"id":"776c3c0a-5b40-4f19-9ea1-2944e504448b","name":"Send SMS","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[432,0]},{"parameters":{"jsCode":"// Format response for RetellAI\nconst items = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\nconst smsResponse = items[0].json;\n\n// Calculate execution time\nconst executionTime = Date.now() - requestData.start_time;\n\n// Check if SMS was sent successfully\nconst success = smsResponse && !smsResponse.error;\n\nreturn [{\n  json: {\n    success: success,\n    to: requestData.to,\n    message_length: requestData.message.length,\n    sender: requestData.sender,\n    call_id: requestData.call_id,\n    sms_response: smsResponse,\n    execution_time_ms: executionTime,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"ecff7c98-e51a-43d2-8f48-135a8963a014","name":"Calculate Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[656,0]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"f54ed0cc-5cda-4454-b3d7-5af05f9d9499","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[880,0]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_params,\n  response_data,\n  success,\n  duration_ms,\n  error_code,\n  created_at\n) VALUES (\n  'send-sms',\n  '{{ $json.call_id }}',\n  '{{ JSON.stringify({to: $json.to, message_length: $json.message_length, sender: $json.sender}) }}',\n  '{{ JSON.stringify($json) }}',\n  {{ $json.success }},\n  {{ $json.execution_time_ms }},\n  {{ $json.success ? 'NULL' : \"'SMS_SEND_FAILED'\" }},\n  now()\n) RETURNING *;","options":{}},"id":"e910bdac-b9cd-4a1e-b139-78ede574664e","name":"Log Execution","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[1088,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Send SMS","type":"main","index":0}]]},"Send SMS":{"main":[[{"node":"Calculate Result","type":"main","index":0}]]},"Calculate Result":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"7d77ed98-756c-4b11-a74e-01377536d877","triggerCount":1,"shared":[{"updatedAt":"2025-11-15T20:28:44.919Z","createdAt":"2025-11-15T20:28:44.919Z","role":"workflow:owner","workflowId":"nT1RYHhe0mqagt83","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-24T05:10:41.951Z","createdAt":"2025-11-16T00:21:08.154Z","id":"kkg8YzL6nK2JXaRm","name":"RetellAI - Create or Get Patient v2.6 PHONE FORMATTING","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/create-new-client","responseMode":"responseNode","options":{}},"id":"50a759a4-7a34-4111-892a-432d72fe93bd","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-1104,112],"webhookId":"create-new-client"},{"parameters":{"jsCode":"\n// Universal Phone Normalization (Australian E.164) - v9.09\n\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n\n  // 1. Strip everything except digits and '+'\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n\n  // 2. Already in E.164 format\n  if (phone.startsWith('+')) {\n    return phone;\n  }\n\n  // 3. Handle 8-digit local numbers (Assume NSW '02')\n  if (phone.length === 8 && !phone.startsWith('+')) {\n    return '+612' + phone;\n  }\n\n  // 4. Handle standard 10-digit AU numbers (04... or 02...)\n  if (phone.length === 10 && phone.startsWith('0')) {\n    return '+61' + phone.substring(1);\n  }\n\n  // 5. Handle numbers starting with 61 (missing +)\n  if (phone.length === 11 && phone.startsWith('61')) {\n    return '+' + phone;\n  }\n\n  // 6. Assume Australian if 9 digits (missing leading 0)\n  if (phone.length === 9) {\n    return '+61' + phone;\n  }\n\n  // 7. Return cleaned version (best effort)\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n\nconst webhookData = $input.item.json.body || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\nconst first_name = (args.first_name || '').trim();\nconst last_name = (args.last_name || '').trim();\nconst phone = (args.phone || '').trim();\nconst village = (args.village || '').trim();\nconst email = (args.email || '').trim();\nconst dob = (args.dob || args.date_of_birth || '').trim();\nconst confirmed_by_caller = args.confirmed_by_caller || false;\nconst call_id = call.call_id || args.call_id || '';\n\nif (!first_name) throw new Error('first_name required');\nif (!last_name) throw new Error('last_name required');\nif (!phone) throw new Error('phone required');\n\n// Normalize phone to match database format\nlet normalized_phone = phone.replace(/\\D/g, '');\nif (normalized_phone.startsWith('0')) {\n  normalized_phone = '61' + normalized_phone.slice(1);\n}\nif (!normalized_phone.startsWith('61') && !normalized_phone.startsWith('+')) {\n  normalized_phone = '61' + normalized_phone;\n}\nif (!normalized_phone.startsWith('+')) {\n  normalized_phone = '+' + normalized_phone;\n}\n\nreturn [{\n  json: {\n    first_name,\n    last_name,\n    phone: normalized_phone,\n    village,\n    email,\n    dob,\n    confirmed_by_caller,\n    call_id,\n    start_time: Date.now()\n  }\n}];"},"id":"7a58dc34-2959-4cdf-87f1-c3dc60cb31ae","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-880,112]},{"parameters":{"operation":"executeQuery","query":"SELECT \n  patient_id,\n  first_name,\n  last_name,\n  preferred_name,\n  phone_normalized,\n  phone_mobile_normalized,\n  village,\n  date_of_birth::text as date_of_birth\nFROM patients\nWHERE \n  first_name ILIKE '{{ $json.first_name }}'\n  AND last_name ILIKE '{{ $json.last_name }}'\n  AND archived = false\nLIMIT 10","options":{}},"id":"ae734e43-5161-48e3-a618-025f82bde66e","name":"Search Local Database","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-656,112],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"const items = $input.all();\nconst req = $items('Extract Request Data')[0].json;\n\nif (items.length === 0 || !items[0].json.patient_id) {\n  return [{\n    json: {\n      ...req,\n      found: false,\n      patient_exists: false\n    }\n  }];\n}\n\nconst searchPhone = req.phone;\nconst searchVillage = (req.village || '').trim().toLowerCase();\nconst searchDOB = req.dob;\nconst confirmedByCaller = req.confirmed_by_caller;\n\n// FIX: Extract date without timezone conversion\nfunction formatDOB(dob) {\n  if (!dob) return null;\n  \n  // If it's already in YYYY-MM-DD format, return as-is\n  if (typeof dob === 'string' && /^\\d{4}-\\d{2}-\\d{2}$/.test(dob)) {\n    return dob;\n  }\n  \n  // If it's an ISO timestamp string, extract just the date part\n  if (typeof dob === 'string' && dob.includes('T')) {\n    return dob.split('T')[0];  // \"1974-01-19T13:00:00.000Z\" ‚Üí \"1974-01-19\"\n  }\n  \n  // Fallback: try Date object (but this has timezone issues)\n  const d = new Date(dob);\n  if (isNaN(d.getTime())) return null;\n  return d.toISOString().split('T')[0];\n}\n\nconst formattedSearchDOB = formatDOB(searchDOB);\n\n// PRIORITY 1: Phone + Caller Confirmation\nif (confirmedByCaller) {\n  for (const item of items) {\n    const patient = item.json;\n    if (patient.phone_normalized === searchPhone || patient.phone_mobile_normalized === searchPhone) {\n      return [{\n        json: {\n          ...req,\n          found: true,\n          patient_exists: true,\n          patient_id: patient.patient_id.toString(),\n          patient_name: `${patient.first_name} ${patient.last_name}`,\n          is_new: false,\n          matched_by: 'phone_with_caller_confirmation',\n          confidence: 'definitive',\n          note: 'Caller confirmed identity via phone lookup'\n        }\n      }];\n    }\n  }\n}\n\n// PRIORITY 2: Name + DOB + Village (GOLD STANDARD)\nif (formattedSearchDOB && searchVillage) {\n  for (const item of items) {\n    const patient = item.json;\n    const dbDOB = formatDOB(patient.date_of_birth);\n    const dbVillage = (patient.village || '').trim().toLowerCase();\n    \n    if (dbDOB === formattedSearchDOB && dbVillage === searchVillage) {\n      return [{\n        json: {\n          ...req,\n          found: true,\n          patient_exists: true,\n          patient_id: patient.patient_id.toString(),\n          patient_name: `${patient.first_name} ${patient.last_name}`,\n          is_new: false,\n          matched_by: 'name_dob_village',\n          confidence: 'high',\n          note: patient.phone_normalized !== searchPhone && patient.phone_mobile_normalized !== searchPhone\n            ? 'Matched by name, DOB, and village. Phone number differs (may have changed or shared household phone).'\n            : null\n        }\n      }];\n    }\n  }\n}\n\n// PRIORITY 3: Phone + Name\nfor (const item of items) {\n  const patient = item.json;\n  if (patient.phone_normalized === searchPhone || patient.phone_mobile_normalized === searchPhone) {\n    const dbVillage = (patient.village || '').trim().toLowerCase();\n    const villageDiffers = searchVillage && dbVillage && dbVillage !== searchVillage;\n    return [{\n      json: {\n        ...req,\n        found: true,\n        patient_exists: true,\n        patient_id: patient.patient_id.toString(),\n        patient_name: `${patient.first_name} ${patient.last_name}`,\n        is_new: false,\n        matched_by: 'phone_and_name',\n        confidence: 'high',\n        note: villageDiffers ? `Matched by phone and name. Village differs (database: ${patient.village}, provided: ${req.village}). Person may have moved.` : null\n      }\n    }];\n  }\n}\n\n// PRIORITY 4: Name + DOB (before village!)\nif (formattedSearchDOB) {\n  for (const item of items) {\n    const patient = item.json;\n    const dbDOB = formatDOB(patient.date_of_birth);\n    if (dbDOB === formattedSearchDOB) {\n      return [{\n        json: {\n          ...req,\n          found: true,\n          patient_exists: true,\n          patient_id: patient.patient_id.toString(),\n          patient_name: `${patient.first_name} ${patient.last_name}`,\n          is_new: false,\n          matched_by: 'name_and_dob',\n          confidence: 'medium-high',\n          note: 'Matched by name and date of birth. Phone and/or village differ.'\n        }\n      }];\n    }\n  }\n}\n\n// PRIORITY 5: Name + Village (after DOB checks!)\nif (searchVillage) {\n  for (const item of items) {\n    const patient = item.json;\n    const dbVillage = (patient.village || '').trim().toLowerCase();\n    if (dbVillage === searchVillage) {\n      return [{\n        json: {\n          ...req,\n          found: true,\n          patient_exists: true,\n          patient_id: patient.patient_id.toString(),\n          patient_name: `${patient.first_name} ${patient.last_name}`,\n          is_new: false,\n          matched_by: 'name_and_village',\n          confidence: 'medium',\n          note: 'Matched by name and village. Phone differs. Consider verifying DOB for confirmation.',\n          suggest_dob_verification: true\n        }\n      }];\n    }\n  }\n}\n\n// NO CONFIDENT MATCH\nreturn [{\n  json: {\n    ...req,\n    found: false,\n    patient_exists: false,\n    note: `Found ${items.length} patient(s) with name \"${req.first_name} ${req.last_name}\" but no confident match. ${formattedSearchDOB ? 'DOB, phone, and village don\\'t match.' : 'Provide DOB for better matching.'} Creating new patient to avoid confusion.`,\n    possible_duplicates: items.length\n  }\n}];"},"id":"65a570a8-6420-4eaa-a75d-43a0755aafcb","name":"Smart Matching v2.4 - PRIORITY ORDER FIXED","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.patient_exists }}","value2":true}]}},"id":"f5804032-e9ee-425b-97af-37deb7cc18c9","name":"Patient Exists?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-224,112]},{"parameters":{"jsCode":"// Format Australian phone numbers for Cliniko\n// Input: normalized phone (+61412111000)\n// Output: formatted for Cliniko display\n\nconst phone = $json.phone;\n\n// Remove +61 prefix and any non-digits\nlet cleaned = phone.replace(/^\\+61/, '0').replace(/\\D/g, '');\n\n// Ensure it starts with 0\nif (!cleaned.startsWith('0')) {\n  cleaned = '0' + cleaned;\n}\n\nlet formatted = '';\nlet phoneType = 'Mobile';\n\n// Mobile: 04xx xxx xxx ‚Üí \"0412 111 000\"\nif (cleaned.startsWith('04')) {\n  // Format: 0412 111 000\n  formatted = cleaned.substring(0, 4) + ' ' + \n              cleaned.substring(4, 7) + ' ' + \n              cleaned.substring(7, 10);\n  phoneType = 'Mobile';\n}\n// NSW Landline: 02 xxxx xxxx ‚Üí \"9999 9999\" (strip 02)\nelse if (cleaned.startsWith('02')) {\n  // Format: 9999 9999 (no area code for NSW)\n  const localNumber = cleaned.substring(2); // Remove 02\n  formatted = localNumber.substring(0, 4) + ' ' + \n              localNumber.substring(4, 8);\n  phoneType = 'Home';\n}\n// Other area codes: 03, 07, 08 ‚Üí \"03 9999 9999\" (keep area code)\nelse if (cleaned.startsWith('03') || cleaned.startsWith('07') || cleaned.startsWith('08')) {\n  // Format: 03 9999 9999\n  formatted = cleaned.substring(0, 2) + ' ' + \n              cleaned.substring(2, 6) + ' ' + \n              cleaned.substring(6, 10);\n  phoneType = 'Home';\n}\nelse {\n  // Fallback: just use the cleaned number\n  formatted = cleaned;\n  phoneType = 'Other';\n}\n\nreturn [{\n  json: {\n    ...$json,\n    phone_formatted: formatted,\n    phone_type: phoneType\n  }\n}];"},"id":"74eb0980-6c45-4dd2-a7c7-a77e58c66d4d","name":"Format Phone for Cliniko","type":"n8n-nodes-base.code","typeVersion":2,"position":[-112,208]},{"parameters":{"method":"POST","url":"https://api.au2.cliniko.com/v1/patients","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n (support@yr.com.au)"},{"name":"Accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"first_name\": \"{{ $json.first_name }}\",\n  \"last_name\": \"{{ $json.last_name }}\",\n  \"patient_phone_numbers\": [\n    {\n      \"phone_type\": \"{{ $json.phone_type }}\",\n      \"number\": \"{{ $json.phone_formatted }}\"\n    }\n  ],\n  \"address_3\": \"{{ $json.village || '' }}\",\n  \"email\": \"{{ $json.email || '' }}\",\n  \"date_of_birth\": \"{{ $json.dob || '' }}\",\n  \"country_code\": \"AU\"\n}","options":{}},"id":"50ed7ee9-acee-48ed-9016-a78171cdf4b5","name":"Create in Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[112,208],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"const item = $input.item.json;\nconst req = $items('Smart Matching v2.4 - PRIORITY ORDER FIXED')[0].json;\n\nif (item.id) {\n  return [{\n    json: {\n      success: true,\n      patient_id: item.id.toString(),\n      patient_name: `${item.first_name} ${item.last_name}`,\n      is_new_patient: true,\n      message: 'Created new patient in Cliniko',\n      note: req.note || 'Will be synced to local database within an hour',\n      possible_duplicates: req.possible_duplicates || 0,\n      duration_ms: Date.now() - req.start_time\n    }\n  }];\n}\n\nthrow new Error(`Cliniko creation failed: ${JSON.stringify(item)}`);"},"id":"5711cd60-efad-4b28-861d-f7e01e8f710c","name":"Build Created Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[336,208]},{"parameters":{"jsCode":"const item = $input.item.json;\n\nlet message = '';\nswitch(item.matched_by) {\n  case 'phone_with_caller_confirmation':\n    message = 'Caller confirmed identity via phone lookup';\n    break;\n  case 'name_dob_village':\n    message = 'Found by name, date of birth, and village';\n    break;\n  case 'phone_and_name':\n    message = 'Found by phone and name';\n    break;\n  case 'name_and_dob':\n    message = 'Found by name and date of birth';\n    break;\n  case 'name_and_village':\n    message = 'Found by name and village';\n    break;\n  default:\n    message = 'Found existing patient';\n}\n\nreturn [{\n  json: {\n    success: true,\n    patient_id: item.patient_id,\n    patient_name: item.patient_name,\n    is_new_patient: false,\n    matched_by: item.matched_by,\n    confidence: item.confidence,\n    message: message,\n    note: item.note || null,\n    suggest_dob_verification: item.suggest_dob_verification || false,\n    duration_ms: Date.now() - item.start_time\n  }\n}];"},"id":"9d6c447e-1fa7-4e2f-9d33-f4dd84ad1056","name":"Build Found Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"bd4b70ef-a32a-4ab9-9399-2fa1824040c6","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[560,112]}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Search Local Database","type":"main","index":0}]]},"Search Local Database":{"main":[[{"node":"Smart Matching v2.4 - PRIORITY ORDER FIXED","type":"main","index":0}]]},"Smart Matching v2.4 - PRIORITY ORDER FIXED":{"main":[[{"node":"Patient Exists?","type":"main","index":0}]]},"Patient Exists?":{"main":[[{"node":"Build Found Response","type":"main","index":0}],[{"node":"Format Phone for Cliniko","type":"main","index":0}]]},"Format Phone for Cliniko":{"main":[[{"node":"Create in Cliniko","type":"main","index":0}]]},"Create in Cliniko":{"main":[[{"node":"Build Created Response","type":"main","index":0}]]},"Build Created Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Build Found Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"a5615369-756c-43ee-86e7-b3051eeffc2b","triggerCount":1,"shared":[{"updatedAt":"2025-11-16T00:21:08.154Z","createdAt":"2025-11-16T00:21:08.154Z","role":"workflow:owner","workflowId":"kkg8YzL6nK2JXaRm","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-04T02:42:09.156Z","createdAt":"2025-11-16T07:04:05.611Z","id":"mKPdRDlJCdHDOFXN","name":"RetellAI - Lookup Caller by Phone v2.6 CACHE_NORMALIZE","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/lookup-caller-phone","responseMode":"responseNode","options":{}},"id":"webhook-main","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"lookup-caller-phone"},{"parameters":{"jsCode":"// Extract caller numbers and create cache key\nconst startTime = Date.now();\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || {};\nconst call = webhookData.call || {};\nconst hdrs = ($input.item.json.headers) || {};\n\nfunction pick(...v){ return v.find(x => typeof x === 'string' && x.trim() !== ''); }\n\nfunction normAU(p){\n  if(!p) return null;\n  let d = (''+p).replace(/[^0-9+]/g,'');\n  if(d.startsWith('+')) return d;\n  if(d.startsWith('0')) d = '61' + d.slice(1);\n  if(!d.startsWith('61')) d = '61' + d;\n  return '+' + d;\n}\n\nconst carrierRaw = pick(call.from_number, webhookData.from_number, hdrs['x-retell-phone']);\nlet spoken = args.phone_number;\n\nif(!spoken || /unknown|<caller_phone_number>|<call_id>/i.test(spoken)){\n  spoken = carrierRaw;\n}\n\nconst phone_e164 = normAU(spoken) || null;\nconst carrier_e164 = normAU(carrierRaw) || null;\nconst cache_key = phone_e164 ? `caller_phone_${phone_e164}` : null;\n\nreturn [{\n  json: {\n    phone_number: phone_e164 || (spoken || '').replace(/[\\s\\-\\(\\)]/g,''),\n    call_id: call.call_id || args.call_id || '',\n    carrier_from_number: carrierRaw || null,\n    carrier_from_number_e164: carrier_e164,\n    cache_key: cache_key,\n    request_start_time: startTime,\n    original_data: webhookData\n  }\n}];"},"id":"extract-request","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[220,0]},{"parameters":{"operation":"executeQuery","query":"SELECT id, cache_key, data, cached_at FROM webhook_cache WHERE cache_key = '{{ $json.cache_key }}' AND cached_at > NOW() - INTERVAL '24 hours' LIMIT 1;","options":{}},"id":"check-cache","name":"Check Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[440,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Handle cache result - branch on hit or miss\n// v2.6: CACHE_NORMALIZE - Ensure top-level fields exist for RetellAI response_variables\nconst cacheItems = $input.all();\nconst requestData = $('Extract Request Data').first().json;\n\nconst hasValidCache = \n  cacheItems.length > 0 &&\n  cacheItems[0].json &&\n  cacheItems[0].json.id &&\n  cacheItems[0].json.data;\n\nif (hasValidCache) {\n  const cached = cacheItems[0].json;\n  const data = typeof cached.data === 'string' ? JSON.parse(cached.data) : cached.data;\n  const duration_ms = Date.now() - requestData.request_start_time;\n  \n  // v2.6 FIX: Normalize old cache format to ensure top-level fields exist\n  // Old format had nested patient.id, patient.first_name, etc.\n  // New format requires top-level patient_id, first_name, last_name, village\n  let normalized = { ...data };\n  \n  if (data.patient && !data.patient_id) {\n    // Old format detected - extract top-level fields from nested patient object\n    normalized.patient_id = data.patient.id || null;\n    normalized.first_name = data.patient.first_name || null;\n    normalized.last_name = data.patient.last_name || null;\n    normalized.village = data.patient.village || null;\n    normalized.phone = data.patient.phone || data.patient.mobile || null;\n  }\n  \n  return [{\n    json: {\n      ...normalized,\n      from_cache: true,\n      cache_hit: true,\n      cache_key: requestData.cache_key,\n      call_id: requestData.call_id,\n      duration_ms: duration_ms,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    ...requestData,\n    from_cache: false,\n    cache_hit: false\n  }\n}];"},"id":"handle-cache","name":"Handle Cache Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[660,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"cache-hit-check","leftValue":"={{ $json.cache_hit }}","rightValue":true,"operator":{"type":"boolean","operation":"equals","singleValue":true}}],"combinator":"and"},"options":{}},"id":"cache-check-if","name":"Cache Hit?","type":"n8n-nodes-base.if","typeVersion":2,"position":[880,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-cache-hit","name":"Respond Cache Hit","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1100,-100]},{"parameters":{"operation":"executeQuery","query":"CREATE TABLE IF NOT EXISTS retell_calls (\n  call_id text PRIMARY KEY,\n  phone_number text,\n  no_phone boolean DEFAULT false,\n  from_number text,\n  created_at timestamptz DEFAULT now(),\n  updated_at timestamptz DEFAULT now()\n);\n\nINSERT INTO retell_calls (call_id, phone_number, from_number)\nVALUES (\n  '{{ $json.call_id || \"\" }}',\n  NULLIF('{{ $json.phone_number || \"\" }}',''),\n  NULLIF('{{ $json.carrier_from_number || $json.carrier_from_number_e164 || \"\" }}','')\n)\nON CONFLICT (call_id) DO UPDATE SET\n  phone_number = COALESCE(NULLIF(EXCLUDED.phone_number,''), retell_calls.phone_number),\n  from_number = COALESCE(retell_calls.from_number, NULLIF(EXCLUDED.from_number,'')),\n  updated_at = now();\n\nSELECT call_id, phone_number, from_number FROM retell_calls WHERE call_id = '{{ $json.call_id || \"\" }}';","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1100,100],"id":"upsert-call","name":"Upsert Call Record","alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"operation":"executeQuery","query":"SELECT \n  patient_id,\n  first_name,\n  last_name,\n  preferred_name,\n  email,\n  phone,\n  phone_mobile,\n  date_of_birth::text as date_of_birth,\n  village,\n  archived,\n  last_synced,\n  '{{ $('Cache Hit?').first().json.phone_number }}'::text AS phone_searched\nFROM patients\nWHERE \n  (phone_normalized = '{{ $('Cache Hit?').first().json.phone_number }}' \n   OR phone_mobile_normalized = '{{ $('Cache Hit?').first().json.phone_number }}')\n  AND archived = false\n  AND (deleted = false OR deleted IS NULL)\nLIMIT 1","options":{}},"id":"lookup-patient","name":"Postgres - Lookup Patient","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1320,100],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Build a clean response for RetellAI and prepare for caching\n// v2.5: Added top-level patient_id, first_name, last_name, village for RetellAI response_variables\nconst items = $input.all();\nconst row = items[0]?.json || {};\nconst requestData = $('Cache Hit?').first().json;\nconst phoneNumber = row.phone_searched || requestData.phone_number || null;\nconst carrierFrom = requestData.carrier_from_number || null;\nconst duration_ms = Date.now() - requestData.request_start_time;\n\nif (!row.patient_id) {\n  return [{\n    json: {\n      found: false,\n      phone_searched: phoneNumber,\n      carrier_from_number: carrierFrom,\n      message: 'No patient found with this phone number',\n      from_cache: false,\n      cache_hit: false,\n      duration_ms: duration_ms,\n      cache_key: requestData.cache_key,\n      call_id: requestData.call_id,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\nconst patient = {\n  id: row.patient_id,\n  first_name: row.first_name,\n  last_name: row.last_name,\n  full_name: [row.first_name, row.last_name].filter(Boolean).join(' '),\n  preferred_name: row.preferred_name || row.first_name || null,\n  email: row.email || null,\n  phone: row.phone || null,\n  mobile: row.phone_mobile || null,\n  dob: row.date_of_birth || null,\n  village: row.village || null,\n  is_archived: row.archived === true,\n  is_active: row.archived === false,\n  cliniko_url: row.patient_id ? `https://reignitehealth.au2.cliniko.com/patients/${row.patient_id}` : null,\n  last_synced: row.last_synced || null\n};\n\nreturn [{\n  json: {\n    found: true,\n    // TOP-LEVEL FIELDS for RetellAI response_variables mapping\n    patient_id: row.patient_id,\n    first_name: row.first_name,\n    last_name: row.last_name,\n    village: row.village,\n    phone: row.phone || row.phone_mobile,\n    // Nested patient object (for detailed access)\n    patient,\n    // Metadata\n    phone_searched: phoneNumber,\n    carrier_from_number: carrierFrom,\n    from_cache: false,\n    cache_hit: false,\n    duration_ms: duration_ms,\n    cache_key: requestData.cache_key,\n    call_id: requestData.call_id,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"transform-response","name":"Transform for RetellAI","type":"n8n-nodes-base.code","typeVersion":2,"position":[1540,100]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_cache (cache_key, data, cached_at) VALUES ('{{ $json.cache_key }}', '{{ JSON.stringify($json).replace(/'/g, \"''\") }}'::jsonb, NOW()) ON CONFLICT (cache_key) DO UPDATE SET data = EXCLUDED.data, cached_at = EXCLUDED.cached_at RETURNING *;","options":{}},"id":"store-cache","name":"Store in Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1760,100],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Extract response data from Transform node (before cache storage)\nconst transformData = $('Transform for RetellAI').first();\nif (transformData && transformData.json) {\n  return [{ json: transformData.json }];\n}\n\n// Fallback: extract from cache result\nconst result = $input.item.json;\nif (result && result.data) {\n  const data = typeof result.data === 'string' ? JSON.parse(result.data) : result.data;\n  return [{ json: data }];\n}\n\nreturn $input.all();"},"id":"prepare-response","name":"Prepare Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1980,100]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-miss","name":"Respond Cache Miss","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2200,100]}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Check Cache","type":"main","index":0}]]},"Check Cache":{"main":[[{"node":"Handle Cache Result","type":"main","index":0}]]},"Handle Cache Result":{"main":[[{"node":"Cache Hit?","type":"main","index":0}]]},"Cache Hit?":{"main":[[{"node":"Respond Cache Hit","type":"main","index":0}],[{"node":"Upsert Call Record","type":"main","index":0}]]},"Upsert Call Record":{"main":[[{"node":"Postgres - Lookup Patient","type":"main","index":0}]]},"Postgres - Lookup Patient":{"main":[[{"node":"Transform for RetellAI","type":"main","index":0}]]},"Transform for RetellAI":{"main":[[{"node":"Store in Cache","type":"main","index":0}]]},"Store in Cache":{"main":[[{"node":"Prepare Response","type":"main","index":0}]]},"Prepare Response":{"main":[[{"node":"Respond Cache Miss","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"2e2aeafe-a0e1-43cf-8a95-0eff8298b103","triggerCount":1,"shared":[{"updatedAt":"2025-11-16T07:04:05.611Z","createdAt":"2025-11-16T07:04:05.611Z","role":"workflow:owner","workflowId":"mKPdRDlJCdHDOFXN","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-04T00:16:16.152Z","createdAt":"2025-11-16T07:05:18.117Z","id":"NnbJfOnrOx7Vj2gf","name":"RetellAI - Lookup Caller by Name & Village v2.4 TOP_LEVEL_VARS","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/lookup-caller-name-village","responseMode":"responseNode","options":{}},"id":"41dc91e3-c2dd-422d-ab9b-a61ba84a3f91","name":"Webhook1","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"lookup-caller-name-village"},{"parameters":{"operation":"executeQuery","query":"WITH q AS (\n  SELECT\n    '{{ $json.body.args.first_name }}' AS search_first,\n    '{{ $json.body.args.last_name }}' AS search_last,\n    '{{ $json.body.args.village }}' AS search_village,\n    util.immutable_unaccent(util.lc('{{ $json.body.args.first_name }}')) AS q_first,\n    util.immutable_unaccent(util.lc('{{ $json.body.args.last_name }}')) AS q_last,\n    util.nospace(util.immutable_unaccent(util.lc('{{ $json.body.args.village }}'))) AS q_village\n),\ncand AS (\n  SELECT\n    p.patient_id, p.first_name, p.last_name, p.preferred_name,\n    p.email, p.phone, p.phone_mobile, p.date_of_birth::text as date_of_birth, p.village,\n    p.archived, p.last_synced,\n    util.immutable_unaccent(util.lc(p.first_name)) AS f_first,\n    util.immutable_unaccent(util.lc(p.last_name)) AS f_last,\n    util.nospace(util.immutable_unaccent(util.lc(coalesce(p.village,'')))) AS f_village\n  FROM patients p\n  WHERE p.archived = false\n),\nscored AS (\n  SELECT\n    c.*,\n    similarity(c.f_first, (SELECT q_first FROM q)) AS s_first,\n    similarity(c.f_last, (SELECT q_last FROM q)) AS s_last,\n    similarity(c.f_village, (SELECT q_village FROM q)) AS s_village,\n    CASE\n      WHEN GREATEST(length(c.f_first), length((SELECT q_first FROM q))) = 0 THEN 0\n      ELSE 1 - (LEAST(levenshtein(c.f_first, (SELECT q_first FROM q)),\n                      GREATEST(length(c.f_first), length((SELECT q_first FROM q))))::float\n                / GREATEST(length(c.f_first), length((SELECT q_first FROM q))))\n    END AS l_first,\n    CASE\n      WHEN GREATEST(length(c.f_last), length((SELECT q_last FROM q))) = 0 THEN 0\n      ELSE 1 - (LEAST(levenshtein(c.f_last, (SELECT q_last FROM q)),\n                      GREATEST(length(c.f_last), length((SELECT q_last FROM q))))::float\n                / GREATEST(length(c.f_last), length((SELECT q_last FROM q))))\n    END AS l_last,\n    CASE\n      WHEN GREATEST(length(c.f_village), length((SELECT q_village FROM q))) = 0 THEN 0\n      ELSE 1 - (LEAST(levenshtein(c.f_village, (SELECT q_village FROM q)),\n                      GREATEST(length(c.f_village), length((SELECT q_village FROM q))))::float\n                / GREATEST(length(c.f_village), length((SELECT q_village FROM q))))\n    END AS l_village,\n    difference(c.f_first, (SELECT q_first FROM q)) AS d_first,\n    difference(c.f_last, (SELECT q_last FROM q)) AS d_last,\n    difference(c.f_village, (SELECT q_village FROM q)) AS d_village\n  FROM cand c\n),\nresults AS (\n  SELECT\n    (SELECT search_first FROM q) AS search_first_name,\n    (SELECT search_last FROM q) AS search_last_name,\n    (SELECT search_village FROM q) AS search_village,\n    patient_id, first_name, last_name, village, email, phone, phone_mobile,\n    date_of_birth, archived,\n    s_first, l_first, d_first,\n    s_last, l_last, d_last,\n    s_village, l_village, d_village,\n    last_synced\n  FROM scored\n  WHERE\n    (\n      (s_last >= 0.50 OR l_last >= 0.65 OR d_last >= 3)\n      AND (\n        (SELECT q_village FROM q) = ''\n        OR s_village >= 0.25 OR l_village >= 0.50 OR d_village >= 3\n      )\n    )\n    AND (\n      (SELECT q_first FROM q) = ''\n      OR s_first >= 0.15 OR l_first >= 0.30 OR d_first >= 2\n    )\n  ORDER BY\n    (GREATEST(s_last, l_last)*0.55\n     + GREATEST(s_first, l_first)*0.25\n     + GREATEST(s_village, l_village)*0.15\n     + (CASE WHEN d_last >= 3 THEN 0.03 ELSE 0 END)\n     + (CASE WHEN d_first >= 3 THEN 0.01 ELSE 0 END)\n     + (CASE WHEN d_village >= 3 THEN 0.01 ELSE 0 END)\n    ) DESC,\n    last_synced DESC\n  LIMIT 5\n)\nSELECT * FROM results\nUNION ALL\nSELECT\n  (SELECT search_first FROM q) AS search_first_name,\n  (SELECT search_last FROM q) AS search_last_name,\n  (SELECT search_village FROM q) AS search_village,\n  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,\n  NULL, NULL, NULL, NULL, NULL, NULL,\n  NULL, NULL, NULL, NULL\nWHERE NOT EXISTS (SELECT 1 FROM results)\nLIMIT 6;","options":{}},"id":"cfeef43e-2a78-4158-97e5-c4dfdf1b28fd","name":"Postgres - Search Patients1","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[320,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// v2.4: Added top-level patient_id, first_name, last_name, village, phone for RetellAI response_variables\n\n// Simple transform - reads search criteria from Postgres output\nconst allItems = $input.all();\n\n// Get search criteria from first row\nlet searchCriteria = {\n  first_name: allItems[0]?.json?.search_first_name || '',\n  last_name: allItems[0]?.json?.search_last_name || '',\n  village: allItems[0]?.json?.search_village || ''\n};\n\n// Filter for actual patient results\nconst patients = allItems.filter(item => item.json.patient_id);\n\nif (patients.length === 0) {\n  return [{\n    json: {\n      found: false,\n      search_criteria: searchCriteria,\n      message: \"No matching patients found\",\n      suggestion: \"Try searching by phone number or date of birth\",\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// Format matches\nconst formattedPatients = patients.map(item => {\n  const p = item.json;\n  return {\n    id: p.patient_id,\n    first_name: p.first_name,\n    last_name: p.last_name,\n    full_name: `${p.first_name} ${p.last_name}`,\n    email: p.email || null,\n    phone: p.phone || p.phone_mobile,\n    mobile: p.phone_mobile || null,\n    dob: p.date_of_birth,\n    village: p.village || 'Unknown',\n    is_archived: p.archived === true,\n    is_active: p.archived === false,\n    cliniko_url: `https://reignitehealth.au2.cliniko.com/patients/${p.patient_id}`,\n    last_synced: p.last_synced,\n    match_scores: {\n      first_name: { similarity: p.s_first, levenshtein: p.l_first, soundex: p.d_first },\n      last_name: { similarity: p.s_last, levenshtein: p.l_last, soundex: p.d_last },\n      village: { similarity: p.s_village, levenshtein: p.l_village, soundex: p.d_village }\n    }\n  };\n});\n\n// Get best match for top-level fields (first patient in sorted results)\nconst bestMatch = formattedPatients[0];\n\nreturn [{\n  json: {\n    found: true,\n    // TOP-LEVEL FIELDS for RetellAI response_variables mapping\n    patient_id: bestMatch.id,\n    first_name: bestMatch.first_name,\n    last_name: bestMatch.last_name,\n    village: bestMatch.village,\n    phone: bestMatch.phone || bestMatch.mobile,\n    confidence_score: bestMatch.match_scores?.last_name?.similarity || 0,\n    // Nested data\n    match_count: formattedPatients.length,\n    search_criteria: searchCriteria,\n    patients: formattedPatients,\n    message: formattedPatients.length === 1 ? \"Exact match found\" : `${formattedPatients.length} potential matches found`,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"029e720d-6aa8-431d-b03d-1e23295d7843","name":"Transform for RetellAI1","type":"n8n-nodes-base.code","typeVersion":2,"position":[640,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"ce195dd5-9241-42f1-b4d9-52d81ef5ee73","name":"Respond to Webhook1","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[960,0]}],"connections":{"Webhook1":{"main":[[{"node":"Postgres - Search Patients1","type":"main","index":0}]]},"Postgres - Search Patients1":{"main":[[{"node":"Transform for RetellAI1","type":"main","index":0}]]},"Transform for RetellAI1":{"main":[[{"node":"Respond to Webhook1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"c40a874b-77a8-495c-95f2-e64108e20286","triggerCount":1,"shared":[{"updatedAt":"2025-11-16T07:05:18.117Z","createdAt":"2025-11-16T07:05:18.117Z","role":"workflow:owner","workflowId":"NnbJfOnrOx7Vj2gf","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-17T00:23:48.876Z","createdAt":"2025-11-16T21:29:08.864Z","id":"lbbschuF1KUGM8ra","name":"get-village-list v2.4 PRODUCTION - Cache Fixed","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-village-list","responseMode":"responseNode","options":{}},"id":"ae8736e0-6472-4cac-ae53-ce8abab8f727","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1328,112],"webhookId":"get-village-list"},{"parameters":{"jsCode":"// Input validation added\nconst webhookData = $input.item.json.body || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\n// Extract call_id with validation\nconst call_id = call.call_id || args.call_id || '';\n\n// Optional: Validate call_id exists (comment out if not required)\n// if (!call_id) {\n//   throw new Error('call_id is required');\n// }\n\nreturn [{\n  json: {\n    call_id,\n    timestamp: new Date().toISOString(),\n    start_time: Date.now()\n  }\n}];"},"id":"85806e5c-3fac-44c9-aac3-1399a6a0328e","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1088,32]},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM villages_cache WHERE cached_at > now() - interval '24 hours' ORDER BY cached_at DESC LIMIT 1;","options":{"queryBatching":"independently"}},"id":"c351b5ba-60ce-42fa-bdd1-77f5675265a6","name":"Check Cache","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-880,112],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// FIXED: Properly handle empty PostgreSQL results with DEBUGGING\nconst cacheItems = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\nconsole.log('DEBUG: cacheItems.length =', cacheItems.length);\nconsole.log('DEBUG: cacheItems[0] =', JSON.stringify(cacheItems[0]?.json));\n\n// Check if we actually have cache data (not just an empty row)\nconst hasValidCache = cacheItems.length > 0 && \n                      cacheItems[0].json && \n                      cacheItems[0].json.id && \n                      cacheItems[0].json.villages_data;\n\nconsole.log('DEBUG: hasValidCache =', hasValidCache);\n\nif (hasValidCache) {\n  try {\n    const cached = cacheItems[0].json;\n    const villages = JSON.parse(cached.villages_data);\n    \n    console.log('DEBUG: Returning CACHE HIT with', villages.length, 'villages');\n    \n    return [{\n      json: {\n        villages,\n        from_cache: true,\n        call_id: requestData.call_id,\n        timestamp: requestData.timestamp,\n        start_time: requestData.start_time\n      }\n    }];\n  } catch (error) {\n    console.error('Cache parse error:', error);\n  }\n}\n\n// Cache miss or error\nconsole.log('DEBUG: Returning CACHE MISS');\n\nreturn [{\n  json: {\n    villages: [],\n    from_cache: false,\n    call_id: requestData.call_id,\n    timestamp: requestData.timestamp,\n    start_time: requestData.start_time\n  }\n}];"},"id":"a10a6cd0-63ed-48c8-b2b4-5d7b782ec637","name":"Handle Cache Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"3af1a597-24dd-46a9-817a-c4fa11a155af","leftValue":"=  {{ $json.from_cache }}","rightValue":"true","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"id":"17d205ae-c175-4e7d-b9c1-40ff91ba9cd4","name":"Cache Hit?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-448,112]},{"parameters":{"documentId":{"__rl":true,"mode":"id","value":"13EaXjEQKRye-hWmtHAMnDmKJgwp34O2iGk-ldwqm9uI"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/13EaXjEQKRye-hWmtHAMnDmKJgwp34O2iGk-ldwqm9uI/edit#gid=0"},"options":{}},"id":"953d95c8-6ead-4ae3-a7d0-4b96a2da6cff","name":"Read Villages from Google Sheets","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[-224,240],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"jsCode":"// Format villages data from Google Sheets structure\nconst sheetData = $input.all();\nconst requestData = $items(\"Handle Cache Result\")[0].json;\n\n// Helper function to check if location exists (not N/A, not nan, not empty)\nfunction hasLocation(val) {\n  if (!val) return false;\n  const str = String(val).toLowerCase().trim();\n  return str !== 'n/a' && str !== 'nan' && str !== '' && !str.includes('no ');\n}\n\n// Map sheet data to village objects\nconst villages = sheetData\n  .map(row => {\n    const r = row.json;\n    \n    // Skip if no village name or not active\n    if (!r.village_name || r.active !== 'Y') return null;\n    \n    return {\n      village_name: r.village_name,\n      address: r.village_name, // Could add actual address if available\n      \n      // Location details for each facility\n      better_balance_location: r.better_balance_location || null,\n      aqua_location: r.aqua_location || null,\n      gymfit_location: r.gymfit_location || null,\n      consult_room_location: r.consult_room_location || null,\n      \n      // Boolean flags for quick checks\n      has_better_balance: hasLocation(r.better_balance_location),\n      has_aqua: hasLocation(r.aqua_location),\n      has_gymfit: hasLocation(r.gymfit_location),\n      has_consult_room: hasLocation(r.consult_room_location),\n      \n      // Wellness coordinator if available\n      wellness_coordinator_email: r.wellness_coordinator_email || null,\n      \n      // Additional info\n      notes: r.notes || null,\n      active: r.active === 'Y'\n    };\n  })\n  .filter(v => v !== null); // Remove nulls (inactive villages)\n\nreturn [{\n  json: {\n    villages,\n    villages_json: JSON.stringify(villages),\n    from_cache: false,\n    call_id: requestData.call_id,\n    timestamp: requestData.timestamp,\n    start_time: requestData.start_time\n  }\n}];"},"id":"e9e98405-d33d-4b2a-b0f4-9435cd91aea0","name":"Format Villages Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,240]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO villages_cache (villages_data, cached_at) \nVALUES ('{{ $json.villages_json.replace(/'/g, \"''\") }}'::jsonb, now()) \nRETURNING *;","options":{"queryBatching":"independently"}},"id":"5e8e588f-06dc-43bb-8418-8201dcb56cb7","name":"Write to Cache","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[224,240],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"const formatData = $items(\"Format Villages Data\")[0].json;\nreturn [{ json: { villages: formatData.villages || [], from_cache: false, call_id: formatData.call_id, timestamp: formatData.timestamp, start_time: formatData.start_time } }];"},"id":"d89afd4c-1b05-4072-ba4d-2f863f2b1048","name":"Prepare Cache Miss Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,240]},{"parameters":{"jsCode":"const input = $input.item || {};\nconst data = input.json || {};\nconst villages = Array.isArray(data.villages) ? data.villages : [];\nconst startTime = data.start_time || Date.now();\nconst duration = Math.round(Date.now() - startTime);\nreturn [{ json: { success: true, villages: villages, count: villages.length, from_cache: data.from_cache === true, call_id: data.call_id || '', timestamp: data.timestamp || new Date().toISOString(), duration_ms: duration } }];"},"id":"bad0f378-055b-442b-9102-ba363d3e91d7","name":"Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify({ success: $json.success, villages: $json.villages, count: $json.count, from_cache: $json.from_cache, timestamp: $json.timestamp }) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"ac0ee931-5db1-4c5a-af50-67398a7ef60c","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[224,0]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_log (webhook_name, call_id, request_body, response_body, success, duration_ms, cache_hit, created_at) \nVALUES (\n  'get-village-list', \n  '{{ $items(\"Format Response\")[0].json.call_id }}', \n  '{{ JSON.stringify($items(\"Extract Request Data\")[0].json).replace(/'/g, \"''\") }}'::jsonb, \n  '{{ JSON.stringify($items(\"Format Response\")[0].json).replace(/'/g, \"''\") }}'::jsonb, \n  true, \n  {{ $items(\"Format Response\")[0].json.duration_ms }}, \n  {{ $items(\"Format Response\")[0].json.from_cache }}, \n  now()\n) \nRETURNING *;","options":{"queryBatching":"independently"}},"id":"62c3c53a-f94d-48be-8b66-45b94b2756b2","name":"Log Execution","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[448,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Check Cache","type":"main","index":0}]]},"Check Cache":{"main":[[{"node":"Handle Cache Result","type":"main","index":0}]]},"Handle Cache Result":{"main":[[{"node":"Cache Hit?","type":"main","index":0}]]},"Cache Hit?":{"main":[[{"node":"Format Response","type":"main","index":0}],[{"node":"Read Villages from Google Sheets","type":"main","index":0}]]},"Read Villages from Google Sheets":{"main":[[{"node":"Format Villages Data","type":"main","index":0}]]},"Format Villages Data":{"main":[[{"node":"Write to Cache","type":"main","index":0}]]},"Write to Cache":{"main":[[{"node":"Prepare Cache Miss Data","type":"main","index":0}]]},"Prepare Cache Miss Data":{"main":[[{"node":"Format Response","type":"main","index":0}]]},"Format Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"7f70f486-54e0-44e3-b2ce-13ff6da2bb24","triggerCount":1,"shared":[{"updatedAt":"2025-11-16T21:29:08.864Z","createdAt":"2025-11-16T21:29:08.864Z","role":"workflow:owner","workflowId":"lbbschuF1KUGM8ra","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-19T17:00:41.112Z","createdAt":"2025-11-19T17:00:40.699Z","id":"BuvbkJ7vJvnq6T5V","name":"Reignite Vapi - Transfer Router","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-vapi/transfer_router","options":{}},"id":"e3f010d5-0126-4a55-b1d2-96ee1b2cb4fe","name":"Webhook - Transfer Router","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-800,192],"webhookId":"8ababa00-0391-45b7-bc22-d0a0b6384905"},{"parameters":{"dataType":"string","value1":"={{ $json.message.toolCalls[0].function.name }}","rules":{"rules":[{"value2":"transfer_to_jordan"},{"value2":"transfer_to_mary","output":1},{"value2":"transfer_to_emma","output":2},{"value2":"transfer_to_grace","output":3}]}},"id":"5c6bf3e9-3954-4e43-8470-82a768272f2e","name":"Switch - Route Tool","type":"n8n-nodes-base.switch","typeVersion":1,"position":[-592,192]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"results\": [\n    {\n      \"toolCallId\": \"{{ $json.body.message.toolCalls[0].id }}\",\n      \"result\": {\n        \"type\": \"assistant-request\",\n        \"assistant\": {\n          \"id\": \"fb5289fe-0348-4251-8995-49714e8d23c1\"\n        },\n        \"message\": {\n          \"role\": \"system\",\n          \"content\": \"The user is being transferred to you. SUMMARY: {{ $json.body.message.toolCalls[0].function.arguments.summary }}\"\n        }\n      }\n    }\n  ]\n}","options":{}},"id":"685f0c1b-a802-47c4-9dc8-b72e8e5133f5","name":"Target: Jordan","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[-304,-16]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"results\": [\n    {\n      \"toolCallId\": \"{{ $json.body.message.toolCalls[0].id }}\",\n      \"result\": {\n        \"type\": \"assistant-request\",\n        \"assistant\": {\n          \"id\": \"8929d51c-89a4-4229-9284-cd63a5932ae8\"\n        },\n        \"message\": {\n          \"role\": \"system\",\n          \"content\": \"The user is being transferred to you. SUMMARY: {{ $json.body.message.toolCalls[0].function.arguments.summary }}\"\n        }\n      }\n    }\n  ]\n}","options":{}},"id":"542c3bb0-29fa-438a-9c46-085491637d59","name":"Target: Mary","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[-304,128]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"results\": [\n    {\n      \"toolCallId\": \"{{ $json.body.message.toolCalls[0].id }}\",\n      \"result\": {\n        \"type\": \"assistant-request\",\n        \"assistant\": {\n          \"id\": \"9606b4dc-ed43-4e0a-a45a-c18846256071\"\n        },\n        \"message\": {\n          \"role\": \"system\",\n          \"content\": \"The user is being transferred to you. SUMMARY: {{ $json.body.message.toolCalls[0].function.arguments.summary }}\"\n        }\n      }\n    }\n  ]\n}","options":{}},"id":"c368aca7-99d4-4eaf-9917-534cfd9588ca","name":"Target: Emma","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[-304,272]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"results\": [\n    {\n      \"toolCallId\": \"{{ $json.body.message.toolCalls[0].id }}\",\n      \"result\": {\n        \"type\": \"assistant-request\",\n        \"assistant\": {\n          \"id\": \"933dad6e-f645-4af9-815a-11d93fee139f\"\n        },\n        \"message\": {\n          \"role\": \"system\",\n          \"content\": \"User returned from specialist. SUMMARY: {{ $json.body.message.toolCalls[0].function.arguments.summary }}\"\n        }\n      }\n    }\n  ]\n}","options":{}},"id":"c3ed1ec1-9f0a-45df-9c21-1a3a4f925a20","name":"Target: Grace","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[-304,416]}],"connections":{"Webhook - Transfer Router":{"main":[[{"node":"Switch - Route Tool","type":"main","index":0}]]},"Switch - Route Tool":{"main":[[{"node":"Target: Jordan","type":"main","index":0}],[{"node":"Target: Mary","type":"main","index":0}],[{"node":"Target: Emma","type":"main","index":0}],[{"node":"Target: Grace","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"65e96bcc-ef80-467b-af20-98aec3e0f936","triggerCount":1,"shared":[{"updatedAt":"2025-11-19T17:00:40.699Z","createdAt":"2025-11-19T17:00:40.699Z","role":"workflow:owner","workflowId":"BuvbkJ7vJvnq6T5V","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-19T20:06:46.906Z","createdAt":"2025-11-19T20:05:10.018Z","id":"QDsc8XyZk5MYOsxQ","name":"Vapi Universal Adapter - Complete Fixed","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-vapi/:tool","options":{}},"id":"df4c9df7-a975-4fba-917b-75d7521efcb2","name":"Webhook - Vapi Entry","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-736,272],"webhookId":"35687976-a481-43b1-8ada-ab8f965fd292"},{"parameters":{"jsCode":"// Get the webhook input data\nconst webhookData = $input.first().json;\n\n// Extract tool name from URL parameter\nconst toolName = webhookData.params.tool;\n\n// Extract Vapi message data\nconst message = webhookData.body.message;\nconst toolCall = message.toolCalls[0];\n\n// Parse arguments\nlet vapiArgs;\nif (typeof toolCall.function.arguments === 'string') {\n  vapiArgs = JSON.parse(toolCall.function.arguments);\n} else {\n  vapiArgs = toolCall.function.arguments;\n}\n\nconst toolCallId = toolCall.id;\nconst callData = message.call || {};\n\n// Create format for Retell webhook\nconst retellFormat = {\n  args: {\n    first_name: vapiArgs.first_name,\n    last_name: vapiArgs.last_name,\n    village: vapiArgs.village,\n    phone_number: vapiArgs.phone_number,\n    dob: vapiArgs.dob,\n    phone: vapiArgs.phone,\n    patient_id: vapiArgs.patient_id,\n    class_id: vapiArgs.class_id,\n    class_type: vapiArgs.class_type,\n    practitioner_id: vapiArgs.practitioner_id,\n    start_date: vapiArgs.start_date,\n    end_date: vapiArgs.end_date,\n    datetime: vapiArgs.datetime,\n    duration_minutes: vapiArgs.duration_minutes,\n    appointment_id: vapiArgs.appointment_id,\n    new_datetime: vapiArgs.new_datetime,\n    reason: vapiArgs.reason,\n    message_content: vapiArgs.message_content,\n    question: vapiArgs.question,\n    transfer_id: null,\n    call: {\n      from_number: callData.customer?.number || 'unknown',\n      start_timestamp: callData.startedAt || new Date().toISOString(),\n      end_timestamp: null,\n      duration_ms: 0,\n      recording_url: null,\n      transcript_object: []\n    }\n  }\n};\n\nreturn {\n  tool: toolName,\n  toolCallId: toolCallId,\n  retellBody: retellFormat,\n  originalVapiBody: webhookData.body\n};"},"id":"77b10a44-340d-436d-8776-0ea942d2fcbb","name":"Transform Vapi to Retell Format","type":"n8n-nodes-base.code","typeVersion":2,"position":[-528,272]},{"parameters":{"dataType":"string","value1":"={{ $json.tool }}","rules":{"rules":[{"value2":"lookup_caller_phone"},{"value2":"lookup_caller_name_village","output":1},{"value2":"lookup_caller_dob","output":2},{"value2":"create_new_client","output":3},{"value2":"get_directions","output":4},{"value2":"get_operating_hours","output":5},{"value2":"faq_search","output":6},{"value2":"add_to_followup","output":7},{"value2":"check_funding","output":8},{"value2":"get_mac_script","output":9},{"value2":"get_availability","output":10},{"value2":"create_appointment","output":11},{"value2":"add_to_sara_approval","output":12},{"value2":"check_phone_availability","output":13},{"value2":"store_phone_number","output":14},{"value2":"check_protected_slot","output":15},{"value2":"check_recurring_conflict","output":16},{"value2":"list_appointments","output":17},{"value2":"cancel_appointment","output":18},{"value2":"reschedule_appointment","output":19},{"value2":"get_class_schedule","output":20},{"value2":"check_class_capacity","output":21},{"value2":"enroll_class","output":22},{"value2":"check_ep_assessment","output":23},{"value2":"add_waitlist","output":24}]}},"id":"50296e8d-d3d0-4e67-961d-eba0beb00603","name":"Switch - Tool Router","type":"n8n-nodes-base.switch","typeVersion":1,"position":[-304,272]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/lookup-caller-phone","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"ede76e5a-8a9f-4ad8-a9fc-ae01179a2511","name":"Call: lookup_caller_phone","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/lookup-caller-name-village","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"e21d8f9d-5424-4a07-91db-02049f8872e3","name":"Call: lookup_caller_name_village","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,112]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/lookup-caller-dob","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"37c52fcc-c407-439c-ab1b-ccdd6237cb0e","name":"Call: lookup_caller_dob","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,208]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/create-new-client","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"a8525335-2dd7-4fd5-95d0-ff27a912de96","name":"Call: create_new_client","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,304]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/get-directions","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"9f68c824-59be-4191-90ec-79bf9d1afca6","name":"Call: get_directions","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,400]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/get-operating-hours","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"5952f446-e66a-41df-ac4c-ca2de9a04477","name":"Call: get_operating_hours","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,512]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/faq-search","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"9ab0ba19-d02d-4867-b15c-7b6adebc9a4a","name":"Call: faq_search","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,608]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/add-to-followup","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"63e999d1-dc3a-4aca-90ce-061cf41736a9","name":"Call: add_to_followup","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,704]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/check-funding","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"58ccb913-d8f3-40a8-9bdf-5a09cf936a4a","name":"Call: check_funding","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,800]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/get-mac-script","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"936146a9-f112-4e33-b497-6f16448a4dd6","name":"Call: get_mac_script","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,912]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/get-availability","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"24d2499e-3ed5-4937-a089-fe15f7e957a0","name":"Call: get_availability","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,1008]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/create-appointment","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"fe0cae5e-cb68-42c3-a0ed-ea2065351efc","name":"Call: create_appointment","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,1104]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/add-to-sara-approval","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"8af0117d-9bd4-4f61-a5a5-16218aa3e52f","name":"Call: add_to_sara_approval","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,1200]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/check-phone-availability","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"f5834a79-af62-420b-97c4-44ba84693766","name":"Call: check_phone_availability","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,1312]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/store-phone-number","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"6fb514c4-c705-4a80-96f4-4e8a18c80a61","name":"Call: store_phone_number","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,1408]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/check-protected-slot","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"c5ff713d-d735-4b31-944c-436a61610ffa","name":"Call: check_protected_slot","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,1504]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/check-recurring-conflict","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"1d3ea50c-89df-4197-ae13-f3e8fa266c69","name":"Call: check_recurring_conflict","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,1600]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/list-appointments","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"95f17063-beb4-4f9c-85f6-700c1aa4c848","name":"Call: list_appointments","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,1712]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/cancel-appointment","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"2c5562c0-6141-492e-9199-26fa7e41c8df","name":"Call: cancel_appointment","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,1808]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/reschedule-appointment","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"04e08b6b-cb67-4158-b7b5-2b2d8a00ca06","name":"Call: reschedule_appointment","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,1904]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/get-class-schedule","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"1bb75126-75e8-4627-b196-ccb0d713c5b5","name":"Call: get_class_schedule","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,2000]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/check-class-capacity","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"6e0fa282-78be-44c1-9ef7-4faf3e4a89f1","name":"Call: check_class_capacity","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,2112]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/enroll-class","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"c5d2f502-0f53-4601-a838-d436f7da0e40","name":"Call: enroll_class","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,2208]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/check-ep-assessment","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"666a32e9-ad6e-4874-af80-c7fa5dd5e676","name":"Call: check_ep_assessment","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,2304]},{"parameters":{"method":"POST","url":"https://auto.yr.com.au/webhook/reignite-retell/add-waitlist","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.retellBody }}","options":{}},"id":"76072527-6bfb-425c-95c6-2414f7e5c6a0","name":"Call: add_waitlist","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,2400]},{"parameters":{"jsCode":"// Get the response from the Retell webhook\nconst retellResponse = $input.first().json;\n\n// Get the tool call ID from the transform node\nconst toolCallId = $('Transform Vapi to Retell Format').first().json.toolCallId;\n\n// Format response for Vapi\nconst vapiResponse = {\n  results: [\n    {\n      toolCallId: toolCallId,\n      result: retellResponse\n    }\n  ]\n};\n\nreturn vapiResponse;"},"id":"b98c758d-01b7-4a9a-9a0c-04a06ec143aa","name":"Transform Response to Vapi Format","type":"n8n-nodes-base.code","typeVersion":2,"position":[304,1200]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"7806c3c1-9729-4b72-b97d-5201607d5dbc","name":"Respond to Vapi","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[512,1200]}],"connections":{"Webhook - Vapi Entry":{"main":[[{"node":"Transform Vapi to Retell Format","type":"main","index":0}]]},"Transform Vapi to Retell Format":{"main":[[{"node":"Switch - Tool Router","type":"main","index":0}]]},"Switch - Tool Router":{"main":[[{"node":"Call: lookup_caller_phone","type":"main","index":0}],[{"node":"Call: lookup_caller_name_village","type":"main","index":0}],[{"node":"Call: lookup_caller_dob","type":"main","index":0}],[{"node":"Call: create_new_client","type":"main","index":0}]]},"Call: lookup_caller_phone":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: lookup_caller_name_village":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: lookup_caller_dob":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: create_new_client":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: get_directions":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: get_operating_hours":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: faq_search":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: add_to_followup":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: check_funding":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: get_mac_script":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: get_availability":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: create_appointment":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: add_to_sara_approval":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: check_phone_availability":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: store_phone_number":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: check_protected_slot":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: check_recurring_conflict":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: list_appointments":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: cancel_appointment":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: reschedule_appointment":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: get_class_schedule":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: check_class_capacity":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: enroll_class":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: check_ep_assessment":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Call: add_waitlist":{"main":[[{"node":"Transform Response to Vapi Format","type":"main","index":0}]]},"Transform Response to Vapi Format":{"main":[[{"node":"Respond to Vapi","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"97ecd42a-ca89-4ef0-8f60-d2ba21ddea2e","triggerCount":1,"shared":[{"updatedAt":"2025-11-19T20:05:10.018Z","createdAt":"2025-11-19T20:05:10.018Z","role":"workflow:owner","workflowId":"QDsc8XyZk5MYOsxQ","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-30T07:41:56.566Z","createdAt":"2025-11-22T01:13:21.173Z","id":"aZzlGdNlWYFNBU5m","name":"RetellAI - Check Funding Eligibility v2.8 COMPOSITE CACHE","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/check-funding","responseMode":"responseNode","options":{}},"id":"webhook-trigger","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[240,300],"webhookId":"check-funding"},{"parameters":{"jsCode":"// Extract and validate webhook data - v2.8\n// FIX: Handle both nested (body.args) and root-level arguments\nconst webhookData = $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\n// Sanitize inputs\nconst patient_id = (args.patient_id || '').trim();\nconst funding_type = (args.funding_type || '').trim().toUpperCase();\nconst call_id = call.call_id || args.call_id || 'unknown';\n\n// Validate funding_type (ALWAYS required)\nconst validFundingTypes = ['HCP', 'DVA', 'GP', 'PRIVATE', 'PHI'];\nif (!validFundingTypes.includes(funding_type)) {\n  throw new Error(\n    `Invalid funding_type: \"${funding_type}\". Must be one of: ${validFundingTypes.join(', ')}`\n  );\n}\n\n// Define funding rules (used throughout workflow)\nconst fundingRules = {\n  'HCP': { appointments_per_year: 5, requires_referral: false, gap_fee: 0, notes: 'Home Care Package funding allows 5 appointments per year' },\n  'DVA': { appointments_per_year: 999, requires_referral: true, gap_fee: 0, notes: 'DVA Gold Card - unlimited appointments with referral' },\n  'GP': { appointments_per_year: 5, requires_referral: true, gap_fee: 0, notes: 'GP Referral allows 5 appointments per year' },\n  'PRIVATE': { appointments_per_year: 999, requires_referral: false, gap_fee: 120, notes: 'Private patients pay $120 gap fee per appointment' },\n  'PHI': { appointments_per_year: 999, requires_referral: false, gap_fee: 50, notes: 'Private Health Insurance patients pay $50 gap fee' }\n};\n\nreturn [{\n  json: {\n    patient_id: patient_id || null,\n    funding_type: funding_type,\n    is_new_patient: !patient_id,\n    call_id: call_id,\n    start_time: Date.now(),\n    rules: fundingRules[funding_type]\n  }\n}];"},"id":"extract-request-data","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[460,300]},{"parameters":{"jsCode":"// Handle Patient Type - v2.8\nconst data = $json;\n\nif (data.is_new_patient) {\n  // NEW PATIENT FLOW: Policy-based eligibility only (skip cache/Cliniko)\n  return [{\n    json: {\n      success: true,\n      eligible: true,\n      funding_type: data.funding_type,\n      appointments_remaining: data.rules.appointments_per_year,\n      appointments_used: 0,\n      requires_referral: data.rules.requires_referral,\n      gap_fee: data.rules.gap_fee,\n      reason: 'New patient - no appointment history',\n      notes: data.rules.notes,\n      is_new_patient: true,\n      call_id: data.call_id,\n      from_cache: false,\n      duration_ms: Date.now() - data.start_time,\n      timestamp: new Date().toISOString(),\n      skip_to_response: true\n    }\n  }];\n}\n\n// EXISTING PATIENT FLOW: Continue to cache check\nreturn [{\n  json: {\n    ...data,\n    skip_to_response: false\n  }\n}];"},"id":"handle-patient-type","name":"Handle Patient Type","type":"n8n-nodes-base.code","typeVersion":2,"position":[680,300]},{"parameters":{"jsCode":"// Route based on skip_to_response - v2.8\n// Using Code node instead of IF node (more reliable)\nconst data = $json;\n\nif (data.skip_to_response) {\n  // New patient - go directly to response\n  return [{ json: { ...data, route: 'response' } }];\n}\n\n// Existing patient - check cache\nreturn [{ json: { ...data, route: 'cache' } }];"},"id":"route-decision","name":"Route Decision","type":"n8n-nodes-base.code","typeVersion":2,"position":[900,300]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"route-check","leftValue":"={{ $json.route }}","rightValue":"response","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"if-skip-to-response","name":"Skip to Response?","type":"n8n-nodes-base.if","typeVersion":2,"position":[1100,300]},{"parameters":{"operation":"executeQuery","query":"-- Check cache with 2-hour TTL and COMPOSITE KEY (patient_id + funding_type)\n-- v2.8 FIX: Must match BOTH patient_id AND funding_type\nSELECT \n  patient_id,\n  funding_type,\n  is_eligible,\n  remaining_appointments,\n  used_appointments,\n  needs_referral,\n  gap_fee_amount,\n  eligibility_reason,\n  additional_notes,\n  cached_at\nFROM patient_funding_cache\nWHERE patient_id = '{{ $json.patient_id }}'\n  AND funding_type = '{{ $json.funding_type }}'\n  AND cached_at > (now() - interval '2 hours')\nLIMIT 1;","options":{}},"id":"check-cache","name":"Check Cache","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[1320,420],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Handle Cache Result - v2.8\n// CRITICAL: Use Code node, not IF node, for cache checking\n// CRITICAL: Check items.length BEFORE accessing fields\n// CRITICAL: JSONB columns are already parsed (no JSON.parse needed!)\n\nconst cacheItems = $input.all();\nconst requestData = $items('Route Decision')[0].json;\n\n// Safe check: Does the array have items AND do they have valid data?\nconst hasValidCache = cacheItems.length > 0 &&\n  cacheItems[0].json &&\n  cacheItems[0].json.patient_id &&\n  cacheItems[0].json.is_eligible !== undefined;\n\nif (hasValidCache) {\n  // CACHE HIT\n  const cached = cacheItems[0].json;\n  console.log('‚úÖ CACHE HIT for patient:', cached.patient_id, 'funding:', cached.funding_type);\n  \n  return [{\n    json: {\n      success: true,\n      eligible: cached.is_eligible,\n      funding_type: cached.funding_type,\n      appointments_remaining: cached.remaining_appointments,\n      appointments_used: cached.used_appointments,\n      requires_referral: cached.needs_referral,\n      gap_fee: cached.gap_fee_amount,\n      reason: cached.eligibility_reason,\n      notes: cached.additional_notes,\n      is_new_patient: false,\n      call_id: requestData.call_id,\n      patient_id: requestData.patient_id,\n      from_cache: true,\n      duration_ms: Date.now() - requestData.start_time,\n      timestamp: new Date().toISOString(),\n      skip_to_response: true\n    }\n  }];\n}\n\n// CACHE MISS - Continue to Cliniko\nconsole.log('‚ùå CACHE MISS for patient:', requestData.patient_id, 'funding:', requestData.funding_type);\nreturn [{\n  json: {\n    ...requestData,\n    from_cache: false,\n    skip_to_response: false\n  }\n}];"},"id":"handle-cache-result","name":"Handle Cache Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[1540,420]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"cache-hit-check","leftValue":"={{ $json.skip_to_response }}","rightValue":true,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"id":"cache-hit-check","name":"Cache Hit?","type":"n8n-nodes-base.if","typeVersion":2,"position":[1760,420]},{"parameters":{"method":"GET","url":"=https://api.au2.cliniko.com/v1/individual_appointments?q[]=patient_id:={{ $json.patient_id }}&q[]=starts_at:>={{ new Date(new Date().getFullYear(), 0, 1).toISOString() }}&per_page=100","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n (support@yr.com.au)"},{"name":"Accept","value":"application/json"}]},"options":{}},"id":"fetch-from-cliniko","name":"Fetch Appointments from Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1980,540],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"jsCode":"// Calculate eligibility from Cliniko response - v2.8\nconst clinikoResponse = $input.item.json;\nconst requestData = $items('Handle Cache Result')[0].json;\n\n// Parse Cliniko response\nconst appointments = clinikoResponse.individual_appointments || [];\nconst currentYear = new Date().getFullYear();\n\n// Count appointments by funding type this year\nconst appointmentsByFunding = {};\nfor (const apt of appointments) {\n  const aptDate = new Date(apt.starts_at);\n  if (aptDate.getFullYear() === currentYear && apt.did_not_arrive === false) {\n    const funding = apt.patient_invoice_type || 'UNKNOWN';\n    appointmentsByFunding[funding] = (appointmentsByFunding[funding] || 0) + 1;\n  }\n}\n\nconst appointmentsUsed = appointmentsByFunding[requestData.funding_type] || 0;\nconst rules = requestData.rules;\nconst appointmentsRemaining = Math.max(0, rules.appointments_per_year - appointmentsUsed);\nconst eligible = appointmentsRemaining > 0;\n\nlet reason;\nif (eligible) {\n  reason = appointmentsUsed === 0 \n    ? `No ${requestData.funding_type} appointments used this year` \n    : `Patient has used ${appointmentsUsed} of ${rules.appointments_per_year} ${requestData.funding_type}-funded appointments`;\n} else {\n  reason = `Patient has used all ${rules.appointments_per_year} ${requestData.funding_type}-funded appointments this year`;\n}\n\nreturn [{\n  json: {\n    success: true,\n    eligible: eligible,\n    funding_type: requestData.funding_type,\n    appointments_remaining: appointmentsRemaining,\n    appointments_used: appointmentsUsed,\n    requires_referral: rules.requires_referral,\n    gap_fee: rules.gap_fee,\n    reason: reason,\n    notes: rules.notes,\n    is_new_patient: false,\n    call_id: requestData.call_id,\n    patient_id: requestData.patient_id,\n    from_cache: false,\n    duration_ms: Date.now() - requestData.start_time,\n    timestamp: new Date().toISOString(),\n    // Data for cache write\n    _cache_eligible: eligible,\n    _cache_remaining: appointmentsRemaining,\n    _cache_used: appointmentsUsed,\n    _cache_referral: rules.requires_referral,\n    _cache_gap: rules.gap_fee,\n    _cache_reason: reason,\n    _cache_notes: rules.notes\n  }\n}];"},"id":"calculate-eligibility","name":"Calculate Eligibility","type":"n8n-nodes-base.code","typeVersion":2,"position":[2200,540]},{"parameters":{"operation":"executeQuery","query":"-- Write to cache with UPSERT - v2.8.1\n-- FIX: Use ON CONFLICT ON CONSTRAINT for atomic upsert (handles concurrent writes)\nINSERT INTO patient_funding_cache (\n  patient_id,\n  funding_type,\n  is_eligible,\n  remaining_appointments,\n  used_appointments,\n  needs_referral,\n  gap_fee_amount,\n  eligibility_reason,\n  additional_notes,\n  cached_at\n)\nVALUES (\n  '{{ $json.patient_id }}',\n  '{{ $json.funding_type }}',\n  {{ $json._cache_eligible }},\n  {{ $json._cache_remaining }},\n  {{ $json._cache_used }},\n  {{ $json._cache_referral }},\n  {{ $json._cache_gap }},\n  '{{ $json._cache_reason.replace(/'/g, \"''\") }}',\n  '{{ $json._cache_notes.replace(/'/g, \"''\") }}',\n  now()\n)\nON CONFLICT ON CONSTRAINT unique_patient_funding\nDO UPDATE SET\n  is_eligible = EXCLUDED.is_eligible,\n  remaining_appointments = EXCLUDED.remaining_appointments,\n  used_appointments = EXCLUDED.used_appointments,\n  needs_referral = EXCLUDED.needs_referral,\n  gap_fee_amount = EXCLUDED.gap_fee_amount,\n  eligibility_reason = EXCLUDED.eligibility_reason,\n  additional_notes = EXCLUDED.additional_notes,\n  cached_at = EXCLUDED.cached_at\nRETURNING *;","options":{}},"id":"write-to-cache","name":"Write to Cache","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[2420,540],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Prepare response after cache write - v2.8\n// Pass through the calculated data (not the cache write result)\nconst calcData = $items('Calculate Eligibility')[0].json;\n\n// Remove internal cache fields before responding\nconst response = { ...calcData };\ndelete response._cache_eligible;\ndelete response._cache_remaining;\ndelete response._cache_used;\ndelete response._cache_referral;\ndelete response._cache_gap;\ndelete response._cache_reason;\ndelete response._cache_notes;\n\nreturn [{ json: response }];"},"id":"prepare-response","name":"Prepare Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[2640,540]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}"},"id":"respond-to-webhook","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2860,420]},{"parameters":{"operation":"executeQuery","query":"-- Log execution AFTER response (non-blocking) - v2.8\nINSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  duration_ms,\n  cache_hit,\n  response_data,\n  success,\n  created_at\n)\nVALUES (\n  'check-funding-v2.8',\n  '{{ $json.call_id }}',\n  {{ $json.duration_ms }},\n  {{ $json.from_cache }},\n  '{{ JSON.stringify($json).replace(/'/g, \"''\") }}'::jsonb,\n  {{ $json.success }},\n  now()\n)\nRETURNING id;","options":{}},"id":"log-execution","name":"Log Execution","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[3080,420],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Handle Patient Type","type":"main","index":0}]]},"Handle Patient Type":{"main":[[{"node":"Route Decision","type":"main","index":0}]]},"Route Decision":{"main":[[{"node":"Skip to Response?","type":"main","index":0}]]},"Skip to Response?":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}],[{"node":"Check Cache","type":"main","index":0}]]},"Check Cache":{"main":[[{"node":"Handle Cache Result","type":"main","index":0}]]},"Handle Cache Result":{"main":[[{"node":"Cache Hit?","type":"main","index":0}]]},"Cache Hit?":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}],[{"node":"Fetch Appointments from Cliniko","type":"main","index":0}]]},"Fetch Appointments from Cliniko":{"main":[[{"node":"Calculate Eligibility","type":"main","index":0}]]},"Calculate Eligibility":{"main":[[{"node":"Write to Cache","type":"main","index":0}]]},"Write to Cache":{"main":[[{"node":"Prepare Response","type":"main","index":0}]]},"Prepare Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"aeeae83e-2a11-45f1-a367-d9338add4263","triggerCount":1,"shared":[{"updatedAt":"2025-11-22T01:13:21.173Z","createdAt":"2025-11-22T01:13:21.173Z","role":"workflow:owner","workflowId":"aZzlGdNlWYFNBU5m","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-23T10:58:38.287Z","createdAt":"2025-11-23T10:09:21.351Z","id":"J81RkHFIvj7kOmXo","name":"Reignite: Retell List Upcoming Appointments v4.2","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/list-appointments","responseMode":"responseNode","options":{}},"id":"2a1e1b0f-ba50-4116-9106-446ba3759c4a","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"ddc78d3a-5efb-4335-80ff-5a2e5afe51f9"},{"parameters":{"jsCode":"// Extract webhook data (RetellAI structure)\nconst webhookData = $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || {};\nconst call = webhookData.call || {};\n\n// Sanitize patient_id (CRITICAL: trim whitespace)\nconst patientId = (args.patient_id || \"\").trim();\n\n// Validation\nif (!patientId) {\n  // Return error structure that will be caught later\n  return {\n    json: {\n      has_error: true,\n      ok: false,\n      message: \"Missing patient_id in request\",\n      error: \"Missing required parameter: patient_id\",\n      debug_info: {\n        has_args: !!args,\n        args_keys: Object.keys(args),\n        raw_patient_id: args.patient_id\n      }\n    }\n  };\n}\n\n// Build Cliniko API URL\nconst now = new Date().toISOString();\nconst filters = [\n  `patient_id:=${patientId}`,\n  `starts_at:>=${now}`,\n  `cancelled_at:!?`,\n  `deleted_at:!?`,\n  `archived_at:!?`\n];\n\nconst url = `https://api.au2.cliniko.com/v1/individual_appointments?${filters.map(f => 'q[]=' + encodeURIComponent(f)).join('&')}&sort=starts_at:asc&per_page=20`;\n\nreturn { \n  json: { \n    has_error: false,\n    url, \n    patient_id: patientId, \n    timestamp: now,\n    call_id: call.call_id || null\n  } \n};"},"id":"46d593e5-f0c4-424c-9e58-a0350ca050ea","name":"Extract & Validate","type":"n8n-nodes-base.code","typeVersion":2,"position":[240,0]},{"parameters":{"jsCode":"// Check if we have an error from validation\nconst data = $input.item.json;\n\nif (data.has_error) {\n  // Pass through the error response\n  return { json: data };\n}\n\n// No error - proceed with API call\n// Return URL for HTTP Request node\nreturn { json: data };"},"id":"a90cde59-9f3a-438e-9eb1-407d411f55c6","name":"Route Logic","type":"n8n-nodes-base.code","typeVersion":2,"position":[480,0],"alwaysOutputData":true},{"parameters":{"url":"={{ $json.url }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Accept","value":"application/json"},{"name":"User-Agent","value":"Reignite (n8n)"}]},"options":{"redirect":{"redirect":{}}}},"id":"a5264990-6108-4ef4-9b8e-6a027972155e","name":"Cliniko API","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[720,0],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"// Handle both success and error cases\nconst input = $input.item.json;\n\n// If this is a validation error passed through, return it\nif (input.has_error) {\n  return { json: input };\n}\n\n// If Cliniko API failed\nif (input.error) {\n  return {\n    json: {\n      ok: false,\n      message: \"Failed to fetch appointments from Cliniko\",\n      error: input.error,\n      count: 0,\n      appointments_summary: [],\n      appointments: []\n    }\n  };\n}\n\n// Success - format the Cliniko response\nconst buildData = $node['Extract & Validate'].json;\n\nfunction extractId(linkObj) {\n  const match = linkObj?.links?.self?.match(/\\/(\\d+)$/);\n  return match ? match[1] : null;\n}\n\nconst appointments = (input.individual_appointments || []).map(a => {\n  const practitionerId = extractId(a.practitioner);\n  const practitionerName = a.practitioner_name || 'Staff Member';\n  \n  return {\n    id: a.id,\n    starts_at: a.starts_at,\n    ends_at: a.ends_at,\n    patient_name: a.patient_name,\n    patient_id: extractId(a.patient),\n    practitioner_id: practitionerId,\n    practitioner_name: practitionerName,\n    appointment_type_id: extractId(a.appointment_type) || 'unknown',\n    business_id: extractId(a.business),\n    business_name: a.business_name || '',\n    notes: a.notes || ''\n  };\n});\n\n// Create human-readable summary (first 5 appointments)\nconst summary = appointments.slice(0, 5).map((a, i) => {\n  const start = new Date(a.starts_at);\n  return {\n    rank: i + 1,\n    id: a.id,\n    patient_name: a.patient_name,\n    practitioner: a.practitioner_name,\n    location: a.business_name,\n    date: start.toLocaleDateString('en-AU', { \n      weekday: 'long', \n      year: 'numeric', \n      month: 'long', \n      day: 'numeric' \n    }),\n    time: start.toLocaleTimeString('en-AU', { \n      hour: '2-digit', \n      minute: '2-digit',\n      hour12: true \n    })\n  };\n});\n\nreturn {\n  json: {\n    ok: true,\n    message: appointments.length ? `Found ${appointments.length} appointment(s)` : 'No appointments found',\n    count: appointments.length,\n    patient_id: buildData.patient_id,\n    appointments_summary: summary,\n    appointments: appointments\n  }\n};"},"id":"d9e3f735-93f5-4233-ae87-fe48545ddf0f","name":"Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[960,0]},{"parameters":{"options":{}},"id":"a4b1b317-3a57-43a1-9a0e-baf16c3c2beb","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[1200,0]}],"connections":{"Webhook":{"main":[[{"node":"Extract & Validate","type":"main","index":0}]]},"Extract & Validate":{"main":[[{"node":"Route Logic","type":"main","index":0}]]},"Route Logic":{"main":[[{"node":"Cliniko API","type":"main","index":0}]]},"Cliniko API":{"main":[[{"node":"Format Response","type":"main","index":0}]]},"Format Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"9453b8c0-20f6-44a9-8637-3c239e72a251","triggerCount":1,"shared":[{"updatedAt":"2025-11-23T10:09:21.351Z","createdAt":"2025-11-23T10:09:21.351Z","role":"workflow:owner","workflowId":"J81RkHFIvj7kOmXo","projectId":"ePBcCsWsgvLDebw1"}],"tags":[{"updatedAt":"2025-10-03T03:47:29.353Z","createdAt":"2025-10-03T03:47:29.353Z","id":"dbO1yennvLLTWb9D","name":"Reignite"}]},{"updatedAt":"2025-11-25T00:13:46.604Z","createdAt":"2025-11-23T10:58:48.788Z","id":"6o2woIDxuO3BI3E9","name":"Reignite: Retell List Upcoming Appointments v4.4 ARGS_AT_ROOT FIX","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/list-appointments","responseMode":"responseNode","options":{}},"id":"f0fc4500-1e75-454b-9c93-2da7d13a4601","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"ddc78d3a-5efb-4335-80ff-5a2e5afe51f9"},{"parameters":{"jsCode":"// Extract and sanitize request data (per BUILD_ERRORS guide Rule #8)\nconst webhookData = $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\n\n// Sanitize patient_id (trim whitespace)\nconst patient_id = (args.patient_id || \"\").trim();\n\n// Validate required field\nif (!patient_id) {\n  return {\n    json: {\n      has_error: true,\n      ok: false,\n      error: \"Missing required parameter: patient_id\",\n      message: \"Missing patient_id in request\",\n      debug_info: {\n        has_args: !!args,\n        args_keys: Object.keys(args),\n        raw_patient_id: args.patient_id\n      }\n    }\n  };\n}\n\n// Build Cliniko API query URL\nconst now = new Date().toISOString();\nconst filters = [\n  `patient_id:=${patient_id}`,\n  `starts_at:>=${now}`,\n  `cancelled_at:!?`,\n  `deleted_at:!?`,\n  `archived_at:!?`\n];\n\nconst url = `https://api.au2.cliniko.com/v1/individual_appointments?${filters.map(f => 'q[]=' + encodeURIComponent(f)).join('&')}&sort=starts_at:asc&per_page=20`;\n\nreturn {\n  json: {\n    has_error: false,\n    url,\n    patient_id,\n    timestamp: now\n  }\n};"},"id":"cf2fe14c-4282-405c-890a-0994c406c55f","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[208,0]},{"parameters":{"url":"={{ $json.url }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Accept","value":"application/json"},{"name":"User-Agent","value":"Reignite (n8n)"}]},"options":{"timeout":10000}},"id":"c90995f8-43db-4d9b-bd85-df11200790e1","name":"Cliniko API","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[400,0],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"// Handle API response or error\nconst extractData = $node['Extract Request Data'].json;\n\n// Check if previous node had error\nif (extractData.has_error) {\n  return { json: extractData };\n}\n\n// Check if API call failed\nif ($input.item.error) {\n  return {\n    json: {\n      ok: false,\n      error: \"Cliniko API error\",\n      message: $input.item.error.message || \"Failed to fetch appointments\",\n      patient_id: extractData.patient_id\n    }\n  };\n}\n\nconst response = $input.item.json;\n\n// Extract helper functions\nfunction extractId(linkObj) {\n  const match = linkObj?.links?.self?.match(/\\/(\\d+)$/);\n  return match ? match[1] : null;\n}\n\n// Process appointments\nconst appointments = (response.individual_appointments || []).map(a => {\n  const practitionerId = extractId(a.practitioner);\n  const practitionerName = a.practitioner_name || 'Staff Member';\n  \n  return {\n    id: a.id,\n    starts_at: a.starts_at,\n    ends_at: a.ends_at,\n    patient_name: a.patient_name,\n    patient_id: extractId(a.patient),\n    practitioner_id: practitionerId,\n    practitioner_name: practitionerName,\n    appointment_type_id: extractId(a.appointment_type) || 'unknown',\n    business_id: extractId(a.business),\n    business_name: a.business_name || '',\n    notes: a.notes || ''\n  };\n});\n\n// Create human-readable summary (first 5)\nconst summary = appointments.slice(0, 5).map((a, i) => {\n  const start = new Date(a.starts_at);\n  return {\n    rank: i + 1,\n    id: a.id,\n    patient_name: a.patient_name,\n    practitioner: a.practitioner_name,\n    location: a.business_name,\n    date: start.toLocaleDateString('en-AU', { \n      weekday: 'long', \n      year: 'numeric', \n      month: 'long', \n      day: 'numeric' \n    }),\n    time: start.toLocaleTimeString('en-AU', { \n      hour: '2-digit', \n      minute: '2-digit',\n      hour12: true \n    })\n  };\n});\n\nreturn {\n  json: {\n    ok: true,\n    message: appointments.length ? `Found ${appointments.length} appointment(s)` : 'No appointments found',\n    count: appointments.length,\n    patient_id: extractData.patient_id,\n    appointments_summary: summary,\n    appointments: appointments\n  }\n};"},"id":"d282c2ac-adcb-4a51-9cf7-0c8e8578df6c","name":"Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[608,0]},{"parameters":{"options":{}},"id":"dde220b6-0f85-4d78-ba7b-70ae2843e3b5","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[800,0]}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Cliniko API","type":"main","index":0}]]},"Cliniko API":{"main":[[{"node":"Format Response","type":"main","index":0}]]},"Format Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"8ab45927-844e-4473-94cf-c1c8333c5840","triggerCount":1,"shared":[{"updatedAt":"2025-11-23T10:58:48.788Z","createdAt":"2025-11-23T10:58:48.788Z","role":"workflow:owner","workflowId":"6o2woIDxuO3BI3E9","projectId":"ePBcCsWsgvLDebw1"}],"tags":[{"updatedAt":"2025-10-03T03:47:29.353Z","createdAt":"2025-10-03T03:47:29.353Z","id":"dbO1yennvLLTWb9D","name":"Reignite"}]},{"updatedAt":"2025-12-02T06:19:50.556Z","createdAt":"2025-11-23T11:04:01.822Z","id":"gKUoS0ETwmo1DwQi","name":"SMS to Mobile Message v1.8","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/send-sms","responseMode":"responseNode","options":{}},"id":"ea4b5492-ff5e-4404-abb4-8e7a11119b49","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"sms-webhook-001"},{"parameters":{"jsCode":"// Extract SMS parameters from webhook request\n// v1.8 - Auto-convert Australian addresses to Google Maps links (iPhone compatible)\nconst webhookData = $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData.parameters || webhookData;\nconst call = webhookData.call || {};\n\n// Parameter extraction\nlet to = args.to_phone || args.to || args.phone || args.phone_number || \n         args.recipient || args.mobile || args.number ||\n         webhookData.to_phone || webhookData.to || webhookData.phone;\n\nlet message = args.message || args.sms_message || args.text || args.body || args.content ||\n              webhookData.message || webhookData.sms_message || webhookData.text;\n\nconst sender = args.sender || args.from || webhookData.sender || '61412111000';\nconst call_id = call.call_id || args.call_id || webhookData.call_id || 'unknown';\n\n// Check nested args\nif (!to || !message) {\n  if (args.args) {\n    const nestedArgs = args.args;\n    to = to || nestedArgs.to_phone || nestedArgs.to || nestedArgs.phone || nestedArgs.phone_number;\n    message = message || nestedArgs.message || nestedArgs.sms_message || nestedArgs.text;\n  }\n}\n\nif (!to) throw new Error('Missing phone parameter.');\nif (!message) throw new Error('Missing message parameter.');\n\n// Clean phone number\nto = to.toString().replace(/\\D/g, '');\nif (!to.match(/^\\d{10,15}$/)) throw new Error('Invalid phone number format: ' + to);\n\n// ========================================\n// AUTO-CONVERT ADDRESSES TO GOOGLE MAPS LINKS\n// ========================================\nconsole.log('Original message:', message);\n\n// Australian address pattern\nconst addressPattern = /(\\d+[-\\d]*\\s+[A-Za-z]+(?:\\s+[A-Za-z]+)*\\s+(?:St|Street|Ave|Avenue|Rd|Road|Dr|Drive|Pl|Place|Ct|Court|Cres|Crescent|Blvd|Boulevard|Way|Lane|Ln|Tce|Terrace|Pde|Parade|Hwy|Highway|Cir|Circle|Loop)\\.?,?\\s+[A-Za-z]+(?:\\s+[A-Za-z]+)*\\s+(?:NSW|VIC|QLD|SA|WA|TAS|NT|ACT)\\s+\\d{4})/gi;\n\nconst matches = message.match(addressPattern);\nconsole.log('Address matches found:', matches);\n\nif (matches && matches.length > 0) {\n  for (const address of matches) {\n    // Replace spaces with + for URL (keeps commas as-is which works fine)\n    const encodedAddress = address.replace(/\\s+/g, '+');\n    const mapsLink = 'https://www.google.com/maps/place/' + encodedAddress;\n    console.log('Converting:', address, '->', mapsLink);\n    message = message.replace(address, mapsLink);\n  }\n}\n\n// Remove fake goo.gl links\nmessage = message.replace(/https:\\/\\/goo\\.gl\\/maps\\/[a-zA-Z0-9]+/g, '');\nmessage = message.replace(/\\s{2,}/g, ' ').trim();\n\nconsole.log('Final message:', message);\n\nif (message.length > 918) throw new Error('Message too long: ' + message.length);\n\nreturn [{\n  json: {\n    to,\n    message,\n    sender,\n    call_id,\n    start_time: Date.now(),\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"20cd3b1e-70b1-46cc-8a91-d3144df88852","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[208,0]},{"parameters":{"url":"=https://api.mobilemessage.com.au/simple/send-sms?api_username=03KnC9&api_password=TthH29CLiQ7S8Jd22jMq4UWr16YgtuJBPgjMNX23faP&sender={{ $json.sender }}&to={{ $json.to }}&message={{ encodeURIComponent($json.message) }}","options":{}},"id":"54080525-8388-4cd9-80c8-8adc7a6b691d","name":"Send SMS","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[432,0]},{"parameters":{"jsCode":"// Format response for RetellAI\nconst items = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\nconst smsResponse = items[0].json;\n\nconst executionTime = Date.now() - requestData.start_time;\nconst success = smsResponse && !smsResponse.error;\n\nreturn [{\n  json: {\n    success: success,\n    to: requestData.to,\n    message_length: requestData.message.length,\n    sender: requestData.sender,\n    call_id: requestData.call_id,\n    sms_response: smsResponse,\n    execution_time_ms: executionTime,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"ef0b0d76-0ce5-4a2e-a82f-e38cba9dadee","name":"Calculate Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[656,0]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"30f7b846-f3a4-4594-a73a-0dcc9ee1e6ff","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[880,0]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_params,\n  response_data,\n  success,\n  duration_ms,\n  error_code,\n  created_at\n) VALUES (\n  'send-sms',\n  '{{ ($json.call_id || \"\").toString().replace(/'/g, \"''\") }}',\n  '{{ JSON.stringify({to: $json.to, message_length: $json.message_length, sender: $json.sender}).replace(/'/g, \"''\") }}',\n  '{{ JSON.stringify($json).replace(/'/g, \"''\") }}',\n  {{ $json.success }},\n  {{ $json.execution_time_ms }},\n  {{ $json.success ? 'NULL' : \"'SMS_SEND_FAILED'\" }},\n  now()\n) RETURNING *;","options":{}},"id":"b94b154b-e35a-4b06-8447-26038e14d1c4","name":"Log Execution","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[1088,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Send SMS","type":"main","index":0}]]},"Send SMS":{"main":[[{"node":"Calculate Result","type":"main","index":0}]]},"Calculate Result":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"79d0f0df-d142-4061-9e34-9509c6362fbf","triggerCount":1,"shared":[{"updatedAt":"2025-11-23T11:04:01.822Z","createdAt":"2025-11-23T11:04:01.822Z","role":"workflow:owner","workflowId":"gKUoS0ETwmo1DwQi","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-02T05:58:17.650Z","createdAt":"2025-11-23T11:08:44.168Z","id":"2PGPPA8g98aHmcAH","name":"RetellAI - Get Class Schedule v1.2 CACHED","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-class-schedule","responseMode":"responseNode","options":{}},"id":"0df361e8-716f-4b87-8347-4bc2b5d6cc20","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-16,208],"webhookId":"get-class-schedule"},{"parameters":{"jsCode":"// Extract and validate request parameters\nconst body = $json.body || $json;\nconst args = body.args || {};\nconst call = body.call || {};\n\n// For manual testing: provide defaults\nconst class_type = args.class_type || body.class_type || 'Better Balance';\nconst village = args.village || body.village || 'Baytree';\nconst weeks_ahead = args.weeks_ahead || body.weeks_ahead || 4;\n\n// Get current date for cache key (date is part of the key)\nconst today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD\n\n// Build cache key: class_schedule_{village}_{class_type}_{date}\nconst cache_key = `class_schedule_${village.trim().toLowerCase().replace(/\\s+/g, '_')}_${class_type.trim().toLowerCase().replace(/\\s+/g, '_')}_${today}`;\n\n// Validation with helpful messages\nif (!class_type || class_type === '') {\n  throw new Error('Missing class_type. For testing, add {\"class_type\": \"Better Balance\", \"village\": \"Baytree\"} to manual trigger');\n}\n\nif (!village || village === '') {\n  throw new Error('Missing village. For testing, add {\"class_type\": \"Better Balance\", \"village\": \"Baytree\"} to manual trigger');\n}\n\nreturn [{\n  json: {\n    class_type: class_type.trim(),\n    village: village.trim(),\n    weeks_ahead: weeks_ahead,\n    cache_key: cache_key,\n    call_id: call.call_id || 'manual-test',\n    request_timestamp: new Date().toISOString(),\n    start_time: Date.now()\n  }\n}];"},"id":"8034c477-2877-4561-969a-7a526e667121","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[200,208]},{"parameters":{"operation":"executeQuery","query":"SELECT \n    id,\n    cache_key,\n    data,\n    cached_at\nFROM webhook_cache\nWHERE cache_key = '{{ $json.cache_key }}'\n  AND cached_at > NOW() - INTERVAL '2 hours'\nLIMIT 1;","options":{}},"id":"cache-check-node-001","name":"Check Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[440,208],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Handle cache check result\nconst cacheItems = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// Check if we have valid cache data\n// CRITICAL: PostgreSQL JSONB columns are already parsed - DO NOT use JSON.parse()!\nconst hasValidCache = \n  cacheItems.length > 0 && \n  cacheItems[0].json && \n  cacheItems[0].json.id && \n  cacheItems[0].json.data;\n\nif (hasValidCache) {\n  // Cache HIT - return cached data directly\n  const cached = cacheItems[0].json;\n  const cachedData = cached.data; // Already parsed! No JSON.parse needed\n  \n  // Calculate duration\n  const duration_ms = Date.now() - requestData.start_time;\n  \n  return [{\n    json: {\n      ...cachedData,\n      from_cache: true,\n      cache_hit: true,\n      cached_at: cached.cached_at,\n      duration_ms: duration_ms,\n      call_id: requestData.call_id,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// Cache MISS - proceed to fetch data\nreturn [{\n  json: {\n    ...requestData,\n    from_cache: false,\n    cache_hit: false\n  }\n}];"},"id":"handle-cache-node-001","name":"Handle Cache Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[640,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"cache-hit-condition","leftValue":"={{ $json.from_cache }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"id":"if-cache-hit-node-001","name":"Cache Hit?","type":"n8n-nodes-base.if","typeVersion":2,"position":[840,208]},{"parameters":{"operation":"executeQuery","query":"SELECT \n    appointment_type_name,\n    starts_at,\n    ends_at,\n    duration_minutes,\n    max_attendees,\n    attendee_count,\n    spaces_available,\n    village,\n    business_name,\n    is_cancelled,\n    last_synced,\n    class_type\nFROM group_appointments_with_details\nWHERE class_type ILIKE '%{{ $json.class_type }}%'\n  AND (village ILIKE '%{{ $json.village }}%' OR village = 'Unknown')\n  AND starts_at >= NOW()\n  AND starts_at <= NOW() + INTERVAL '{{ $json.weeks_ahead }} weeks'\n  AND is_cancelled = false\n  AND is_deleted = false\nORDER BY starts_at ASC\nLIMIT 10;","options":{}},"id":"89b17d9b-8885-4f5e-99b5-9df21e39f067","name":"Query Group Appointments","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1040,340],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Format response\nconst items = $input.all();\nconst requestData = $('Extract Request Data').first().json;\n\n// Calculate duration regardless of success/failure\nconst duration_ms = Date.now() - requestData.start_time;\n\nif (items.length === 0 || !items[0].json.starts_at) {\n  return [{\n    json: {\n      success: false,\n      message: \"No upcoming sessions found for this class\",\n      class_type: requestData.class_type,\n      village: requestData.village,\n      call_id: requestData.call_id,\n      timestamp: new Date().toISOString(),\n      duration_ms: duration_ms,\n      from_cache: false,\n      cache_hit: false\n    }\n  }];\n}\n\n// Helper functions\nfunction formatDate(dateStr) {\n  const date = new Date(dateStr);\n  return date.toISOString().split('T')[0];\n}\n\nfunction formatTime(dateStr) {\n  const date = new Date(dateStr);\n  return date.toLocaleTimeString('en-AU', { \n    hour: '2-digit', \n    minute: '2-digit',\n    hour12: true \n  });\n}\n\nfunction getDayName(dateStr) {\n  const date = new Date(dateStr);\n  return date.toLocaleDateString('en-AU', { weekday: 'long' });\n}\n\nfunction detectRecurringPattern(sessions) {\n  if (sessions.length < 2) return null;\n  \n  const days = sessions.map(s => new Date(s.starts_at).getDay());\n  const times = sessions.map(s => formatTime(s.starts_at));\n  \n  // Check if same day and time\n  if (days.every(d => d === days[0]) && times.every(t => t === times[0])) {\n    return {\n      day: getDayName(sessions[0].starts_at),\n      time: times[0],\n      frequency: 'Weekly'\n    };\n  }\n  return null;\n}\n\nconst sessions = items.map(item => item.json);\nconst nextSession = sessions[0];\nconst recurringPattern = detectRecurringPattern(sessions);\n\n// Calculate cache age\nconst lastSynced = new Date(nextSession.last_synced);\nconst now = new Date();\nconst cacheAgeHours = Math.floor((now - lastSynced) / (1000 * 60 * 60));\n\nreturn [{\n  json: {\n    success: true,\n    class_type: requestData.class_type,\n    village: requestData.village,\n    next_session: {\n      date: formatDate(nextSession.starts_at),\n      day_name: getDayName(nextSession.starts_at),\n      time: formatTime(nextSession.starts_at),\n      duration_minutes: nextSession.duration_minutes,\n      spaces_available: nextSession.spaces_available,\n      max_capacity: nextSession.max_attendees,\n      location: nextSession.business_name\n    },\n    upcoming_sessions: sessions.slice(0, 4).map(s => ({\n      date: formatDate(s.starts_at),\n      day_name: getDayName(s.starts_at),\n      time: formatTime(s.starts_at),\n      spaces: s.spaces_available,\n      max: s.max_attendees\n    })),\n    recurring_pattern: recurringPattern,\n    total_sessions_found: sessions.length,\n    call_id: requestData.call_id,\n    timestamp: new Date().toISOString(),\n    from_cache: false,\n    cache_hit: false,\n    cache_age_hours: cacheAgeHours,\n    duration_ms: duration_ms,\n    cache_key: requestData.cache_key\n  }\n}];"},"id":"5345f6ab-d697-4d3c-841f-3e637e58e0ff","name":"Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1240,340]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_cache (cache_key, data, cached_at)\nVALUES (\n    '{{ $json.cache_key }}',\n    '{{ JSON.stringify($json).replace(/'/g, \"''\") }}'::jsonb,\n    NOW()\n)\nON CONFLICT (cache_key) \nDO UPDATE SET \n    data = EXCLUDED.data,\n    cached_at = EXCLUDED.cached_at\nRETURNING *;","options":{}},"id":"store-cache-node-001","name":"Store in Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1440,340],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Pass through the formatted response from Format Response node\n// We need to get the data from Format Response, not from Store in Cache\nconst formatResponseNode = $items(\"Format Response\");\nif (formatResponseNode && formatResponseNode.length > 0) {\n  return [{ json: formatResponseNode[0].json }];\n}\n\n// Fallback: use input data\nreturn $input.all();"},"id":"merge-cache-node-001","name":"Merge After Cache","type":"n8n-nodes-base.code","typeVersion":2,"position":[1640,340]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"2b8f38e5-5fc9-4bfc-b696-d7fa957646d5","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2040,208]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO webhook_log (\n    webhook_name,\n    call_id,\n    request_body,\n    response_body,\n    duration_ms,\n    cache_hit,\n    success,\n    created_at\n) VALUES (\n    'get-class-schedule',\n    '{{ $json.call_id }}',\n    '{{ JSON.stringify($items(\"Extract Request Data\")[0].json).replace(/'/g, \"''\") }}'::jsonb,\n    '{{ JSON.stringify($json).replace(/'/g, \"''\") }}'::jsonb,\n    {{ $json.duration_ms || 0 }},\n    {{ $json.from_cache || false }},\n    {{ $json.success || false }},\n    NOW()\n) RETURNING id;","options":{}},"id":"0495e3b4-3cb3-468d-ba33-85b13ae368c1","name":"Log Webhook Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[2240,208],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-16,-100],"id":"e809419e-52ba-4168-9c23-516758f4f8f2","name":"When clicking 'Execute workflow'"}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Check Cache","type":"main","index":0}]]},"Check Cache":{"main":[[{"node":"Handle Cache Result","type":"main","index":0}]]},"Handle Cache Result":{"main":[[{"node":"Cache Hit?","type":"main","index":0}]]},"Cache Hit?":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}],[{"node":"Query Group Appointments","type":"main","index":0}]]},"Query Group Appointments":{"main":[[{"node":"Format Response","type":"main","index":0}]]},"Format Response":{"main":[[{"node":"Store in Cache","type":"main","index":0}]]},"Store in Cache":{"main":[[{"node":"Merge After Cache","type":"main","index":0}]]},"Merge After Cache":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Webhook Execution","type":"main","index":0}]]},"When clicking 'Execute workflow'":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"43dd17cf-750b-49c6-bb05-751e744f95f8","triggerCount":1,"shared":[{"updatedAt":"2025-11-23T11:08:44.168Z","createdAt":"2025-11-23T11:08:44.168Z","role":"workflow:owner","workflowId":"2PGPPA8g98aHmcAH","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-25T08:35:30.698Z","createdAt":"2025-11-23T11:31:43.986Z","id":"CIoulASoWOJgShrK","name":"RetellAI - Get Booking Rules v1.3","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-booking-rules","responseMode":"responseNode","options":{}},"id":"7142c4a2-618c-4aa1-9519-f8b0a83900b1","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"get-booking-rules"},{"parameters":{"jsCode":"// Extract and validate request parameters\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\n// Extract parameters with type coercion for is_new_client\nlet is_new_client = args.is_new_client;\nconst funding_type = (args.funding_type || '').toUpperCase();\nconst call_id = call.call_id || args.call_id || '';\n\n// Convert string \"true\"/\"false\" to boolean (common with RetellAI)\nif (typeof is_new_client === 'string') {\n  is_new_client = is_new_client.toLowerCase() === 'true';\n}\n\n// Validate required fields\nif (typeof is_new_client !== 'boolean') {\n  throw new Error('is_new_client is required and must be a boolean or string \"true\"/\"false\"');\n}\nif (!funding_type) {\n  throw new Error('funding_type is required');\n}\n\n// Validate funding_type is one of the allowed values\nconst validTypes = ['HCP', 'DVA', 'GP', 'PRIVATE', 'PHI'];\nif (!validTypes.includes(funding_type)) {\n  throw new Error(`Invalid funding_type. Must be one of: ${validTypes.join(', ')}`);\n}\n\n// Create rule_key for cache lookup\nconst clientType = is_new_client ? 'new' : 'existing';\nconst rule_key = `${clientType}_${funding_type}`;\n\nconst startTime = Date.now();\n\nreturn [{\n  json: {\n    is_new_client,\n    funding_type,\n    rule_key,\n    call_id,\n    start_time: startTime,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"b60e8b5f-3f6b-44b7-b2ba-db5593aeffa3","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"operation":"executeQuery","query":"-- Check if business rules cache exists and is fresh (24 hour TTL)\nSELECT \n  rule_key,\n  is_new_client,\n  funding_type,\n  appointment_type,\n  duration_minutes,\n  requires_referral,\n  max_booking_window_days,\n  can_book_recurring,\n  notes,\n  EXTRACT(EPOCH FROM (now() - cached_at))/3600 as hours_old\nFROM business_rules_cache\nWHERE rule_key = '{{ $json.rule_key }}'\n  AND cached_at > now() - interval '24 hours'\nLIMIT 1;","options":{"queryBatching":"independently"}},"id":"f70adb6f-d29b-4d5b-893b-4eefff08993c","name":"Check Business Rules Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[448,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Check if we have cached business rules (CORRECT PATTERN FROM DOCS)\nconst cacheItems = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// CRITICAL: Check for ACTUAL data field, not just rule_key\n// PostgreSQL with alwaysOutputData returns [{json: {}}] even for 0 rows\nconst hasValidCache = cacheItems.length > 0 && \n                      cacheItems[0].json && \n                      cacheItems[0].json.appointment_type;  // Real data field check\n\nif (hasValidCache) {\n  // Cache hit - data exists\n  const cached = cacheItems[0].json;\n  // NO JSON.parse() needed - PostgreSQL JSONB already parsed!\n  return [{ json: { ...cached, from_cache: true } }];\n}\n\n// Cache miss - get default rules\nconst is_new_client = requestData.is_new_client;\nconst funding_type = requestData.funding_type;\nconst rule_key = requestData.rule_key;\n\n// Default rules matrix\nconst newClientRules = {\n  'HCP': {\n    appointment_type: 'Initial Consultation',\n    duration_minutes: 60,\n    requires_referral: false,\n    max_booking_window_days: 21,\n    can_book_recurring: false,\n    notes: 'New Home Care Package client - Initial assessment required'\n  },\n  'DVA': {\n    appointment_type: 'Initial Consultation',\n    duration_minutes: 60,\n    requires_referral: true,\n    max_booking_window_days: 21,\n    can_book_recurring: false,\n    notes: 'New DVA client - Referral required for initial appointment'\n  },\n  'GP': {\n    appointment_type: 'Initial Consultation',\n    duration_minutes: 60,\n    requires_referral: true,\n    max_booking_window_days: 21,\n    can_book_recurring: false,\n    notes: 'New GP CDM client - Referral required'\n  },\n  'PRIVATE': {\n    appointment_type: 'Initial Consultation',\n    duration_minutes: 60,\n    requires_referral: false,\n    max_booking_window_days: 21,\n    can_book_recurring: false,\n    notes: 'New private client - Standard initial consultation'\n  },\n  'PHI': {\n    appointment_type: 'Initial Consultation',\n    duration_minutes: 60,\n    requires_referral: false,\n    max_booking_window_days: 21,\n    can_book_recurring: false,\n    notes: 'New PHI client - Check fund requirements'\n  }\n};\n\nconst existingClientRules = {\n  'HCP': {\n    appointment_type: 'Review Appointment',\n    duration_minutes: 45,\n    requires_referral: false,\n    max_booking_window_days: 21,\n    can_book_recurring: true,\n    notes: 'Existing HCP client - Can book recurring appointments'\n  },\n  'DVA': {\n    appointment_type: 'Review Appointment',\n    duration_minutes: 45,\n    requires_referral: false,\n    max_booking_window_days: 21,\n    can_book_recurring: true,\n    notes: 'Existing DVA client - Referral on file, can book recurring'\n  },\n  'GP': {\n    appointment_type: 'Review Appointment',\n    duration_minutes: 45,\n    requires_referral: false,\n    max_booking_window_days: 21,\n    can_book_recurring: true,\n    notes: 'Existing GP CDM client - Referral on file, can book recurring'\n  },\n  'PRIVATE': {\n    appointment_type: 'Review Appointment',\n    duration_minutes: 45,\n    requires_referral: false,\n    max_booking_window_days: 21,\n    can_book_recurring: true,\n    notes: 'Existing private client - Can book recurring appointments'\n  },\n  'PHI': {\n    appointment_type: 'Review Appointment',\n    duration_minutes: 45,\n    requires_referral: false,\n    max_booking_window_days: 21,\n    can_book_recurring: true,\n    notes: 'Existing PHI client - Can book recurring appointments'\n  }\n};\n\nconst rulesSource = is_new_client ? newClientRules : existingClientRules;\nconst defaultRule = rulesSource[funding_type] || rulesSource['PRIVATE'];\n\nreturn [{\n  json: {\n    rule_key,\n    is_new_client,\n    funding_type,\n    ...defaultRule,\n    from_cache: false\n  }\n}];"},"id":"b954981d-2a5d-4529-ba0b-3888aed14688","name":"Get Business Rules","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"operation":"executeQuery","query":"-- Cache the business rules for 24 hours (only if it was a cache miss)\nINSERT INTO business_rules_cache (\n  rule_key,\n  is_new_client,\n  funding_type,\n  appointment_type,\n  duration_minutes,\n  requires_referral,\n  max_booking_window_days,\n  can_book_recurring,\n  notes,\n  cached_at\n)\nVALUES (\n  '{{ $json.rule_key }}',\n  {{ $json.is_new_client }},\n  '{{ $json.funding_type }}',\n  '{{ $json.appointment_type }}',\n  {{ $json.duration_minutes }},\n  {{ $json.requires_referral }},\n  {{ $json.max_booking_window_days }},\n  {{ $json.can_book_recurring }},\n  '{{ $json.notes }}',\n  now()\n)\nON CONFLICT (rule_key) \nDO UPDATE SET\n  appointment_type = EXCLUDED.appointment_type,\n  duration_minutes = EXCLUDED.duration_minutes,\n  requires_referral = EXCLUDED.requires_referral,\n  max_booking_window_days = EXCLUDED.max_booking_window_days,\n  can_book_recurring = EXCLUDED.can_book_recurring,\n  notes = EXCLUDED.notes,\n  cached_at = now()\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"a4f9bb3f-041b-4672-a72d-3ba04cf6b3bc","name":"Cache Business Rules","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[880,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Build final response with booking rules\n// CRITICAL FIX: Read from \"Get Business Rules\" not \"Cache Business Rules\"\n// \"Get Business Rules\" has the correct from_cache flag\nconst rulesNode = $items(\"Get Business Rules\")[0].json;\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// Extract values\nconst call_id = requestData.call_id;\nconst from_cache = rulesNode.from_cache || false;\n\nconst response = {\n  success: true,\n  rules: {\n    appointment_type: rulesNode.appointment_type,\n    duration_minutes: rulesNode.duration_minutes,\n    requires_referral: rulesNode.requires_referral,\n    max_booking_window_days: rulesNode.max_booking_window_days,\n    can_book_recurring: rulesNode.can_book_recurring\n  },\n  notes: rulesNode.notes,\n  call_id,\n  from_cache,\n  timestamp: new Date().toISOString()\n};\n\nreturn [{ json: response }];"},"id":"ee01fd54-ba4f-4043-943b-324a8c988462","name":"Build Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"b2d2085d-4bec-4e0e-920a-57353f34c658","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,0]},{"parameters":{"operation":"executeQuery","query":"-- Log webhook execution (happens after response sent)\nINSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_body,\n  response_body,\n  success,\n  duration_ms,\n  cache_hit,\n  created_at\n)\nVALUES (\n  'get-booking-rules',\n  '{{ $items(\"Extract Request Data\")[0].json.call_id }}',\n  '{{ JSON.stringify($items(\"Extract Request Data\")[0].json) }}'::jsonb,\n  '{{ JSON.stringify($items(\"Build Response\")[0].json) }}'::jsonb,\n  true,\n  {{ Math.round((Date.now() - $items(\"Extract Request Data\")[0].json.start_time)) }},\n  {{ $items(\"Build Response\")[0].json.from_cache }},\n  now()\n)\nRETURNING id, webhook_name, duration_ms, cache_hit;","options":{"queryBatching":"independently"}},"id":"64442248-1fbf-4e90-bc68-c10db19fd759","name":"Log Webhook Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1552,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Check Business Rules Cache","type":"main","index":0}]]},"Check Business Rules Cache":{"main":[[{"node":"Get Business Rules","type":"main","index":0}]]},"Get Business Rules":{"main":[[{"node":"Cache Business Rules","type":"main","index":0}]]},"Cache Business Rules":{"main":[[{"node":"Build Response","type":"main","index":0}]]},"Build Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Webhook Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"60daaaaf-5d06-456c-a5ba-16cb951af53e","triggerCount":1,"shared":[{"updatedAt":"2025-11-23T11:31:43.986Z","createdAt":"2025-11-23T11:31:43.986Z","role":"workflow:owner","workflowId":"CIoulASoWOJgShrK","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-26T22:52:44.808Z","createdAt":"2025-11-23T11:34:20.779Z","id":"1ZanK2FXNNc5NIQ7","name":"RetellAI - Add to Waitlist v1.3.1 SQL ESCAPE FIX","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/add-waitlist","responseMode":"responseNode","options":{}},"id":"d098aff1-a1b0-41c1-b776-788d396fa032","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-1104,112],"webhookId":"add-waitlist"},{"parameters":{"jsCode":"// Extract and validate request parameters - v1.3 ERROR HANDLING\n// FIX: Handle double-nesting (body.body) AND args_at_root variations\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\n// Extract required parameters\nconst patient_id = args.patient_id || '';\nconst class_name = args.class_name || args.class_type || '';  // Accept both\nconst village = args.village || '';\nconst call_id = call.call_id || args.call_id || '';\n\n// Validate required fields\nif (!patient_id) {\n  throw new Error('patient_id is required');\n}\nif (!class_name) {\n  throw new Error('class_name (or class_type) is required');\n}\nif (!village) {\n  throw new Error('village is required');\n}\n\nconst startTime = Date.now();\n\nreturn [{\n  json: {\n    patient_id,\n    class_name,\n    village,\n    call_id,\n    start_time: startTime,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"7efda06e-9ca4-4622-aae8-ff9623ea264b","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-880,112]},{"parameters":{"operation":"executeQuery","query":"-- Check if patient already on waitlist for this class\nSELECT\n  id,\n  patient_id,\n  patient_name,\n  class_name,\n  village,\n  position,\n  enrolled,\n  created_at\nFROM class_waitlist\nWHERE patient_id = '{{ $json.patient_id }}'\n  AND class_name = '{{ $json.class_name }}'\n  AND village = '{{ $json.village }}'\n  AND enrolled = false  -- Only check active waitlist\nLIMIT 1;","options":{"queryBatching":"independently"}},"id":"5c45b472-c2f3-4bf4-aa2b-5a376f2b4966","name":"Check Existing Waitlist","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-656,112],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Check if patient already on waitlist\nconst items = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// If patient already on waitlist, return existing entry\nif (items.length > 0 && items[0].json.id) {\n  const existing = items[0].json;\n  return [{\n    json: {\n      already_on_waitlist: true,\n      position: existing.position,\n      patient_id: existing.patient_id,\n      class_name: existing.class_name,\n      village: existing.village,\n      message: `You're already on the waitlist at position ${existing.position}`,\n      ...requestData\n    }\n  }];\n}\n\n// Not on waitlist - continue to add\nreturn [{\n  json: {\n    already_on_waitlist: false,\n    ...requestData\n  }\n}];"},"id":"de795c39-c592-4231-a0cd-988f2fad6252","name":"Handle Duplicate Check","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"duplicate-check","leftValue":"={{ $json.already_on_waitlist }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"a00264ba-d24e-441d-b173-3cb1ce077526","name":"Already on Waitlist?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"url":"=https://api.au2.cliniko.com/v1/patients/{{ $items(\"Extract Request Data\")[0].json.patient_id }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"},{"name":"Accept","value":"application/json"}]},"options":{"response":{"response":{"fullResponse":true}}}},"id":"352823f1-4e50-4280-a929-abf94c2d26c6","name":"Get Patient Info from Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"onError":"continueRegularOutput","credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}}},{"parameters":{"jsCode":"// v1.3 - Check Cliniko API response for errors\nconst response = $input.item.json;\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// Check if response indicates an error\n// When onError=continueRegularOutput, errors come through with status codes\nconst statusCode = response.statusCode || response.status || 200;\nconst hasError = response.error || statusCode >= 400 || !response.body?.id;\n\nif (hasError) {\n  // Patient not found or API error\n  return [{\n    json: {\n      cliniko_error: true,\n      error_message: response.error?.message || response.message || `Patient ID ${requestData.patient_id} not found in Cliniko`,\n      status_code: statusCode,\n      patient_id: requestData.patient_id,\n      class_name: requestData.class_name,\n      village: requestData.village,\n      call_id: requestData.call_id,\n      timestamp: requestData.timestamp\n    }\n  }];\n}\n\n// Extract patient details from successful Cliniko response\nconst clinikoData = response.body || response;\nconst firstName = clinikoData.first_name || '';\nconst lastName = clinikoData.last_name || '';\nconst patientName = `${firstName} ${lastName}`.trim() || 'Unknown';\nconst phone = clinikoData.phone_numbers?.[0]?.number || '';\nconst email = clinikoData.email || '';\n\nreturn [{\n  json: {\n    cliniko_error: false,\n    patient_id: requestData.patient_id,\n    patient_name: patientName,\n    phone: phone,\n    email: email,\n    class_name: requestData.class_name,\n    village: requestData.village,\n    call_id: requestData.call_id,\n    timestamp: requestData.timestamp\n  }\n}];"},"id":"check-cliniko-response-node","name":"Check Cliniko Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"cliniko-error-check","leftValue":"={{ $json.cliniko_error }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"cliniko-error-if-node","name":"Cliniko Error?","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,0]},{"parameters":{"jsCode":"// Build error response for invalid patient_id\nconst errorData = $input.item.json;\n\nreturn [{\n  json: {\n    success: false,\n    waitlist_added: false,\n    error: true,\n    error_code: 'PATIENT_NOT_FOUND',\n    message: `Unable to add to waitlist: ${errorData.error_message}`,\n    patient_id: errorData.patient_id,\n    class_name: errorData.class_name,\n    village: errorData.village,\n    call_id: errorData.call_id,\n    timestamp: new Date().toISOString(),\n    suggestion: 'Please verify the patient_id is correct and exists in Cliniko'\n  }\n}];"},"id":"build-error-response-node","name":"Build Error Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,112]},{"parameters":{"operation":"executeQuery","query":"-- Add patient to waitlist (position auto-assigned by trigger)\nINSERT INTO class_waitlist (\n  patient_id,\n  patient_name,\n  phone,\n  email,\n  class_name,\n  village,\n  added_via,\n  call_id,\n  created_at\n)\nVALUES (\n  '{{ $json.patient_id }}',\n  '{{ $json.patient_name }}',\n  '{{ $json.phone }}',\n  '{{ $json.email }}',\n  '{{ $json.class_name }}',\n  '{{ $json.village }}',\n  'voice_ai',\n  '{{ $json.call_id }}',\n  now()\n)\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"281e75ad-4e39-426f-beb0-beddaf9a7c36","name":"Add to Waitlist DB","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[672,-112],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Prepare data for Google Sheets\nconst dbResult = $input.item.json;\n\n// Format timestamp for Australian timezone\nconst timestamp = new Date().toLocaleString('en-AU', {\n  timeZone: 'Australia/Melbourne',\n  year: 'numeric',\n  month: '2-digit',\n  day: '2-digit',\n  hour: '2-digit',\n  minute: '2-digit',\n  second: '2-digit',\n  hour12: false\n});\n\n// Return data formatted for Google Sheets append\nreturn [{\n  json: {\n    // These field names will become the column values\n    Timestamp: timestamp,\n    'Patient ID': dbResult.patient_id,\n    'Patient Name': dbResult.patient_name,\n    'Phone': dbResult.phone || '',\n    'Email': dbResult.email || '',\n    'Class Name': dbResult.class_name,\n    'Village': dbResult.village,\n    'Position': dbResult.position,\n    'Added By': 'Voice AI',\n    'Contacted': 'FALSE',\n    'Call ID': dbResult.call_id,\n    // Keep these for response building\n    _position: dbResult.position,\n    _patient_name: dbResult.patient_name,\n    _class_name: dbResult.class_name,\n    _village: dbResult.village,\n    _waitlist_id: dbResult.id\n  }\n}];"},"id":"d5a8a86a-36b4-470d-a893-5243e2047f6f","name":"Prepare Sheets Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[896,-112]},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"132N5SB4QMuL0nJkrTIUC4EmDIM0KmW1EG-Zq3mPG3BI","mode":"id"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/132N5SB4QMuL0nJkrTIUC4EmDIM0KmW1EG-Zq3mPG3BI/edit#gid=0"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"47ec8579-22bf-4f31-a596-a982baa79f13","name":"Add to Google Sheets","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[1120,-112],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Build response from prepared data\nconst sheetsData = $input.item.json;\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\nreturn [{\n  json: {\n    success: true,\n    waitlist_added: true,\n    position: sheetsData._position,\n    message: `You've been added to the waitlist at position ${sheetsData._position}. We'll contact you if a spot opens up.`,\n    patient_name: sheetsData._patient_name,\n    class_name: sheetsData._class_name,\n    village: sheetsData._village,\n    call_id: requestData.call_id,\n    timestamp: new Date().toISOString(),\n    waitlist_id: sheetsData._waitlist_id,\n    synced_to_sheets: true\n  }\n}];"},"id":"a14dcbbe-f1a5-4d28-adf1-de28017101ba","name":"Build Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1344,-112]},{"parameters":{"jsCode":"// Build duplicate response\nconst duplicateData = $input.item.json;\n\nreturn [{\n  json: {\n    success: true,\n    waitlist_added: false,\n    already_on_waitlist: true,\n    position: duplicateData.position,\n    message: duplicateData.message,\n    class_name: duplicateData.class_name,\n    village: duplicateData.village,\n    call_id: duplicateData.call_id,\n    timestamp: duplicateData.timestamp\n  }\n}];"},"id":"dffe422c-5596-4412-ba76-3f569d01505d","name":"Build Duplicate Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"bfe1755c-29e6-4233-9acc-b44dfcf34742","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1568,112]},{"parameters":{"operation":"executeQuery","query":"-- Log webhook execution (v1.3.1 - escape single quotes)\nINSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_body,\n  response_body,\n  success,\n  duration_ms,\n  created_at\n)\nVALUES (\n  'add-to-waitlist',\n  '{{ $items(\"Extract Request Data\")[0].json.call_id }}',\n  '{{ JSON.stringify($items(\"Extract Request Data\")[0].json).replace(/'/g, \"''\") }}',\n  '{{ JSON.stringify($json).replace(/'/g, \"''\") }}',\n  {{ $json.success }},\n  {{ Date.now() - $items(\"Extract Request Data\")[0].json.start_time }},\n  now()\n)\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"c3033d80-8621-4cf2-9dc2-0b98220799a8","name":"Log Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1792,112],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Check Existing Waitlist","type":"main","index":0}]]},"Check Existing Waitlist":{"main":[[{"node":"Handle Duplicate Check","type":"main","index":0}]]},"Handle Duplicate Check":{"main":[[{"node":"Already on Waitlist?","type":"main","index":0}]]},"Already on Waitlist?":{"main":[[{"node":"Build Duplicate Response","type":"main","index":0}],[{"node":"Get Patient Info from Cliniko","type":"main","index":0}]]},"Get Patient Info from Cliniko":{"main":[[{"node":"Check Cliniko Response","type":"main","index":0}]]},"Check Cliniko Response":{"main":[[{"node":"Cliniko Error?","type":"main","index":0}]]},"Cliniko Error?":{"main":[[{"node":"Build Error Response","type":"main","index":0}],[{"node":"Add to Waitlist DB","type":"main","index":0}]]},"Build Error Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Add to Waitlist DB":{"main":[[{"node":"Prepare Sheets Data","type":"main","index":0}]]},"Prepare Sheets Data":{"main":[[{"node":"Add to Google Sheets","type":"main","index":0}]]},"Add to Google Sheets":{"main":[[{"node":"Build Response","type":"main","index":0}]]},"Build Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Build Duplicate Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"56ce4329-ee7d-4bb4-b3f4-bae1bcd8730c","triggerCount":1,"shared":[{"updatedAt":"2025-11-23T11:34:20.779Z","createdAt":"2025-11-23T11:34:20.779Z","role":"workflow:owner","workflowId":"1ZanK2FXNNc5NIQ7","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-03T22:48:17.571Z","createdAt":"2025-11-23T18:44:24.747Z","id":"ffglDgQYISHofPTT","name":"RetellAI - Check Class Capacity v5.0 FAST","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/check-class-capacity","responseMode":"responseNode","options":{}},"id":"webhook-check-capacity","name":"Webhook - Check Class Capacity","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-1550,160],"webhookId":"check-class-capacity-webhook"},{"parameters":{"jsCode":"// v5.0 FAST - Extract and validate with capacity cache key\nconst webhookData = $input.item.json.body?.body || $input.item.json.body || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\nfunction sanitize(str) {\n  if (!str) return '';\n  return String(str).trim().replace(/'/g, \"''\").slice(0, 100);\n}\n\nconst class_name = sanitize(args.class_name || args.className);\nconst village = sanitize(args.village || args.location);\nconst call_id = sanitize(call.call_id || 'unknown');\n\nif (!class_name || !village) {\n  return [{\n    json: {\n      success: false,\n      error: !class_name ? 'class_name is required' : 'village is required',\n      call_id: call_id,\n      timestamp: new Date().toISOString(),\n      execution_time_ms: 0\n    }\n  }];\n}\n\n// Build capacity cache key\nconst capacity_cache_key = `class_capacity_${class_name.toLowerCase().replace(/\\s+/g, '_')}_${village.toLowerCase().replace(/\\s+/g, '_')}`;\n\nreturn [{\n  json: {\n    success: true,\n    class_name,\n    village,\n    call_id,\n    capacity_cache_key,\n    rules_cache_key: `${class_name}|${village}`,\n    start_time: Date.now()\n  }\n}];"},"id":"extract-request","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1326,160]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.success }}","value2":true}]}},"id":"is-valid","name":"Is Valid?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-1102,160]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"return-error","name":"Return Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[-878,320]},{"parameters":{"operation":"executeQuery","query":"-- Check capacity result cache (10min TTL)\nSELECT \n  id,\n  cache_key,\n  data,\n  cached_at\nFROM webhook_cache\nWHERE cache_key = '{{ $json.capacity_cache_key }}'\n  AND cached_at > NOW() - INTERVAL '10 minutes'\nLIMIT 1;","options":{"queryBatching":"independently"}},"id":"check-cache","name":"Check Capacity Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-878,160],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// v5.0 FAST - Handle capacity cache result\nconst cacheItems = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\n// Check for valid cache hit\nconst hasValidCache = \n  cacheItems.length > 0 &&\n  cacheItems[0].json &&\n  cacheItems[0].json.id &&\n  cacheItems[0].json.data;\n\nif (hasValidCache) {\n  const cached = cacheItems[0].json;\n  const capacityData = cached.data;\n  \n  const isFull = capacityData.is_full || false;\n  const availableSpots = capacityData.available_spots || capacityData.spots_available || 999;\n  const hasCapacity = capacityData.has_capacity !== undefined ? capacityData.has_capacity : (!isFull && availableSpots > 0);\n  \n  return [{\n    json: {\n      ...capacityData,\n      has_capacity: hasCapacity,\n      spots_available: availableSpots,\n      class_id: capacityData.class_id || capacityData.next_class_id || null,\n      call_id: requestData.call_id,\n      from_cache: true,\n      timestamp: new Date().toISOString(),\n      execution_time_ms: Date.now() - requestData.start_time,\n      cache_performance: {\n        from_cache: true,\n        cached_at: cached.cached_at\n      }\n    }\n  }];\n}\n\n// Cache miss - proceed to DB check\nreturn [{\n  json: {\n    ...requestData,\n    from_cache: false,\n    needs_full_check: true\n  }\n}];"},"id":"handle-cache","name":"Handle Capacity Cache","type":"n8n-nodes-base.code","typeVersion":2,"position":[-654,160]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.from_cache }}","value2":true}]}},"id":"cache-hit","name":"Capacity Cache Hit?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-430,160]},{"parameters":{"operation":"executeQuery","query":"-- Check capacity rules cache (FAST - no Google Sheets fallback)\nSELECT \n  id,\n  class_type,\n  village,\n  capacity_rule,\n  threshold,\n  handling,\n  notes,\n  free_trial,\n  max_capacity,\n  cached_at\nFROM class_capacity_rules_cache\nWHERE class_type ILIKE '%' || '{{ $json.class_name }}' || '%'\n  AND (village ILIKE '%' || '{{ $json.village }}' || '%' OR village IS NULL)\n  AND active = true\nORDER BY \n  CASE WHEN village IS NOT NULL THEN 1 ELSE 2 END,\n  cached_at DESC\nLIMIT 1;","options":{"queryBatching":"independently"}},"id":"check-rules-db","name":"Check Rules DB","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-206,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Handle DB Rules Result\nconst cacheItems = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\nif (cacheItems.length > 0 && cacheItems[0].json.id) {\n  const rule = cacheItems[0].json;\n  return [{\n    json: {\n      ...requestData,\n      rule_id: rule.id,\n      class_type: rule.class_type,\n      capacity_rule: rule.capacity_rule,\n      threshold: rule.threshold,\n      handling: rule.handling,\n      notes: rule.notes,\n      free_trial: rule.free_trial,\n      max_capacity: rule.max_capacity,\n      rules_from_cache: true\n    }\n  }];\n}\n\n// Fallback if no rule found: assume standard 10 person limit\nreturn [{\n  json: {\n    ...requestData,\n    class_type: requestData.class_name,\n    capacity_rule: 'Check threshold',\n    threshold: 10,\n    handling: 'if_gt_10_waitlist',\n    notes: 'Fallback rule',\n    free_trial: false,\n    max_capacity: 10,\n    rules_from_cache: false\n  }\n}];"},"id":"handle-db-result","name":"Handle DB Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[18,0]},{"parameters":{"jsCode":"// Determine if Cliniko check needed\nconst data = $input.item.json;\n\n// If \"Check threshold\", need Cliniko\nif (data.capacity_rule === 'Check threshold') {\n  return [{\n    json: {\n      ...data,\n      skip_cliniko: false,\n      needs_cliniko: true\n    }\n  }];\n}\n\n// Default / Unlimited: skip Cliniko\nreturn [{\n  json: {\n    ...data,\n    current_enrollment: 0,\n    available_spots: 999,\n    is_full: false,\n    skip_cliniko: true\n  }\n}];"},"id":"check-cliniko-need","name":"Need Cliniko Check?","type":"n8n-nodes-base.code","typeVersion":2,"position":[242,0]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.skip_cliniko }}"}]}},"id":"query-cliniko-if","name":"Query Cliniko?","type":"n8n-nodes-base.if","typeVersion":1,"position":[466,0]},{"parameters":{"jsCode":"// Placeholder: Query Cliniko for current enrollment\n// In production, this would query Cliniko API\nconst data = $input.item.json;\n\n// TODO: Replace with actual Cliniko API call if needed\n// For now, assume 2 spots available to allow booking flow to proceed\nconst currentEnrollment = 8;\n\nreturn [{\n  json: {\n    ...data,\n    current_enrollment: currentEnrollment,\n    available_spots: data.threshold - currentEnrollment,\n    is_full: currentEnrollment >= data.threshold,\n    cliniko_checked: true\n  }\n}];"},"id":"cliniko-query","name":"Get Cliniko Enrollment","type":"n8n-nodes-base.code","typeVersion":2,"position":[690,-160]},{"parameters":{"jsCode":"// Merge Cliniko paths\nconst allItems = $input.all();\nconst requestData = $items(\"Extract Request Data\")[0].json;\nconst clinikoData = allItems[0].json;\n\nreturn [{ \n  json: {\n    ...requestData,\n    ...clinikoData\n  }\n}];"},"id":"merge-paths","name":"Merge Paths","type":"n8n-nodes-base.code","typeVersion":2,"position":[914,0]},{"parameters":{"jsCode":"// v5.0 FAST - Build Final Response\nconst data = $input.item.json;\n\nif (data.success === false) {\n  return [{ json: { ...data, has_capacity: false, spots_available: 0 }}];\n}\n\nconst executionTime = data.start_time ? (Date.now() - data.start_time) : 0;\nconst className = data.class_name || 'Unknown';\nconst villageName = data.village || 'Unknown';\nconst isFull = data.is_full || false;\nconst availableSpots = data.available_spots || 999;\nconst hasCapacity = !isFull && availableSpots > 0;\n\nlet message = '';\nif (isFull) {\n  message = `${className} is at capacity (${data.current_enrollment}/${data.threshold})`;\n} else {\n  message = `${className} has ${availableSpots} spots available`;\n}\n\nconst response = {\n  success: true,\n  call_id: data.call_id,\n  class_name: className,\n  village: villageName,\n  has_capacity: hasCapacity,\n  spots_available: availableSpots,\n  class_id: data.class_id || null,\n  capacity_rule: data.capacity_rule,\n  threshold: data.threshold,\n  message: message,\n  from_cache: false,\n  execution_time_ms: executionTime,\n  capacity_cache_key: data.capacity_cache_key\n};\n\nreturn [{ json: response }];"},"id":"build-response","name":"Build Final Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1138,0]},{"parameters":{"operation":"executeQuery","query":"-- Write capacity result to cache\nINSERT INTO webhook_cache (\n  cache_key,\n  data\n) VALUES (\n  '{{ $json.capacity_cache_key }}',\n  '{{ JSON.stringify($json).replace(/'/g, \"''\") }}'::jsonb\n)\nON CONFLICT (cache_key)\nDO UPDATE SET\n  data = EXCLUDED.data,\n  cached_at = NOW()\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"write-cache","name":"Write Capacity Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1362,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Merge cache write result\nconst requestData = $items(\"Build Final Response\")[0].json;\nreturn [{ json: requestData }];"},"id":"merge-final","name":"Merge Final","type":"n8n-nodes-base.code","typeVersion":2,"position":[1586,0]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"respond-webhook","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[1810,0]},{"parameters":{"operation":"executeQuery","query":"-- Log execution\nINSERT INTO webhook_logs (\n  webhook_name,\n  call_id,\n  success,\n  execution_time_ms,\n  response_data,\n  error_message\n) VALUES (\n  'check-class-capacity',\n  '{{ $json.call_id }}',\n  {{ $json.success }},\n  COALESCE(NULLIF({{ $json.execution_time_ms }}, 'NaN'::numeric), 0)::integer,\n  $${{ JSON.stringify($json) }}$$::jsonb,\n  NULLIF('{{ $json.error }}', '')\n)\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"log-execution","name":"Log Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[2034,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}}],"connections":{"Webhook - Check Class Capacity":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Is Valid?","type":"main","index":0}]]},"Is Valid?":{"main":[[{"node":"Check Capacity Cache","type":"main","index":0}],[{"node":"Return Validation Error","type":"main","index":0}]]},"Check Capacity Cache":{"main":[[{"node":"Handle Capacity Cache","type":"main","index":0}]]},"Handle Capacity Cache":{"main":[[{"node":"Capacity Cache Hit?","type":"main","index":0}]]},"Capacity Cache Hit?":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}],[{"node":"Check Rules DB","type":"main","index":0}]]},"Check Rules DB":{"main":[[{"node":"Handle DB Result","type":"main","index":0}]]},"Handle DB Result":{"main":[[{"node":"Need Cliniko Check?","type":"main","index":0}]]},"Need Cliniko Check?":{"main":[[{"node":"Query Cliniko?","type":"main","index":0}]]},"Query Cliniko?":{"main":[[{"node":"Get Cliniko Enrollment","type":"main","index":0}],[{"node":"Merge Paths","type":"main","index":0}]]},"Get Cliniko Enrollment":{"main":[[{"node":"Merge Paths","type":"main","index":0}]]},"Merge Paths":{"main":[[{"node":"Build Final Response","type":"main","index":0}]]},"Build Final Response":{"main":[[{"node":"Write Capacity Cache","type":"main","index":0}]]},"Write Capacity Cache":{"main":[[{"node":"Merge Final","type":"main","index":0}]]},"Merge Final":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"4763898f-29fe-4787-aceb-368cdf88b014","triggerCount":1,"shared":[{"updatedAt":"2025-11-23T18:44:24.747Z","createdAt":"2025-11-23T18:44:24.747Z","role":"workflow:owner","workflowId":"ffglDgQYISHofPTT","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-23T19:15:01.851Z","createdAt":"2025-11-23T19:15:01.386Z","id":"i67SgqtzKdUROO5Z","name":"RetellAI - Lookup Caller by DOB v2.8 SIMPLIFIED ERROR HANDLING","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/lookup-caller-dob","responseMode":"responseNode","options":{}},"id":"4e5f8987-026c-4f32-b764-6a518ada4128","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,0],"webhookId":"lookup-caller-dob"},{"parameters":{"jsCode":"// Extract parameters from various possible structures\nconst body = $input.first().json.body || {};\n\n// Try multiple possible parameter locations\nlet dateOfBirth = body.date_of_birth || body.args?.date_of_birth || body.parameters?.date_of_birth;\nlet firstName = body.first_name || body.args?.first_name || body.parameters?.first_name;\nlet lastName = body.last_name || body.args?.last_name || body.parameters?.last_name;\n\n// CRITICAL FIX: Treat empty strings as missing\nif (dateOfBirth === '') dateOfBirth = null;\nif (firstName === '') firstName = null;\nif (lastName === '') lastName = null;\n\n// Validate required parameters\nif (!dateOfBirth || !firstName || !lastName) {\n  return [\n    {\n      json: {\n        error: true,\n        found: false,\n        message: \"Missing or empty required parameters\",\n        required: [\"date_of_birth\", \"first_name\", \"last_name\"],\n        received: {\n          date_of_birth: dateOfBirth || 'missing/empty',\n          first_name: firstName || 'missing/empty',\n          last_name: lastName || 'missing/empty'\n        },\n        raw_body: body,\n        suggestion: \"Check RetellAI tool configuration. Ensure all 3 parameters are mapped correctly.\",\n        debug_tip: \"Look at raw_body to see actual structure received from RetellAI\",\n        timestamp: new Date().toISOString()\n      }\n    }\n  ];\n}\n\n// Date format validation\nconst dateRegex = /^\\d{4}-\\d{2}-\\d{2}$/;\nif (!dateRegex.test(dateOfBirth)) {\n  return [\n    {\n      json: {\n        error: true,\n        found: false,\n        message: \"Invalid date format\",\n        expected_format: \"YYYY-MM-DD (e.g., 1945-03-15)\",\n        received: dateOfBirth,\n        suggestion: \"Ensure RetellAI is sending date in YYYY-MM-DD format\",\n        timestamp: new Date().toISOString()\n      }\n    }\n  ];\n}\n\n// Return validated parameters\nreturn [\n  {\n    json: {\n      date_of_birth: dateOfBirth,\n      first_name: firstName,\n      last_name: lastName,\n      validated: true,\n      error: false\n    }\n  }\n];"},"id":"a65a7616-604e-465b-9f91-910c1f6c7edd","name":"Extract & Validate Parameters","type":"n8n-nodes-base.code","typeVersion":2,"position":[320,0]},{"parameters":{"operation":"executeQuery","query":"=SELECT \n  patient_id,\n  first_name,\n  last_name,\n  preferred_name,\n  email,\n  phone,\n  phone_mobile,\n  date_of_birth,\n  village,\n  archived,\n  last_synced\nFROM patients\nWHERE \n  date_of_birth = '{{ $json.date_of_birth }}'\n  AND LOWER(first_name) = LOWER('{{ $json.first_name }}')\n  AND LOWER(last_name) = LOWER('{{ $json.last_name }}')\n  AND archived = false\nORDER BY \n  CASE WHEN phone IS NOT NULL AND phone != '' THEN 1 ELSE 2 END,\n  CASE WHEN village IS NOT NULL AND village != '' THEN 1 ELSE 2 END,\n  last_synced DESC\nLIMIT 1","options":{}},"id":"804801cd-c4d9-4265-9c3f-de712cdc0915","name":"Postgres - Search by DOB and Name","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[640,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"jsCode":"// Get the validated parameters from Extract node\nconst extractNode = $('Extract & Validate Parameters').first().json;\n\n// Check if validation failed (error flag set)\nif (extractNode.error === true) {\n  // Return the error response as-is\n  return [{ json: extractNode }];\n}\n\n// Get search parameters\nconst dob = extractNode.date_of_birth;\nconst firstName = extractNode.first_name;\nconst lastName = extractNode.last_name;\n\n// Get results from Postgres\nconst postgresResults = $input.all();\n\n// Check if Postgres query failed or returned no results\nif (postgresResults.length === 0 || !postgresResults[0].json.patient_id) {\n  // No patients found\n  return [\n    {\n      json: {\n        found: false,\n        search_criteria: {\n          date_of_birth: dob,\n          first_name: firstName,\n          last_name: lastName\n        },\n        message: \"No patients found matching these criteria\",\n        suggestion: \"Verify the date format (YYYY-MM-DD) and name spelling. Check if patient exists in Cliniko.\",\n        timestamp: new Date().toISOString()\n      }\n    }\n  ];\n}\n\n// Format matching patient\nconst patient = postgresResults[0].json;\n\nreturn [\n  {\n    json: {\n      found: true,\n      search_criteria: {\n        date_of_birth: dob,\n        first_name: firstName,\n        last_name: lastName\n      },\n      patient: {\n        id: patient.patient_id,\n        first_name: patient.first_name,\n        last_name: patient.last_name,\n        full_name: `${patient.first_name} ${patient.last_name}`,\n        preferred_name: patient.preferred_name || patient.first_name,\n        email: patient.email || null,\n        phone: patient.phone || patient.phone_mobile,\n        mobile: patient.phone_mobile || null,\n        dob: patient.date_of_birth,\n        village: patient.village || 'Unknown',\n        is_archived: patient.archived === true,\n        is_active: patient.archived === false,\n        cliniko_url: `https://reignitehealth.au2.cliniko.com/patients/${patient.patient_id}`,\n        last_synced: patient.last_synced\n      },\n      message: \"Patient found\",\n      timestamp: new Date().toISOString()\n    }\n  }\n];"},"id":"9f2f8f55-bec7-4070-9d49-ca631682613c","name":"Transform for RetellAI","type":"n8n-nodes-base.code","typeVersion":2,"position":[864,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"1c62a293-518b-4be5-8311-f864d8e8c211","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1088,0]}],"connections":{"Webhook":{"main":[[{"node":"Extract & Validate Parameters","type":"main","index":0}]]},"Extract & Validate Parameters":{"main":[[{"node":"Postgres - Search by DOB and Name","type":"main","index":0}]]},"Postgres - Search by DOB and Name":{"main":[[{"node":"Transform for RetellAI","type":"main","index":0}]]},"Transform for RetellAI":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"54bfb98d-6d27-40c3-a409-66d2816dcd23","triggerCount":1,"shared":[{"updatedAt":"2025-11-23T19:15:01.386Z","createdAt":"2025-11-23T19:15:01.386Z","role":"workflow:owner","workflowId":"i67SgqtzKdUROO5Z","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-24T04:09:12.681Z","createdAt":"2025-11-23T20:37:06.576Z","id":"HRFLzjFg3Neaqhyp","name":"RetellAI - Email End of Call Summary + Sheets v7.2 FINAL","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/email-call-summary","responseMode":"responseNode","options":{}},"id":"73dd8144-20c1-4075-bb2e-bb42d6a6066a","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-1488,96],"webhookId":"1565fad1-c77c-46bf-b164-2f40bf462708"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $('Webhook').item.json.body?.event }}","rightValue":"call_analyzed","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"6967171c-261e-46f4-a6ac-bba9f9ed94cd","name":"Is Call Analyzed Event?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1264,96]},{"parameters":{"operation":"executeQuery","query":"-- Check if we've already processed this call_id\n-- This prevents duplicate emails\n\nCREATE TABLE IF NOT EXISTS processed_call_emails (\n  call_id      text PRIMARY KEY,\n  processed_at timestamptz DEFAULT now(),\n  email_sent   boolean DEFAULT true\n);\n\n-- Check if this call_id exists\nSELECT \n  call_id,\n  processed_at,\n  email_sent\nFROM processed_call_emails\nWHERE call_id = '{{ $json.body.call.call_id }}'\nLIMIT 1;","options":{}},"id":"3e303fe9-1e1c-48bf-a5db-ab74b77ffffa","name":"Check If Already Processed","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-1040,96],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// FIXED: Check if this call has already been processed\nconst items = $input.all();\n\nif (!items || items.length === 0) {\n  console.log('‚úÖ NEW CALL: No items from DB check, continuing...');\n  return items;\n}\n\nconst pgResult = items[0].json;\n\n// PostgreSQL returns empty array [] when no rows found\nif (Array.isArray(pgResult) && pgResult.length === 0) {\n  console.log('‚úÖ NEW CALL: Empty array from DB, not processed yet');\n  return items;\n}\n\n// If pgResult is a non-empty array, check first item\nif (Array.isArray(pgResult) && pgResult.length > 0 && pgResult[0].call_id) {\n  console.log('‚ùå DUPLICATE PREVENTED: Call already processed, skipping');\n  return [];\n}\n\n// If pgResult is an object with call_id, already processed\nif (pgResult && !Array.isArray(pgResult) && pgResult.call_id) {\n  console.log('‚ùå DUPLICATE PREVENTED: Call already processed, skipping');\n  return [];\n}\n\nconsole.log('‚úÖ NEW CALL: Not processed yet, continuing...');\nreturn items;"},"id":"0451eefc-4662-449a-a354-abde89709692","name":"Skip If Already Processed","type":"n8n-nodes-base.code","typeVersion":2,"position":[-816,96]},{"parameters":{"operation":"executeQuery","query":"-- Mark this call as processed FIRST\n-- This ensures we don't send duplicate emails even if the workflow runs twice\n\nINSERT INTO processed_call_emails (call_id, processed_at, email_sent)\nVALUES (\n  '{{ $json.body.call.call_id }}',\n  NOW(),\n  true\n)\nON CONFLICT (call_id) DO NOTHING\nRETURNING *;","options":{}},"id":"fb1ce48e-0ea8-4b00-8608-fa7f06b22a57","name":"Mark As Processed","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-592,96],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"operation":"executeQuery","query":"-- Look up transfer data AND patient info by call_id\n-- ALWAYS returns one row with complete patient info when available\n\nCREATE TABLE IF NOT EXISTS retell_calls (\n  call_id      text PRIMARY KEY,\n  phone_number text,\n  no_phone     boolean DEFAULT false,\n  from_number  text,\n  created_at   timestamptz DEFAULT now(),\n  updated_at   timestamptz DEFAULT now()\n);\n\n-- Get the call_id from webhook\nWITH call_info AS (\n  SELECT '{{ $json.body.call.call_id }}' as search_call_id\n),\n-- Look for transfer (from Sara's tool)\ntransfer_lookup AS (\n  SELECT *\n  FROM retell_transfers\n  WHERE call_id = (SELECT search_call_id FROM call_info)\n  ORDER BY created_at DESC\n  LIMIT 1\n),\n-- Look for retell_calls entry (from Lookup Caller tool at start of call)\nretell_call_lookup AS (\n  SELECT *\n  FROM retell_calls\n  WHERE call_id = (SELECT search_call_id FROM call_info)\n  LIMIT 1\n),\n-- Look up patient by phone number\npatient_lookup AS (\n  SELECT\n    patient_id,\n    first_name,\n    last_name,\n    preferred_name,\n    email,\n    phone,\n    phone_mobile,\n    date_of_birth,\n    village,\n    archived\n  FROM patients\n  WHERE archived = false\n    AND (\n      phone_normalized = (SELECT phone_number FROM retell_call_lookup)\n      OR phone_mobile_normalized = (SELECT phone_number FROM retell_call_lookup)\n    )\n  LIMIT 1\n)\n-- ALWAYS return one row with merged data\nSELECT\n  -- Transfer fields (from Sara's tool)\n  t.transfer_id,\n  COALESCE(t.call_id, ci.search_call_id) as call_id,\n  t.created_at as transfer_created_at,\n  t.updated_at as transfer_updated_at,\n  \n  -- Caller info: prefer transfer, fallback to patient lookup\n  COALESCE(\n    t.caller_name,\n    CONCAT(p.first_name, ' ', p.last_name)\n  ) as caller_name,\n  \n  COALESCE(t.village, p.village) as village,\n  \n  COALESCE(\n    t.patient_id,\n    p.patient_id::text\n  ) as patient_id,\n  \n  -- Transfer-specific fields\n  t.phone_number as transfer_phone_number,\n  t.no_phone,\n  t.intent,\n  t.urgency,\n  t.details,\n  \n  -- retell_calls data\n  rc.phone_number AS stored_phone_number,\n  rc.no_phone AS stored_no_phone,\n  rc.from_number AS carrier_from_number,\n  \n  -- Patient data for reference\n  p.first_name,\n  p.last_name,\n  p.preferred_name,\n  p.email,\n  p.phone as patient_phone,\n  p.phone_mobile as patient_mobile,\n  p.date_of_birth,\n  p.village as patient_village\n  \nFROM call_info ci\nLEFT JOIN transfer_lookup t ON TRUE\nLEFT JOIN retell_call_lookup rc ON TRUE\nLEFT JOIN patient_lookup p ON TRUE\nLIMIT 1;","options":{"queryReplacement":""}},"id":"dc22cfd6-58d1-4e55-b6f3-d05fbac8986d","name":"Postgres Load Transfer","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-368,96],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"assignments":{"assignments":[{"id":"a1b2c3d4","name":"call_id","value":"={{ $('Webhook').first().json.body?.call?.call_id || 'N/A' }}","type":"string"},{"id":"a1b2c3d5","name":"agent_id","value":"={{ $('Webhook').first().json.body?.call?.agent_id || 'N/A' }}","type":"string"},{"id":"a1b2c3d6","name":"agent_version","value":"={{ $('Webhook').first().json.body?.call?.agent_version || 'N/A' }}","type":"string"},{"id":"a1b2c3d7","name":"direction","value":"={{ $('Webhook').first().json.body?.call?.direction || 'unknown' }}","type":"string"},{"id":"a1b2c3d8","name":"outcome","value":"={{ $('Webhook').first().json.body?.call?.call_status || 'unknown' }}","type":"string"},{"id":"a1b2c3d9","name":"start_time","value":"={{ $('Webhook').first().json.body?.call?.start_timestamp ? new Date($('Webhook').first().json.body.call.start_timestamp).toLocaleString('en-AU', { timeZone: 'Australia/Sydney' }) : 'N/A' }}","type":"string"},{"id":"a1b2c3d10","name":"end_time","value":"={{ $('Webhook').first().json.body?.call?.end_timestamp ? new Date($('Webhook').first().json.body.call.end_timestamp).toLocaleString('en-AU', { timeZone: 'Australia/Sydney' }) : 'N/A' }}","type":"string"},{"id":"a1b2c3d11","name":"duration_ms","value":"={{ $('Webhook').first().json.body?.call?.duration_ms || 0 }}","type":"number"},{"id":"a1b2c3d12","name":"human_duration","value":"={{ (() => { const ms = $('Webhook').first().json.body?.call?.duration_ms; if (!ms) return 'N/A'; const totalSeconds = Math.floor(ms / 1000); const minutes = Math.floor(totalSeconds / 60); const seconds = totalSeconds % 60; return `${minutes}m ${seconds}s`; })() }}","type":"string"},{"id":"a1b2c3d13","name":"duration_seconds","value":"={{ (() => { const ms = $('Webhook').first().json.body?.call?.duration_ms; if (!ms) return 0; return Math.floor(ms / 1000); })() }}","type":"number"},{"id":"a1b2c3d14","name":"date","value":"={{ $('Webhook').first().json.body?.call?.start_timestamp ? new Date($('Webhook').first().json.body.call.start_timestamp).toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney' }) : 'N/A' }}","type":"string"},{"id":"a1b2c3d15","name":"time","value":"={{ $('Webhook').first().json.body?.call?.start_timestamp ? new Date($('Webhook').first().json.body.call.start_timestamp).toLocaleTimeString('en-AU', { timeZone: 'Australia/Sydney' }) : 'N/A' }}","type":"string"},{"id":"a1b2c3d16","name":"plain_transcript","value":"={{ (() => { const transcript = $('Webhook').first().json.body?.call?.transcript_object; if (!transcript || !Array.isArray(transcript)) return 'No transcript available'; return transcript.map(turn => `${turn.role?.charAt(0)?.toUpperCase() + turn.role?.slice(1) || 'Unknown'}: ${turn.content || ''}`).join('\\n\\n'); })() }}","type":"string"},{"id":"a1b2c3d17","name":"html_transcript","value":"={{ (() => { const transcript = $('Webhook').first().json.body?.call?.transcript_object; if (!transcript || !Array.isArray(transcript)) return 'No transcript available'; return transcript.map(turn => `${turn.role?.charAt(0)?.toUpperCase() + turn.role?.slice(1) || 'Unknown'}: ${turn.content || ''}`).join('<br><br>'); })() }}","type":"string"},{"id":"a1b2c3d18","name":"recording_url","value":"={{ $('Webhook').first().json.body?.call?.recording_url || 'N/A' }}","type":"string"},{"id":"a1b2c3d19","name":"public_log_url","value":"={{ $('Webhook').first().json.body?.call?.public_log_url || 'N/A' }}","type":"string"},{"id":"a1b2c3d20","name":"client_name","value":"={{ (() => { const name = $('Postgres Load Transfer').first().json?.caller_name; return (name && name.trim()) ? name.trim() : 'Unknown Caller'; })() }}","type":"string"},{"id":"a1b2c3d21","name":"village","value":"={{ $('Postgres Load Transfer').first().json?.village || 'N/A' }}","type":"string"},{"id":"a1b2c3d22","name":"cliniko_id","value":"={{ $('Postgres Load Transfer').first().json?.patient_id || 'N/A' }}","type":"string"},{"id":"a1b2c3d23","name":"caller_id","value":"={{ $('Postgres Load Transfer').first().json?.stored_phone_number || $('Postgres Load Transfer').first().json?.transfer_phone_number || 'N/A' }}","type":"string"},{"id":"a1b2c3d24","name":"intent","value":"={{ $('Postgres Load Transfer').first().json?.intent || 'N/A' }}","type":"string"},{"id":"a1b2c3d25","name":"escalated","value":"={{ $('Postgres Load Transfer').first().json?.urgency || 'N/A' }}","type":"string"},{"id":"a1b2c3d26","name":"notes","value":"={{ $('Postgres Load Transfer').first().json?.details || 'No details provided' }}","type":"string"},{"id":"a1b2c3d27","name":"errors","value":"","type":"string"}]},"options":{}},"id":"4482a284-78c9-4250-bbb7-5033285e5cea","name":"Compose Data for Email","type":"n8n-nodes-base.set","typeVersion":3.3,"position":[-144,0]},{"parameters":{"assignments":{"assignments":[{"id":"s1","name":"call_id","value":"={{ $('Webhook').first().json.body?.call?.call_id || 'N/A' }}","type":"string"},{"id":"s2","name":"date","value":"={{ $('Webhook').first().json.body?.call?.start_timestamp ? new Date($('Webhook').first().json.body.call.start_timestamp).toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney' }) : 'N/A' }}","type":"string"},{"id":"s3","name":"time","value":"={{ $('Webhook').first().json.body?.call?.start_timestamp ? new Date($('Webhook').first().json.body.call.start_timestamp).toLocaleTimeString('en-AU', { timeZone: 'Australia/Sydney' }) : 'N/A' }}","type":"string"},{"id":"s4","name":"caller_id","value":"={{ (() => { const phone = $('Postgres Load Transfer').first().json?.stored_phone_number || $('Postgres Load Transfer').first().json?.transfer_phone_number; return (phone && phone.trim()) ? phone.trim() : 'N/A'; })() }}","type":"string"},{"id":"s5","name":"client_name","value":"={{ (() => { const name = $('Postgres Load Transfer').first().json?.caller_name; return (name && name.trim()) ? name.trim() : 'Unknown Caller'; })() }}","type":"string"},{"id":"s6","name":"cliniko_id","value":"={{ (() => { const id = $('Postgres Load Transfer').first().json?.patient_id; return (id && String(id).trim()) ? String(id).trim() : 'N/A'; })() }}","type":"string"},{"id":"s7","name":"village","value":"={{ (() => { const v = $('Postgres Load Transfer').first().json?.village; return (v && v.trim()) ? v.trim() : 'N/A'; })() }}","type":"string"},{"id":"s8","name":"duration_seconds","value":"={{ (() => { const ms = $('Webhook').first().json.body?.call?.duration_ms; if (!ms) return 0; return Math.floor(ms / 1000); })() }}","type":"number"},{"id":"s9","name":"intent","value":"={{ (() => { const i = $('Postgres Load Transfer').first().json?.intent; return (i && i.trim()) ? i.trim() : 'N/A'; })() }}","type":"string"},{"id":"s10","name":"outcome","value":"={{ $('Webhook').first().json.body?.call?.call_status || 'unknown' }}","type":"string"},{"id":"s11","name":"escalated","value":"={{ (() => { const u = $('Postgres Load Transfer').first().json?.urgency; return (u && u.trim()) ? u.trim() : 'N/A'; })() }}","type":"string"},{"id":"s12","name":"errors","value":"","type":"string"},{"id":"s13","name":"recording_url","value":"={{ $('Webhook').first().json.body?.call?.recording_url || 'N/A' }}","type":"string"},{"id":"s14","name":"notes","value":"={{ (() => { const n = $('Postgres Load Transfer').first().json?.details; return (n && n.trim()) ? n.trim() : 'No details provided'; })() }}","type":"string"}]},"options":{}},"id":"74231934-a587-45e9-beda-b1f938fccdfe","name":"Compose Data for Sheets","type":"n8n-nodes-base.set","typeVersion":3.3,"position":[80,192]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"inbound-check","leftValue":"={{ $json.direction }}","rightValue":"inbound","operator":{"type":"string","operation":"equals"}},{"id":"duration-check","leftValue":"={{ $json.duration_ms }}","rightValue":10000,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"12134b97-6c76-4114-aa39-20ff8d1777cc","name":"Is Inbound Call > 10s?","type":"n8n-nodes-base.if","typeVersion":2,"position":[80,0]},{"parameters":{"sendTo":"peter@yesai.au","subject":"=üìû Call Summary: {{ $json.client_name }} ({{ $json.human_duration }})","message":"=<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 800px; margin: 0 auto; padding: 20px; }\n    .header { background-color: #4CAF50; color: white; padding: 20px; border-radius: 5px; }\n    .section { margin: 20px 0; padding: 15px; border-left: 4px solid #4CAF50; background-color: #f9f9f9; }\n    .label { font-weight: bold; color: #4CAF50; }\n    .transcript { background-color: #f5f5f5; padding: 15px; border-radius: 5px; white-space: pre-wrap; }\n    .footer { margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee; font-size: 0.9em; color: #666; }\n    .urgent { color: #ff0000; font-weight: bold; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>üìû Call Summary</h1>\n      <p style=\"font-size: 1.2em; margin: 0;\">{{ $json.client_name }}</p>\n    </div>\n\n    <div class=\"section\">\n      <p><span class=\"label\">Call ID:</span> {{ $json.call_id }}</p>\n      <p><span class=\"label\">Direction:</span> {{ $json.direction }}</p>\n      <p><span class=\"label\">Status:</span> {{ $json.status }}</p>\n      <p><span class=\"label\">Duration:</span> {{ $json.human_duration }}</p>\n      <p><span class=\"label\">Start:</span> {{ $json.start_time }}</p>\n      <p><span class=\"label\">End:</span> {{ $json.end_time }}</p>\n    </div>\n\n    {{ $json.patient_id !== 'N/A' ? `\n    <div class=\"section\">\n      <h3>üë§ Patient Information</h3>\n      <p><span class=\"label\">Patient ID:</span> ${$json.cliniko_id}</p>\n      <p><span class=\"label\">Name:</span> ${$json.client_name}</p>\n      <p><span class=\"label\">Village:</span> ${$json.village}</p>\n    </div>\n    ` : '' }}\n\n    {{ $json.intent !== 'N/A' ? `\n    <div class=\"section\">\n      <h3>üìã Call Details</h3>\n      <p><span class=\"label\">Intent:</span> ${$json.intent}</p>\n      <p><span class=\"label ${$json.urgency === 'high' ? 'urgent' : ''}\">Urgency:</span> ${$json.escalated}</p>\n      <p><span class=\"label\">Details:</span> ${$json.notes}</p>\n    </div>\n    ` : '' }}\n\n    <div class=\"section\">\n      <h3>üìù Transcript</h3>\n      <div class=\"transcript\">{{ $json.html_transcript }}</div>\n    </div>\n\n    {{ $json.recording_url !== 'N/A' ? `\n    <div class=\"section\">\n      <h3>üîó Links</h3>\n      <p><span class=\"label\">Recording:</span> <a href=\"${$json.recording_url}\">Listen to recording</a></p>\n      <p><span class=\"label\">Public Log:</span> <a href=\"${$json.public_log_url}\">View detailed log</a></p>\n    </div>\n    ` : '' }}\n\n    <div class=\"footer\">\n      <p>This is an automated summary from Reignite Health AI.</p>\n      <p>Agent: {{ $json.agent_id }} (v{{ $json.agent_version }})</p>\n    </div>\n  </div>\n</body>\n</html>","options":{}},"id":"54c05e88-812a-4f37-8d79-0992652ec7c9","name":"Send Email via Gmail","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[304,0],"webhookId":"f9f51f13-64bd-4444-afc4-c52c03c102fa","credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}},{"parameters":{"operation":"appendOrUpdate","documentId":{"__rl":true,"value":"1RCT-JiTk7cm9uu9cVKG11K4WI0HLz_615Da37WqIz80","mode":"id"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1RCT-JiTk7cm9uu9cVKG11K4WI0HLz_615Da37WqIz80/edit#gid=0"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":[],"schema":[{"id":"call_id","displayName":"call_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"readOnly":false,"removed":false},{"id":"date","displayName":"date","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"readOnly":false,"removed":false},{"id":"time","displayName":"time","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"readOnly":false,"removed":false},{"id":"caller_id","displayName":"caller_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"readOnly":false,"removed":false},{"id":"client_name","displayName":"client_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"readOnly":false,"removed":false},{"id":"cliniko_id","displayName":"cliniko_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"readOnly":false,"removed":false},{"id":"village","displayName":"village","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"readOnly":false,"removed":false},{"id":"duration_seconds","displayName":"duration_seconds","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"readOnly":false,"removed":false},{"id":"intent","displayName":"intent","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"readOnly":false,"removed":false},{"id":"outcome","displayName":"outcome","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"readOnly":false,"removed":false},{"id":"escalated","displayName":"escalated","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"readOnly":false,"removed":false},{"id":"errors","displayName":"errors","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"readOnly":false,"removed":false},{"id":"recording_url","displayName":"recording_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"readOnly":false,"removed":false},{"id":"notes","displayName":"notes","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"readOnly":false,"removed":false}]},"options":{}},"id":"b1534254-d663-4652-a626-0e41ac7379c5","name":"Log to Google Sheets","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[304,192],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"mode":"combine","combinationMode":"mergeByPosition","options":{}},"id":"44f29c55-aea5-4d20-b270-a6ddc3974aa8","name":"Merge Branches","type":"n8n-nodes-base.merge","typeVersion":2.1,"position":[528,96]},{"parameters":{"assignments":{"assignments":[{"id":"success-response-1","name":"success","value":true,"type":"boolean"},{"id":"success-response-2","name":"message","value":"Call processed - email and sheets logged","type":"string"},{"id":"success-response-3","name":"call_id","value":"={{ $('Compose Data for Sheets').first().json.call_id }}","type":"string"},{"id":"success-response-4","name":"timestamp","value":"={{ new Date().toISOString() }}","type":"string"}]},"options":{}},"id":"06f881e3-c776-4927-ad61-4ab7415b8b09","name":"Success Response","type":"n8n-nodes-base.set","typeVersion":3.3,"position":[752,96]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"b123303f-0984-4140-87ee-f91098244588","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[976,96]}],"connections":{"Webhook":{"main":[[{"node":"Is Call Analyzed Event?","type":"main","index":0}]]},"Is Call Analyzed Event?":{"main":[[{"node":"Check If Already Processed","type":"main","index":0}]]},"Check If Already Processed":{"main":[[{"node":"Skip If Already Processed","type":"main","index":0}]]},"Skip If Already Processed":{"main":[[{"node":"Mark As Processed","type":"main","index":0}]]},"Mark As Processed":{"main":[[{"node":"Postgres Load Transfer","type":"main","index":0}]]},"Postgres Load Transfer":{"main":[[{"node":"Compose Data for Email","type":"main","index":0},{"node":"Compose Data for Sheets","type":"main","index":0}]]},"Compose Data for Email":{"main":[[{"node":"Is Inbound Call > 10s?","type":"main","index":0}]]},"Is Inbound Call > 10s?":{"main":[[{"node":"Send Email via Gmail","type":"main","index":0}]]},"Send Email via Gmail":{"main":[[{"node":"Merge Branches","type":"main","index":0}]]},"Log to Google Sheets":{"main":[[{"node":"Merge Branches","type":"main","index":1}]]},"Merge Branches":{"main":[[{"node":"Success Response","type":"main","index":0}]]},"Success Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Compose Data for Sheets":{"main":[[{"node":"Log to Google Sheets","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"4d52701f-39c9-452d-a1e9-91e643438b82","triggerCount":1,"shared":[{"updatedAt":"2025-11-23T20:37:06.576Z","createdAt":"2025-11-23T20:37:06.576Z","role":"workflow:owner","workflowId":"HRFLzjFg3Neaqhyp","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-29T03:35:02.079Z","createdAt":"2025-11-23T21:06:29.336Z","id":"Mk1JzdKBWDsBiz2S","name":"n8n Daily Error Report v1.5","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"hours","triggerAtMinute":20}]}},"id":"1dba7d05-3c69-420e-a340-3e0d4dd77e6a","name":"Schedule Trigger (Hourly)","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,0]},{"parameters":{"url":"https://auto.yr.com.au/api/v1/workflows?active=true","sendHeaders":true,"headerParameters":{"parameters":[{"name":"X-N8N-API-KEY","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwZmRmM2Y0Ni1iNGIxLTRlYjMtYTdlZS05MGYxZDczMzE3NDUiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzYzODg3NDQyfQ.nMvcYGkjKHMkGVXXVr8Pfh61wT4WgWgX5SOtDNBW-F4"}]},"options":{}},"id":"get-workflows","name":"Get Active Workflows","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[240,0],"alwaysOutputData":true},{"parameters":{"url":"https://auto.yr.com.au/api/v1/executions?status=error&limit=200","sendHeaders":true,"headerParameters":{"parameters":[{"name":"X-N8N-API-KEY","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwZmRmM2Y0Ni1iNGIxLTRlYjMtYTdlZS05MGYxZDczMzE3NDUiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzYzODg3NDQyfQ.nMvcYGkjKHMkGVXXVr8Pfh61wT4WgWgX5SOtDNBW-F4"}]},"options":{}},"id":"get-failed","name":"Get Failed Executions","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[480,0],"alwaysOutputData":true},{"parameters":{"url":"https://auto.yr.com.au/api/v1/executions?status=success&limit=250","sendHeaders":true,"headerParameters":{"parameters":[{"name":"X-N8N-API-KEY","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwZmRmM2Y0Ni1iNGIxLTRlYjMtYTdlZS05MGYxZDczMzE3NDUiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzYzODg3NDQyfQ.nMvcYGkjKHMkGVXXVr8Pfh61wT4WgWgX5SOtDNBW-F4"}]},"options":{}},"id":"get-success","name":"Get Successful Executions","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[720,0],"alwaysOutputData":true},{"parameters":{"jsCode":"// Error categorization logic\n// This node receives data sequentially from the chain\n// NEW: Ignores errors that occurred BEFORE workflow was last edited\n// v1.5: Only checks errors in the LAST HOUR (not 12 hours) for more frequent checking\n\nconst N8N_ERROR_PATTERNS = {\n  'timeout': [\n    /timeout/i,\n    /timed out/i,\n    /ETIMEDOUT/i,\n    /ESOCKETTIMEDOUT/i,\n    /request timeout/i\n  ],\n  'network': [\n    /ECONNREFUSED/i,\n    /ENOTFOUND/i,\n    /EHOSTUNREACH/i,\n    /network error/i,\n    /socket hang up/i,\n    /ECONNRESET/i\n  ],\n  'authentication': [\n    /unauthorized/i,\n    /401/i,\n    /403/i,\n    /authentication failed/i,\n    /invalid credentials/i,\n    /API key/i\n  ],\n  'rate_limit': [\n    /429/i,\n    /too many requests/i,\n    /rate limit/i,\n    /quota exceeded/i\n  ],\n  'workflow_execution': [\n    /workflow execution failed/i,\n    /node execution failed/i,\n    /missing required parameter/i,\n    /undefined is not a function/i,\n    /cannot read property/i,\n    /relation.*does not exist/i,\n    /does not exist/i\n  ],\n  'server_error': [\n    /500/i,\n    /502/i,\n    /503/i,\n    /504/i,\n    /internal server error/i,\n    /bad gateway/i,\n    /service unavailable/i\n  ]\n};\n\nconst RETELLAI_ERROR_PATTERNS = {\n  'retellai_missing_data': [\n    /is required/i,\n    /required field/i,\n    /missing.*required/i,\n    /parameter.*required/i,\n    /field.*required/i,\n    /must provide/i,\n    /cannot be empty/i,\n    /is undefined/i,\n    /is null/i\n  ],\n  'wrong_tool_called': [\n    /tool.*not found/i,\n    /tool_id.*does not exist/i,\n    /invalid tool_id/i,\n    /tool.*undefined/i\n  ],\n  'cliniko_integration': [\n    /cliniko.*error/i,\n    /client.*not found/i,\n    /appointment.*failed/i,\n    /invalid cliniko/i\n  ]\n};\n\nfunction categorizeError(errorMessage) {\n  if (!errorMessage) return { category: 'uncategorized', subcategory: 'unknown' };\n\n  for (const [subcategory, patterns] of Object.entries(N8N_ERROR_PATTERNS)) {\n    for (const pattern of patterns) {\n      if (pattern.test(errorMessage)) {\n        return { category: 'n8n_error', subcategory };\n      }\n    }\n  }\n\n  for (const [subcategory, patterns] of Object.entries(RETELLAI_ERROR_PATTERNS)) {\n    for (const pattern of patterns) {\n      if (pattern.test(errorMessage)) {\n        return { category: 'retellai_error', subcategory };\n      }\n    }\n  }\n\n  return { category: 'uncategorized', subcategory: 'unknown' };\n}\n\nconst currentInput = $input.item.json;\nconst successExecutions = currentInput.data || [];\n\nconst apiKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwZmRmM2Y0Ni1iNGIxLTRlYjMtYTdlZS05MGYxZDczMzE3NDUiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzYzODg3NDQyfQ.nMvcYGkjKHMkGVXXVr8Pfh61wT4WgWgX5SOtDNBW-F4';\nconst baseUrl = 'https://auto.yr.com.au';\n\nlet workflows = [];\nlet failedExecutions = [];\n\ntry {\n  const wfResponse = await this.helpers.httpRequest({\n    method: 'GET',\n    url: `${baseUrl}/api/v1/workflows?active=true`,\n    headers: { 'X-N8N-API-KEY': apiKey }\n  });\n  workflows = wfResponse.data || [];\n} catch (e) {\n  console.log('Failed to fetch workflows');\n}\n\ntry {\n  const failedResponse = await this.helpers.httpRequest({\n    method: 'GET',\n    url: `${baseUrl}/api/v1/executions?status=error&limit=250`,\n    headers: { 'X-N8N-API-KEY': apiKey }\n  });\n  failedExecutions = failedResponse.data || [];\n} catch (e) {\n  console.log('Failed to fetch failed executions');\n}\n\n// Create maps for workflow info INCLUDING updatedAt timestamp\nconst activeWorkflowIds = new Set();\nconst activeWorkflowNames = {};\nconst workflowUpdatedAt = {};  // Track when each workflow was last edited\n\nfor (const wf of workflows) {\n  if (wf && wf.id && wf.active) {\n    activeWorkflowIds.add(wf.id);\n    activeWorkflowNames[wf.id] = wf.name;\n    // Store the updatedAt timestamp for filtering\n    workflowUpdatedAt[wf.id] = wf.updatedAt ? new Date(wf.updatedAt) : null;\n  }\n}\n\n// v1.5: Check only LAST HOUR for more frequent monitoring\nconst oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);\n\nconst errors = [];\nconst n8nErrors = [];\nconst retellErrors = [];\nconst uncategorizedErrors = [];\nlet skippedDueToEdit = 0;  // Track how many errors we skip\n\nfor (const execution of failedExecutions) {\n  if (!execution || !execution.workflowId) continue;\n  if (!activeWorkflowIds.has(execution.workflowId)) continue;\n  \n  const startedAt = execution.startedAt ? new Date(execution.startedAt) : null;\n  if (!startedAt || startedAt < oneHourAgo) continue;\n\n  // Skip errors that occurred BEFORE the workflow was last edited\n  const wfUpdated = workflowUpdatedAt[execution.workflowId];\n  if (wfUpdated && startedAt < wfUpdated) {\n    skippedDueToEdit++;\n    continue;  // Skip this error - workflow has been edited since\n  }\n\n  let errorMessage = '';\n  let nodeName = 'Unknown';\n  \n  if (execution.data && execution.data.resultData) {\n    const resultData = execution.data.resultData;\n    if (resultData.error) {\n      errorMessage = resultData.error.message || JSON.stringify(resultData.error);\n      if (resultData.error.node && resultData.error.node.name) {\n        nodeName = resultData.error.node.name;\n      }\n    }\n    if (resultData.lastNodeExecuted && nodeName === 'Unknown') {\n      nodeName = resultData.lastNodeExecuted;\n    }\n  }\n  \n  if (!errorMessage && execution.stoppedAt && execution.status === 'error') {\n    errorMessage = 'Execution failed without explicit error message';\n  }\n\n  if (!errorMessage) {\n    errorMessage = 'Unknown error';\n  }\n\n  const { category, subcategory } = categorizeError(errorMessage);\n\n  const errorRecord = {\n    execution_id: execution.id,\n    workflow_id: execution.workflowId,\n    workflow_name: activeWorkflowNames[execution.workflowId] || execution.workflowName || 'Unknown',\n    started_at: execution.startedAt,\n    node_name: nodeName,\n    error_message: errorMessage,\n    category: category,\n    subcategory: subcategory,\n    error_source: category === 'retellai_error' ? 'üî¥ RetellAI' : (category === 'n8n_error' ? 'üîß n8n' : '‚ùì Other')\n  };\n\n  errors.push(errorRecord);\n\n  if (category === 'n8n_error') {\n    n8nErrors.push(errorRecord);\n  } else if (category === 'retellai_error') {\n    retellErrors.push(errorRecord);\n  } else {\n    uncategorizedErrors.push(errorRecord);\n  }\n}\n\n// Get unique successful workflows (only active, last hour, after last edit)\nconst successByWorkflow = {};\nfor (const execution of successExecutions) {\n  if (!execution || !execution.workflowId) continue;\n  if (!activeWorkflowIds.has(execution.workflowId)) continue;\n  \n  const startedAt = execution.startedAt ? new Date(execution.startedAt) : null;\n  if (!startedAt || startedAt < oneHourAgo) continue;\n\n  // Also filter successes to only count those after last edit\n  const wfUpdated = workflowUpdatedAt[execution.workflowId];\n  if (wfUpdated && startedAt < wfUpdated) continue;\n\n  const wfId = execution.workflowId;\n  if (!successByWorkflow[wfId]) {\n    successByWorkflow[wfId] = {\n      workflow_name: activeWorkflowNames[wfId] || execution.workflowName || 'Unknown',\n      success_count: 0,\n      last_success: null\n    };\n  }\n  successByWorkflow[wfId].success_count++;\n  if (!successByWorkflow[wfId].last_success || new Date(execution.startedAt) > new Date(successByWorkflow[wfId].last_success)) {\n    successByWorkflow[wfId].last_success = execution.startedAt;\n  }\n}\n\nconst successfulWorkflows = Object.values(successByWorkflow).sort((a, b) => a.workflow_name.localeCompare(b.workflow_name));\n\nreturn [{\n  json: {\n    errors: errors,\n    n8n_errors: n8nErrors,\n    retellai_errors: retellErrors,\n    uncategorized_errors: uncategorizedErrors,\n    successful_workflows: successfulWorkflows,\n    active_workflows_count: activeWorkflowIds.size,\n    skipped_pre_edit_errors: skippedDueToEdit,\n    has_errors: errors.length > 0,\n    summary: {\n      total_errors: errors.length,\n      n8n_errors_count: n8nErrors.length,\n      retellai_errors_count: retellErrors.length,\n      uncategorized_count: uncategorizedErrors.length,\n      successful_workflows_count: successfulWorkflows.length,\n      active_workflows_total: activeWorkflowIds.size,\n      skipped_pre_edit_errors: skippedDueToEdit\n    }\n  }\n}];"},"id":"d7b01219-2865-4f46-b579-80acf1cf27ad","name":"Analyze Errors with Categorization","type":"n8n-nodes-base.code","typeVersion":2,"position":[960,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition-has-errors","leftValue":"={{ $json.has_errors }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"check-has-errors","name":"Has Errors?","type":"n8n-nodes-base.if","typeVersion":2,"position":[1200,0]},{"parameters":{"jsCode":"const data = $input.item.json;\nconst errors = data.errors || [];\nconst n8nErrors = data.n8n_errors || [];\nconst retellErrors = data.retellai_errors || [];\nconst uncategorizedErrors = data.uncategorized_errors || [];\nconst successfulWorkflows = data.successful_workflows || [];\nconst summary = data.summary || {};\n\n// Format timestamp\nconst now = new Date();\nconst reportTime = now.toLocaleString('en-AU', { timeZone: 'Australia/Melbourne' });\nconst reportPeriod = '1 hour';  // v1.5: Changed to 1 hour\n\n// Helper to escape HTML\nconst esc = (s) => String(s ?? '').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[c]));\n\n// Helper to format timestamp\nfunction formatTime(ts) {\n  if (!ts) return 'N/A';\n  try {\n    const d = new Date(ts);\n    if (isNaN(d)) return 'N/A';\n    return d.toLocaleString('en-AU', { timeZone: 'Australia/Melbourne' });\n  } catch (e) {\n    return 'N/A';\n  }\n}\n\n// Table styles\nconst tableStyle = 'style=\"border-collapse:collapse;width:100%;margin-bottom:20px;border:1px solid #e5e7eb;font-family:Arial,Helvetica,sans-serif\"';\nconst thStyle = 'style=\"padding:10px;border:1px solid #e5e7eb;background:#f9fafb;text-align:left;font-weight:600;font-size:13px;color:#111827\"';\nconst tdStyle = 'style=\"padding:10px;border:1px solid #e5e7eb;font-size:13px;vertical-align:top\"';\nconst tdErrorStyle = 'style=\"padding:10px;border:1px solid #e5e7eb;font-size:12px;vertical-align:top;max-width:400px;word-wrap:break-word\"';\n\n// Build summary section\nlet summaryHtml = `\n<div style=\"background:#fef2f2;border-left:4px solid #dc2626;padding:15px;margin-bottom:20px\">\n  <h3 style=\"margin:0 0 10px 0;color:#dc2626;font-family:Arial,Helvetica,sans-serif\">üö® New Errors Detected</h3>\n  <p style=\"margin:5px 0;font-family:Arial,Helvetica,sans-serif;font-size:14px\"><strong>Report Time:</strong> ${esc(reportTime)}</p>\n  <p style=\"margin:5px 0;font-family:Arial,Helvetica,sans-serif;font-size:14px\"><strong>Period:</strong> Last ${reportPeriod}</p>\n  <p style=\"margin:5px 0;font-family:Arial,Helvetica,sans-serif;font-size:14px\"><strong>Active Workflows:</strong> ${summary.active_workflows_total}</p>\n  <p style=\"margin:5px 0;font-family:Arial,Helvetica,sans-serif;font-size:14px\"><strong>Total Errors:</strong> ${summary.total_errors}</p>\n  <p style=\"margin:5px 0 0 0;font-family:Arial,Helvetica,sans-serif;font-size:14px\">\n    ‚Ä¢ üîß n8n Infrastructure Errors: <strong>${summary.n8n_errors_count}</strong><br>\n    ‚Ä¢ üî¥ RetellAI Workflow Errors: <strong>${summary.retellai_errors_count}</strong><br>\n    ‚Ä¢ ‚ùì Other/Uncategorized: <strong>${summary.uncategorized_count}</strong>\n  </p>\n  ${summary.skipped_pre_edit_errors > 0 ? `<p style=\"margin:10px 0 0 0;font-family:Arial,Helvetica,sans-serif;font-size:12px;color:#6b7280\"><em>‚ÑπÔ∏è ${summary.skipped_pre_edit_errors} older errors skipped (occurred before workflow was edited)</em></p>` : ''}\n</div>\n`;\n\n// Build errors table (with categorization)\nlet errorsTableHtml = `\n<h3 style=\"color:#dc2626;font-family:Arial,Helvetica,sans-serif;margin-top:20px\">‚ùå Errors Detected</h3>\n<table ${tableStyle}>\n  <thead>\n    <tr>\n      <th ${thStyle}>Source</th>\n      <th ${thStyle}>Workflow</th>\n      <th ${thStyle}>Error Time</th>\n      <th ${thStyle}>Node</th>\n      <th ${thStyle}>Error Message</th>\n      <th ${thStyle}>Execution ID</th>\n    </tr>\n  </thead>\n  <tbody>\n`;\n\n// Sort by category (RetellAI first, then n8n, then uncategorized)\nconst sortedErrors = [...errors].sort((a, b) => {\n  const order = { 'retellai_error': 0, 'n8n_error': 1, 'uncategorized': 2 };\n  return order[a.category] - order[b.category];\n});\n\nfor (const error of sortedErrors) {\n  const sourceColor = error.category === 'retellai_error' ? '#dc2626' : (error.category === 'n8n_error' ? '#ea580c' : '#6b7280');\n  errorsTableHtml += `\n    <tr>\n      <td ${tdStyle} style=\"color:${sourceColor};font-weight:600\">${esc(error.error_source)}</td>\n      <td ${tdStyle}>${esc(error.workflow_name)}</td>\n      <td ${tdStyle}>${esc(formatTime(error.started_at))}</td>\n      <td ${tdStyle}>${esc(error.node_name)}</td>\n      <td ${tdErrorStyle}>${esc(error.error_message.substring(0, 200))}${error.error_message.length > 200 ? '...' : ''}</td>\n      <td ${tdStyle} style=\"font-family:monospace;font-size:11px\">${esc(error.execution_id)}</td>\n    </tr>\n`;\n}\n\nerrorsTableHtml += `\n  </tbody>\n</table>\n`;\n\n// Build categorization breakdown\nlet categorizationHtml = `\n<h3 style=\"color:#1e40af;font-family:Arial,Helvetica,sans-serif;margin-top:30px\">üìà Error Categorization Breakdown</h3>\n<table ${tableStyle}>\n  <thead>\n    <tr>\n      <th ${thStyle}>Category</th>\n      <th ${thStyle}>Count</th>\n      <th ${thStyle}>Percentage</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td ${tdStyle}>üî¥ RetellAI Workflow Errors</td>\n      <td ${tdStyle} style=\"text-align:center\">${summary.retellai_errors_count}</td>\n      <td ${tdStyle} style=\"text-align:center\">${summary.total_errors > 0 ? Math.round((summary.retellai_errors_count / summary.total_errors) * 100) : 0}%</td>\n    </tr>\n    <tr>\n      <td ${tdStyle}>üîß n8n Infrastructure Errors</td>\n      <td ${tdStyle} style=\"text-align:center\">${summary.n8n_errors_count}</td>\n      <td ${tdStyle} style=\"text-align:center\">${summary.total_errors > 0 ? Math.round((summary.n8n_errors_count / summary.total_errors) * 100) : 0}%</td>\n    </tr>\n    <tr>\n      <td ${tdStyle}>‚ùì Other/Uncategorized</td>\n      <td ${tdStyle} style=\"text-align:center\">${summary.uncategorized_count}</td>\n      <td ${tdStyle} style=\"text-align:center\">${summary.total_errors > 0 ? Math.round((summary.uncategorized_count / summary.total_errors) * 100) : 0}%</td>\n    </tr>\n  </tbody>\n</table>\n`;\n\n// Combine all sections\nconst emailHtml = `\n<div style=\"font-family:Arial,Helvetica,sans-serif;max-width:1200px;margin:0 auto;padding:20px\">\n  <h2 style=\"color:#dc2626;border-bottom:3px solid #dc2626;padding-bottom:10px;font-family:Arial,Helvetica,sans-serif\">üö® n8n Error Alert</h2>\n  \n  ${summaryHtml}\n  \n  ${errorsTableHtml}\n  \n  ${categorizationHtml}\n  \n  <div style=\"margin-top:30px;padding-top:20px;border-top:1px solid #e5e7eb;text-align:center;font-size:12px;color:#6b7280\">\n    <p>Automated alert generated by n8n monitoring workflow v1.5</p>\n    <p>This email is only sent when new errors are detected.</p>\n    <p>Powered by Yes AI Consultants Australia - <a href=\"https://www.YesAI.au\" style=\"color:#6b7280;text-decoration:none\">www.YesAI.au</a></p>\n  </div>\n</div>\n`;\n\nconst subject = `üö® [n8n] ${summary.total_errors} new error${summary.total_errors > 1 ? 's' : ''} detected`;\n\nreturn [{\n  json: {\n    subject: subject,\n    html: emailHtml,\n    summary: summary,\n    report_time: reportTime\n  }\n}];"},"id":"ce4e1dcb-c5fb-499b-969b-8e35ef89097a","name":"Compose Email Report","type":"n8n-nodes-base.code","typeVersion":2,"position":[1440,-100]},{"parameters":{"sendTo":"peter@yesai.au","subject":"={{ $json.subject }}","message":"={{ $json.html }}","options":{"senderName":"n8n Monitoring"}},"id":"d7738ced-5f35-416f-8cd7-15eb102ad43a","name":"Send Email via Gmail","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[1680,-100],"credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}},{"parameters":{},"id":"no-action-node","name":"No Errors - Skip Email","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1440,100]}],"connections":{"Schedule Trigger (Hourly)":{"main":[[{"node":"Get Active Workflows","type":"main","index":0}]]},"Get Active Workflows":{"main":[[{"node":"Get Failed Executions","type":"main","index":0}]]},"Get Failed Executions":{"main":[[{"node":"Get Successful Executions","type":"main","index":0}]]},"Get Successful Executions":{"main":[[{"node":"Analyze Errors with Categorization","type":"main","index":0}]]},"Analyze Errors with Categorization":{"main":[[{"node":"Has Errors?","type":"main","index":0}]]},"Has Errors?":{"main":[[{"node":"Compose Email Report","type":"main","index":0}],[{"node":"No Errors - Skip Email","type":"main","index":0}]]},"Compose Email Report":{"main":[[{"node":"Send Email via Gmail","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":{"node:Schedule Trigger (7am & 7pm)":{"recurrenceRules":[0]},"node:Schedule Trigger (Hourly)":{"recurrenceRules":[]}},"meta":null,"pinData":{},"versionId":"d22422bb-4573-46bd-a767-ffbfa641d1d9","triggerCount":1,"shared":[{"updatedAt":"2025-11-23T21:06:29.336Z","createdAt":"2025-11-23T21:06:29.336Z","role":"workflow:owner","workflowId":"Mk1JzdKBWDsBiz2S","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-03T19:22:06.783Z","createdAt":"2025-11-24T04:09:50.421Z","id":"cCJFdILbfg4VIldj","name":"RetellAI - Email End of Call Summary + Sheets v8.1 UNIFIED","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/email-call-summary","responseMode":"responseNode","options":{}},"id":"080540df-b49f-4f06-b2f3-f0f096eebdce","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-448,208],"webhookId":"1565fad1-c77c-46bf-b164-2f40bf462708"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $('Webhook').item.json.body?.event }}","rightValue":"call_analyzed","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"068c522b-290a-4ff3-8c2c-28479da3c264","name":"Is Call Analyzed Event?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,208]},{"parameters":{"operation":"executeQuery","query":"-- Check if we've already processed this call_id\n-- This prevents duplicate emails\n\nCREATE TABLE IF NOT EXISTS processed_call_emails (\n  call_id      text PRIMARY KEY,\n  processed_at timestamptz DEFAULT now(),\n  email_sent   boolean DEFAULT true\n);\n\n-- Check if this call_id exists\nSELECT \n  call_id,\n  processed_at,\n  email_sent\nFROM processed_call_emails\nWHERE call_id = '{{ $('Webhook').first().json.body.call.call_id }}'\nLIMIT 1;","options":{}},"id":"6e701ece-7161-4adc-89cb-f5c5f9500f7f","name":"Check If Already Processed","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[0,208],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// FIXED: Check if this call has already been processed\nconst items = $input.all();\n\nif (!items || items.length === 0) {\n  console.log('NEW CALL: No items from DB check, continuing...');\n  return items;\n}\n\nconst pgResult = items[0].json;\n\n// PostgreSQL returns empty array [] when no rows found\nif (Array.isArray(pgResult) && pgResult.length === 0) {\n  console.log('NEW CALL: Empty array from DB, not processed yet');\n  return items;\n}\n\n// If pgResult is a non-empty array, check first item\nif (Array.isArray(pgResult) && pgResult.length > 0 && pgResult[0].call_id) {\n  console.log('DUPLICATE PREVENTED: Call already processed, skipping');\n  return [];\n}\n\n// If pgResult is an object with call_id, already processed\nif (pgResult && !Array.isArray(pgResult) && pgResult.call_id) {\n  console.log('DUPLICATE PREVENTED: Call already processed, skipping');\n  return [];\n}\n\nconsole.log('NEW CALL: Not processed yet, continuing...');\nreturn items;"},"id":"9a610d56-750d-47c7-a396-42f8bc3c0ce2","name":"Skip If Already Processed","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,208]},{"parameters":{"operation":"executeQuery","query":"-- Mark this call as processed FIRST\n-- This ensures we don't send duplicate emails even if the workflow runs twice\n\nINSERT INTO processed_call_emails (call_id, processed_at, email_sent)\nVALUES (\n  '{{ $('Webhook').first().json.body.call.call_id }}',\n  NOW(),\n  true\n)\nON CONFLICT (call_id) DO NOTHING\nRETURNING *;","options":{}},"id":"a69ca148-5ad0-4c72-8925-5cee91abc505","name":"Mark As Processed","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[448,208],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"operation":"executeQuery","query":"-- v8.1 FIX: Look up patient info using BOTH retell_calls AND webhook from_number\n-- This ensures we find the patient even if retell_calls entry is missing\n\nCREATE TABLE IF NOT EXISTS retell_calls (\n  call_id      text PRIMARY KEY,\n  phone_number text,\n  no_phone     boolean DEFAULT false,\n  from_number  text,\n  created_at   timestamptz DEFAULT now(),\n  updated_at   timestamptz DEFAULT now()\n);\n\n-- Get both call_id and from_number from webhook\nWITH call_info AS (\n  SELECT \n    '{{ $('Webhook').first().json.body.call.call_id }}' as search_call_id,\n    '{{ $('Webhook').first().json.body.call.from_number }}' as webhook_from_number\n),\n-- Look for transfer (from Sara's tool)\ntransfer_lookup AS (\n  SELECT *\n  FROM retell_transfers\n  WHERE call_id = (SELECT search_call_id FROM call_info)\n  ORDER BY created_at DESC\n  LIMIT 1\n),\n-- Look for retell_calls entry (from Lookup Caller tool at start of call)\nretell_call_lookup AS (\n  SELECT *\n  FROM retell_calls\n  WHERE call_id = (SELECT search_call_id FROM call_info)\n  LIMIT 1\n),\n-- Normalize the webhook from_number to E.164 format\nnormalized_webhook_phone AS (\n  SELECT \n    CASE \n      WHEN (SELECT webhook_from_number FROM call_info) LIKE '+%' THEN (SELECT webhook_from_number FROM call_info)\n      WHEN (SELECT webhook_from_number FROM call_info) LIKE '0%' THEN '+61' || SUBSTRING((SELECT webhook_from_number FROM call_info) FROM 2)\n      ELSE '+61' || (SELECT webhook_from_number FROM call_info)\n    END as normalized_phone\n),\n-- Look up patient by phone - try retell_calls first, then webhook from_number\npatient_lookup AS (\n  SELECT\n    patient_id,\n    first_name,\n    last_name,\n    preferred_name,\n    email,\n    phone,\n    phone_mobile,\n    date_of_birth,\n    village,\n    archived\n  FROM patients\n  WHERE archived = false\n    AND (\n      -- Try retell_calls phone first\n      phone_normalized = (SELECT phone_number FROM retell_call_lookup)\n      OR phone_mobile_normalized = (SELECT phone_number FROM retell_call_lookup)\n      -- Fallback: try webhook from_number directly\n      OR phone_normalized = (SELECT normalized_phone FROM normalized_webhook_phone)\n      OR phone_mobile_normalized = (SELECT normalized_phone FROM normalized_webhook_phone)\n      -- Also try the raw webhook from_number (in case it's already E.164)\n      OR phone_normalized = (SELECT webhook_from_number FROM call_info)\n      OR phone_mobile_normalized = (SELECT webhook_from_number FROM call_info)\n    )\n  ORDER BY \n    -- Prefer exact matches on retell_calls phone_number (most reliable)\n    CASE WHEN phone_normalized = (SELECT phone_number FROM retell_call_lookup) THEN 0 ELSE 1 END,\n    -- Then prefer matches on webhook from_number\n    CASE WHEN phone_normalized = (SELECT normalized_phone FROM normalized_webhook_phone) THEN 0 ELSE 1 END\n  LIMIT 1\n)\n-- ALWAYS return one row with merged data\nSELECT\n  -- Transfer fields (from Sara's tool)\n  t.transfer_id,\n  COALESCE(t.call_id, ci.search_call_id) as call_id,\n  t.created_at as transfer_created_at,\n  t.updated_at as transfer_updated_at,\n  \n  -- Caller info: prefer transfer, fallback to patient lookup\n  COALESCE(\n    t.caller_name,\n    CASE \n      WHEN p.preferred_name IS NOT NULL AND p.preferred_name != '' \n        THEN p.preferred_name || ' ' || p.last_name\n      ELSE CONCAT(p.first_name, ' ', p.last_name)\n    END\n  ) as caller_name,\n  \n  COALESCE(t.village, p.village) as village,\n  \n  COALESCE(\n    t.patient_id,\n    p.patient_id::text\n  ) as patient_id,\n  \n  -- Transfer-specific fields\n  t.phone_number as transfer_phone_number,\n  t.no_phone,\n  t.intent,\n  t.urgency,\n  t.details,\n  \n  -- retell_calls data\n  rc.phone_number AS stored_phone_number,\n  rc.no_phone AS stored_no_phone,\n  COALESCE(rc.from_number, ci.webhook_from_number) AS carrier_from_number,\n  \n  -- Patient data for reference\n  p.first_name,\n  p.last_name,\n  p.preferred_name,\n  p.email,\n  p.phone as patient_phone,\n  p.phone_mobile as patient_mobile,\n  p.date_of_birth,\n  p.village as patient_village\n  \nFROM call_info ci\nLEFT JOIN transfer_lookup t ON TRUE\nLEFT JOIN retell_call_lookup rc ON TRUE\nLEFT JOIN patient_lookup p ON TRUE\nLIMIT 1;","options":{"queryReplacement":""}},"id":"689c7d41-744d-4241-a89a-50b9981648b0","name":"Postgres Load Transfer","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[672,208],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// UNIFIED EMAIL TEMPLATE v8.1 - Call Summary\n// FIX: Now receives patient data from improved SQL query that uses webhook from_number as fallback\n\n// Get webhook data\nconst wh = $items('Webhook')?.[0]?.json || {};\nconst body = wh.body || {};\nconst call = body.call || {};\n\n// Row from Postgres Load Transfer\nconst row = Array.isArray($json) ? ($json[0] || {}) : ($json || {});\n\n// HTML escape\nconst esc = (s) => String(s ?? '').replace(/[&<>\"']/g, c => (\n  {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[c]\n));\n\n// AU E.164 normalization\nfunction normAU(p) {\n  if (!p) return null;\n  let d = ('' + p).replace(/[^0-9+]/g, '');\n  if (d.startsWith('+')) return d;\n  if (d.startsWith('0')) d = '61' + d.slice(1);\n  if (!d.startsWith('61')) d = '61' + d;\n  return '+' + d;\n}\n\n// Time formatting (Australia/Melbourne)\nfunction fmtAU(ts) {\n  if (!ts) return null;\n  const d = new Date(ts);\n  if (isNaN(d)) return null;\n  return d.toLocaleString('en-AU', { timeZone: 'Australia/Melbourne' });\n}\n\nfunction humanDuration(ms) {\n  if (ms == null || isNaN(ms)) return null;\n  const total = Math.max(0, Math.floor(Number(ms) / 1000));\n  const m = Math.floor(total / 60);\n  const s = total % 60;\n  return `${m}m ${s}s`;\n}\n\n// Extract data - prefer Postgres row, fallback to call data\nconst fromPhone = normAU(row.carrier_from_number || call.from_number) || '[not captured]';\n\n// Callback phone: use stored phone, transfer phone, patient phone, or webhook from_number\nlet callbackBase = null;\nif (row.no_phone === true) {\n  callbackBase = null;\n} else {\n  callbackBase = row.stored_phone_number || row.transfer_phone_number || row.patient_phone || row.patient_mobile || call.from_number || null;\n}\nconst callbackPhone = (row.no_phone === true) ? 'No phone (declined)' : (normAU(callbackBase) || '[not provided]');\n\n// Caller info - now populated from patient lookup via improved SQL\nconst caller = row.caller_name?.trim() || 'Unknown';\nconst village = row.village || row.patient_village || 'N/A';\nconst intent = row.intent || 'general enquiry';\nconst urgency = row.urgency || 'routine';\nconst details = row.details || '';\nconst patientId = row.patient_id || 'N/A';\n\n// Call meta\nconst startTime = fmtAU(call.start_timestamp);\nconst endTime = fmtAU(call.end_timestamp);\nconst duration = ('duration_ms' in call) ? humanDuration(call.duration_ms) : null;\nconst disconnect = call.disconnection_reason || null;\nconst recordingUrl = call.recording_url || null;\nconst publicLogUrl = call.public_log_url || null;\nconst callStatus = call.call_status || 'unknown';\nconst direction = call.direction || 'unknown';\n\n// Transcript\nfunction roleLabel(r) {\n  if (!r) return 'Unknown';\n  const t = r.toLowerCase();\n  if (['assistant','agent','ai'].includes(t)) return 'Agent';\n  if (['user','caller','human'].includes(t)) return 'User';\n  return r.charAt(0).toUpperCase() + r.slice(1);\n}\n\nlet htmlTranscript = 'No transcript available';\nif (Array.isArray(call.transcript_object) && call.transcript_object.length) {\n  htmlTranscript = call.transcript_object\n    .map(t => `${esc(roleLabel(t.role))}: ${esc((t.content || '').trim())}`)\n    .join('<br><br>');\n}\n\n// Subject - unified format\nconst durationStr = duration || 'N/A';\nconst subject = `[Reignite] Call Summary: ${caller} (${durationStr})`;\n\n// Table styles - same as Sara Transfer\nconst td = 'style=\"padding:8px 10px;border:1px solid #e5e7eb;vertical-align:top;font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:20px\"';\nconst th = 'style=\"padding:8px 10px;border:1px solid #e5e7eb;background:#f9fafb;text-align:left;font-weight:600;font-family:Arial,Helvetica,sans-serif;font-size:13px;line-height:18px;color:#111827\"';\n\n// Build conditional rows for Call Timings & Status\nlet timingsRows = `\n  <tr><td ${td}><strong>Start Time</strong></td><td ${td}>${esc(startTime || 'N/A')}</td></tr>\n`;\nif (endTime) timingsRows += `<tr><td ${td}><strong>End Time</strong></td><td ${td}>${esc(endTime)}</td></tr>`;\nif (duration) timingsRows += `<tr><td ${td}><strong>Duration</strong></td><td ${td}>${esc(duration)}</td></tr>`;\ntimingsRows += `<tr><td ${td}><strong>Direction</strong></td><td ${td}>${esc(direction)}</td></tr>`;\ntimingsRows += `<tr><td ${td}><strong>Status</strong></td><td ${td}>${esc(callStatus)}</td></tr>`;\nif (disconnect) timingsRows += `<tr><td ${td}><strong>Disconnection Reason</strong></td><td ${td}>${esc(disconnect)}</td></tr>`;\n\n// Build optional Call Data & Links block\nlet linksBlock = '';\nif (recordingUrl || publicLogUrl) {\n  linksBlock = `<tr><td ${th} colspan=\"2\">Call Data & Links</td></tr>`;\n  if (recordingUrl) {\n    linksBlock += `<tr><td ${td}><strong>Recording URL</strong></td><td ${td}><a href=\"${esc(recordingUrl)}\">${esc(recordingUrl)}</a></td></tr>`;\n  }\n  if (publicLogUrl) {\n    linksBlock += `<tr><td ${td}><strong>Public Log</strong></td><td ${td}><a href=\"${esc(publicLogUrl)}\">${esc(publicLogUrl)}</a></td></tr>`;\n  }\n}\n\n// HTML - unified table format\nconst html = `\n  <table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\"\n         style=\"border-collapse:collapse;width:100%;max-width:780px;border:1px solid #e5e7eb\">\n    <tr><td ${th} colspan=\"2\">Caller</td></tr>\n    <tr><td ${td} style=\"width:240px\"><strong>Name</strong></td><td ${td}>${esc(caller)}</td></tr>\n    <tr><td ${td}><strong>From phone (carrier)</strong></td><td ${td}>${esc(fromPhone)}</td></tr>\n    <tr><td ${td}><strong>Callback phone</strong></td><td ${td}>${esc(callbackPhone)}</td></tr>\n    <tr><td ${td}><strong>Village</strong></td><td ${td}>${esc(village)}</td></tr>\n\n    <tr><td ${th} colspan=\"2\">Request Details</td></tr>\n    <tr><td ${td}><strong>Intent</strong></td><td ${td}>${esc(intent)}</td></tr>\n    <tr><td ${td}><strong>Urgency</strong></td><td ${td}>${esc(urgency)}</td></tr>\n    <tr><td ${td}><strong>Patient ID</strong></td><td ${td}>${esc(patientId)}</td></tr>\n    <tr><td ${td}><strong>Details</strong></td><td ${td}>${esc(details || 'None')}</td></tr>\n\n    <tr><td ${th} colspan=\"2\">Call Timings & Status</td></tr>\n    ${timingsRows}\n\n    ${linksBlock}\n\n    <tr><td ${th} colspan=\"2\">Transcript</td></tr>\n    <tr><td ${td} colspan=\"2\" style=\"background:#fff\">${htmlTranscript}</td></tr>\n\n    <tr><td ${th} colspan=\"2\">Technical</td></tr>\n    <tr><td ${td}><strong>Call ID</strong></td><td ${td}>${esc(call.call_id || 'N/A')}</td></tr>\n    <tr><td ${td}><strong>Agent ID</strong></td><td ${td}>${esc(call.agent_id || 'N/A')}</td></tr>\n    <tr><td ${td}><strong>Agent Version</strong></td><td ${td}>${esc(call.agent_version || 'N/A')}</td></tr>\n  </table>\n  <div style=\"font-family:Arial,Helvetica,sans-serif;font-size:12px;color:#6b7280;margin-top:10px\">\n    Powered by Yes AI <a href=\"https://www.YesAI.au\" style=\"color:#6b7280;text-decoration:none\">www.YesAI.au</a>\n  </div>\n`;\n\n// Also output data for Google Sheets (parallel branch)\nreturn [{ json: { \n  subject, \n  html,\n  // Sheet data\n  call_id: call.call_id || 'N/A',\n  date: startTime ? new Date(call.start_timestamp).toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney' }) : 'N/A',\n  time: startTime ? new Date(call.start_timestamp).toLocaleTimeString('en-AU', { timeZone: 'Australia/Sydney' }) : 'N/A',\n  caller_id: callbackPhone,\n  client_name: caller,\n  cliniko_id: patientId,\n  village: village,\n  duration_seconds: call.duration_ms ? Math.floor(call.duration_ms / 1000) : 0,\n  intent: intent,\n  outcome: callStatus,\n  escalated: urgency,\n  errors: '',\n  recording_url: recordingUrl || 'N/A',\n  notes: details || 'No details provided',\n  direction: direction,\n  duration_ms: call.duration_ms || 0\n} }];"},"id":"f833b885-51ef-45ce-913e-b64e1d34f44e","name":"Compose Email (UNIFIED)","type":"n8n-nodes-base.code","typeVersion":2,"position":[896,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"inbound-check","leftValue":"={{ $json.direction }}","rightValue":"inbound","operator":{"type":"string","operation":"equals"}},{"id":"duration-check","leftValue":"={{ $json.duration_ms }}","rightValue":10000,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"d45a9865-cf2c-4f06-b99b-f872abc85e28","name":"Is Inbound Call > 10s?","type":"n8n-nodes-base.if","typeVersion":2,"position":[1120,112]},{"parameters":{"sendTo":"peter@yesai.au","subject":"={{ $json.subject }}","message":"={{ $json.html }}","options":{}},"id":"050eecc5-3062-4f30-877c-06b19b8c36d5","name":"Send Email via Gmail","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[1344,112],"webhookId":"f9f51f13-64bd-4444-afc4-c52c03c102fa","credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1RCT-JiTk7cm9uu9cVKG11K4WI0HLz_615Da37WqIz80","mode":"id"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1RCT-JiTk7cm9uu9cVKG11K4WI0HLz_615Da37WqIz80/edit#gid=0"},"columns":{"mappingMode":"autoMapInputData","value":{}},"options":{}},"id":"ff3f1157-8ba6-4049-8c66-c02884ed52bc","name":"Log to Google Sheets","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[1344,304],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}}},{"parameters":{"mode":"combine","combinationMode":"mergeByPosition","options":{}},"id":"3db133de-4ff7-4bdb-9227-8f6ffb716687","name":"Merge Branches","type":"n8n-nodes-base.merge","typeVersion":2.1,"position":[1568,208]},{"parameters":{"assignments":{"assignments":[{"id":"success-response-1","name":"success","value":true,"type":"boolean"},{"id":"success-response-2","name":"message","value":"Call processed - email and sheets logged","type":"string"},{"id":"success-response-3","name":"call_id","value":"={{ $('Compose Email (UNIFIED)').first().json.call_id }}","type":"string"},{"id":"success-response-4","name":"timestamp","value":"={{ new Date().toISOString() }}","type":"string"}]},"options":{}},"id":"39e42df4-8cae-438f-8853-f2fb20e936a7","name":"Success Response","type":"n8n-nodes-base.set","typeVersion":3.3,"position":[1792,208]},{"parameters":{"respondWith":"json","responseBody":"={{ { \"success\": true, \"status\": \"processing\", \"message\": \"Call summary email will be sent shortly\", \"call_id\": $(\"Webhook\").first().json.body?.call?.call_id || \"unknown\" } }}","options":{}},"id":"07f3d8d7-36c9-4ea2-b550-ef4ac12ab5a4","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[0,0]}],"connections":{"Webhook":{"main":[[{"node":"Is Call Analyzed Event?","type":"main","index":0}]]},"Is Call Analyzed Event?":{"main":[[{"node":"Respond to Webhook","type":"main","index":0},{"node":"Check If Already Processed","type":"main","index":0}]]},"Check If Already Processed":{"main":[[{"node":"Skip If Already Processed","type":"main","index":0}]]},"Skip If Already Processed":{"main":[[{"node":"Mark As Processed","type":"main","index":0}]]},"Mark As Processed":{"main":[[{"node":"Postgres Load Transfer","type":"main","index":0}]]},"Postgres Load Transfer":{"main":[[{"node":"Compose Email (UNIFIED)","type":"main","index":0}]]},"Compose Email (UNIFIED)":{"main":[[{"node":"Is Inbound Call > 10s?","type":"main","index":0},{"node":"Log to Google Sheets","type":"main","index":0}]]},"Is Inbound Call > 10s?":{"main":[[{"node":"Send Email via Gmail","type":"main","index":0}]]},"Send Email via Gmail":{"main":[[{"node":"Merge Branches","type":"main","index":0}]]},"Log to Google Sheets":{"main":[[{"node":"Merge Branches","type":"main","index":1}]]},"Merge Branches":{"main":[[{"node":"Success Response","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"a82f0331-3772-4a2a-b878-8d942244c643","triggerCount":1,"shared":[{"updatedAt":"2025-11-24T04:09:50.421Z","createdAt":"2025-11-24T04:09:50.421Z","role":"workflow:owner","workflowId":"cCJFdILbfg4VIldj","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-25T08:36:03.266Z","createdAt":"2025-11-24T04:19:12.544Z","id":"FFgsgXXV5KAHy51c","name":"RetellAI - Get Reschedule Availability v1.1 SPOKEN TEXT","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/get-reschedule-availability","responseMode":"responseNode","options":{}},"id":"b3b4bbf9-5b87-44ca-9998-bb851a5c898a","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"a1b2c3d4-e5f6-7890-abcd-ef1234567890"},{"parameters":{"jsCode":"const webhookData = $input.item.json.body?.body || $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\nconst appointment_id = args.appointment_id || '';\nconst preferred_date = args.preferred_date || '';\nconst date_range_days = args.date_range_days || 14;\nconst call_id = call.call_id || args.call_id || '';\n\nif (!appointment_id) {\n  throw new Error('appointment_id is required');\n}\n\nconst targetDate = preferred_date || new Date().toISOString().split('T')[0];\n\nreturn [{\n  json: {\n    appointment_id,\n    preferred_date: targetDate,\n    date_range_days,\n    call_id,\n    start_time: Date.now(),\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"fe2c03f2-fba7-4656-a768-798c1d15b64f","name":"Extract Request Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"url":"=https://api.au2.cliniko.com/v1/individual_appointments/{{ $json.appointment_id }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Accept","value":"application/json"},{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"}]},"options":{"response":{"response":{"responseFormat":"json"}}}},"id":"95324cbb-23cf-4386-a74e-19627bd5d306","name":"Get Current Appointment","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[448,0],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"const response = $input.item.json;\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\nif (response.error || response.statusCode >= 400) {\n  throw new Error('Failed to fetch appointment');\n}\n\nconst appointment = response;\nlet practitioner_id = null;\n\nif (appointment.practitioner?.links?.self) {\n  const match = appointment.practitioner.links.self.match(/practitioners\\/(\\d+)/);\n  if (match && match[1]) {\n    practitioner_id = match[1];\n  }\n}\n\nif (!practitioner_id) {\n  throw new Error('Could not extract practitioner ID');\n}\n\nconst starts_at = new Date(appointment.starts_at);\nconst ends_at = new Date(appointment.ends_at);\nconst duration_minutes = Math.round((ends_at - starts_at) / 60000);\n\nconst original_date = starts_at.toISOString().split('T')[0];\nconst original_time = starts_at.toLocaleTimeString('en-AU', { \n  hour: '2-digit', \n  minute: '2-digit', \n  hour12: true \n});\n\nreturn [{\n  json: {\n    ...requestData,\n    practitioner_id,\n    duration_minutes,\n    original_datetime: appointment.starts_at,\n    original_date,\n    original_time,\n    appointment_type_id: appointment.appointment_type?.id || ''\n  }\n}];"},"id":"b310a5c5-0586-4150-a85a-2021876401b1","name":"Process Current Appointment","type":"n8n-nodes-base.code","typeVersion":2,"position":[656,0]},{"parameters":{"operation":"executeQuery","query":"SELECT id, practitioner_data, \n  EXTRACT(EPOCH FROM (now() - cached_at))/3600 as hours_old\nFROM practitioner_cache\nWHERE cache_key = 'all_practitioners'\n  AND cached_at > now() - interval '24 hours'\nLIMIT 1;","options":{"queryBatching":"single"}},"id":"880c710e-dc77-4017-bb64-6e66ee088342","name":"Check Practitioner Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[880,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"const items = $input.all();\nconst requestData = $items(\"Process Current Appointment\")[0].json;\n\nif (items.length > 0 && items[0].json.id) {\n  const cached = items[0].json;\n  let practitionerData = [];\n  \n  try {\n    practitionerData = JSON.parse(cached.practitioner_data);\n    if (Array.isArray(practitionerData) && practitionerData.length > 0) {\n      return [{\n        json: {\n          ...requestData,\n          practitioners: practitionerData,\n          from_cache: true,\n          needs_cliniko_fetch: false\n        }\n      }];\n    }\n  } catch (e) {\n    // Fall through to fetch\n  }\n}\n\nreturn [{\n  json: {\n    ...requestData,\n    practitioners: [],\n    from_cache: false,\n    needs_cliniko_fetch: true\n  }\n}];"},"id":"7a074871-f6ed-4573-9494-4f65d88d5fa5","name":"Handle Cache","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,0]},{"parameters":{"url":"https://api.au2.cliniko.com/v1/practitioners","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Accept","value":"application/json"},{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"}]},"options":{"response":{"response":{"responseFormat":"json"}}}},"id":"eac58f91-9a6a-4cfa-8042-2cacef901bdb","name":"Fetch Practitioners from Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1328,0],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"const response = $input.item.json;\nconst cacheData = $items(\"Handle Cache\")[0].json;\n\nif (cacheData.from_cache && cacheData.practitioners.length > 0) {\n  return [{ json: { ...cacheData, from_cache: true }}];\n}\n\nif (response.error || response.statusCode >= 400) {\n  throw new Error('Cliniko API error fetching practitioners');\n}\n\nconst practitioners = response.practitioners || [];\nconst mappedPractitioners = practitioners\n  .filter(p => p.active)\n  .map(p => ({\n    cliniko_id: p.id,\n    name: p.label || p.display_name || p.first_name + ' ' + p.last_name,\n    active: p.active\n  }));\n\nreturn [{\n  json: {\n    ...cacheData,\n    practitioners: mappedPractitioners,\n    from_cache: false\n  }\n}];"},"id":"6be4c70b-bbe9-4dcd-bc2c-cb522283534f","name":"Process Cliniko Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1536,0]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO practitioner_cache (cache_key, practitioner_data, cached_at)\nVALUES (\n  'all_practitioners',\n  '{{ JSON.stringify($json.practitioners) }}'::jsonb,\n  now()\n)\nON CONFLICT (cache_key) \nDO UPDATE SET\n  practitioner_data = EXCLUDED.practitioner_data,\n  cached_at = now()\nRETURNING *;","options":{"queryBatching":"single"}},"id":"da630e36-3447-4fb5-be02-a5a268032189","name":"Cache Practitioners","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[1776,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Get practitioners from Cache Practitioners node (PostgreSQL output)\nconst cacheResult = $items(\"Cache Practitioners\")[0].json;\nconst practitioners = cacheResult.practitioner_data || [];\n\n// Get context data from Process Cliniko Response node (has practitioner_id, duration, etc.)\nconst contextData = $items(\"Process Cliniko Response\")[0].json;\n\n// Look up practitioner name\nlet practitioner_name = 'Unknown Practitioner';\nconst practitioner = practitioners.find(p => \n  String(p.cliniko_id) === String(contextData.practitioner_id)\n);\nif (practitioner) {\n  practitioner_name = practitioner.name;\n}\n\n// Date handling\nlet startDate;\nif (contextData.preferred_date && typeof contextData.preferred_date === 'string') {\n  startDate = new Date(contextData.preferred_date + 'T00:00:00.000Z');\n  if (isNaN(startDate.getTime())) {\n    startDate = new Date();\n  }\n} else {\n  startDate = new Date();\n}\n\nconst dateRangeDays = parseInt(contextData.date_range_days) || 14;\nconst endDate = new Date(startDate.getTime());\nendDate.setUTCDate(endDate.getUTCDate() + dateRangeDays);\n\nlet startDateStr;\nlet endDateStr;\ntry {\n  startDateStr = startDate.toISOString().split('T')[0];\n  endDateStr = endDate.toISOString().split('T')[0];\n} catch (e) {\n  const now = new Date();\n  startDateStr = now.toISOString().split('T')[0];\n  const futureDate = new Date(now.getTime());\n  futureDate.setUTCDate(futureDate.getUTCDate() + 14);\n  endDateStr = futureDate.toISOString().split('T')[0];\n}\n\nreturn [{\n  json: {\n    ...contextData,\n    practitioners: practitioners,\n    practitioner_name: practitioner_name,\n    start_date: startDateStr,\n    end_date: endDateStr\n  }\n}];"},"id":"35e77ae9-b915-4036-a1d7-f1e8b70ff09f","name":"Prepare Availability Query","type":"n8n-nodes-base.code","typeVersion":2,"position":[1984,0]},{"parameters":{"url":"https://api.au2.cliniko.com/v1/individual_appointments","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"practitioner_id","value":"={{ $json.practitioner_id }}"},{"name":"per_page","value":"100"},{"name":"sort","value":"starts_at"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Accept","value":"application/json"},{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"}]},"options":{"response":{"response":{"responseFormat":"json"}}}},"id":"bbb767a0-c2bb-40c8-86de-6f810ad489ca","name":"Check Cliniko Availability","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2208,0],"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"const availabilityResponse = $input.item.json;\nconst prepData = $items(\"Prepare Availability Query\")[0].json;\nconst requestData = $items(\"Extract Request Data\")[0].json;\n\nif (availabilityResponse.error || availabilityResponse.statusCode >= 400) {\n  return [{\n    json: {\n      success: true,\n      slots_available: false,\n      total_slots: 0,\n      slots: [],\n      message: 'Unable to check availability',\n      original_appointment: {\n        appointment_id: requestData.appointment_id,\n        current_date: prepData.original_date || 'unknown',\n        current_time: prepData.original_time || 'unknown',\n        practitioner: prepData.practitioner_name || 'Unknown Practitioner',\n        duration_minutes: prepData.duration_minutes || 60\n      },\n      call_id: requestData.call_id,\n      duration_ms: Date.now() - requestData.start_time,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\nconst allAppointments = availabilityResponse.individual_appointments || [];\nconst startDate = new Date(prepData.start_date);\nconst endDate = new Date(prepData.end_date);\n\nconst existingAppointments = allAppointments.filter(appt => {\n  const apptDate = new Date(appt.starts_at);\n  return apptDate >= startDate && apptDate <= endDate;\n});\n\nconst workingHours = { start: 9, end: 17, workingDays: [1,2,3,4,5] };\nconst availableSlots = [];\n\nconst currentDate = new Date(startDate);\nwhile (currentDate <= endDate) {\n  if (!workingHours.workingDays.includes(currentDate.getDay())) {\n    currentDate.setDate(currentDate.getDate() + 1);\n    continue;\n  }\n  \n  const dateStr = currentDate.toISOString().split('T')[0];\n  const dayAppointments = existingAppointments\n    .filter(appt => new Date(appt.starts_at).toISOString().split('T')[0] === dateStr)\n    .map(appt => ({ start: new Date(appt.starts_at), end: new Date(appt.ends_at) }))\n    .sort((a, b) => a.start - b.start);\n  \n  for (let hour = workingHours.start; hour < workingHours.end; hour++) {\n    for (let minute = 0; minute < 60; minute += 15) {\n      const slotStart = new Date(dateStr + 'T00:00:00.000Z');\n      slotStart.setUTCHours(hour, minute, 0, 0);\n      const slotEnd = new Date(slotStart.getTime() + prepData.duration_minutes * 60000);\n      \n      if (slotEnd.getUTCHours() + (slotEnd.getUTCMinutes() / 60) > workingHours.end) continue;\n      \n      let hasConflict = false;\n      for (const appt of dayAppointments) {\n        if (slotStart < appt.end && slotEnd > appt.start) {\n          hasConflict = true;\n          break;\n        }\n      }\n      \n      if (prepData.original_datetime && !hasConflict) {\n        const origStart = new Date(prepData.original_datetime);\n        const origEnd = new Date(origStart.getTime() + prepData.duration_minutes * 60000);\n        if (slotStart < origEnd && slotEnd > origStart) hasConflict = true;\n      }\n      \n      if (!hasConflict) {\n        const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];\n        const displayTime = new Date(slotStart.getTime() + 11 * 60 * 60 * 1000);\n        const timeStr = displayTime.toLocaleTimeString('en-AU', { \n          hour: '2-digit', minute: '2-digit', hour12: true \n        });\n        \n        availableSlots.push({\n          datetime: slotStart.toISOString(),\n          date: dateStr,\n          time: timeStr,\n          day_of_week: dayNames[slotStart.getUTCDay()],\n          practitioner_id: prepData.practitioner_id || 'unknown',\n          practitioner_name: prepData.practitioner_name || 'Unknown Practitioner',\n          duration_minutes: prepData.duration_minutes || 60,\n          is_protected: false\n        });\n      }\n    }\n  }\n  \n  currentDate.setDate(currentDate.getDate() + 1);\n}\n\nconst topSlots = availableSlots.slice(0, 10);\n\nreturn [{\n  json: {\n    success: true,\n    slots_available: topSlots.length > 0,\n    total_slots: topSlots.length,\n    slots: topSlots,\n    message: topSlots.length > 0 \n      ? 'Found ' + topSlots.length + ' available slots'\n      : 'No availability found',\n    original_appointment: {\n      appointment_id: requestData.appointment_id,\n      current_date: prepData.original_date || 'unknown',\n      current_time: prepData.original_time || 'unknown',\n      practitioner: prepData.practitioner_name || 'Unknown Practitioner',\n      duration_minutes: prepData.duration_minutes || 60\n    },\n    call_id: requestData.call_id,\n    duration_ms: Date.now() - requestData.start_time,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"04b664cc-db97-4348-a070-4ab082a376a7","name":"Build Final Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[2432,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"f14baf60-36da-410c-bc91-b6cf9547a8ce","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2656,0]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO webhook_log (\n  webhook_name, call_id, request_body, response_body,\n  success, duration_ms, cache_hit, created_at\n)\nVALUES (\n  'get-reschedule-availability',\n  '{{ $items(\"Extract Request Data\")[0].json.call_id }}',\n  '{{ JSON.stringify($items(\"Extract Request Data\")[0].json) }}'::jsonb,\n  '{{ JSON.stringify($items(\"Build Final Response\")[0].json) }}'::jsonb,\n  true,\n  {{ $items(\"Build Final Response\")[0].json.duration_ms || 0 }},\n  {{ $items(\"Handle Cache\")[0]?.json?.from_cache || false }},\n  now()\n)\nRETURNING *;","options":{"queryBatching":"single"}},"id":"64b92338-3de0-41c0-b0c2-7056e5a202e3","name":"Log Webhook Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[2864,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}}},{"parameters":{"jsCode":"// Generate natural spoken text from availability data\nconst items = $input.all();\nconst data = items[0].json;\n\nconst slots = data.slots || [];\nconst originalAppt = data.original_appointment || {};\n\n// If no slots available\nif (slots.length === 0) {\n  return [{\n    json: {\n      ...data,\n      spoken_text: `I'm sorry, I don't have any available time slots for rescheduling in the next ${data.date_range_days || 14} days. Would you like me to check a different date range, or I can add you to our waitlist for cancellations?`\n    }\n  }];\n}\n\n// Build natural language for available slots\nlet spokenText = `I found ${slots.length} available time slot${slots.length > 1 ? 's' : ''} for rescheduling your appointment. `;\n\n// Add context about current appointment\nif (originalAppt.current_date && originalAppt.current_time) {\n  spokenText += `Your current appointment is on ${originalAppt.current_date} at ${originalAppt.current_time}. `;\n}\n\n// Describe the available slots\nslots.forEach((slot, index) => {\n  const date = new Date(slot.datetime);\n  const dayName = slot.day_of_week || date.toLocaleDateString('en-AU', { weekday: 'long' });\n  const dayMonth = date.toLocaleDateString('en-AU', { day: 'numeric', month: 'long' });\n  const time = slot.time || date.toLocaleTimeString('en-AU', { \n    hour: 'numeric', \n    minute: '2-digit', \n    hour12: true \n  });\n  \n  if (index === 0) {\n    spokenText += `The first available slot is ${dayName}, ${dayMonth} at ${time}. `;\n  } else if (index === slots.length - 1) {\n    spokenText += `And ${dayName}, ${dayMonth} at ${time}.`;\n  } else if (index < 3) {  // Only mention first 3 slots in detail\n    spokenText += `Then ${dayName}, ${dayMonth} at ${time}. `;\n  }\n});\n\n// Add guidance if there are more slots\nif (slots.length > 3) {\n  spokenText += ` I have ${slots.length - 3} more slots available if these don't work for you.`;\n}\n\nreturn [{\n  json: {\n    ...data,\n    spoken_text: spokenText,\n    slots_count: slots.length\n  }\n}];"},"id":"d1ff4f66-2249-49cd-9a19-67b7dffb1352","name":"Generate Spoken Text","type":"n8n-nodes-base.code","typeVersion":2,"position":[2544,0]}],"connections":{"Webhook":{"main":[[{"node":"Extract Request Data","type":"main","index":0}]]},"Extract Request Data":{"main":[[{"node":"Get Current Appointment","type":"main","index":0}]]},"Get Current Appointment":{"main":[[{"node":"Process Current Appointment","type":"main","index":0}]]},"Process Current Appointment":{"main":[[{"node":"Check Practitioner Cache","type":"main","index":0}]]},"Check Practitioner Cache":{"main":[[{"node":"Handle Cache","type":"main","index":0}]]},"Handle Cache":{"main":[[{"node":"Fetch Practitioners from Cliniko","type":"main","index":0}]]},"Fetch Practitioners from Cliniko":{"main":[[{"node":"Process Cliniko Response","type":"main","index":0}]]},"Process Cliniko Response":{"main":[[{"node":"Cache Practitioners","type":"main","index":0}]]},"Cache Practitioners":{"main":[[{"node":"Prepare Availability Query","type":"main","index":0}]]},"Prepare Availability Query":{"main":[[{"node":"Check Cliniko Availability","type":"main","index":0}]]},"Check Cliniko Availability":{"main":[[{"node":"Build Final Response","type":"main","index":0}]]},"Build Final Response":{"main":[[{"node":"Generate Spoken Text","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Log Webhook Execution","type":"main","index":0}]]},"Generate Spoken Text":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"e66bd107-fefe-4b76-b374-88a9bd2d9daf","triggerCount":1,"shared":[{"updatedAt":"2025-11-24T04:19:12.544Z","createdAt":"2025-11-24T04:19:12.544Z","role":"workflow:owner","workflowId":"FFgsgXXV5KAHy51c","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-12-03T18:35:52.591Z","createdAt":"2025-11-25T07:18:06.855Z","id":"jhU2bAKMWzPgWGBj","name":"RetellAI - Book Appointment Compound v1.1 TIMEZONE FIX","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"reignite-retell/book-appointment-compound","responseMode":"responseNode","options":{}},"id":"webhook-trigger-001","name":"Webhook Trigger","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[0,300],"webhookId":"book-appointment-compound"},{"parameters":{"jsCode":"// STANDARD EXTRACTION PATTERN - RetellAI Compatible\n// Book Appointment Compound v1.1 TIMEZONE FIX\n\nconst webhookData = $input.item.json.body || $input.item.json || {};\nconst args = webhookData.args || webhookData;\nconst call = webhookData.call || {};\n\n// ============================================\n// PHONE NORMALIZATION (NSW Default) - v9.09 GEM v2\n// ============================================\nfunction normalizePhoneAU(raw) {\n  if (!raw) return null;\n  let phone = raw.toString().replace(/[^0-9+]/g, '');\n  if (phone.startsWith('+')) return phone;\n  if (phone.length === 8 && !phone.startsWith('+')) return '+612' + phone;\n  if (phone.length === 10 && phone.startsWith('0')) return '+61' + phone.substring(1);\n  if (phone.length === 11 && phone.startsWith('61')) return '+' + phone;\n  if (phone.length === 9) return '+61' + phone;\n  return phone.startsWith('+') ? phone : '+61' + phone;\n}\n\n// ============================================\n// Extract all required parameters\n// ============================================\nconst patient_id = args.patient_id || '';\nconst practitioner_id = args.practitioner_id || '473326864069303022'; // Default practitioner\nconst appointment_type = args.appointment_type || 'Standard Consultation';\nconst starts_at = args.starts_at || args.start_time || args.datetime || '';\nconst duration_minutes = parseInt(args.duration_minutes) || 30;\nconst village = args.village || '';\nconst funding_type = (args.funding_type || '').toUpperCase();\nconst appointment_notes = args.appointment_notes || args.notes || '';\nconst unit_villa = args.unit_villa || '';\nconst is_new_client = args.is_new_client || false;\nconst client_name = args.client_name || '';\nconst recurrence_details = args.recurrence_details || null;\nconst call_id = call.call_id || args.call_id || '';\n\n// ============================================\n// Validation\n// ============================================\nconst errors = [];\n\nif (!patient_id) errors.push('patient_id is required');\nif (!starts_at) errors.push('starts_at is required');\nif (!village) errors.push('village is required');\nif (!funding_type) errors.push('funding_type is required');\n\nconst validFundingTypes = ['HCP', 'DVA', 'GP', 'PRIVATE', 'PHI'];\nif (funding_type && !validFundingTypes.includes(funding_type)) {\n  errors.push(`Invalid funding_type. Must be one of: ${validFundingTypes.join(', ')}`);\n}\n\nconst validAppointmentTypes = ['Standard Consultation', 'Standard Home Visit'];\nif (appointment_type && !validAppointmentTypes.includes(appointment_type)) {\n  errors.push(`Invalid appointment_type. Must be one of: ${validAppointmentTypes.join(', ')}`);\n}\n\n// Parse and validate datetime\nlet appointmentDate;\ntry {\n  appointmentDate = new Date(starts_at);\n  if (isNaN(appointmentDate.getTime())) {\n    errors.push('Invalid starts_at format. Use ISO 8601 format.');\n  }\n} catch (e) {\n  errors.push('Invalid starts_at format. Use ISO 8601 format.');\n}\n\n// Check appointment is in the future\nconst now = new Date();\nif (appointmentDate && appointmentDate <= now) {\n  errors.push('Appointment starts_at must be in the future');\n}\n\n// Check booking window (21 days)\nif (appointmentDate) {\n  const maxBookingDate = new Date(now);\n  maxBookingDate.setDate(now.getDate() + 21);\n  if (appointmentDate > maxBookingDate) {\n    const daysAhead = Math.ceil((appointmentDate - now) / (1000 * 60 * 60 * 24));\n    errors.push(`Appointment is ${daysAhead} days ahead. Bookings limited to 21 days.`);\n  }\n}\n\n// If validation errors, return early\nif (errors.length > 0) {\n  return [{\n    json: {\n      success: false,\n      appointment_created: false,\n      error: {\n        code: 'VALIDATION_ERROR',\n        message: errors.join('; '),\n        details: errors\n      },\n      call_id: call_id,\n      timestamp: new Date().toISOString(),\n      validation_failed: true\n    }\n  }];\n}\n\n// ============================================\n// Calculate derived fields\n// ============================================\n// Convert starts_at to UTC ISO format for Cliniko API\nconst starts_at_utc = appointmentDate.toISOString();\n\nconst endDate = new Date(appointmentDate);\nendDate.setMinutes(endDate.getMinutes() + duration_minutes);\nconst ends_at = endDate.toISOString();\n\n// Date parts for checks\nconst date_only = appointmentDate.toISOString().split('T')[0]; // YYYY-MM-DD\n\n// Day of week for recurring/protected checks\nconst daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\nconst day_of_week = daysOfWeek[appointmentDate.getDay()];\n\n// Time slot (HH:MM:SS)\nconst hours = String(appointmentDate.getHours()).padStart(2, '0');\nconst minutes = String(appointmentDate.getMinutes()).padStart(2, '0');\nconst time_slot = `${hours}:${minutes}:00`;\n\n// End time for overlap checks\nconst endHours = String(endDate.getHours()).padStart(2, '0');\nconst endMinutes = String(endDate.getMinutes()).padStart(2, '0');\nconst end_time = `${endHours}:${endMinutes}:00`;\n\n// Formatted display strings\nconst date_formatted = appointmentDate.toLocaleDateString('en-AU', { \n  timeZone: 'Australia/Sydney',\n  weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' \n});\nconst time_formatted = appointmentDate.toLocaleTimeString('en-AU', { \n  timeZone: 'Australia/Sydney',\n  hour: '2-digit', minute: '2-digit', hour12: true \n});\n\n// Cliniko notes\nconst clinikoNotes = [\n  `Village: ${village}`,\n  unit_villa ? `Unit/Villa: ${unit_villa}` : '',\n  `Funding: ${funding_type}`,\n  appointment_notes ? `Notes: ${appointment_notes}` : ''\n].filter(n => n).join('\\n');\n\n// Appointment type ID mapping\nconst APPOINTMENT_TYPE_MAP = {\n  'Standard Consultation': '472831283798480897',\n  'Standard Home Visit': '472831283798480897'\n};\nconst appointment_type_id = APPOINTMENT_TYPE_MAP[appointment_type] || '472831283798480897';\n\nreturn [{\n  json: {\n    // Core identifiers\n    patient_id,\n    practitioner_id,\n    business_id: '675491769126754955',\n    appointment_type_id,\n    appointment_type,\n    \n    // Timing (both formats - original for display, UTC for API)\n    starts_at: starts_at_utc,\n    starts_at_original: starts_at,\n    ends_at,\n    duration_minutes,\n    date_only,\n    day_of_week,\n    time_slot,\n    end_time,\n    date_formatted,\n    time_formatted,\n    \n    // Location/Funding\n    village,\n    unit_villa,\n    funding_type,\n    \n    // Notes\n    appointment_notes,\n    cliniko_notes: clinikoNotes,\n    \n    // Flags\n    is_new_client,\n    client_name,\n    recurrence_details,\n    \n    // Tracking\n    call_id,\n    start_time: Date.now(),\n    timestamp: new Date().toISOString(),\n    validation_failed: false\n  }\n}];"},"id":"code-extract-001","name":"Extract & Validate Request","type":"n8n-nodes-base.code","typeVersion":2,"position":[250,300]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"validation-failed-check","leftValue":"={{ $json.validation_failed }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"if-validation-001","name":"Validation Failed?","type":"n8n-nodes-base.if","typeVersion":2,"position":[500,300]},{"parameters":{"jsCode":"// Run All Pre-Checks - Simplified Sequential Approach\n// This replaces the parallel check pattern to avoid $items() issues in n8n v1.121+\n\nconst requestData = $json;\nlet blockers = [];\nlet warnings = [];\n\n// Pre-check results (will be populated below)\nlet is_holiday = false;\nlet holiday_name = null;\nlet has_recurring_conflict = false;\nlet recurring_conflict_details = null;\nlet is_protected_slot = false;\nlet protected_slot_reason = null;\n\n// NOTE: Database checks disabled for now - tables may not exist yet\n// Holiday and recurring conflict checks would normally query PostgreSQL\n// Protected slot checks would normally read from Google Sheets\n//\n// For now, we skip these checks and proceed directly to Cliniko slot check\n// This allows the booking to work while you set up the prerequisite tables\n\n// ============================================\n// Determine if booking can proceed\n// ============================================\nconst can_proceed = blockers.length === 0;\n\nreturn [{\n  json: {\n    ...requestData,\n    \n    // Check results (all skipped for now)\n    pre_checks: {\n      holiday: {\n        checked: false,\n        is_holiday,\n        holiday_name,\n        note: 'Holiday check skipped - table not configured'\n      },\n      recurring_conflict: {\n        checked: false,\n        has_conflict: has_recurring_conflict,\n        details: recurring_conflict_details,\n        note: 'Recurring check skipped - table not configured'\n      },\n      protected_slot: {\n        checked: false,\n        is_protected: is_protected_slot,\n        reason: protected_slot_reason,\n        note: 'Protected slot check skipped - sheet not configured'\n      }\n    },\n    \n    // Decision\n    can_proceed,\n    blockers,\n    warnings,\n    \n    // Timing\n    checks_completed_at: new Date().toISOString()\n  }\n}];"},"id":"code-prechecks-001","name":"Run All Pre-Checks","type":"n8n-nodes-base.code","typeVersion":2,"position":[750,300]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"can-proceed-check","leftValue":"={{ $json.can_proceed }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"if-can-proceed-001","name":"Can Proceed?","type":"n8n-nodes-base.if","typeVersion":2,"position":[1300,300]},{"parameters":{"url":"=https://api.au2.cliniko.com/v1/individual_appointments?q[]=practitioner_id:={{ $json.practitioner_id }}&q[]=starts_at:>={{ $json.starts_at }}&q[]=starts_at:<={{ $json.ends_at }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"},{"name":"Accept","value":"application/json"}]},"options":{}},"id":"http-check-slot-001","name":"Check Cliniko Slot Availability","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1550,200],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"// Check if Cliniko slot is available\nconst clinikoResponse = $input.item.json;\n// Get request data from the Pre-Checks node using n8n's $() syntax\nconst requestData = $('Run All Pre-Checks').first().json;\n\n// Handle API error\nif (clinikoResponse.error) {\n  return [{\n    json: {\n      ...requestData,\n      cliniko_slot_available: false,\n      cliniko_error: clinikoResponse.error,\n      can_proceed: false,\n      blockers: [\n        ...requestData.blockers,\n        {\n          type: 'CLINIKO_API_ERROR',\n          message: 'Could not verify slot availability in Cliniko',\n          details: { error: clinikoResponse.error }\n        }\n      ]\n    }\n  }];\n}\n\n// Check if slot is taken\nconst appointments = clinikoResponse.individual_appointments || [];\nif (appointments.length > 0) {\n  return [{\n    json: {\n      ...requestData,\n      cliniko_slot_available: false,\n      can_proceed: false,\n      blockers: [\n        ...requestData.blockers,\n        {\n          type: 'SLOT_UNAVAILABLE',\n          message: 'This time slot is no longer available in Cliniko.',\n          details: { existing_appointments: appointments.length }\n        }\n      ]\n    }\n  }];\n}\n\n// Slot is available\nreturn [{\n  json: {\n    ...requestData,\n    cliniko_slot_available: true\n  }\n}];"},"id":"code-check-slot-001","name":"Handle Slot Check Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[1800,200]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"slot-available-check","leftValue":"={{ $json.cliniko_slot_available }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"if-slot-available-001","name":"Slot Available?","type":"n8n-nodes-base.if","typeVersion":2,"position":[2050,200]},{"parameters":{"method":"POST","url":"https://api.au2.cliniko.com/v1/individual_appointments","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"},{"name":"Accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ { patient_id: $json.patient_id, practitioner_id: $json.practitioner_id, business_id: $json.business_id, appointment_type_id: $json.appointment_type_id, starts_at: $json.starts_at, ends_at: $json.ends_at, notes: $json.cliniko_notes, send_sms: true, confirmed: true } }}","options":{}},"id":"http-create-appt-001","name":"Create Appointment in Cliniko","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2300,100],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"jsCode":"// Process Cliniko appointment creation response\nconst clinikoResponse = $input.item.json;\nconst requestData = $('Handle Slot Check Result').first().json;\n\n// Handle API error\nif (clinikoResponse.error || !clinikoResponse.id) {\n  const errorMsg = clinikoResponse.error || 'No appointment ID returned';\n  return [{\n    json: {\n      ...requestData,\n      appointment_created: false,\n      cliniko_error: errorMsg,\n      error: {\n        code: 'CLINIKO_CREATE_ERROR',\n        message: `Failed to create appointment: ${errorMsg}`\n      }\n    }\n  }];\n}\n\n// Success - extract appointment details\nconst patient_name = clinikoResponse.patient?.first_name && clinikoResponse.patient?.last_name\n  ? `${clinikoResponse.patient.first_name} ${clinikoResponse.patient.last_name}`\n  : requestData.client_name || 'Patient';\n\nreturn [{\n  json: {\n    ...requestData,\n    appointment_created: true,\n    appointment_id: clinikoResponse.id,\n    patient_name: patient_name,\n    practitioner_name: 'Liam Potter',\n    cliniko_link: `https://reignitehealth.au2.cliniko.com/appointments/${clinikoResponse.id}`,\n    sms_sent: true,\n    cliniko_response: clinikoResponse\n  }\n}];"},"id":"code-process-cliniko-001","name":"Process Cliniko Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[2550,100]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"appointment-created-check","leftValue":"={{ $json.appointment_created }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"options":{}},"id":"if-created-001","name":"Appointment Created?","type":"n8n-nodes-base.if","typeVersion":2,"position":[2800,100]},{"parameters":{"method":"POST","url":"https://api.au2.cliniko.com/v1/treatment_notes","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"User-Agent","value":"RetellAI n8n Webhook (support@yr.com.au)"},{"name":"Accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ { individual_appointment_id: $json.appointment_id, content: 'Booked via Voice AI (Compound Webhook).\\nCall ID: ' + $json.call_id + '\\nFunding: ' + $json.funding_type + '\\nAppointment Type: ' + $json.appointment_type + ($json.unit_villa ? '\\nUnit/Villa: ' + $json.unit_villa : '') + ($json.appointment_notes ? '\\nNotes: ' + $json.appointment_notes : '') } }}","options":{}},"id":"http-treatment-notes-001","name":"Add Treatment Notes","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3050,0],"alwaysOutputData":true,"credentials":{"httpBasicAuth":{"id":"jjBjG1tO5syL0Ip9","name":"Reignite-Cliniko"}},"continueOnFail":true},{"parameters":{"sendTo":"peter@yesai.au","subject":"=ü§ñ Voice AI Booking (Compound) - {{ $('Process Cliniko Response').first().json.patient_name }}","message":"=<html><body style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\"><div style=\"background-color: #f0f8ff; padding: 20px; border-radius: 10px;\"><h2 style=\"color: #2c3e50;\">ü§ñ Voice AI Booking (Compound Webhook)</h2><div style=\"background-color: white; padding: 15px; border-radius: 5px; margin: 10px 0;\"><table style=\"width: 100%; border-collapse: collapse;\"><tr style=\"border-bottom: 1px solid #eee;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Patient:</td><td style=\"padding: 10px;\">{{ $('Process Cliniko Response').first().json.patient_name }}</td></tr><tr style=\"border-bottom: 1px solid #eee; background: #f9f9f9;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Appointment ID:</td><td style=\"padding: 10px;\">{{ $('Process Cliniko Response').first().json.appointment_id }}</td></tr><tr style=\"border-bottom: 1px solid #eee;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Date:</td><td style=\"padding: 10px;\">{{ $('Process Cliniko Response').first().json.date_formatted }}</td></tr><tr style=\"border-bottom: 1px solid #eee; background: #f9f9f9;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Time:</td><td style=\"padding: 10px;\">{{ $('Process Cliniko Response').first().json.time_formatted }}</td></tr><tr style=\"border-bottom: 1px solid #eee;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Duration:</td><td style=\"padding: 10px;\">{{ $('Process Cliniko Response').first().json.duration_minutes }} minutes</td></tr><tr style=\"border-bottom: 1px solid #eee; background: #f9f9f9;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Type:</td><td style=\"padding: 10px;\">{{ $('Process Cliniko Response').first().json.appointment_type }}</td></tr><tr style=\"border-bottom: 1px solid #eee;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Village:</td><td style=\"padding: 10px;\">{{ $('Process Cliniko Response').first().json.village }}</td></tr><tr style=\"background: #f9f9f9;\"><td style=\"padding: 10px; font-weight: bold; color: #555;\">Funding:</td><td style=\"padding: 10px;\">{{ $('Process Cliniko Response').first().json.funding_type }}</td></tr></table></div><div style=\"text-align: center; margin: 25px 0;\"><a href=\"{{ $('Process Cliniko Response').first().json.cliniko_link }}\" style=\"display: inline-block; background-color: #3498db; color: white; padding: 14px 35px; text-decoration: none; border-radius: 5px; font-weight: bold; font-size: 16px;\">View in Cliniko</a></div><div style=\"background-color: #e8f5e9; padding: 12px; border-radius: 5px; margin: 15px 0;\"><p style=\"margin: 0; font-size: 13px; color: #2e7d32;\">‚úÖ Appointment created | ‚úÖ SMS sent to patient | ‚úÖ Treatment notes added | ‚úÖ All pre-checks passed</p></div><div style=\"font-size: 12px; color: #7f8c8d; padding-top: 15px; border-top: 1px solid #ddd;\"><p style=\"margin: 5px 0;\"><strong>Call ID:</strong> {{ $('Process Cliniko Response').first().json.call_id }}</p><p style=\"margin: 5px 0;\"><strong>Created via:</strong> Compound Webhook (single call)</p><p style=\"margin: 5px 0;\"><em>Voice AI booking system | Auto-flagged for review</em></p></div></div></body></html>","options":{}},"id":"gmail-notify-001","name":"Send Email Notification","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[3300,0],"credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}},"continueOnFail":true},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1-OXnCJtYRa1h3C7HENhbxlDixLJWJYtsi-VebGiD3Tc","mode":"id"},"sheetName":{"__rl":true,"value":2141551618,"mode":"list","cachedResultName":"13_sara_approval_queue","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1-OXnCJtYRa1h3C7HENhbxlDixLJWJYtsi-VebGiD3Tc/edit#gid=2141551618"},"columns":{"mappingMode":"defineBelow","value":{"timestamp":"={{ $('Process Cliniko Response').first().json.timestamp }}","client_name":"={{ $('Process Cliniko Response').first().json.patient_name }}","cliniko_id":"={{ $('Process Cliniko Response').first().json.patient_id }}","village":"={{ $('Process Cliniko Response').first().json.village }}","is_new_client":"={{ $('Process Cliniko Response').first().json.is_new_client }}","service_type":"={{ $('Process Cliniko Response').first().json.appointment_type }}","booking_date_time":"={{ $('Process Cliniko Response').first().json.date_formatted }} {{ $('Process Cliniko Response').first().json.time_formatted }}","practitioner":"={{ $('Process Cliniko Response').first().json.practitioner_name }}","payment_method":"={{ $('Process Cliniko Response').first().json.funding_type }}","special_notes":"={{ $('Process Cliniko Response').first().json.appointment_notes }}","booking_id":"={{ $('Process Cliniko Response').first().json.appointment_id }}","call_id":"={{ $('Process Cliniko Response').first().json.call_id }}","status":"pending_review","booked_via":"voice_ai_compound"}},"options":{}},"id":"sheets-approval-001","name":"Add to Sara Approval Queue","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[3550,0],"credentials":{"googleSheetsOAuth2Api":{"id":"7bMprzkuOrdU7bu9","name":"Google Sheets account"}},"continueOnFail":true},{"parameters":{"operation":"executeQuery","query":"=DELETE FROM patient_funding_cache WHERE patient_id = '{{ $('Process Cliniko Response').first().json.patient_id }}' RETURNING *;","options":{"queryBatching":"independently"}},"id":"postgres-invalidate-001","name":"Invalidate Funding Cache","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[3800,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"jsCode":"// Format final success response\nconst data = $('Process Cliniko Response').first().json;\n\nconst duration_ms = Date.now() - data.start_time;\n\nreturn [{\n  json: {\n    success: true,\n    appointment_created: true,\n    appointment_id: data.appointment_id,\n    \n    confirmation_details: {\n      patient_name: data.patient_name,\n      practitioner_name: data.practitioner_name,\n      datetime: data.starts_at,\n      date: data.date_formatted,\n      time: data.time_formatted,\n      duration_minutes: data.duration_minutes,\n      village: data.village,\n      funding_type: data.funding_type,\n      appointment_type: data.appointment_type\n    },\n    \n    pre_checks: data.pre_checks,\n    \n    actions_completed: {\n      holiday_checked: true,\n      recurring_conflict_checked: true,\n      protected_slot_checked: true,\n      cliniko_slot_verified: true,\n      appointment_created: true,\n      treatment_notes_added: true,\n      sms_sent: data.sms_sent,\n      email_notification_sent: true,\n      added_to_approval_queue: true,\n      funding_cache_invalidated: true\n    },\n    \n    flagged_for_review: true,\n    cliniko_link: data.cliniko_link,\n    \n    call_id: data.call_id,\n    duration_ms: duration_ms,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"code-success-response-001","name":"Format Success Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[4050,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-success-001","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[4300,0]},{"parameters":{"jsCode":"// Format blocked response (pre-checks failed)\nconst data = $json;\n\nconst duration_ms = Date.now() - data.start_time;\n\n// Get the primary blocker\nconst primaryBlocker = data.blockers[0] || { type: 'UNKNOWN', message: 'Booking blocked' };\n\nreturn [{\n  json: {\n    success: false,\n    appointment_created: false,\n    \n    error: {\n      code: primaryBlocker.type,\n      message: primaryBlocker.message,\n      all_blockers: data.blockers\n    },\n    \n    pre_checks: data.pre_checks,\n    \n    requested_details: {\n      datetime: data.starts_at,\n      date: data.date_formatted,\n      time: data.time_formatted,\n      duration_minutes: data.duration_minutes,\n      village: data.village,\n      practitioner_id: data.practitioner_id\n    },\n    \n    call_id: data.call_id,\n    duration_ms: duration_ms,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"code-blocked-response-001","name":"Format Blocked Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1550,400]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-blocked-001","name":"Respond Blocked","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1800,400]},{"parameters":{"jsCode":"// Format validation error response\nconst data = $json;\n\nreturn [{\n  json: {\n    success: false,\n    appointment_created: false,\n    error: data.error,\n    call_id: data.call_id,\n    timestamp: data.timestamp\n  }\n}];"},"id":"code-validation-error-001","name":"Format Validation Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[750,600]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-validation-001","name":"Respond Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1000,600]},{"parameters":{"jsCode":"// Format slot unavailable response\nconst data = $json;\n\nconst duration_ms = Date.now() - data.start_time;\n\nreturn [{\n  json: {\n    success: false,\n    appointment_created: false,\n    \n    error: {\n      code: 'SLOT_UNAVAILABLE',\n      message: 'This time slot is no longer available.',\n      blockers: data.blockers\n    },\n    \n    pre_checks: data.pre_checks,\n    \n    requested_details: {\n      datetime: data.starts_at,\n      date: data.date_formatted,\n      time: data.time_formatted,\n      village: data.village\n    },\n    \n    call_id: data.call_id,\n    duration_ms: duration_ms,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"code-slot-error-001","name":"Format Slot Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[2300,300]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-slot-error-001","name":"Respond Slot Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2550,300]},{"parameters":{"jsCode":"// Format Cliniko creation error response\nconst data = $json;\n\nconst duration_ms = Date.now() - data.start_time;\n\nreturn [{\n  json: {\n    success: false,\n    appointment_created: false,\n    \n    error: data.error || {\n      code: 'CLINIKO_CREATE_ERROR',\n      message: 'Failed to create appointment in Cliniko'\n    },\n    \n    pre_checks: data.pre_checks,\n    \n    requested_details: {\n      datetime: data.starts_at,\n      date: data.date_formatted,\n      time: data.time_formatted,\n      village: data.village\n    },\n    \n    call_id: data.call_id,\n    duration_ms: duration_ms,\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"code-create-error-001","name":"Format Create Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[3050,200]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"}]}}},"id":"respond-create-error-001","name":"Respond Create Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[3300,200]},{"parameters":{"operation":"executeQuery","query":"-- Log compound webhook execution\nINSERT INTO webhook_log (\n  webhook_name,\n  call_id,\n  request_body,\n  response_body,\n  success,\n  duration_ms,\n  cache_hit,\n  created_at\n)\nVALUES (\n  'book-appointment-compound',\n  '{{ $json.call_id }}',\n  '{{ JSON.stringify($json) }}'::jsonb,\n  '{{ JSON.stringify($json) }}'::jsonb,\n  {{ $json.success }},\n  {{ $json.duration_ms || 0 }},\n  false,\n  now()\n)\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"postgres-log-001","name":"Log Webhook Execution","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[4550,0],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true},{"parameters":{"operation":"executeQuery","query":"-- Log appointment to database\nINSERT INTO appointment_log (\n  appointment_id,\n  patient_id,\n  practitioner_id,\n  datetime,\n  duration_minutes,\n  appointment_type,\n  funding_type,\n  village,\n  created_via,\n  call_id,\n  flagged_for_review,\n  created_at\n)\nVALUES (\n  '{{ $json.appointment_id }}',\n  '{{ $json.patient_id }}',\n  '{{ $json.practitioner_id }}',\n  '{{ $json.starts_at }}'::timestamptz,\n  {{ $json.duration_minutes }},\n  '{{ $json.appointment_type }}',\n  '{{ $json.funding_type }}',\n  '{{ $json.village }}',\n  'voice_ai_compound',\n  '{{ $json.call_id }}',\n  true,\n  now()\n)\nRETURNING *;","options":{"queryBatching":"independently"}},"id":"postgres-appt-log-001","name":"Log Appointment to Database","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[4300,150],"alwaysOutputData":true,"credentials":{"postgres":{"id":"7IKr1k5yuchz7uQL","name":"n8n Postgres DB"}},"continueOnFail":true}],"connections":{"Webhook Trigger":{"main":[[{"node":"Extract & Validate Request","type":"main","index":0}]]},"Extract & Validate Request":{"main":[[{"node":"Validation Failed?","type":"main","index":0}]]},"Validation Failed?":{"main":[[{"node":"Format Validation Error","type":"main","index":0}],[{"node":"Run All Pre-Checks","type":"main","index":0}]]},"Format Validation Error":{"main":[[{"node":"Respond Validation Error","type":"main","index":0}]]},"Run All Pre-Checks":{"main":[[{"node":"Can Proceed?","type":"main","index":0}]]},"Can Proceed?":{"main":[[{"node":"Check Cliniko Slot Availability","type":"main","index":0}],[{"node":"Format Blocked Response","type":"main","index":0}]]},"Format Blocked Response":{"main":[[{"node":"Respond Blocked","type":"main","index":0}]]},"Check Cliniko Slot Availability":{"main":[[{"node":"Handle Slot Check Result","type":"main","index":0}]]},"Handle Slot Check Result":{"main":[[{"node":"Slot Available?","type":"main","index":0}]]},"Slot Available?":{"main":[[{"node":"Create Appointment in Cliniko","type":"main","index":0}],[{"node":"Format Slot Error","type":"main","index":0}]]},"Format Slot Error":{"main":[[{"node":"Respond Slot Error","type":"main","index":0}]]},"Create Appointment in Cliniko":{"main":[[{"node":"Process Cliniko Response","type":"main","index":0}]]},"Process Cliniko Response":{"main":[[{"node":"Appointment Created?","type":"main","index":0}]]},"Appointment Created?":{"main":[[{"node":"Add Treatment Notes","type":"main","index":0}],[{"node":"Format Create Error","type":"main","index":0}]]},"Format Create Error":{"main":[[{"node":"Respond Create Error","type":"main","index":0}]]},"Add Treatment Notes":{"main":[[{"node":"Send Email Notification","type":"main","index":0}]]},"Send Email Notification":{"main":[[{"node":"Add to Sara Approval Queue","type":"main","index":0}]]},"Add to Sara Approval Queue":{"main":[[{"node":"Invalidate Funding Cache","type":"main","index":0}]]},"Invalidate Funding Cache":{"main":[[{"node":"Format Success Response","type":"main","index":0}]]},"Format Success Response":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Respond Success":{"main":[[{"node":"Log Appointment to Database","type":"main","index":0},{"node":"Log Webhook Execution","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"b4c7c5f4-20ab-420c-91de-ef3529ee6c67","triggerCount":1,"shared":[{"updatedAt":"2025-11-25T07:18:06.855Z","createdAt":"2025-11-25T07:18:06.855Z","role":"workflow:owner","workflowId":"jhU2bAKMWzPgWGBj","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-29T03:35:05.631Z","createdAt":"2025-11-25T19:10:01.966Z","id":"6ipSW3RPOouybJ7f","name":"n8n Silent Failure Report v1.2","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":15}]}},"id":"schedule-trigger","name":"Schedule Trigger (Every 15 min)","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,112]},{"parameters":{"url":"https://auto.yr.com.au/api/v1/workflows?active=true","sendHeaders":true,"headerParameters":{"parameters":[{"name":"X-N8N-API-KEY","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwZmRmM2Y0Ni1iNGIxLTRlYjMtYTdlZS05MGYxZDczMzE3NDUiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzYzODg3NDQyfQ.nMvcYGkjKHMkGVXXVr8Pfh61wT4WgWgX5SOtDNBW-F4"}]},"options":{}},"id":"get-workflows","name":"Get Active Workflows","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[240,112],"alwaysOutputData":true},{"parameters":{"url":"https://auto.yr.com.au/api/v1/executions?status=success&limit=250","sendHeaders":true,"headerParameters":{"parameters":[{"name":"X-N8N-API-KEY","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwZmRmM2Y0Ni1iNGIxLTRlYjMtYTdlZS05MGYxZDczMzE3NDUiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzYzODg3NDQyfQ.nMvcYGkjKHMkGVXXVr8Pfh61wT4WgWgX5SOtDNBW-F4"}]},"options":{}},"id":"get-success-executions","name":"Get Successful Executions","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[480,112],"alwaysOutputData":true},{"parameters":{"jsCode":"// Silent Failure Detection Logic v1.2\n// Detects workflows that \"succeed\" but return problematic data to RetellAI\n// v1.2: Only checks LAST 15 MINUTES and flags if there are any issues\n\nconst SILENT_FAILURE_PATTERNS = {\n  // Pattern 1: Null/Empty outputs\n  null_output: {\n    name: 'Null/Empty Output',\n    description: 'Workflow returned null, undefined, empty object, or empty array',\n    severity: 'high',\n    check: (output) => {\n      if (output === null || output === undefined) return true;\n      if (typeof output === 'string' && output.trim() === '') return true;\n      if (typeof output === 'object') {\n        if (Array.isArray(output) && output.length === 0) return true;\n        if (Object.keys(output).length === 0) return true;\n      }\n      return false;\n    }\n  },\n  \n  // Pattern 2: Error-like successful responses\n  error_in_success: {\n    name: 'Error in Success Response',\n    description: 'Output contains error indicators despite success status',\n    severity: 'high',\n    check: (output) => {\n      const str = JSON.stringify(output || '').toLowerCase();\n      const errorPatterns = [\n        /\"error\"\\s*:/,\n        /\"errorMessage\"\\s*:/,\n        /\"error_message\"\\s*:/,\n        /\"status\"\\s*:\\s*\"?(error|fail|failed)/,\n        /\"success\"\\s*:\\s*false/,\n        /\"ok\"\\s*:\\s*false/,\n        /not found/i,\n        /no results/i,\n        /no data/i,\n        /cannot find/i\n      ];\n      return errorPatterns.some(p => p.test(str));\n    }\n  },\n  \n  // Pattern 3: Missing critical RetellAI response fields\n  missing_retell_fields: {\n    name: 'Missing RetellAI Fields',\n    description: 'Response lacks fields RetellAI typically expects',\n    severity: 'medium',\n    check: (output, workflowName) => {\n      if (!output || typeof output !== 'object') return false;\n      const str = JSON.stringify(output);\n      \n      // Check for RetellAI webhook patterns\n      const isRetellWorkflow = /retell/i.test(workflowName);\n      if (!isRetellWorkflow) return false;\n      \n      // RetellAI expects structured responses - check if it's too bare\n      const hasMinimalStructure = str.length < 20;\n      const hasOnlyPrimitives = !str.includes('{') || !str.includes(':');\n      \n      return hasMinimalStructure || hasOnlyPrimitives;\n    }\n  },\n  \n  // Pattern 4: Suspiciously short response\n  truncated_response: {\n    name: 'Truncated/Minimal Response',\n    description: 'Response is unusually short (< 50 chars) for a data operation',\n    severity: 'low',\n    check: (output, workflowName) => {\n      const str = JSON.stringify(output || '');\n      // Data-fetching workflows should return substantial data\n      const isDataWorkflow = /(get|fetch|list|search|find|lookup|check)/i.test(workflowName);\n      if (!isDataWorkflow) return false;\n      return str.length < 50;\n    }\n  },\n  \n  // Pattern 5: Array with all null/empty items\n  empty_array_items: {\n    name: 'Array with Empty Items',\n    description: 'Array returned but all items are null/empty',\n    severity: 'medium',\n    check: (output) => {\n      if (!Array.isArray(output) || output.length === 0) return false;\n      return output.every(item => \n        item === null || \n        item === undefined || \n        (typeof item === 'object' && Object.keys(item || {}).length === 0)\n      );\n    }\n  },\n  \n  // Pattern 6: Response only contains metadata, no actual data\n  metadata_only: {\n    name: 'Metadata Only Response',\n    description: 'Response contains only metadata fields like timestamps, no actual data',\n    severity: 'medium',\n    check: (output) => {\n      if (!output || typeof output !== 'object' || Array.isArray(output)) return false;\n      const keys = Object.keys(output);\n      const metadataKeys = ['timestamp', 'time', 'date', 'created', 'updated', 'id', 'version', 'status'];\n      const isAllMetadata = keys.every(k => \n        metadataKeys.some(mk => k.toLowerCase().includes(mk))\n      );\n      return isAllMetadata && keys.length > 0 && keys.length <= 3;\n    }\n  },\n  \n  // Pattern 7: Boolean-only response for data queries\n  boolean_for_data: {\n    name: 'Boolean Instead of Data',\n    description: 'Returned only true/false when data was expected',\n    severity: 'medium',\n    check: (output, workflowName) => {\n      const isDataWorkflow = /(get|fetch|list|search|find|lookup)/i.test(workflowName);\n      if (!isDataWorkflow) return false;\n      return typeof output === 'boolean' || \n             (typeof output === 'object' && Object.keys(output || {}).length === 1 && \n              typeof Object.values(output)[0] === 'boolean');\n    }\n  }\n};\n\n// Get data from input - this node receives data sequentially\nconst allItems = $input.all();\n\n// First item is workflows, second is executions\nlet workflows = [];\nlet successExecutions = [];\n\nfor (const item of allItems) {\n  const data = item.json.data || [];\n  // Determine if this is workflows or executions based on structure\n  if (data.length > 0) {\n    if (data[0].hasOwnProperty('active') && data[0].hasOwnProperty('nodes')) {\n      workflows = data;\n    } else if (data[0].hasOwnProperty('workflowId') || data[0].hasOwnProperty('status')) {\n      successExecutions = data;\n    }\n  }\n}\n\n// Create workflow name map INCLUDING updatedAt for filtering\nconst activeWorkflowIds = new Set();\nconst workflowNames = {};\nconst workflowUpdatedAt = {};  // Track when each workflow was last edited\n\nfor (const wf of workflows) {\n  if (wf && wf.id && wf.active) {\n    activeWorkflowIds.add(wf.id);\n    workflowNames[wf.id] = wf.name;\n    workflowUpdatedAt[wf.id] = wf.updatedAt ? new Date(wf.updatedAt) : null;\n  }\n}\n\n// v1.2: Check only LAST 15 MINUTES\nconst fifteenMinutesAgo = new Date(Date.now() - 15 * 60 * 1000);\n\n// Analyze executions for silent failures\nconst silentFailures = [];\nconst workflowStats = {};\n\nfor (const execution of successExecutions) {\n  if (!execution || !execution.workflowId) continue;\n  if (!activeWorkflowIds.has(execution.workflowId)) continue;\n  \n  const startedAt = execution.startedAt ? new Date(execution.startedAt) : null;\n  if (!startedAt || startedAt < fifteenMinutesAgo) continue;\n  \n  // Skip executions that occurred BEFORE the workflow was last edited\n  const wfUpdated = workflowUpdatedAt[execution.workflowId];\n  if (wfUpdated && startedAt < wfUpdated) continue;\n  \n  const workflowName = workflowNames[execution.workflowId] || 'Unknown';\n  const wfId = execution.workflowId;\n  \n  // Initialize stats\n  if (!workflowStats[wfId]) {\n    workflowStats[wfId] = {\n      workflow_name: workflowName,\n      total_executions: 0,\n      silent_failures: 0,\n      issues_by_type: {}\n    };\n  }\n  workflowStats[wfId].total_executions++;\n  \n  // Extract final output from execution data\n  let finalOutput = null;\n  try {\n    if (execution.data && execution.data.resultData && execution.data.resultData.runData) {\n      const runData = execution.data.resultData.runData;\n      const nodeNames = Object.keys(runData);\n      \n      // Find the last node's output (usually Response or final node)\n      for (const nodeName of nodeNames.reverse()) {\n        const nodeData = runData[nodeName];\n        if (nodeData && nodeData.length > 0) {\n          const lastRun = nodeData[nodeData.length - 1];\n          if (lastRun && lastRun.data && lastRun.data.main && lastRun.data.main[0]) {\n            const outputs = lastRun.data.main[0];\n            if (outputs && outputs.length > 0) {\n              finalOutput = outputs[0].json;\n              break;\n            }\n          }\n        }\n      }\n    }\n  } catch (e) {\n    // Could not extract output\n  }\n  \n  // Check for silent failure patterns\n  const detectedIssues = [];\n  \n  for (const [patternId, pattern] of Object.entries(SILENT_FAILURE_PATTERNS)) {\n    try {\n      if (pattern.check(finalOutput, workflowName)) {\n        detectedIssues.push({\n          pattern_id: patternId,\n          name: pattern.name,\n          description: pattern.description,\n          severity: pattern.severity\n        });\n        \n        // Track by type\n        if (!workflowStats[wfId].issues_by_type[patternId]) {\n          workflowStats[wfId].issues_by_type[patternId] = 0;\n        }\n        workflowStats[wfId].issues_by_type[patternId]++;\n      }\n    } catch (e) {\n      // Skip this pattern if it errors\n    }\n  }\n  \n  if (detectedIssues.length > 0) {\n    workflowStats[wfId].silent_failures++;\n    \n    // Only record detailed failures for high/medium severity\n    const hasSignificantIssue = detectedIssues.some(i => i.severity === 'high' || i.severity === 'medium');\n    if (hasSignificantIssue) {\n      silentFailures.push({\n        execution_id: execution.id,\n        workflow_id: wfId,\n        workflow_name: workflowName,\n        started_at: execution.startedAt,\n        issues: detectedIssues,\n        severity: detectedIssues.some(i => i.severity === 'high') ? 'high' : 'medium',\n        output_preview: JSON.stringify(finalOutput).substring(0, 100)\n      });\n    }\n  }\n}\n\n// Calculate workflow health scores\nconst workflowHealth = [];\nfor (const [wfId, stats] of Object.entries(workflowStats)) {\n  if (stats.total_executions === 0) continue;\n  \n  const failureRate = (stats.silent_failures / stats.total_executions) * 100;\n  let healthScore = 'healthy';\n  \n  if (failureRate >= 50) healthScore = 'critical';\n  else if (failureRate >= 25) healthScore = 'warning';\n  else if (failureRate >= 10) healthScore = 'attention';\n  \n  if (failureRate > 0) {\n    workflowHealth.push({\n      workflow_id: wfId,\n      workflow_name: stats.workflow_name,\n      total_executions: stats.total_executions,\n      silent_failures: stats.silent_failures,\n      failure_rate: Math.round(failureRate * 10) / 10,\n      health_score: healthScore,\n      top_issues: Object.entries(stats.issues_by_type)\n        .sort((a, b) => b[1] - a[1])\n        .slice(0, 3)\n        .map(([id, count]) => ({ type: SILENT_FAILURE_PATTERNS[id]?.name || id, count }))\n    });\n  }\n}\n\n// Sort by failure rate descending\nworkflowHealth.sort((a, b) => b.failure_rate - a.failure_rate);\nsilentFailures.sort((a, b) => {\n  const severityOrder = { high: 0, medium: 1, low: 2 };\n  return severityOrder[a.severity] - severityOrder[b.severity];\n});\n\n// Summary\nconst criticalWorkflows = workflowHealth.filter(w => w.health_score === 'critical').length;\nconst warningWorkflows = workflowHealth.filter(w => w.health_score === 'warning').length;\nconst totalSilentFailures = silentFailures.length;\n\n// Count total executions in period\nlet totalExecutionsAnalyzed = 0;\nfor (const stats of Object.values(workflowStats)) {\n  totalExecutionsAnalyzed += stats.total_executions;\n}\n\n// v1.2: Flag if there are any significant issues to report\nconst hasIssues = criticalWorkflows > 0 || warningWorkflows > 0 || silentFailures.some(f => f.severity === 'high');\n\nreturn [{\n  json: {\n    silent_failures: silentFailures.slice(0, 50), // Top 50 most recent\n    workflow_health: workflowHealth,\n    has_issues: hasIssues,\n    summary: {\n      total_executions_analyzed: totalExecutionsAnalyzed,\n      total_silent_failures: totalSilentFailures,\n      critical_workflows: criticalWorkflows,\n      warning_workflows: warningWorkflows,\n      workflows_with_issues: workflowHealth.length\n    }\n  }\n}];"},"id":"analyze-silent-failures","name":"Detect Silent Failures","type":"n8n-nodes-base.code","typeVersion":2,"position":[720,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition-has-issues","leftValue":"={{ $json.has_issues }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"check-has-issues","name":"Has Issues?","type":"n8n-nodes-base.if","typeVersion":2,"position":[960,112]},{"parameters":{"jsCode":"const data = $input.item.json;\nconst silentFailures = data.silent_failures || [];\nconst workflowHealth = data.workflow_health || [];\nconst summary = data.summary || {};\n\n// Format timestamp\nconst now = new Date();\nconst reportTime = now.toLocaleString('en-AU', { timeZone: 'Australia/Melbourne' });\nconst reportPeriod = '15 minutes';  // v1.2: Changed to 15 min\n\n// Helper to escape HTML\nconst esc = (s) => String(s ?? '').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[c]));\n\n// Helper to format timestamp\nfunction formatTime(ts) {\n  if (!ts) return 'N/A';\n  try {\n    const d = new Date(ts);\n    if (isNaN(d)) return 'N/A';\n    return d.toLocaleString('en-AU', { timeZone: 'Australia/Melbourne' });\n  } catch (e) {\n    return 'N/A';\n  }\n}\n\n// Get health badge\nfunction getHealthBadge(score) {\n  const badges = {\n    critical: { emoji: 'üî¥', color: '#dc2626', text: 'CRITICAL' },\n    warning: { emoji: 'üü†', color: '#ea580c', text: 'WARNING' },\n    attention: { emoji: 'üü°', color: '#ca8a04', text: 'ATTENTION' },\n    healthy: { emoji: 'üü¢', color: '#16a34a', text: 'HEALTHY' }\n  };\n  return badges[score] || badges.healthy;\n}\n\n// Table styles\nconst tableStyle = 'style=\"border-collapse:collapse;width:100%;margin-bottom:20px;border:1px solid #e5e7eb;font-family:Arial,Helvetica,sans-serif\"';\nconst thStyle = 'style=\"padding:10px;border:1px solid #e5e7eb;background:#f9fafb;text-align:left;font-weight:600;font-size:13px;color:#111827\"';\nconst tdStyle = 'style=\"padding:10px;border:1px solid #e5e7eb;font-size:13px;vertical-align:top\"';\n\n// Build summary section with alert styling\nlet alertColor = '#dc2626';\nlet alertBg = '#fef2f2';\n\nif (summary.critical_workflows > 0) {\n  alertColor = '#dc2626';\n  alertBg = '#fef2f2';\n} else if (summary.warning_workflows > 0) {\n  alertColor = '#ea580c';\n  alertBg = '#fff7ed';\n}\n\nlet summaryHtml = `\n<div style=\"background:${alertBg};border-left:4px solid ${alertColor};padding:15px;margin-bottom:20px\">\n  <h3 style=\"margin:0 0 10px 0;color:${alertColor};font-family:Arial,Helvetica,sans-serif\">üö® Silent Failures Detected</h3>\n  <p style=\"margin:5px 0;font-family:Arial,Helvetica,sans-serif;font-size:14px\"><strong>Report Time:</strong> ${esc(reportTime)}</p>\n  <p style=\"margin:5px 0;font-family:Arial,Helvetica,sans-serif;font-size:14px\"><strong>Period:</strong> Last ${reportPeriod}</p>\n  <p style=\"margin:5px 0;font-family:Arial,Helvetica,sans-serif;font-size:14px\"><strong>Executions Analyzed:</strong> ${summary.total_executions_analyzed}</p>\n  <p style=\"margin:10px 0 0 0;font-family:Arial,Helvetica,sans-serif;font-size:14px\">\n    ‚Ä¢ üî¥ Critical Workflows: <strong style=\"color:#dc2626\">${summary.critical_workflows}</strong> (>50% silent failure rate)<br>\n    ‚Ä¢ üü† Warning Workflows: <strong style=\"color:#ea580c\">${summary.warning_workflows}</strong> (25-50% silent failure rate)<br>\n    ‚Ä¢ üìä Total Workflows with Issues: <strong>${summary.workflows_with_issues}</strong><br>\n    ‚Ä¢ üîá Total Silent Failures Detected: <strong>${summary.total_silent_failures}</strong>\n  </p>\n</div>\n`;\n\n// What are silent failures explanation\nlet explanationHtml = `\n<div style=\"background:#f8fafc;border:1px solid #e2e8f0;border-radius:4px;padding:15px;margin-bottom:20px\">\n  <h4 style=\"margin:0 0 10px 0;color:#475569;font-family:Arial,Helvetica,sans-serif\">‚ÑπÔ∏è What are Silent Failures?</h4>\n  <p style=\"margin:0;font-family:Arial,Helvetica,sans-serif;font-size:13px;color:#64748b\">\n    Silent failures are workflow executions that complete with \"success\" status but return problematic data:\n    <br>‚Ä¢ <strong>Null/Empty outputs</strong> - Returning nothing when data was expected\n    <br>‚Ä¢ <strong>Error messages in success</strong> - \"not found\", \"invalid\", \"no results\" in output\n    <br>‚Ä¢ <strong>Missing fields</strong> - Response lacks fields RetellAI needs\n    <br>‚Ä¢ <strong>Truncated responses</strong> - Unusually short data for the operation type\n  </p>\n</div>\n`;\n\n// Workflow Health Table\nlet healthTableHtml = `\n<h3 style=\"color:#1e40af;font-family:Arial,Helvetica,sans-serif;margin-top:20px\">üìä Workflow Health Overview</h3>\n<table ${tableStyle}>\n  <thead>\n    <tr>\n      <th ${thStyle}>Status</th>\n      <th ${thStyle}>Workflow</th>\n      <th ${thStyle}>Executions</th>\n      <th ${thStyle}>Silent Failures</th>\n      <th ${thStyle}>Failure Rate</th>\n      <th ${thStyle}>Top Issues</th>\n    </tr>\n  </thead>\n  <tbody>\n`;\n\nfor (const wf of workflowHealth) {\n  const badge = getHealthBadge(wf.health_score);\n  const topIssues = wf.top_issues.map(i => `${i.type} (${i.count})`).join(', ') || 'N/A';\n  \n  healthTableHtml += `\n    <tr>\n      <td ${tdStyle} style=\"text-align:center\">\n        <span style=\"color:${badge.color};font-weight:600\">${badge.emoji} ${badge.text}</span>\n      </td>\n      <td ${tdStyle}>${esc(wf.workflow_name)}</td>\n      <td ${tdStyle} style=\"text-align:center\">${wf.total_executions}</td>\n      <td ${tdStyle} style=\"text-align:center;color:${badge.color};font-weight:600\">${wf.silent_failures}</td>\n      <td ${tdStyle} style=\"text-align:center;color:${badge.color};font-weight:600\">${wf.failure_rate}%</td>\n      <td ${tdStyle} style=\"font-size:12px\">${esc(topIssues)}</td>\n    </tr>\n`;\n}\n\nhealthTableHtml += `\n  </tbody>\n</table>\n`;\n\n// Recent Silent Failures Detail\nlet failuresTableHtml = '';\nif (silentFailures.length > 0) {\n  failuresTableHtml = `\n<h3 style=\"color:#dc2626;font-family:Arial,Helvetica,sans-serif;margin-top:30px\">üîá Recent Silent Failures (Top ${Math.min(silentFailures.length, 20)})</h3>\n<table ${tableStyle}>\n  <thead>\n    <tr>\n      <th ${thStyle}>Severity</th>\n      <th ${thStyle}>Workflow</th>\n      <th ${thStyle}>Time</th>\n      <th ${thStyle}>Issues Detected</th>\n      <th ${thStyle}>Output Preview</th>\n    </tr>\n  </thead>\n  <tbody>\n`;\n\n  for (const failure of silentFailures.slice(0, 20)) {\n    const severityColors = { high: '#dc2626', medium: '#ea580c', low: '#ca8a04' };\n    const severityEmojis = { high: 'üî¥', medium: 'üü†', low: 'üü°' };\n    const issues = failure.issues.map(i => i.name).join(', ');\n    \n    failuresTableHtml += `\n    <tr>\n      <td ${tdStyle} style=\"text-align:center;color:${severityColors[failure.severity]};font-weight:600\">\n        ${severityEmojis[failure.severity]} ${failure.severity.toUpperCase()}\n      </td>\n      <td ${tdStyle}>${esc(failure.workflow_name)}</td>\n      <td ${tdStyle}>${esc(formatTime(failure.started_at))}</td>\n      <td ${tdStyle} style=\"font-size:12px\">${esc(issues)}</td>\n      <td ${tdStyle} style=\"font-family:monospace;font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis\">${esc(failure.output_preview)}</td>\n    </tr>\n`;\n  }\n\n  failuresTableHtml += `\n  </tbody>\n</table>\n`;\n}\n\n// Combine all sections\nconst emailHtml = `\n<div style=\"font-family:Arial,Helvetica,sans-serif;max-width:1200px;margin:0 auto;padding:20px\">\n  <h2 style=\"color:#dc2626;border-bottom:3px solid #8b5cf6;padding-bottom:10px;font-family:Arial,Helvetica,sans-serif\">üö® n8n Silent Failure Alert</h2>\n  \n  ${summaryHtml}\n  \n  ${explanationHtml}\n  \n  ${healthTableHtml}\n  \n  ${failuresTableHtml}\n  \n  <div style=\"margin-top:30px;padding-top:20px;border-top:1px solid #e5e7eb;text-align:center;font-size:12px;color:#6b7280\">\n    <p>Automated alert generated by n8n monitoring workflow v1.2</p>\n    <p>This email is only sent when silent failures are detected.</p>\n    <p>Powered by Yes AI Consultants Australia - <a href=\"https://www.YesAI.au\" style=\"color:#6b7280;text-decoration:none\">www.YesAI.au</a></p>\n  </div>\n</div>\n`;\n\n// Subject line with severity\nconst subject = `üö® [n8n] Silent failures: ${summary.critical_workflows} critical, ${summary.warning_workflows} warning workflows`;\n\nreturn [{\n  json: {\n    subject: subject,\n    html: emailHtml,\n    summary: summary,\n    report_time: reportTime\n  }\n}];"},"id":"compose-report","name":"Compose Email Report","type":"n8n-nodes-base.code","typeVersion":2,"position":[1200,12]},{"parameters":{"sendTo":"peter@yesai.au","subject":"={{ $json.subject }}","message":"={{ $json.html }}","options":{"senderName":"n8n Monitoring"}},"id":"send-email","name":"Send Email via Gmail","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[1440,12],"credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}},{"parameters":{},"id":"no-action-node","name":"No Issues - Skip Email","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1200,212]}],"connections":{"Schedule Trigger (Every 15 min)":{"main":[[{"node":"Get Active Workflows","type":"main","index":0}]]},"Get Active Workflows":{"main":[[{"node":"Get Successful Executions","type":"main","index":0}]]},"Get Successful Executions":{"main":[[{"node":"Detect Silent Failures","type":"main","index":0}]]},"Detect Silent Failures":{"main":[[{"node":"Has Issues?","type":"main","index":0}]]},"Has Issues?":{"main":[[{"node":"Compose Email Report","type":"main","index":0}],[{"node":"No Issues - Skip Email","type":"main","index":0}]]},"Compose Email Report":{"main":[[{"node":"Send Email via Gmail","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":{"node:Schedule Trigger (7:10am & 7:10pm)":{"recurrenceRules":[]},"node:Schedule Trigger":{"recurrenceRules":[0]},"node:Schedule Trigger (Every 15 min)":{"recurrenceRules":[]}},"meta":null,"pinData":{},"versionId":"71418b41-0492-41c2-93ff-e81c5a14f92f","triggerCount":1,"shared":[{"updatedAt":"2025-11-25T19:10:01.966Z","createdAt":"2025-11-25T19:10:01.966Z","role":"workflow:owner","workflowId":"6ipSW3RPOouybJ7f","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]},{"updatedAt":"2025-11-25T23:15:42.537Z","createdAt":"2025-11-25T22:48:17.678Z","id":"EzLukgQynVFaEJk8","name":"n8n Email Health Check v1.2","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"hours","hoursInterval":24}]}},"id":"trigger-daily","name":"Schedule Trigger (Daily)","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,0]},{"parameters":{"jsCode":"// Generate a unique test ID for this health check run\nconst testId = 'HEALTH_CHECK_' + Date.now() + '_' + Math.random().toString(36).substring(2, 8);\nconst startTime = Date.now();\nconst targetEmail = 'yesrightau@gmail.com';\nconst timestamp = new Date().toISOString();\n\nreturn [{\n  json: {\n    test_id: testId,\n    start_time: startTime,\n    target_email: targetEmail,\n    timestamp: timestamp\n  }\n}];"},"id":"generate-test-id","name":"Generate Test ID","type":"n8n-nodes-base.code","typeVersion":2,"position":[240,0]},{"parameters":{"sendTo":"yesrightau@gmail.com","subject":"={{ 'n8n Health Check - ' + $json.test_id }}","message":"={{ 'This is an automated health check email sent at ' + $json.timestamp + '.\\n\\nTest ID: ' + $json.test_id + '\\n\\nIf you receive this email, the n8n email system is working correctly.' }}","options":{"senderName":"n8n Health Check"}},"id":"send-test-email","name":"Send Test Email","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[480,0],"credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}},{"parameters":{"amount":120,"unit":"seconds"},"id":"wait-2-minutes","name":"Wait 2 Minutes","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[720,0]},{"parameters":{"resource":"message","operation":"getAll","returnAll":false,"limit":20,"filters":{"q":"={{ 'subject:(\"n8n Health Check - ' + $('Generate Test ID').item.json.test_id + '\")' }}","includeSpamTrash":false},"options":{}},"id":"search-for-email","name":"Search for Test Email","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[960,0],"alwaysOutputData":true,"credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}},{"parameters":{"method":"GET","url":"https://gmail.googleapis.com/gmail/v1/users/me/profile","authentication":"predefinedCredentialType","nodeCredentialType":"gmailOAuth2","options":{}},"id":"get-mailbox-stats","name":"Get Mailbox Stats","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1200,0],"alwaysOutputData":true,"credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}},{"parameters":{"jsCode":"// Check if the test email was found and get mailbox stats\n// v1.2 - Sequential execution: Search -> Mailbox Stats -> This node\nconst searchResults = $('Search for Test Email').all();\nconst testId = $('Generate Test ID').item.json.test_id;\nconst startTime = $('Generate Test ID').item.json.start_time;\nconst elapsedMs = Date.now() - startTime;\nconst elapsedSeconds = Math.round(elapsedMs / 1000);\n\n// Get mailbox profile data from the previous node (sequential now)\nconst mailboxData = $input.item.json || {};\nconst messagesTotal = mailboxData.messagesTotal || 0;\nconst threadsTotal = mailboxData.threadsTotal || 0;\n\n// Gmail free tier is 15GB shared across Drive, Gmail, Photos\n// We can't get exact usage via API without admin access, so estimate based on message count\n// Average email ~75KB, so rough estimate\nconst estimatedUsageGB = (messagesTotal * 0.000075).toFixed(2);\nconst maxStorageGB = 15;\nconst estimatedPercent = Math.min(100, ((messagesTotal * 0.000075) / maxStorageGB * 100)).toFixed(1);\n\n// Check if any emails were found\nlet emailFound = false;\nlet foundEmailId = null;\n\nif (searchResults && searchResults.length > 0) {\n  for (const item of searchResults) {\n    if (item.json && item.json.id) {\n      emailFound = true;\n      foundEmailId = item.json.id;\n      break;\n    }\n  }\n}\n\nreturn [{\n  json: {\n    email_found: emailFound,\n    test_id: testId,\n    elapsed_seconds: elapsedSeconds,\n    found_email_id: foundEmailId,\n    mailbox_stats: {\n      messages_total: messagesTotal,\n      threads_total: threadsTotal,\n      estimated_usage_gb: estimatedUsageGB,\n      max_storage_gb: maxStorageGB,\n      estimated_percent: estimatedPercent\n    },\n    timestamp: new Date().toISOString()\n  }\n}];"},"id":"check-email-found","name":"Check Email Found","type":"n8n-nodes-base.code","typeVersion":2,"position":[1440,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"email-found-check","leftValue":"={{ $json.email_found }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"if-email-found","name":"Email Found?","type":"n8n-nodes-base.if","typeVersion":2,"position":[1680,0]},{"parameters":{"jsCode":"// Email was found - system is healthy\nconst data = $('Check Email Found').item.json;\nconst testId = data.test_id;\nconst elapsedSeconds = data.elapsed_seconds;\nconst stats = data.mailbox_stats;\n\nconst now = new Date();\nconst reportTime = now.toLocaleString('en-AU', { timeZone: 'Australia/Melbourne' });\n\nconst emailHtml = `\n<div style=\"font-family:Arial,sans-serif;max-width:600px;margin:0 auto;padding:20px\">\n  <h2 style=\"color:#059669;border-bottom:3px solid #10b981;padding-bottom:10px\">&#10003; Email Health Check - PASSED</h2>\n  \n  <div style=\"background:#f0fdf4;border-left:4px solid #10b981;padding:15px;margin:20px 0\">\n    <p style=\"margin:0;font-size:16px\"><strong>Status:</strong> Email system is working correctly</p>\n    <p style=\"margin:10px 0 0 0;font-size:14px\"><strong>Test ID:</strong> ${testId}</p>\n    <p style=\"margin:5px 0 0 0;font-size:14px\"><strong>Delivery Time:</strong> ${elapsedSeconds} seconds</p>\n    <p style=\"margin:5px 0 0 0;font-size:14px\"><strong>Check Time:</strong> ${reportTime}</p>\n  </div>\n  \n  <div style=\"background:#f0f9ff;border-left:4px solid #3b82f6;padding:15px;margin:20px 0\">\n    <h3 style=\"margin:0 0 10px 0;color:#1e40af;font-size:14px\">&#128233; Mailbox Statistics</h3>\n    <p style=\"margin:5px 0;font-size:14px\"><strong>Total Messages:</strong> ${stats.messages_total.toLocaleString()}</p>\n    <p style=\"margin:5px 0;font-size:14px\"><strong>Total Threads:</strong> ${stats.threads_total.toLocaleString()}</p>\n    <p style=\"margin:5px 0;font-size:14px\"><strong>Estimated Usage:</strong> ${stats.estimated_usage_gb} GB of ${stats.max_storage_gb} GB (~${stats.estimated_percent}%)</p>\n    <div style=\"background:#e5e7eb;border-radius:4px;height:20px;margin-top:10px;overflow:hidden\">\n      <div style=\"background:${parseFloat(stats.estimated_percent) > 80 ? '#ef4444' : parseFloat(stats.estimated_percent) > 50 ? '#f59e0b' : '#10b981'};height:100%;width:${stats.estimated_percent}%;transition:width 0.3s\"></div>\n    </div>\n  </div>\n  \n  <div style=\"margin-top:30px;padding-top:20px;border-top:1px solid #e5e7eb;text-align:center;font-size:12px;color:#6b7280\">\n    <p>Automated health check by n8n monitoring</p>\n  </div>\n</div>\n`;\n\nreturn [{\n  json: {\n    status: 'healthy',\n    subject: '[n8n] Email Health Check PASSED - System OK',\n    html: emailHtml,\n    test_id: testId,\n    elapsed_seconds: elapsedSeconds\n  }\n}];"},"id":"compose-success-email","name":"Compose Success Email","type":"n8n-nodes-base.code","typeVersion":2,"position":[1920,-150]},{"parameters":{"sendTo":"peter@yesai.au","subject":"={{ $json.subject }}","message":"={{ $json.html }}","options":{"senderName":"n8n Health Check"}},"id":"send-success-report","name":"Send Success Report","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[2160,-150],"credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}},{"parameters":{"jsCode":"// Email NOT found - system may be down!\nconst data = $('Check Email Found').item.json;\nconst testId = data.test_id;\nconst elapsedSeconds = data.elapsed_seconds;\nconst stats = data.mailbox_stats;\n\nconst now = new Date();\nconst reportTime = now.toLocaleString('en-AU', { timeZone: 'Australia/Melbourne' });\n\n// SMS message - keep it short (160 char limit)\nconst smsMessage = `ALERT: n8n email DOWN! Test email not received after 2min. Check yesrightau@gmail.com NOW. ID: ${testId.substring(0, 20)}`;\n\nconst emailHtml = `\n<div style=\"font-family:Arial,sans-serif;max-width:600px;margin:0 auto;padding:20px\">\n  <h2 style=\"color:#dc2626;border-bottom:3px solid #ef4444;padding-bottom:10px\">&#128680; Email Health Check - FAILED</h2>\n  \n  <div style=\"background:#fef2f2;border-left:4px solid #ef4444;padding:15px;margin:20px 0\">\n    <p style=\"margin:0;font-size:16px;color:#dc2626\"><strong>Status:</strong> TEST EMAIL NOT RECEIVED</p>\n    <p style=\"margin:10px 0 0 0;font-size:14px\"><strong>Test ID:</strong> ${testId}</p>\n    <p style=\"margin:5px 0 0 0;font-size:14px\"><strong>Wait Time:</strong> ${elapsedSeconds} seconds (2 minutes)</p>\n    <p style=\"margin:5px 0 0 0;font-size:14px\"><strong>Check Time:</strong> ${reportTime}</p>\n  </div>\n  \n  <div style=\"background:#f0f9ff;border-left:4px solid #3b82f6;padding:15px;margin:20px 0\">\n    <h3 style=\"margin:0 0 10px 0;color:#1e40af;font-size:14px\">&#128233; Mailbox Statistics</h3>\n    <p style=\"margin:5px 0;font-size:14px\"><strong>Total Messages:</strong> ${stats.messages_total.toLocaleString()}</p>\n    <p style=\"margin:5px 0;font-size:14px\"><strong>Total Threads:</strong> ${stats.threads_total.toLocaleString()}</p>\n    <p style=\"margin:5px 0;font-size:14px\"><strong>Estimated Usage:</strong> ${stats.estimated_usage_gb} GB of ${stats.max_storage_gb} GB (~${stats.estimated_percent}%)</p>\n    <div style=\"background:#e5e7eb;border-radius:4px;height:20px;margin-top:10px;overflow:hidden\">\n      <div style=\"background:${parseFloat(stats.estimated_percent) > 80 ? '#ef4444' : parseFloat(stats.estimated_percent) > 50 ? '#f59e0b' : '#10b981'};height:100%;width:${stats.estimated_percent}%;transition:width 0.3s\"></div>\n    </div>\n  </div>\n  \n  <div style=\"background:#fffbeb;border-left:4px solid #f59e0b;padding:15px;margin:20px 0\">\n    <p style=\"margin:0;font-size:14px\"><strong>Action Required:</strong></p>\n    <ul style=\"margin:10px 0 0 0;padding-left:20px\">\n      <li>Check Gmail account yesrightau@gmail.com</li>\n      <li>Verify OAuth credentials are still valid</li>\n      <li>Check n8n logs for email sending errors</li>\n      <li>Verify Gmail API quotas haven't been exceeded</li>\n    </ul>\n  </div>\n  \n  <p style=\"margin-top:20px;padding:10px;background:#f3f4f6;border-radius:4px;font-size:12px\">\n    <strong>SMS Alert Sent To:</strong> +61412111000\n  </p>\n  \n  <div style=\"margin-top:30px;padding-top:20px;border-top:1px solid #e5e7eb;text-align:center;font-size:12px;color:#6b7280\">\n    <p>Automated health check by n8n monitoring</p>\n  </div>\n</div>\n`;\n\nreturn [{\n  json: {\n    status: 'failed',\n    subject: '[n8n] Email Health Check FAILED - URGENT',\n    html: emailHtml,\n    sms_message: smsMessage,\n    sms_phone: '61412111000',\n    test_id: testId,\n    elapsed_seconds: elapsedSeconds\n  }\n}];"},"id":"compose-failure-alert","name":"Compose Failure Alert","type":"n8n-nodes-base.code","typeVersion":2,"position":[1920,150]},{"parameters":{"url":"={{ 'https://api.mobilemessage.com.au/simple/send-sms?api_username=03KnC9&api_password=TthH29CLiQ7S8Jd22jMq4UWr16YgtuJBPgjMNX23faP&sender=61412111000&to=' + $json.sms_phone + '&message=' + encodeURIComponent($json.sms_message) }}","options":{}},"id":"send-sms-alert","name":"Send SMS Alert","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2160,150]},{"parameters":{"sendTo":"peter@yesai.au","subject":"={{ $('Compose Failure Alert').item.json.subject }}","message":"={{ $('Compose Failure Alert').item.json.html }}","options":{"senderName":"n8n Health Check ALERT"}},"id":"send-failure-email","name":"Send Failure Email","type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[2400,150],"credentials":{"gmailOAuth2":{"id":"wQTBKo8ZT52ltAMq","name":"Gmail account"}}}],"connections":{"Schedule Trigger (Daily)":{"main":[[{"node":"Generate Test ID","type":"main","index":0}]]},"Generate Test ID":{"main":[[{"node":"Send Test Email","type":"main","index":0}]]},"Send Test Email":{"main":[[{"node":"Wait 2 Minutes","type":"main","index":0}]]},"Wait 2 Minutes":{"main":[[{"node":"Search for Test Email","type":"main","index":0}]]},"Search for Test Email":{"main":[[{"node":"Get Mailbox Stats","type":"main","index":0}]]},"Get Mailbox Stats":{"main":[[{"node":"Check Email Found","type":"main","index":0}]]},"Check Email Found":{"main":[[{"node":"Email Found?","type":"main","index":0}]]},"Email Found?":{"main":[[{"node":"Compose Success Email","type":"main","index":0}],[{"node":"Compose Failure Alert","type":"main","index":0}]]},"Compose Success Email":{"main":[[{"node":"Send Success Report","type":"main","index":0}]]},"Compose Failure Alert":{"main":[[{"node":"Send SMS Alert","type":"main","index":0}]]},"Send SMS Alert":{"main":[[{"node":"Send Failure Email","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Schedule Trigger (Daily)":{"recurrenceRules":[0]}},"meta":null,"pinData":null,"versionId":"c5c7e11c-71e0-48b8-9b57-ee8d95dad37f","triggerCount":1,"shared":[{"updatedAt":"2025-11-25T22:48:17.678Z","createdAt":"2025-11-25T22:48:17.678Z","role":"workflow:owner","workflowId":"EzLukgQynVFaEJk8","projectId":"ePBcCsWsgvLDebw1"}],"tags":[]}],"nextCursor":"eyJsaW1pdCI6MTAwLCJvZmZzZXQiOjEwMH0="}