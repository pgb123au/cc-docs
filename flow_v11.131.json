{"conversation_flow_id": "conversation_flow_bdc11c9ad2d1", "version": 8, "global_prompt": "IDENTITY: You are Grace, the lead receptionist for Re-ignite Health in Australia.\n\nCRITICAL: NEVER say \"Hang tight\". Use \"Just a moment\" or \"One moment\" instead.\n\nTONE & LANGUAGE STYLE:\n- Friendly, professional, concise, empathetic\n- Use warm, conversational language suited for elderly Australians\n- Use simple, clear phrases - avoid jargon or complex terms\n- Be patient and reassuring\n\nFORBIDDEN PHRASES:\n- NEVER say \"Hang tight\" - instead say \"Just a moment\" or \"Bear with me\"\n- NEVER use American slang or expressions\n\nCORE RULES:\n1. Search Knowledge Base FIRST for info.\n2. If tools fail, apologize and transfer to Sara.\n3. TIMEZONE: Sydney ({{current_time_Australia/Sydney}}).", "nodes": [{"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "No problem at all. Would you like us to call you back at a better time? I can make a note for Sara to follow up."}, "edges": [{"condition": "Yes / callback requested", "id": "edge-deferral-yes", "transition_condition": {"type": "prompt", "prompt": "User says yes, wants callback, or provides a time."}, "destination_node_id": "node-confirm-callback-number"}, {"condition": "No / done / decline callback", "id": "edge-deferral-no", "transition_condition": {"type": "prompt", "prompt": "User says no, they'll call back themselves."}, "destination_node_id": "node-hangup-final"}, {"condition": "Timeout", "id": "edge-global-deferral-timeout-v11-53", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "global_node_setting": {"condition": "When user says it's not a good time, asks to call back later, cannot talk now, or is busy.", "negative_finetune_examples": [], "positive_finetune_examples": []}, "name": "global_deferral", "finetune_transition_examples": [], "id": "node-global-deferral", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 0, "y": 17420}}, {"edges": [{"condition": "Phone match found", "id": "edge-lookup-match-v2-001", "transition_condition": {"type": "prompt", "prompt": "Function returned match_found: true"}, "destination_node_id": "node-greeting-existing"}, {"condition": "No phone match", "id": "edge-lookup-no-match-v2-002", "transition_condition": {"type": "prompt", "prompt": "Function returned match_found: false"}, "destination_node_id": "node-greeting-new"}, {"condition": "Error", "id": "edge-lookup-error-v9-31", "transition_condition": {"type": "prompt", "prompt": "Tool returned error, timeout, null, or failed to execute"}, "destination_node_id": "node-greeting-new"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-lookup-caller-phone", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Execute the lookup_caller_by_phone tool to identify the caller from their phone number. Wait for the result and route based on whether a patient match is found or not."}, "name": "caller_id_lookup", "start_speaker": "agent", "response_variables": {"match_found": "found", "last_name": "last_name", "village": "village", "first_name": "first_name", "patient_id": "patient_id"}, "id": "node-caller-id-lookup", "knowledge_base_ids": [], "display_position": {"x": 1100, "y": 21490}, "speak_during_execution": false, "parameters": {"call_id": "{{call_id}}", "phone": "{{user_number}}"}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Greet the caller warmly. Say: 'Hello, you've reached Re-ignite Health. I'm Grace, your virtual receptionist. This call may be recorded for quality and training purposes. Is that {{first_name}} {{last_name}} from {{village}} calling?'"}, "edges": [{"condition": "Identity confirmed", "id": "edge-confirm-identity-v2-003", "transition_condition": {"type": "prompt", "prompt": "User confirms identity (yes, that's me, correct, yep, speaking) OR provides a specific request immediately (e.g., 'Yes, I want to book physio', 'Yes, when is my next appointment', 'That's me, I need to cancel')"}, "destination_node_id": "node-intent-detection"}, {"condition": "Wrong person", "id": "edge-wrong-identity-v2-004", "transition_condition": {"type": "prompt", "prompt": "User says no, not them, wrong person"}, "destination_node_id": "node-manual-lookup"}, {"condition": "Timeout", "id": "edge-greeting-existing-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 10 seconds, silence"}, "destination_node_id": "node-are-you-there"}], "name": "greeting_existing", "finetune_transition_examples": [], "id": "node-greeting-existing", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 1650, "y": 21480}, "timeout": 12000}, {"finetune_conversation_examples": [], "instruction": {"type": "static_text", "text": "Hello, you've reached Re-ignite Health. I'm Grace, the virtual receptionist. This call may be recorded. May I please first ask if you are an existing client of ours?"}, "edges": [{"condition": "Says existing client", "id": "edge-existing-client-v2-005", "transition_condition": {"type": "prompt", "prompt": "User says existing, been here before, current client, etc."}, "destination_node_id": "node-manual-lookup"}, {"condition": "Says new client", "id": "edge-new-client-v2-006", "transition_condition": {"type": "prompt", "prompt": "User says new, first time, never been, etc."}, "destination_node_id": "node-collect-patient-details-new"}, {"condition": "Wants to book (new client)", "id": "edge-greeting-new-book-v11-83", "transition_condition": {"type": "prompt", "prompt": "User immediately states they want to book an appointment or asks about services/pricing"}, "destination_node_id": "node-booking-transfer-intro"}, {"condition": "Timeout", "id": "edge-greeting-new-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 10 seconds, silence"}, "destination_node_id": "node-are-you-there"}, {"condition": "Info/Question", "id": "edge-greeting-new-info-v11-88", "transition_condition": {"type": "prompt", "prompt": "User asks a question, wants information, or has a general inquiry"}, "destination_node_id": "node-intent-detection"}], "name": "greeting_new", "finetune_transition_examples": [], "id": "node-greeting-new", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 1650, "y": 22060}, "timeout": 12000}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "If the user explicitly rejected the name found by Caller ID, IGNORE that name and ask for their name as if new. SYSTEMATIC IDENTITY COLLECTION: You need THREE pieces of information.\nSEQUENCE:\n1. Ask for FIRST NAME.\n2. Ask for LAST NAME.\n3. Ask for VILLAGE NAME.\nRULES:\n- Collect one piece at a time.\n- Confirm each piece.\n- Do NOT proceed to lookup until all three are collected.\n- If user says 'home' -> Ask 'Is that within the village or a private residence?'. If Private, pass 'Private Residence'.\n\nNAME CHECK: Check if name was already provided in previous turn. If so, verify it rather than asking again.\n\nPHONE FORMAT HINT: If lookup fails and the number starts with '04', try internally replacing '04' with '+614' for the lookup tool, or ask the user for their number again."}, "edges": [{"condition": "User requests human", "id": "edge-manual-lookup-human-v11-53", "transition_condition": {"type": "prompt", "prompt": "User asks to speak to a person, human, Sara, or real person"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Private residence - skip lookup", "id": "edge-private-residence-skip-lookup-v10-46", "transition_condition": {"type": "prompt", "prompt": "User stated Private Residence AND Name (first_name and last_name) is known."}, "destination_node_id": "node-manual-lookup-function"}, {"condition": "Details provided", "id": "edge-to-name-lookup-v2-007", "transition_condition": {"type": "prompt", "prompt": "Got name and village from user AND village is NOT 'Private'/'Private Residence'/'home'"}, "destination_node_id": "node-manual-lookup-function"}, {"condition": "User is actually new", "id": "edge-lookup-actually-new", "transition_condition": {"type": "prompt", "prompt": "User says they're new, never been there, first time, or not an existing client"}, "destination_node_id": "node-collect-patient-details-new"}, {"condition": "User cannot provide details", "id": "edge-manual-lookup-give-up-v11-43", "transition_condition": {"type": "prompt", "prompt": "User cannot provide name, village, or date of birth; says 'I don't know', 'I can't remember', or is unable to identify themselves after 2+ attempts"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Timeout", "id": "edge-node-manual-lookup-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "User doesn't know village name", "id": "edge-manual-lookup-forgot-village-v11-38", "transition_condition": {"type": "prompt", "prompt": "User doesn't know or can't remember their village name, retirement community name, or location"}, "destination_node_id": "node-dob-lookup"}], "name": "manual_lookup", "finetune_transition_examples": [], "id": "node-manual-lookup", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 7700, "y": 24700}}, {"speak_during_execution_message": "Let me look up your file...", "edges": [{"condition": "Lookup complete - proceed to greeting", "id": "edge-lookup-found-booking-for-other-v11", "transition_condition": {"type": "prompt", "prompt": "Lookup successful (found patient) AND user is booking for someone else (not themselves)."}, "destination_node_id": "node-greeting-proxy"}, {"condition": "High confidence match", "id": "edge-found-by-name-high-confidence-v10-51", "transition_condition": {"type": "prompt", "prompt": "match_found=true AND confidence_score >= 0.8 (or confidence_score is not returned, meaning exact match)"}, "destination_node_id": "node-intent-detection"}, {"condition": "Low confidence match - verify DOB", "id": "edge-found-by-name-low-confidence-v10-51", "transition_condition": {"type": "prompt", "prompt": "match_found=true BUT confidence_score < 0.8 - need secondary verification via DOB to confirm identity"}, "destination_node_id": "node-dob-lookup"}, {"condition": "Not found", "id": "edge-try-dob-v2-009", "transition_condition": {"type": "prompt", "prompt": "match_found=false or not found"}, "destination_node_id": "node-dob-lookup"}, {"condition": "Error", "id": "edge-node-manual-lookup-function-error", "transition_condition": {"type": "prompt", "prompt": "Tool returned error, timeout, null, or success=false. Route to human handoff for manual assistance."}, "destination_node_id": "node-universal-error-handoff"}, {"condition": "Complaint Context", "id": "edge-lookup-to-complaint-v10-83", "transition_condition": {"type": "prompt", "prompt": "User found AND original intent was to make a complaint"}, "destination_node_id": "node-human-transfer-prep"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-lookup-caller-name-village", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Trigger the manual lookup tool. Extract first_name, last_name, and village from conversation history.\n\nEXTRACTION RULES:\n- Extract directly from conversation, do NOT rely on bound variables\n- If user stated 'Private Residence', home, or not in village: pass 'Private Residence' as village\n- Extract phone ONLY if user explicitly provided one (not from_number)\n- For Home Visits: extract full street address into appointment_notes later\n\nPROXY BOOKING: Only include phone if user explicitly stated patient's phone. Do NOT use caller's from_number."}, "name": "manual_lookup_function", "response_variables": {"phone": "phone", "patient_id": "patient_id", "confidence_score": "confidence_score", "match_found": "found", "last_name": "last_name", "village": "village", "first_name": "first_name"}, "id": "node-manual-lookup-function", "knowledge_base_ids": [], "display_position": {"x": 8250, "y": 16340}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "first_name": "", "last_name": "", "village": ""}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Verify DOB from conversation context first. If missing, ask: 'May I please also get your date of birth?'"}, "edges": [{"condition": "DOB provided", "id": "edge-to-dob-function-v2-010", "transition_condition": {"type": "prompt", "prompt": "User provided date of birth"}, "destination_node_id": "node-dob-lookup-function"}, {"condition": "DOB lookup failed or needs human", "id": "edge-dob-refusal-v11", "transition_condition": {"type": "prompt", "prompt": "User refuses to provide date of birth, says they don't want to give it, or asks why it's needed."}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "DOB verification failed", "id": "edge-dob-to-identity-failed-v9-37", "transition_condition": {"type": "prompt", "prompt": "DOB does not match records - identity verification failed"}, "destination_node_id": "node-greeting-identity-failed"}, {"condition": "User unsure/forgot DOB", "id": "edge-dob-unsure-v11-36", "transition_condition": {"type": "prompt", "prompt": "User says they don't know, forgot, can't remember, or are unsure of their date of birth"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Timeout", "id": "edge-node-dob-lookup-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "dob_lookup", "finetune_transition_examples": [], "id": "node-dob-lookup", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 8800, "y": 13460}}, {"speak_during_execution_message": "Checking those details now...", "edges": [{"condition": "Found by DOB", "id": "edge-found-by-dob-v2-011", "transition_condition": {"type": "prompt", "prompt": "found"}, "destination_node_id": "node-intent-detection"}, {"condition": "Still not found", "id": "edge-not-found-transfer-v2-012", "transition_condition": {"type": "prompt", "prompt": "not found"}, "destination_node_id": "node-collect-mobile-fallback"}, {"condition": "Error", "id": "edge-node-dob-lookup-function-error", "transition_condition": {"type": "prompt", "prompt": "Tool returned error, timeout, null, or success=false Route to human handoff for manual assistance."}, "destination_node_id": "node-universal-error-handoff"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-lookup-caller-dob", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Look up the patient by their date of birth. Extract date_of_birth (YYYY-MM-DD format) from conversation. Optionally extract first_name and last_name strictly from conversation history if available - do NOT require them."}, "name": "dob_lookup_function", "response_variables": {"match_found": "found", "last_name": "last_name", "village": "village", "first_name": "first_name", "phone": "phone", "patient_id": "patient_id"}, "id": "node-dob-lookup-function", "knowledge_base_ids": [], "display_position": {"x": 9350, "y": 28985}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "first_name": "", "last_name": "", "date_of_birth": ""}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Perfect, thank you. I've noted your details and Sara will call you back shortly to assist you further. Have a great day!"}, "edges": [], "name": "end_call_new_client", "finetune_transition_examples": [], "id": "node-end-call-new-client", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 20900, "y": 34815}, "skip_response_edge": {"condition": "Skip response", "id": "edge-end-new-client-to-termination", "transition_condition": {"type": "prompt", "prompt": "Skip response"}, "destination_node_id": "node-termination-final"}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Detect caller intent from their response. Route to appropriate node.\n\nINTENTS:\n- Booking/appointment -> node-triage-service\n- Reschedule -> node-list-appointments-universal\n- Cancel -> node-list-appointments-universal\n- Class/exercise -> node-class-triage\n- Speak to human -> node-human-transfer-prep\n- General question -> node-kb-answer\n- My Aged Care -> node-mac-greeting\n\nASK ONE QUESTION if intent unclear. Do not assume.\n\nSILENT STANDOFF PREVENTION: After acknowledging intent, ALWAYS ask a clarifying question or explicitly state what you're doing next. Never end on a statement without a question or action.\n\nDIRECTIONS ROUTING: If utterance contains 'directions' / 'where is' / 'how do I get to' with a class name, but NO booking verbs (book/enroll/sign up), route to Information not Class Triage."}, "edges": [{"condition": "Specific Class Inquiry", "id": "edge-intent-class-specific-patch", "transition_condition": {"type": "prompt", "prompt": "User asks about specific classes (Aqua, Gym Fit, Better Balance)"}, "destination_node_id": "node-class-triage"}, {"condition": "Identity Incorrect", "id": "edge-intent-identity-incorrect-v11-47", "transition_condition": {"type": "prompt", "prompt": "User says 'That's not me', 'wrong person', 'I'm not [name]', or indicates the identified person is incorrect"}, "destination_node_id": "node-collect-patient-details"}, {"condition": "Human/Sara Request", "id": "edge-intent-human-request-v11-42", "transition_condition": {"type": "prompt", "prompt": "User explicitly asks to speak to a person, human, representative, or Sara"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Booking", "id": "edge-intent-booking", "transition_condition": {"type": "prompt", "prompt": "User wants to book a NEW appointment (Physio, EP, Class, or any new booking)"}, "destination_node_id": "node-booking-transfer-intro"}, {"condition": "Existing Appointment", "id": "edge-intent-existing-appt", "transition_condition": {"type": "prompt", "prompt": "User wants to manage OR VIEW existing appointments, asks 'when is my next appointment', 'what appointments do I have', 'check my schedule', 'do I have anything booked', or similar schedule inquiries AND {{patient_id}} is NOT empty/null"}, "destination_node_id": "node-list-appointments-universal"}, {"condition": "Existing Appt (unidentified)", "id": "edge-intent-existing-appt-unidentified", "transition_condition": {"type": "prompt", "prompt": "User wants to manage OR VIEW existing appointments BUT {{patient_id}} is empty or null - need to identify them first"}, "destination_node_id": "node-manual-lookup"}, {"condition": "Information", "id": "edge-intent-info", "transition_condition": {"type": "prompt", "prompt": "User wants INFORMATION (FAQ, hours, directions, pricing, MAC funding)"}, "destination_node_id": "node-triage-info"}, {"condition": "Farewell", "id": "edge-intent-farewell", "transition_condition": {"type": "prompt", "prompt": "User is done (no, that's all, bye, thanks, goodbye)"}, "destination_node_id": "node-hangup-final"}, {"condition": "Record/File Query", "id": "edge-intent-record-query-v11-43", "transition_condition": {"type": "prompt", "prompt": "User asks about their own record, file, account, profile, details on file, 'what do you have for me', 'what's my information', or similar personal record inquiry"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "User says something unclear or unrelated", "id": "edge-intent-catchall", "transition_condition": {"type": "prompt", "prompt": "User says something unclear, unrelated, or doesn't match any of the above intents"}, "destination_node_id": "node-kb-answer"}, {"condition": "KB returned no results", "id": "edge-intent-kb-fallback", "transition_condition": {"type": "prompt", "prompt": "Knowledge base returned no relevant information, search failed, or search yielded nothing relevant"}, "destination_node_id": "node-capture-faq-transfer"}, {"condition": "Timeout", "id": "edge-node-intent-detection-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "SMS request", "id": "edge-intent-sms-request-v10-37", "transition_condition": {"type": "prompt", "prompt": "User explicitly asks for SMS, text message, 'send me a text', 'text me the details', 'can you message me', or wants appointment details sent to their phone"}, "destination_node_id": "node-sms-send"}, {"condition": "Complaint intent", "id": "edge-intent-complaint-v10-37", "transition_condition": {"type": "prompt", "prompt": "User wants to make a complaint, raise a concern, had a bad experience, is unhappy about something, or explicitly mentions complaint/concern/issue with service"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Directions/location question about class", "id": "edge-intent-directions-v11-105", "transition_condition": {"type": "prompt", "prompt": "User asks for directions or location of a class but does NOT want to book/enroll"}, "destination_node_id": "node-triage-info"}], "name": "intent_detection", "finetune_transition_examples": [], "model": "gpt-4o", "id": "node-intent-detection", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 2200, "y": 22420}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "CONTEXT CHECK: If user already stated service type ('physio', 'physiotherapy', 'EP', 'exercise physiology') earlier in conversation, route to practitioner preference immediately - do NOT ask about service type again.\n\nSERVICE OPTIONS: Physiotherapy, Exercise Physiology, or classes (Better Balance, Aqua, Gym Fit).\n\nBOOKING FOR SOMEONE ELSE: Only check this if user specifically mentions booking for wife/husband/mother/father/someone else. If {{patient_id}} exists and user is booking for themselves, assume it's for the caller.\n\nDO NOT ASK 'is this for yourself?' if caller is already identified."}, "edges": [{"condition": "Existing patient + Service type already stated \u2192 Skip triage", "id": "edge-booking-direct-to-preference-v11-117", "transition_condition": {"type": "prompt", "prompt": "User ALREADY stated 'physio', 'physiotherapy', 'EP', or 'exercise physiology' in their message or earlier in conversation AND {{patient_id}} is not empty (existing patient identified). Skip triage entirely - proceed directly to practitioner preference."}, "destination_node_id": "node-capture-practitioner-preference"}, {"condition": "Class", "id": "edge-booking-class", "transition_condition": {"type": "prompt", "prompt": "Caller mentions class, Better Balance, Aqua, or Gym Fit."}, "destination_node_id": "node-class-triage"}, {"condition": "Existing patient - Physio/EP (needs triage)", "id": "edge-booking-skip-pii", "transition_condition": {"type": "prompt", "prompt": "{{patient_id}} is not empty (caller already identified) AND caller chose physiotherapy or exercise physiology BUT service type was NOT already stated earlier in conversation."}, "destination_node_id": "node-triage-service"}, {"condition": "New patient - Physio/EP", "id": "edge-booking-physio-ep", "transition_condition": {"type": "prompt", "prompt": "Caller chooses physiotherapy or exercise physiology AND {{patient_id}} is empty or null."}, "destination_node_id": "node-collect-patient-details-new"}, {"condition": "Timeout", "id": "edge-node-booking-transfer-intro-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "Booking for someone else", "id": "edge-booking-for-other-v10-37", "transition_condition": {"type": "prompt", "prompt": "User is booking for someone else (wife, husband, mother, father, spouse, partner, friend, family member). Collect their details."}, "destination_node_id": "node-triage-booking-proxy"}], "name": "booking_transfer_intro", "finetune_transition_examples": [], "id": "node-booking-transfer-intro", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 18150, "y": 29685}}, {"speak_during_execution_message": "One moment while I note that down...", "edges": [{"condition": "User changes mind", "id": "edge-node-capture-booking-escape-v10-80", "transition_condition": {"type": "prompt", "prompt": "User changes mind, asks a different question, says actually never mind, or requests different service"}, "destination_node_id": "node-intent-detection"}, {"condition": "Captured", "id": "edge-booking-captured-to-check-funding", "transition_condition": {"type": "prompt", "prompt": "success: true"}, "destination_node_id": "node-email-sara-unified"}, {"condition": "Error", "id": "edge-node-capture-booking-error", "transition_condition": {"type": "prompt", "prompt": "Tool failed \u00e2\u20ac\u201d apologize and route to Sara handoff."}, "destination_node_id": "node-universal-error-handoff"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-capture-booking-details", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Capture booking intent for Sara. EXTRACTION RULE: Extract caller_name, village, intent (booking_1on1, booking_class, human_request, etc.), urgency (routine/urgent/high), and details (summarize what they need) directly from the conversation. Ensure 'caller_name' and 'village' are populated.\n\nINTENT EXTRACTION: Extract the specific intent that failed (booking_1on1, booking_class, booking_ep, etc.) to enable granular analytics. Do not use generic 'booking_fallback'.\n\nTRANSFER_TYPE EXTRACTION: Extract transfer_type from context: booking_class_failure, booking_ep_failure, booking_physio_failure, etc. Do NOT use generic 'booking_fallback'."}, "name": "capture_booking", "response_variables": {"success": "success", "transfer_id": "transfer_id"}, "id": "node-capture-booking", "knowledge_base_ids": [], "display_position": {"x": 1650, "y": 22700}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "phone_number": "", "patient_id": "{{patient_id}}", "urgency": "", "transfer_type": "", "details": "", "village": "", "intent": "", "caller_name": ""}}, {"speak_during_execution_message": "Let me look up your appointments...", "edges": [{"condition": "No patient_id - identify first", "id": "edge-list-universal-no-patient-id-v11-43", "transition_condition": {"type": "prompt", "prompt": "{{patient_id}} is empty or null - caller not identified. Cannot list appointments without patient ID."}, "destination_node_id": "node-manual-lookup"}, {"condition": "Has appointments", "id": "edge-list-universal-has-appts", "transition_condition": {"type": "prompt", "prompt": "appointment_count > 0"}, "destination_node_id": "node-show-appointments-universal"}, {"condition": "No appointments", "id": "edge-list-universal-no-appts", "transition_condition": {"type": "prompt", "prompt": "appointment_count = 0"}, "destination_node_id": "node-no-appointments-universal"}, {"condition": "Error", "id": "edge-list-universal-error", "transition_condition": {"type": "prompt", "prompt": "Tool returned error, timeout, null, or success=false"}, "destination_node_id": "node-universal-error-handoff"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-list-appointments", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Execute list_appointments tool. Wait for result, then follow success/failure edges.\n\nCONTEXT: Review the conversation history to determine if the user's original intent was to View, Reschedule, or Cancel. Route to the appropriate presentation node based on results.\n\nFAILURE RULE: If this tool fails or returns error, route immediately to human handoff. Do not retry."}, "name": "list_appointments_universal", "response_variables": {"appointment_count": "count", "spoken_text": "spoken_text", "appointments": "appointments", "success": "success"}, "id": "node-list-appointments-universal", "knowledge_base_ids": [], "display_position": {"x": 17050, "y": 30955}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "patient_id": "{{patient_id}}"}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "CONTEXT-AWARE RESPONSE:\n\nCONTEXT CHECK: Review the conversation history to determine if the user wanted to View, Reschedule, or Cancel. Respond appropriately:\n- If 'cancel': \"I don't see any upcoming appointments to cancel in your record. Is there anything else I can help you with?\"\n- If 'reschedule': \"I don't see any upcoming appointments to reschedule. Would you like to book a new appointment instead?\"\n- If 'view' or empty: \"I don't see any upcoming appointments in your record. Would you like to book a new appointment?\"\n\nLOOP PREVENTION: If the user insists they have an appointment after you have checked and found none (2+ disagreements), apologize and say: 'I understand you believe you have an appointment. Let me arrange a callback with Sara who can check our full system.' Then route to human transfer."}, "edges": [{"condition": "Yes book new", "id": "edge-no-appts-universal-book", "transition_condition": {"type": "prompt", "prompt": "User wants to book new appointment"}, "destination_node_id": "node-booking-transfer-intro"}, {"condition": "Something else", "id": "edge-no-appts-universal-other", "transition_condition": {"type": "prompt", "prompt": "User has another request or says no"}, "destination_node_id": "node-intent-detection"}, {"condition": "Done", "id": "edge-no-appts-universal-farewell", "transition_condition": {"type": "prompt", "prompt": "User is done, says goodbye, no thanks"}, "destination_node_id": "node-hangup-final"}, {"condition": "User insists 2+ times", "id": "edge-no-appts-retry-limit-v11-40", "transition_condition": {"type": "prompt", "prompt": "User insists/disagrees they have an appointment after being told none found - route to human transfer if they insist 2+ times"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Timeout", "id": "edge-no-appts-universal-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "no_appointments_universal", "finetune_transition_examples": [], "id": "node-no-appointments-universal", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 17600, "y": 32905}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Present appointments to caller from {{spoken_text}}.\n\nRULES:\n1. Read appointments EXACTLY as provided\n2. Ask which appointment they want to modify\n3. Wait for selection before proceeding\n\nAfter selection, confirm: \"That's the [date/time] appointment with [practitioner]. Would you like to reschedule or cancel this one?\"\n\nRoute based on response: reschedule -> node-reschedule-which, cancel -> node-cancel-confirm-main.\n\nMULTIPLE APPOINTMENTS: If user says 'Reschedule' but has multiple appointments, ASK 'Which one would you like to reschedule?' first. Do NOT transition until a specific appointment is identified.\n\nIMPORTANT: Only list the first 2-3 appointments unless the user specifically asks for more. Do not repeat full details unnecessarily.\n\nTIMEZONE SAFETY: NEVER read raw ISO timestamps. If spoken_text is missing, say 'Let me get the exact time' and route to human."}, "edges": [{"condition": "Appointment identified", "id": "edge-show-universal-fast-track", "transition_condition": {"type": "prompt", "prompt": "User has ALREADY specified which appointment to reschedule (e.g. 'the Tuesday one', 'my 10am appointment')"}, "destination_node_id": "node-get-reschedule-availability"}, {"condition": "Bulk cancel request", "id": "edge-show-universal-bulk-cancel", "transition_condition": {"type": "prompt", "prompt": "User's context implies intent to Cancel AND user wants to cancel ALL/multiple appointments (said 'cancel all', 'cancel everything', 'all of them')"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Proceed with reschedule", "id": "edge-show-universal-to-reschedule", "transition_condition": {"type": "prompt", "prompt": "User explicitly asks to reschedule OR context implies intent to reschedule"}, "destination_node_id": "node-ask-reschedule-date"}, {"condition": "Proceed with cancel", "id": "edge-show-universal-to-cancel", "transition_condition": {"type": "prompt", "prompt": "User explicitly asks to cancel OR context implies intent to cancel"}, "destination_node_id": "node-cancel-confirm-main"}, {"condition": "Multiple - ask which to cancel", "id": "edge-show-universal-cancel-which", "transition_condition": {"type": "prompt", "prompt": "User's context implies intent to Cancel AND multiple appointments found AND user has not yet specified which one"}, "destination_node_id": "node-cancel-confirm-main"}, {"condition": "Multiple - ask which to reschedule", "id": "edge-show-universal-reschedule-which", "transition_condition": {"type": "prompt", "prompt": "User's context implies intent to Reschedule AND multiple appointments found AND user has not yet specified which one"}, "destination_node_id": "node-reschedule-which"}, {"condition": "Stop listing", "id": "edge-show-universal-stop-listing", "transition_condition": {"type": "prompt", "prompt": "User says stop, that's enough, no more, okay, got it, or indicates they don't want to hear more appointments"}, "destination_node_id": "node-anything-else"}, {"condition": "Something else", "id": "edge-show-universal-view-more", "transition_condition": {"type": "prompt", "prompt": "User's context implies intent to View AND user has another request or question"}, "destination_node_id": "node-intent-detection"}, {"condition": "Nothing else", "id": "edge-show-universal-view-done", "transition_condition": {"type": "prompt", "prompt": "User's context implies intent to View AND user is done or satisfied"}, "destination_node_id": "node-hangup-final"}, {"condition": "Timeout", "id": "edge-show-universal-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "show_appointments_universal", "finetune_transition_examples": [], "id": "node-show-appointments-universal", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 17600, "y": 14100}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "The user wants to reschedule but has multiple appointments. Ask: 'Which appointment would you like to reschedule?'"}, "edges": [{"condition": "Appointment selected", "id": "edge-reschedule-which-selected", "transition_condition": {"type": "prompt", "prompt": "The user has selected a specific appointment."}, "destination_node_id": "node-get-reschedule-availability"}], "name": "reschedule_which", "finetune_transition_examples": [], "id": "node-reschedule-which", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 18150, "y": 5295}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Confirm the users INTENT to reschedule (not the result). Say: So you would like to move your appointment from [original] to [new time]. Let me update that for you now. Do NOT say it has been rescheduled yet. Ask for reason if not provided. Include the service type in confirmation: \"I'll move your [Service Type] appointment from...\"\n\nCRITICAL: Explicitly recall and hold the 'appointment_id' and 'new_starts_at' timestamp for the tool call."}, "edges": [{"condition": "Topic Change / Different Request", "id": "edge-reschedule-escape-hatch", "transition_condition": {"type": "prompt", "prompt": "User changes topic, asks an unrelated question, says 'actually never mind', 'I have a different question', or indicates they want to do something else instead of rescheduling"}, "destination_node_id": "node-intent-detection"}, {"condition": "User wants to cancel instead", "id": "edge-reschedule-switch-cancel-v11-43", "transition_condition": {"type": "prompt", "prompt": "User decides to CANCEL instead of reschedule - says 'actually cancel it', 'just cancel', 'forget the reschedule, cancel it', 'I'd rather just cancel'"}, "destination_node_id": "node-cancel-confirm-main"}, {"condition": "Confirm reschedule", "id": "edge-reschedule-confirm-execute", "transition_condition": {"type": "prompt", "prompt": "User confirms the reschedule (says yes, go ahead, correct, that's right) AND reason has been captured (user provided a reason for rescheduling). If user confirms but no reason was given yet, ask for the reason first before proceeding."}, "destination_node_id": "node-reschedule-function"}, {"condition": "Change mind - refresh slots", "id": "edge-reschedule-change", "transition_condition": {"type": "prompt", "prompt": "User says change, no, wait, different time"}, "destination_node_id": "node-ask-new-reschedule-date"}, {"condition": "Timeout", "id": "edge-node-reschedule-confirm-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "Slot no longer available", "id": "edge-resched-slot-unavailable-v10-08", "transition_condition": {"type": "prompt", "prompt": "Tool returned error indicating slot is no longer available or was taken"}, "destination_node_id": "node-present-reschedule-slots"}], "name": "reschedule_confirm", "finetune_transition_examples": [], "id": "node-reschedule-confirm", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 19800, "y": 6705}}, {"speak_during_execution_message": "Just updating your appointment now...", "edges": [{"condition": "Success", "id": "edge-resched-success", "transition_condition": {"type": "prompt", "prompt": "success=true"}, "destination_node_id": "node-reschedule-success-msg"}, {"condition": "Error", "id": "edge-reschedule-function-error", "transition_condition": {"type": "prompt", "prompt": "Function failed or workflow error"}, "destination_node_id": "node-universal-error-handoff"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-reschedule-appointment", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Reschedule the appointment.\n\nCRITICAL EXTRACTION (Use conversation context, NOT bound variables):\n1. 'appointment_id': ID of the appointment to move (from list_appointments history).\n2. 'new_datetime': ISO 8601 timestamp of the NEW slot (e.g., 2025-12-15T10:00:00+11:00).\n3. 'reason': Optional user reason.\n\nRULES:\n- Match user's choice to the 'tool-get-reschedule-availability' output to find the exact 'datetime' ISO string.\n- Do NOT reformat the timestamp. Use it exactly as returned by the tool."}, "name": "reschedule_function", "response_variables": {"new_appointment_id": "new_appointment_id", "new_starts_at": "new_starts_at", "message": "message", "success": "success"}, "id": "node-reschedule-function", "knowledge_base_ids": [], "display_position": {"x": 20350, "y": 9160}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "new_starts_at": "", "reason": "", "appointment_id": ""}}, {"speak_during_execution_message": "Processing your cancellation now...", "edges": [{"condition": "Success", "id": "edge-cancel-success", "transition_condition": {"type": "prompt", "prompt": "success=true"}, "destination_node_id": "node-cancel-success"}, {"condition": "Error", "id": "edge-cancel-function-error", "transition_condition": {"type": "prompt", "prompt": "Function failed or workflow error"}, "destination_node_id": "node-universal-error-handoff"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-cancel-appointment", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Cancel the appointment.\n\nCRITICAL EXTRACTION (Do NOT use hard-bound variables):\n1. Extract 'appointment_id' from the conversation context. If the user is cancelling a booking JUST made in this call, use the ID from that confirmation. Otherwise, use the ID from the list_appointments selection.\n2. Extract 'reason' from the user's stated reason for cancellation\n\nIf cancelling an appointment NOT made in this call, you MUST list appointments first.\n\nThe LLM must extract these from conversation context, not from pre-bound variables.\nEXTRACTION RULE: Look at the JSON output of the 'list_appointments' (or 'get_reschedule_availability') tool in the history. Find the ID matching the appointment the user selected."}, "name": "cancel_function", "response_variables": {"message": "message", "success": "success"}, "id": "node-cancel-function", "knowledge_base_ids": [], "display_position": {"x": 21450, "y": 31605}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "reason": "", "patient_id": "{{patient_id}}", "appointment_id": ""}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "That appointment has been cancelled for you. You will receive a confirmation SMS shortly.\n\nWould you like to book a new appointment for another time?"}, "edges": [{"condition": "User wants to rebook", "id": "edge-cancel-rebook-yes", "transition_condition": {"type": "prompt", "prompt": "User wants to book a new appointment - they may want the same service type that was cancelled"}, "destination_node_id": "node-collect-appointment-preferences"}, {"condition": "User declines rebook and done", "id": "edge-cancel-rebook-no", "transition_condition": {"type": "prompt", "prompt": "User declines rebooking - says 'no', 'no thanks', 'not right now', 'maybe later', or similar negative response to rebooking offer"}, "destination_node_id": "node-add-to-followup-cancel"}, {"condition": "Fallback", "id": "edge-cancel-success-to-anything-else", "transition_condition": {"type": "prompt", "prompt": "User response is unclear or doesn't match specific conditions above"}, "destination_node_id": "node-anything-else"}, {"condition": "Timeout", "id": "edge-node-cancel-success-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "cancel_success", "finetune_transition_examples": [], "id": "node-cancel-success", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 22000, "y": 6405}}, {"speak_during_execution_message": "One moment while I note that down...", "edges": [{"condition": "FAQ needs Sara approval", "id": "edge-capture-faq-to-sara-approval-v9-34", "transition_condition": {"type": "prompt", "prompt": "The FAQ question requires Sara approval before we can provide an answer (Sara approval now handled by compound booking tool)"}, "destination_node_id": "node-email-sara-unified"}, {"condition": "Captured", "id": "edge-faq-captured-v2-076", "transition_condition": {"type": "prompt", "prompt": "success: true"}, "destination_node_id": "node-email-sara-unified"}, {"condition": "Error", "id": "edge-node-capture-faq-transfer-error-added", "transition_condition": {"type": "prompt", "prompt": "Tool failed, returned error, timeout, or null response"}, "destination_node_id": "node-universal-error-handoff"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-capture-booking-details", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Capture transfer details for Sara. Extract from conversation history: caller_name (full name), phone_number (mobile if provided), details (summarize what caller needs help with), urgency (routine/urgent/high based on caller tone). Extract village, intent, and details directly from the conversation history."}, "name": "capture_faq_transfer", "response_variables": {"success": "success", "transfer_id": "transfer_id"}, "id": "node-capture-faq-transfer", "knowledge_base_ids": [], "display_position": {"x": 17050, "y": 33845}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "phone_number": "", "patient_id": "{{patient_id}}", "urgency": "", "transfer_type": "faq", "details": "", "village": "", "intent": "faq_transfer", "caller_name": ""}}, {"speak_during_execution_message": "I'm sending this to Sara now...", "edges": [{"condition": "transfer_id is empty or missing", "id": "edge-transfer-id-guard-v10-55", "transition_condition": {"type": "prompt", "prompt": "The transfer_id variable is empty, null, or was not set by the previous capture tool"}, "destination_node_id": "node-universal-error-handoff"}, {"condition": "Email queued", "id": "edge-email-sara-success", "transition_condition": {"type": "prompt", "prompt": "Tool returned success. We wait_for_result=true to ensure consistent success/error handling."}, "destination_node_id": "node-callback-confirmed-unified"}, {"condition": "Error", "id": "edge-email-sara-error", "transition_condition": {"type": "prompt", "prompt": "Tool returned error, timeout, or failed to execute"}, "destination_node_id": "node-universal-error-handoff"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-email-sara-transfer", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Send email to Sara with the transfer details. This unified node handles all callback types (FAQ, human transfer, complaint). The transfer_id contains all context needed."}, "name": "email_sara_unified", "response_variables": {"success": "success", "email_sent": "email_sent"}, "id": "node-email-sara-unified", "knowledge_base_ids": [], "display_position": {"x": 6050, "y": 31055}, "speak_during_execution": true, "parameters": {"transfer_id": "{{transfer_id}}", "call_id": "{{call_id}}"}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "CONTEXT-AWARE CONFIRMATION:\n\nCheck the type of transfer they requested to customize response:\n- If 'faq': Say 'Sara will call you back to help with your question.'\n- If 'complaint': Say 'I'm sorry for the inconvenience. Sara will call you back to resolve this.'\n- If 'human_request': Say 'Sara will call you back shortly.'\n- Default: Say 'Sara will be in touch soon.'\n\nThen ask: 'Is there anything else I can help you with today{{#if first_name}}, {{first_name}}{{/if}}?'"}, "edges": [{"condition": "Something else", "id": "edge-callback-more", "transition_condition": {"type": "prompt", "prompt": "User has another request"}, "destination_node_id": "node-intent-detection"}, {"condition": "Nothing else", "id": "edge-callback-done", "transition_condition": {"type": "prompt", "prompt": "User is done or says goodbye"}, "destination_node_id": "node-hangup-final"}, {"condition": "Timeout", "id": "edge-callback-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "callback_confirmed_unified", "finetune_transition_examples": [], "id": "node-callback-confirmed-unified", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 6600, "y": 27425}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Prepare for human transfer to Sara.\n\nSAY: \"I'll arrange for Sara to call you back. She's our senior receptionist and can help with this.\"\n\nCOLLECT (if not already known):\n1. Best callback number (confirm {{user_number}} or get new)\n2. Brief reason for callback\n3. Urgency (routine/urgent)\n\nAfter collecting, proceed to capture node. Do NOT promise immediate callback - Sara calls within business hours."}, "edges": [{"condition": "User changes mind", "id": "edge-node-human-transfer-prep-escape-v10-80", "transition_condition": {"type": "prompt", "prompt": "User changes mind, asks a different question, says actually never mind, or requests different service"}, "destination_node_id": "node-intent-detection"}, {"condition": "Capture patient message before transfer", "id": "edge-transfer-prep-to-capture-msg-v9-37", "transition_condition": {"type": "prompt", "prompt": "Ask patient if they have a message to leave before transferring to human"}, "destination_node_id": "node-capture-patient-message"}, {"condition": "Reason provided", "id": "edge-human-reason-v2-088", "transition_condition": {"type": "prompt", "prompt": "User explained why they want to speak to Sara AND did not request to just hang up"}, "destination_node_id": "node-capture-human-transfer"}, {"condition": "Timeout", "id": "edge-node-human-transfer-prep-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "User just wants to hang up", "id": "edge-transfer-hangup", "transition_condition": {"type": "prompt", "prompt": "User says they just want to hang up, end the call, or don't need help anymore"}, "destination_node_id": "node-hangup-final"}, {"condition": "Transfer cancelled - return to flow", "id": "edge-human-transfer-to-intent-v11-62", "transition_condition": {"type": "prompt", "prompt": "User changes mind, expresses a new intent, or wants to do something else instead of waiting for callback"}, "destination_node_id": "node-intent-detection"}], "global_node_setting": {"condition": "User explicitly asks to speak to a human, representative, Sara.", "negative_finetune_examples": [], "positive_finetune_examples": []}, "name": "human_transfer_prep", "finetune_transition_examples": [], "id": "node-human-transfer-prep", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 4400, "y": 18680}}, {"speak_during_execution_message": "Let me note that for Sara...", "edges": [{"condition": "User changes mind", "id": "edge-node-capture-human-transfer-escape-v10-80", "transition_condition": {"type": "prompt", "prompt": "User changes mind, asks a different question, says actually never mind, or requests different service"}, "destination_node_id": "node-intent-detection"}, {"condition": "Captured", "id": "edge-human-captured-v2-089", "transition_condition": {"type": "prompt", "prompt": "success: true"}, "destination_node_id": "node-email-sara-unified"}, {"condition": "Error", "id": "edge-node-capture-human-transfer-error-added", "transition_condition": {"type": "prompt", "prompt": "Tool failed. Route to fallback email/hangup path to avoid infinite loop."}, "destination_node_id": "node-universal-error-handoff"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-capture-booking-details", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Determine intent from context (complaint, human_request, etc.).\n\nEXTRACTION RULE: For the 'details' parameter, combine the original reason for calling with the specific message provided. Format as: '[Original Reason] | User Message: [Message]'."}, "name": "capture_human_transfer", "response_variables": {"success": "success", "transfer_id": "transfer_id"}, "id": "node-capture-human-transfer", "knowledge_base_ids": [], "display_position": {"x": 5500, "y": 23210}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "phone_number": "", "patient_id": "{{patient_id}}", "urgency": "", "transfer_type": "human_request", "details": "", "village": "", "intent": "", "caller_name": ""}}, {"llm_override": {"temperature": 0.3, "model": "gpt-4o-mini"}, "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Is there anything else I can help you with{{#if first_name}}, {{first_name}}{{/if}}?\n\nCOMMON: Most callers say no and end the call. Only route to other actions if the user explicitly requests something.\n\nSMS SUMMARY: If the user requests an SMS summary of what was discussed or booked (e.g., \"can you text me that?\", \"send me a summary\"), draft a concise SMS message and store it in the variable {{message}}. Do NOT read the SMS aloud - just confirm you'll send it and transition to the SMS send node.\n\nSMS LOOP PREVENTION: If user requests SMS and you have not just sent one in the previous turn, proceed to SMS. Otherwise, acknowledge the SMS was already sent.\n\nSMS POLICY: If user asks for booking confirmation via text, say 'Our system sends that automatically' and do NOT trigger the SMS tool."}, "edges": [{"condition": "User frustration or confusion", "id": "edge-anything-else-frustration-v10-07", "transition_condition": {"type": "prompt", "prompt": "User sounds frustrated, confused, repeats the same question, sighs, says 'never mind', 'this isn't working', 'can I just talk to someone', 'real person', 'human', 'operator', 'I need help', or shows any sign of communication difficulty"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "SMS requested", "id": "edge-node-anything-else-to-sms-send", "transition_condition": {"type": "prompt", "prompt": "If caller requested a text message for this info, send SMS now."}, "destination_node_id": "node-sms-send"}, {"condition": "Yes something else", "id": "edge-anything-yes-v2-093", "transition_condition": {"type": "prompt", "prompt": "User has another request"}, "destination_node_id": "node-intent-detection"}, {"condition": "No that's all", "id": "edge-anything-no-v2-094", "transition_condition": {"type": "prompt", "prompt": "User is done"}, "destination_node_id": "node-hangup-final"}, {"condition": "After identifying new booking", "id": "edge-gateway-to-triage", "transition_condition": {"type": "prompt", "prompt": "After identifying new booking intent, go to service triage."}, "destination_node_id": "node-triage-service"}, {"condition": "Timeout", "id": "edge-node-anything-else-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "anything_else", "finetune_transition_examples": [], "id": "node-anything-else", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 12100, "y": 7525}}, {"llm_override": {"temperature": 0.3, "model": "gpt-4o-mini"}, "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "FAST TRIAGE: Route to class schedule immediately.\n\nCLASS TYPES: Hydrotherapy (=Aqua/Pool/Water), Better Balance, Pilates, Gym Fit, Falls Prevention, Tai Chi, Walking Group.\n\nRULE: If caller said class type AND village known, route IMMEDIATELY to get_class_schedule. No confirmation needed."}, "edges": [{"condition": "Class chosen (existing patient)", "id": "edge-class-triage-chosen-existing-v10-49", "transition_condition": {"type": "prompt", "prompt": "Caller mentioned ANY class type (Aqua, Hydrotherapy, Better Balance, Pilates, Falls Prevention, Tai Chi, Walking Group, pool class, water class) AND {{patient_id}} is set. IMMEDIATELY route - do not confirm."}, "destination_node_id": "node-get-class-schedule"}, {"condition": "Class chosen (new patient)", "id": "edge-class-triage-chosen-new-v10-49", "transition_condition": {"type": "prompt", "prompt": "Caller names a specific NON-Gym-Fit class (Better Balance, Aqua, etc.) AND {{patient_id}} is empty/null/not set (new caller must register first before enrollment)"}, "destination_node_id": "node-collect-patient-details-new"}, {"condition": "Unclear / User unsure", "id": "edge-class-triage-unclear", "transition_condition": {"type": "prompt", "prompt": "User is unsure which class, says \"I don't know\", asks for recommendations, or response is unclear"}, "destination_node_id": "node-kb-answer"}, {"condition": "Timeout", "id": "edge-node-class-triage-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "Gym Fit - new patient needs details", "id": "edge-class-triage-gymfit-new-patient-v10-45", "transition_condition": {"type": "prompt", "prompt": "Caller selected Gym Fit class AND {{patient_id}} is empty or null (new patient - must collect details before EP assessment)"}, "destination_node_id": "node-collect-patient-details-new"}, {"condition": "Gym Fit - check EP first", "id": "edge-class-triage-gymfit-ep-v10-37", "transition_condition": {"type": "prompt", "prompt": "Caller selected Gym Fit class AND {{patient_id}} is set - must check EP assessment eligibility before showing schedule AND village is known/set"}, "destination_node_id": "node-check-ep-assessment"}, {"condition": "User wants physio/appointment, NOT class", "id": "edge-class-triage-physio-escape-v11-104", "transition_condition": {"type": "prompt", "prompt": "User explicitly says they want Physiotherapy, a physio appointment, Exercise Physiology, or any 1-on-1 appointment - NOT a class. They may say: \"I don't want a class\", \"physio appointment\", \"I want physio\", \"not a class\", \"individual appointment\""}, "destination_node_id": "node-triage-service"}, {"condition": "User declines / wants info only", "id": "edge-class-triage-escape-v11-105", "transition_condition": {"type": "prompt", "prompt": "User declines class OR wants directions/info only OR changes topic"}, "destination_node_id": "node-intent-detection"}], "name": "class_triage", "finetune_transition_examples": [], "id": "node-class-triage", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 2750, "y": 22670}}, {"speak_during_execution_message": "Let me pull up the latest class schedule...", "edges": [{"condition": "No classes available", "id": "edge-class-schedule-empty", "transition_condition": {"type": "prompt", "prompt": "Tool returns success=true BUT the 'schedule' array is empty/has zero items/no classes available. Route to no-results node. NOTE: Do NOT use this edge for success=false - that should go to human transfer."}, "destination_node_id": "node-class-schedule-no-results"}, {"condition": "No classes at this village (success=false)", "id": "edge-class-schedule-success-false-no-classes-v11-108", "transition_condition": {"type": "prompt", "prompt": "Tool returns success=false AND the message contains 'No' and 'classes' (e.g., 'No Better Balance classes are currently scheduled at...'). This indicates the village doesn't have this class type, not a technical error. Route to no-results node to communicate available alternatives to caller."}, "destination_node_id": "node-class-schedule-no-results"}, {"condition": "Class schedule retrieved successfully", "id": "edge-schedule-to-present", "transition_condition": {"type": "prompt", "prompt": "Tool returned success with class schedule"}, "destination_node_id": "node-present-class-schedule"}, {"condition": "Error", "id": "edge-schedule-fail-to-retry", "transition_condition": {"type": "prompt", "prompt": "Use this edge only if the tool fails due to network error, invalid parameters, or unexpected server error. Do not use this for 'No upcoming sessions found' messages."}, "destination_node_id": "node-universal-error-handoff"}, {"condition": "Stuck/Loop Detection Fallback", "id": "edge-get-class-schedule-loop-fallback", "transition_condition": {"type": "prompt", "prompt": "FALLBACK: If this node has been active for more than 10 seconds without a clear tool response, or if the same availability check has been attempted 2+ times in this conversation, apologize and route to Sara for manual assistance."}, "destination_node_id": "node-human-transfer-prep"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-get-class-schedule", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "LANGUAGE: NEVER say \"hang tight\". Say \"just a moment\" instead.\n\nGet class schedule for the specified village and class type.\n\nVILLAGE RULE: The 'village' parameter here refers to the CLASS LOCATION (where the class is held), not the patient's home village. Extract from conversation context where the user wants to attend class.\n\nSPOKEN FOLLOW-UP: After tool completes, ALWAYS speak. If success: explain results. If no results: tell caller clearly. If error: apologize and offer alternative. NEVER leave caller in silence.\n\nSAFETY: NEVER read raw JSON or {{schedule}} variable directly. If spoken_text is empty or malformed, say 'I'm having trouble accessing the schedule. Let me transfer you to Sara.'\n\nHANDLING success=false: If tool returns success=false with a message about 'No classes at [village]', this is NOT an error - communicate the message to the caller and offer alternatives mentioned in the response (other villages with classes)."}, "name": "get_class_schedule", "response_variables": {"alternative_villages": "alternative_villages", "schedule": "schedule", "spoken_text": "spoken_text", "message": "message", "success": "success", "class_id": "next_class_id"}, "id": "node-get-class-schedule", "knowledge_base_ids": [], "display_position": {"x": 3300, "y": 18080}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "date": "", "village": "{{village}}", "class_type": ""}}, {"speak_during_execution_message": "Just adding you to the class list now...", "edges": [{"condition": "Required IDs cannot be", "id": "edge-enroll-missing-ids", "transition_condition": {"type": "prompt", "prompt": "Required IDs cannot be confidently inferred from history; ask the caller once to clarify, otherwise capture for Sara."}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Enrollment failed", "id": "edge-enroll-fail", "transition_condition": {"type": "prompt", "prompt": "success=false"}, "destination_node_id": "node-universal-error-handoff"}, {"condition": "Enrollment successful", "id": "edge-enrolled-to-confirm", "transition_condition": {"type": "prompt", "prompt": "Tool returned success and enrollment completed"}, "destination_node_id": "node-enroll-confirm"}, {"condition": "Error", "id": "edge-enroll-class-error-v9-32", "transition_condition": {"type": "prompt", "prompt": "Tool returned error, timeout, or failed. Route to Sara for manual enrollment assistance."}, "destination_node_id": "node-universal-error-handoff"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 15000, "wait_for_result": true, "tool_id": "tool-enroll-class", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "LANGUAGE: NEVER say \"hang tight\". Say \"just a moment\" instead.\n\nEnroll patient in the selected class.\n\nVILLAGE RULE: The 'village' parameter here refers to the CLASS LOCATION (where the class is held), not the patient's home village. Use the class location from the schedule lookup.\n\nTRIAL FLAG: Set 'is_trial' to boolean true if user mentions 'free trial', 'try it out', 'first class free'. Otherwise set to false."}, "name": "enroll_class", "response_variables": {"class_name": "class_name", "success": "success", "class_date": "class_date", "class_time": "class_time", "enrollment_id": "enrollment_id"}, "id": "node-enroll-class", "knowledge_base_ids": [], "display_position": {"x": 20900, "y": 8800}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "class_id": "{{class_id}}", "village": "{{village}}", "is_trial": "", "patient_id": "{{patient_id}}", "class_type": "{{class_type}}"}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "I'll make sure to pass that message on to the team. What would you like me to tell them? STORAGE RULE: After the user provides their message, Acknowledge the message (do not overwrite existing content). Format: '[Original reason] | User message: [new message]'. This preserves the original transfer context while adding the user's specific message."}, "edges": [{"condition": "Message captured", "id": "edge-message-captured", "transition_condition": {"type": "prompt", "prompt": "User provides message content"}, "destination_node_id": "node-capture-human-transfer"}, {"condition": "Timeout", "id": "edge-node-capture-patient-message-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "capture_patient_message", "finetune_transition_examples": [], "id": "node-capture-patient-message", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 4950, "y": 20240}}, {"speak_during_execution_message": "Creating your patient file now...", "edges": [{"condition": "User wants Gym Fit or EP Class", "id": "edge-new-client-gym-fit-v10-55", "transition_condition": {"type": "prompt", "prompt": "User mentioned wanting to join Gym Fit, EP classes, or exercise physiology classes"}, "destination_node_id": "node-check-ep-assessment"}, {"condition": "New caller intent was to manage (not book)", "id": "edge-create-client-rescue-manage-v11-43", "transition_condition": {"type": "prompt", "prompt": "User's ORIGINAL intent (from beginning of call) was to reschedule, cancel, or manage an EXISTING appointment - not to book a new one. Route to human as they claim to have an existing record."}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "MAC funding mentioned in conversation", "id": "edge-new-client-mac-bypass-v10-99", "transition_condition": {"type": "prompt", "prompt": "CHECK CONVERSATION HISTORY: User explicitly stated during this call that they have My Aged Care funding, Home Care Package (HCP), or MAC. Do NOT check variables - look for these exact phrases in what the user said earlier in this conversation."}, "destination_node_id": "node-mac-greeting"}, {"condition": "Created - booking 1:1 appointment", "id": "edge-create-client-success", "transition_condition": {"type": "prompt", "prompt": "success=true and patient_id returned AND user wants physio/EP/1:1 appointment (not class)"}, "destination_node_id": "node-collect-appointment-preferences"}, {"condition": "Created - joining waitlist", "id": "edge-create-client-waitlist-v10-49", "transition_condition": {"type": "prompt", "prompt": "success=true and patient_id returned AND context indicates user wants to join a waitlist (not a confirmed booking)."}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Failed", "id": "edge-create-client-fail", "transition_condition": {"type": "prompt", "prompt": "success=false or error (client creation failed)"}, "destination_node_id": "node-universal-error-handoff"}, {"condition": "Intent is FAQ/Complaint", "id": "edge-skip-client-creation", "transition_condition": {"type": "prompt", "prompt": "Intent is FAQ, complaint, callback, directions, info, or other non-booking request. Do NOT create patient."}, "destination_node_id": "node-intent-detection"}, {"condition": "New client created successfully, end call", "id": "edge-create-client-to-end-v9-37", "transition_condition": {"type": "prompt", "prompt": "New patient record created successfully - wrap up the call"}, "destination_node_id": "node-new-patient-booking-triage"}, {"condition": "No Mobile / Refused", "id": "edge-create-client-no-mobile", "transition_condition": {"type": "prompt", "prompt": "User refuses to provide phone number, has no mobile, or phone number extraction failed"}, "destination_node_id": "node-universal-error-handoff"}, {"condition": "Error", "id": "edge-create-client-error-v11-53", "transition_condition": {"type": "prompt", "prompt": "Tool returned error, timeout, or failed to create patient"}, "destination_node_id": "node-universal-error-handoff"}, {"condition": "Gym Fit/EP intent", "id": "edge-create-client-gymfit-ep-v11-73", "transition_condition": {"type": "prompt", "prompt": "Client creation successful and user wanted Gym Fit or EP classes"}, "destination_node_id": "node-check-ep-assessment"}, {"condition": "Standard Class intent", "id": "edge-create-client-standard-class-v11-73", "transition_condition": {"type": "prompt", "prompt": "Client creation successful and user wanted standard exercise classes"}, "destination_node_id": "node-get-class-schedule"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 15000, "wait_for_result": true, "tool_id": "tool-create-new-client", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Extract patient details directly from conversation history.\n\nPHONE RULE: Use the extracted mobile number from conversation. Only use {{user_number}} if the user explicitly confirmed they are booking for themselves.\n\nFORMAT RULE: Convert 'date_of_birth' to YYYY-MM-DD format (e.g., 1955-03-15).\n\nADDRESS RULE: Extract 'address' if the patient is in a Private Residence."}, "name": "create_new_client", "response_variables": {"phone": "mobile", "patient_id": "patient_id", "success": "success", "is_new_client": "is_new_patient", "last_name": "last_name", "sms_phone": "mobile", "village": "village", "first_name": "first_name"}, "id": "node-create-new-client", "knowledge_base_ids": [], "display_position": {"x": 19800, "y": 15280}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "first_name": "", "last_name": "", "address": "", "phone": "", "date_of_birth": "", "village": ""}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "FORBIDDEN: Do not ask for provider names/numbers. Say we'll collect them later.\nUse '10_mac_script.csv' from Knowledge Base.\n\nGreet and assess eligibility:\n\"Great{{#if first_name}}, {{first_name}}{{/if}}! My Aged Care funding can cover your physio or EP appointments. Do you have a My Aged Care package, or would you like me to explain how to get started?\"\n\nCRITICAL: Do NOT ask for provider details or card numbers. We organize funding details offline.\n\nAfter confirming eligibility: 'Would you like to book your first appointment now?'\n\nIf user lacks provider details: 'That's fine, we can organize those later. Would you like to book now?'"}, "edges": [{"condition": "Anonymous User", "id": "edge-mac-anonymous-v11-88", "transition_condition": {"type": "prompt", "prompt": "{{patient_id}} is empty, null, or not set - user is anonymous and needs identification first"}, "destination_node_id": "node-manual-lookup"}, {"condition": "User has MAC and wants to book NOW", "id": "edge-mac-has-approval-fast-book-v11-43", "transition_condition": {"type": "prompt", "prompt": "User confirms they HAVE My Aged Care funding/package AND explicitly wants to book an appointment NOW ('yes I have MAC, book me in', 'I have a package, I want to book')"}, "destination_node_id": "node-collect-appointment-preferences"}, {"condition": "Has MAC approval/package", "id": "edge-mac-has-approval-v10-19", "transition_condition": {"type": "prompt", "prompt": "User confirms they have MAC approval, package, reference number, or are already set up with My Aged Care"}, "destination_node_id": "node-check-funding-mac"}, {"condition": "Needs help/not approved", "id": "edge-mac-needs-help-v10-19", "transition_condition": {"type": "prompt", "prompt": "User is not approved, unsure, wants to know how to apply, or needs help getting started with My Aged Care"}, "destination_node_id": "node-capture-human-transfer"}, {"condition": "Complex/distressed", "id": "edge-mac-complex-v10-19", "transition_condition": {"type": "prompt", "prompt": "User sounds distressed, confused, has complex situation, or explicitly asks to speak to someone"}, "destination_node_id": "node-capture-human-transfer"}, {"condition": "Timeout", "id": "edge-node-mac-greeting-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "Continue to booking preferences", "id": "edge-mac-no-details-proceed", "transition_condition": {"type": "prompt", "prompt": "User does not have provider details handy BUT wants to proceed with booking anyway, or asks to provide them later."}, "destination_node_id": "node-collect-appointment-preferences"}], "name": "MAC assessment (consolidated v10.19)", "finetune_transition_examples": [], "id": "node-mac-greeting", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 20350, "y": 5785}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Based on the funding check result, guide the caller appropriately.\n\nIF ELIGIBLE: 'Great news! Your My Aged Care funding is active. Would you like to book your first appointment now?'\n\nIF NOT ELIGIBLE: 'I see there may be an issue with your funding. Would you like me to arrange a callback from Sara to help sort this out?'\n\nCRITICAL: Do NOT ask for provider details, care advisor names, or contact numbers. We can organize funding details offline."}, "edges": [{"condition": "User wants to book", "id": "edge-mac-outcome-to-booking-v10-94", "transition_condition": {"type": "prompt", "prompt": "User wants to proceed with booking (even if they need to provide details later)."}, "destination_node_id": "node-collect-appointment-preferences"}, {"condition": "Wants to book now", "id": "edge-mac-outcome-book-v10-19", "transition_condition": {"type": "prompt", "prompt": "User says yes, wants to book, ready to book, or indicates booking intent"}, "destination_node_id": "node-collect-appointment-preferences"}, {"condition": "Callback (existing patient)", "id": "edge-mac-outcome-callback-existing-v10-24", "transition_condition": {"type": "prompt", "prompt": "User wants Sara to call them back, wants help applying, or wants followup AND {{patient_id}} is set/known"}, "destination_node_id": "node-add-followup-mac"}, {"condition": "Callback (new caller)", "id": "edge-mac-outcome-callback-new-v10-24", "transition_condition": {"type": "prompt", "prompt": "User wants Sara to call them back, wants help applying, or wants followup BUT {{patient_id}} is empty/null/not set (new caller)"}, "destination_node_id": "node-capture-human-transfer"}, {"condition": "Done/no booking", "id": "edge-mac-outcome-done-v10-19", "transition_condition": {"type": "prompt", "prompt": "User is DONE and does NOT want to book - says 'no thanks', 'not right now', 'I will think about it', 'that is all I needed', 'I will apply myself', goodbye phrases"}, "destination_node_id": "node-anything-else"}, {"condition": "Timeout", "id": "edge-node-mac-outcome-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "MAC outcome handler (consolidated v10.19)", "finetune_transition_examples": [], "id": "node-mac-outcome", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 21450, "y": 12440}}, {"speak_during_execution_message": "Let me note that for follow-up...", "edges": [{"condition": "Proceed after queuing MAC", "id": "edge-add-followup-mac-continue", "transition_condition": {"type": "prompt", "prompt": "patient_id is available - proceed after queuing MAC follow-up for Sara."}, "destination_node_id": "node-anything-else"}, {"condition": "Error", "id": "edge-add-followup-mac-error", "transition_condition": {"type": "prompt", "prompt": "Tool returned error, timeout, or failed"}, "destination_node_id": "node-universal-error-handoff"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-add-to-followup", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Add MAC follow-up request. Extract: caller_name, phone, and notes (summarize what MAC assistance they need).\n\nEXTRACTION RULE: Extract caller_name from conversation history. Do not use bound variables for caller_name.\n\nEXTRACTION RULE: Extract 'caller_name' and 'phone' directly from conversation history. Do NOT use bound variables."}, "speak_after_execution": true, "name": "add_followup_mac", "speak_after_execution_message": "I've added you to Sara's follow-up list. She will call you back to help with your My Aged Care questions.", "response_variables": {"followup_id": "followup_id", "message": "message", "success": "success"}, "id": "node-add-followup-mac", "knowledge_base_ids": [], "display_position": {"x": 22000, "y": 12140}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "reason": "MAC followup", "notes": "", "patient_id": "{{patient_id}}", "urgency": "routine", "phone": "", "caller_name": ""}}, {"llm_override": {"temperature": 0.3, "model": "gpt-4o-mini"}, "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "SERVICE TYPE CHECK: If user has ALREADY said 'physio', 'physiotherapy', 'EP', or 'exercise physiology' earlier in this call, DO NOT ask again - proceed immediately to practitioner preference.\n\nOnly ask about service type if user was vague (e.g., 'sore back', 'need help', 'appointment').\n\nDO NOT ask about practitioner preference or home visits in this node - identify Service Type ONLY, then transition.\n\nHOME VISIT RULE: If user requests Home Visit, ask 'Is that for Physiotherapy or Exercise Physiology?' to set service_category."}, "edges": [{"condition": "User requests human", "id": "edge-triage-human-escape-v11-53", "transition_condition": {"type": "prompt", "prompt": "User asks to speak to a person, human, Sara, or real person"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Service type known - proceed immediately", "id": "edge-triage-to-preference", "transition_condition": {"type": "prompt", "prompt": "Service type (Physiotherapy or Exercise Physiology) has been stated or confirmed in this node OR was already known from earlier in conversation. Proceed immediately to practitioner preference - do NOT ask clarifying questions."}, "destination_node_id": "node-capture-practitioner-preference"}, {"condition": "User mentions class", "id": "edge-triage-to-class", "transition_condition": {"type": "prompt", "prompt": "User mentions class, group, balance, gym, aqua"}, "destination_node_id": "node-class-triage"}, {"condition": "User wants to make a complaint", "id": "edge-triage-to-complaint-v9-37", "transition_condition": {"type": "prompt", "prompt": "User indicates they want to make a complaint or raise a concern"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Timeout", "id": "edge-node-triage-service-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "User changes intent", "id": "edge-triage-escape-hatch-v11-47", "transition_condition": {"type": "prompt", "prompt": "User changes their mind, wants to do something different, or expresses a completely new intent"}, "destination_node_id": "node-intent-detection"}], "name": "triage_service", "finetune_transition_examples": [], "id": "node-triage-service", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 12650, "y": 28145}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Ask: 'Do you have a preferred practitioner, or are you happy with whoever is available?' If user says any name, set practitioner_preference to that name. If user says 'anyone', 'no preference', 'whoever', 'doesn't matter', or similar, proceed immediately WITHOUT asking follow-up questions."}, "edges": [{"condition": "Practitioner preference stated (name or 'anyone')", "id": "edge-pref-captured", "transition_condition": {"type": "prompt", "prompt": "User indicates no specific practitioner preference using ANY of these phrases or similar:\n- 'anyone', 'no preference', 'whoever', 'whoever is available'\n- 'doesn't matter', 'no one specific', 'first available', 'any practitioner'\n- 'see who's available', 'check who's available', 'whoever you can get'\n- 'whoever has availability', 'just check availability', 'show me who's free'\n- 'I don't mind', 'any of them', 'no particular preference'\nOR user names a specific practitioner.\nTransition IMMEDIATELY without asking more questions."}, "destination_node_id": "node-get-slots"}, {"condition": "Timeout", "id": "edge-node-practitioner-preference-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "Class intent detected", "id": "edge-practitioner-to-class-v11-114", "transition_condition": {"type": "prompt", "prompt": "User asks about classes, class schedule, Better Balance, Aqua class, Gym Fit, or changes intent from physio booking to class inquiry. Use this edge BEFORE the KB edge."}, "destination_node_id": "node-class-triage"}, {"condition": "General KB question (not class/availability)", "id": "edge-practitioner-pref-question", "transition_condition": {"type": "prompt", "prompt": "User asks a general question about village info, opening hours, directions, or policies. Do NOT use this edge for questions about class schedules, availability, or booking - those should route to class-triage or get-slots."}, "destination_node_id": "node-kb-answer"}], "name": "capture_practitioner_preference", "finetune_transition_examples": [], "id": "node-capture-practitioner-preference", "knowledge_base_ids": ["knowledge_base_6b0ca1fb26a49041"], "type": "conversation", "display_position": {"x": 13200, "y": 26495}}, {"speak_during_execution_message": "Let me check what times are available for you...", "edges": [{"condition": "Slots available", "id": "edge-get-slots-success", "transition_condition": {"type": "prompt", "prompt": "If availability returned at least one usable slot, present them to caller."}, "destination_node_id": "node-present-new-slots"}, {"condition": "Success", "id": "edge-get-slots-empty", "transition_condition": {"type": "prompt", "prompt": "Tool returned success=true but no availability (spoken_text indicates none OR slots list empty)"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Missing village (edge should rarely fire now)", "id": "edge-get-slots-missing-village-v11-110", "transition_condition": {"type": "prompt", "prompt": "Tool returned error_code='MISSING_VILLAGE' or message contains 'Village is required'. This should NOT happen now that village is auto-bound. If it does occur, ask the caller to confirm their village and retry."}, "destination_node_id": "node-collect-missing-village"}, {"condition": "Error", "id": "edge-get-slots-error", "transition_condition": {"type": "prompt", "prompt": "Tool returned error, timeout, null, or success=false"}, "destination_node_id": "node-universal-error-handoff"}, {"condition": "Stuck/Loop Detection Fallback", "id": "edge-get-slots-loop-fallback", "transition_condition": {"type": "prompt", "prompt": "FALLBACK: If the same availability check has been attempted multiple times without success, or the user is going in circles regarding dates."}, "destination_node_id": "node-human-transfer-prep"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-get-availability", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Execute get-availability tool to find appointment slots.\n\nPARAMETERS (auto-filled where possible):\n- village: Auto-filled from {{village}} (from caller ID lookup)\n- service_category: Extract from conversation ('physio' or 'ep')\n- date: Extract from conversation (YYYY-MM-DD format, default: 2 weeks from now)\n- call_id: Auto-filled from {{call_id}}\n- patient_id: Auto-filled from {{patient_id}}\n\nSERVICE MAPPING: 'Physiotherapy' -> 'physio', 'Exercise Physiology' -> 'ep'\n\nAPPOINTMENT TYPE MAPPING:\n- New patient: 'Initial Consultation'\n- Existing patient: 'Standard Consultation'\n- EP: 'EP Initial Assessment' (new) or 'EP Assessment' (existing)\n- Home visit: 'Initial Home Visit' (new) or 'Standard Home Visit' (existing)\n\nPRACTITIONER: If user requests specific practitioner, search KB for their UUID.\n\nAFTER TOOL RETURNS: Route to appropriate edge based on result. Do NOT speak results here."}, "name": "get_slots", "response_variables": {"spoken_text": "spoken_text", "slots": "available_practitioners", "message": "message", "success": "success", "slots_summary": "slots_summary"}, "id": "node-get-slots", "knowledge_base_ids": ["knowledge_base_6b0ca1fb26a49041"], "display_position": {"x": 13750, "y": 8170}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "date": "", "appointment_type": "", "duration_minutes": "", "patient_id": "{{patient_id}}", "village": "{{village}}", "practitioner_id": "", "service_category": ""}}, {"speak_during_execution_message": "Let me check if an assessment is needed...", "edges": [{"condition": "Assessment not required", "id": "edge-ep-assessment-not-needed-v10-49", "transition_condition": {"type": "prompt", "prompt": "Tool returned needs_assessment=false. Patient does not need an EP assessment for this class - proceed directly to capacity check."}, "destination_node_id": "node-enroll-class"}, {"condition": "Assessment already complete", "id": "edge-ep-already-complete-v10-49", "transition_condition": {"type": "prompt", "prompt": "Tool returned assessment_complete=true (regardless of needs_assessment). Patient has already completed their EP assessment - proceed to capacity check."}, "destination_node_id": "node-enroll-class"}, {"condition": "EP assessment needed - offer booking", "id": "edge-ep-needed-v10-49", "transition_condition": {"type": "prompt", "prompt": "Tool returned needs_assessment=true AND assessment_complete=false. Caller needs EP assessment before joining this class - offer them the option to book it now."}, "destination_node_id": "node-offer-ep-booking"}, {"condition": "Tool error", "id": "edge-ep-tool-error-v10-49", "transition_condition": {"type": "prompt", "prompt": "Tool returned error, timeout, null, or no response received"}, "destination_node_id": "node-universal-error-handoff"}, {"condition": "Add to EP assessment followup list", "id": "edge-ep-assessment-to-followup-v11-86", "transition_condition": {"type": "prompt", "prompt": "User needs EP assessment but wants to be added to followup list for later, or assessment scheduling needs Sara's help"}, "destination_node_id": "node-add-to-followup-class-ep"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-check-ep-assessment", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Check if EP assessment is required for this patient. The class type and village context should be determined from the conversation history."}, "name": "check_ep_assessment", "response_variables": {"needs_assessment": "assessment_required", "message": "message", "assessment_complete": "assessment_completed", "assessment_date": "date_completed"}, "id": "node-check-ep-assessment", "knowledge_base_ids": [], "display_position": {"x": 20350, "y": 9800}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "patient_id": "{{patient_id}}"}}, {"speak_during_execution_message": "Adding you to the EP assessment follow-up list...", "edges": [{"condition": "Proceed after queuing class/EP", "id": "edge-add-to-followup-class-ep-continue", "transition_condition": {"type": "prompt", "prompt": "Proceed after queuing class/EP follow-up for Sara."}, "destination_node_id": "node-anything-else"}, {"condition": "Error", "id": "edge-add-to-followup-class-ep-error", "transition_condition": {"type": "prompt", "prompt": "Tool returned error, timeout, or failed"}, "destination_node_id": "node-universal-error-handoff"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-add-to-followup", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "EXTRACTION: Extract 'caller_name' from conversation (use 'Unknown Caller' if not found). Extract 'phone' from conversation (use from_number if not provided). Add EP assessment follow-up. Extract 'caller_name', 'phone', and 'notes' (including class type and village context) from conversation.\n\nREASON EXTRACTION: Extract reason from context. Use 'Class Full - help needed' if coming from class full flow, or 'EP Assessment booking' if coming from EP assessment flow.\n\nEXTRACTION RULE: Extract 'caller_name' and 'phone' directly from conversation history. Do NOT use bound variables."}, "name": "add_to_followup_class_ep", "response_variables": {"followup_id": "followup_id", "message": "message", "success": "success"}, "id": "node-add-to-followup-class-ep", "knowledge_base_ids": [], "display_position": {"x": 20900, "y": 11420}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "reason": "ep_assessment_followup", "notes": "", "patient_id": "{{patient_id}}", "urgency": "routine", "phone": "{{user_number}}", "caller_name": ""}}, {"speak_during_execution_message": "Let me find some alternative times for you...", "edges": [{"condition": "No availability found", "id": "edge-reschedule-no-slots-v11-51", "transition_condition": {"type": "prompt", "prompt": "Tool returned empty slot list or no available_slots"}, "destination_node_id": "node-anything-else"}, {"condition": "Success - Slots Found", "id": "edge-resched-availability-success", "transition_condition": {"type": "prompt", "prompt": "Tool returned success=true and (spoken_text is present OR slots list is not empty)"}, "destination_node_id": "node-present-reschedule-slots"}, {"condition": "Error", "id": "edge-resched-availability-error", "transition_condition": {"type": "prompt", "prompt": "Tool returned error, timeout, null, or success=false"}, "destination_node_id": "node-universal-error-handoff"}, {"condition": "Stuck/Loop Detection Fallback", "id": "edge-get-reschedule-availability-loop-fallback", "transition_condition": {"type": "prompt", "prompt": "FALLBACK: If this node has been active for more than 10 seconds without a clear tool response, or if the same availability check has been attempted 2+ times in this conversation, apologize and route to Sara for manual assistance."}, "destination_node_id": "node-human-transfer-prep"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-get-reschedule-availability", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Get reschedule availability.\n\nAPPOINTMENT_ID EXTRACTION (CRITICAL): Extract 'appointment_id' from:\n1. The list_appointments output shown earlier in the conversation, OR\n2. The most recently confirmed booking if the user is correcting a just-made booking\n\nLook back in conversation history to find the appointment_id of the specific appointment the user wants to reschedule. The user may have said something like 'the Tuesday one' or 'my 10am appointment' - match this to the appointment list and extract that appointment's ID.\n\nCORRECTION HANDLING: Check the user's last response in the conversation history. If they provided a specific correction date (e.g. 'I meant Wednesday'), use that as the preferred_date parameter."}, "name": "get_reschedule_availability", "response_variables": {"spoken_text": "spoken_text", "success": "success", "slots": "available_slots"}, "id": "node-get-reschedule-availability", "knowledge_base_ids": [], "display_position": {"x": 18700, "y": 4545}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "preferred_date": "", "appointment_id": ""}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Present the available reschedule slots naturally and conversationally.\n\nCRITICAL MEMORY: When user selects a slot, explicitly NOTE:\n1. The 'appointment_id' of the appointment being rescheduled (from the original list_appointments result)\n2. The 'starts_at' ISO timestamp (e.g., this year-12-15T10:00:00+11:00) of the NEW slot they selected\n\nYou MUST pass these exact values to the reschedule tool.\n\nSPEECH STYLE:\n- 'I have a few options for you. There's [day] the [date] at [time], or [day] the [date] at [time].'\n- Use natural date phrasing: 'Tuesday the sixteenth of December'\n- Use natural time: 'ten in the morning' or 'two thirty in the afternoon'"}, "edges": [{"condition": "slot chosen", "id": "edge-resched-slot-chosen", "transition_condition": {"type": "prompt", "prompt": "slot chosen"}, "destination_node_id": "node-reschedule-confirm"}, {"condition": "Timeout", "id": "edge-node-present-reschedule-slots-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "Stuck/Loop Detection", "id": "edge-reschedule-slots-loop-fallback-v10-37", "transition_condition": {"type": "prompt", "prompt": "Same slots have been presented 2+ times and user keeps asking for different options, or conversation has been going in circles about reschedule times"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "User rejects all slots", "id": "edge-reschedule-slots-rejected-v10-51", "transition_condition": {"type": "prompt", "prompt": "User says none of these work, wants different dates, rejects all listed slots, or asks to check availability for a specific time not listed"}, "destination_node_id": "node-ask-new-reschedule-date"}], "name": "present_reschedule_slots", "finetune_transition_examples": [], "id": "node-present-reschedule-slots", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 19250, "y": 5385}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "The user rejected all the reschedule options presented. You MUST ask for a new date preference before checking availability again.\n\nSay something like: \"I'm sorry those times don't work. What date or time frame would be better for you?\"\n\nWait for the user to provide a new date preference (e.g., 'next Tuesday', 'sometime in January', 'morning next week').\n\nONCE THEY PROVIDE A DATE:\nCRITICAL: CONVERT date to YYYY-MM-DD format for the tool parameter (e.g., 'next Tuesday' -> '2024-12-10').\n- Extract the preferred date and convert to YYYY-MM-DD format if possible\n- This will be used as their preferred date for the next availability check\n\nDO NOT proceed to check availability until the user has given a new date preference.\nCRITICAL: When user provides a date, CONVERT to YYYY-MM-DD format for tool parameters."}, "edges": [{"condition": "New date provided", "id": "edge-new-date-provided-v10-51", "transition_condition": {"type": "prompt", "prompt": "User has provided a new date preference (e.g., 'next week', 'Tuesday', 'January 15th', 'sometime in the morning')"}, "destination_node_id": "node-get-reschedule-availability"}, {"condition": "User gives up", "id": "edge-new-date-give-up-v10-51", "transition_condition": {"type": "prompt", "prompt": "User says forget it, never mind, I'll call back later, or wants to abandon rescheduling"}, "destination_node_id": "node-anything-else"}, {"condition": "Timeout", "id": "edge-new-date-timeout-v10-51", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "ask_new_reschedule_date", "finetune_transition_examples": [], "id": "node-ask-new-reschedule-date", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 20350, "y": 1080}}, {"speak_during_execution_message": "Let me note that for follow-up...", "edges": [{"condition": "Proceed after queuing cancellation", "id": "edge-add-to-followup-cancel-continue", "transition_condition": {"type": "prompt", "prompt": "Proceed after logging cancellation - offer to help with anything else"}, "destination_node_id": "node-anything-else"}, {"condition": "Error", "id": "edge-add-to-followup-cancel-error", "transition_condition": {"type": "prompt", "prompt": "Tool returned error, timeout, or failed"}, "destination_node_id": "node-universal-error-handoff"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-add-to-followup", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "EXTRACTION: Extract 'caller_name' from conversation (use 'Unknown Caller' if not found). Extract 'phone' from conversation (use from_number if not provided). Log appointment cancellation. Extract: caller_name, phone, and notes (include which appointment was cancelled and why).\n\nEXTRACTION RULE: Extract 'caller_name' and 'phone' directly from conversation history. Do NOT use bound variables."}, "name": "add_to_followup_cancel", "response_variables": {"followup_id": "followup_id", "message": "message", "success": "success"}, "id": "node-add-to-followup-cancel", "knowledge_base_ids": [], "display_position": {"x": 22550, "y": 3895}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "reason": "cancelled_appointment", "notes": "", "patient_id": "{{patient_id}}", "urgency": "routine", "phone": "{{user_number}}", "caller_name": ""}}, {"speak_during_execution_message": "Sending that text message now...", "edges": [{"condition": "Success", "id": "edge-sms-success", "transition_condition": {"type": "prompt", "prompt": "SMS sent successfully"}, "destination_node_id": "node-sms-sent-confirmation"}, {"condition": "Error", "id": "edge-sms-failed", "transition_condition": {"type": "prompt", "prompt": "Tool returned error, timeout, null, or success=false. Apologize and offer alternative."}, "destination_node_id": "node-universal-error-handoff"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-send-sms", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Send SMS. Usage: Directions, Addresses (include Google Maps link from KB if available), Village phone numbers, General Info, OR if user explicitly requests a text summary of their booking/call details."}, "name": "sms_send", "response_variables": {"success": "success", "message_id": "message_id"}, "id": "node-sms-send", "knowledge_base_ids": [], "display_position": {"x": 17050, "y": 2495}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "message": "", "to_phone": "{{user_number}}"}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "prompt": "\n\nIMPORTANT: If user says 'anyone', 'any', 'first available', or 'doesn't matter', treat this as slot selection and TRANSITION IMMEDIATELY to check_funding_before_book. Do NOT ask again or go back to get_slots.", "text": "CRITICAL: Read {{spoken_text}} VERBATIM to the caller.\n\nThe webhook has returned a natural speech response in {{spoken_text}}. Read it exactly as provided - do NOT paraphrase or summarize.\n\nExample of what {{spoken_text}} contains:\n\"At Gordon Quarter, we have 3 practitioners: Liam Potter, Physio; Paul Salem, Physio; Sue Williams, Physio. Do you have a preference, or would you like me to find the first available appointment?\"\n\nAFTER READING: Wait for the caller to respond with their preference.\n\nTRANSITION IMMEDIATELY: When user selects ANY slot (says 'first', 'second', 'Thursday', 'book it', etc.), transition to next node. Do NOT confirm their choice verbally. Do NOT say 'let me finalize'. Just transition.\n\nONLY IF {{spoken_text}} is empty: Present practitioners from {{slots}} manually."}, "edges": [{"condition": "Slot Selected (Specific or Any)", "id": "edge-present-slots-to-extract", "transition_condition": {"type": "prompt", "prompt": "User indicates slot selection (e.g., 'first', 'Thursday', 'book it') OR indicates no preference (e.g., 'anyone', 'any', 'first available', 'doesn't matter', 'you choose'). Transition immediately to booking."}, "destination_node_id": "node-check-funding-before-book"}, {"condition": "User wants recurring", "id": "edge-present-slots-to-recurring-v10-07", "transition_condition": {"type": "prompt", "prompt": "User asks to make this a recurring/weekly/fortnightly/regular appointment after selecting a slot"}, "destination_node_id": "node-capture-recurring-details"}, {"condition": "PRIVATE pay - skip funding check", "id": "edge-present-slots-private-fast-track-v10-46", "transition_condition": {"type": "prompt", "prompt": "User has selected a time slot AND the user previously stated they want to pay PRIVATELY (self-pay) or do not have funding."}, "destination_node_id": "node-create-appointment"}, {"condition": "User wants different date/time", "id": "edge-present-slots-different-date-v11-120", "transition_condition": {"type": "prompt", "prompt": "User explicitly asks to search for a DIFFERENT date or time than what was just offered. Do NOT trigger if user is merely confirming the current timeframe (e.g. 'yes, in two weeks', 'around that time') or saying 'anyone'/'first available' within the current timeframe."}, "destination_node_id": "node-get-slots"}, {"condition": "Class intent detected", "id": "edge-present-new-slots-to-class-v11-114", "transition_condition": {"type": "prompt", "prompt": "User asks about classes or changes intent from current booking to class inquiry"}, "destination_node_id": "node-class-triage"}, {"condition": "User asks general question / info", "id": "edge-node-present-new-slots-global-return", "transition_condition": {"type": "prompt", "prompt": "User asks a general question about location, hours, pricing, or other information instead of providing the requested answer"}, "destination_node_id": "node-kb-answer"}, {"condition": "User wants to speak to human", "id": "edge-present-slots-human-escape-v11-35", "transition_condition": {"type": "prompt", "prompt": "User explicitly asks to speak to a person, human, Sara, or says this is too complicated"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Timeout", "id": "edge-node-present-new-slots-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "present_new_slots", "finetune_transition_examples": [], "id": "node-present-new-slots", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 14300, "y": 23680}}, {"speak_during_execution_message": "One moment, I'm checking availability and securing that booking now...", "edges": [{"condition": "Booking successful", "id": "edge-compound-success", "transition_condition": {"type": "prompt", "prompt": "Tool returned success=true and appointment_created=true. The compound tool has already: checked holidays, checked recurring conflicts, checked protected slots, created the Cliniko appointment, added treatment notes, sent SMS confirmation, emailed staff, and added to Sara's approval queue. Proceed to confirm the booking to the caller."}, "destination_node_id": "node-booking-readback"}, {"condition": "Holiday blocked", "id": "edge-booking-holiday-error", "transition_condition": {"type": "prompt", "prompt": "Tool returned error_code: HOLIDAY or booking blocked due to public holiday"}, "destination_node_id": "node-universal-error-handoff"}, {"condition": "Funding ineligible", "id": "edge-booking-funding-fail", "transition_condition": {"type": "prompt", "prompt": "Tool returned eligible: false or funding check failed"}, "destination_node_id": "node-universal-error-handoff"}, {"condition": "Recurring conflict", "id": "edge-booking-recurring-conflict", "transition_condition": {"type": "prompt", "prompt": "Tool returned error_code: RECURRING_CONFLICT or slot conflicts with recurring booking"}, "destination_node_id": "node-universal-error-handoff"}, {"condition": "Protected slot", "id": "edge-booking-protected-slot", "transition_condition": {"type": "prompt", "prompt": "Tool returned error_code: PROTECTED_SLOT or slot is protected"}, "destination_node_id": "node-universal-error-handoff"}, {"condition": "Slot unavailable", "id": "edge-booking-slot-unavailable", "transition_condition": {"type": "prompt", "prompt": "error_code = 'SLOT_UNAVAILABLE' or slot is no longer available"}, "destination_node_id": "node-universal-error-handoff"}, {"condition": "Not eligible", "id": "edge-booking-not-eligible", "transition_condition": {"type": "prompt", "prompt": "error_code contains 'FUNDING' OR error_message contains 'eligible' OR funding check failed"}, "destination_node_id": "node-universal-error-handoff"}, {"condition": "Catch-all booking failure", "id": "edge-booking-catchall-fail-v10-02", "transition_condition": {"type": "prompt", "prompt": "success is false and error was not caught by specific holiday, slot, or funding edges above. Use this as final fallback for any unexpected booking failure."}, "destination_node_id": "node-universal-error-handoff"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 25000, "wait_for_result": true, "tool_id": "tool-book-appointment-compound", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Extract target village. Default to {{village}} only if unspecified. MANDATORY: Extract 'practitioner_id' from the selected slot. FUNDING UPDATE: If the user has agreed to Private Pay after a funding rejection, explicitly set funding_type to 'PRIVATE'.\n\nCRITICAL: Extract 'starts_at' (ISO 8601 timestamp) from the slot selected by the user in the previous turn. Do not modify the timestamp.\n\nDURATION RULE: Extract 'duration_minutes' from the selected slot. If not available: Initial Consultation=45, Standard=30, EP Assessment=60.\n\nOPTIONAL FIELDS: Extract if mentioned by user:\n- unit_villa: Unit or villa number (for aged care facilities)\n- appointment_notes: Any special requests or accessibility needs\n- recurrence_details: Frequency and duration for recurring appointments\n\nFUNDING TYPES: HCP, DVA, GP, PRIVATE, PHI (Private Health Insurance). If patient mentions health fund/insurance/extras cover, set funding_type to PHI not PRIVATE."}, "name": "create_appointment", "response_variables": {"error_message": "error_message", "appointment_created": "appointment_created", "practitioner_name": "confirmation_details.practitioner_name", "success": "success", "booking_date": "confirmation_details.date", "appointment_id": "appointment_id", "booking_time": "confirmation_details.time", "error_code": "error_code"}, "id": "node-create-appointment", "knowledge_base_ids": [], "display_position": {"x": 10450, "y": 14690}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "appointment_type": "", "patient_id": "{{patient_id}}", "client_name": "", "practitioner_id": "", "duration_minutes": "", "funding_type": "", "recurrence_details": "", "is_new_client": "", "referral_confirmed": "", "starts_at": "", "village": "", "unit_villa": "", "appointment_notes": ""}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "I had trouble finding your details{{#if first_name}}, {{first_name}}{{/if}}. Let me get your information.\n\nLOOP PREVENTION: If you have already attempted to verify identity and failed, or if the user is getting frustrated, apologize and say: 'I'm having trouble finding your details. Let me have Sara call you back to help.' Then route immediately to human transfer."}, "edges": [{"condition": "Second identity failure", "id": "edge-identity-second-failure-v10-08", "transition_condition": {"type": "prompt", "prompt": "This is the SECOND identity verification failure in this call. Route to human handoff immediately."}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Says existing client", "id": "edge-identity-retry-existing", "transition_condition": {"type": "prompt", "prompt": "User says existing, been here before, current client, etc."}, "destination_node_id": "node-manual-lookup"}, {"condition": "Says new client", "id": "edge-identity-retry-new", "transition_condition": {"type": "prompt", "prompt": "User says new, first time, never been, etc."}, "destination_node_id": "node-intent-detection"}, {"condition": "Fallback", "id": "edge-greeting-identity-failed-fallback", "transition_condition": {"type": "prompt", "prompt": "User says something unclear, unexpected, or doesn't match existing or new client patterns"}, "destination_node_id": "node-intent-detection"}, {"condition": "Timeout", "id": "edge-node-greeting-identity-failed-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "User provides details", "id": "edge-identity-failed-provides-details-v11-47", "transition_condition": {"type": "prompt", "prompt": "User provides their name, village, or other identifying information"}, "destination_node_id": "node-manual-lookup-function"}], "name": "greeting_new_CID_failed", "finetune_transition_examples": [], "id": "node-greeting-identity-failed", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 9350, "y": 0}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Review {{schedule}}. If the schedule is empty or null, say 'I'm sorry, I couldn't find any upcoming classes for that.' Otherwise, present specific day/time options to the user. If user says 'anytime' or is vague, explain you need to book a SPECIFIC session to secure their spot, and read the options again. Identify the specific class_id from their selection (from the schedule/next_class_id) and use it in the next tool call; do not assume stored vars persist automatically from their selection before proceeding."}, "edges": [{"condition": "class_type is Gym Fit", "id": "edge-select-to-ep", "transition_condition": {"type": "prompt", "prompt": "class_type is Gym Fit or EP class"}, "destination_node_id": "node-check-ep-assessment"}, {"condition": "class_type is not EP-required", "id": "edge-select-to-capacity", "transition_condition": {"type": "prompt", "prompt": "User has clearly selected a specific class time from the options provided."}, "destination_node_id": "node-check-capacity"}, {"condition": "If caller says none", "id": "edge-select-class-time-cancel", "transition_condition": {"type": "prompt", "prompt": "User REJECTS all options - says 'none of these work', 'cancel', 'no thanks', 'never mind', 'I do not want any of these', or wants to stop class enrollment entirely"}, "destination_node_id": "node-anything-else"}, {"condition": "Try different class", "id": "edge-select-to-class-triage", "transition_condition": {"type": "prompt", "prompt": "User wants to try a different class type or check other options"}, "destination_node_id": "node-class-triage"}, {"condition": "Timeout", "id": "edge-node-select-class-time-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "User can't decide or needs more info", "id": "edge-select-class-unsure-v11-38", "transition_condition": {"type": "prompt", "prompt": "User can't decide which class time, asks 'which do you recommend', or needs more information about the classes"}, "destination_node_id": "node-kb-answer"}], "name": "select_class_time", "finetune_transition_examples": [], "id": "node-select-class-time", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 5500, "y": 16760}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Answer question using Knowledge Base.\n\nSEARCH ORDER:\n1. 04_faqs.csv - general questions, pricing, policies\n2. 01_villages_config.csv - village locations, addresses, phone numbers, Google Maps links, class locations within villages\n3. 02_practitioners.csv - practitioner info\n\nVILLAGE DIRECTIONS:\n- Most callers LIVE in a village and want directions WITHIN their village (e.g., 'Where is the gym?' = tell them the gym location in THEIR village)\n- For class locations, tell them where the class is held within their village (e.g., 'Better Balance is in the Auditorium in the Main Building')\n- If they want the village address/phone for someone visiting them, offer to SMS the address and Google Maps link\n\nRULES:\n- Read KB answer naturally, don't quote verbatim\n- If not in KB, say \"I don't have that information. Sara can help.\"\n- For complex questions, offer human transfer\n\nAfter answering, ask \"Is there anything else I can help with?\"\n\nSMS OFFER: When answering any directions question (village OR class location), always offer to send via SMS after giving the address."}, "edges": [{"condition": "View appointments", "id": "edge-kb-to-list-appointments", "transition_condition": {"type": "prompt", "prompt": "User asks to check, view, or see their appointments, bookings, schedule, or upcoming sessions AND {{patient_id}} is NOT empty/null (caller is identified). If patient_id is empty, route to node-manual-lookup instead."}, "destination_node_id": "node-list-appointments-universal"}, {"condition": "View appointments (unidentified)", "id": "edge-kb-to-list-appointments-unidentified-v11-33", "transition_condition": {"type": "prompt", "prompt": "User asks to check, view, or see their appointments, bookings, schedule, or upcoming sessions BUT {{patient_id}} is empty/null (caller NOT identified). Route to manual lookup first."}, "destination_node_id": "node-manual-lookup"}, {"condition": "User wants Sara to", "id": "edge-kb-to-message", "transition_condition": {"type": "prompt", "prompt": "User wants Sara to follow up / leave a message"}, "destination_node_id": "node-capture-faq-transfer"}, {"condition": "Question answered and no", "id": "edge-kb-done", "transition_condition": {"type": "prompt", "prompt": "Question was ANSWERED successfully AND user indicates they are satisfied - says 'thanks', 'that helps', 'got it', 'perfect', or indicates no further questions"}, "destination_node_id": "node-anything-else"}, {"condition": "User requests SMS, text", "id": "edge-to-sms", "transition_condition": {"type": "prompt", "prompt": "User requests SMS, text message, or written confirmation of information (e.g., send me the address, text me the details)"}, "destination_node_id": "node-sms-send"}, {"condition": "KB returned no results", "id": "edge-kb-answer-fallback", "transition_condition": {"type": "prompt", "prompt": "Knowledge base FAILED to find relevant information OR returned empty/null results OR confidence score too low to answer"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Timeout", "id": "edge-node-kb-answer-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "KB score below threshold", "id": "edge-kb-low-score-fallback", "transition_condition": {"type": "prompt", "prompt": "Knowledge base returned results but confidence score < 0.5 OR no relevant matches found"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Return to Booking", "id": "edge-node-kb-answer-return-to-booking-v10-95", "transition_condition": {"type": "prompt", "prompt": "User wants to resume booking, says 'anyway back to booking', 'let's book', 'I still want that appointment', or indicates they want to continue with their booking"}, "destination_node_id": "node-collect-appointment-preferences"}], "name": "kb_answer", "finetune_transition_examples": [], "id": "node-kb-answer", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 16500, "y": 26715}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Excellent{{#if first_name}}, {{first_name}}{{/if}}! You're enrolled{{#if class_name}} in {{class_name}}{{/if}}{{#if class_date}} on {{class_date}}{{/if}}{{#if class_time}} at {{class_time}}{{/if}}."}, "edges": [], "name": "enroll_confirm", "finetune_transition_examples": [], "id": "node-enroll-confirm", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 21450, "y": 1715}, "skip_response_edge": {"condition": "Skip response", "id": "edge-skip-node-enroll-confirm", "transition_condition": {"type": "prompt", "prompt": "Skip response"}, "destination_node_id": "node-anything-else"}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Your appointment has been successfully rescheduled.\n\nIMPORTANT: Prefer the tool's 'new_starts_at' output variable. Only fallback to conversation context if that variable is missing.\n\nSay: \"Done! Your appointment has been moved to [day] at [time]. You will receive a confirmation SMS shortly.\"\n\nRead the specific day (e.g., \"Tuesday, December 15th\") and time (e.g., \"10:00 AM\") from the new_starts_at variable or from what the user selected when choosing from the reschedule slots."}, "edges": [], "name": "reschedule_success_msg", "finetune_transition_examples": [], "id": "node-reschedule-success-msg", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 20900, "y": 815}, "skip_response_edge": {"condition": "Skip response", "id": "edge-skip-node-reschedule-success-msg", "transition_condition": {"type": "prompt", "prompt": "Skip response"}, "destination_node_id": "node-anything-else"}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Capture recurring appointment preferences. SEPARATE THESE:\n1. FREQUENCY/DURATION (for recurrence_details): How often (weekly, fortnightly) and for how long (4 weeks, ongoing)\n2. SPECIAL REQUESTS (for appointment_notes): Specific times, practitioner preferences, accessibility needs\n\nAsk: 'How often would you like these appointments, and for how long?' Retain the 'starts_at' timestamp from the previous step context."}, "edges": [{"condition": "PRIVATE pay - skip funding check", "id": "edge-recurring-private-fast-track-v10-46", "transition_condition": {"type": "prompt", "prompt": "Recurring details captured AND user previously stated they want to pay PRIVATELY (self-pay), said \"I will pay myself\", \"private\", \"no funding\", or indicated during this call they do not have MAC/DVA/GP funding - skip funding check entirely and proceed directly to booking"}, "destination_node_id": "node-create-appointment"}, {"condition": "Proceed to funding check then booking", "id": "edge-recurring-captured", "transition_condition": {"type": "prompt", "prompt": "Recurring details captured AND {{funding_type}} is NOT 'PRIVATE' - proceed to funding check first"}, "destination_node_id": "node-check-funding-before-book"}, {"condition": "Timeout", "id": "edge-node-capture-recurring-details-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "capture_recurring_details", "finetune_transition_examples": [], "id": "node-capture-recurring-details", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 9900, "y": 14890}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "CRITICAL: Read {{spoken_text}} VERBATIM to the caller.\n\nThe webhook has returned a natural speech response. Read it exactly as provided.\n\nExample of what {{spoken_text}} contains:\n\"I'm sorry, there are no Better Balance classes currently scheduled at Gordon Quarter. However, Better Balance classes are available at The Baytree, Glenaeon, Henry Kendall. Would you like me to check one of those villages instead?\"\n\nAFTER READING: Wait for the caller to respond.\n\nIf {{spoken_text}} is empty but {{message}} has content, read {{message}} instead.\n\nALTERNATIVES: If {{alternative_villages}} list is available, you can offer to check those specific villages."}, "edges": [{"condition": "User wants to try", "id": "edge-try-different-class", "transition_condition": {"type": "prompt", "prompt": "User wants to try different class type or different search"}, "destination_node_id": "node-class-triage"}, {"condition": "User wants to be", "id": "edge-add-to-waitlist", "transition_condition": {"type": "prompt", "prompt": "User wants to be added to waitlist or notified AND {{patient_id}} is NOT empty/null (caller is identified). If patient_id is empty, route to collect details first."}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Waitlist (unidentified)", "id": "edge-add-to-waitlist-unidentified-v11-33", "transition_condition": {"type": "prompt", "prompt": "User wants to be added to waitlist or notified BUT {{patient_id}} is empty/null (caller NOT identified). Collect patient details first before adding to waitlist."}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "User doesn't want alternatives", "id": "edge-no-alternatives", "transition_condition": {"type": "prompt", "prompt": "User doesn't want alternatives or waitlist"}, "destination_node_id": "node-anything-else"}, {"condition": "Timeout", "id": "edge-node-class-schedule-no-results-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "User asks a question", "id": "edge-no-results-question-v10-37", "transition_condition": {"type": "prompt", "prompt": "User asks a question about the class, schedule, facility, when the next one is, or other clarifying question"}, "destination_node_id": "node-kb-answer"}], "name": "class_schedule_no_results", "finetune_transition_examples": [], "id": "node-class-schedule-no-results", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 3850, "y": 19100}}, {"finetune_conversation_examples": [], "instruction": {"type": "static_text", "text": "Perfect! I've sent you a text message with all the details."}, "edges": [], "name": "sms_sent_confirmation", "finetune_transition_examples": [], "id": "node-sms-sent-confirmation", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 17600, "y": 1090}, "skip_response_edge": {"condition": "Skip response", "id": "edge-skip-node-sms-sent-confirmation", "transition_condition": {"type": "prompt", "prompt": "Skip response"}, "destination_node_id": "node-anything-else"}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "PAST DATE CHECK: If user provides a past date, ask for a future date.\n\nCollect booking preferences:\n1. Service type (if not already established in context) - \"What type of appointment do you need?\"\n2. Date preference - \"When would you like to come in?\" IMPORTANT: When user provides a date, CONVERT to YYYY-MM-DD format for tool parameters.\n3. Time preference - \"Morning or afternoon?\"\n4. Practitioner preference (optional)\n\nSERVICES: Physiotherapy, Occupational Therapy, Podiatry, Dietetics, Massage, Exercise Physiology\n\nOnce collected, proceed to node-check-funding-before-book or node-get-slots.\n\nSERVICE ROUTING: If user requests Massage or Podiatry, explain these services require calling directly and offer to transfer to Sara. Note: We only book Physio and EP online. For Massage or Podiatry, ask the user to call the clinic directly.\n\nDATE ANCHORING: Calculate relative dates based on {{current_time_Australia/Sydney}}. 'Tomorrow' = today + 1 day, 'Next Monday' = the coming Monday, etc."}, "edges": [{"condition": "User requests human", "id": "edge-collect-appointment-preferences-human-v11-52", "transition_condition": {"type": "prompt", "prompt": "User asks to speak to a person, human, Sara, or real person"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "User mentions class/group", "id": "edge-prefs-class-intent", "transition_condition": {"type": "prompt", "prompt": "User mentions class, group class, group session, Better Balance, Aqua, Gym Fit, or any group exercise program"}, "destination_node_id": "node-class-triage"}, {"condition": "Recurring booking request", "id": "edge-collect-prefs-to-recurring-v10-07", "transition_condition": {"type": "prompt", "prompt": "User mentions recurring, weekly, fortnightly, every week, regular appointment, ongoing, or similar repeating schedule request"}, "destination_node_id": "node-capture-recurring-details"}, {"condition": "Preferences collected with specific date", "id": "edge-preferences-collected", "transition_condition": {"type": "prompt", "prompt": "User provided SPECIFIC date(s) (e.g., 'Monday', 'December 15th'). Treat date ranges or vague times ('sometime next week', 'whenever') as Unsure."}, "destination_node_id": "node-get-slots"}, {"condition": "Unclear or needs clarification", "id": "edge-preferences-unclear", "transition_condition": {"type": "prompt", "prompt": "User's preferences are unclear, they asked a question, or want to speak to someone"}, "destination_node_id": "node-kb-answer"}, {"condition": "Timeout", "id": "edge-node-collect-appointment-preferences-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "User is unsure or needs help deciding", "id": "edge-preferences-unsure-v11-38", "transition_condition": {"type": "prompt", "prompt": "User is unsure what they need, doesn't know what service to book, can't decide on a time, or asks for recommendations"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Date provided but Service unknown", "id": "edge-prefs-date-only-v11-44", "transition_condition": {"type": "prompt", "prompt": "User provided date/time but has not specified Physio or EP"}, "destination_node_id": "node-triage-service"}], "name": "collect_appointment_preferences", "finetune_transition_examples": [], "id": "node-collect-appointment-preferences", "knowledge_base_ids": [], "terminal": false, "type": "conversation", "display_position": {"x": 9350, "y": 15790}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "You need an Exercise Physiology assessment before joining Gym Fit. This helps us understand your fitness level and create a safe program for you. Would you like me to book an EP assessment for you now?\n\nIF USER DECLINES ASSESSMENT: Explain firmly: \"I understand, but for safety reasons, we cannot enroll you in Gym Fit without this assessment. Would you like to try a different class like Better Balance instead?\" Then route to class triage if they want alternatives.\n\n\nAPPOINTMENT TYPE: Always use appointment_type='EP Initial Assessment' for EP bookings."}, "edges": [{"condition": "User says yes, book", "id": "edge-offer-ep-yes", "transition_condition": {"type": "prompt", "prompt": "User says yes, book EP assessment. IMPORTANT: Set service_category='ep' and appointment_type='EP Initial Assessment' before transitioning."}, "destination_node_id": "node-collect-appointment-preferences"}, {"condition": "User says no, not", "id": "edge-offer-ep-no", "transition_condition": {"type": "prompt", "prompt": "User says no, not now, maybe later, or declines EP booking. Thank them and end call gracefully."}, "destination_node_id": "node-gym-fit-rejected"}, {"condition": "Timeout", "id": "edge-node-offer-ep-booking-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "User declines EP but wants alternative class", "id": "edge-offer-ep-decline-to-class-v10-37", "transition_condition": {"type": "prompt", "prompt": "User declines EP assessment but expresses interest in trying a different class or asks about alternatives"}, "destination_node_id": "node-class-triage"}], "name": "offer_ep_assessment_booking", "finetune_transition_examples": [], "id": "node-offer-ep-booking", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 20900, "y": 3055}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "CRITICAL: Read {{spoken_text}} VERBATIM to the caller.\n\nThe webhook has returned a natural speech response in {{spoken_text}}. Read it exactly as provided - do NOT paraphrase or summarize.\n\nExample of what {{spoken_text}} contains:\n\"The next Better Balance class at Gordon Quarter is on Tuesday, the 10th of December at 10 am. There are 5 spots available. Would you like me to book a spot for you?\"\n\nAFTER READING: Wait for the caller to respond. If they want to book, extract the class_id from the response data.\n\nONLY IF {{spoken_text}} is empty (unlikely): Present from {{next_session}} data manually."}, "edges": [{"condition": "User selected a class session", "id": "edge-selected-class-to-capacity", "transition_condition": {"type": "prompt", "prompt": "User has selected a specific class time (e.g. 'the 10am one', 'yes book it', 'the first one')."}, "destination_node_id": "node-check-capacity"}, {"condition": "User selects a class time", "id": "edge-class-schedule-to-select-v9-37", "transition_condition": {"type": "prompt", "prompt": "User indicates which class time they want but it's ambiguous or needs clarification."}, "destination_node_id": "node-select-class-time"}, {"condition": "User wants different date/time", "id": "edge-present-class-different-date", "transition_condition": {"type": "prompt", "prompt": "User asks for a different date, different time, different week, or wants to see other options"}, "destination_node_id": "node-get-class-schedule"}, {"condition": "Timeout", "id": "edge-node-present-class-schedule-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "User declines options", "id": "edge-present-class-schedule-decline-v11-95", "transition_condition": {"type": "prompt", "prompt": "User declines all options, says none of these work, not interested, wants something else, or changes mind about class booking"}, "destination_node_id": "node-anything-else"}], "name": "present_class_options", "finetune_transition_examples": [], "id": "node-present-class-schedule", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 4950, "y": 14950}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "[SYSTEM CONTEXT: appointment_id=the appointment]\n\nMEMORY REFRESH: The appointment_id to cancel is the appointment. This was selected by the user from the list-appointments results. You MUST pass this exact ID to the cancel tool.\n\nConfirm the cancellation with the caller. Say something like: 'Just to confirm, you would like to cancel your appointment on [read date from conversation] at [read time from conversation] with [practitioner name from conversation]?' Read these details specifically from the conversation history - do NOT use variable placeholders.\n\nSYSTEM: Internally memorize the appointment_id of the appointment being discussed so you can pass it to the cancellation tool in the next step.\n\nEXTRACTION RULE: Extract the appointment_id from conversation history. Do NOT rely on bound variables."}, "edges": [{"condition": "Proceed with cancellation", "id": "edge-cancel-confirm-with-reason-v10-97", "transition_condition": {"type": "prompt", "prompt": "User confirms cancellation AND simultaneously provides the reason."}, "destination_node_id": "node-cancel-function"}, {"condition": "User confirms cancellation", "id": "edge-cancel-yes", "transition_condition": {"type": "prompt", "prompt": "User confirms cancellation (yes, correct, go ahead) BUT has NOT provided a reason yet."}, "destination_node_id": "node-cancel-collect-reason"}, {"condition": "User declines cancel", "id": "edge-cancel-no", "transition_condition": {"type": "prompt", "prompt": "User declines: no, nevermind, keep it, don't cancel, wait, actually no, etc."}, "destination_node_id": "node-intent-detection"}, {"condition": "Timeout", "id": "edge-node-cancel-confirm-main-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "cancel_confirmation_main", "finetune_transition_examples": [], "id": "node-cancel-confirm-main", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 20350, "y": 31985}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Ask the caller why they need to cancel. Listen for the reason and then proceed to confirm the cancellation. Do NOT attempt to store or set any variables.\n\nCRITICAL: Retain the appointment details (date, time, practitioner) from the previous step so you can confirm them after cancellation."}, "edges": [{"condition": "Reason provided or declined", "id": "edge-reason-collected", "transition_condition": {"type": "prompt", "prompt": "Caller provided a reason for cancellation OR declined to provide one"}, "destination_node_id": "node-cancel-function"}, {"condition": "Timeout", "id": "edge-reason-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "cancel_collect_reason", "finetune_transition_examples": [], "id": "node-cancel-collect-reason", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 20900, "y": 31695}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Collect patient details for new registration.\n\nREQUIRED INFORMATION (collect in order):\n1. Full Name (first and last name)\n2. Village Name (or 'Private Residence' if not in a retirement village)\n3. Date of Birth (convert to YYYY-MM-DD format)\n4. Mobile Phone Number\n\nRULES:\n- Verify any details already collected from earlier in the call\n- Ask only for missing details\n- If user says they're already a patient, route to manual lookup\n- For Private Residence, collect full street address\n- Landlines (02/03/07/08) require mobile number for SMS confirmations\n- Proxy bookings: Ask if the caller's number is best contact for patient\n\nCLASS_VILLAGE PRESERVATION: If caller came from waitlist flow, do NOT overwrite class_village. Store patient's home in {{village}} only."}, "edges": [{"condition": "All details collected", "id": "edge-details-collected", "transition_condition": {"type": "prompt", "prompt": "All 4 required details (Name, Village, DOB, Phone) collected and confirmed - proceed to database check"}, "destination_node_id": "node-create-new-client"}, {"condition": "User says existing client", "id": "edge-details-existing-client", "transition_condition": {"type": "prompt", "prompt": "User says they are already a patient, registered, or have been there before"}, "destination_node_id": "node-manual-lookup"}, {"condition": "User requests human", "id": "edge-details-to-human", "transition_condition": {"type": "prompt", "prompt": "User asks to speak to a human, Sara, or someone else, OR cannot provide details"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "User asks general question", "id": "edge-details-to-kb", "transition_condition": {"type": "prompt", "prompt": "User asks a general question about location, hours, pricing instead of providing details"}, "destination_node_id": "node-kb-answer"}, {"condition": "Rescue: New caller wants reschedule/cancel", "id": "edge-collect-details-rescue-resched-v11-34", "transition_condition": {"type": "prompt", "prompt": "User's original intent was to reschedule, cancel, or manage existing appointments (not book new) - they are NOT trying to book a new appointment"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Timeout", "id": "edge-details-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "User doesn't know or forgot information", "id": "edge-details-forgot-info-v11-38", "transition_condition": {"type": "prompt", "prompt": "User says they don't know, can't remember, forgot their date of birth, village name, or other required details"}, "destination_node_id": "node-human-transfer-prep"}], "name": "collect_patient_details", "finetune_transition_examples": [], "id": "node-collect-patient-details", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 3850, "y": 24700}}, {"llm_override": {"temperature": 0.3, "model": "gpt-4o-mini"}, "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "I can help with that. Are you asking about our location, funding options like My Aged Care, or general questions?\n\nKB PRIORITY: Check your Knowledge Base FIRST for villages, practitioners, FAQs, and MAC scripts before calling any webhooks."}, "edges": [{"condition": "Hours question", "id": "edge-triage-info-hours", "transition_condition": {"type": "prompt", "prompt": "User asks about operating hours, opening hours, when are you open, business hours, clinic hours"}, "destination_node_id": "node-kb-answer"}, {"condition": "MAC/Funding", "id": "edge-triage-info-mac", "transition_condition": {"type": "prompt", "prompt": "User asking about MAC funding, My Aged Care, government funding"}, "destination_node_id": "node-mac-greeting"}, {"condition": "Directions/Location", "id": "edge-triage-info-directions", "transition_condition": {"type": "prompt", "prompt": "User asking about location, address, directions, how to get there, where is the gym, where is the pool, village phone number, or where classes are held"}, "destination_node_id": "node-kb-answer"}, {"condition": "General/FAQ/Hours", "id": "edge-triage-info-general", "transition_condition": {"type": "prompt", "prompt": "User asking general FAQ, hours, pricing, services, or other questions"}, "destination_node_id": "node-kb-answer"}, {"condition": "Change Topic / Human", "id": "edge-triage-info-escape", "transition_condition": {"type": "prompt", "prompt": "User wants to speak to a person, go back, or switch topics"}, "destination_node_id": "node-intent-detection"}, {"condition": "Timeout", "id": "edge-node-triage-info-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "triage_information", "finetune_transition_examples": [], "id": "node-triage-info", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 6600, "y": 17700}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Are you still there? If user responds, acknowledge and ask how you can help them continue. Context recovery: briefly recap what you were discussing before the silence if relevant.\n\nIf the user does not respond after this prompt, the call will end."}, "edges": [{"condition": "User responds - new caller", "id": "edge-still-there-yes-new-v11-52", "transition_condition": {"type": "prompt", "prompt": "User says yes, I'm here, sorry, hello, or any response AND {{patient_id}} is empty (new caller not yet identified)"}, "destination_node_id": "node-manual-lookup"}, {"condition": "User responds - existing caller", "id": "edge-still-there-yes-existing-v11-52", "transition_condition": {"type": "prompt", "prompt": "User says yes, I'm here, sorry, hello, or any response AND {{patient_id}} is NOT empty (existing caller already identified)"}, "destination_node_id": "node-intent-detection"}, {"condition": "User asks for human", "id": "edge-are-you-there-human-v11-37", "transition_condition": {"type": "prompt", "prompt": "User asks to speak to a person, human, or Sara"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "No response", "id": "edge-still-there-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 12 seconds, silence, timeout"}, "destination_node_id": "node-hangup-final"}], "name": "are_you_there", "finetune_transition_examples": [], "id": "node-are-you-there", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 7150, "y": 19780}}, {"finetune_conversation_examples": [], "instruction": {"type": "static_text", "text": "Thanks for calling Re-ignite Health. If you need anything else, just call us back. Have a wonderful day!\n\nGoodbye."}, "edges": [], "name": "hangup_final", "finetune_transition_examples": [], "id": "node-hangup-final", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 18150, "y": 34525}, "skip_response_edge": {"condition": "Skip response", "id": "edge-hangup-to-termination-skip", "transition_condition": {"type": "prompt", "prompt": "Skip response"}, "destination_node_id": "node-termination-final"}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Read back the booking confirmation to the caller using the stored variables: {{booking_date}}, {{booking_time}}, {{practitioner_name}}. These are the Source of Truth for what was actually booked. Verify that the recurrence details (if any) match what the user requested. If variables are empty, say: 'I have secured that appointment for you.' instead of reading details. Say something like: 'Great, I have you booked for [booking_date] at [booking_time] with [practitioner_name]. Is that correct?'\n\nDATE FORMAT: Always read dates in natural spoken format (e.g., 'Tuesday the 12th of January at 2pm'). NEVER read ISO date strings verbatim."}, "edges": [{"condition": "Booked EP Assessment for Gym Fit", "id": "edge-booking-ep-assessment-v11-54", "transition_condition": {"type": "prompt", "prompt": "User just booked an EP Assessment AND the original intent was to join Gym Fit class (check conversation history: user mentioned 'Gym Fit' before being routed to EP assessment)"}, "destination_node_id": "node-ep-next-steps"}, {"condition": "User wants to cancel another appointment", "id": "edge-booking-readback-cancel-other-v11-54", "transition_condition": {"type": "prompt", "prompt": "User wants to cancel ANOTHER appointment (different from the one just booked) - says 'I also want to cancel', 'cancel another one', 'I need to cancel my other appointment'"}, "destination_node_id": "node-list-appointments-universal"}, {"condition": "User has more requests", "id": "edge-readback-yes", "transition_condition": {"type": "prompt", "prompt": "User says yes, has another question, needs help with something else"}, "destination_node_id": "node-anything-else"}, {"condition": "User wants to change booking", "id": "edge-readback-correction-v10-24", "transition_condition": {"type": "prompt", "prompt": "User indicates the booking details need to change - says 'that's not right', 'I said Tuesday not Thursday', 'wrong time', 'can we change it'. Note: The booking is already confirmed in the system, so any changes will need to be a reschedule. IMPORTANT: Before routing, extract the user's preferred new date/time from their correction (e.g., if they said 'I said Tuesday', set preferred_date to 'Tuesday'). Use the appointment_id from the booking just confirmed."}, "destination_node_id": "node-get-reschedule-availability"}, {"condition": "User is done", "id": "edge-readback-no", "transition_condition": {"type": "prompt", "prompt": "User says no AND clearly indicates they are done/satisfied/want to hang up."}, "destination_node_id": "node-hangup-final"}, {"condition": "Class intent detected", "id": "edge-booking-readback-to-class-v11-114", "transition_condition": {"type": "prompt", "prompt": "User asks about classes or changes intent from current booking to class inquiry"}, "destination_node_id": "node-class-triage"}, {"condition": "Timeout", "id": "edge-readback-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "User declines/cancels", "id": "edge-booking-decline-v10-95", "transition_condition": {"type": "prompt", "prompt": "User says no, that's wrong, cancel it, I don't want that, or declines the booking"}, "destination_node_id": "node-cancel-function"}, {"condition": "User wants to join waitlist", "id": "edge-gym-fit-waitlist", "transition_condition": {"type": "prompt", "prompt": "User wants to join the waitlist for Gym Fit class after booking their EP assessment"}, "destination_node_id": "node-human-transfer-prep"}], "name": "booking_readback", "finetune_transition_examples": [], "id": "node-booking-readback", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 11000, "y": 25840}}, {"speak_during_execution_message": "Let me just verify your funding details...", "edges": [{"condition": "Funding Ineligible", "id": "edge-funding-ineligible-v10-004", "transition_condition": {"type": "prompt", "prompt": "Tool returned eligible=false or eligible: false. The patient is NOT approved for this funding type. This edge takes PRIORITY - if ineligible, offer private pay regardless of other conditions."}, "destination_node_id": "node-offer-private-pay"}, {"condition": "Referral required", "id": "edge-funding-requires-referral-v10-08", "transition_condition": {"type": "prompt", "prompt": "Tool returned requires_referral=true AND eligible=true. The patient needs a valid GP/specialist referral for this funding type (DVA or Medicare). Inform them they must bring their referral to the appointment. This edge takes PRIORITY over generic 'funding OK' to ensure referral warning is shown."}, "destination_node_id": "node-referral-warning"}, {"condition": "MAC script already completed", "id": "edge-funding-mac-already-done-v10-06", "transition_condition": {"type": "prompt", "prompt": "MAC/HCP funding detected AND eligible=true BUT user has already completed the MAC script during this call (came from MAC flow, said 'book now', or MAC details already captured). Skip MAC flow and proceed directly to booking. Check conversation: Has agent already said 'My Aged Care funding can help cover' in this call? If yes, skip MAC script."}, "destination_node_id": "node-create-appointment"}, {"condition": "MAC funding", "id": "edge-funding-mac-v10-002", "transition_condition": {"type": "prompt", "prompt": "funding_type is 'HCP' AND eligible=true (MAC/HCP funding only - exclude DVA/Medicare)"}, "destination_node_id": "node-mac-greeting"}, {"condition": "Funding OK or not required", "id": "edge-funding-ok-to-book-v10-001", "transition_condition": {"type": "prompt", "prompt": "Funding check passed (eligible=true AND requires_referral is false or not set), or funding not required - proceed to booking"}, "destination_node_id": "node-create-appointment"}, {"condition": "Error - transfer to human", "id": "edge-funding-error-proceed-v10-003", "transition_condition": {"type": "prompt", "prompt": "Tool returned error, timeout, or failed - cannot verify funding status"}, "destination_node_id": "node-universal-error-handoff"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-check-funding", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Check funding eligibility before booking.\n\nExecute tool-check-funding with:\n- patient_id: {{patient_id}}\n- funding_type: MAP from conversation: 'My Aged Care' -> 'HCP', 'Medicare'/'Care Plan' -> 'GP', 'Veterans'/'DVA' -> 'DVA', 'Private Health' -> 'PHI', 'Private'/'Self-pay' -> 'PRIVATE'\n- call_id: {{call_id}}\n- starts_at: Extract ISO 8601 timestamp from selected slot\n\nRESULTS:\n- eligible=true: Proceed to node-create-appointment\n- eligible=false: Explain {{message}}, offer alternatives\n- requires_referral=true: \"You'll need a GP referral. Shall I proceed anyway?\"\n\nOn error, proceed with booking and note for Sara."}, "name": "check_funding_before_book", "response_variables": {"funding_decision": "funding_decision", "requires_referral": "requires_referral", "success": "success", "eligible": "eligible", "funding_type": "funding_type", "message": "message", "funding_valid": "funding_valid"}, "id": "node-check-funding-before-book", "knowledge_base_ids": [], "display_position": {"x": 14850, "y": 10520}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "starts_at": "", "appointment_type": "", "funding_type": "", "patient_id": "{{patient_id}}"}}, {"llm_override": {"temperature": 0.3, "model": "gpt-4o-mini"}, "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "PRIORITY: If user says 'Yes', 'Enroll me', 'Book it', or similar affirmative, EXECUTE the enrollment immediately - even if they also mention a complaint or other topic. Handle mixed intents AFTER enrollment is complete.\n\n[SYSTEM CONTEXT: class_id={{class_id}}, class_type={{class_type}}, village={{village}}]\n\nGood news, there are spots available in that class! Just to confirm, that is for the {{class_type}} session you selected? Would you like me to book you in?\n\nRead the specific date and time from the conversation context (e.g. \"Monday at 10am\") when confirming. Do NOT use variable placeholders like {{class_date}}.\n\nTRIAL DETECTION: Listen for mentions of 'free trial', 'trying it out', 'first time', etc. If detected, set is_trial=true for the enrollment tool."}, "edges": [{"condition": "Force enroll after repeated confirmations", "id": "edge-class-intent-force-enroll-v10-37", "transition_condition": {"type": "prompt", "prompt": "LOOP BREAKER (CHECK FIRST): User has said yes, sure, okay, please, enroll me, book it, or similar affirmative response 2+ times during this class enrollment conversation AND {{patient_id}} is NOT empty/null. STOP confirming and proceed to enrollment immediately. If patient_id is empty, route to collect details first."}, "destination_node_id": "node-enroll-class"}, {"condition": "Force enroll (NEW patient)", "id": "edge-class-intent-force-enroll-new-v11-33", "transition_condition": {"type": "prompt", "prompt": "LOOP BREAKER: User has confirmed 2+ times BUT {{patient_id}} is empty/null (new caller). Route to collect patient details first before enrollment."}, "destination_node_id": "node-collect-patient-details"}, {"condition": "Confirm (existing patient)", "id": "edge-class-intent-yes-existing-v10-24", "transition_condition": {"type": "prompt", "prompt": "User says yes, please, book me in, sure, okay, or agrees to enrollment AND {{patient_id}} is set/known"}, "destination_node_id": "node-enroll-class"}, {"condition": "Confirm (new caller)", "id": "edge-class-intent-yes-new-v10-24", "transition_condition": {"type": "prompt", "prompt": "User says yes, please, book me in, sure, okay, or agrees to enrollment BUT {{patient_id}} is empty/null/not set (new caller needs registration first)"}, "destination_node_id": "node-collect-patient-details"}, {"condition": "User declines", "id": "edge-class-intent-no-v10-002", "transition_condition": {"type": "prompt", "prompt": "User says no, not now, maybe later, let me think, or declines"}, "destination_node_id": "node-anything-else"}, {"condition": "Topic change / different request", "id": "edge-class-intent-topic-change-v10-37", "transition_condition": {"type": "prompt", "prompt": "User changes topic, asks different question, says 'actually', 'never mind', wants to complain, or indicates different intent than class enrollment"}, "destination_node_id": "node-intent-detection"}, {"condition": "Timeout", "id": "edge-node-confirm-class-intent-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "confirm_class_enrollment_intent", "finetune_transition_examples": [], "id": "node-confirm-class-intent", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 1650, "y": 19530}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "CONTEXT REFRESH: Before offering private pay, summarize the appointment details discussed earlier.\n\nSay something like: \"Just to confirm, we were looking at booking [appointment type] at the time and date we discussed.\"\n\nThen offer: \"We can still book this as a private consultation. The current private consultation fee will apply. Would you like to proceed with that?\"\n\nIf user declines, acknowledge and ask if there's anything else you can help with."}, "edges": [{"condition": "User asks about price/cost", "id": "edge-private-pay-question", "transition_condition": {"type": "prompt", "prompt": "User asks about price, cost, how much, fees, or payment amounts"}, "destination_node_id": "node-kb-answer"}, {"condition": "Accept private pay", "id": "edge-private-pay-yes", "transition_condition": {"type": "prompt", "prompt": "User agrees to private pay, says yes, okay, that's fine, proceed"}, "destination_node_id": "node-create-appointment"}, {"condition": "Decline or unsure", "id": "edge-private-pay-no", "transition_condition": {"type": "prompt", "prompt": "User declines, wants to think about it, or asks for Sara callback"}, "destination_node_id": "node-anything-else"}, {"condition": "Timeout", "id": "edge-node-offer-private-pay-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-anything-else"}], "name": "offer_private_pay", "finetune_transition_examples": [], "id": "node-offer-private-pay", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 15950, "y": 11030}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "The user mentioned their funding type requires a referral. Ask if they have one:\n- If they have it: Great, proceed with booking\n- If they don't have it on them but will bring it: That's fine, proceed with booking and note 'will bring referral'\n- If they don't have one and can't get one: Explain they can book as private pay or contact their GP for a referral\n\nDo NOT force private pay if they just don't have the referral document on them."}, "edges": [{"condition": "User confirms", "id": "edge-referral-proceed", "transition_condition": {"type": "prompt", "prompt": "User says yes, I have a referral, I'll bring it, proceed, etc. Set referral_confirmed to true for the booking node."}, "destination_node_id": "node-create-appointment"}, {"condition": "Switch to Private Pay", "id": "edge-referral-switch-private-v10-17", "transition_condition": {"type": "prompt", "prompt": "User decides to pay privately instead of providing a referral (says 'I'll pay private', 'I'll just pay myself', 'forget the referral', 'I don't need Medicare')"}, "destination_node_id": "node-create-appointment"}, {"condition": "User needs referral - offer private", "id": "edge-referral-no", "transition_condition": {"type": "prompt", "prompt": "User says they don't have a referral, need to get one, or wants to wait"}, "destination_node_id": "node-offer-private-pay"}, {"condition": "Hang up / get referral first", "id": "edge-referral-hangup", "transition_condition": {"type": "prompt", "prompt": "User wants to hang up, get a referral first, or call back later"}, "destination_node_id": "node-hangup-final"}, {"condition": "Timeout", "id": "edge-referral-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "referral_warning", "finetune_transition_examples": [], "id": "node-referral-warning", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 15400, "y": 28825}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "I can help with that. When would you like to move this appointment to? Please let me know your preferred date or day of the week.\n\nDATE ANCHORING: Calculate relative dates based on {{current_time_Australia/Sydney}}. 'Tomorrow' = today + 1 day, 'Next Monday' = the coming Monday, etc."}, "edges": [{"condition": "User provides date preference", "id": "edge-reschedule-date-provided-v10-82", "transition_condition": {"type": "prompt", "prompt": "User provides a date preference (e.g., 'next Tuesday', 'tomorrow', 'December 15th', 'next week', or a specific date)"}, "destination_node_id": "node-get-reschedule-availability"}, {"condition": "User cancels", "id": "edge-reschedule-date-cancel-v10-82", "transition_condition": {"type": "prompt", "prompt": "User says nevermind, cancel, forget it, or doesn't want to reschedule anymore"}, "destination_node_id": "node-anything-else"}, {"condition": "Timeout", "id": "edge-reschedule-date-timeout-v10-82", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "User doesn't know preferred date", "id": "edge-reschedule-date-unsure-v11-38", "transition_condition": {"type": "prompt", "prompt": "User says they don't know, anytime works, you choose, or can't decide on a date"}, "destination_node_id": "node-get-reschedule-availability"}], "name": "ask_reschedule_date", "finetune_transition_examples": [], "id": "node-ask-reschedule-date", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 18150, "y": 4635}}, {"finetune_conversation_examples": [], "name": "termination_final", "finetune_transition_examples": [], "id": "node-termination-final", "knowledge_base_ids": [], "type": "end", "display_position": {"x": 23650, "y": 34535}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "I've found {{first_name}} {{last_name}}'s file. IMPORTANT: You are speaking to a proxy caller (not the patient). Address the caller politely, do not refer to them as {{first_name}}. How can I help with the patient's booking today?"}, "edges": [{"condition": "Booking/appointment request", "id": "edge-proxy-booking", "transition_condition": {"type": "prompt", "prompt": "User wants to book an appointment (physio, EP, home visit)."}, "destination_node_id": "node-collect-appointment-preferences"}, {"condition": "Class inquiry", "id": "edge-proxy-class", "transition_condition": {"type": "prompt", "prompt": "User wants to book a class (Better Balance, Aqua, Gym Fit)."}, "destination_node_id": "node-class-triage"}, {"condition": "Human/Sara request", "id": "edge-proxy-human", "transition_condition": {"type": "prompt", "prompt": "User wants to speak to a human or has a question I can't answer."}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Timeout", "id": "edge-greeting-proxy-timeout-v11-52", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "greeting_proxy", "finetune_transition_examples": [], "id": "node-greeting-proxy", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 8800, "y": 23490}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Is the person you are booking for a new patient or have they been here before?"}, "edges": [{"condition": "Caller IS the patient", "id": "edge-proxy-self-booking-v11-43", "transition_condition": {"type": "prompt", "prompt": "Caller says 'it's for me', 'I'm the patient', 'booking for myself', 'for me' - they are NOT booking for someone else"}, "destination_node_id": "node-triage-service"}, {"condition": "New Patient", "id": "edge-proxy-new-patient-v11-42", "transition_condition": {"type": "prompt", "prompt": "User says the person is new, first time, never been before, hasn't visited"}, "destination_node_id": "node-collect-patient-details-proxy"}, {"condition": "Existing Patient", "id": "edge-proxy-existing-patient-v11-42", "transition_condition": {"type": "prompt", "prompt": "User says the person has been before, is existing, returning patient"}, "destination_node_id": "node-manual-lookup"}, {"condition": "Timeout", "id": "edge-node-triage-booking-proxy-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "Unsure", "id": "edge-proxy-unsure-v11-44", "transition_condition": {"type": "prompt", "prompt": "User does not know if patient is new or existing"}, "destination_node_id": "node-manual-lookup"}], "name": "triage_booking_proxy", "finetune_transition_examples": [], "id": "node-triage-booking-proxy", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 18700, "y": 29275}}, {"speak_during_execution_message": "One moment while I note that down...", "edges": [{"condition": "Callback captured - email Sara", "id": "edge-capture-callback-success-v11-95", "transition_condition": {"type": "prompt", "prompt": "Callback request successfully captured (success=true)"}, "destination_node_id": "node-email-sara-unified"}, {"condition": "User changes mind", "id": "edge-node-capture-callback-escape-v10-80", "transition_condition": {"type": "prompt", "prompt": "User changes mind, asks a different question, says actually never mind, or requests different service"}, "destination_node_id": "node-intent-detection"}, {"condition": "Error", "id": "edge-node-capture-callback-error", "transition_condition": {"type": "prompt", "prompt": "Tool failed \u00e2\u20ac\u201d apologize and route to Sara handoff."}, "destination_node_id": "node-universal-error-handoff"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-capture-booking-details", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Capture booking intent for Sara. EXTRACTION RULE: Extract caller_name, village, intent (booking_1on1, booking_class, human_request, etc.), urgency (routine/urgent/high), and details (summarize what they need) directly from the conversation. Ensure 'caller_name' and 'village' are populated.\n\nIf user confirmed existing number, use {{user_number}}."}, "name": "capture_callback", "response_variables": {"success": "success", "transfer_id": "transfer_id"}, "id": "node-capture-callback", "knowledge_base_ids": [], "display_position": {"x": 1650, "y": 20860}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "phone_number": "", "patient_id": "{{patient_id}}", "urgency": "routine", "transfer_type": "booking_fallback", "details": "", "village": "", "intent": "callback_deferral", "caller_name": ""}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Collect details for a NEW patient. Ask for:\n1. First name\n2. Last name\n3. Date of birth\n4. Mobile phone number\n5. Village (or 'Private Residence' if at home)\n\nCollect one piece of information at a time. Confirm each piece before moving to the next.\n\n6. ADDRESS CHECK: If the patient's village is 'Private Residence', you MUST ask for their Street Address before creating the file."}, "edges": [{"condition": "All details collected", "id": "edge-details-collected-collect-1", "transition_condition": {"type": "prompt", "prompt": "All required details collected (Name, Village, DOB, Phone, AND Address if village is Private Residence)."}, "destination_node_id": "node-create-new-client"}, {"condition": "User says existing client", "id": "edge-details-existing-client-collect-1", "transition_condition": {"type": "prompt", "prompt": "User says they are already a patient, registered, or have been there before"}, "destination_node_id": "node-manual-lookup"}, {"condition": "User requests human", "id": "edge-details-to-human-collect-1", "transition_condition": {"type": "prompt", "prompt": "User asks to speak to a human, Sara, or someone else, OR cannot provide details"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "User asks general question", "id": "edge-details-to-kb-collect-1", "transition_condition": {"type": "prompt", "prompt": "User asks a general question about location, hours, pricing instead of providing details"}, "destination_node_id": "node-kb-answer"}, {"condition": "Rescue: New caller wants reschedule/cancel", "id": "edge-collect-details-rescue-resched-v11-34-collect-1", "transition_condition": {"type": "prompt", "prompt": "User's original intent was to reschedule, cancel, or manage existing appointments (not book new) - they are NOT trying to book a new appointment"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Timeout", "id": "edge-details-timeout-collect-1", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "User doesn't know or forgot information", "id": "edge-details-forgot-info-v11-38-collect-1", "transition_condition": {"type": "prompt", "prompt": "User says they don't know, can't remember, forgot their date of birth, village name, or other required details"}, "destination_node_id": "node-human-transfer-prep"}], "name": "collect_patient_details_new", "finetune_transition_examples": [], "id": "node-collect-patient-details-new", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 18700, "y": 30135}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Collect details for a PROXY booking (booking on behalf of someone else). Ask for the PATIENT's (not caller's):\n1. First name\n2. Last name\n3. Date of Birth\n4. PATIENT'S Mobile Number (required for their file - Do NOT use the caller's number)\n5. Village or 'Private Residence'\n\nDo NOT ask for caller's details. Do NOT use {{user_number}} for the patient's mobile."}, "edges": [{"condition": "All details collected", "id": "edge-details-collected-collect-2", "transition_condition": {"type": "prompt", "prompt": "All 4 required details (Name, Village, DOB, Phone) collected and confirmed - proceed to database check"}, "destination_node_id": "node-create-new-client"}, {"condition": "User says existing client", "id": "edge-details-existing-client-collect-2", "transition_condition": {"type": "prompt", "prompt": "User says they are already a patient, registered, or have been there before"}, "destination_node_id": "node-manual-lookup"}, {"condition": "User requests human", "id": "edge-details-to-human-collect-2", "transition_condition": {"type": "prompt", "prompt": "User asks to speak to a human, Sara, or someone else, OR cannot provide details"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "User asks general question", "id": "edge-details-to-kb-collect-2", "transition_condition": {"type": "prompt", "prompt": "User asks a general question about location, hours, pricing instead of providing details"}, "destination_node_id": "node-kb-answer"}, {"condition": "Rescue: New caller wants reschedule/cancel", "id": "edge-collect-details-rescue-resched-v11-34-collect-2", "transition_condition": {"type": "prompt", "prompt": "User's original intent was to reschedule, cancel, or manage existing appointments (not book new) - they are NOT trying to book a new appointment"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Timeout", "id": "edge-details-timeout-collect-2", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "User doesn't know or forgot information", "id": "edge-details-forgot-info-v11-38-collect-2", "transition_condition": {"type": "prompt", "prompt": "User says they don't know, can't remember, forgot their date of birth, village name, or other required details"}, "destination_node_id": "node-human-transfer-prep"}], "name": "collect_patient_details_proxy", "finetune_transition_examples": [], "id": "node-collect-patient-details-proxy", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 19250, "y": 25370}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "CONTEXT CHECK: If mobile was ALREADY provided (e.g. in proxy flow), do not ask again. Assume it is known.\n\nBefore I create your file, may I please get a mobile number we can reach you on? This is required for appointment confirmations and reminders.\n\nIMPORTANT: If the caller provides a landline number, ask: 'Do you have a mobile number we can use for SMS confirmations?' If they don't have a mobile, note that SMS confirmations won't be possible."}, "edges": [{"condition": "Mobile collection failed - transfer", "id": "edge-mobile-fallback-existing-fail", "transition_condition": {"type": "prompt", "prompt": "User claimed to be existing client (lookup failed) and we are now in fallback."}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "User requests human", "id": "edge-collect-mobile-fallback-human-v11-52", "transition_condition": {"type": "prompt", "prompt": "User asks to speak to a person, human, Sara, or real person"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "Mobile number provided", "id": "edge-mobile-fallback-collected-v11-51", "transition_condition": {"type": "prompt", "prompt": "User provided a mobile phone number"}, "destination_node_id": "node-create-new-client"}, {"condition": "Only landline available", "id": "edge-mobile-fallback-landline-v11-51", "transition_condition": {"type": "prompt", "prompt": "User only has a landline, no mobile available"}, "destination_node_id": "node-create-new-client"}, {"condition": "Timeout", "id": "edge-mobile-fallback-timeout-v11-51", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "collect_mobile_fallback", "finetune_transition_examples": [], "id": "node-collect-mobile-fallback", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 9900, "y": 24320}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "No problem. Unfortunately Gym Fit does require an EP assessment for safety reasons. Would you like to try one of our other classes that don't require an assessment, such as Better Balance or Aqua? Or would you prefer to speak with Sara about other options?"}, "edges": [{"condition": "Try different class", "id": "edge-gymfit-rejected-other-class-v11-51", "transition_condition": {"type": "prompt", "prompt": "User wants to try Better Balance, Aqua, or another class"}, "destination_node_id": "node-class-triage"}, {"condition": "Speak to Sara", "id": "edge-gymfit-rejected-transfer-v11-51", "transition_condition": {"type": "prompt", "prompt": "User wants to speak with Sara or get more options"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "No thanks", "id": "edge-gymfit-rejected-done-v11-51", "transition_condition": {"type": "prompt", "prompt": "User declines other options"}, "destination_node_id": "node-anything-else"}, {"condition": "Timeout", "id": "edge-gym-fit-rejected-timeout-v11-52", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "User accepts EP", "id": "edge-gymfit-accept-ep-v11-88", "transition_condition": {"type": "prompt", "prompt": "User changes mind and wants to book the EP assessment after all - says 'actually yes', 'okay book the EP', 'I'll do the assessment', 'fine I'll get assessed'"}, "destination_node_id": "node-collect-appointment-preferences"}], "name": "gym_fit_rejected", "finetune_transition_examples": [], "id": "node-gym-fit-rejected", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 21450, "y": 2125}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Great, your EP assessment is booked! Once you complete your assessment, you'll be cleared to join Gym Fit. Would you like Sara to call you after your assessment to help get you enrolled in the class?"}, "edges": [{"condition": "User wants waitlist", "id": "edge-ep-next-yes-waitlist-v11-54", "transition_condition": {"type": "prompt", "prompt": "User says yes, wants to join waitlist, add me, please do"}, "destination_node_id": "node-human-transfer-prep"}, {"condition": "User declines", "id": "edge-ep-next-no-v11-54", "transition_condition": {"type": "prompt", "prompt": "User says no, not right now, maybe later, or declines the waitlist"}, "destination_node_id": "node-anything-else"}, {"condition": "Timeout", "id": "edge-ep-next-timeout-v11-54", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "ep_next_steps", "finetune_transition_examples": [], "id": "node-ep-next-steps", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 11550, "y": 7705}}, {"speak_during_execution_message": "Let me verify your funding eligibility...", "edges": [{"condition": "Eligible", "id": "edge-mac-funding-eligible-v11-55", "transition_condition": {"type": "prompt", "prompt": "eligible=true - patient has valid MAC/HCP funding"}, "destination_node_id": "node-mac-outcome"}, {"condition": "Not eligible", "id": "edge-mac-funding-ineligible-v11-55", "transition_condition": {"type": "prompt", "prompt": "eligible=false - patient does not have MAC/HCP funding or it is inactive"}, "destination_node_id": "node-offer-private-pay"}, {"condition": "Error", "id": "edge-mac-funding-error-v11-55", "transition_condition": {"type": "prompt", "prompt": "Tool returned error, timeout, or failed"}, "destination_node_id": "node-universal-error-handoff"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-check-funding", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Verify MAC/HCP funding eligibility for the patient. This checks if they have active Home Care Package funding."}, "name": "check_funding_mac", "response_variables": {"funding_type": "funding_type", "requires_referral": "requires_referral", "message": "message", "funding_valid": "funding_valid", "success": "success", "eligible": "eligible"}, "id": "node-check-funding-mac", "knowledge_base_ids": [], "display_position": {"x": 20900, "y": 4225}, "speak_during_execution": true, "parameters": {"funding_type": "HCP", "call_id": "{{call_id}}", "patient_id": "{{patient_id}}"}}, {"speak_during_execution_message": "I apologize for the technical difficulty. Let me arrange a callback...", "edges": [{"condition": "always", "id": "edge-error-logged-to-end", "transition_condition": {"type": "prompt", "prompt": "Logging complete"}, "destination_node_id": "node-termination-final"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-add-to-followup", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Log system error for urgent follow-up."}, "name": "universal_error_handoff", "response_variables": {"success": "success"}, "id": "node-universal-error-handoff", "knowledge_base_ids": [], "display_position": {"x": 23100, "y": 12210}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "reason": "system_error", "notes": "System error occurred.", "urgency": "urgent", "phone": "{{user_number}}", "patient_id": "{{patient_id}}", "caller_name": "{{first_name}} {{last_name}}"}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Is this the best number to reach you?"}, "edges": [{"condition": "Yes", "id": "edge-callback-yes-v11-73", "transition_condition": {"type": "prompt", "prompt": "User confirms yes, this number is correct"}, "destination_node_id": "node-capture-callback"}, {"condition": "No/New Number", "id": "edge-callback-no-v11-73", "transition_condition": {"type": "prompt", "prompt": "User says no or provides a different number"}, "destination_node_id": "node-collect-new-number"}, {"condition": "Timeout", "id": "edge-confirm-callback-timeout-v11-95", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "confirm_callback_number", "finetune_transition_examples": [], "id": "node-confirm-callback-number", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 550, "y": 17430}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "I've successfully created your file! Would you like to go ahead and book your appointment now?"}, "edges": [{"condition": "Yes/Book", "id": "edge-new-patient-triage-yes", "transition_condition": {"type": "prompt", "prompt": "User says yes, wants to book an appointment, or indicates booking intent"}, "destination_node_id": "node-collect-appointment-preferences"}, {"condition": "Class", "id": "edge-new-patient-triage-class", "transition_condition": {"type": "prompt", "prompt": "User wants to join a class, mentions exercise class, Gym Fit, Better Balance, Aqua, etc."}, "destination_node_id": "node-class-triage"}, {"condition": "No/Done", "id": "edge-new-patient-triage-no", "transition_condition": {"type": "prompt", "prompt": "User says no, not right now, that's all, or indicates they're done"}, "destination_node_id": "node-end-call-new-client"}, {"condition": "Timeout", "id": "edge-new-patient-triage-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "new_patient_booking_triage", "finetune_transition_examples": [], "id": "node-new-patient-booking-triage", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 20350, "y": 34720}}, {"speak_during_execution_message": "Let me check if there's space in that class...", "edges": [{"condition": "Full", "id": "edge-capacity-full", "transition_condition": {"type": "prompt", "prompt": "has_capacity=false or spots_available=0 - class is full"}, "destination_node_id": "node-class-full-apology"}, {"condition": "Available", "id": "edge-capacity-available", "transition_condition": {"type": "prompt", "prompt": "has_capacity=true and spots_available > 0"}, "destination_node_id": "node-enroll-class"}, {"condition": "Error", "id": "edge-capacity-error", "transition_condition": {"type": "prompt", "prompt": "Tool returned error - proceed anyway and let enrollment handle it"}, "destination_node_id": "node-universal-error-handoff"}], "finetune_transition_examples": [], "type": "function", "tool_type": "local", "timeout": 10000, "wait_for_result": true, "tool_id": "tool-check-class-capacity", "finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "Check if the selected class has capacity. Extract class_name, village, and date from conversation context."}, "name": "check_capacity", "response_variables": {"has_capacity": "has_capacity", "spots_available": "spots_available", "success": "success", "class_id": "class_id"}, "id": "node-check-capacity", "knowledge_base_ids": [], "display_position": {"x": 6050, "y": 7995}, "speak_during_execution": true, "parameters": {"call_id": "{{call_id}}", "class_date": "", "class_name": "", "village": ""}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "What is the best number to reach you at?"}, "edges": [{"condition": "Number provided", "id": "edge-new-number-provided", "transition_condition": {"type": "prompt", "prompt": "User provides a phone number"}, "destination_node_id": "node-capture-callback"}, {"condition": "Timeout", "id": "edge-new-number-timeout", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "collect_new_number", "finetune_transition_examples": [], "id": "node-collect-new-number", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 1100, "y": 20360}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "I apologize, but I need to confirm which village location you're enquiring about. Which village is this for?"}, "edges": [{"condition": "Village provided", "id": "edge-village-collected-v11-112", "transition_condition": {"type": "prompt", "prompt": "User provides a village name (e.g., Gordon Quarter, Oak Village, The Baytree, etc.)"}, "destination_node_id": "node-get-slots"}, {"condition": "Timeout", "id": "edge-village-timeout-v11-112", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}, {"condition": "User unsure - transfer to Sara", "id": "edge-village-unknown-v11-112", "transition_condition": {"type": "prompt", "prompt": "User is unsure of their village or asks for help identifying it"}, "destination_node_id": "node-human-transfer-prep"}], "name": "collect_missing_village", "finetune_transition_examples": [], "id": "node-collect-missing-village", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 14300, "y": 520}}, {"finetune_conversation_examples": [], "instruction": {"type": "prompt", "text": "I'm sorry, but that specific class session is fully booked. Would you like me to check a different date, or would you prefer to be added to a waitlist so we can call you back if a spot opens up?"}, "edges": [{"condition": "Try different date", "id": "edge-class-full-different-date-v11-112", "transition_condition": {"type": "prompt", "prompt": "User wants to check a different date or time"}, "destination_node_id": "node-get-class-schedule"}, {"condition": "Add to waitlist", "id": "edge-class-full-waitlist-v11-112", "transition_condition": {"type": "prompt", "prompt": "User wants to be added to waitlist or notified when spot opens"}, "destination_node_id": "node-add-to-followup-class-ep"}, {"condition": "User declines", "id": "edge-class-full-nevermind-v11-112", "transition_condition": {"type": "prompt", "prompt": "User says never mind, no thanks, or wants to do something else"}, "destination_node_id": "node-anything-else"}, {"condition": "Timeout", "id": "edge-class-full-timeout-v11-112", "transition_condition": {"type": "prompt", "prompt": "No response for 15 seconds"}, "destination_node_id": "node-are-you-there"}], "name": "class_full_apology", "finetune_transition_examples": [], "id": "node-class-full-apology", "knowledge_base_ids": [], "type": "conversation", "display_position": {"x": 6600, "y": 12840}}], "start_node_id": "node-caller-id-lookup", "start_speaker": "agent", "tools": [{"headers": {}, "method": "POST", "query_params": {}, "description": "n8n looks up caller in Postgres by phone number if available (from carrier from_number) or by call_id context", "type": "custom", "url": "https://auto.yr.com.au/webhook/reignite-retell/lookup-caller-phone", "tool_id": "tool-lookup-caller-phone", "args_at_root": false, "timeout_ms": 10000, "name": "lookup_caller_by_phone", "response_variables": {"match_found": "found", "last_name": "last_name", "caller_phone": "phone", "village": "village", "first_name": "first_name", "patient_id": "patient_id"}, "id": "tool-lookup-caller-phone", "parameters": {"type": "object", "properties": {"phone": {"type": "string", "description": "Caller ID phone number"}, "call_id": {"type": "string", "description": "Dynamic call ID: {{call_id}}"}}, "required": ["phone"]}}, {"headers": {}, "parameter_type": "json", "method": "POST", "query_params": {}, "description": "Look up patient by name and village. Extract first_name, last_name, and village from conversation history.", "type": "custom", "url": "https://auto.yr.com.au/webhook/reignite-retell/lookup-caller-name-village", "tool_id": "tool-lookup-caller-name-village", "args_at_root": false, "timeout_ms": 10000, "name": "lookup_caller_by_name_village", "response_variables": {"phone": "phone", "patient_id": "patient_id", "confidence_score": "confidence_score", "match_found": "found", "last_name": "last_name", "village": "village", "first_name": "first_name"}, "id": "tool-lookup-caller-name-village", "parameters": {"type": "object", "properties": {"last_name": {"type": "string", "description": "Last name"}, "village": {"type": "string", "description": "Village name"}, "first_name": {"type": "string", "description": "First name"}, "phone": {"type": "string", "description": "Caller's phone number for deduplication of common names"}, "call_id": {"type": "string", "description": "Dynamic call ID: {{call_id}}"}}, "required": ["first_name", "last_name", "village"]}}, {"headers": {}, "method": "POST", "query_params": {}, "description": "n8n looks up caller by name and date of birth in Postgres", "type": "custom", "url": "https://auto.yr.com.au/webhook/reignite-retell/lookup-caller-dob", "tool_id": "tool-lookup-caller-dob", "args_at_root": false, "timeout_ms": 10000, "name": "lookup_caller_by_dob", "response_variables": {"match_found": "found", "last_name": "last_name", "village": "village", "first_name": "first_name", "phone": "phone", "patient_id": "patient_id"}, "id": "tool-lookup-caller-dob", "parameters": {"type": "object", "properties": {"name": {"type": "string", "description": "Optional patient name to help narrow search"}, "last_name": {"type": "string", "description": "Last name"}, "first_name": {"type": "string", "description": "First name"}, "date_of_birth": {"type": "string", "description": "Date of birth in YYYY-MM-DD format"}, "call_id": {"type": "string", "description": "Dynamic call ID: {{call_id}}"}}, "required": ["date_of_birth"]}}, {"headers": {}, "method": "POST", "query_params": {}, "description": "n8n reschedules appointment in Cliniko, sends SMS confirmation, logs to Google Sheets NOTE: n8n webhook must accept new_starts_at (ISO 8601) and parse internally.", "type": "custom", "url": "https://auto.yr.com.au/webhook/reignite-retell/reschedule-appointment", "tool_id": "tool-reschedule-appointment", "args_at_root": false, "timeout_ms": 10000, "name": "reschedule_appointment", "response_variables": {"new_appointment_id": "new_appointment_id", "new_starts_at": "new_starts_at", "message": "message", "success": "success"}, "id": "tool-reschedule-appointment", "parameters": {"type": "object", "properties": {"appointment_id": {"type": "string", "description": "Cliniko appointment ID"}, "reason": {"type": "string", "description": "Reason for rescheduling"}, "new_starts_at": {"type": "string", "description": "New appointment start time in ISO 8601 format (e.g., 2025-12-15T09:30:00+11:00)"}, "call_id": {"type": "string", "description": "Dynamic call ID: {{call_id}}"}}, "required": ["appointment_id", "new_starts_at"]}}, {"headers": {}, "method": "POST", "query_params": {}, "description": "n8n cancels appointment in Cliniko, sends SMS, logs to Cancellation_Followup sheet", "type": "custom", "url": "https://auto.yr.com.au/webhook/reignite-retell/cancel-appointment", "tool_id": "tool-cancel-appointment", "args_at_root": false, "timeout_ms": 10000, "name": "cancel_appointment", "response_variables": {"message": "message", "success": "success"}, "id": "tool-cancel-appointment", "parameters": {"type": "object", "properties": {"appointment_id": {"type": "string", "description": "Cliniko appointment ID"}, "reason": {"type": "string", "description": "Reason for cancellation"}, "call_id": {"type": "string", "description": "Dynamic call ID: {{call_id}}"}}, "required": ["appointment_id", "reason"]}}, {"headers": {}, "parameter_type": "json", "method": "POST", "query_params": {}, "description": "n8n captures all caller details and context for Sara callback, stores in workflow state", "type": "custom", "url": "https://auto.yr.com.au/webhook/reignite-retell/capture-booking-details", "tool_id": "tool-capture-booking-details", "args_at_root": false, "timeout_ms": 10000, "name": "capture_transfer_details", "response_variables": {"success": "success", "transfer_id": "transfer_id"}, "id": "tool-capture-booking-details", "parameters": {"type": "object", "properties": {"caller_name": {"type": "string", "description": "Caller's full name"}, "urgency": {"type": "string", "description": "routine, important, or urgent"}, "patient_id": {"type": "string", "description": "Cliniko patient ID if identified"}, "phone_number": {"type": "string", "description": "Callback phone number (optional)"}, "details": {"type": "string", "description": "Free-form notes from conversation"}, "transfer_type": {"type": "string", "description": "Type of transfer: faq, complaint, human_request, booking_fallback, bulk_cancellation"}, "village": {"type": "string", "description": "Village name if known"}, "intent": {"type": "string", "description": "Intent type: booking_1on1, booking_class, new_client, question, human_request, bulk_cancellation, faq_handoff, or complaint"}, "call_id": {"type": "string", "description": "Dynamic call ID: {{call_id}}"}}, "required": ["caller_name", "intent", "details", "urgency", "call_id"]}}, {"headers": {}, "parameter_type": "json", "method": "POST", "query_params": {}, "description": "n8n sends formatted email to Sara with all captured caller details and context", "type": "custom", "url": "https://auto.yr.com.au/webhook/reignite-retell/email-sara-transfer", "tool_id": "tool-email-sara-transfer", "args_at_root": false, "timeout_ms": 10000, "name": "email_sara_with_caller_details", "response_variables": {"success": "success", "email_sent": "email_sent"}, "id": "tool-email-sara-transfer", "parameters": {"type": "object", "properties": {"transfer_id": {"type": "string", "description": "Transfer ID from capture tool"}, "call_id": {"type": "string", "description": "Dynamic call ID: {{call_id}}"}}, "required": ["transfer_id", "call_id"]}}, {"headers": {}, "method": "POST", "query_params": {}, "description": "Creates a new patient record in Cliniko. MUST be called for all new patients BEFORE booking any appointments. Requires: first_name, last_name, date_of_birth (YYYY-MM-DD format), mobile_phone, village. Email is NOT required - do not ask for it. This is a mandatory first step for new patient bookings - never skip it.", "type": "custom", "url": "https://auto.yr.com.au/webhook/reignite-retell/create-new-client", "tool_id": "tool-create-new-client", "args_at_root": false, "timeout_ms": 10000, "name": "create_new_client", "response_variables": {"patient_id": "patient_id", "success": "success", "is_new_client": "is_new_patient", "last_name": "last_name", "sms_phone": "mobile", "village": "village", "first_name": "first_name"}, "id": "tool-create-new-client", "parameters": {"type": "object", "properties": {"address": {"type": "string", "description": "Street address for home visit bookings"}, "phone": {"type": "string"}, "date_of_birth": {"type": "string", "description": "Date of birth in YYYY-MM-DD format"}, "last_name": {"type": "string"}, "village": {"type": "string"}, "first_name": {"type": "string"}, "call_id": {"type": "string", "description": "Dynamic call ID: {{call_id}}"}}, "required": ["first_name", "last_name", "phone", "village", "date_of_birth", "call_id"]}}, {"headers": {}, "method": "POST", "query_params": {}, "description": "Checks funding validity.", "type": "custom", "url": "https://auto.yr.com.au/webhook/reignite-retell/check-funding", "tool_id": "tool-check-funding", "args_at_root": false, "timeout_ms": 10000, "name": "check_funding", "response_variables": {"funding_decision": "funding_decision", "appointment_types": "appointment_types", "requires_referral": "requires_referral", "eligible": "eligible", "success": "success", "funding_type": "funding_type", "message": "message", "funding_valid": "funding_valid"}, "id": "tool-check-funding", "parameters": {"type": "object", "properties": {"recurrence_details": {"type": "string", "description": "Recurrence pattern if booking is recurring (e.g., Weekly for 5 weeks)"}, "starts_at": {"type": "string", "description": "ISO 8601 datetime of proposed appointment (for time-based funding rules)"}, "appointment_type": {"type": "string", "description": "Type of appointment for service-specific funding rules"}, "patient_id": {"type": "string", "description": "Cliniko patient ID (leave empty for new patients)"}, "practitioner_id": {"type": "string", "description": "Practitioner ID if specified"}, "funding_type": {"type": "string", "description": "Type of funding: HCP (My Aged Care), DVA (Veterans), GP (Medicare), PRIVATE (Self-pay), PHI (Private Health Insurance)", "enum": ["HCP", "DVA", "GP", "PRIVATE", "PHI"]}, "village": {"type": "string", "description": "Village name for location-based funding rules"}, "call_id": {"type": "string", "description": "Dynamic call ID: {{call_id}}"}}, "required": ["funding_type", "patient_id", "call_id"]}}, {"headers": {}, "method": "POST", "query_params": {}, "description": "Finds available slots.", "type": "custom", "url": "https://auto.yr.com.au/webhook/reignite-retell/get-availability", "tool_id": "tool-get-availability", "args_at_root": false, "timeout_ms": 10000, "name": "get_availability", "response_variables": {"spoken_text": "spoken_text", "slots": "available_practitioners", "success": "success", "slots_summary": "slots_summary"}, "id": "tool-get-availability", "parameters": {"type": "object", "properties": {"date": {"type": "string", "description": "Date to check availability for in YYYY-MM-DD format"}, "duration_minutes": {"type": "number", "description": "Duration of appointment in minutes (e.g., 30, 45, 60). Used to filter slots that can accommodate the requested duration."}, "appointment_type": {"type": "string", "description": "Type of appointment to filter availability. Use exact enum values.", "enum": ["Standard Consultation", "Initial Consultation", "Standard Home Visit", "EP Assessment", "EP Initial Assessment", "Initial Home Visit"]}, "practitioner_id": {"type": "string"}, "service_category": {"type": "string", "description": "Service category to filter practitioners: 'physio' for Physiotherapy, 'ep' for Exercise Physiology. CRITICAL for ensuring patient sees correct practitioner type.", "enum": ["physio", "ep"]}, "village": {"type": "string"}, "call_id": {"type": "string", "description": "Dynamic call ID: {{call_id}}"}}, "required": ["date", "service_category"]}}, {"headers": {}, "method": "POST", "query_params": {}, "description": "The Master Booking Tool. Performs ALL validation (holidays, business rules, recurring conflicts), creates the appointment in Cliniko, and submits it to Sara's approval queue in a single step. ALWAYS use this to finalize a booking after the user selects a time. Returns comprehensive confirmation with all details.", "type": "custom", "url": "https://auto.yr.com.au/webhook/reignite-retell/book-appointment-compound", "tool_id": "tool-book-appointment-compound", "args_at_root": false, "timeout_ms": 25000, "name": "book_appointment_compound", "response_variables": {"error_message": "error_message", "appointment_created": "appointment_created", "practitioner_name": "confirmation_details.practitioner_name", "success": "success", "booking_date": "confirmation_details.date", "patient_name": "confirmation_details.patient_name", "cliniko_link": "cliniko_link", "appointment_id": "appointment_id", "booking_time": "confirmation_details.time", "error_code": "error_code"}, "id": "tool-book-appointment-compound", "parameters": {"type": "object", "properties": {"unit_villa": {"type": "string", "description": "Unit or villa number if applicable"}, "recurrence_details": {"type": "string", "description": "Optional: If user requested recurring (e.g., 'Weekly for 5 weeks')"}, "starts_at": {"type": "string", "description": "ISO 8601 Datetime of the booking (e.g., 2024-12-25T14:00:00+11:00)"}, "appointment_notes": {"type": "string", "description": "Any special notes from the user"}, "practitioner_id": {"type": "string", "description": "ID of the practitioner. If omitted or empty, defaults to the next available practitioner for the village."}, "funding_type": {"type": "string", "description": "Funding type: HCP, DVA, GP, PRIVATE, or PHI", "enum": ["HCP", "DVA", "GP", "PRIVATE", "PHI"]}, "call_id": {"type": "string", "description": "Dynamic call ID: {{call_id}}"}, "duration_minutes": {"type": "number", "description": "Duration of the appointment (default 30)"}, "appointment_type": {"type": "string", "description": "Type of appointment. Use exact enum values.", "enum": ["Standard Consultation", "Initial Consultation", "Standard Home Visit", "EP Assessment", "EP Initial Assessment"]}, "patient_id": {"type": "string", "description": "Cliniko Patient ID"}, "referral_confirmed": {"type": "boolean", "description": "True if user explicitly confirmed they have a valid referral (DVA/GP)"}, "is_new_client": {"type": "boolean", "description": "Flag if this is a new client"}, "village": {"type": "string", "description": "Village name"}, "client_name": {"type": "string", "description": "Full name of client"}}, "required": ["patient_id", "starts_at", "village", "funding_type", "appointment_type"]}}, {"headers": {}, "method": "POST", "query_params": {}, "description": "Get the schedule of available class times. MUST be called BEFORE enrolling anyone in a class so they can see available times and choose one. Never enroll someone in a class without showing them the schedule first. Returns class times for Better Balance, Aqua, or Gym Fit classes at specified villages.", "type": "custom", "url": "https://auto.yr.com.au/webhook/reignite-retell/get-class-schedule", "tool_id": "tool-get-class-schedule", "args_at_root": false, "timeout_ms": 10000, "name": "get_class_schedule", "response_variables": {"schedule": "schedule", "spoken_text": "spoken_text", "class_type": "class_type", "success": "success", "class_id": "next_class_id"}, "id": "tool-get-class-schedule", "parameters": {"type": "object", "properties": {"date": {"type": "string", "description": "Optional: Specific date (YYYY-MM-DD) to search for classes."}, "class_type": {"type": "string"}, "village": {"type": "string"}, "call_id": {"type": "string", "description": "Dynamic call ID: {{call_id}}"}}}}, {"headers": {}, "speak_during_execution_message": "I'm securing that spot for you now...", "method": "POST", "query_params": {}, "description": "Enrolls patient in a single class session. Requires class_id from get_class_schedule results.", "type": "custom", "url": "https://auto.yr.com.au/webhook/reignite-retell/enroll-class-single", "tool_id": "tool-enroll-class", "args_at_root": false, "timeout_ms": 10000, "name": "enroll_class", "response_variables": {"class_type": "class_type", "success": "success", "date_formatted": "date_formatted", "time_formatted": "time_formatted", "message": "message", "is_trial": "is_trial", "enrollment_id": "enrollment_id"}, "id": "tool-enroll-class", "parameters": {"type": "object", "properties": {"class_type": {"type": "string", "description": "Type of class (e.g., 'Better Balance', 'Aqua', 'Gym Fit') - use as fallback if class_id not available"}, "village": {"type": "string", "description": "Village where class is held"}, "is_trial": {"type": "boolean", "description": "Set to true if this is a free trial enrollment"}, "patient_id": {"type": "string"}, "class_id": {"type": "string", "description": "Specific class instance ID - use if known from schedule results"}, "call_id": {"type": "string", "description": "Dynamic call ID: {{call_id}}"}}, "required": ["patient_id", "class_id"]}, "speak_during_execution": true}, {"headers": {}, "method": "POST", "query_params": {}, "description": "Check if patient needs EP assessment for Gym Fit", "type": "custom", "url": "https://auto.yr.com.au/webhook/reignite-retell/check-ep-assessment", "tool_id": "tool-check-ep-assessment", "args_at_root": false, "timeout_ms": 10000, "name": "check_ep_assessment", "response_variables": {"needs_assessment": "assessment_required", "message": "message", "assessment_complete": "assessment_completed", "assessment_date": "date_completed"}, "id": "tool-check-ep-assessment", "parameters": {"type": "object", "properties": {"patient_id": {"type": "string", "description": "Cliniko patient ID"}, "call_id": {"type": "string", "description": "Dynamic call ID: {{call_id}}"}}, "required": ["patient_id", "call_id"]}}, {"headers": {}, "method": "POST", "query_params": {}, "description": "View patient's upcoming appointments. ALWAYS call this before cancel or reschedule. Returns times in Sydney (AEDT/AEST) timezone.", "type": "custom", "url": "https://auto.yr.com.au/webhook/reignite-retell/list-appointments", "tool_id": "tool-list-appointments", "args_at_root": false, "timeout_ms": 10000, "name": "list_appointments", "response_variables": {"appointment_count": "count", "spoken_text": "spoken_text", "appointments": "appointments", "success": "success"}, "id": "tool-list-appointments", "parameters": {"type": "object", "properties": {"patient_id": {"type": "string"}, "call_id": {"type": "string", "description": "Dynamic call ID: {{call_id}}"}}, "required": ["patient_id", "call_id"]}}, {"headers": {}, "method": "POST", "query_params": {}, "description": "Send SMS message to mobile phone number", "type": "custom", "url": "https://auto.yr.com.au/webhook/reignite-retell/send-sms", "tool_id": "tool-send-sms", "args_at_root": false, "timeout_ms": 10000, "name": "send_sms", "response_variables": {"success": "success", "message_id": "message_id"}, "id": "tool-send-sms", "parameters": {"type": "object", "properties": {"message": {"type": "string", "description": "SMS message content to send"}, "to_phone": {"type": "string", "description": "Mobile phone number to send SMS to"}, "call_id": {"type": "string", "description": "Dynamic call ID: {{call_id}}"}}, "required": ["to_phone", "message", "call_id"]}}, {"headers": {}, "method": "POST", "query_params": {}, "description": "Add To Followup", "type": "custom", "url": "https://auto.yr.com.au/webhook/reignite-retell/add-to-followup", "tool_id": "tool-add-to-followup", "args_at_root": false, "timeout_ms": 10000, "name": "add_to_followup", "response_variables": {"message": "message", "followup_id": "followup_id", "success": "success"}, "id": "tool-add-to-followup", "parameters": {"type": "object", "properties": {"reason": {"type": "string", "description": "Reason for followup (e.g., 'MAC funding followup', 'cancelled_appointment')"}, "caller_name": {"type": "string", "description": "Name of the caller for follow-up"}, "notes": {"type": "string", "description": "Detailed notes about the follow-up request"}, "urgency": {"type": "string", "description": "Urgency level: routine, urgent, or high", "enum": ["routine", "urgent", "high"]}, "phone": {"type": "string", "description": "Phone number for follow-up callback"}, "patient_id": {"type": "string", "description": "Cliniko patient ID"}, "village": {"type": "string", "description": "Village/location name if known (optional)"}, "call_id": {"type": "string", "description": "Dynamic call ID: {{call_id}}"}}, "required": ["reason", "caller_name", "phone", "notes", "urgency", "call_id"]}}, {"headers": {}, "method": "POST", "query_params": {}, "description": "Get Reschedule Availability", "type": "custom", "url": "https://auto.yr.com.au/webhook/reignite-retell/get-reschedule-availability", "tool_id": "tool-get-reschedule-availability", "args_at_root": false, "timeout_ms": 10000, "name": "get_reschedule_availability", "response_variables": {"spoken_text": "spoken_text", "slots": "available_slots", "message": "message", "success": "success"}, "id": "tool-get-reschedule-availability", "parameters": {"type": "object", "properties": {"appointment_id": {"type": "string", "description": "ID of the appointment to be rescheduled"}, "call_id": {"type": "string", "description": "Dynamic call ID: {{call_id}}"}, "preferred_date": {"type": "string", "description": "Preferred date for rescheduling in YYYY-MM-DD format. If user specifies a date preference (e.g., 'next Monday', 'mid-December'), convert to ISO date and pass here."}}, "required": ["appointment_id"]}}, {"headers": {}, "speak_during_execution_message": "Let me double check the availability...", "method": "POST", "query_params": {}, "description": "Check if a class has available spots. Returns capacity info.", "type": "custom", "url": "https://auto.yr.com.au/webhook/reignite-retell/check-class-capacity", "tool_id": "tool-check-class-capacity", "args_at_root": false, "timeout_ms": 10000, "name": "check_class_capacity", "response_variables": {"has_capacity": "has_capacity", "spots_available": "spots_available", "success": "success", "class_id": "class_id"}, "id": "tool-check-class-capacity", "parameters": {"type": "object", "properties": {"village": {"type": "string", "description": "Village name where the class is held"}, "class_name": {"type": "string", "description": "Name of the class (e.g., 'Better Balance', 'Aqua', 'Gym Fit')"}, "class_date": {"type": "string", "description": "Date to check capacity for (YYYY-MM-DD format)"}, "call_id": {"type": "string", "description": "Dynamic call ID: {{call_id}}"}}, "required": ["class_name", "village"]}, "speak_during_execution": true}], "model_choice": {"type": "cascading", "model": "gpt-4.1", "high_priority": false}, "knowledge_base_ids": ["knowledge_base_1855cb0a2ebe9362"], "kb_config": {"top_k": 3, "filter_score": 0.6}, "begin_tag_display_position": {"x": 550, "y": 21595}, "is_published": false}
